<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- å¼ºåˆ¶é¡µé¢åœ¨å½“å‰çª—å£ä»¥ç‹¬ç«‹é¡µé¢æ˜¾ç¤º,é˜²æ­¢åˆ«äººåœ¨æ¡†æ¶é‡Œè°ƒç”¨é¡µé¢ -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>[JavaåŸºç¡€]ThreadPoolExecutor | åœŸå·çš„è‡ªç•™åœ°</title>
  <meta name="description" content="å‰é¢å·²ç»é“ºå«å¥½ï¼ŒBOSSç™»åœº">
<meta name="keywords" content="multithread">
<meta property="og:type" content="article">
<meta property="og:title" content="[JavaåŸºç¡€]ThreadPoolExecutor">
<meta property="og:url" content="https://htchz.cc/1860367337.html">
<meta property="og:site_name" content="åœŸå·çš„è‡ªç•™åœ°">
<meta property="og:description" content="å‰é¢å·²ç»é“ºå«å¥½ï¼ŒBOSSç™»åœº">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://htchz.cc/images/pasted-142.png">
<meta property="og:image" content="https://htchz.cc/images/pasted-141.png">
<meta property="og:updated_time" content="2018-10-22T03:34:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[JavaåŸºç¡€]ThreadPoolExecutor">
<meta name="twitter:description" content="å‰é¢å·²ç»é“ºå«å¥½ï¼ŒBOSSç™»åœº">
<meta name="twitter:image" content="https://htchz.cc/images/pasted-142.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://htchz.cc/1860367337.html">
  
    <link rel="alternate" href="/atom.xml" title="åœŸå·çš„è‡ªç•™åœ°" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/unnamed.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
</head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/fennecs" target="_blank">
          <img class="img-circle img-rotate" src="/images/unnamed.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">åœŸå·</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">åç«¯ç å†œ</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Guangzhou, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="æœç´¢" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">é¦–é¡µ</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">å½’æ¡£</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">åˆ†ç±»</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">æ ‡ç­¾</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">å…³äº</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/fennecs" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">å…¬å‘Š</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>ç¢§æ²¹é¸¡!ç¢§æ²¹é¸¡ï¼</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">åˆ†ç±»</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DB/">DB</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Firebase/">Firebase</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GolangåŸºç¡€/">GolangåŸºç¡€</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaåŸºç¡€/">JavaåŸºç¡€</a><span class="category-list-count">48</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Proxy/">Proxy</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/åˆ†å¸ƒå¼/">åˆ†å¸ƒå¼</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å»ºç«™/">å»ºç«™</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å¾®æœåŠ¡/">å¾®æœåŠ¡</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/æœåŠ¡å™¨/">æœåŠ¡å™¨</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç¢ç¢å¿µ/">ç¢ç¢å¿µ</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç½‘ç»œ/">ç½‘ç»œ</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">æ ‡ç­¾</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/">AOP</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BT/">BT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bean/">Bean</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GC/">GC</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Https/">Https</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hystrix/">Hystrix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IOC/">IOC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javaé›†åˆ/">Javaé›†åˆ</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Json/">Json</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/">NIO</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OOP/">OOP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/">TCP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bbr/">bbr</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/goroutine/">goroutine</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdk8/">jdk8</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/multithread/">multithread</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/properties/">properties</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ä½å›¾/">ä½å›¾</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ä½è¿ç®—/">ä½è¿ç®—</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/å“ˆå¸Œä¸€è‡´æ€§/">å“ˆå¸Œä¸€è‡´æ€§</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/å‘/">å‘</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æ•°æ®åˆ†ç‰‡/">æ•°æ®åˆ†ç‰‡</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æœåŠ¡é™æµ/">æœåŠ¡é™æµ</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æ­£åˆ™/">æ­£åˆ™</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ç¢§æ²¹é¸¡/">ç¢§æ²¹é¸¡</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/è¿ç»´/">è¿ç»´</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">æ ‡ç­¾äº‘</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/AOP/" style="font-size: 13.14px;">AOP</a> <a href="/tags/BT/" style="font-size: 13px;">BT</a> <a href="/tags/Bean/" style="font-size: 13px;">Bean</a> <a href="/tags/GC/" style="font-size: 13.57px;">GC</a> <a href="/tags/Hexo/" style="font-size: 13px;">Hexo</a> <a href="/tags/Https/" style="font-size: 13.14px;">Https</a> <a href="/tags/Hystrix/" style="font-size: 13px;">Hystrix</a> <a href="/tags/IOC/" style="font-size: 13px;">IOC</a> <a href="/tags/JVM/" style="font-size: 13.71px;">JVM</a> <a href="/tags/Javaé›†åˆ/" style="font-size: 14px;">Javaé›†åˆ</a> <a href="/tags/Json/" style="font-size: 13px;">Json</a> <a href="/tags/Mysql/" style="font-size: 13px;">Mysql</a> <a href="/tags/NIO/" style="font-size: 13.14px;">NIO</a> <a href="/tags/Nginx/" style="font-size: 13px;">Nginx</a> <a href="/tags/OOP/" style="font-size: 13.29px;">OOP</a> <a href="/tags/TCP/" style="font-size: 13px;">TCP</a> <a href="/tags/bbr/" style="font-size: 13px;">bbr</a> <a href="/tags/goroutine/" style="font-size: 13.14px;">goroutine</a> <a href="/tags/jdk8/" style="font-size: 13.14px;">jdk8</a> <a href="/tags/multithread/" style="font-size: 13.86px;">multithread</a> <a href="/tags/properties/" style="font-size: 13px;">properties</a> <a href="/tags/ä½å›¾/" style="font-size: 13px;">ä½å›¾</a> <a href="/tags/ä½è¿ç®—/" style="font-size: 13px;">ä½è¿ç®—</a> <a href="/tags/å“ˆå¸Œä¸€è‡´æ€§/" style="font-size: 13px;">å“ˆå¸Œä¸€è‡´æ€§</a> <a href="/tags/å‘/" style="font-size: 13px;">å‘</a> <a href="/tags/æ•°æ®åˆ†ç‰‡/" style="font-size: 13px;">æ•°æ®åˆ†ç‰‡</a> <a href="/tags/æœåŠ¡é™æµ/" style="font-size: 13.14px;">æœåŠ¡é™æµ</a> <a href="/tags/æ­£åˆ™/" style="font-size: 13px;">æ­£åˆ™</a> <a href="/tags/ç¢§æ²¹é¸¡/" style="font-size: 13.43px;">ç¢§æ²¹é¸¡</a> <a href="/tags/è¿ç»´/" style="font-size: 13px;">è¿ç»´</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">å½’æ¡£</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">å…«æœˆ 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">ä¸ƒæœˆ 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">äº”æœˆ 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">ä¸‰æœˆ 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">ä¸€æœˆ 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">åäºŒæœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">åä¸€æœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">åæœˆ 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">ä¹æœˆ 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">å…«æœˆ 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">ä¸ƒæœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">å…­æœˆ 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">äº”æœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">å››æœˆ 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">ä¸‰æœˆ 2018</a><span class="archive-list-count">39</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse in" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">æ–‡ç« ç›®å½•</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#çº¿ç¨‹æ± æ€»è§ˆ"><span class="toc-text">1. çº¿ç¨‹æ± æ€»è§ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹"><span class="toc-text">1.1. çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#javaçº¿ç¨‹æ± çš„ç»§æ‰¿ä½“ç³»"><span class="toc-text">1.2. javaçº¿ç¨‹æ± çš„ç»§æ‰¿ä½“ç³»</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ThreadPoolExecutor"><span class="toc-text">2. ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadPoolExecutorçš„é‡è¦å±æ€§"><span class="toc-text">2.1. ThreadPoolExecutorçš„é‡è¦å±æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æäº¤ä»»åŠ¡"><span class="toc-text">2.2. æäº¤ä»»åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#è¿è¡Œä»»åŠ¡"><span class="toc-text">2.3. è¿è¡Œä»»åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ·»åŠ å·¥ä½œçº¿ç¨‹"><span class="toc-text">2.4. æ·»åŠ å·¥ä½œçº¿ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å·¥ä½œçº¿ç¨‹çš„-idle-è¶…æ—¶å¤„ç†"><span class="toc-text">2.5. å·¥ä½œçº¿ç¨‹çš„ idle è¶…æ—¶å¤„ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Future"><span class="toc-text">2.6. Future</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#è¿è¡Œä»»åŠ¡-1"><span class="toc-text">2.6.1. è¿è¡Œä»»åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä»»åŠ¡å®Œæˆ"><span class="toc-text">2.6.2. ä»»åŠ¡å®Œæˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è·å–ç»“æœ"><span class="toc-text">2.6.3. è·å–ç»“æœ</span></a></li></ol></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-JavaåŸºç¡€-ThreadPoolExecutor" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      [JavaåŸºç¡€]ThreadPoolExecutor
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/1860367337.html" class="article-date">
	  <time datetime="2018-08-31T04:00:00.000Z" itemprop="datePublished">2018-08-31</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/JavaåŸºç¡€/">JavaåŸºç¡€</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/multithread/">multithread</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/1860367337.html#comments" class="article-comment-link">è¯„è®º</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">å­—æ•°ç»Ÿè®¡: 4.6k(å­—)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">é˜…è¯»æ—¶é•¿: 20(åˆ†)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <blockquote>
<p>å‰é¢å·²ç»é“ºå«å¥½ï¼ŒBOSSç™»åœº</p>
</blockquote>
<a id="more"></a>

<h1 id="çº¿ç¨‹æ± æ€»è§ˆ">1. çº¿ç¨‹æ± æ€»è§ˆ</h1><h2 id="çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹">1.1. çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹</h2><p>çº¿ç¨‹æ± çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œ<a href="https://segmentfault.com/a/1190000008693801" target="_blank" rel="noopener">å›¾æº</a>ï¼Œ<br><img src="/images/pasted-142.png" alt="upload successful"><br>javaçš„çº¿ç¨‹æ± æ˜¯æ²¡æœ‰è°ƒåº¦å™¨çš„ã€‚</p>
<h2 id="javaçº¿ç¨‹æ± çš„ç»§æ‰¿ä½“ç³»">1.2. javaçº¿ç¨‹æ± çš„ç»§æ‰¿ä½“ç³»</h2><p>javaçº¿ç¨‹æ± ç›¸å¯¹å‰é¢å‡ ç¯‡å®¹æ˜“çœ‹å¾—å¤šï¼Œå› ä¸ºç”¨äº†ä¸€å †ç°æˆçš„ä¸œè¥¿ğŸ™„<br><img src="/images/pasted-141.png" alt="upload successful"></p>
<ul>
<li>Executoræ¥å£ï¼šExecutoræ¥å£ä¸­å®šä¹‰äº†ä¸€ä¸ªexecuteæ–¹æ³•ï¼Œç”¨æ¥æäº¤çº¿ç¨‹çš„æ‰§è¡Œã€‚</li>
<li>ExecutorServiceï¼šExecutoræ¥å£çš„å­æ¥å£ï¼Œç”¨æ¥ç®¡ç†çº¿ç¨‹çš„æ‰§è¡Œï¼Œæ¯”å¦‚å…³é—­çº¿ç¨‹æ± (shutdown)ç­‰ã€‚</li>
<li>ThreadPoolExecutorï¼šå¤§éƒ¨åˆ†çº¿ç¨‹æ± çš„å®ç°ï¼Œé€šè¿‡ä¸åŒçš„ä¼ å…¥å‚æ•°å®ç°ä¸åŒç‰¹æ€§çš„çº¿ç¨‹æ± ã€‚</li>
<li>ScheduledExecutorServiceï¼šå»¶è¿Ÿæˆ–å‘¨æœŸæ€§çº¿ç¨‹æ± æ¥å£ï¼Œå®šä¹‰äº†å»¶è¿Ÿå’Œå‘¨æœŸæ‰§è¡Œæ¥å£</li>
<li>ScheduledThreadPoolExecutorï¼šå»¶è¿Ÿæˆ–å‘¨æœŸæ€§çº¿ç¨‹æ± å®ç°ã€‚</li>
<li>Executorsï¼šJavaæä¾›çš„ä¸€ä¸ªä¸“é—¨ç”¨äºåˆ›å»ºçº¿ç¨‹æ± çš„å·¥å‚ç±»ï¼ŒExecutorServiceçš„åˆå§‹åŒ–å¯ä»¥ä½¿ç”¨Executorsç±»çš„é™æ€æ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>shutdownåªæ˜¯å°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®ä¸ºSHUTWDOWNçŠ¶æ€ï¼Œæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œæ²¡æœ‰è¢«æ‰§è¡Œçš„åˆ™ä¸­æ–­ã€‚è€ŒshutdownNowåˆ™æ˜¯å°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®ä¸ºSTOPï¼Œæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡åˆ™è¢«åœæ­¢ï¼Œæ²¡è¢«æ‰§è¡Œä»»åŠ¡çš„åˆ™è¿”å›ã€‚</p>
</blockquote>
<h1 id="ThreadPoolExecutor">2. ThreadPoolExecutor</h1><p>çº¿ç¨‹æ± çš„æœ‰è®¸å¤šåˆå§‹åŒ–æ–¹å¼ï¼Œæœ€ç»ˆè½åˆ°è¿™ä¸ªæ„é€ å‡½æ•°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•°</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•°</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">long</span> keepAliveTime, // å¤šä½™çº¿ç¨‹çš„æ´»è·ƒæ—¶é—´</span></span></span><br><span class="line"><span class="function"><span class="params">                          TimeUnit unit, // æ´»è·ƒæ—¶é—´å•ä½</span></span></span><br><span class="line"><span class="function"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue, // ä»»åŠ¡é˜Ÿåˆ—</span></span></span><br><span class="line"><span class="function"><span class="params">                          ThreadFactory threadFactory, // çº¿ç¨‹å·¥å‚</span></span></span><br><span class="line"><span class="function"><span class="params">                          RejectedExecutionHandler handler)</span> </span>&#123; <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†çš„æ‰§è¡Œç­–ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">        keepAliveTime &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">if</span> (workQueue == <span class="keyword">null</span> || threadFactory == <span class="keyword">null</span> || handler == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">this</span>.acc = System.getSecurityManager() == <span class="keyword">null</span> ?</span><br><span class="line">            <span class="keyword">null</span> :</span><br><span class="line">            AccessController.getContext();</span><br><span class="line">    <span class="keyword">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">    <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">    <span class="keyword">this</span>.workQueue = workQueue;</span><br><span class="line">    <span class="keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">    <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">    <span class="keyword">this</span>.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªå±æ€§<code>allowCoreThreadTimeOut</code>ï¼Œé€šè¿‡<code>allowCoreThreadTimeOut(boolean)</code>è®¾ç½®ï¼Œè¡¨ç¤ºæ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ˜¯å¦è¦è¶…æ—¶é”€æ¯ï¼Œåæ­£æˆ‘æ˜¯æ²¡è®¾ç½®è¿‡ - -</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">allowCoreThreadTimeOut</span><span class="params">(<span class="keyword">boolean</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; keepAliveTime &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Core threads must have nonzero keep alive times"</span>);</span><br><span class="line">    <span class="keyword">if</span> (value != allowCoreThreadTimeOut) &#123;</span><br><span class="line">        allowCoreThreadTimeOut = value;</span><br><span class="line">        <span class="keyword">if</span> (value)</span><br><span class="line">            interruptIdleWorkers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡Executorsç±»å®ä¾‹åŒ–ä¸åŒçš„çº¿ç¨‹æ± ï¼š</p>
<ul>
<li>Executors.newCachedThreadPool</li>
<li>Executors.newFixedThreadPool</li>
<li>Executors.newWorkStealingPool</li>
<li>Executors.newSingleThreadExecutor</li>
<li>Executors.newScheduledThreadPool</li>
</ul>
<h2 id="ThreadPoolExecutorçš„é‡è¦å±æ€§">2.1. ThreadPoolExecutorçš„é‡è¦å±æ€§</h2><ul>
<li>corePoolSizeï¼šçº¿ç¨‹çš„æ ¸å¿ƒæ•°é‡</li>
<li>maximumPoolSizeï¼šå½“ä»»åŠ¡é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œæäº¤æ–°ä»»åŠ¡ä¼šåˆ›å»ºæ–°çº¿ç¨‹ï¼Œè¿™ä¸ªå€¼å³æœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œ&gt;=æ ¸å¿ƒçº¿ç¨‹æ•°é‡</li>
<li>keepAliveTimeï¼šè¶…è¿‡æ ¸å¿ƒæ•°é‡æ—¶ï¼Œçº¿ç¨‹çš„æœ€å¤§ç©ºé—²æ—¶é—´/</li>
<li>threadFactoryï¼šåˆ›å»ºçº¿ç¨‹çš„å·¥å‚ç±»ï¼Œé»˜è®¤æ˜¯é»˜è®¤ä¸º<code>Executors.DefaultThreadFactory</code>ï¼Œå®šä¹‰äº†çº¿ç¨‹çš„åå­—</li>
<li>handlerï¼šæ»¡ä»»åŠ¡é˜Ÿåˆ—æ»¡çº¿ç¨‹æ•°çš„æƒ…å†µä¸‹çš„æ‹’ç»ç­–ç•¥ï¼Œé»˜è®¤ä¸º<code>AbortPolicy</code>,æŠ›ä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸</li>
<li>ctlï¼šctl æ˜¯ä¸€ä¸ª AtomicInteger ç±»å‹, å®ƒçš„ ä½29ä½ ç”¨äºå­˜æ”¾å½“å‰çš„çº¿ç¨‹æ•°, å› æ­¤ä¸€ä¸ªçº¿ç¨‹æ± åœ¨ç†è®ºä¸Šæœ€å¤§çš„çº¿ç¨‹æ•°æ˜¯ 536870911; é«˜ 3 ä½æ˜¯ç”¨äºè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€, å…¶ä¸­é«˜ä¸‰ä½çš„å€¼å’ŒçŠ¶æ€å¯¹åº”å¦‚ä¸‹:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// COUNT_BITS = 32 - 3</span></span><br><span class="line"><span class="comment">// å¯ä»¥æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// ä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// ä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¸å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// è¿‡æ¸¡çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†ï¼Œå½“å‰çº¿ç¨‹æ± å·²ç»æ²¡æœ‰æœ‰æ•ˆçš„çº¿ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹æ± çš„çŠ¶æ€å°†ä¼šTIDYINGï¼Œå¹¶ä¸”å°†è¦è°ƒç”¨terminatedæ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// ç»ˆæ­¢çŠ¶æ€ã€‚terminatedæ–¹æ³•è°ƒç”¨å®Œæˆä»¥åçš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br></pre></td></tr></table></figure>

<p>è¿™äº›çŠ¶æ€æ˜¯æŒ‰ç€å¤§å°æ’åºçš„ï¼Œçº¿ç¨‹çš„ä»£ç è®¸å¤šåœ°æ–¹å°†çŠ¶æ€è¿›è¡Œå¤§å°æ¯”è¾ƒï¼Œå¾—å‡ºçº¿ç¨‹æ± çš„ç»ˆæ­¢çš„ç¨‹åº¦ã€‚</p>
<p> å…¶ä»–å±æ€§ï¼Œæœ‰äº›ä¸Šé¢å·²ç»ä»‹ç»äº†,ä¸»è¦æœ‰ä¸ªç‹¬å é”<code>mainLcok</code>,ç»ˆæ­¢æ¡ä»¶å˜é‡<code>termination</code>,å·¥ä½œçº¿ç¨‹å°è£…<code>workers</code><br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ˜¯ä¸€ä¸ªå¤ç”¨å­—æ®µ, å®ƒå¤ç”¨åœ°è¡¨ç¤ºäº†å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€, å½“å‰çº¿ç¨‹æ•°ä¿¡æ¯.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºå­˜æ”¾æäº¤åˆ°çº¿ç¨‹æ± ä¸­, ä½†æ˜¯è¿˜æœªæ‰§è¡Œçš„é‚£äº›ä»»åŠ¡.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± å†…éƒ¨é”, å¯¹çº¿ç¨‹æ± å†…éƒ¨æ“ä½œåŠ é”, é˜²æ­¢ç«æ€æ¡ä»¶</span></span><br><span class="line">    <span class="comment">// å¯¹ workers å­—æ®µçš„æ“ä½œå‰, éœ€è¦è·å–åˆ°è¿™ä¸ªé”.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€ä¸ª Set ç»“æ„, åŒ…å«äº†å½“å‰çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰å·¥ä½œçº¿ç¨‹.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;Worker&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¡ä»¶å˜é‡, ç”¨äºæ”¯æŒ awaitTermination æ“ä½œ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition termination = mainLock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•çº¿ç¨‹æ± ä¸­æ›¾ç»åˆ°è¾¾è¿‡çš„æœ€å¤§çš„çº¿ç¨‹æ•°.</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªå­—æ®µåœ¨è·å– mainLock é”çš„å‰æä¸‹æ‰èƒ½æ“ä½œ.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> largestPoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•å·²ç»å®Œæˆçš„ä»»åŠ¡æ•°. ä»…ä»…å½“å·¥ä½œçº¿ç¨‹ç»“æŸæ—¶æ‰æ›´æ–°æ­¤å­—æ®µ.</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªå­—æ®µåœ¨è·å– mainLock é”çš„å‰æä¸‹æ‰èƒ½æ“ä½œ.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> completedTaskCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿ç¨‹å·¥å‚. å½“éœ€è¦ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ—¶, è¿™é‡Œç”Ÿæˆ.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»»åŠ¡æäº¤å¤±è´¥åçš„å¤„ç† handler</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç©ºé—²çº¿ç¨‹çš„ç­‰å¾…ä»»åŠ¡æ—¶é—´, ä»¥çº³ç§’ä¸ºå•ä½.</span></span><br><span class="line">    <span class="comment">// å½“å½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äº corePoolSize æ—¶, </span></span><br><span class="line">    <span class="comment">// æˆ–è€… allowCoreThreadTimeOut ä¸ºçœŸæ—¶, çº¿ç¨‹æ‰æœ‰ idle ç­‰å¾…è¶…æ—¶æ—¶é—´, </span></span><br><span class="line">    <span class="comment">// å¦‚æœè¶…æ—¶åˆ™æ­¤çº¿ç¨‹ä¼šåœæ­¢.; </span></span><br><span class="line">    <span class="comment">// åä¹‹çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…æ–°ä»»åŠ¡åˆ°æ¥.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> keepAliveTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤ä¸º false.</span></span><br><span class="line">    <span class="comment">// å½“ä¸º false æ—¶, keepAliveTime ä¸èµ·ä½œç”¨, çº¿ç¨‹æ± ä¸­çš„ core çº¿ç¨‹ä¼šä¸€ç›´å­˜æ´», </span></span><br><span class="line">    <span class="comment">// å³ä½¿è¿™äº›çº¿ç¨‹æ˜¯ idle çŠ¶æ€.</span></span><br><span class="line">    <span class="comment">// å½“ä¸º true æ—¶, core çº¿ç¨‹ä½¿ç”¨ keepAliveTime ä½œä¸º idle è¶…æ—¶</span></span><br><span class="line">    <span class="comment">// æ—¶é—´æ¥ç­‰å¾…æ–°çš„ä»»åŠ¡.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> allowCoreThreadTimeOut;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¸å¿ƒçº¿ç¨‹æ•°.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> corePoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€å¤§çº¿ç¨‹æ•°.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> maximumPoolSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="æäº¤ä»»åŠ¡">2.2. æäº¤ä»»åŠ¡</h2><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯æäº¤ä»»åŠ¡çš„ä¸»æµç¨‹äº†ï¼Œåˆ†ä¸ºä¸‰æ­¥</p>
<ol>
<li>çº¿ç¨‹æ•°å°äºcorePoolSizeï¼Œå°è¯•æ·»åŠ Workerå¹¶æäº¤ä»»åŠ¡åˆ°ä»»åŠ¡åˆ°worker,trueè¡¨ç¤ºæ ¸å¿ƒçº¿ç¨‹</li>
<li>ä»»åŠ¡å…¥é˜ŸæˆåŠŸï¼ŒäºŒæ¬¡æ ¡éªŒçº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œæ˜¯å¦éœ€è¦æ‹’ç»ä»»åŠ¡æˆ–è€…å¢åŠ worker</li>
<li>å¢åŠ å·¥ä½œçº¿ç¨‹ï¼Œfalseè¡¨ç¤ºè¶…æ ¸å¿ƒæ•°é‡çš„çº¿ç¨‹</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="comment">// step 1</span></span><br><span class="line">    <span class="comment">// workerCountOf(c)å–ä½29ä½</span></span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// step 2</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">        <span class="comment">// å¦‚æœä¸åœ¨è¿è¡ŒçŠ¶æ€ä¸”ä»»åŠ¡æœªè¢«æ¶ˆè´¹ï¼Œremove(command)==trueï¼Œåˆ™æ‹’ç»ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// step 3</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹addWorker(command, true)å‰ï¼Œçœ‹Workerç±»ï¼Œæ˜¯å¯¹çº¿ç¨‹çš„å°è£…,å®ç°äº†Runnableï¼Œç»§æ‰¿äº†AQSï¼Œæ‰€æœ‰æœ‰é”çš„èƒ½åŠ›ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span></span></span><br><span class="line"><span class="class">      <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span></span></span><br><span class="line"><span class="class">      <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class">  </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6138294804551838833L</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// çº¿ç¨‹å¼•ç”¨</span></span><br><span class="line">      <span class="keyword">final</span> Thread thread;</span><br><span class="line">      <span class="comment">// åˆ›å»ºçº¿ç¨‹æ—¶å¸¦çš„ä»»åŠ¡</span></span><br><span class="line">      Runnable firstTask;</span><br><span class="line">      <span class="comment">/** Per-thread task counter */</span></span><br><span class="line">      <span class="keyword">volatile</span> <span class="keyword">long</span> completedTasks;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ æ–¹æ³•</span></span><br><span class="line">      Worker(Runnable firstTask) &#123;</span><br><span class="line">          setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">          <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">          <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/** Delegates main run loop to outer runWorker  */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          runWorker(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Lock methods</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// The value 0 represents the unlocked state.</span></span><br><span class="line">      <span class="comment">// The value 1 represents the locked state.</span></span><br><span class="line"><span class="comment">// é0è¡¨ç¤ºè¯¥å·¥ä½œçº¿ç¨‹è¢«å æœ‰</span></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> getState() != <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">              setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">          setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">          setState(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span>        </span>&#123; acquire(<span class="number">1</span>); &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span>  </span>&#123; <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span>      </span>&#123; release(<span class="number">1</span>); &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> isHeldExclusively(); &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          Thread t;</span><br><span class="line">          <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  t.interrupt();</span><br><span class="line">              &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="è¿è¡Œä»»åŠ¡">2.3. è¿è¡Œä»»åŠ¡</h2><p>å¯ä»¥çœ‹åˆ°<code>newThread(this)</code>æ–¹æ³•æ˜¯ä¼ å…¥è‡ªèº«ï¼Œæˆ‘ä»¬çœ‹ä»–çš„<code>run()</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    runWorker(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">    Thread wt = Thread.currentThread();</span><br><span class="line">    <span class="comment">// å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">    Runnable task = w.firstTask;</span><br><span class="line">    w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	è¿™é‡Œå°±æ˜¯çº¿ç¨‹ä¸æ–­æ‹¿ä»»åŠ¡çš„åŸç†ï¼Œé€šè¿‡ä¸€ä¸ª<span class="keyword">while</span>å®ç°</span><br><span class="line">        <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">            <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">            <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">            <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">            <span class="comment">// ä¸€äº›ä¸­æ–­çš„åˆ¤æ–­ï¼Œlock()è°ƒç”¨äº†AQSçš„acquire()æ–¹æ³•ï¼Œä¸­æ–­æ˜¯ä¸ä¼šé‡Šæ”¾é”çš„</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            	<span class="comment">// å¥½å§ï¼Œé»˜è®¤å®ç°è¿™é‡Œæ˜¯ç©ºçš„ï¼Œå¦‚æœè¦è‡ªå·±å®šä¹‰çº¿ç¨‹æ± å¯ä»¥</span></span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                	<span class="comment">// è·‘taskå•¦</span></span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                	<span class="comment">// ä¾æ—§ç©ºå®ç°</span></span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                task = <span class="keyword">null</span>;</span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ²¡ä»»åŠ¡å¯ä»¥æ‹¿çš„æ—¶å€™ï¼Œå·¥ä½œçº¿ç¨‹å°±ä¼šè·³å‡ºwhileä»è€Œç»ˆæ­¢äº†ï¼Œæ‰€ä»¥æ²¡ä»»åŠ¡çš„æ—¶å€™æƒ³ä¿æŒçº¿ç¨‹ä¸è¢«é”€æ¯ï¼Œå°±å¾—åœ¨<code>getTask()</code>é˜»å¡ï¼Œå…·ä½“åé¢å°èŠ‚ä¼šè®²ã€‚</p>
<p>å½“ä»»åŠ¡æ‹¿å®Œçš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šæ‰§è¡Œ<code>processWorkerExit(w, completedAbruptly)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// éæ­£å¸¸ç»“æŸï¼ˆæŠ›å¼‚å¸¸äº†ï¼‰ï¼Œé‚£ä¹ˆè¦å‡å»çº¿ç¨‹æ•°é‡è¡¥æ•‘ä¸€ä¸‹</span></span><br><span class="line">    <span class="keyword">if</span> (completedAbruptly) <span class="comment">// If abrupt, then workerCount wasn't adjusted</span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        completedTaskCount += w.completedTasks;</span><br><span class="line">        workers.remove(w);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tryTerminate();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// æ¸…é™¤çº¿ç¨‹åçš„æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">            <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">            <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">                min = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// replacement not needed</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æ„å¤–ä¸­æ–­ï¼Œä¸”æ ¸å¿ƒå·¥ä½œçº¿ç¨‹ä¸å¤Ÿï¼Œè¦è¡¥å›worker</span></span><br><span class="line">        addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•ä¸€å¼€å§‹ä¼šåˆ¤æ–­æ˜¯å¦æ­£å¸¸ç»ˆæ­¢ï¼Œéæ­£å¸¸ç»ˆæ­¢ä¼šæ‰§è¡Œ<code>decrementWorkerCount()</code>æ¥å‡å°‘å·¥ä½œçº¿ç¨‹æ•°é‡ã€‚</p>
<p>é‚£æ­£å¸¸ç»ˆæ­¢å‘¢æ€ä¹ˆå‡æ•°é‡å‘¢ï¼Œ<code>runWorker</code>æ²¡å†™ï¼Œè¿™ä¸€æ­¥éª¤ä¹Ÿæ”¾åˆ°<code>getTask()</code>é‡Œå»æ‰§è¡Œäº†</p>
<p>å·¥ä½œçº¿ç¨‹ç»“æŸåï¼Œçœ‹æ˜¯å¦éœ€è¦ç»ˆæ­¢çº¿ç¨‹æ± ï¼Œ<code>tryTerminate()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryTerminate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="comment">// å¦‚æœåœ¨è¿è¡Œï¼Œæˆ–è€…å·²ç»åœ¨ç»ˆæ­¢ä¸­ï¼ˆTIDYINGï¼‰ï¼Œæˆ–è€…åˆšå‘èµ·ç»ˆæ­¢æŒ‡ä»¤ï¼ˆSHUTDOWNï¼‰ä½†æ˜¯ä»»åŠ¡é˜Ÿåˆ—è¿˜æ²¡å®Œï¼ˆisEmptyï¼‰ï¼Œé‚£ä¹ˆä¸éœ€è¦æ‰§è¡Œç»ˆæ­¢çº¿ç¨‹æ± ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) || </span><br><span class="line">            runStateAtLeast(c, TIDYING) ||</span><br><span class="line">            (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) &#123; <span class="comment">// Eligible to terminate</span></span><br><span class="line">        	<span class="comment">// çº¿ç¨‹æ± SHUTFDOWNï¼Œä»»åŠ¡å¯¹åˆ—å·²ç©ºï¼Œä¸­æ–­æ‰€æœ‰å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">            interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">// casè®¾ç½®ç»ˆæ­¢ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    terminated();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</span><br><span class="line">                    termination.signalAll();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// caså¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€è½®å§</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tryTerminate()</code>è¿”å›ä¹‹åï¼Œä¸»æµç¨‹æ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œçœ‹éœ€è¦ä¸éœ€è¦è¡¥å›é”€æ¯çš„å·¥ä½œçº¿ç¨‹ã€‚</p>
<p>ä»¥ä¸Šæ˜¯å·¥ä½œçº¿ç¨‹çš„è¿è¡Œè¿‡ç¨‹ã€‚</p>
<h2 id="æ·»åŠ å·¥ä½œçº¿ç¨‹">2.4. æ·»åŠ å·¥ä½œçº¿ç¨‹</h2><p>ä¸‹é¢æ˜¯æ·»åŠ addWorkerçš„éƒ¨åˆ† </p>
<blockquote>
<p><code>retry:</code>æ˜¯æ ‡ç­¾(Label)è¯­æ³•ï¼Œå¯ä»¥æ‰§è¡Œå¤šå±‚å¾ªç¯çš„breakå’Œcontinue</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">            ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">               firstTask == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// é€šè¿‡æ§åˆ¶æ•°é‡æ¥é˜²æ­¢å¹¶å‘</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">            <span class="comment">// å¦‚æœè¿è¡ŒçŠ¶æ€ä¸ä¸€è‡´äº†ï¼Œé‡æ–°æ‰§è¡Œå¤–å±‚çš„è¿è¡ŒçŠ¶æ€æ ¡éªŒ</span></span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">            <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</span><br><span class="line">    Worker w = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        w = <span class="keyword">new</span> Worker(firstTask);</span><br><span class="line">        <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Recheck while holding lock.</span></span><br><span class="line">                <span class="comment">// Back out on ThreadFactory failure or if</span></span><br><span class="line">                <span class="comment">// shut down before lock acquired.</span></span><br><span class="line">                <span class="keyword">int</span> rs = runStateOf(ctl.get());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// rs &lt; SHUTDOWN å³ rs = RUNNING</span></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                    (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="keyword">int</span> s = workers.size();</span><br><span class="line">                    <span class="comment">// æ›´æ–°æœ€å¤§è®°å½•</span></span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    workerAdded = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">            	<span class="comment">// å¦‚æœæˆåŠŸåˆ›å»ºå¹¶æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆé‡Œï¼Œçº¿ç¨‹å¼€å§‹è·‘</span></span><br><span class="line">                t.start();</span><br><span class="line">                workerStarted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">   		<span class="comment">// å–„åå·¥ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨ï¼Œå¦çš„æƒ…å†µä¸‹ï¼Œå¤–éƒ¨è°ƒç”¨ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼Œé»˜è®¤æŠ›å¼‚å¸¸ã€‚</p>
<h2 id="å·¥ä½œçº¿ç¨‹çš„-idle-è¶…æ—¶å¤„ç†">2.5. å·¥ä½œçº¿ç¨‹çš„ idle è¶…æ—¶å¤„ç†</h2><p>åœ¨è¿è¡Œä»»åŠ¡çš„å°èŠ‚ï¼Œæœ‰ä¸ª<code>getTask()</code>æ–¹æ³•ï¼Œå¦‚æœæ‹¿ä¸åˆ°ä»»åŠ¡ï¼Œé‚£å·¥ä½œçº¿ç¨‹å°±å¾—ç»“æŸäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹çœ‹<code>getTask()</code>çš„ç­–ç•¥æ˜¯ä»€ä¹ˆã€‚</p>
<p>å·¥ä½œçº¿ç¨‹çš„ idle è¶…å‡ºå¤„ç†åœ¨åº•å±‚ä¾èµ–äº BlockingQueue å¸¦è¶…æ—¶çš„ poll æ–¹æ³•, å³å·¥ä½œçº¿ç¨‹ä¼šä¸æ–­åœ°ä» workQueue è¿™ä¸ª BlockingQueue ä¸­è·å–ä»»åŠ¡, å¦‚æœ allowCoreThreadTimeOut å­—æ®µä¸º true, æˆ–è€…å½“å‰çš„å·¥ä½œçº¿ç¨‹æ•°å¤§äº corePoolSize, é‚£ä¹ˆçº¿ç¨‹çš„ idle è¶…æ—¶æœºåˆ¶å°±ç”Ÿæ•ˆäº†, æ­¤æ—¶å·¥ä½œçº¿ç¨‹ä¼šä»¥å¸¦è¶…æ—¶çš„ poll æ–¹å¼ä» workQueue ä¸­è·å–ä»»åŠ¡. å½“è¶…æ—¶äº†è¿˜æ²¡æœ‰è·å–åˆ°ä»»åŠ¡, é‚£ä¹ˆæˆ‘ä»¬å°±çŸ¥é“æ­¤çº¿ç¨‹ä¸€ä¸ªåˆ°è¾¾ idle è¶…æ—¶æ—¶é—´, å› æ­¤ç»ˆæ­¢æ­¤å·¥ä½œçº¿ç¨‹.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Are workers subject to culling?</span></span><br><span class="line">        <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">            &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runnable r = timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                workQueue.take(); <span class="comment">// é˜»å¡</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            timedOut = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">            timedOut = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Future">2.6. Future</h2><ul>
<li>Future å¯ä»¥æ‹¿åˆ°çº¿ç¨‹æ± ä»»åŠ¡çš„è¿è¡Œç»“æœï¼Œæ˜¯å¯¹ä»»åŠ¡çš„å°è£…ï¼Œ</li>
<li>ä»»åŠ¡å¿…éœ€æ˜¯Callableç±»å‹çš„ä»»åŠ¡<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callable</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Computes a result, or throws an exception if unable to do so.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> computed result</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception if unable to compute a result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">V <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mayInterruptIfRunning ä»»åŠ¡åœ¨workerè·‘çš„æ—¶å€™æ˜¯å¦èƒ½è¢«å–æ¶ˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜»å¡ç›´åˆ°æ‹¿åˆ°è¿è¡Œç»“æœ</span></span><br><span class="line">    <span class="function">V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸¦è¶…æ—¶çš„get(0</span></span><br><span class="line">    <span class="function">V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ThreadPoolExecutor</code>é€šè¿‡çˆ¶ç±»<code>AbstractExecutorService</code>çš„<code>submit(Runnable task)</code>æ–¹æ³•ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, <span class="keyword">null</span>);</span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FutureTask</span><span class="params">(Callable&lt;V&gt; callable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callable == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">this</span>.callable = callable;</span><br><span class="line">    <span class="keyword">this</span>.state = NEW;       <span class="comment">// ensure visibility of callable</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°Futureçš„åŸç†æ˜¯ç”¨ä¸€ä¸ª<code>FutureTask</code>(æˆ‘ä»¬è¿™ç¯‡å°±åªçœ‹è¿™ä¸ªç±»)ç±»å¯¹ä»»åŠ¡è¿›è¡Œå°è£…ï¼Œä¸‹é¢æ˜¯ <code>FutureTask</code>çš„å‡ ä¸ªçŠ¶æ€å’Œä¸€äº›å±æ€§ï¼Œä»å­—é¢ä¸Šå¯ä»¥çœ‹å‡ºå„ä¸ªçŠ¶æ€ä»£è¡¨çš„æ„æ€ï¼Œè¿™å‡ ä¸ªçŠ¶æ€å’Œçº¿ç¨‹æ± çš„çŠ¶æ€ä¸€æ ·æ˜¯å¤§å°ä¸æ˜¯éšä¾¿å®šçš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">    * Possible state transitions:</span></span><br><span class="line"><span class="comment">    * NEW -&gt; COMPLETING -&gt; NORMAL</span></span><br><span class="line"><span class="comment">    * NEW -&gt; COMPLETING -&gt; EXCEPTIONAL</span></span><br><span class="line"><span class="comment">    * NEW -&gt; CANCELLED</span></span><br><span class="line"><span class="comment">    * NEW -&gt; INTERRUPTING -&gt; INTERRUPTED</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NEW          = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLETING   = <span class="number">1</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NORMAL       = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXCEPTIONAL  = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED    = <span class="number">4</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTERRUPTING = <span class="number">5</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTERRUPTED  = <span class="number">6</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// è¿è¡Œè¿™ä¸ªrunçš„çº¿ç¨‹ï¼Œå³çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> Thread runner;</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   <span class="comment">// è°ƒç”¨äº†get()çš„ç­‰å¾…çº¿ç¨‹ï¼Œæ˜¯ä¸ªé“¾è¡¨</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> WaitNode waiters;</span><br></pre></td></tr></table></figure>

<h3 id="è¿è¡Œä»»åŠ¡-1">2.6.1. è¿è¡Œä»»åŠ¡</h3><p>å½“çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹çš„è¿è¡Œä»»åŠ¡çš„<code>run()</code>çš„çš„æ—¶å€™ï¼Œ<code>FutureTask</code>å°±ä¼šè°ƒç”¨ä»»åŠ¡çš„<code>call()</code>ï¼Œå¹¶å°†å­˜å‚¨è¿è¡Œç»“æœã€‚</p>
<p>æˆ‘ä»¬çœ‹<code>FutureTask</code>çš„<code>run()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰äººç»ˆæ­¢ä»»åŠ¡ï¼Œstateä¾æ—§æ˜¯NEWï¼Œåˆ™casè®¾ç½®å·¥ä½œçº¿ç¨‹ï¼Œå¤±è´¥åˆ™ç›´æ¥ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (state != NEW ||</span><br><span class="line">        !UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, runnerOffset,</span><br><span class="line">                                     <span class="keyword">null</span>, Thread.currentThread()))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Callable&lt;V&gt; c = callable;</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == NEW) &#123;</span><br><span class="line">            V result;</span><br><span class="line">            <span class="keyword">boolean</span> ran;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = c.call();</span><br><span class="line">                ran = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                result = <span class="keyword">null</span>;</span><br><span class="line">                ran = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// å¼‚å¸¸å®Œæˆçš„å¤„ç†æ–¹å¼</span></span><br><span class="line">                setException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ran)</span><br><span class="line">                <span class="comment">// æ­£å¸¸å®Œæˆï¼Œæ›´æ–°çŠ¶æ€ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line">                set(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// runner must be non-null until state is settled to</span></span><br><span class="line">        <span class="comment">// prevent concurrent calls to run()</span></span><br><span class="line">        runner = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// state must be re-read after nulling runner to prevent</span></span><br><span class="line">        <span class="comment">// leaked interrupts</span></span><br><span class="line">        <span class="keyword">int</span> s = state;</span><br><span class="line">        <span class="comment">// å¦‚æœä»»åŠ¡è¢«å–æ¶ˆï¼Œè°ƒç”¨Thread.yield();ç›´åˆ°å–„åå·¥ä½œåšå®Œï¼ŒçŠ¶æ€å˜æˆINTERRUPTED</span></span><br><span class="line">        <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(V v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="keyword">this</span>, stateOffset, NEW, COMPLETING)) &#123;</span><br><span class="line">        outcome = v;</span><br><span class="line">        UNSAFE.putOrderedInt(<span class="keyword">this</span>, stateOffset, NORMAL); <span class="comment">// final state</span></span><br><span class="line">        <span class="comment">// æ›´æ–°çŠ¶æ€ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä»»åŠ¡å®Œæˆ">2.6.2. ä»»åŠ¡å®Œæˆ</h3><p>ä»»åŠ¡å®Œæˆçš„æ–¹æ³•ï¼Œåªæœ‰å››ç§ï¼šæ­£å¸¸ã€å¼‚å¸¸ã€å–æ¶ˆã€ä¸­æ–­å·¥ä½œçº¿ç¨‹ï¼Œæ¯ç§<br>åˆ†åˆ«è°ƒç”¨<code>set(result)</code>,<code>setException(ex)</code>,<code>cancel(boolean)</code>ï¼Œå…¶ä¸­å–æ¶ˆå’Œä¸­æ–­éƒ½æ˜¯è°ƒç”¨<code>cancel(boolean)</code>ï¼Œé€šè¿‡å‚æ•°æ§åˆ¶ï¼Œè¿™å‡ ç§æ–¹æ³•éƒ½ä¼šè°ƒç”¨<code>finishCompletion()</code>,é€ä¸€å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ï¼ˆæ¯”å¦‚ä¸Šé¢<code>set(V v)</code>çš„è°ƒç”¨ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishCompletion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert state &gt; COMPLETING;</span></span><br><span class="line">    <span class="keyword">for</span> (WaitNode q; (q = waiters) != <span class="keyword">null</span>;) &#123;</span><br><span class="line">        <span class="comment">// å°†æ•´ä¸ªwaitersé“¾è¡¨å¼•ç”¨ç½®ä¸ºnullï¼Œæ–¹ä¾¿gc</span></span><br><span class="line">        <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, waitersOffset, q, <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">// ä¸€ä¸€å”¤é†’	</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                Thread t = q.thread;</span><br><span class="line">                <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    q.thread = <span class="keyword">null</span>;</span><br><span class="line">                    LockSupport.unpark(t);</span><br><span class="line">                &#125;</span><br><span class="line">                WaitNode next = q.next;</span><br><span class="line">                <span class="keyword">if</span> (next == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                q.next = <span class="keyword">null</span>; <span class="comment">// unlink to help gc</span></span><br><span class="line">                q = next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é¢„ç•™ç»™å­ç±»çš„ç©ºå‡½æ•°</span></span><br><span class="line">    done();</span><br><span class="line"></span><br><span class="line">    callable = <span class="keyword">null</span>;        <span class="comment">// to reduce footprint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è·å–ç»“æœ">2.6.3. è·å–ç»“æœ</h3><p>æŒºå®¹æ˜“ç†è§£çš„ä»£ç ï¼Œæ¥ä¸‹æ¥çœ‹<code>get()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s = state;</span><br><span class="line">    <span class="keyword">if</span> (s &lt;= COMPLETING)</span><br><span class="line">        <span class="comment">// 0Læ˜¯æ— è¶…æ—¶æ—¶é—´</span></span><br><span class="line">        s = awaitDone(<span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">    <span class="keyword">return</span> report(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>get()</code>è°ƒç”¨çš„æ—¶å€™<code>s &lt;= COMPLETING</code>,å³æœªç»ˆæ­¢æˆ–è€…æœªå®Œæˆï¼Œåˆ™è°ƒç”¨<code>awaitDone(false, 0L)</code>ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é“¾è¡¨ï¼Œå› ä¸ºget()å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œæ‰€ä»¥ç»´æŠ¤ä¸€ä¸ªé“¾è¡¨æ¥å­˜å‚¨è¿™äº›çº¿ç¨‹ã€‚ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼ˆæ— è®ºæ„å¤–è¿˜æ˜¯æ­£å¸¸ï¼‰ä¼šè°ƒç”¨`finishCompletion()`å”¤é†’æ‰€æœ‰è¿˜åœ¨æŒ‚èµ·çš„çº¿ç¨‹</span></span><br><span class="line"><span class="comment">// è¿™æ˜¯ä¸€ä¸ªæ–°èŠ‚ç‚¹æ’åœ¨å¤´éƒ¨çš„é“¾è¡¨</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">    <span class="keyword">volatile</span> WaitNode next;</span><br><span class="line">    WaitNode() &#123; thread = Thread.currentThread(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†çº¿ç¨‹ä»åˆ—è¡¨</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeWaiter</span><span class="params">(WaitNode node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// node == null ä»€ä¹ˆéƒ½ä¸åš</span></span><br><span class="line">    <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</span><br><span class="line">        node.thread = <span class="keyword">null</span>;</span><br><span class="line">        retry:</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;          <span class="comment">// restart on removeWaiter race</span></span><br><span class="line">            <span class="keyword">for</span> (WaitNode pred = <span class="keyword">null</span>, q = waiters, s; q != <span class="keyword">null</span>; q = s) &#123;</span><br><span class="line">                s = q.next;</span><br><span class="line">                <span class="keyword">if</span> (q.thread != <span class="keyword">null</span>)</span><br><span class="line">                    pred = q;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pred.next = s;</span><br><span class="line">                    <span class="keyword">if</span> (pred.thread == <span class="keyword">null</span>) <span class="comment">// check for race</span></span><br><span class="line">                        <span class="keyword">continue</span> retry;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, waitersOffset,</span><br><span class="line">                                                      q, s))</span><br><span class="line">                    <span class="keyword">continue</span> retry;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">awaitDone</span><span class="params">(<span class="keyword">boolean</span> timed, <span class="keyword">long</span> nanos)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> deadline = timed ? System.nanoTime() + nanos : <span class="number">0L</span>;</span><br><span class="line">    WaitNode q = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> queued = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    	<span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            removeWaiter(q);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> s = state;</span><br><span class="line">        <span class="keyword">if</span> (s &gt; COMPLETING) &#123;</span><br><span class="line">            <span class="keyword">if</span> (q != <span class="keyword">null</span>)</span><br><span class="line">                q.thread = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s == COMPLETING) <span class="comment">// cannot time out yet</span></span><br><span class="line">            Thread.yield();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (q == <span class="keyword">null</span>)</span><br><span class="line">            q = <span class="keyword">new</span> WaitNode();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!queued)</span><br><span class="line">            <span class="comment">// å¾ˆèŠ±å“¨åœ°æŠŠæ–°åœ°é˜»å¡çº¿ç¨‹èŠ‚ç‚¹æ”¾åˆ°é“¾è¡¨å¤´</span></span><br><span class="line">            queued = UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, waitersOffset,</span><br><span class="line">                                                 q.next = waiters, q);</span><br><span class="line">        <span class="comment">// è®¾ç½®äº†è¶…æ—¶çš„æŒ‚èµ·æ–¹å¼</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                removeWaiter(q);</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å®šæ—¶æŒ‚èµ·</span></span><br><span class="line">            LockSupport.parkNanos(<span class="keyword">this</span>, nanos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// æ— é™æŒ‚èµ·ï¼Œç›´åˆ°å®Œæˆå”¤é†’</span></span><br><span class="line">            LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://htchz.cc/1860367337.html" title="[JavaåŸºç¡€]ThreadPoolExecutor" target="_blank" rel="external">https://htchz.cc/1860367337.html</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong> æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CNåè®®</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/fennecs" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/unnamed.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/fennecs" target="_blank"><span class="text-dark">åœŸå·</span><small class="ml-1x">åç«¯ç å†œ</small></a></h3>
        <div>è¯·è¯´å‡ºHello Worldçš„16ç§å†™æ³•ã€‚</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/967765342.html" title="[JavaåŸºç¡€]ScheduledThreadPoolExecutor"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;ä¸Šä¸€ç¯‡</span></a>
    </li>
    
    
    <li class="next">
      <a href="/3516892559.html" title="[JavaåŸºç¡€]BlockingQueue"><span>ä¸‹ä¸€ç¯‡&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn" data-toggle="collapse" href="#collapseToc" aria-expanded="true" title="æ–‡ç« ç›®å½•" role="button">
        <span>[&nbsp;</span><span>æ–‡ç« ç›®å½•</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/fennecs" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'æ–‡ç« ',
            PAGES: 'é¡µé¢',
            CATEGORIES: 'åˆ†ç±»',
            TAGS: 'æ ‡ç­¾',
            UNTITLED: '(æœªå‘½å)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
    <script defer>
    var disqus_config = function () {
        
            this.page.url = 'https://htchz.cc/1860367337.html';
        
        this.page.identifier = 'JavaåŸºç¡€-ThreadPoolExecutor';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'htchz' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //åˆ©ç”¨ FancyBox å®ç°ç‚¹å‡»å›¾ç‰‡æ”¾å¤§
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>





</body>
</html>