<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>[分布式]手撕raft | 土川的自留地</title>
  <meta name="description" content="1. 前言Raft作为一个简单的一致性算法，实现一下还是挺好玩的。代码基于6.824 lab-raft，6.824是麻省理工的分布式课程的一个编号，里面有4个lab，第二个就是raft协议的实现，第三个是基于raft协议的kv存储设计，有待实现（oh我居然在做麻省理工的课程设计）。该lab要求使用go实现算法，并提供了一个具有故障模拟功能的RPC，即通过模拟网络，在单台机器我们就可以运行raft算">
<meta name="keywords" content="raft">
<meta property="og:type" content="article">
<meta property="og:title" content="[分布式]手撕raft">
<meta property="og:url" content="https://htchz.cc/1823228532.html">
<meta property="og:site_name" content="土川的自留地">
<meta property="og:description" content="1. 前言Raft作为一个简单的一致性算法，实现一下还是挺好玩的。代码基于6.824 lab-raft，6.824是麻省理工的分布式课程的一个编号，里面有4个lab，第二个就是raft协议的实现，第三个是基于raft协议的kv存储设计，有待实现（oh我居然在做麻省理工的课程设计）。该lab要求使用go实现算法，并提供了一个具有故障模拟功能的RPC，即通过模拟网络，在单台机器我们就可以运行raft算">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://htchz.cc/images/20191004005135.png">
<meta property="og:updated_time" content="2020-02-23T04:26:12.496Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[分布式]手撕raft">
<meta name="twitter:description" content="1. 前言Raft作为一个简单的一致性算法，实现一下还是挺好玩的。代码基于6.824 lab-raft，6.824是麻省理工的分布式课程的一个编号，里面有4个lab，第二个就是raft协议的实现，第三个是基于raft协议的kv存储设计，有待实现（oh我居然在做麻省理工的课程设计）。该lab要求使用go实现算法，并提供了一个具有故障模拟功能的RPC，即通过模拟网络，在单台机器我们就可以运行raft算">
<meta name="twitter:image" content="https://htchz.cc/images/20191004005135.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://htchz.cc/1823228532.html">
  
    <link rel="alternate" href="/atom.xml" title="土川的自留地" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/unnamed.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
</head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/fennecs" target="_blank">
          <img class="img-circle img-rotate" src="/images/unnamed.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">土川</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">后端码农</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Guangzhou, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/fennecs" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>碧油鸡!碧油鸡！</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Firebase/">Firebase</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang基础/">Golang基础</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a><span class="category-list-count">36</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Proxy/">Proxy</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器/">容器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/建站/">建站</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器/">服务器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/">AOP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BT/">BT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BUG/">BUG</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bean/">Bean</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GC/">GC</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Https/">Https</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hystrix/">Hystrix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IOC/">IOC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java集合/">Java集合</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Json/">Json</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/">NIO</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OOP/">OOP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/">TCP</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZAB/">ZAB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bbr/">bbr</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deploy/">deploy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/goroutine/">goroutine</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/">iptables</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/istio/">istio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdk8/">jdk8</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/">k8s</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/multithread/">multithread</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/properties/">properties</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raft/">raft</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/一致性算法/">一致性算法</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/事务/">事务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/位图/">位图</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/位运算/">位运算</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/坑/">坑</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据分片/">数据分片</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/服务限流/">服务限流</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/正则/">正则</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/运维/">运维</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/AOP/" style="font-size: 13.33px;">AOP</a> <a href="/tags/BT/" style="font-size: 13px;">BT</a> <a href="/tags/BUG/" style="font-size: 13.5px;">BUG</a> <a href="/tags/Bean/" style="font-size: 13px;">Bean</a> <a href="/tags/GC/" style="font-size: 13.67px;">GC</a> <a href="/tags/HTTP/" style="font-size: 13px;">HTTP</a> <a href="/tags/Hexo/" style="font-size: 13px;">Hexo</a> <a href="/tags/Https/" style="font-size: 13px;">Https</a> <a href="/tags/Hystrix/" style="font-size: 13px;">Hystrix</a> <a href="/tags/IOC/" style="font-size: 13px;">IOC</a> <a href="/tags/JVM/" style="font-size: 13.83px;">JVM</a> <a href="/tags/Java集合/" style="font-size: 13.17px;">Java集合</a> <a href="/tags/Json/" style="font-size: 13px;">Json</a> <a href="/tags/Mysql/" style="font-size: 13.17px;">Mysql</a> <a href="/tags/NIO/" style="font-size: 13.17px;">NIO</a> <a href="/tags/Nginx/" style="font-size: 13px;">Nginx</a> <a href="/tags/OOP/" style="font-size: 13.33px;">OOP</a> <a href="/tags/TCP/" style="font-size: 13.17px;">TCP</a> <a href="/tags/ZAB/" style="font-size: 13px;">ZAB</a> <a href="/tags/bbr/" style="font-size: 13px;">bbr</a> <a href="/tags/deploy/" style="font-size: 13px;">deploy</a> <a href="/tags/goroutine/" style="font-size: 13.17px;">goroutine</a> <a href="/tags/iptables/" style="font-size: 13px;">iptables</a> <a href="/tags/istio/" style="font-size: 13px;">istio</a> <a href="/tags/jdk8/" style="font-size: 13.17px;">jdk8</a> <a href="/tags/k8s/" style="font-size: 13.17px;">k8s</a> <a href="/tags/multithread/" style="font-size: 14px;">multithread</a> <a href="/tags/properties/" style="font-size: 13px;">properties</a> <a href="/tags/raft/" style="font-size: 13.17px;">raft</a> <a href="/tags/一致性算法/" style="font-size: 13.17px;">一致性算法</a> <a href="/tags/事务/" style="font-size: 13px;">事务</a> <a href="/tags/位图/" style="font-size: 13px;">位图</a> <a href="/tags/位运算/" style="font-size: 13px;">位运算</a> <a href="/tags/坑/" style="font-size: 13px;">坑</a> <a href="/tags/数据分片/" style="font-size: 13px;">数据分片</a> <a href="/tags/服务限流/" style="font-size: 13.17px;">服务限流</a> <a href="/tags/正则/" style="font-size: 13px;">正则</a> <a href="/tags/运维/" style="font-size: 13px;">运维</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">23</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse in" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">1. 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实现"><span class="toc-text">2. 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据结构"><span class="toc-text">2.1. 数据结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一些封装"><span class="toc-text">2.2. 一些封装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#raft实例初始化"><span class="toc-text">2.3. raft实例初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#votedFor清空时机"><span class="toc-text">2.4. votedFor清空时机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#投票发起与接收"><span class="toc-text">2.5. 投票发起与接收</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#broadcastVote-发起投票"><span class="toc-text">2.5.1. broadcastVote() 发起投票</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RequestVote-接收投票"><span class="toc-text">2.5.2. RequestVote 接收投票</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#日志复制与接收"><span class="toc-text">2.6. 日志复制与接收</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#broadcastAppendEntries-广播日志-心跳"><span class="toc-text">2.6.1. broadcastAppendEntries 广播日志/心跳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AppendEntries-接收日志"><span class="toc-text">2.6.2. AppendEntries 接收日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#将提交的日志应用至状态机"><span class="toc-text">2.7. 将提交的日志应用至状态机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#持久化"><span class="toc-text">2.8. 持久化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#后记"><span class="toc-text">3. 后记</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-分布式-手撕raft" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      [分布式]手撕raft
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/1823228532.html" class="article-date">
	  <time datetime="2019-10-03T08:27:57.000Z" itemprop="datePublished">2019-10-03</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/分布式/">分布式</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/raft/">raft</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/1823228532.html#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 2.9k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 13(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="前言">1. 前言</h1><p>Raft作为一个简单的一致性算法，实现一下还是挺好玩的。代码基于<strong>6.824</strong> <a href="http://nil.csail.mit.edu/6.824/2018/labs/lab-raft.html" target="_blank" rel="noopener">lab-raft</a>，<strong>6.824</strong>是麻省理工的分布式课程的一个编号，里面有4个lab，第二个就是raft协议的实现，第三个是基于raft协议的kv存储设计，有待实现（oh我居然在做麻省理工的课程设计）。该lab要求使用go实现算法，并提供了一个<a href="http://oserror.com/distributed/golang-rpc-with-failure-simulation/" target="_blank" rel="noopener">具有故障模拟功能的RPC</a>，即通过模拟网络，在单台机器我们就可以运行raft算法。</p>
<blockquote>
<p>做实验前，你应该熟读raft论文，这里是<a href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md" target="_blank" rel="noopener">中文版</a></p>
</blockquote>
<h1 id="实现">2. 实现</h1><p>参照raft论文和lab提示，整体利用channel作为事件驱动、mutex保证线程安全，写出一个raft算法骨架还是比较容易的。不过在跑test的时候，小小的细节不对就会导致<code>test failed</code>。<br><img src="../images/20191004005135.png" alt><br><strong>raft-lab</strong>提供了17个test，检验了各种情况下的一致性，模拟了各种奇葩网络变化（网络变成这样还是跑路吧），要求4分钟内pass。</p>
<h2 id="数据结构">2.1. 数据结构</h2><p>参照论文，定义几个数据结构</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	Follower = <span class="literal">iota</span></span><br><span class="line">	Candidate</span><br><span class="line">	Leader</span><br><span class="line"></span><br><span class="line">	HeartbeatInterval = <span class="number">100</span> * time.Millisecond</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ApplyMsg <span class="keyword">struct</span> &#123;</span><br><span class="line">	CommandValid <span class="keyword">bool</span></span><br><span class="line">	Command      <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	CommandIndex <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term    <span class="keyword">int</span></span><br><span class="line">	Command <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AppendEntriesArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term         <span class="keyword">int</span></span><br><span class="line">	LeaderId     <span class="keyword">int</span></span><br><span class="line">	PrevLogIndex <span class="keyword">int</span></span><br><span class="line">	PrevLogTerm  <span class="keyword">int</span></span><br><span class="line">	Entries      []LogEntry</span><br><span class="line">	LeaderCommit <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AppendEntriesReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term      <span class="keyword">int</span></span><br><span class="line">	Success   <span class="keyword">bool</span></span><br><span class="line">	NextIndex <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Raft <span class="keyword">struct</span> &#123;</span><br><span class="line">	currentTerm     <span class="keyword">int</span></span><br><span class="line">	mu              sync.Mutex          <span class="comment">// Lock to protect shared access to this peer's state</span></span><br><span class="line">	peers           []*labrpc.ClientEnd <span class="comment">// RPC end points of all peers</span></span><br><span class="line">	persister       *Persister          <span class="comment">// Object to hold this peer's persisted state</span></span><br><span class="line">	me              <span class="keyword">int</span>                 <span class="comment">// this peer's index into peers[]</span></span><br><span class="line">	state           <span class="keyword">int</span>                 <span class="comment">// 0:Follower 1:Candidate 2:Leader</span></span><br><span class="line">	votedFor        <span class="keyword">int</span>                 <span class="comment">// 这个实验用index来代替节点</span></span><br><span class="line">	voteCount       <span class="keyword">int</span></span><br><span class="line">	commitIndex     <span class="keyword">int</span></span><br><span class="line">	lastApplied     <span class="keyword">int</span></span><br><span class="line">	currentLeaderId <span class="keyword">int</span></span><br><span class="line">	log             []LogEntry</span><br><span class="line">	nextIndex       []<span class="keyword">int</span></span><br><span class="line">	matchIndex      []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	applyCh     <span class="keyword">chan</span> ApplyMsg</span><br><span class="line">	heartbeatCh <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">	leaderCh    <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">	commitCh    <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RequestVoteArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Your data here (2A, 2B).</span></span><br><span class="line">	Term         <span class="keyword">int</span></span><br><span class="line">	CandidateId  <span class="keyword">int</span> <span class="comment">// 这个实验用index来代替节点</span></span><br><span class="line">	LastLogIndex <span class="keyword">int</span></span><br><span class="line">	LastLogTerm  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RequestVoteReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Your data here (2A).</span></span><br><span class="line">	VoteGranted <span class="keyword">bool</span> <span class="comment">// 是否支持</span></span><br><span class="line">	Term        <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小声bb，<code>AppendEntriesReply</code>论文是没有返回<code>nextIndex</code>的，而是由leader自己去<strong>减一重试</strong>，这其实是比较慢的，在设置了网络故障<strong>unreliable</strong>的test中，单纯的<strong>减一重试</strong>会导致raft集群在一定时间内不能达到一致。让follower过滤掉同一个term的index，并返回应该尝试的<code>nextIndex</code>，虽然会导致一次复制的日志变多，不过提高了集群达到一致的速度。</p>
<h2 id="一些封装">2.2. 一些封装</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取锁/释放锁的封装，可以在利用`runtime.Caller`打印获取锁的调用点，虽然性能损失比较大。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rf.mu.Lock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字如其名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">getLastLogTerm</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> rf.log[<span class="built_in">len</span>(rf.log)<span class="number">-1</span>].Term</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">getLastLogIndex</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(rf.log) - <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="raft实例初始化">2.3. raft实例初始化</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Make</span><span class="params">(peers []*labrpc.ClientEnd, me <span class="keyword">int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	persister *Persister, applyCh <span class="keyword">chan</span> ApplyMsg)</span> *<span class="title">Raft</span></span> &#123;</span><br><span class="line">	rf := &amp;Raft&#123;&#125;</span><br><span class="line">	rf.peers = peers</span><br><span class="line">	rf.persister = persister</span><br><span class="line">	rf.me = me</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Your initialization code here (2A, 2B, 2C).</span></span><br><span class="line">	rf.state = Follower</span><br><span class="line">	rf.currentTerm = <span class="number">0</span></span><br><span class="line">	rf.votedFor = <span class="number">-1</span></span><br><span class="line">	rf.currentLeaderId = <span class="number">-1</span></span><br><span class="line">	<span class="comment">// 初始化空白日志</span></span><br><span class="line">	rf.log = <span class="built_in">append</span>(rf.log, LogEntry&#123;Term: <span class="number">0</span>&#125;)</span><br><span class="line">	rf.applyCh = applyCh</span><br><span class="line"></span><br><span class="line">	rf.heartbeatCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">100</span>)</span><br><span class="line">	rf.leaderCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">100</span>)</span><br><span class="line">	rf.commitCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// initialize from state persisted before a crash</span></span><br><span class="line">	rf.readPersist(persister.ReadRaftState())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化随机数资源库</span></span><br><span class="line">	rand.Seed(time.Now().UnixNano())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">switch</span> rf.state &#123;</span><br><span class="line">			<span class="keyword">case</span> Follower:</span><br><span class="line">				<span class="keyword">select</span> &#123;</span><br><span class="line">				<span class="keyword">case</span> &lt;-rf.heartbeatCh:</span><br><span class="line">				<span class="comment">// 这是lab要求心跳</span></span><br><span class="line">				<span class="keyword">case</span> &lt;-time.After(time.Duration(rand.Int63()%<span class="number">333</span>+<span class="number">550</span>) * time.Millisecond):</span><br><span class="line">					rf.state = Candidate</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">case</span> Leader:</span><br><span class="line">				rf.broadcastAppendEntries()</span><br><span class="line">				time.Sleep(HeartbeatInterval)</span><br><span class="line">			<span class="keyword">case</span> Candidate:</span><br><span class="line">				<span class="keyword">go</span> rf.broadcastVote()</span><br><span class="line">				<span class="keyword">select</span> &#123;</span><br><span class="line">				<span class="keyword">case</span> &lt;-time.After(time.Duration(rand.Int63()%<span class="number">300</span>+<span class="number">500</span>) * time.Millisecond): <span class="comment">//随机投票超时是必须的，为了防止票被瓜分完。</span></span><br><span class="line">				<span class="keyword">case</span> &lt;-rf.heartbeatCh:</span><br><span class="line">					rf.state = Follower</span><br><span class="line">				<span class="keyword">case</span> &lt;-rf.leaderCh: </span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			&lt;-rf.commitCh</span><br><span class="line">			rf.applyMsg(applyCh)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">return</span> rf</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法返回一个raft实例，读取持久化数据，起了两个goroutine。</p>
<ul>
<li><p>goroutine1是raft三种状态的转化，这里的超时时间不宜设的太短（太短指论文里的时间），在lab文档里有指出为了配合test，选举超时时间应该<strong>larger than the paper’s 150 to 300 milliseconds</strong></p>
</li>
<li><p>goroutine2应用已提交日志。</p>
</li>
</ul>
<p>在初始化channel的时候应该设置缓冲大于1。多余的事件并不会导致系统不一致，但是若由于channel缓冲不够而导致阻塞，就会使raft节点死锁。</p>
<h2 id="votedFor清空时机">2.4. votedFor清空时机</h2><p>一次rpc，无论是发起端还是接收端，只要收到更大的term，就要调整自己的状态，发生下面变化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rf.votedFor = <span class="number">-1</span></span><br><span class="line">rf.state = Follower</span><br><span class="line">rf.currentTerm = remoteTerm</span><br></pre></td></tr></table></figure>

<p>可以看到<code>state</code>会变成<code>Follower</code>。</p>
<p>假设一种情景，ABC三个节点下，A为leader，此时C发生分区，那么C一定会不断循环进行超时选举，C的term会一直增大，当C网络恢复重新加入集群后会继续发投票请求rpc。由于C的投票请求rpc中的<code>term</code>较大，集群就会调整<code>currentTerm</code>以及<code>state</code>，已有leader会废掉。而问题是，C的请求投票是无意义的，却使集群进行了一次选举。针对这个问题有个<strong>preVote</strong>方案，就是在投票前调研一下自己是否有投票必要，如果没必要，就不发起投票。这篇文章暂无涉及<strong>preVote</strong>。</p>
<h2 id="投票发起与接收">2.5. 投票发起与接收</h2><h3 id="broadcastVote-发起投票">2.5.1. broadcastVote() 发起投票</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">broadcastVote</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rf.Lock()</span><br><span class="line">	rf.currentTerm++</span><br><span class="line">	rf.voteCount = <span class="number">1</span></span><br><span class="line">	rf.votedFor = rf.me</span><br><span class="line">	vote := &amp;RequestVoteArgs&#123;</span><br><span class="line">		Term:         rf.currentTerm,</span><br><span class="line">		CandidateId:  rf.me,</span><br><span class="line">		LastLogIndex: rf.getLastLogIndex(),</span><br><span class="line">		LastLogTerm:  rf.getLastLogTerm(),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rf.persist()</span><br><span class="line">	rf.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(rf.peers); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> rf.state != Candidate &#123; <span class="comment">// 发送</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> vote.CandidateId == i &#123; <span class="comment">// 自己的票已经给自己了</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(server <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			<span class="keyword">var</span> reply RequestVoteReply</span><br><span class="line">			ok := rf.sendRequestVote(server, vote, &amp;reply)</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			rf.Lock()</span><br><span class="line">			<span class="keyword">defer</span> rf.Unlock()</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 一般来说，reply.Term &gt; rf.currentTerm 的情况下 reply.VoteGranted 不会为true</span></span><br><span class="line">			<span class="keyword">if</span> reply.Term &gt; rf.currentTerm &#123;</span><br><span class="line">				rf.votedFor = <span class="number">-1</span></span><br><span class="line">				rf.state = Follower</span><br><span class="line">				rf.currentTerm = reply.Term</span><br><span class="line">				rf.persist()</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> reply.VoteGranted &#123;</span><br><span class="line">				rf.voteCount++</span><br><span class="line">				<span class="keyword">if</span> rf.state == Candidate &amp;&amp; rf.voteCount &gt; <span class="built_in">len</span>(rf.peers)/<span class="number">2</span> &#123;</span><br><span class="line">					rf.becomeLeader()</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">sendRequestVote</span><span class="params">(server <span class="keyword">int</span>, args *RequestVoteArgs, reply *RequestVoteReply)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	ok := rf.peers[server].Call(<span class="string">"Raft.RequestVote"</span>, args, reply)</span><br><span class="line">	<span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在接收到投票reply后，查看票根是否过半，如果过半转化为leader。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有加锁，外部调用已经加锁了</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">becomeLeader</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rf.state = Leader</span><br><span class="line">	rf.nextIndex = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(rf.peers))</span><br><span class="line">	rf.matchIndex = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(rf.peers))</span><br><span class="line">	<span class="comment">// 初始化为0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(rf.peers); i++ &#123;</span><br><span class="line">		rf.nextIndex[i] = rf.getLastLogIndex() + <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	rf.leaderCh &lt;- <span class="literal">true</span> <span class="comment">// 结束选举阻塞</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RequestVote-接收投票">2.5.2. RequestVote 接收投票</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">RequestVote</span><span class="params">(args *RequestVoteArgs, reply *RequestVoteReply)</span></span> &#123;</span><br><span class="line">	rf.Lock()</span><br><span class="line">	<span class="keyword">defer</span> rf.Unlock()</span><br><span class="line">	<span class="keyword">defer</span> rf.persist()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Your code here (2A, 2B).</span></span><br><span class="line">	reply.VoteGranted = <span class="literal">false</span></span><br><span class="line">	reply.Term = rf.currentTerm</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 过期的投票请求</span></span><br><span class="line">	<span class="keyword">if</span> rf.currentTerm &gt; args.Term &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果发起方的term比接收方大</span></span><br><span class="line">	<span class="comment">// adjust current term</span></span><br><span class="line">	<span class="keyword">if</span> rf.currentTerm &lt; args.Term &#123;</span><br><span class="line">		rf.currentTerm = args.Term</span><br><span class="line">		rf.state = Follower</span><br><span class="line">		rf.votedFor = <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	upToDate := <span class="literal">false</span></span><br><span class="line">	<span class="keyword">if</span> args.LastLogTerm &gt; rf.getLastLogTerm() &#123;</span><br><span class="line">		upToDate = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> args.LastLogTerm == rf.getLastLogTerm() &amp;&amp; args.LastLogIndex &gt;= rf.getLastLogIndex() &#123;</span><br><span class="line">		upToDate = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (rf.votedFor == <span class="number">-1</span> || rf.votedFor == args.CandidateId) &amp;&amp; <span class="comment">// 保证有票</span></span><br><span class="line">		upToDate &#123;</span><br><span class="line">		reply.VoteGranted = <span class="literal">true</span></span><br><span class="line">		rf.state = Follower</span><br><span class="line">		rf.votedFor = args.CandidateId</span><br><span class="line">		rf.heartbeatCh &lt;- <span class="literal">true</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1，进行投票后要发送心跳<code>rf.heartbeatCh &lt;- true</code>，不然节点会由<code>Follower</code>超时，从而使集群选举循环下去。<br>2，判断日志是否较新要满足其中一个条件：一，term较大，二，term一样，但日志index比较大</p>
<h2 id="日志复制与接收">2.6. 日志复制与接收</h2><h3 id="broadcastAppendEntries-广播日志-心跳">2.6.1. broadcastAppendEntries 广播日志/心跳</h3><p>日志复制lab文档要求一秒不能超过10次。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">broadcastAppendEntries</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rf.Lock()</span><br><span class="line">	<span class="keyword">defer</span> rf.Unlock()</span><br><span class="line"></span><br><span class="line">	N := rf.commitIndex</span><br><span class="line">	<span class="keyword">for</span> i := rf.commitIndex + <span class="number">1</span>; i &lt;= rf.getLastLogIndex(); i++ &#123;</span><br><span class="line">		<span class="comment">// 1 是leader本身</span></span><br><span class="line">		num := <span class="number">1</span></span><br><span class="line">		<span class="keyword">for</span> j := <span class="keyword">range</span> rf.peers &#123;</span><br><span class="line">			<span class="comment">// 只能提交本term的，一旦提交了本term的，旧term也算提交了</span></span><br><span class="line">			<span class="keyword">if</span> rf.me != j &amp;&amp; rf.matchIndex[j] &gt;= i &amp;&amp; rf.log[i].Term == rf.currentTerm &#123;</span><br><span class="line">				num++</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> num &gt; <span class="built_in">len</span>(rf.peers)/<span class="number">2</span> &#123;</span><br><span class="line">			N = i</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> N != rf.commitIndex &#123;</span><br><span class="line">		rf.commitIndex = N</span><br><span class="line">		rf.commitCh &lt;- <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(rf.peers); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> rf.state != Leader &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> i == rf.me &#123; <span class="comment">// 不用给自己心跳</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> args AppendEntriesArgs</span><br><span class="line">		args.Term = rf.currentTerm</span><br><span class="line">		args.LeaderCommit = rf.commitIndex</span><br><span class="line">		args.LeaderId = rf.me</span><br><span class="line">		args.PrevLogIndex = rf.nextIndex[i] - <span class="number">1</span></span><br><span class="line">		args.PrevLogTerm = rf.log[args.PrevLogIndex].Term</span><br><span class="line">		args.Entries = <span class="built_in">make</span>([]LogEntry, <span class="built_in">len</span>(rf.log[args.PrevLogIndex+<span class="number">1</span>:]))</span><br><span class="line">		<span class="comment">// 复制</span></span><br><span class="line">		<span class="built_in">copy</span>(args.Entries, rf.log[args.PrevLogIndex+<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, args AppendEntriesArgs)</span></span> &#123;</span><br><span class="line">			<span class="keyword">var</span> reply AppendEntriesReply</span><br><span class="line">			ok := rf.sendAppendEntries(i, &amp;args, &amp;reply)</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			rf.handleAppendEntriesReply(&amp;args, &amp;reply, i)</span><br><span class="line">		&#125;(i, args)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">sendAppendEntries</span><span class="params">(server <span class="keyword">int</span>, args *AppendEntriesArgs, reply *AppendEntriesReply)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	ok := rf.peers[server].Call(<span class="string">"Raft.AppendEntries"</span>, args, reply)</span><br><span class="line">	<span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次发送日志前，leader从<code>matchIndex[]</code>里统计出应该commit的index，如果index前进，发送commit事件。统计时要判断<code>rf.log[i].Term == rf.currentTerm</code>，也就是说只能提交自己term的log，一旦提交了自己term的log，之前term未被提交的log也算提交了。这个在论文有提到。</p>
<p>下面是复制日志的响应代码，也很直白。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reply 为 false， 如果不是任期问题，就是日志不匹配</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">handleAppendEntriesReply</span><span class="params">(args *AppendEntriesArgs, reply *AppendEntriesReply, i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	rf.Lock()</span><br><span class="line">    <span class="keyword">defer</span> rf.Unlock()</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> rf.state != Leader &#123; <span class="comment">// 获取锁后校验自己的状态</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> args.Term != rf.currentTerm &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> reply.Term &gt; rf.currentTerm &#123;</span><br><span class="line">		rf.votedFor = <span class="number">-1</span></span><br><span class="line">		rf.currentTerm = reply.Term</span><br><span class="line">		rf.state = Follower</span><br><span class="line">		rf.persist()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> reply.Success &#123;</span><br><span class="line">        <span class="comment">// len(args.Entries)  == 0 就是心跳了，不用处理</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(args.Entries) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			rf.matchIndex[i] = args.PrevLogIndex + <span class="built_in">len</span>(args.Entries)</span><br><span class="line">			rf.nextIndex[i] = rf.matchIndex[i] + <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		rf.nextIndex[i] = reply.NextIndex <span class="comment">// 直接采用follower的建议</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AppendEntries-接收日志">2.6.2. AppendEntries 接收日志</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">AppendEntries</span><span class="params">(args *AppendEntriesArgs, reply *AppendEntriesReply)</span></span> &#123;</span><br><span class="line">	rf.Lock()</span><br><span class="line">	<span class="keyword">defer</span> rf.Unlock()</span><br><span class="line">	<span class="keyword">defer</span> rf.persist()</span><br><span class="line"></span><br><span class="line">	reply.Success = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 告诉老term的节点该更新啦</span></span><br><span class="line">	<span class="keyword">if</span> rf.currentTerm &gt; args.Term &#123;</span><br><span class="line">		reply.Term = rf.currentTerm</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 心跳</span></span><br><span class="line">	rf.heartbeatCh &lt;- <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// adjust current term</span></span><br><span class="line">	<span class="keyword">if</span> args.Term &gt; rf.currentTerm &#123;</span><br><span class="line">		rf.currentTerm = args.Term</span><br><span class="line">		rf.state = Follower</span><br><span class="line">		rf.votedFor = <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reply.Term = rf.currentTerm</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这坨是在日志不匹配的情况下，对leader的NextIndex建议</span></span><br><span class="line">	<span class="keyword">if</span> rf.getLastLogIndex() &lt; args.PrevLogIndex &#123;</span><br><span class="line">		reply.NextIndex = rf.getLastLogIndex() + <span class="number">1</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> rf.log[args.PrevLogIndex].Term != args.PrevLogTerm &#123;</span><br><span class="line">		term := rf.log[args.PrevLogIndex].Term</span><br><span class="line">		<span class="keyword">if</span> args.PrevLogTerm != term &#123;</span><br><span class="line">			<span class="keyword">for</span> i := args.PrevLogIndex - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">				<span class="keyword">if</span> rf.log[i].Term != term &#123;</span><br><span class="line">					reply.NextIndex = i + <span class="number">1</span></span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reply.Success = <span class="literal">true</span></span><br><span class="line">	reply.NextIndex = rf.getLastLogIndex() + <span class="number">1</span></span><br><span class="line">	<span class="comment">// 删除已存在日志</span></span><br><span class="line">	rf.log = rf.log[:args.PrevLogIndex+<span class="number">1</span>]</span><br><span class="line">	<span class="comment">// 附加新日志</span></span><br><span class="line">	rf.log = <span class="built_in">append</span>(rf.log, args.Entries...)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> args.LeaderCommit &gt; rf.commitIndex &#123;</span><br><span class="line">		rf.commitIndex = Min(args.LeaderCommit, rf.getLastLogIndex())</span><br><span class="line">		rf.commitCh &lt;- <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这理主要是<code>NextIndex</code>建议值的计算。</p>
<h2 id="将提交的日志应用至状态机">2.7. 将提交的日志应用至状态机</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">applyMsg</span><span class="params">(applyCh <span class="keyword">chan</span> ApplyMsg)</span></span> &#123;</span><br><span class="line">	rf.Lock()</span><br><span class="line">	<span class="keyword">defer</span> rf.Unlock()</span><br><span class="line">	<span class="keyword">for</span> i := rf.lastApplied + <span class="number">1</span>; i &lt;= rf.commitIndex; i++ &#123;</span><br><span class="line">		msg := ApplyMsg&#123;</span><br><span class="line">			<span class="literal">true</span>,</span><br><span class="line">			rf.log[i].Command,</span><br><span class="line">			i,</span><br><span class="line">		&#125;</span><br><span class="line">		applyCh &lt;- msg</span><br><span class="line">		rf.lastApplied = i</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用过程其实是由test去管理的，我们只要负责把需要应用的日志放入<code>chan ApplyMsg</code>。</p>
<h2 id="持久化">2.8. 持久化</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">persist</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Your code here (2C).</span></span><br><span class="line">	<span class="comment">// Example:</span></span><br><span class="line">	w := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">	e := gob.NewEncoder(w)</span><br><span class="line">	e.Encode(rf.currentTerm)</span><br><span class="line">	e.Encode(rf.votedFor)</span><br><span class="line">	e.Encode(rf.log)</span><br><span class="line">	data := w.Bytes()</span><br><span class="line">	rf.persister.SaveRaftState(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">readPersist</span><span class="params">(data []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> data == <span class="literal">nil</span> || <span class="built_in">len</span>(data) &lt; <span class="number">1</span> &#123; <span class="comment">// bootstrap without any state?</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	r := bytes.NewBuffer(data)</span><br><span class="line">	d := gob.NewDecoder(r)</span><br><span class="line">	d.Decode(&amp;rf.currentTerm)</span><br><span class="line">	d.Decode(&amp;rf.votedFor)</span><br><span class="line">	d.Decode(&amp;rf.log)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个持久化函数，持久化了<code>currentTerm</code>当前term,<code>votedFor</code>得票者,<code>log</code>日志数组，当这三个属性变化时，都执行一次<code>rf.persist()</code>就没错啦。</p>
<h1 id="后记">3. 后记</h1><p>表面是在贴代码，实际就是在贴代码。</p>
<p>由于实验是并发过程，一旦<code>test failed</code>是不容易按线性的过程来分析的。我的方法是多打日志，以及利用<code>net/http/pprof</code>包对程序的goroutine、mutex状态进行分析。</p>
<p>实现完以后我感觉又变强了（并没有）。</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://htchz.cc/1823228532.html" title="[分布式]手撕raft" target="_blank" rel="external">https://htchz.cc/1823228532.html</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/fennecs" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/unnamed.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/fennecs" target="_blank"><span class="text-dark">土川</span><small class="ml-1x">后端码农</small></a></h3>
        <div>请说出Hello World的16种写法。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/1473130276.html" title="[Redis]《Redis设计与实现》"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2102019255.html" title="[k8s]k8s部署踩坑"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn" data-toggle="collapse" href="#collapseToc" aria-expanded="true" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/fennecs" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
    <script defer>
    var disqus_config = function () {
        
            this.page.url = 'https://htchz.cc/1823228532.html';
        
        this.page.identifier = '分布式-手撕raft';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'htchz' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //利用 FancyBox 实现点击图片放大
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>





</body>
</html>