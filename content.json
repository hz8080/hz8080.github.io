{"meta":{"title":"åœŸå·çš„è‡ªç•™åœ°","subtitle":"via fennecs.huang@gmail.com","description":"æˆ‘æ˜¯é»„åœŸå·ï¼Œæ˜¯å…„å¼Ÿï¼Œå°±æ¥ç æˆ‘ã€‚","author":"åœŸå·","url":"https://htchz.cc","root":"/"},"pages":[{"title":"å…³äº","date":"2020-05-07T07:50:37.832Z","updated":"2020-05-07T07:50:37.832Z","comments":false,"path":"about/index.html","permalink":"https://htchz.cc/about/index.html","excerpt":"","text":"é‚®ç®±ï¼šfennecs.huang@gmail.com Telegramï¼šhttps://t.me/orzhtc è¯„è®ºæ¨¡å—éœ€è¦æ¢¯å­~ 2020: ã€ŠLinuxé˜²ç«å¢™ã€‹âœ… 2019: ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹âœ…Â· ã€ŠTCP/IPè¯¦è§£ å·ä¸€ã€‹âœ… ã€Šæ¯å¤©5åˆ†é’Ÿç©è½¬Kubernetesã€‹âœ… ã€ŠDockeræŠ€æœ¯å…¥é—¨ä¸å®è·µã€‹âœ… ã€ŠGoè¯­è¨€å®æˆ˜ã€‹âœ… 2018: ã€ŠJava 8 å®æˆ˜ã€‹âœ… ã€ŠNettyå®æˆ˜ã€‹âœ… ã€ŠJava NIOã€‹âœ… 2017: ã€ŠHTTPæƒå¨æŒ‡å—ã€‹âœ… ã€ŠJAVAå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹âœ… ã€ŠEffective Javaã€‹âœ… ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹âœ… ã€ŠHead Firstè®¾è®¡æ¨¡å¼ã€‹âœ…"},{"title":"åˆ†ç±»","date":"2019-08-15T14:48:32.947Z","updated":"2018-12-17T09:14:15.000Z","comments":false,"path":"categories/index.html","permalink":"https://htchz.cc/categories/index.html","excerpt":"","text":""},{"title":"æ ‡ç­¾","date":"2019-08-15T14:48:33.087Z","updated":"2018-12-17T09:13:02.000Z","comments":false,"path":"tags/index.html","permalink":"https://htchz.cc/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"[Redis]scanå‘½ä»¤å®ç°","slug":"Redis-scanå‘½ä»¤å®ç°","date":"2020-07-14T07:07:35.000Z","updated":"2020-07-14T10:05:21.256Z","comments":true,"path":"3055836750.html","link":"","permalink":"https://htchz.cc/3055836750.html","excerpt":"","text":"å¦‚æœè¦åœ¨redisæŸ¥æ‰¾éå†keyï¼Œkeyså‘½ä»¤ä¼šé˜»å¡ï¼Œæ˜¯ä¸èƒ½ç”¨çš„ï¼Œè¿™æ—¶å°±è¦ç”¨scanå‘½ä»¤ã€‚ scanå‘½ä»¤æ”¯æŒä¼ å…¥cursorã€match patternã€countã€type(6.0æ–°å¢type)ï¼Œæ ¹æ®æ¸¸æ ‡ï¼Œè¿”å›countæ•°é‡çš„ç¬¦åˆæ¡ä»¶çš„keyï¼Œä»¥åŠæ–°æ¸¸æ ‡ã€‚æ³¨æ„è¿™ä¸ªcountåªæ˜¯ä¸€ä¸ªæœŸæœ›å€¼ï¼Œçœ‹æºç å°±çŸ¥é“ä¸ºä»€ä¹ˆä¸æ˜¯ç¡®åˆ‡å€¼ã€‚ dbæ˜¯ç”±dictç»„æˆçš„ï¼Œsetã€hashã€ziplistä¹Ÿæ˜¯æœ‰dictç±»å‹çš„ï¼Œdictå‘ç”Ÿæ‰©å®¹å’Œç¼©å®¹çš„è¯ï¼Œå¦‚æœæŒ‰è‡ªç„¶æ•°çš„æ–¹æ³•å»éå†ï¼Œæ‰©å®¹ä¼šé‡å¤éå†ï¼Œç¼©å®¹ä¼šé—æ¼éå†ã€‚ å‡è®¾dictç¨³å®šçŠ¶æ€ä¸‹ï¼Œdict sizeä»8å˜æˆ16ï¼Œåˆšè®¿é—®è¿‡indexä¸º3çš„æ¡¶ï¼Œæ¥ä¸‹æ¥å°±åº”è¯¥éå†4-15æ¡¶ï¼Œç”±äºåŸå…ˆ0-3å·çš„æ¡¶çš„keyæœ‰ä¸€éƒ¨åˆ†æŒªåˆ°8-11ä¸­ï¼ˆ+8ï¼‰ï¼Œåé¢å°±ä¼šé‡å¤éå†åˆ°ã€‚ å‡è®¾dict sizeä»8å˜æˆ4ï¼Œåˆšè®¿é—®è¿‡indexä¸º3çš„æ¡¶ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯éå†ç»“æŸäº†ï¼Œè¿™æ ·åŸå…ˆ4-7å·çš„æ¡¶å°±ä¼šæ¼æ‰ï¼ˆ-4ï¼‰ã€‚ å¦‚æœåœ¨æ‰©å®¹ç¼©å®¹æƒ…å†µä¸‹ï¼Œéœ€è¦éå†ä¸¤æ¡æ•°ç»„ï¼ŒåŒæ ·ä¼šé‡åˆ°ä¸Šé¢çš„é—®é¢˜ã€‚ çœ‹çœ‹redisæ˜¯æ€ä¹ˆè§£å†³çš„ã€‚ redisä¸é‡‡ç”¨è‡ªç„¶æ•°é¡ºåºéå†ï¼Œè€Œæ˜¯é‡‡ç”¨é«˜ä½é¡ºåºéå†ï¼Œä¹Ÿå°±æ˜¯å¯¹æ¸¸æ ‡å‰è¿›çš„æ–¹å¼æ˜¯é…±ç´«çš„ï¼šç”¨å¯¹åº”æ•°ç»„çš„æ©ç å°†æ¸¸æ ‡çš„å€¼æˆªæ–­ï¼ˆå‡†ç¡®åœ°è¯´ä¸æ˜¯æˆªæ–­ï¼Œå¯ä»¥å…ˆç”¨æˆªæ–­ç†è§£ï¼‰ â€”&gt; å·¦å³ç¿»è½¬ -&gt; è‡ªå¢ -&gt; å·¦å³ç¿»è½¬å›æ¥ã€‚ è¿™ä¸ªç®—æ³•çš„åŸç†æ˜¯ï¼Œæ•°ç»„æ‰©å®¹æ˜¯*2ï¼Œé‚£ä¹ˆæ¯æ¬¡æ‰©å®¹ï¼Œæ—§æ•°ç»„çš„å…ƒç´ å“ˆå¸Œå€¼&amp; new_maskå¾—åˆ°ä¸‹æ ‡ï¼Œè¦ä¹ˆåœ¨åŸæ¥çš„æ¡¶ï¼Œè¦ä¹ˆæ˜¯åŸæ¥æ¡¶çš„index*2ï¼Œå…·ä½“è¡¨ç°ä¸ºæœ€é«˜ä½åˆ†åˆ«æ˜¯0å’Œ1ã€‚é‚£ä¹ˆä»é«˜ä½èµ·å¼€å§‹éå†çš„è¯ï¼Œå¦‚æœå»æ‰æœ€é«˜ä½ï¼Œå…¶å®éå†çš„é¡ºåºå’Œæ—§æ•°ç»„æ˜¯ä¸€æ ·çš„ã€‚ ä¸¾ä¸ªä¾‹å­ï¼ŒåŸæ¥çš„é¡ºåºæ˜¯ 000 100 010 110é‚£ä¹ˆæ‰©å®¹åï¼Œé¡ºåºæ˜¯ (0)000 (1)000 (0)100 (1)100 (0)010 (1)010 (0)110 (1)1001. éå†å®ç°ä»£ç åŸºäº6.0ï¼Œä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯dictérehashçŠ¶æ€ï¼Œä¸€éƒ¨åˆ†æ˜¯rehashçŠ¶æ€ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990// è¿™ä¸ªå‡½æ•°å°†æ¸¸æ ‡vçš„å…ƒç´ æ”¾åˆ°privdataï¼Œå¹¶ç”¨ç®—æ³•æ¨è¿›cursorï¼Œunsigned long dictScan(dict *d, unsigned long v, dictScanFunction *fn, dictScanBucketFunction* bucketfn, void *privdata)&#123; dictht *t0, *t1; const dictEntry *de, *next; unsigned long m0, m1; if (dictSize(d) == 0) return 0; /* Having a safe iterator means no rehashing can happen, see _dictRehashStep. * This is needed in case the scan callback tries to do dictFind or alike. */ d-&gt;iterators++; if (!dictIsRehashing(d)) &#123; t0 = &amp;(d-&gt;ht[0]); m0 = t0-&gt;sizemask; /* Emit entries at cursor */ if (bucketfn) bucketfn(privdata, &amp;t0-&gt;table[v &amp; m0]); de = t0-&gt;table[v &amp; m0]; while (de) &#123; next = de-&gt;next; fn(privdata, de); de = next; &#125; /* Set unmasked bits so incrementing the reversed cursor * operates on the masked bits */ v |= ~m0; /* Increment the reverse cursor */ v = rev(v); v++; v = rev(v); &#125; else &#123; t0 = &amp;d-&gt;ht[0]; t1 = &amp;d-&gt;ht[1]; /* Make sure t0 is the smaller and t1 is the bigger table */ if (t0-&gt;size &gt; t1-&gt;size) &#123; t0 = &amp;d-&gt;ht[1]; t1 = &amp;d-&gt;ht[0]; &#125; m0 = t0-&gt;sizemask; m1 = t1-&gt;sizemask; /* Emit entries at cursor */ if (bucketfn) bucketfn(privdata, &amp;t0-&gt;table[v &amp; m0]); de = t0-&gt;table[v &amp; m0]; while (de) &#123; next = de-&gt;next; fn(privdata, de); de = next; &#125; /* Iterate over indices in larger table that are the expansion * of the index pointed to by the cursor in the smaller table */ do &#123; /* Emit entries at cursor */ if (bucketfn) bucketfn(privdata, &amp;t1-&gt;table[v &amp; m1]); de = t1-&gt;table[v &amp; m1]; while (de) &#123; next = de-&gt;next; fn(privdata, de); de = next; &#125; // è¿™é‡Œæ›¾ç»æœ‰ä¸ªbugï¼Œå‚è€ƒä¸‹é¢ç¾å›¢é“¾æ¥ /* Increment the reverse cursor not covered by the smaller mask.*/ v |= ~m1; v = rev(v); v++; v = rev(v); // è¿™ä¸ª(m0 ^ m1)å°±æ˜¯å‰é¢è¯´åˆ°çš„é«˜ä½ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªå¾ªç¯åªä¼šæ‰§è¡Œä¸¤æ¬¡ï¼Œå°æ•°ç»„çš„ä¸€ä¸ªæ¡¶ä¸‹æ ‡å¯¹åº”å¤§æ•°ç»„çš„ä¸¤ä¸ªæ¡¶ä¸‹æ ‡ /* Continue while bits covered by mask difference is non-zero */ &#125; while (v &amp; (m0 ^ m1)); &#125; /* undo the ++ at the top */ d-&gt;iterators--; return v;&#125; åœ¨érehashçŠ¶æ€ï¼Œç”¨æ©ç å®šä½è®¡ç®—cursorå¯¹åº”çš„æ¡¶ï¼Œç”¨ä¸€ä¸ªå¾ªç¯å–å‡ºæ¡¶ä¸‹æ‰€æœ‰entryã€‚ åœ¨rehashçŠ¶æ€ï¼Œéœ€è¦ç¡®å®šå¤§å°æ•°ç»„ï¼Œå¾ªç¯å–å‡ºå°æ•°ç»„çš„æ¡¶çš„entryï¼Œå¯¹äºå¤§æ•°ç»„ï¼Œéå†ä¸¤ä¸ªæ¡¶çš„æ‰€æœ‰entryï¼Œå¹¶æ¨è¿›cursor 2. æ¸¸æ ‡æ¨è¿›cursoræ¨è¿›çš„ç®—æ³•æ˜¯ 12345678// è¿™é‡Œå°†éæ©ç éƒ¨åˆ†ç½®1ï¼Œå¦‚ä¸Šé¢è¯´çš„å¹¶éæˆªæ–­v |= ~m1;// ç¿»è½¬v = rev(v);// è‡ªå¢v++;// ç¿»è½¬å›æ¥v = rev(v); revå‡½æ•° 1234567891011/* Function to reverse bits. Algorithm from: * http://graphics.stanford.edu/~seander/bithacks.html#ReverseParallel */static unsigned long rev(unsigned long v) &#123; unsigned long s = CHAR_BIT * sizeof(v); // bit size; must be power of 2 unsigned long mask = ~0UL; while ((s &gt;&gt;= 1) &gt; 0) &#123; mask ^= (mask &lt;&lt; s); v = ((v &gt;&gt; s) &amp; mask) | ((v &lt;&lt; s) &amp; ~mask); &#125; return v;&#125; å¤§æ„æ˜¯ï¼Œunsigned longæ˜¯32ä½ï¼Œå³æŠŠå‰16ä½å’Œå16ä½äº¤æ¢ï¼Œç„¶å16ä½é‡Œï¼Œå‰8ä½å’Œå8ä½äº¤æ¢ã€‚ã€‚ã€‚ä»¥æ­¤ç±»æ¨ï¼Œæ€»å…±5æ¬¡ã€‚ æƒ³åæ§½è¿™ä¸ªè€å“¥ä¸æ˜¯ä¸å±‘äºè¿™ç§ä½è¿ç®—é­”æ³•å— = = 3. scanGenericCommandè¿™ä¸ªæ–¹æ³•æ˜¯scanå‘½ä»¤çš„å®ç°ï¼Œæºä»£ç æ¯”è¾ƒé•¿ï¼Œæ³¨é‡Šå†™çš„å¾ˆè¯¦ç»†ï¼Œå¤§çº¦æœ‰å››æ­¥ï¼šStep 1: Parse options. è¿™ä¸€æ­¥æ˜¯æŠŠå‚æ•°æ ¡éªŒStep 2: Iterate the collection. è¿™ä¸€æ­¥æ˜¯æå–å‡ºç›®æ ‡çš„dictï¼Œè°ƒç”¨å‰é¢çš„éå†æ–¹æ³•ã€‚Step 3: Filter elements. è¿™ä¸€æ­¥æ˜¯æ ¹æ®matchè¿‡æ»¤æˆ–æ ¹æ®typeè¿‡æ»¤ã€‚Step 4: Reply to the client. å›å¤å®¢æˆ·ç«¯ ä¸»è¦çœ‹ç¬¬äºŒæ­¥ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465/* Step 2: Iterate the collection. * * Note that if the object is encoded with a ziplist, intset, or any other * representation that is not a hash table, we are sure that it is also * composed of a small number of elements. So to avoid taking state we * just return everything inside the object in a single call, setting the * cursor to zero to signal the end of the iteration. *//* Handle the case of a hash table. */ht = NULL;if (o == NULL) &#123; ht = c-&gt;db-&gt;dict;&#125; else if (o-&gt;type == OBJ_SET &amp;&amp; o-&gt;encoding == OBJ_ENCODING_HT) &#123; ht = o-&gt;ptr;&#125; else if (o-&gt;type == OBJ_HASH &amp;&amp; o-&gt;encoding == OBJ_ENCODING_HT) &#123; ht = o-&gt;ptr; count *= 2; /* We return key / value for this type. */&#125; else if (o-&gt;type == OBJ_ZSET &amp;&amp; o-&gt;encoding == OBJ_ENCODING_SKIPLIST) &#123; zset *zs = o-&gt;ptr; ht = zs-&gt;dict; count *= 2; /* We return key / value for this type. */&#125;if (ht) &#123; void *privdata[2]; /* We set the max number of iterations to ten times the specified * COUNT, so if the hash table is in a pathological state (very * sparsely populated) we avoid to block too much time at the cost * of returning no or very few elements. */ long maxiterations = count*10; /* We pass two pointers to the callback: the list to which it will * add new elements, and the object containing the dictionary so that * it is possible to fetch more data in a type-dependent way. */ privdata[0] = keys; privdata[1] = o; do &#123; cursor = dictScan(ht, cursor, scanCallback, NULL, privdata); &#125; while (cursor &amp;&amp; maxiterations-- &amp;&amp; listLength(keys) &lt; (unsigned long)count);&#125; else if (o-&gt;type == OBJ_SET) &#123; int pos = 0; int64_t ll; while(intsetGet(o-&gt;ptr,pos++,&amp;ll)) listAddNodeTail(keys,createStringObjectFromLongLong(ll)); cursor = 0;&#125; else if (o-&gt;type == OBJ_HASH || o-&gt;type == OBJ_ZSET) &#123; unsigned char *p = ziplistIndex(o-&gt;ptr,0); unsigned char *vstr; unsigned int vlen; long long vll; while(p) &#123; ziplistGet(p,&amp;vstr,&amp;vlen,&amp;vll); listAddNodeTail(keys, (vstr != NULL) ? createStringObject((char*)vstr,vlen) : createStringObjectFromLongLong(vll)); p = ziplistNext(o-&gt;ptr,p); &#125; cursor = 0;&#125; else &#123; serverPanic(\"Not handled encoding in SCAN.\");&#125; æ³¨æ„éå†åœæ­¢çš„æ¡ä»¶æ˜¯cursor &amp;&amp; maxiterations &gt; 0 &amp;&amp; listlength(keys) &lt; countï¼Œmaxiterations = count*10ï¼›å¦‚æœéœ€è¦è¿”å›key/valueï¼Œcount *= 2ã€‚ ç»“åˆåé¢çš„è¿‡æ»¤ï¼Œæ‰€ä»¥è¯´è¿”å›ç»“æœçš„é•¿åº¦ä¸æ˜¯ä¸¥æ ¼æŒ‰ç…§æˆ‘ä»¬ä¼ å…¥çš„countçš„å€¼ï¼Œæœ‰å¯èƒ½è¶…äº†ä¸€ä¸¢ä¸¢ï¼Œæœ‰å¯èƒ½éå†äº†10å€countæ•°é‡çš„æ¡¶æ²¡å‡ ä¸ªå…ƒç´ ï¼Œä¹Ÿæœ‰å¯èƒ½æ‰¾åˆ°å¾ˆå¤šè¢«è¿‡æ»¤äº†ä¸€å¤§å †ã€‚ 4. å‚è€ƒ ç¾å›¢é’ˆå¯¹Redis Rehashæœºåˆ¶çš„æ¢ç´¢å’Œå®è·µ RedisäºŒè¿›åˆ¶åè½¬ç®—æ³•åˆ†æ","categories":[{"name":"redis","slug":"redis","permalink":"https://htchz.cc/categories/redis/"}],"tags":[]},{"title":"[Mysql]ä¸¤é˜¶æ®µæäº¤å’Œå´©æºƒæ¢å¤","slug":"Mysql-ä¸¤é˜¶æ®µæäº¤å’Œå´©æºƒæ¢å¤","date":"2020-06-05T03:15:08.000Z","updated":"2020-06-05T17:04:55.591Z","comments":true,"path":"2934732838.html","link":"","permalink":"https://htchz.cc/2934732838.html","excerpt":"","text":"1. ä¸¤é˜¶æ®µæäº¤innodbå’Œbin logéœ€è¦è¿›è¡Œä¸¤é˜¶æ®µæäº¤(Two-Phase Commit Protocolï¼Œ2PC)ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ—¥å¿—ä¸€è‡´æ€§ï¼Œè¦ä¹ˆéƒ½å­˜åœ¨ï¼Œè¦ä¹ˆéƒ½ä¸å­˜åœ¨ã€‚ è¦è¯´æ˜çš„æ˜¯ï¼Œä¸¤é˜¶æ®µæäº¤ä¸æ­¢redo logå’Œbinlogæœ‰å…³ï¼Œundo logä¹Ÿæ˜¯å‚ä¸è€…ã€‚ XIDæ˜¯äº‹åŠ¡æ ¹æ®äº‹åŠ¡ç¬¬ä¸€æ¡queryç”Ÿæˆçš„idï¼Œé€šè¿‡XIDå°†redo logå’Œbinlogå…³è”èµ·æ¥ã€‚åœ¨ä¸Šä¸€ç¯‡çš„binlogæ—¥å¿—é‡Œä¹Ÿèƒ½çœ‹åˆ°XIDçš„èº«å½±ã€‚ ä¸¤é˜¶æ®µæäº¤ï¼Œå…¶å®å°±æ˜¯innodb prepareï¼Œå†™binlogï¼Œinnodb commitï¼› å…·ä½“æ˜¯ï¼Œ prepareé˜¶æ®µï¼Œredo logå†™å…¥æ ¹æ®äº‹åŠ¡æäº¤æ—¶çš„åˆ·ç›˜ç­–ç•¥å†³å®šæ˜¯å¦åˆ·ç›˜ï¼Œç„¶åå°†log segment(ä¸æ˜¯å›æ»šæ®µï¼ï¼ï¼)æ ‡ä¸ºTRX_UNDO_PREPAREDï¼›binlogä¸åšä»»ä½•äº‹ commité˜¶æ®µï¼Œbinlogå†™å…¥binlogæ—¥å¿—ï¼›æ¥ç€innodbå°†ä¿®æ”¹undo log segmentçŠ¶æ€ï¼Œå¹¶åœ¨redo logå†™å…¥ä¸€ä¸ªcommit logã€‚ å¦‚æœæ²¡æœ‰ä¸¤é˜¶æ®µæäº¤ï¼Œredo logå’Œbinlogå„å†™å„çš„ï¼Œä¸­é—´å‘ç”Ÿå´©æºƒï¼Œå°±ä¼šå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚ å…ˆå†™binlogï¼Œå†å†™redo logï¼šå¦‚æœredo logæ²¡å†™æˆåŠŸï¼Œå°±ä¼šé€ æˆå´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œä¸»åº“æ²¡æœ‰ã€ä»åº“æœ‰çš„æƒ…å†µï¼Œä¸»ä»ä¸ä¸€è‡´ã€‚ å…ˆå†™redo logï¼Œå†å†™binlogï¼šå¦‚æœbinlogæ²¡å†™æˆåŠŸï¼Œå°±ä¼šé€ æˆå´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œä¸»åº“æœ‰ã€ä»åº“æ²¡æœ‰çš„æƒ…å†µï¼Œä¸»ä»ä¸ä¸€è‡´ã€‚ è¯´ç™½äº†ï¼Œä¸ºäº†ä¿è¯äº‹åŠ¡ï¼Œæ€»æ˜¯å¾—åšä¸€äº›å†—ä½™çš„æ“ä½œï¼Œä¾‹å¦‚tcpå¤šæ¬¡æ¡æ‰‹æŒ¥æ‰‹ï¼Œéƒ½æ˜¯é€šè¿‡å†—ä½™æ“ä½œæ¥ä¿è¯ä¸¤ä¸ªä¸šåŠ¡ä¹‹é—´ä¸€è‡´ã€‚ 1.1. redo logå’Œbinlogé¡ºåºä¸ä¸€è‡´çš„é—®é¢˜ä¸¤é˜¶æ®µçš„æäº¤ä¸åªå¦‚æ­¤ï¼Œå¦‚æœåªæ˜¯åƒä¸Šé¢é‚£æ ·ï¼Œè¿˜ä¼šå‡ºç°ä¸»ä»ä¸ä¸€è‡´çš„æƒ…å†µã€‚ 1.1.1. çƒ­å¤‡é—®é¢˜T1 (--prepare--binlog[pos100]--------------------------------------------commit) T2 (-----prepare-----binlog[pos200]----------commit) T3 (--------prepare-------binlog[pos300]------commit) online-backup(----------------------------------------------backup------------)å‡è®¾3ä¸ªäº‹åŠ¡å¦‚ä¸Šï¼Œé‚£ä¹ˆ redo log prepareçš„é¡ºåºï¼šT1 --&gt; T2 --&gt; T3 binlogçš„å†™å…¥é¡ºåºï¼š T1 --&gt; T2 --&gt; T3 redo log commitçš„é¡ºåºï¼š T2 --&gt; T3 --&gt; T1å¯ä»¥çœ‹åˆ°redo logæäº¤çš„é¡ºåºå’Œbin logä¸ä¸€è‡´äº†ï¼Œè¿™æ˜¯ä¸å…è®¸çš„ï¼Œä¼šå¯¼è‡´ä¸»ä»ä¸ä¸€è‡´ã€‚ online-backupè¡¨ç¤ºçƒ­å¤‡ï¼Œå› ä¸ºä»åº“åœ¨å»ºç«‹çš„æ—¶å€™éœ€è¦å¯¹ä¸»åº“è¿›è¡Œä¸€æ¬¡å¤‡ä»½ã€‚å½“T2ï¼ŒT3æäº¤åï¼Œè¿™æ—¶çƒ­å¤‡æ¥è¯»ä½ç½®ï¼Œè¯»åˆ°æœ€åä¸€ä¸ªæäº¤çš„äº‹åŠ¡T3ï¼Œç”±äºè¿™ä¸ªé˜¶æ®µä¸æ˜¯è¯»binlogçš„ï¼Œæ‰€ä»¥T1æ²¡æœ‰è¢«å¤åˆ¶åˆ°ï¼Œæ¥ä¸‹æ¥çš„binlogå¤åˆ¶ä»T3å¼€å§‹ï¼Œæ‰€ä»¥ä¼šæ¼æ‰T1çš„æ•°æ®ã€‚ 1.1.2. å¤åˆ¶é—®é¢˜ã€ŠMySQL5.7 æ ¸å¿ƒæŠ€æœ¯æ­ç§˜ï¼šMySQL Group commitã€‹ï¼ˆè§å‚è€ƒï¼‰ä¸¾äº†ä¸€ä¸ªä¾‹å­ï¼Œå°±æ˜¯æœ‰ä¸€è¡Œæ•°æ®ï¼Œx=1ï¼Œy=1T1:x=y+1,y=x+1;T2:y=x+1,x=y+1; æ–‡ç« è¯´è¿™ä¸¤ä¸ªäº‹åŠ¡é¢ å€’æ‰§è¡Œå‡ºæ¥çš„ç»“æœä¸ä¸€æ ·ã€‚ä½†æ˜¯åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™ä¸¤ä¸ªäº‹åŠ¡æ˜¯æ²¡æ³•é¢ å€’çš„ã€‚äº‹åŠ¡ä¸ºäº†é˜²æ­¢å›æ»šè¦†ç›–ï¼Œå¯¹ä¸€æ¡è®°å½•åŠ Xé”ä¿®æ”¹åï¼Œåªæœ‰äº‹åŠ¡æäº¤ä¹‹åæ‰èƒ½é‡Šæ”¾Xé”ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªäº‹åŠ¡æ˜¯æ²¡åŠæ³•åŒæ—¶å¤„äº2PCçš„ï¼Œè‚¯å®šæ˜¯T1 2PCå®Œï¼ŒT2æ‰å¼€å§‹2PCã€‚æ‰ç–å­¦æµ…ï¼Œå¯èƒ½ç†è§£æœ‰è¯¯ï¼Œæ¬¢è¿æŒ‡å‡ºã€‚ æ‰€ä»¥æ—©æœŸçš„mysqlç”¨prepare_commit_mutexé”æ¥å‘èµ·2PCä¿è¯é¡ºåºï¼Œè¿™åœ¨é«˜å¹¶å‘ä¸‹æ˜¯å¾ˆè€—è´¹æ€§èƒ½çš„ã€‚ä¸€ä¸ªäº‹åŠ¡è¦è·å–é”æ‰èƒ½å‘èµ·prepareï¼ŒçŸ¥é“commitä¹‹åæ‰é‡Šæ”¾é”ã€‚é™¤äº†é”ç«äº‰ï¼Œå¦ä¸€æ–¹é¢ï¼Œsync_binlog=1çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡2PCéœ€è¦åˆ·ç›˜binlogåˆ·ç›˜ï¼Œè¿™ä¸ä»…å¢å¤§äº†ç£ç›˜å‹åŠ›ï¼Œä¹Ÿå»¶é•¿äº†å æœ‰é”çš„æ—¶é•¿ã€‚ äºæ˜¯mysql5.6å¼•å…¥äº†ç»„æäº¤ã€‚ 1.2. ç»„æäº¤ç»„æäº¤æ˜¯é€šè¿‡ä¸€ä¸ªæœºåˆ¶ä¿è¯binlogé¡ºåºå’Œcommité¡ºåºä¸€è‡´ã€‚ åŠ å…¥ç»„æäº¤ä¹‹åï¼Œ2PCçš„è¿‡ç¨‹ç¨å¾®å˜äº†ã€‚åœ¨å°†commité˜¶æ®µç»†åˆ†ï¼Œä¿è¯commité¡ºåºå’Œå†™binlogä¸€è‡´ã€‚ è¿™ä¸ªè¿‡ç¨‹æ¯ä¸ªé˜¶æ®µéƒ½ç”¨äº†ä¸€ä¸ªé˜Ÿåˆ—æ¥å­˜å‚¨ï¼Œå…ˆåˆ°çš„çº¿ç¨‹æ˜¯listçš„leaderï¼Œååˆ°çš„åŠ å…¥é“¾è¡¨æˆä¸ºfollowerï¼Œ prepareé˜¶æ®µï¼Œäº‹åŠ¡è·å–prepare_commit_mutexï¼Œç„¶ååˆ·ç›˜ï¼Œè®¾ç½®prepareçŠ¶æ€ï¼Œç„¶åé‡Šæ”¾é”ã€‚ commité˜¶æ®µåˆ†æˆä¸‰ä¸ªé˜¶æ®µï¼š Flush stage: leaderè·å¾—Lock_log mutexé”ï¼Œå°†é˜Ÿåˆ—é‡Œçš„binlogå†™å…¥æ–‡ä»¶ç¼“å†² Sync stage:leaderé‡Šæ”¾Lock_log mutexï¼ŒæŒæœ‰Lock_sync mutex, å¦‚æœsync_binlogä¸º1ï¼Œè¿›è¡Œsyncæ“ä½œ Commit stage: leaderé‡Šæ”¾Lock_sync mutexï¼ŒæŒæœ‰Lock_commit mutexï¼Œéå†é˜Ÿåˆ—ï¼Œé€ä¸€è¿›è¡Œcommitã€‚ æ¯ä¸ªé˜¶æ®µçš„é˜Ÿåˆ—é•¿åº¦ä¸æ˜¯ä¸€è‡´çš„ï¼Œå¯èƒ½Flushé˜¶æ®µçš„leaderä¼šåœ¨Syncé˜¶æ®µè¿½åŠ è¿›å‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæˆä¸ºfollowerï¼Œä½†æ˜¯followeræ°¸è¿œæ˜¯followerã€‚ ç½‘ä¸Šçš„è¿™ä¸ªå›¾å¾ˆå½¢è±¡ã€‚ åœ¨Sync stageé˜¶æ®µï¼Œæœ‰ä¸¤ä¸ªå‚æ•°å¯ä»¥å½±å“ç»„æäº¤ï¼š binlog_group_commit_sync_delay=N:è¿™ä¸ªå‚æ•°è¡¨æ˜åœ¨Sync stageç­‰å¾…å¤šå°‘Î¼såå¯ä»¥åˆ·ç›˜ï¼Œç­‰çš„è¶Šä¹…ï¼Œå°±è¶Šå¯èƒ½åˆå¹¶åæ¥çš„é˜Ÿåˆ—ï¼Œä¸€æ¬¡åˆ·æ›´å¤šæ—¥å¿—ï¼Œä½†æ˜¯ç›¸åº”çš„ï¼Œäº‹åŠ¡å“åº”å°±å˜æ…¢ã€‚ binlog_group_commit_sync_no_delay_count=N:å½“é˜Ÿåˆ—çš„äº‹åŠ¡ä¸ªæ•°è¾¾åˆ°Nï¼Œå°±è¿›è¡Œåˆ·ç›˜ã€‚ ç»„æäº¤ä¼˜ç‚¹ï¼š å°†æœ¬è¯¥ä¸²è¡Œçš„è¿‡ç¨‹å˜æˆå¯å¹¶è¡Œçš„è¿‡ç¨‹ è™½ç„¶prepare_commit_mutexæ²¡æœ‰å»é™¤ï¼Œä½†æ˜¯å ç”¨çš„æ—¶é—´å˜çŸ­äº†ï¼Œå˜æˆ1/4 é€šè¿‡é˜Ÿåˆ—ä¿è¯é¡ºåºä¸€è‡´ åˆå¹¶åˆ·ç›˜ 2. å´©æºƒæ¢å¤2.1. æœªå¼€å¯binlogä»redo logè¯»åˆ°last checkpoint lsnï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¼€å§‹é‡æ–°åº”ç”¨redo logï¼Œä¸ç®¡æ˜¯æäº¤è¿˜æ˜¯æœªæäº¤çŠ¶æ€ã€‚ç”±äºundo logä¼šè®°å½•æˆredo logï¼Œæ‰€ä»¥æ„é€ å‡ºundo logä¹‹åï¼Œå¯ä»¥é€šè¿‡undo logå›æ»šæœªæäº¤çš„äº‹åŠ¡ã€‚ 2.2. å¼€å¯binlogå…ˆå’Œä¸Šé¢æ‰§è¡Œä¸€æ ·çš„é€»è¾‘ï¼Œç”±äºå¤šäº†binlogï¼Œä¸ºäº†å’Œä»åº“ä¿è¯ä¸€è‡´ï¼Œéœ€è¦æå–æœ€åä¸€ä¸ªbinlogæ–‡ä»¶çš„XIDï¼Œæ¥ç€æ£€æŸ¥å¤„äºprepareçŠ¶æ€çš„redo logï¼Œå¦‚æœredo logçš„XIDä¸åœ¨binlogé‡Œï¼Œåˆ™å›æ»šï¼Œå¦‚æœåœ¨ï¼Œæäº¤redo logã€‚ 3. å‚è€ƒ ã€ŠMySQL5.7 æ ¸å¿ƒæŠ€æœ¯æ­ç§˜ï¼šMySQL Group commitã€‹","categories":[],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://htchz.cc/tags/Mysql/"}]},{"title":"[Mysql]æ¼«æ¸¸bin log","slug":"Mysql-bin-log","date":"2020-05-26T01:51:00.000Z","updated":"2020-06-05T09:00:10.794Z","comments":true,"path":"2414692924.html","link":"","permalink":"https://htchz.cc/2414692924.html","excerpt":"","text":"binlogæ˜¯serverå±‚çš„æ—¥å¿—ï¼Œå¯¹äºinnodbæ¥è¯´ï¼Œåªæœ‰binlogå†™å®Œåï¼Œæ‰èƒ½æäº¤redo logã€‚binlogè®°å½•é€»è¾‘è¯­å¥ï¼Œåªä¼šè®°å½•å†™ç±»ä¼¼äºsqlçš„æ—¥å¿—ã€‚binlogä¸»è¦çš„ä½œç”¨ å´©æºƒæ¢å¤ ä¸»ä»å¤åˆ¶ 1. ç»„ç»‡ç»“æ„1.1. æ–‡ä»¶binlogçš„ç›¸å…³é…ç½®å¯ä»¥æ‰§è¡Œshow variables like &#39;%bin%&#39;;æŸ¥çœ‹ 12345678910111213141516171819202122232425262728293031323334mysql&gt; show variables like '%bin%';+--------------------------------------------+---------------------------------+| Variable_name | Value |+--------------------------------------------+---------------------------------+| bind_address | * || binlog_cache_size | 32768 || binlog_checksum | CRC32 || binlog_direct_non_transactional_updates | OFF || binlog_error_action | ABORT_SERVER || binlog_format | ROW || binlog_group_commit_sync_delay | 0 || binlog_group_commit_sync_no_delay_count | 0 || binlog_gtid_simple_recovery | ON || binlog_max_flush_queue_time | 0 || binlog_order_commits | ON || binlog_row_image | FULL || binlog_rows_query_log_events | OFF || binlog_stmt_cache_size | 32768 || binlog_transaction_dependency_history_size | 25000 || binlog_transaction_dependency_tracking | COMMIT_ORDER || innodb_api_enable_binlog | OFF || innodb_locks_unsafe_for_binlog | OFF || log_bin | ON || log_bin_basename | /data/mysql3306/mysql-bin || log_bin_index | /data/mysql3306/mysql-bin.index || log_bin_trust_function_creators | ON || log_bin_use_v1_row_events | OFF || log_statements_unsafe_for_binlog | ON || max_binlog_cache_size | 18446744073709547520 || max_binlog_size | 536870912 || max_binlog_stmt_cache_size | 18446744073709547520 || sql_log_bin | ON || sync_binlog | 1 |+--------------------------------------------+---------------------------------+ æ‰§è¡Œshow master status;å¯ä»¥çœ‹åˆ°å½“å‰å†™å…¥çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„åå­—å’Œä½ç½®ã€‚ 1234567mysql&gt; show master status;+------------------+-----------+--------------+------------------+-------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+-----------+--------------+------------------+-------------------+| mysql-bin.000930 | 178613715 | | mysql,test | |+------------------+-----------+--------------+------------------+-------------------+1 row in set (0.10 sec) binlogä¸»è¦æœ‰ä¸¤ç§æ–‡ä»¶ï¼š äºŒè¿›åˆ¶æ—¥å¿—ç´¢å¼•æ–‡ä»¶ï¼ˆæ–‡ä»¶ååç¼€ä¸º.indexï¼‰ç”¨äºè®°å½•æ‰€æœ‰æœ‰æ•ˆçš„çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼ˆæ–‡ä»¶ååç¼€ä¸º.****ï¼‰è®°å½•æ•°æ®åº“æ‰€æœ‰çš„DDLå’ŒDMLè¯­å¥äº‹ä»¶ å¦‚ä¸Šè¾“å‡ºï¼ŒäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶å­˜æ”¾çš„basenameæ˜¯â€/data/mysql3306/mysql-bin.****â€ï¼ŒäºŒè¿›åˆ¶æ—¥å¿—ç´¢å¼•æ–‡ä»¶è·¯å¾„æ˜¯â€/data/mysql3306/mysql-bin.indexâ€, å…·ä½“å¦‚ä¸‹ 1234567891011121314[root@dev_test63 mysql3306]# ls -l mysql-bin*-rw-r----- 1 mysql mysql 538582976 5æœˆ 22 01:17 mysql-bin.000919-rw-r----- 1 mysql mysql 536879010 5æœˆ 22 12:03 mysql-bin.000920-rw-r----- 1 mysql mysql 536885288 5æœˆ 22 20:03 mysql-bin.000921-rw-r----- 1 mysql mysql 536871917 5æœˆ 23 05:05 mysql-bin.000922-rw-r----- 1 mysql mysql 536871391 5æœˆ 23 21:40 mysql-bin.000923-rw-r----- 1 mysql mysql 536895385 5æœˆ 24 07:03 mysql-bin.000924-rw-r----- 1 mysql mysql 536945072 5æœˆ 25 00:03 mysql-bin.000925-rw-r----- 1 mysql mysql 536904757 5æœˆ 25 09:03 mysql-bin.000926-rw-r----- 1 mysql mysql 536871742 5æœˆ 25 19:28 mysql-bin.000927-rw-r----- 1 mysql mysql 536870960 5æœˆ 26 04:34 mysql-bin.000928-rw-r----- 1 mysql mysql 536871255 5æœˆ 26 19:33 mysql-bin.000929-rw-r----- 1 mysql mysql 153202413 5æœˆ 27 00:22 mysql-bin.000930-rw-r----- 1 mysql mysql 228 5æœˆ 26 19:33 mysql-bin.index sync_binlogæ˜¯ç”¨æ¥è¡¨ç¤ºåŒæ­¥åˆ·binlogï¼Œå¦‚æœæ•°æ®åº“ç¹å¿™å¯èƒ½ä¼šé€ æˆç£ç›˜ioå‹åŠ›å¤§ å‚æ•°ä¸º0æ—¶ï¼Œå¹¶ä¸æ˜¯ç«‹å³fsyncæ–‡ä»¶åˆ°ç£ç›˜ï¼Œè€Œæ˜¯ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„fsyncæœºåˆ¶ï¼› å‚æ•°ä¸º1æ—¶ï¼Œç«‹å³fsyncæ–‡ä»¶åˆ°ç£ç›˜ï¼› å‚æ•°å¤§äº1æ—¶ï¼Œåˆ™è¾¾åˆ°æŒ‡å®šæäº¤æ¬¡æ•°åï¼Œç»Ÿä¸€fsyncåˆ°ç£ç›˜ã€‚ å› æ­¤åªæœ‰å½“sync_binlogå‚æ•°ä¸º1æ—¶ï¼Œæ‰æ˜¯æœ€å®‰å…¨çš„ï¼Œå½“å…¶ä¸ä¸º1æ—¶ï¼Œéƒ½å­˜åœ¨binlogæœªfsyncåˆ°ç£ç›˜çš„é£é™©ï¼Œè‹¥æ­¤æ—¶å‘ç”Ÿæ–­ç”µç­‰æ•…éšœï¼Œå°±æœ‰å¯èƒ½å‡ºç°æ­¤äº‹åŠ¡å¹¶æœªåˆ·å‡ºåˆ°ç£ç›˜ã€‚ sql_log_binè¡¨ç¤ºå¼€å¯binlogï¼Œå¼€å…³éƒ½éœ€è¦é‡å¯mysqlmysql-bin.indexè¿™ä¸ªæ–‡ä»¶å¾ˆç®€å•ï¼Œåªæ˜¯è®°å½•äº†å½“å‰çš„binlogåˆ—è¡¨ 12345678910111213[root@dev_test63 mysql3306]# cat mysql-bin.index./mysql-bin.000919./mysql-bin.000920./mysql-bin.000921./mysql-bin.000922./mysql-bin.000923./mysql-bin.000924./mysql-bin.000925./mysql-bin.000926./mysql-bin.000927./mysql-bin.000928./mysql-bin.000929./mysql-bin.000930 è€Œbinlogæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶é›†åˆï¼Œæ¯ä¸ªbinlogæ–‡ä»¶ä»¥ä¸€ä¸ª4å­—èŠ‚çš„é­”æ•°0xfe62696eå¼€å¤´ï¼ˆå3å­—èŠ‚å…¶å®å°±æ˜¯â€binâ€ï¼‰ æ¥ç€æ˜¯ä¸€ç»„Eventsï¼ŒEventç”±headerç»„æˆï¼Œheaderè®°å½•äº†åˆ›å»ºæ—¶é—´ã€æœåŠ¡å™¨æ ‡è¯†ç­‰ï¼Œdataæ˜¯æ•°æ®ã€‚ä¸€ä¸ªbinlogæ–‡ä»¶é‡Œï¼Œç¬¬ä¸€ä¸ªeventæè¿°binlogçš„æ ¼å¼ï¼Œæœ€åä¸€ä¸ªbinlogæè¿°ä¸‹ä¸€ä¸ªbinlogæ–‡ä»¶çš„ä¿¡æ¯ã€‚ 1.2. rotationå½“ä¸‹é¢ä¸‰ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œbinlogä¼šrotateæ–°æ–‡ä»¶ï¼š å®ä¾‹åœæ­¢æˆ–é‡å¯æ—¶ flush logs å‘½ä»¤ï¼› å½“å‰binlog &gt; max_binlog_size(åƒä¸Šé¢çš„é…ç½®æ˜¯512M) å¦‚æœæœ‰ä¸€ä¸ªå¤§äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œå¾ˆå¯èƒ½ä¼šå‘ç”Ÿä¸€ä¸ªbinlogæ–‡ä»¶ç¨å¤§äºmax_binlog_size 2. æ¨¡å¼binlogæœ‰ä¸‰ç§è®°å½•æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯statementï¼Œrowï¼Œmixedï¼Œé€šè¿‡binlog_formatæ¥æŒ‡å®šï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æŒ‡å®šã€‚ 2.1. statementstatementè®°å½•çš„æ˜¯åŸè¯­å¥ï¼Œä½ æ‰§è¡Œä»€ä¹ˆè¯­å¥å°±ä¼šè®°å½•ä»€ä¹ˆè¯­å¥ã€‚è¿™åœ¨ä¸»ä»å¤åˆ¶çš„æ—¶å€™å°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼š è¿™é‡Œæä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆå¤§å¤šæ•°æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯RCï¼Œè€Œinnodbæ˜¯RRå‘¢ï¼š è¿™æ˜¯ä¸€ä¸ªå†å²é—ç•™é—®é¢˜ï¼Œç½‘ä¸Šä¹Ÿå¯ä»¥æ‰¾åˆ°å¾ˆå¤šè§£é‡Šï¼Œå¤§ä½“å°±æ˜¯ï¼šåœ¨mysql5.1.5ä¹‹å‰åªæœ‰statementæ¨¡å¼ï¼Œå¦‚æœäº‹åŠ¡ç”¨RCéš”ç¦»çº§åˆ«ï¼Œå°±ä¼šå¯èƒ½å‡ºç°ä¸»ä»ä¸ä¸€è‡´çš„æƒ…å†µã€‚ ç°åœ¨å·²ç»ä¸èƒ½åœ¨statementæ¨¡å¼ä¸‹æ‰§è¡ŒRCäº‹åŠ¡äº†ï¼Œä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š Cannot execute statement: impossible to write to binary log since BINLOG_FORMAT = STATEMENT and at least one table uses a storage engine limited to row-based logging. InnoDB is limited to row-logging when transaction isolation level is READ COMMITTED or READ UNCOMMITTED. å‡è®¾RCå…è®¸ï¼Œé‚£ä¹ˆå‡è®¾studentè¡¨æœ‰scoreå­—æ®µï¼Œ äº‹åŠ¡A äº‹åŠ¡B begin; begin; delete from student where score &lt; 6; / / insert into student(score) values(1); / commit; commit; / åœ¨RRçº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Bçš„è¯­å¥ä¼šé˜»å¡ï¼Œå› ä¸ºäº‹åŠ¡Aä¼šç»™æ»¡è¶³æ¡ä»¶çš„åˆ—åŠ ä¸ŠXé”ï¼Œç»™é—´éš™åŠ ä¸Šgapé”ï¼Œæ‰€ä»¥äº‹åŠ¡Bæ˜¯ä¼šè¢«é˜»å¡çš„ã€‚åœ¨RCçº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Bçš„è¯­å¥æ˜¯ä¸ä¼šé˜»å¡çš„ï¼Œå› æ­¤å…ˆäºäº‹åŠ¡Aæäº¤ï¼Œæäº¤å®Œæˆå†™å…¥binlogï¼Œæ¥ç€Aæäº¤å†™å…¥binlogï¼Œ æ‰€ä»¥åœ¨binlogé‡Œæ˜¯è¿™æ ·çš„ï¼ˆåªæ˜¯ä¸¾ä¸ªğŸŒ°ï¼‰ï¼š 12insert into student(age) values(1);delete from student where age &lt; 6; è¿™æ ·binlogè¢«ä»åº“æ¶ˆè´¹ä¹‹åå°±ä¸»ä»å°±ä¸ä¸€è‡´ã€‚ 2.2. rowrowæ˜¯è®°å½•åˆ°æ¯ä¸€è¡Œçš„é€»è¾‘è¯­å¥ï¼Œæ¯”å¦‚æ‰§è¡Œupdate student set name = &#39;åœŸå·&#39; where age &lt; 10çš„sqlï¼Œå°±ä¼šç”Ÿæˆnæ¡è®°å½•ã€‚ è¿™æ ·å¯ä»¥é¿å…statementäº§ç”Ÿçš„é—®é¢˜ï¼Œç¼ºç‚¹å°±æ˜¯æ—¥å¿—é‡å¤ªå¤§ï¼Œå¯èƒ½ä¼šäº§ç”Ÿioå‹åŠ›ã€‚ 2.3. mixedmixedæ¨¡å¼æ˜¯ç”±mysqlè‡ªè¡Œåˆ¤æ–­ä½¿ç”¨å“ªç§æ¨¡å¼ã€‚è½¬æ¢æ¡ä»¶ä¼ é€é—¨ æ–°ç‰ˆæœ¬çš„MySQLå¯¹row levelæ¨¡å¼ä¹Ÿè¢«åšäº†ä¼˜åŒ–ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¿®æ”¹éƒ½ä¼šä»¥row levelæ¥è®°å½•ï¼Œåƒé‡åˆ°è¡¨ç»“æ„å˜æ›´çš„æ—¶å€™å°±ä¼šä»¥statementæ¨¡å¼æ¥è®°å½•ï¼Œå¦‚æœsqlè¯­å¥ç¡®å®å°±æ˜¯updateæˆ–è€…deleteç­‰ä¿®æ”¹æ•°æ®çš„è¯­å¥ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šè®°å½•æ‰€æœ‰è¡Œçš„å˜æ›´ï¼›å› æ­¤ï¼Œç°åœ¨ä¸€èˆ¬ä½¿ç”¨row levelå³å¯ã€‚ 3. binlogå†…å®¹3.1. mysqlbinlogmysqlbinlogæ˜¯mysqlæä¾›çš„ä¸€ä¸ªæŸ¥çœ‹binlogçš„å·¥å…·ï¼Œé€šè¿‡è¯¥å·¥å…·å¯ä»¥å°†äºŒè¿›åˆ¶æ–‡ä»¶è§£æä¸ºæ–‡æœ¬ä¾›æˆ‘ä»¬è¿›è¡Œé˜…è¯»ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„binlogï¼Œå¯ä»¥æŒ‡å®šæ—¶é—´æˆ–åç§»é‡ä½œä¸ºstartã€stopæ¥ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ã€‚å¦‚æœæŒ‡å®šçš„åç§»é‡ä¸æ˜¯ä¸€ä¸ªeventçš„èµ·å§‹åç§»é‡ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚ å½“å‰msyqlæ˜¯rowæ¨¡å¼ï¼Œæ‰§è¡Œmysqlbinlog -v --start-datetime=&quot;2020-05-25 09:59:59&quot; --stop-datetime=&quot;2020-05-25 10:00:00&quot; mysql-bin.000927 --base64-output=decode-rowsï¼Œ--base64-output=decode-rowsä¸ºäº†è§£ç rowæ ¼å¼ï¼Œ-vè¯¦ç»†è¾“å‡ºè¯­å¥ã€‚æˆªå–ä¸€éƒ¨åˆ†å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930# at 26237733#200525 9:59:59 server id 3306 end_log_pos 26237798 CRC32 0xbcd552f0 GTID [commit=no]SET @@SESSION.GTID_NEXT= 'ANONYMOUS'/*!*/;# at 26237798#200525 9:59:59 server id 3306 end_log_pos 26237883 CRC32 0x5558cbbe Query thread_id=43976966 exec_time=0 error_code=0SET TIMESTAMP=1590371999/*!*/;BEGIN/*!*/;# at 26237883#200525 9:59:59 server id 3306 end_log_pos 26237968 CRC32 0x8f9f400f Table_map: `superq_db`.`superq_trigger_registry` mapped to number 96550# at 26237968#200525 9:59:59 server id 3306 end_log_pos 26238162 CRC32 0x560afdaa Update_rows: table id 96550 flags: STMT_END_F### UPDATE `superq_db`.`superq_trigger_registry`### WHERE### @1=15093### @2='EXECUTOR'### @3='job-executor-saber'### @4='172.88.2.128:19012'### @5='172.88.2.128:10099'### @6=1590371989### SET### @1=15093### @2='EXECUTOR'### @3='job-executor-saber'### @4='172.88.2.128:19012'### @5='172.88.2.128:10099'### @6=1590371999# at 26238162#200525 9:59:59 server id 3306 end_log_pos 26238193 CRC32 0x1e662746 Xid = 3290666026COMMIT/*!*/; # at xxxxï¼šä¸€ä¸ªeventçš„å¼€å¤´ï¼Œ #200525 9:59:59ï¼šæ—¶é—´ï¼Œ20å¹´5æœˆ25æ—¥ï¼Œ9æ—¶59åˆ†59ç§’ server id 3306ï¼šserverç¼–å· end_log_pos 26237798ï¼šä¸‹ä¸€ä¸ªäº‹ä»¶å¼€å§‹çš„ä½ç½®ï¼ˆå³å½“å‰äº‹ä»¶çš„ç»“æŸä½ç½®+1ï¼‰ CRC32 0xbcd552f0ï¼šCRC32æ˜¯æ ¡éªŒå’Œçš„ç®—æ³•ï¼Œåœ¨ä¸Šé¢é…ç½®æ¸…å•é‡Œbinlog_checksumå¯ä»¥çœ‹åˆ°ï¼Œåé¢è·Ÿç€çš„æ˜¯32ä½æ ¡éªŒå’Œã€‚ Queryï¼ševent typeï¼Œå…·ä½“å¯ä»¥ç¿»é˜…Event Classes and Types thread_id=43976966ï¼šçº¿ç¨‹id exec_time=0ï¼šæ‰§è¡Œæ—¶é—´ error_code=0ï¼šé”™è¯¯ç ï¼Œ0è¡¨ç¤ºæ— é”™è¯¯ Xid = 3290666026ï¼šè¡¨ç¤ºredo logå’ŒbinlogåšXAçš„Xid 3.1.1. ç»“æ„ä½“å‰é¢è¯´åˆ°ï¼Œeventåˆ†ä¸ºheaderå’Œdataï¼Œäº‹å®ä¸Šï¼Œbinlog äº‹ä»¶çš„ç»“æ„ä¸»è¦æœ‰3ä¸ªç‰ˆæœ¬ï¼š v1: Used in MySQL 3.23 v3: Used in MySQL 4.0.2 though 4.1 v4: Used in MySQL 5.0 and up ç°åœ¨åŸºæœ¬ç”¨çš„æ˜¯v4ç‰ˆæœ¬ã€‚ 12345678910111213141516171819+=====================================+| event | timestamp 0 : 4 || header +----------------------------+| | type_code 4 : 1 || +----------------------------+| | server_id 5 : 4 || +----------------------------+| | event_length 9 : 4 || +----------------------------+| | next_position 13 : 4 || +----------------------------+| | flags 17 : 2 || +----------------------------+| | extra_headers 19 : x-19 |+=====================================+| event | fixed part x : y || data +----------------------------+| | variable part |+=====================================+ ä¸Šé¢ç”¨offset : lengthæè¿°äº†å„ä¸ªå±æ€§çš„ä½ç½®ï¼Œå¦‚æœäº‹ä»¶å¤´çš„é•¿åº¦æ˜¯ x å­—èŠ‚ï¼Œé‚£ä¹ˆäº‹ä»¶ä½“çš„é•¿åº¦ä¸º (event_length - x) å­—èŠ‚ï¼›è®¾äº‹ä»¶ä½“ä¸­ fixed part çš„é•¿åº¦ä¸º y å­—èŠ‚ï¼Œé‚£ä¹ˆ variable part çš„é•¿åº¦ä¸º (event_length - (x + y)) å­—èŠ‚ 3.1.2. binlog-checksumæ ¡éªŒå’ŒåŠŸèƒ½æ˜¯ä¸ºäº†é˜²æ­¢ä¼ è¾“è¿‡ç¨‹ä¸­å‘ç”Ÿå·®é”™ï¼Œä¸»ä»ä¸ä¸€è‡´ã€‚ å…³äºbinlog-checksumæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ binlog_checksumï¼šé»˜è®¤å€¼æ˜¯CRC32ï¼Œå¯ä»¥è®¾ç½®ä¸ºNONE master_verify_checksumï¼šä¸»åº“æ ¡éªŒeventæ ¡éªŒå’Œï¼Œé»˜è®¤ä¸º0ï¼Œåœ¨master threadè¿›è¡Œdumpçš„æ—¶å€™æ ¡éªŒï¼Œåœ¨SHOW BINLOG EVENTSæ ¡éªŒ slave_sql_verify_checksumï¼šä»åº“æ ¡éªŒeventæ ¡éªŒå’Œï¼Œé»˜è®¤ä¸º1ï¼Œå½“IO threadæŠŠeventå†™å…¥åˆ°relay logï¼ˆä»åº“è¯»å–åˆ°çš„binlogç”Ÿæˆrelay logï¼‰çš„æ—¶å€™æ ¡éªŒã€‚ mysqlbinlogå¯ä»¥åŠ ä¸Š--verify-binlog-checksumå‚æ•°ï¼Œæ‰“å°æœ‰é—®é¢˜çš„sqlã€‚ å¦‚æœæ ¡éªŒå¤±è´¥ä¼šæŠ¥é”™ï¼Œå¯ä»¥ç”¨pt-table-checksumå·¥å…·è¿›è¡Œä¿®æ­£ï¼Œå…³äºæ›´å¤šï¼Œå¦è¡Œäº†è§£ã€‚ 3.2. SHOW BINLOG EVENTSè¿™ä¸ªæ˜¯mysqlå‘½ä»¤ï¼Œä¹Ÿæ˜¯ç”¨æ¥é˜…è¯»binlogã€‚ä½¿ç”¨æ–¹å¼æ˜¯SHOW BINLOG EVENTS [IN &#39;log_name&#39;] [FROM pos] [LIMIT [offset,] row_count]ï¼Œä¸­æ‹¬å·éƒ½æ˜¯å¯é€‰é¡¹ã€‚ 3.3. GTIDå¯ä»¥åœ¨æ—¥å¿—é‡Œçœ‹åˆ°GTIDçš„å­—çœ¼ï¼ŒGTIDå³Global Transaction IDï¼Œå…¨å±€äº‹åŠ¡idï¼Œç”±server_uuid:transaction_idç»„æˆï¼Œæ˜¯åœ¨mysql5.6å¼•è¿›çš„ä¸€ä¸ªç‰¹æ€§ã€‚ ç»„å¤åˆ¶æ’ä»¶MGRmysqlå®˜æ–¹çš„ä¸€ä¸ªé«˜å¯ç”¨æ’ä»¶ï¼Œä½¿ç”¨äº†PAXOSåè®®ã€‚åœ¨è¿™ç§ä¸€è‡´æ€§åè®®ä¸­éœ€è¦æœ‰ä¸€ä¸ªå…¨å±€å¢é•¿çš„command indexï¼ŒGTIDå°±æ‰¿æ‹…äº†è¿™ä¸ªè§’è‰²ã€‚ æ‰§è¡Œshow variables like &#39;%gtid%&#39;;ï¼Œè¾“å‡º 12345678910111213+----------------------------------+-----------+| Variable_name | Value |+----------------------------------+-----------+| binlog_gtid_simple_recovery | ON || enforce_gtid_consistency | OFF || gtid_executed_compression_period | 1000 || gtid_mode | OFF || gtid_next | AUTOMATIC || gtid_owned | || gtid_purged | || session_track_gtids | OFF |+----------------------------------+-----------+8 rows in set (0.02 sec) gtid_modeå…¶å®æ˜¯OFFçŠ¶æ€ã€‚ å…³äºæ›´å¤šï¼Œå¦è¡Œäº†è§£ã€‚ 4. ä¸»ä»å¤åˆ¶ä¸»ä»å¤åˆ¶æœ‰åŸºäºbinlogå’ŒåŸºäºGTIDä¸¤ç§æ–¹å¼ã€‚åŸºäºbinlogçš„å¤åˆ¶æ¨¡å¼çš„åŸºæœ¬æµç¨‹æ˜¯ï¼š masteräº‹åŠ¡æäº¤ï¼Œå°†è®°å½•å˜æ›´å†™å…¥binlog slaveçš„ioè¿›ç¨‹è¿æ¥masterï¼Œä»æŒ‡å®šä½ç½®æˆ–ä»0å¼€å§‹è¯·æ±‚æ—¥å¿— masterè¿”å›æ—¥å¿—ç»™slaveï¼Œå¹¶å¸¦ä¸Šbinlogåç§°å’Œä¸‹ä¸€ä¸ªbinlogæ¶ˆè´¹ä½ç½® slaveæ¥æ”¶åˆ°æ—¥å¿—ï¼Œå°†æ—¥å¿—è¿½åŠ åˆ°relay logæœ«ç«¯ï¼Œå¹¶è®°å½•binlogåç§°å’Œbinlogæ¶ˆè´¹ä½ç½®ï¼Œä¸‹æ¬¡è¯·æ±‚ä½¿å¸¦ä¸Šã€‚ slaveçš„sqlè¿›ç¨‹ä¸æ–­è¯»relay logï¼Œæ‰§è¡Œsqlã€‚ å¦‚æœslaveå¼€å¯äº†binlogï¼Œåˆä¼šå°†æ‰§è¡Œçš„sqlå˜æ›´è®°å…¥binlogï¼›å¦‚æœslaveåˆæ˜¯å…¶ä»–slaveçš„masterï¼Œå°±ä¼šæ‰§è¡Œä¸€æ ·çš„é€»è¾‘ã€‚ åœ¨slaveä¸Šæ‰§è¡Œï¼Œshow slave status\\Gï¼Œéƒ¨åˆ†è¾“å‡ºå¦‚ä¸‹ 12345678910111213141516171819202122232425mysql&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 11.198.116.79 Master_User: replicator Master_Port: 3018 Connect_Retry: 60 Master_Log_File: mysql-bin.000831 Read_Master_Log_Pos: 1151797 Relay_Log_File: slave-relay.002490 Relay_Log_Pos: 313 Relay_Master_Log_File: mysql-bin.000831 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 1151797 Relay_Log_Space: 769 å¦‚æœRead_Master_Log_Poså’ŒExec_Master_Log_Posä¸€è‡´ï¼Œè¡¨ç¤ºä»åº“å·²ç»è¿½èµ¶ä¸Šä¸»åº“ã€‚ åœ¨ä¸»åº“æ‰§è¡Œshow master status\\Gï¼Œå¯ä»¥çœ‹åˆ°ä¸»åº“å½“å‰æ­£åœ¨å†™å…¥çš„binlogå’Œä½ç½®ã€‚ 5. å‚è€ƒ ã€ŠEvent Structureã€‹ ã€ŠMySQLä¸ºä»€ä¹ˆé»˜è®¤éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»ï¼Ÿã€‹ ã€Š10åˆ†é’Ÿå­¦ä¼šMysqlä¹‹Binlogã€‹","categories":[{"name":"Mysql","slug":"Mysql","permalink":"https://htchz.cc/categories/Mysql/"}],"tags":[]},{"title":"[Mysql]æ¼«æ¸¸redo log","slug":"Mysql-redo-log","date":"2020-05-19T14:00:05.000Z","updated":"2020-06-05T09:01:05.959Z","comments":true,"path":"1559835943.html","link":"","permalink":"https://htchz.cc/1559835943.html","excerpt":"","text":"redo logè´Ÿè´£è®°å½•ç‰©ç†æ•°æ®é¡µï¼Œæ‰€ä»¥æ— è®ºæ‰§è¡Œå¤šå°‘æ¬¡éƒ½æ˜¯å¹‚ç­‰çš„ï¼›è€Œbinlogæ˜¯è®°å½•é€»è¾‘æ•°æ®ï¼Œæ‰§è¡Œå¤šæ¬¡å°±å¯èƒ½é‡å¤æ•°æ®ã€‚ æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œinnodbå°†æœªå†™å…¥ç£ç›˜çš„é¡µå«åšè„é¡µï¼Œredo logçš„ä½œç”¨å°±æ˜¯è®°å½•è„é¡µçš„æ•°æ®ã€‚ åœ¨å®•æœºæ¢å¤æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡æ˜¯å¦æŒä¹…åŒ–æ˜¯æ ¹æ®redo logåˆ·ç›˜æƒ…å†µå†³å®šçš„ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡çš„redo logå·²ç»å…¨éƒ¨åˆ·å…¥ç£ç›˜ï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹åŠ¡æ˜¯æœ‰æ•ˆçš„ï¼Œåä¹‹éœ€è¦æ ¹æ®undo logå›æ»šã€‚ redo logåœ¨ç¡¬ç›˜ä¸­æ˜¯åˆ†æˆå¤šå—æ¥å­˜å‚¨çš„ï¼Œä»¥ib_logfile[number]å‘½åã€‚ æ‰§è¡ŒSHOW GLOBAL VARIABLES LIKE &quot;innodb_log%&quot;;ï¼Œ 1234567891011+-----------------------------+-----------+| Variable_name | Value |+-----------------------------+-----------+| innodb_log_buffer_size | 67108864 || innodb_log_checksums | ON || innodb_log_compressed_pages | ON || innodb_log_file_size | 536870912 || innodb_log_files_in_group | 4 || innodb_log_group_home_dir | ./ || innodb_log_write_ahead_size | 8192 |+-----------------------------+-----------+ innodb_log_files_in_groupæŒ‡å®šäº†redo logæ–‡ä»¶è¢«åˆ†ä¸ºå‡ éƒ¨åˆ†ï¼Œæ¯ä¸€éƒ¨åˆ†çš„æ–‡ä»¶å¤§å°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå½“å†™å…¥ib_logfile3åï¼Œåˆç»§ç»­å†™å…¥ib_logfile0ï¼Œå¦‚æ­¤å¾ªç¯ã€‚ è¿™æ˜¯åœ¨ç£ç›˜é‡Œçš„æ–‡ä»¶ï¼Œ 1234567[root@dev_test63 mysql3306]# ll ib*-rw-r----- 1 mysql mysql 683671552 5æœˆ 20 01:25 ibdata1-rw-r----- 1 mysql mysql 536870912 5æœˆ 20 01:24 ib_logfile0-rw-r----- 1 mysql mysql 536870912 5æœˆ 19 11:10 ib_logfile1-rw-r----- 1 mysql mysql 536870912 5æœˆ 20 01:24 ib_logfile2-rw-r----- 1 mysql mysql 536870912 5æœˆ 20 01:25 ib_logfile3-rw-r----- 1 mysql mysql 79691776 5æœˆ 20 01:01 ibtmp1 ibtmp1æ˜¯ä¸´æ—¶è¡¨ç©ºé—´ï¼Œibdata1æ˜¯å…±äº«è¡¨ç©ºé—´ã€‚ 1. ä¸ºä»€ä¹ˆè¦æœ‰redo log: redo logæ˜¯é¡ºåºå†™å…¥çš„ï¼Œè€Œæ•°æ®é¡µè½ç›˜æ˜¯éšæœºå­˜å‚¨ã€‚ å»¶è¿Ÿåˆ·è„é¡µå¯ä»¥èµ·åˆ°åˆå¹¶å¤šæ¬¡ä¿®æ”¹çš„ä½œç”¨ï¼Œmysqlçš„æœ€å°å­˜å‚¨å•ä½æ˜¯é¡µï¼Œä¸€ä¸ªé¡µæœ‰å¤šè¡Œï¼Œå¦‚æœæ¯æ¬¡ä¿®æ”¹ä¸€è¡Œå°±è¦æ›´æ–°æ•´ä¸ªé¡µï¼Œå¹¶ä¸æ˜¯é‚£ä¹ˆèƒ½æ¥æ”¶ã€‚ æœ‰äº†redo logä¹‹åï¼Œå¯¹äºä¸€è¡Œæ•°æ®ï¼Œé¦–å…ˆæ›´æ–°buffer poolï¼ˆåœ¨è¿™ä¹‹å‰è¿˜æœ‰undo logï¼‰ï¼Œç„¶åå†å†™å…¥log bufferã€‚ 2. ç»„ç»‡ç»“æ„ç”±äºredoè®°å½•çš„æ˜¯ç‰©ç†å˜æ›´ï¼Œæ¯”å¦‚åœ¨â€œç¬¬100è¡¨ç©ºé—´ç¬¬100é¡µåç§»é‡1024å†™å…¥4ä¸ªå­—èŠ‚balabalaâ€ï¼Œè€Œä¸æ˜¯æè¿°ç¬¬å‡ è¡Œæ”¹æˆä»€ä¹ˆæ ·ï¼Œä¸€è¡Œè®°å½•å˜æ›´æ¶‰åŠçš„ç‰©ç†é¡µå¯èƒ½æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥å¯èƒ½äº§ç”Ÿä¸€æ¡redo logï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å¤šæ¡redo logï¼Œè¿™ä¸ªå’Œundo logä¸åŒã€‚ 2.1. redo logè¿™æ˜¯ä¸€æ¡redo logçš„é€šç”¨ç»“æ„ typeï¼šredo logçš„ç±»å‹ï¼Œå¯èƒ½æ˜¯åŸºç¡€ç±»å‹ï¼Œä¹Ÿå¯èƒ½æ˜¯å¤æ‚ç±»å‹ Space IDï¼šè¡¨ç©ºé—´id page numberï¼šé¡µå· dataï¼šredo logå†…å®¹ å…·ä½“typeçš„ç±»å‹æœ‰å¾ˆå¤šï¼Œå‚è€ƒåº•éƒ¨é“¾æ¥ï¼Œå…¶ä¸­åŒ…æ‹¬undo logå¯¹åº”çš„redo logMLOG_UNDO_INSERTã€‚ä¸€ä¸ªæ“ä½œäº§ç”Ÿçš„redo logå¯èƒ½æ˜¯ä¸€ä¸ªï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ç»„redo logã€‚ 2.2. log blockç»„ç»‡redo logçš„æ˜¯log blockï¼Œä¸€ä¸ªlog blockæ˜¯å­˜å‚¨redo logçš„åŸºæœ¬å•ä½ï¼Œå’Œé¡µæœ‰ç‚¹ç±»ä¼¼ã€‚ log block headerï¼šå­˜æ”¾blockä¿¡æ¯ log block bodyï¼šå­˜æ”¾å¤šæ¡redo log log block trailerï¼šå­˜æ”¾blockçš„æ ¡éªŒå€¼ï¼Œç”¨äºæ­£ç¡®æ€§æ ¡éªŒ log bufferå’Œlog fileéƒ½æ˜¯ä»¥log blockä¸ºåŸºæœ¬æ“ä½œå•ä½ï¼Œredo logåœ¨log blocké‡Œé¡ºåºå†™å…¥ã€‚ 2.3. mtrMini-Transactionï¼Œå³mtrï¼Œ å‰é¢è¯´åˆ°ä¸€ä¸ªæ“ä½œå¯èƒ½äº§ç”Ÿä¸€ç»„redo logï¼Œé‚£ä¹ˆè¿™ç»„redo logæ˜¯éœ€è¦ä¿è¯äº‹åŠ¡æ€§çš„ï¼Œinnodbä½¿ç”¨mtrè¿™ç§æ¯”transactionæ›´å°ç²’åº¦çš„äº‹åŠ¡ï¼Œæ¥ä¿è¯ä¸€ç»„redoçš„äº‹åŠ¡æ€§ã€‚ mtrå¼€å¯åï¼Œä¼šå®šä½åˆ°è¦ä¿®æ”¹çš„pageçš„ä½ç½®ï¼Œå¯¹ç´¢å¼•åŠ é”ï¼›ä¹‹åæ‰§è¡Œä¸€ç³»åˆ—å†™æ“ä½œï¼ŒæœŸé—´äº§ç”Ÿçš„redo logä¼šæš‚å­˜åœ¨mtrå¯¹è±¡ä¸­ï¼›mtræäº¤æ—¶ï¼Œéœ€è¦æŠŠæš‚å­˜çš„redo logç»„æ”¾å…¥log bufferä¸­ï¼Œç„¶åæŠŠä¿®æ”¹çš„è„é¡µæ”¾å…¥flush listï¼Œä¹‹åé‡Šæ”¾pageçš„é”ã€‚ 3. åˆ·ç›˜ç­–ç•¥è¿™é‡Œæœ‰å‡ ä¸ªæ¦‚å¿µ buffer poolï¼šæŒ‡åœ¨å†…å­˜ä¸­çš„æ•°æ®é¡µï¼Œinnodbéœ€è¦æŠŠç‰©æµæ•°æ®é¡µè¯»åˆ°å†…å­˜ä¸­è¿›è¡Œä¿®æ”¹ã€‚ log bufferï¼šæŒ‡redo logçš„bufferï¼Œå±äºè¿›ç¨‹ã€‚ redo log fileï¼šæŒ‡å†…å­˜ä¸­çš„redo logæ–‡ä»¶ï¼Œå±äºæ“ä½œç³»ç»Ÿï¼Œå¾…fsyncåˆ°ç£ç›˜ä¸­ã€‚ redo logåˆ·ç›˜æ—¶æœºå¦‚ä¸‹ï¼š æœ‰äº‹åŠ¡æäº¤æ—¶ï¼Œæ ¹æ®äº‹åŠ¡æäº¤æ—¶çš„åˆ·ç›˜ç­–ç•¥å†³å®šæ˜¯å¦åˆ·ç›˜ innodb_flush_log_at_timeouté»˜è®¤å€¼ä¸º1ï¼Œä¹Ÿå°±æ˜¯1så†…å¦‚æœæ²¡å‘ç”Ÿåˆ·ç›˜ï¼Œéœ€è¦è¿›è¡Œåˆ·ç›˜ å½“log bufferä¸­å·²ç»ä½¿ç”¨çš„å†…å­˜è¶…è¿‡ä¸€åŠæ—¶ å½“åˆ°è¾¾checkpointæ—¶ 3.1. äº‹åŠ¡æäº¤æ—¶çš„åˆ·ç›˜ç­–ç•¥innodb_flush_log_at_trx_commitæŒ‡å®šäº†redo logçš„äº‹åŠ¡æäº¤åˆ·ç›˜ç­–ç•¥ï¼Œåˆ†åˆ«ä¸‰ä¸ªå€¼0ï¼šæ¯æ¬¡æäº¤äº‹åŠ¡ï¼Œä¸ä¼šå°†log bufferå†™å…¥redo log fileï¼Œè€Œæ˜¯ç”±master threadæ¯ç§’å°†log bufferå†™å…¥redo log fileï¼Œå¹¶è°ƒç”¨fsyncè½ç›˜1ï¼šæ¯æ¬¡æäº¤äº‹åŠ¡ï¼Œå°†log bufferå†™å…¥redo log fileï¼ŒåŒæ—¶è°ƒç”¨fsyncè½ç›˜ï¼Œæ˜¯æœ€ä¸¥æ ¼ä¹Ÿæ˜¯æ€§èƒ½æœ€å·®çš„ç­–ç•¥2: æ¯æ¬¡æäº¤äº‹åŠ¡ï¼Œå°†log bufferå†™å…¥redo log fileï¼Œæ¯ç§’è°ƒç”¨fsyncè½ç›˜ 0å’Œ2çœ‹èµ·æ¥æœ‰ç‚¹ç›¸ä¼¼ã€‚åŒºåˆ«åœ¨äºï¼Œå‰è€…æ²¡æœ‰å°†log bufferåŒæ­¥å†™å…¥redo log fileï¼Œè¦çŸ¥é“redo log fileæ˜¯æ–‡ä»¶ï¼Œæ‰€ä»¥0æ²¡åŒæ­¥å†™å…¥æ–‡ä»¶ï¼Œæ€§èƒ½ä¼šæ¯”2é«˜ï¼Œä½†mysqlå´©æºƒæ—¶ï¼Œä¼šä¸¢å¤±æ—¥å¿—ï¼›è€Œ2åŒæ­¥å†™å…¥æ–‡ä»¶ï¼Œå·²ç»å°†æ—¥å¿—æäº¤åˆ°æ“ä½œç³»ç»Ÿäº†ï¼Œåªæœ‰æ“ä½œç³»ç»Ÿå®•æœºäº†æ‰ä¼šä¸¢å¤±æ—¥å¿—ã€‚ æˆ‘ä»¬çº¿ä¸Šæ•°æ®åº“innodb_flush_log_at_trx_commitçš„å€¼æ˜¯1ï¼Œæœ‰ä¸€æ¬¡åŒäº‹æ¸…ç†æ•°æ®æ—¶åšäº†ä¸ªå…¨è¡¨æ›´æ–°ï¼Œredo logç–¯ç‹‚åˆ·ç›˜ï¼Œä»è€Œå¯¼è‡´æ•°æ®åº“ç¼“æ…¢ï¼Œäºæ˜¯è¿ç»´å…³é—­äº†åŒ1ï¼ˆinnodb_flush_log_at_trx_commitå’Œsync_binlogï¼‰ï¼Œæš‚åœäº†æ¸…ç†è„šæœ¬ï¼Œæ‰å¾—ä»¥æ¢å¤ã€‚ 4. LSNLog sequence numberæ˜¯ä¸€ä¸ª8å­—èŠ‚çš„ä¸æ–­å¢é•¿çš„æ•°å­—ï¼Œè¡¨ç¤ºæ—¥å¿—ç¼–å·ï¼Œèµ·åˆ°ä¸€ä¸ªç±»ä¼¼ç‰ˆæœ¬çš„ä½œç”¨ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½æœ‰è¿™ä¸ªLSNï¼Œæœ€ç»ˆéœ€è¦è¿™nä¸ªåœ°æ–¹çš„LSNè¾¾åˆ°ä¸€è‡´ã€‚ é€šè¿‡LSNå¯ä»¥è·å¾—ï¼š æ•°æ®é¡µçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚ å†™å…¥çš„æ—¥å¿—æ€»é‡ï¼Œé€šè¿‡LSNå¼€å§‹å·ç å’Œç»“æŸå·ç å¯ä»¥è®¡ç®—å‡ºå†™å…¥çš„æ—¥å¿—é‡ã€‚ å¯çŸ¥é“æ£€æŸ¥ç‚¹çš„ä½ç½®ã€‚ æ‰§è¡ŒSHOW ENGINE INNODB STATUS;å¯ä»¥çœ‹åˆ°å’ŒLSNæœ‰å…³çš„ä¿¡æ¯ï¼š 123456789---LOG---Log sequence number 1509428892Log flushed up to 1509428892Pages flushed up to 1509300590Last checkpoint at 15093005810 pending log flushes, 0 pending chkp writes3554874 log i/o's done, 0.00 log i/o's/second Log sequence numberæ˜¯redo log bufferçš„LSNlog flushed up toæ˜¯åˆ·åˆ°redo log fileåœ¨ç¡¬ç›˜ä¸­çš„LSNï¼›pages flushed up toæ˜¯å·²ç»åˆ·åˆ°ç£ç›˜æ•°æ®é¡µä¸Šçš„LSNlast checkpoint atæ˜¯ä¸Šä¸€æ¬¡æ£€æŸ¥ç‚¹æ‰€åœ¨ä½ç½®çš„LSN å¯ä»¥çœ‹åˆ°LSNä¸æ˜¯å®Œå…¨ä¸€è‡´ï¼Œæµ‹è¯•ç¯å¢ƒdbæ˜¯ç©ºé—²çš„ï¼ŒLog sequence numberå’Œlog flushed up toæ˜¯ç›¸åŒçš„ï¼Œpages flushed up toè½åï¼Œè¿™æ˜¯å› ä¸ºè„é¡µå¾ˆå°‘çš„è¯å¯ä»¥æš‚æ—¶ä¸åˆ·åˆ°ç£ç›˜ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œlog sequence number &gt; log flushed up to å’Œ pages flushed up to &gt; last checkpoint at å¯èƒ½ä¼šå‡ºç°æ•°æ®é¡µåˆ·ç›˜å¿«äºredo logåˆ·ç›˜çš„æƒ…å†µï¼Œè¿™æ—¶checkpointæ˜¯æœ‰æœºåˆ¶ä¿æŠ¤æ•°æ®æ…¢äºæ—¥å¿—ï¼Œæ‰€ä»¥ä¼šæš‚åœæ•°æ®é¡µåˆ·ç›˜ï¼Œç­‰å¾…æ—¥å¿—åˆ·ç›˜è¿›åº¦è¶…è¿‡æ•°æ®åˆ·ç›˜ã€‚ ç”±äºè®°å½•ç‰©ç†æ•°æ®é¡µï¼Œå¦‚æœåœ¨ä¸€ä¸ªäº‹åŠ¡é‡ŒæŠŠaæ›´æ–°æˆbï¼ŒåˆæŠŠbæ›´æ–°ä¸ºaï¼Œä¼šä¸ä¼šä¿å­˜åˆ°redo logé‡Œçš„ï¼Ÿ è¯•éªŒè¿‡åï¼Œæ‰§è¡ŒSHOW ENGINE INNODB STATUS\\Gï¼Œå¯ä»¥çœ‹åˆ°Log sequence numberæœ‰å¢åŠ ï¼› 5. checkpointç”±äºredo logç›¸å½“äºç»™æ•°æ®é¡µåšäº†ä¸ªå¤‡ä»½ï¼Œæ‰€ä»¥äº‹åŠ¡æäº¤æ—¶å¹¶ä¸ä¸€å®šè¦æŠŠæ•°æ®é¡µè½ç›˜ã€‚ä½†æ˜¯ï¼š1ï¼šbuffer poolæ˜¯æœ‰é™çš„ï¼Œ2ï¼šredo log bufferæ˜¯æœ‰é™çš„ã€‚æ‰€ä»¥éœ€è¦ä¸€ä¸ªæ—¶æœºï¼Œå°†buffer poolé‡Œçš„æ•°æ®è½ç›˜ï¼ŒåŒæ—¶æ¸…é™¤redo log bufferé‡Œå·²ç»è½ç›˜çš„æ•°æ®é¡µï¼Œè¿™ä¸ªæ—¶æœºå°±æ˜¯checkpointã€‚æ•°æ®åº“é‡å¯åçš„æ¢å¤ï¼Œåªéœ€è¦ä»checkpoint lsnç®—èµ·ï¼Œcheckpoint lsnä¹‹å‰çš„æ•°æ®éƒ½æ˜¯è®¤ä¸ºå·²ç»æŒä¹…åŒ–çš„ã€‚ checkpointçš„ç›®çš„å¾ˆç®€å•ï¼Œå³æŠŠæ•°æ®é¡µè½ç›˜ï¼Œä½†æ˜¯ä»€ä¹ˆæ—¶å€™ã€åˆ·å¤šå°‘é¡µåˆ°ç£ç›˜ã€ä»å“ªé‡Œå–è„é¡µéƒ½æœ‰äº›ä¸åŒã€‚ checkpoint_lsnæ˜¯æŒ‡checkpointå‘ç”Ÿåˆ·ç›˜ä¹‹åï¼Œè®°å½•æ­¤æ¬¡checkpointçš„lsnåˆ°redo log fileçš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å¤´å¯ä»¥ç†è§£ä¸ºç®¡ç†æ•°æ®é¡µç¼“å†²çš„æ•°æ®ç»“æ„ï¼Œéœ€è¦ä¿è¯FLUSHåˆ—è¡¨ï¼šLRUçš„æœ‰ä¸¤ç§Checkpointï¼Œåˆ†åˆ«ä¸ºï¼šSharp Checkpointã€Fuzzy Checkpointã€‚ Sharp Checkpointæ˜¯å…¨éƒ¨åˆ·ç›˜ï¼Œå‘ç”Ÿåœ¨åˆ‡æ¢redo logæ–‡ä»¶æˆ–è€…æ•°æ®åº“å…³é—­çš„æ—¶å€™ï¼Œéœ€è¦æŠŠbuffer poolçš„æ•°æ®é¡µå…¨åˆ·ç›˜ã€‚ MySQLåœæ­¢æ—¶æ˜¯å¦å°†è„æ•°æ®å’Œè„æ—¥å¿—åˆ·å…¥ç£ç›˜ï¼Œç”±å˜é‡innodb_fast_shutdown={ 0|1|2 }æ§åˆ¶ï¼Œé»˜è®¤å€¼ä¸º1ï¼Œå³åœæ­¢æ—¶å¿½ç•¥æ‰€æœ‰flushæ“ä½œï¼Œåœ¨ä¸‹æ¬¡å¯åŠ¨çš„æ—¶å€™å†flushï¼Œå®ç°fast shutdownã€‚ Fuzzy Checkpointæ˜¯éƒ¨åˆ†åˆ·ç›˜ï¼Œåˆ†ä¸ºå››ç§ã€‚ 5.1. master thread checkpointç”±masterçº¿ç¨‹æ§åˆ¶ï¼Œæ¯1ç§’ï¼Œæ¯10ç§’åˆ·å…¥ä¸€å®šæ¯”ä¾‹çš„è„é¡µåˆ°ç£ç›˜ï¼Œå¼‚æ­¥ã€‚ 5.2. flush_lru_list checkpointä»MySQL5.6å¼€å§‹å¯é€šè¿‡innodb_page_cleanerså˜é‡æŒ‡å®šä¸“é—¨è´Ÿè´£è„é¡µåˆ·ç›˜çš„page cleanerçº¿ç¨‹çš„ä¸ªæ•°ï¼Œè¯¥çº¿ç¨‹çš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯lru_listè¡¨æœ‰å¯ç”¨çš„ç©ºé—²é¡µã€‚ 5.3. async/sync flush checkpointï¼šåŒæ­¥åˆ·ç›˜/å¼‚æ­¥åˆ·ç›˜ã€‚ä¾‹å¦‚è¿˜æœ‰éå¸¸å¤šçš„è„é¡µæ²¡åˆ·åˆ°ç£ç›˜(éå¸¸å¤šæ˜¯å¤šå°‘ï¼Œæœ‰æ¯”ä¾‹æ§åˆ¶)ï¼Œè¿™æ—¶å€™ä¼šé€‰æ‹©åŒæ­¥åˆ·åˆ°ç£ç›˜ï¼Œä½†è¿™å¾ˆå°‘å‡ºç°ï¼›å¦‚æœè„é¡µä¸æ˜¯å¾ˆå¤šï¼Œå¯ä»¥é€‰æ‹©å¼‚æ­¥åˆ·åˆ°ç£ç›˜ï¼Œå¦‚æœè„é¡µå¾ˆå°‘ï¼Œå¯ä»¥æš‚æ—¶ä¸åˆ·è„é¡µåˆ°ç£ç›˜ã€‚ è¿™é‡Œæœ‰å››ä¸ªé…ç½® 12345678innodb_log_files_in_group=4innodb_log_file_size=4Gæ€»æ–‡ä»¶å¤§å°: 17179869184log_sys-&gt;max_modified_age_async = 12175607164 (71%)log_sys-&gt;max_modified_age_sync = 13045293390 (76%)log_sys-&gt;max_checkpoint_age_async = 13480136503 (78%)log_sys-&gt;max_checkpoint_age = 13914979615 (81%) è®¾ï¼Œcheckpoint_age = log_lsn - last_checkpoint_lsnï¼Œmax_modified_age = log_lsn - è„é¡µæœ€å°lsn å½“max_modified_age &gt; max_modified_age_asyncsï¼Œéœ€è¦flush_listå–å‡ºè„é¡µï¼Œå¼‚æ­¥åˆ·ç›˜å½“max_modified_age &gt; max_modified_age_syncï¼Œéœ€è¦flush_listå–å‡ºè„é¡µï¼ŒåŒæ­¥åˆ·ç›˜ å½“checkpoint_age &gt; max_checkpoint_age_asyncï¼Œå¯ä»¥æ— éœ€ç­‰å¾…checkpointå®Œæˆå½“checkpoint_age &gt; max_checkpoint_ageï¼Œéœ€è¦åŒæ­¥ç­‰å¾…checkpointå®Œæˆ 5.4. dirty page too much checkpointè„é¡µå¤ªå¤šæ—¶å¼ºåˆ¶è§¦å‘æ£€æŸ¥ç‚¹ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¿è¯ç¼“å­˜æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ã€‚è„é¡µæ¯”ä¾‹ç”±å˜é‡ innodb_max_dirty_pages_pct æ§åˆ¶ï¼ŒMySQL 5.6é»˜è®¤çš„å€¼ä¸º75ï¼Œå³å½“è„é¡µå ç¼“å†²æ± çš„75%åï¼Œå°±å¼ºåˆ¶åˆ·ä¸€éƒ¨åˆ†è„é¡µåˆ°ç£ç›˜ã€‚ å…³äºä¸Šé¢æåˆ°çš„åˆ—è¡¨ï¼š lru_listï¼šæ˜¯ä¸€ä¸ªä½¿ç”¨äº†æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•çš„åˆ—è¡¨ï¼Œå¯ä»¥ç†è§£ä¸ºç®¡ç†æ•°æ®é¡µç¼“å†²çš„æ•°æ®ç»“æ„ã€‚flush_listï¼šlruçš„çš„è„é¡µä¼šæ”¾è¿›è¿™ä¸ªåˆ—è¡¨ï¼Œä½†æ˜¯ä¸ä¼šä»lruç§»é™¤ï¼Œæ‰€ä»¥è„é¡µä¼šå­˜åœ¨ä¸¤ä¸ªåœ°æ–¹ã€‚flush_listé‡Œçš„è„é¡µä¼šæ ¹æ®lsnæœ€ä¸ºæ’åºä¾æ®ï¼Œä¿è¯lsnå°çš„å…ˆè½ç›˜ã€‚free_listï¼šfree_listå¦‚æœæ²¡æœ‰ç©ºé—²é¡µå¯ä»¥åˆ†é…ï¼Œå°±ä¼šä»lru_listæ‰¹é‡æ·˜æ±°æ•°æ®é¡µä»¥ä¾›ä½¿ç”¨ã€‚ 6. redo logå¤ªå¤§å’Œå¤ªå°å¯ä»¥çœ‹åˆ°ï¼Œasync/sync flush checkpointè¿™ç§ç±»å‹çš„checkpointå…¶å®æ˜¯å’Œlog_fileçš„å¤§å°æœ‰å…³çš„ã€‚å¦‚æœlog_fileå°äº†ï¼Œä¼šä½¿checkpointå˜å¤šï¼Œå½±å“innodbæ€§èƒ½ï¼›å¦‚æœlog_fileå¤§äº†ï¼Œä¸¤æ¬¡checkpointè·¨åº¦å¤§ï¼Œåœ¨æ¢å¤çš„æ—¶å€™å¯èƒ½å°±ä¼šç­‰å¾…å¤ªä¹…ï¼ˆæŒ‚äº†è·‘è·¯å§ğŸ˜„ï¼‰ã€‚ å…·ä½“å¤šå¤§åº”è¯¥ç»“åˆå®é™…æµ‹è¯•ã€‚ 7. ä¸¤é˜¶æ®µæäº¤ å´©æºƒæ¢å¤å¦å¤–è®²ã€‚ 8. å‚è€ƒ ã€Šè¯¦ç»†åˆ†æMySQLäº‹åŠ¡æ—¥å¿—(redo logå’Œundo log)ã€‹ ã€ŠInnoDB log file è®¾ç½®å¤šå¤§åˆé€‚ï¼Ÿã€‹ ã€ŠMySQLè¿ç»´å†…å‚ã€‹èŠ‚é€‰ | InnoDBæ—¥å¿—ç®¡ç†æœºåˆ¶ï¼ˆäº”ï¼‰ ã€ŠRedo Logâ€”â€”ç¬¬ä¸€ç¯‡ã€‹ ã€ŠMySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB redo logæ¼«æ¸¸ã€‹","categories":[{"name":"Mysql","slug":"Mysql","permalink":"https://htchz.cc/categories/Mysql/"}],"tags":[]},{"title":"[Mysql]æ¼«æ¸¸undo log","slug":"Mysql-undo-log","date":"2020-05-10T01:51:00.000Z","updated":"2020-06-05T09:00:41.138Z","comments":true,"path":"1791523990.html","link":"","permalink":"https://htchz.cc/1791523990.html","excerpt":"Innodbå­¦ä¼šæ˜¯ä¸å¯èƒ½å­¦ä¼šçš„ï¼Œè¿™è¾ˆå­éƒ½å­¦ä¸ä¼šçš„ã€‚","text":"Innodbå­¦ä¼šæ˜¯ä¸å¯èƒ½å­¦ä¼šçš„ï¼Œè¿™è¾ˆå­éƒ½å­¦ä¸ä¼šçš„ã€‚ innodbæ˜¯ä¸€ä¸ªæ—¥å¿—å…ˆè¡Œï¼ˆWrite-ahead loggingï¼‰çš„å­˜å‚¨å¼•æ“ï¼Œè¿™ä¹Ÿæ˜¯å¤§éƒ¨åˆ†å…³ç³»å‹æ•°æ®åº“çš„ç‰¹ç‚¹ã€‚è€Œåƒredisè¿™æ ·çš„nosqlå°±æ˜¯æ•°æ®ä¸ºå…ˆï¼Œå†è¿›è¡Œè½ç›˜ã€‚ undo logå’Œredo logå’Œbinlogï¼Œè¿™ä¸‰ä¸ªlogæ˜¯mysqlåŠinnodbçš„å…³é”®ã€‚è¿™ä¸‰ç§æ—¥å¿—éƒ½ä¼šåˆ·ç›˜ï¼Œå…¶ä¸­ï¼š undo log: äº‹åŠ¡åŸå­æ€§å’Œå¤šç‰ˆæœ¬æ§åˆ¶MVCCï¼ˆäº‹åŠ¡éš”ç¦»ï¼‰ redo log: äº‹åŠ¡æŒä¹…æ€§ï¼Œå®•æœºæ¢å¤ binlog: å®•æœºæ¢å¤ï¼Œä¸»ä»åŒæ­¥ å¯ä»¥çœ‹å‡ºä¸‰ä¸ªæ—¥å¿—åœ¨å¯¹åº”åŠŸèƒ½ä¸Šéœ€è¦ç›¸äº’åä½œã€‚undo logå’Œredo logæ˜¯äº‹åŠ¡æ—¥å¿—ï¼›redo logè¦ç­‰binlogå†™å…¥æˆåŠŸæ‰èƒ½commitï¼›undo Logä¿è¯äº‹åŠ¡çš„åŸå­æ€§ï¼Œredo logä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚ ç½‘ä¸Šå¤§å¤šéƒ½æ˜¯è®²undo logèƒ½åšä»€ä¹ˆï¼Œä½†æ²¡å‡ ç¯‡è®²æ¸…æ¥šundo logç»„ç»‡ç»“æ„ã€‚innodbæœ€å°å­˜å‚¨ç²’åº¦æ˜¯é¡µpageï¼Œè€Œé¡µå°±åˆ†ä¸ºFIL_PAGE_INDEXç´¢å¼•é¡µï¼ˆç´¢å¼•å³æ•°æ®ï¼‰å’ŒFIL_PAGE_UNDO_LOGundoé¡µã€‚ éƒ¨åˆ†æ¦‚å¿µæ˜¯å…³äºMVCCçš„ï¼Œéœ€è¦é…åˆ[Mysql]Innodbçš„å¿«ç…§è¯»å®ç°é£Ÿç”¨ï¼Œæœ¬æ–‡ä¸åšè®¨è®ºã€‚ undo logå°±æ˜¯ä¸ªå†å²ç‰ˆæœ¬ï¼Œè½ç›˜åä¸å’Œredo logå­˜åœ¨ä¸€èµ·ã€‚ 1. è¡¨ç©ºé—´InnoDBå­˜å‚¨å¼•æ“æä¾›äºŒç§æ•°æ®åº“è¡¨çš„å­˜å‚¨æ–¹å¼ ç³»ç»Ÿè¡¨ç©ºé—´ï¼šæ‰€æœ‰æ•°æ®ä¸Šæ”¾åœ¨ä¸€èµ·ï¼Œç‰©ç†æ–‡ä»¶å¯ä»¥æ‹†æˆå¤šä¸ªæ–‡ä»¶ã€‚ ç‹¬å è¡¨ç©ºé—´ï¼šæ¯ä¸ªè¡¨æœ‰è‡ªå·±çš„ç‰©ç†æ–‡ä»¶ï¼Œæ€§èƒ½æ›´å¥½ã€‚ å…³äºæ›´å¤šä¸åœ¨è®¨è®ºèŒƒå›´ã€‚ 2. ç»“æ„å±‚æ¬¡Rollback Segmentï¼ˆrsegï¼‰ç§°ä¸ºå›æ»šæ®µã€‚Mysql5.6ä¹‹å‰undoé»˜è®¤è®°å½•åˆ°ç³»ç»Ÿè¡¨ç©ºé—´ï¼ˆibdataï¼‰ï¼Œå¦‚æœå¼€å¯äº† innodb_file_per_table ï¼Œå°†æ”¾åœ¨æ¯ä¸ªè¡¨çš„.ibdæ–‡ä»¶ä¸­ã€‚5.6ä¹‹åè¿˜å¯ä»¥åˆ›å»ºç‹¬ç«‹çš„undoè¡¨ç©ºé—´ï¼Œ8ä¹‹åæ›´æ˜¯é»˜è®¤æ‰“å¼€ç‹¬ç«‹undoè¡¨ç©ºé—´ï¼Œæœ€ä½æ•°é‡ä¸º2ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯è‡³å°‘ä¸€ä¸ªundoè¡¨ç©ºé—´è¿›è¡Œtruncateï¼Œä¸€ä¸ªundoè¡¨ç©ºé—´ç»§ç»­ä½¿ç”¨ã€‚ç‹¬ç«‹undoè¡¨ç©ºé—´çš„æ–‡ä»¶æ ¼å¼æ˜¯undo001ï¼Œundo002â€¦â€¦ æ¯ä¸ªrollback Segmentä¸­é»˜è®¤æœ‰1024ä¸ªundo log segmentï¼Œmysql5.5å1ä¸ªundoè¡¨ç©ºé—´æ”¯æŒ128ä¸ªrollback Segmentã€‚0å·rollback Segmenté»˜è®¤åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ibdataä¸­ï¼Œ1-32rollback Segmentåœ¨ä¸´æ—¶è¡¨ç©ºé—´ï¼Œ33ï½128åœ¨ç‹¬ç«‹undoè¡¨ç©ºé—´ä¸­ï¼ˆæ²¡æœ‰æ‰“å¼€åˆ™åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ibdataä¸­ï¼Œè¿™æ ·ç³»ç»Ÿè¡¨ç©ºé—´ä¼šå¤ªå¤§ï¼‰ï¼Œæ‰€ä»¥1ä¸ªè¡¨ç©ºé—´æœ€å¤šæ”¯æŒ96*1024ä¸ªäº‹åŠ¡ï¼Œè¶…äº†å°±æŠ¥é”™å•¦ã€‚ ä¸€ä¸ªundo log segmentç§°ä¸ºundo logæˆ–undo slotæˆ–undoï¼›ä¸€ä¸ªundo logå¯¹è±¡å¯¹åº”å¤šä¸ªundo log recordï¼Œä¹Ÿå°±æ˜¯è®°å½•çš„å†å²ç‰ˆæœ¬ã€‚ ä¸€ä¸ªundo log segmentæœ‰ä¸€ä¸ªpageé“¾è¡¨ï¼Œundo log recordå°±æ˜¯æ”¾åœ¨pageä¸­çš„ï¼Œå½“ä¸€ä¸ªpageä¸è¶³ä»¥æ”¾ä¸‹æ–°çš„undo log recordæ—¶ï¼Œä¼šåˆ†é…æ–°çš„pageï¼Œæ”¾åˆ°é“¾è¡¨å°¾éƒ¨ã€‚ ä¸€ä¸ªundo log segmentå…¶å®æ˜¯ä¸€ä¸ªé¡µå«undo log header pageï¼Œæœ‰INSERT/UPDATEä¸¤ä¸ªç±»å‹ã€‚è¿™ä¸ªé¡µæœ‰ä¸€é¡¹å†…å®¹TRX_UNDO_PAGE_LISTæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå³undo pageé“¾è¡¨ã€‚ ç®€å•æ¥è¯´ï¼Œç»“æ„æ˜¯è¿™æ ·çš„ï¼š rollback segments(128) undo log segments(1024) undo page(Nï¼‰ undo record undo record â€¦ A collection of undo logs. Undo log segments exists within rollback segments. An undo log segment might contain undo logs from multiple transactions. An undo log segment can only be used by one transaction at a time but can be reused after it is released at transaction commit or rollbackâ€”â€”mysql#undo_log_segment ä¸€ä¸ªrollback Segmentå¯ä»¥è¢«å¤šä¸ªäº‹åŠ¡ä½¿ç”¨ã€‚è€Œä¸€ä¸ªundo log segmentåªèƒ½è¢«ä¸€ä¸ªäº‹åŠ¡å æœ‰ã€‚ç”±äºundo log segmentåŒºåˆ†æ’å…¥å’Œæ›´æ–°ï¼ŒåˆåŒºåˆ†ä¸´æ—¶è¡¨å’Œæ™®é€šè¡¨ï¼Œæ‰€ä»¥ä¸€ä¸ªäº‹åŠ¡è‡³å¤šå æœ‰å››ä¸ªundo log segmentã€‚ 2.1. å¤´è¿™å¼ å›¾é‡Œï¼Œ Undo Log Segment Headerï¼šæ˜¯undo logçš„ç¬¬ä¸€é¡µï¼Œä¸å­˜æ”¾record undo log headerï¼šå›¾é‡ŒUndo Log Segment Headerçš„TRX_UNDO_LAST_LOGå±æ€§æŒ‡å‘äº†ä¸€ä¸ªundo pageï¼Œæ¯ä¸€ä¸ªundo pageéƒ½æœ‰undo log headeræè¿°è¿™ä¸ªundo pageçš„ä¿¡æ¯ã€‚ undo page headerï¼šå›¾é‡Œæ²¡æœ‰ï¼Œè¿™ä¸ªheaderç±»ä¼¼äºæ•°æ®é¡µçš„page headerã€‚ 3. å†™undo logè¿‡ç¨‹3.1. åˆ†é…å›æ»šæ®µå½“è¯»å†™äº‹åŠ¡å¼€å¯æˆ–åªè¯»äº‹åŠ¡è½¬åŒ–ä¸ºè¯»å†™äº‹åŠ¡æ—¶ï¼Œä¼šä¸ºä¸€ä¸ªäº‹åŠ¡åˆ†é…äº‹åŠ¡idå’Œä¸€ä¸ªå›æ»šæ®µï¼ˆåªè¯»äº‹åŠ¡çš„idæ˜¯0ï¼‰ã€‚ åˆ†é…é€»è¾‘ï¼š è½®è¯¢ï¼ˆç¯å½¢ç¼“å†²ï¼ŒåŒredo logï¼‰é€‰å–ä¸€ä¸ªå¯ç”¨çš„å›æ»šæ®µï¼› é€‰å–çš„å›æ»šæ®µå¼•ç”¨è®¡æ•°+1ï¼ˆå¤šå¯¹ä¸€ï¼‰ï¼Œé˜²æ­¢è¢«å›æ”¶ï¼ˆtruncateï¼‰ã€‚ ä¸´æ—¶è¡¨ä½¿ç”¨ä¸´æ—¶è¡¨å›æ»šæ®µï¼Œç‰¹ç‚¹æ˜¯ä¸ç”¨å†™redo logï¼Œæ™®é€šè¡¨ä½¿ç”¨çš„æ™®é€šå›æ»šæ®µéœ€è¦å†™redo logã€‚ 3.2. ä½¿ç”¨å›æ»šæ®µæ•°æ®å˜æ›´æ—¶ï¼Œinsertå’Œupdateåˆ†åˆ«å†™ç›¸ä¼¼ä½†ä¸åŒçš„undo logã€‚ ä¸´æ—¶è¡¨ä¸ç”¨å†™redo log æ“ä½œæ—¶æœªåˆ†é…undo log statementï¼Œåˆ™å¯¹å˜æ›´ç±»å‹åˆ†é…å¯¹åº”çš„undo log statement åˆ†é…undo log statementæ—¶ï¼Œå¦‚æœç¼“å­˜åˆ—è¡¨æœ‰å¯ç”¨çš„undo log statementï¼Œå–å‡ºæ¥ä½¿ç”¨ã€‚ redo logæœ‰è®¸å¤šç§ç±»å‹ï¼Œè¿™é‡Œæ˜¯ä¸€ç§typeä¸ºMLOG_UNDO_INSERTçš„æ—¥å¿—ï¼Œä¿è¯undo logæ˜¯æœ‰æ•ˆçš„ã€‚ 3.3. å†™å…¥undo loginsertçš„undo recordé•¿è¿™æ · type_cmplï¼šundo logç±»å‹ï¼Œpurgeæ—¶ç”¨ undo noï¼šäº‹åŠ¡ç¼–å· table idï¼šè¡¨id updateçš„undo recordé•¿è¿™æ · DATA_ROLL_PTRï¼šè¯¥è¡Œå¯¹åº”çš„å‰ä¸€ä¸ªå†å²ç‰ˆæœ¬çš„æŒ‡é’ˆï¼Œä»è€Œæ„å»ºä¸€ä¸ªå†å²ç‰ˆæœ¬çš„é“¾è¡¨ type_cmplï¼šundo logç±»å‹ï¼Œè¾…åŠ©purgeçº¿ç¨‹æ¸…ç† (posN,lenN,u_old_colN)[]ï¼šå­—æ®µæ—§å€¼ï¼Œåªéœ€è¦è®°å½•è¢«æ›´æ–°çš„å­—æ®µ (pos,len,colN)[]ï¼šè¢«æ›´æ–°çš„äºŒçº§ç´¢å¼•ï¼Œå›æ»šçš„æ—¶å€™éœ€è¦ undo noï¼šäº‹åŠ¡ç¼–å· table idï¼šè¡¨id äº‹åŠ¡noå’Œäº‹åŠ¡idè¿˜æ˜¯æœ‰äº›ä¸åŒçš„ï¼Œäº‹åŠ¡ç¼–å·æ˜¯ç”¨æ¥æ’åºçš„ï¼Œåœ¨äº‹åŠ¡æäº¤ä¹‹å‰é€šè¿‡å…¨å±€è®¡æ•°å™¨ç”Ÿæˆï¼Œç›®çš„æ˜¯ä¸ºäº†æ”¾å…¥histroy listæœ‰åºï¼Œæ–¹ä¾¿purgeæ¸…ç†ã€‚ ä¸åŒç±»å‹çš„undo recordä¸‹æœ‰äº›å±æ€§æ²¡æœ‰ï¼Œä¾‹å¦‚ç´¢å¼•æ²¡å˜åŒ–çš„æƒ…å†µä¸‹ï¼Œ(pos,len,colN)[]å°±æ²¡è®°å½•ã€‚ (å…¶å®æˆ‘ä¸çŸ¥é“è®°unique keyå¹²å˜›çš„) 3.4. undo logç±»å‹purgeçº¿ç¨‹åœ¨å¯¹å¾…undo logæ—¶ï¼Œä¼šæ ¹æ®undo logçš„ç±»å‹åšä¸åŒçš„åŠ¨ä½œï¼Œä¸‹é¢åˆ†ä¸ºä¸‰ç±»ï¼Œæ‹¬å·é‡Œæ˜¯åŠ¨ä½œ æ’å…¥ï¼š TRX_UNDO_INSERT_RECï¼šè¡¨ç¤ºæ–°å¢è®°å½•ï¼ˆä¸»é”®è®°å…¥æ—¥å¿—ï¼‰ TRX_UNDO_UPD_DEL_RECï¼šå½“è¡¨ä¸­æœ‰ä¸€æ¡è¢«æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•å’Œè¦æ’å…¥çš„æ•°æ®ä¸»é”®ç›¸åŒæ—¶ï¼Œå®é™…æ˜¯æ›´æ–°è¿™æ¡è¢«æ ‡è®°åˆ é™¤çš„è®°å½•ã€‚ï¼ˆä¸»é”®è®°å…¥æ—¥å¿—ï¼‰ æ›´æ–°ï¼š TRX_UNDO_UPD_EXIST_RECï¼šï¼ˆå°†ä¸»é”®å’Œè¢«æ›´æ–°äº†çš„å­—æ®µå†…å®¹è®°å…¥æ—¥å¿—ï¼‰ åˆ é™¤ï¼š TRX_UNDO_DEL_MARK_RECï¼šï¼ˆä¸»é”®è®°å…¥æ—¥å¿—ï¼‰æ ‡è®°åˆ é™¤ 3.5. æ’å…¥æ’å…¥æ—¶æ„å»ºçš„undo logï¼ŒåŒ…æ‹¬undoç±»å‹ï¼Œundo noï¼Œtable idï¼Œä¸»é”®å„åˆ—ä¿¡æ¯ã€‚ insert undo logåœ¨äº‹åŠ¡æäº¤åå°±ä¼šè¢«åˆ é™¤ã€‚ 3.6. æ›´æ–°æ›´æ–°æ—¶æ„å»ºçš„undo logï¼ŒåŒ…æ‹¬undoç±»å‹ï¼Œundo noï¼Œtable idï¼Œä¸»é”®å„åˆ—ä¿¡æ¯ï¼Œdata_trx_idã€data_roll_pointerï¼Œè¢«æ›´æ–°çš„äºŒçº§ç´¢å¼•ï¼Œn_updatedï¼Œå­—æ®µæ—§å€¼ã€‚ MVCCé‚£ç¯‡è®²è¿‡ï¼Œæ¯è¡Œè®°å½•éƒ½æœ‰ä¸‰ä¸ªéšè—å­—æ®µï¼Œæ‰€ä»¥è®°å½•çš„old_trx_idã€old_roll_pointerä¼šè¢«è®°å…¥undo logï¼Œold trx_idè¡¨ç¤ºä¿®æ”¹çš„äº‹åŠ¡idï¼Œold_roll_pointeræŒ‡å‘å‰ä¸€ä¸ªundo recordã€‚ å¦‚æœè¦æ›´æ–°ä¸€è¡Œè®°å½•çš„ä¸»é”®ï¼Œéœ€è¦åˆ é™¤è®°å½•ï¼ˆdelete_markç½®1ï¼Œä¸èƒ½åŒæ­¥åˆ é™¤ï¼Œä¸ºäº†MVCCï¼‰ï¼Œå†æ’å…¥æ–°è®°å½•ï¼Œæ‰€ä»¥ä¼šæœ‰TRX_UNDO_DEL_MARK_RECå’ŒTRX_UNDO_INSERT_RECä¸¤æ¡æ—¥å¿—ã€‚ å¯¹äºäºŒçº§ç´¢å¼•çš„æ›´æ–°éƒ½æ˜¯åˆ é™¤+æ’å…¥ã€‚ å¦‚æœæ›´æ–°ä¸€è¡Œå‰åçš„å­˜å‚¨ç©ºé—´ä¸ä¸€æ ·å¤§ï¼Œä¹Ÿéœ€è¦åˆ é™¤ï¼ˆåŒæ­¥åˆ é™¤ï¼‰å†æ’å…¥ã€‚ 3.7. åˆ é™¤åˆ é™¤ä¸€æ¡è®°å½•ï¼Œå…¶å®åˆ†ä¸¤ä¸ªé˜¶æ®µï¼Œ prepareé˜¶æ®µï¼šå°†deleteæ ‡å¿—ä½ç½®1ï¼Œæ„é€ undo log purgeé˜¶æ®µï¼šè¿™ä¸ªå‘ç”Ÿåœ¨äº‹åŠ¡æäº¤åï¼Œå°†è®°å½•ç§»åŠ¨åˆ°åƒåœ¾é“¾è¡¨ï¼Œç­‰å¾…å¤ç”¨ã€‚ åƒåœ¾é“¾è¡¨æ˜¯æŒ‡æ•°æ®é¡µä¸Šçš„ä¸€ä¸ªå±æ€§PAGE_FREEï¼ŒæŒ‡å‘ä¸€ä¸ªé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œå¯ä»¥å‚é˜…æ–‡ç« åº•éƒ¨çš„é“¾æ¥ã€‚ åˆ é™¤å±äºæ›´æ–°ï¼Œæ‰€ä»¥ä»–ä»¬çš„undo logæ˜¯åŒä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä¸è¿‡åˆ é™¤ç±»å‹çš„undo logå°‘äº†n_updatedå’Œå­—æ®µæ—§å€¼ï¼Œä»¥åŠè¢«æ›´æ–°çš„äºŒçº§ç´¢å¼•ã€‚ 3.8. äº‹åŠ¡prepareäº‹åŠ¡å¼€å§‹çš„é˜¶æ®µï¼Œéœ€è¦å°†undo log header pageçš„äº‹åŠ¡çŠ¶æ€TRX_UNDO_STATEè®¾ç½®ä¸ºTRX_UNDO_PREPARED 3.9. äº‹åŠ¡æäº¤å…ˆè¯´ä¸€ä¸‹history listï¼Œshow engine innodb statusæ‰§è¡Œè¿™ä¸ªå‘½ä»¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°history list 123456789101112*** WE ROLL BACK TRANSACTION (1)------------TRANSACTIONS------------Trx id counter 2915975770Purge done for trx's n:o &lt; 2915975770 undo n:o &lt; 0 state: running but idleHistory list length 47LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421366361910208, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 421366361903824, not started0 lock struct(s), heap size 1136, 0 row lock(s) è¿™ä¸ªå€¼è¡¨ç¤ºè¿˜æœ‰å¤šå°‘undo logæ²¡è¢«æ¸…ç†ï¼Œè¿™ä¸ªå€¼å¤ªå¤§çš„è¯ï¼Œè¯´æ˜æœ‰undo logç”±äºæœ‰å¤§äº‹åŠ¡å­˜åœ¨è€Œæ— æ³•è¢«æ¸…ç†ã€‚ Undo Log Segment Headeræœ‰ä¸ªTRX_UNDO_STATEï¼Œäº‹åŠ¡æäº¤æ—¶ï¼ŒTRX_UNDO_STATEæœ‰ä¸‰ç§å€¼ï¼Œ å¦‚æœå½“å‰çš„undo logåªå ä¸€ä¸ªpageï¼Œä¸”å ç”¨å¤§å°ä½¿ç”¨ä¸è¶³å…¶3/4æ—¶(TRX_UNDO_PAGE_REUSE_LIMIT)ï¼Œåˆ™çŠ¶æ€è®¾ç½®ä¸ºTRX_UNDO_CACHEDï¼Œè¯¥undoå¯¹è±¡ä¼šéšååŠ å…¥åˆ°undo cache listä¸Šï¼› å¦‚æœäº‹åŠ¡ç±»å‹æ˜¯TRX_UNDO_INSERT_RECï¼Œåˆ™çŠ¶æ€è®¾ç½®ä¸ºTRX_UNDO_TO_FREE å¦‚æœä¸æ»¡è¶³ä¸Šé¢çš„ï¼Œå°±éœ€è¦purgeçº¿ç¨‹å»æ¸…ç†ï¼ŒçŠ¶æ€è®¾ç½®ä¸ºTRX_UNDO_TO_PURGE å¯¹äºupdate undoå¯¹è±¡éœ€è¦æ”¾å…¥history listä¸Šï¼Œå…·ä½“æ˜¯å°†å½“å‰undoåŠ å…¥åˆ°å›æ»šæ®µheaderçš„TRX_RSEG_HISTORYé“¾è¡¨ä¸Šã€‚ å¦‚æœupdate undoåªæœ‰æ™®é€šè¡¨ï¼Œåˆ™ç»™History list length+1ï¼Œå¦‚æœè¿˜æœ‰ä¸´æ—¶è¡¨ï¼Œåˆ™+2ï¼Œç„¶åå”¤é†’purgeçº¿ç¨‹ã€‚ å¦‚æœupdate undoéœ€è¦ç¼“å­˜ï¼Œåˆ™æ”¾å…¥å›æ»šæ®µçš„update_undo_cachedé“¾è¡¨ä¸Šï¼›å¦åˆ™é‡Šæ”¾undoå¯¹è±¡å†…å­˜ã€‚ å¯¹äºinsert undoåœ¨äº‹åŠ¡é‡Šæ”¾é”ã€ä»è¯»å†™äº‹åŠ¡é“¾è¡¨æ¸…é™¤ã€å…³é—­read viewåæ‰è¿›è¡Œï¼Œä¹Ÿå°±æ˜¯ç­‰æ‰€æœ‰åäº‹éƒ½åŠå®Œæ‰æ¸…ç†ã€‚ å¦‚æœinsert undoéœ€è¦ç¼“å­˜ï¼Œåˆ™æ”¾å…¥å›æ»šæ®µçš„insert_undo_cachedé“¾è¡¨ä¸Šï¼›å¦åˆ™é‡Šæ”¾undoå¯¹è±¡å†…å­˜ã€‚å’Œupdate undoä¸åŒçš„æ˜¯ï¼Œinsert undoä¸éœ€è¦æ”¾å…¥hisotry listã€‚ äº‹åŠ¡æäº¤åï¼Œå›æ»šæ®µçš„å¼•ç”¨è®¡æ•°-1ã€‚ tip1ï¼šç”±äºcacheçš„åŸå› ï¼Œå³ä½¿dbç©ºé—²ä¸­ï¼Œhistory listçš„é•¿åº¦ä¸€èˆ¬éƒ½ä¸ä¼šæ˜¯0ã€‚tip2ï¼šinsert undoçš„é‡ç”¨æ˜¯ç›´æ¥resetï¼Œè€Œupdate undoçš„é‡ç”¨æ˜¯ä¼šå’Œä¸Šä¸€ä¸ªäº‹åŠ¡çš„undo pageå…±å­˜çš„ï¼Œå…·ä½“æ˜¯undo pageä¸Šçš„undo log headeræœ‰TRX_UNDO_NEXT_LOG å’ŒTRX_UNDO_PREV_LOGæ¥è¡¨ç¤ºäº‹åŠ¡åœ¨é¡µé¢ä¸­çš„åç§»é‡çš„ 3.10. æ¸…ç† purgepurgeå‘ç”Ÿåœ¨äº‹åŠ¡commitæ—¶ã€‚update undoä¼šè¢«æ”¾å…¥history listä¸­ï¼Œå½“æ²¡æœ‰æ´»è·ƒçš„äº‹åŠ¡ä½œç”¨äºundo logæ—¶ï¼Œä¼šè¢«purgeçº¿ç¨‹æ¸…ç†ã€‚å¦‚ä½•åˆ¤æ–­æœ‰æ²¡æœ‰æ´»è·ƒçš„äº‹åŠ¡ä½œç”¨äºundo log?innodbä¼šå¿«å…‹éš†ä¸€ä¸ªæ´»è·ƒçš„æœ€è€çš„read viewï¼Œæ‰€æœ‰åœ¨è¿™ä¸ªread viewä¹‹å‰çš„undo logéƒ½æ˜¯å¯ä»¥æ¸…ç†çš„ã€‚ purgeçº¿ç¨‹ä»history listæ‰¹é‡å–åˆ°undo logåï¼Œå¯¹äºin-placeæ›´æ–°ï¼Œéœ€è¦çœ‹éœ€ä¸éœ€è¦æ¸…ç†äºŒçº§ç´¢å¼•ï¼›å¯¹äºåˆ é™¤æ“ä½œï¼Œéœ€è¦å°†åˆ é™¤è®°å½•æ”¾å…¥æ•°æ®é¡µåƒåœ¾é“¾è¡¨PAGE_FREEä¸­ã€‚ 3.11. å›æ»šäº‹åŠ¡å›æ»šåªéœ€è¦æ‹¿åˆ°undo logçš„è¿›è¡Œé€†å‘æ“ä½œå°±å¯ä»¥äº†ã€‚ å¯¹äºæ ‡è®°åˆ é™¤çš„è®°å½•æ¸…ç†delete_markï¼›å¯¹äºæ›´æ–°ï¼Œå°†æ•°æ®å›æ»šåˆ°æœ€è€ç‰ˆæœ¬ï¼Œå›æ»šç´¢å¼•ï¼›å¯¹äºæ’å…¥æ“ä½œï¼Œç›´æ¥åˆ é™¤èšé›†ç´¢å¼•ï¼ˆåï¼‰å’ŒäºŒçº§ç´¢å¼•ï¼ˆå…ˆï¼‰ã€‚ 3.12. æŒä¹…åŒ–todo 3.13. å´©æºƒæ¢å¤å…¶ä»–ç¯‡ã€‚ 4. åè®°ç”±äºinsertå’Œupdateçš„ç§ç§åŒºåˆ«ï¼Œä»¥è‡³äºundo log segmentéœ€è¦åˆ†æˆä¸¤ç§ã€‚ 5. å‚è€ƒ ã€ŠMySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB undo log æ¼«æ¸¸ã€‹ ã€Šinnodbæºç åˆ†æä¹‹pageç»“æ„è§£æã€‹ ã€ŠMySQL 5.7 Reference Manual 14.6.7 Undo Logsã€‹ ã€ŠInnoDB undo logã€‹","categories":[{"name":"Mysql","slug":"Mysql","permalink":"https://htchz.cc/categories/Mysql/"}],"tags":[]},{"title":"[ç½‘ç»œ]ç«¯å£è½¬å‘","slug":"ç½‘ç»œ-åˆ©ç”¨iptablesè½¬å‘æµé‡","date":"2020-05-01T15:53:39.000Z","updated":"2020-07-07T07:03:07.209Z","comments":true,"path":"2735588161.html","link":"","permalink":"https://htchz.cc/2735588161.html","excerpt":"","text":"ä¹‹å‰ä¹°çš„GGCå®¶çš„HK vpsï¼Œä»å»å¹´å¼€å§‹ç”µä¿¡è®¿é—®ä¸€ç›´ä¸¢åŒ…ï¼Œä¸¢åŒ…ç‡ä¸€ä¸Šå»ï¼Œå¸¦å®½å†å¤§é€Ÿåº¦ä¹Ÿæ˜¯æä¸ä¸Šå»ï¼ˆ[ç½‘ç»œ]TCPæ‹¥å¡æ§åˆ¶é‚£äº›äº‹ï¼‰ã€‚ äºæ˜¯æƒ³åˆ°ä¹°ä¸ªnatæœºä¸­è½¬ä¸€ä¸‹æµé‡ã€‚ (2æ ¸384å†…å­˜ï¼Œé€‚åˆç”¨æ¥ä¸­è½¬æµé‡) 1. iptablesç«¯å£è½¬å‘natåˆ°æ‰‹åï¼Œæœºå™¨é•œåƒç”¨çš„æ˜¯centos7ï¼Œå…³é—­firewallï¼ŒæŠŠiptablesè£…ä¸Šã€‚ 123456# å…³é—­ firewalldsystemctl disable firewalld --now# è£…iptablesyum install iptables-services# å¼€æœºå¯åŠ¨systemctl enable iptables.service --now æ¥ç€å¼€å¯ipv4è½¬å‘ï¼Œé»˜è®¤iptablesæ˜¯å…³é—­ipv4è½¬å‘ 123456# ä¸´æ—¶å¼€å¯ ipv4 è½¬å‘echo 1 &gt; /proc/sys/net/ipv4/ip_forward# æ°¸ä¹…å¼€å¯ ipv4 è½¬å‘echo 'net.ipv4.ip_forward = 1' &gt;&gt; /etc/sysctl.conf# ä½¿ç”Ÿæ•ˆsysctl -p æ¥ç€æ˜¯åŠ iptablesè§„åˆ™ï¼Œéœ€è¦åœ¨natè¡¨åŠ å…¥ä¸€æ¡DNATå’Œä¸€æ¡SNATï¼ŒDNATæ˜¯ä¿®æ”¹ç›®çš„åœ°å€ï¼Œè½¬å‘æµé‡åˆ°HK vpsï¼›SNATæ˜¯ä¿®æ”¹æºåœ°å€ï¼Œä¿è¯æµé‡å›åˆ°è¿™å°æœºä¸Šï¼ˆåªæœ‰è¿™å°æœºçŸ¥é“æ€ä¹ˆå›åˆ°æˆ‘å®¶ï¼‰ã€‚ å‡è®¾NATæœºç›‘å¬10086ç«¯å£ï¼ŒHK vpsçš„ipæ˜¯104.104.104.104ï¼ŒssæœåŠ¡ç«¯å£æ˜¯10010ï¼ŒNATæœºå†…ç½‘åœ°å€æ˜¯192.168.1.10 12345678910# DNATiptables -t nat -A PREROUTING -p tcp -m tcp --dport 10086 -j DNAT --to-destination 104.104.104.104:10010# SNATï¼Œ--to-source ip[:port] portå¯ä»¥ä¸æŒ‡å®šï¼Œä¼šæ˜¯éšæœºçš„iptables -t nat -A POSTROUTING -p tcp -m tcp -d 104.104.104.104 --dport 10010 -j SNAT --to-source 192.168.1.10# åº”ç”¨iptablesservice iptables save# é‡å¯systemctl restart iptables# çœ‹ä¸‹natè¡¨iptables -nL -t nat æ­¤å¤–ï¼Œnatæœºè¦å¼€æ”¾10086ç«¯å£ã€‚ æœ€åä¸€æ­¥ï¼Œåœ¨natæ§åˆ¶é¢æ¿çš„NATè½¬å‘ç­–ç•¥åˆ›å»ºç­–ç•¥ï¼Œåˆ›å»ºä¸€ä¸ªæ˜ å°„åˆ°è¯¥æœºå™¨10086çš„ç­–ç•¥ï¼Œå°±èƒ½æ‹¿åˆ°å…¬ç½‘ipå’Œç«¯å£äº†ã€‚ 2. firewallç«¯å£è½¬å‘firewallçš„ä¼šç®€å•ä¸€äº› 12345678# å…è®¸é˜²ç«å¢™ä¼ªè£…IPfirewall-cmd --add-masquerade --permanent# æ£€æŸ¥æ˜¯å¦å…è®¸ä¼ªè£…IPfirewall-cmd --query-masquerade # æ·»åŠ è½¬å‘è§„åˆ™firewall-cmd --permanent --zone=public --add-forward-port=port=10086:proto=tcp:toport=10010:toaddr=104.104.104.104# å¼€æ”¾ç›‘å¬ç«¯å£firewall-cmd --zone=public --add-port=10086/tcp --permanent","categories":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"https://htchz.cc/categories/ç½‘ç»œ/"}],"tags":[{"name":"iptables","slug":"iptables","permalink":"https://htchz.cc/tags/iptables/"}]},{"title":"[JVM]JVMä¸­ä¸‰è‰²æ ‡è®°æ³•","slug":"JVM-JVMä¸­ä¸‰è‰²æ ‡è®°æ³•","date":"2020-03-17T14:53:15.000Z","updated":"2020-04-02T08:07:09.175Z","comments":true,"path":"2394647798.html","link":"","permalink":"https://htchz.cc/2394647798.html","excerpt":"","text":"ä¸‰è‰²æ ‡è®°ç®—æ³•æ˜¯æè¿°è¿½è¸ªå¼å›æ”¶å™¨çš„ä¸€ç§æœ‰ç”¨çš„æ–¹æ³•ï¼Œåˆ©ç”¨å®ƒå¯ä»¥æ¨æ¼”å›æ”¶å™¨çš„æ­£ç¡®æ€§ã€‚å¯¹è±¡åˆ†æˆä¸‰ç§ç±»å‹: é»‘è‰²:æ ¹å¯¹è±¡ï¼Œæˆ–è€…è¯¥å¯¹è±¡ä¸å®ƒçš„å­å¯¹è±¡éƒ½è¢«æ‰«æ ç°è‰²:å¯¹è±¡æœ¬èº«è¢«æ‰«æ,ä½†è¿˜æ²¡æ‰«æå®Œè¯¥å¯¹è±¡ä¸­çš„å­å¯¹è±¡ ç™½è‰²:æœªè¢«æ‰«æå¯¹è±¡ï¼Œæ‰«æå®Œæˆæ‰€æœ‰å¯¹è±¡ä¹‹åï¼Œæœ€ç»ˆä¸ºç™½è‰²çš„ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œå³åƒåœ¾å¯¹è±¡ æ ¹å¯¹è±¡è¢«ç½®ä¸ºé»‘è‰²ï¼Œå­å¯¹è±¡è¢«ç½®ä¸ºç°è‰²ã€‚ç»§ç»­ç”±ç°è‰²éå†,å°†å·²æ‰«æäº†å­å¯¹è±¡çš„å¯¹è±¡ç½®ä¸ºé»‘è‰²ã€‚ éå†äº†æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡åï¼Œæ‰€æœ‰å¯è¾¾çš„å¯¹è±¡éƒ½å˜æˆäº†é»‘è‰²ã€‚ä¸å¯è¾¾çš„å¯¹è±¡å³ä¸ºç™½è‰²ï¼Œéœ€è¦è¢«æ¸…ç†ã€‚è¿™çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œä½†æ˜¯å¦‚æœåœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¹Ÿåœ¨è¿è¡Œï¼Œé‚£ä¹ˆå¯¹è±¡çš„æŒ‡é’ˆå°±æœ‰å¯èƒ½æ”¹å˜ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå¯¹è±¡ä¸¢å¤±é—®é¢˜ æˆ‘ä»¬çœ‹ä¸‹é¢ä¸€ç§æƒ…å†µï¼Œå½“åƒåœ¾æ”¶é›†å™¨æ‰«æåˆ°ä¸‹é¢æƒ…å†µæ—¶ï¼š 12A.c=CB.c=null è¿™æ ·ï¼Œå¯¹è±¡çš„çŠ¶æ€å›¾å˜æˆå¦‚ä¸‹æƒ…å½¢ï¼šè¿™æ—¶å€™åƒåœ¾æ”¶é›†å™¨å†æ ‡è®°æ‰«æçš„æ—¶å€™å°±ä¼šä¸‹å›¾æˆè¿™æ ·ï¼š æ˜¾ç„¶ï¼ŒCæ˜¯ç™½è‰²çš„ï¼Œä¹Ÿå°±æ˜¯æ¼æ ‡äº†ï¼Œä¼šè¢«å½“æˆåƒåœ¾å›æ”¶æ‰ï¼Œè¿™å¯¹ç¨‹åºæ¥è¯´æ˜¯ä¸å¯ä»¥æ¥å—çš„ã€‚ æ¼æ ‡çš„æƒ…å†µåªä¼šå‘ç”Ÿåœ¨ç™½è‰²å¯¹è±¡ä¸­ï¼Œä¸”æ»¡è¶³ä»¥ä¸‹ä»»æ„ä¸€ä¸ªæ¡ä»¶ï¼š å¹¶å‘æ ‡è®°æ—¶ï¼Œåº”ç”¨çº¿ç¨‹ç»™ä¸€ä¸ªé»‘è‰²å¯¹è±¡çš„å¼•ç”¨ç±»å‹å­—æ®µèµ‹å€¼äº†è¯¥ç™½è‰²å¯¹è±¡ å¹¶å‘æ ‡è®°æ—¶ï¼Œåº”ç”¨çº¿ç¨‹åˆ é™¤æ‰€æœ‰ç°è‰²å¯¹è±¡åˆ°è¯¥ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ äº‹å®ä¸Šï¼Œæ–¹æ³•1æ˜¯CMSçš„å®ç°å…³é”®ï¼Œæ–¹æ³•2æ˜¯G1çš„å®ç°å…³é”®ï¼Œæœ‰å…³å®ç°å°±ç§»æ­¥[JVM]CMSå’Œ[JVM]G1","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"GC","slug":"GC","permalink":"https://htchz.cc/tags/GC/"},{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}]},{"title":"[JVM]å†…å­˜æ¨¡å‹","slug":"JVM-å†…å­˜æ¨¡å‹","date":"2020-03-17T06:28:45.000Z","updated":"2020-06-15T03:57:27.881Z","comments":true,"path":"93872510.html","link":"","permalink":"https://htchz.cc/93872510.html","excerpt":"è¡¥ä¸ªå†…å­˜æ¨¡å‹ç¬”è®°ã€‚","text":"è¡¥ä¸ªå†…å­˜æ¨¡å‹ç¬”è®°ã€‚ JVM å†…å­˜å…±åˆ†ä¸ºè™šæ‹Ÿæœºæ ˆã€å †ã€æ–¹æ³•åŒºï¼ˆjdk8æ˜¯å…ƒç©ºé—´ï¼Œåœ¨jvmä¹‹å¤–ï¼‰ã€PCå¯„å­˜å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰ã€æœ¬åœ°æ–¹æ³•æ ˆäº”ä¸ªéƒ¨åˆ†ã€‚è¿™æ˜¯jdk7çš„å®ç°ï¼Œæ–¹æ³•åŒºå…¶å®å°±æ˜¯æ°¸ä¹…ä»£ã€‚è¿™æ˜¯jdk8çš„å®ç°ï¼Œæ°¸ä¹…ä»£åºŸé™¤ï¼Œå°†ç±»ä¿¡æ¯æ”¾åˆ°æœ¬åœ°å†…å­˜ä¸­ï¼Œä¹Ÿå°±æ˜¯æ”¾åœ¨jvmå¤–ã€‚ 1. è™šæ‹Ÿæœºæ ˆçº¿ç¨‹ç§æœ‰ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªè™šæ‹Ÿæœºæ ˆ ä¸€ä¸ªæ ˆé‡Œæœ‰å¤šä¸ªå¸§ï¼Œæ ˆå¸§åŒ…å«å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ã€‚çº¿ç¨‹è°ƒç”¨æ–¹æ³•æ—¶ä¼šåˆ›å»ºæ ˆå¸§å…¥æ ˆï¼Œç»“æŸæ–¹æ³•æ—¶ä¼šå‡ºæ ˆã€‚ æ ˆæ·±åº¦è¶…è¿‡é™åˆ¶ä¼šStackOverflowErrorï¼Œæ ˆå¸§ç”³è¯·æ—¶å†…å­˜ä¸è¶³ä¼šæŠ¥OutOfMemoryErrorã€‚ 1.1. å±€éƒ¨å˜é‡è¡¨ç”¨äºå­˜æ”¾å±€éƒ¨å˜é‡å’Œæ–¹æ³•å‚æ•°çš„å¼•ç”¨ï¼Œä½¿ç”¨ç´¢å¼•è¿›è¡Œè®¿é—®ã€‚ è¿™ä¸ªè¡¨çš„ç»„æˆå•ä½æ˜¯slotï¼Œ32ä½çš„jvmä¼šä½¿ç”¨32ä½çš„slotï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆlong/doubleåœ¨32jvmä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ è¢«è™šæ‹Ÿæœºæ ˆå¼•ç”¨çš„å¯¹è±¡ï¼Œå±äºGCROOTï¼Œä¸ä¼šå›æ”¶ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•å¾ˆé•¿ï¼Œä½†æ˜¯ä¸€ä¸ªå¤§å¯¹è±¡ä¸å†è¢«ä½¿ç”¨ï¼Œå¯ä»¥è®¾ç½®ä¸ºå°†å¤§å¯¹è±¡çš„å˜é‡èµ‹å€¼ä¸ºnullæ¥å¸®åŠ©gcã€‚ï¼ˆé•¿æ–¹æ³•ä½ å°±è¯¥ä¼˜åŒ–ä¸€ä¸‹äº†ï¼‰ 1.2. æ“ä½œæ•°æ ˆä¹Ÿæ˜¯å­˜æ”¾åŸºæœ¬æ•°æ®ç±»å‹æˆ–å¼•ç”¨çš„ï¼Œåªèƒ½è¿›è¡Œå‡ºæ ˆ/å‹æ ˆï¼Œä½¿ç”¨åœºæ™¯å¦‚å‘èµ·æ–¹æ³•è°ƒç”¨çš„æ—¶å€™æ”¾å‚æ•°ï¼Œç®—æœ¯è¿ç®—çš„ä¸­é—´å€¼ 1.3. åŠ¨æ€é“¾æ¥ä¸€ä¸ªå¼•ç”¨ï¼ŒæŒ‡å‘æ–¹æ³•åŒºçš„æ–¹æ³•ï¼Œç”±äºjavaå¤šæ€ç‰¹æ€§ï¼Œç¼–è¯‘åå¤§å¤šæ•°ä¸èƒ½ç¡®å®šå“ªä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œåªèƒ½åœ¨è¿è¡Œæ—¶æ‰èƒ½å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚ 1.4. æ–¹æ³•è¿”å›å€¼å¦‚æœæ–¹æ³•æ˜¯æ­£å¸¸é€€å‡ºï¼ˆæ²¡æœ‰å¼‚å¸¸ï¼‰ä¸”æœ‰è¿”å›å€¼ï¼Œè°ƒç”¨æ–¹éœ€è¦ä»è¿™é‡Œå–åˆ°è¿”å›å€¼ï¼Œå¹¶åœ¨æ ˆå¸§çš„æ“ä½œæ•°æ ˆè¿›è¡Œå‹æ ˆã€‚ 2. PCå¯„å­˜å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰çº¿ç¨‹ç§æœ‰ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªPCå¯„å­˜å™¨ï¼Œä¹Ÿå«ç¨‹åºè®¡æ•°å™¨ã€‚ PCå¯„å­˜å™¨å­˜æ”¾äº†çº¿ç¨‹å½“å‰æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ï¼Œç”¨äºä¸Šä¸‹æ–‡åˆ‡æ¢åæ¢å¤çº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚ å¦‚æœå½“å‰æ‰§è¡Œçš„æ˜¯nativeæ–¹æ³•ï¼Œé‚£ä¹ˆPCå¯„å­˜å™¨ä¸ºç©ºã€‚ 3. æœ¬åœ°æ–¹æ³•æ ˆçº¿ç¨‹ç§æœ‰ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ ˆã€‚ ç±»ä¼¼äºè™šæ‹Ÿæœºæ ˆï¼Œåªä¸è¿‡è¡¨ç¤ºçš„æ˜¯nativeæ–¹æ³•ã€‚ æ ˆæ·±åº¦è¶…è¿‡é™åˆ¶ä¼šStackOverflowErrorï¼Œæ ˆå¸§ç”³è¯·æ—¶å†…å­˜ä¸è¶³ä¼šæŠ¥OutOfMemoryErrorã€‚ 4. å †çº¿ç¨‹å…±äº«ã€‚GCåŒºåŸŸã€‚ 5. æ–¹æ³•åŒº(å…ƒç©ºé—´)çº¿ç¨‹å…±äº«ã€‚ä¸»è¦ç”¨äºå­˜å‚¨ç±»çš„ä¿¡æ¯ã€å¸¸é‡æ± ã€é™æ€å˜é‡ã€åŠæ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚æ–¹æ³•åŒºé€»è¾‘ä¸Šå±äºå †å†…å­˜ã€‚è¿™å°±ç»™gcå¸¦æ¥äº†è´Ÿæ‹…ï¼Œå› ä¸ºè¿™äº›åŸºæœ¬éƒ½æ˜¯ä¸å˜çš„å¯¹è±¡ã€‚ jdk8å°†è¿™éƒ¨åˆ†æŒªåˆ°å †å¤–å†…å­˜ï¼Œç§°ä¸ºå…ƒç©ºé—´ï¼ˆMetaspaceï¼‰ 5.1. æ–¹æ³•åŒºï¼Œå…ƒç©ºé—´ä¸æ°¸ä¹…ä»£æ–¹æ³•åŒºæ˜¯jvmè§„èŒƒï¼ŒHotspotä»¥å‰ç”¨æ°¸ä¹…ä»£å®ç°ï¼Œæ”¾åœ¨äº†å †å†…å­˜é‡Œã€‚jdk8å®Œå…¨åºŸé™¤äº†æ°¸ä¹…ä»£ï¼Œå°†è¿™äº›æ•°æ®æ”¾åˆ°äº†æœ¬åœ°å†…å­˜ã€‚ ä¸»è¦åŸå› æ˜¯: å¸¸é‡å­˜åœ¨æ°¸ä¹…ä»£ä¸­ï¼Œå®¹æ˜“å‡ºç°æ€§èƒ½é—®é¢˜å’Œå†…å­˜æº¢å‡ºã€‚ ç±»åŠæ–¹æ³•çš„ä¿¡æ¯ç­‰æ¯”è¾ƒéš¾ç¡®å®šå…¶å¤§å°ï¼Œå› æ­¤å¯¹äºæ°¸ä¹…ä»£çš„å¤§å°æŒ‡å®šæ¯”è¾ƒå›°éš¾ï¼Œå¤ªå°å®¹æ˜“å‡ºç°æ°¸ä¹…ä»£æº¢å‡ºï¼Œå¤ªå¤§åˆ™å®¹æ˜“å¯¼è‡´è€å¹´ä»£æº¢å‡ºã€‚æ¯”å¦‚jspç”ŸæˆåŠ¨æ€ç±»ï¼Œè¿™æ˜¯æ¯”è¾ƒéš¾é¢„æµ‹çš„ã€‚ æ°¸ä¹…ä»£ä¼šä¸º GC å¸¦æ¥ä¸å¿…è¦çš„å¤æ‚åº¦ï¼Œå¹¶ä¸”å›æ”¶æ•ˆç‡åä½ï¼Œæ¯•ç«Ÿè¿™äº›ä¸œè¥¿æ˜¯ä¸€ç›´ä¸å˜çš„ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}]},{"title":"[k8s]istioè‡ªåŠ¨æ³¨å…¥å¤±è´¥","slug":"k8s-istioè‡ªåŠ¨æ³¨å…¥å¤±è´¥","date":"2020-02-26T16:05:20.000Z","updated":"2020-02-26T17:25:53.347Z","comments":true,"path":"855478903.html","link":"","permalink":"https://htchz.cc/855478903.html","excerpt":"æŸ¥äº†æˆ‘ä¸€å¤©å–µçš„","text":"æŸ¥äº†æˆ‘ä¸€å¤©å–µçš„ 1. è¿‡ç¨‹istioä¸¤ç§æ³¨å…¥æ¨¡å¼ï¼Œä¸€ç§æ˜¯æ‰§è¡Œistioctl kube-injectå°†ç›®æ ‡deploymentçš„yamlå…ˆä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯æ‰‹åŠ¨æ³¨å…¥sidecarå’ŒinitContainerï¼Œå¦ä¸€ç§å°±æ˜¯åœ¨podè¢«éƒ¨ç½²çš„æ—¶å€™ï¼Œåˆ©ç”¨k8sçš„webhookæœºåˆ¶ï¼Œè¿›è¡Œè‡ªåŠ¨æ³¨å…¥ã€‚ åœ¨è‡ªåŠ¨æ³¨å…¥å‰ï¼Œè¦åœ¨éƒ¨ç½²å®¹å™¨çš„namespaceæ‰“ä¸Šistio-injection: enabledæ ‡ç­¾ï¼Œè¿™æ ·æ‰ä¼šè‡ªåŠ¨æ³¨å…¥ï¼ŒåŒæ—¶ï¼Œè¿˜å¯ä»¥æŒ‡å®štemplateçš„æ³¨è§£:sidecar.istio.io/inject: trueæ¥åšæ›´å°ç²’åº¦çš„æ§åˆ¶ã€‚ åœ¨ä½¿ç”¨bookinfoçš„demoè¿‡ç¨‹ä¸­ï¼Œè‡ªåŠ¨æ³¨å…¥å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œç”šè‡³è¿podéƒ½æ²¡æœ‰createã€‚ æ‰§è¡Œkubectl describe deployment productpageæŸ¥çœ‹å…¶ä¸­ä¸€ä¸ªdeploymentï¼Œå‘ç°åªæœ‰ä¸€ä¸ªäº‹ä»¶ï¼Œ Scaled up replica set productpage-v1-596598f447 to 1ï¼Œç„¶åå°±æ²¡æœ‰ç„¶åäº†ã€‚ æ‰§è¡Œkubectl describe replicaset productpage-v1-596598f447ï¼Œæ˜¾ç¤ºfailed calling webhook â€œsidecar-injector.istio.ioâ€: Post https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s: context deadline exceeded`ï¼Œ æŸ¥çœ‹apiserverçš„æ—¥å¿—ï¼Œä¸€ç›´æç¤º &quot;sidecar-injector.istio.io&quot;: Post https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)æŸ¥çœ‹controller-managerçš„æ—¥å¿—ï¼Œä¸€ç›´æç¤º Event(v1.ObjectReference{Kind:&quot;HorizontalPodAutoscaler&quot;, Namespace:&quot;istio-system&quot;, Name:&quot;istio-telemetry&quot;, UID:&quot;da322eac-127a-4c78-89e6-db614d697949&quot;, APIVersion:&quot;autoscaling/v2beta2&quot;, ResourceVersion:&quot;10847941&quot;, FieldPath:&quot;&quot;}): type: &apos;Warning&apos; reason: &apos;FailedComputeMetricsReplicas&apos; invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: unable to get metrics for resource cpu: no metrics returned from resource metrics APIçœ‹èµ·æ¥æ˜¯åœ¨è¯´æ‰¾ä¸åˆ°metrics apiï¼Ÿ ä¸Šå®˜ç½‘ï¼ŒIstio / Sidecar Injection Problemsæ²¡æœ‰ä¸€ä¸ªæè¿°æ˜¯ç¬¦åˆçš„ã€‚github issueä¹Ÿæ²¡æœ‰æåˆ°è¦å®‰è£…metrics-serverã€‚ æœ€åæ‰¾åˆ°ä¸€ç¯‡åšå®¢ï¼Œé‡Œé¢æåˆ° äºæ˜¯ä¹–ä¹–å®‰è£…metrics-serverï¼Œç„¶åæ³¨å…¥sidecarçš„podå°±æˆåŠŸåˆ›å»ºäº† = = å…¶å®ä¸€æ—©å°±çœ‹åˆ°å…³äºmetrics apiçš„æŠ¥é”™ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºé‚£æ˜¯æ”¶é›†ç›‘æ§æ•°æ®çš„ï¼Œäºæ˜¯æ²¡é¸Ÿä»–ï¼Œè¿˜æ˜¯å›¾æ ·äº†ã€‚ 2. demo","categories":[{"name":"å®¹å™¨","slug":"å®¹å™¨","permalink":"https://htchz.cc/categories/å®¹å™¨/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://htchz.cc/tags/k8s/"},{"name":"istio","slug":"istio","permalink":"https://htchz.cc/tags/istio/"}]},{"title":"[Javaä»£ç†]Springçš„cglibä¸finalæ–¹æ³•çš„å‘","slug":"Javaä»£ç†-springçš„cglibä¸finalæ–¹æ³•çš„å‘","date":"2020-01-12T05:51:39.000Z","updated":"2020-07-01T12:23:51.850Z","comments":true,"path":"4249712641.html","link":"","permalink":"https://htchz.cc/4249712641.html","excerpt":"","text":"1. å‰è¨€cglibæ˜¯é‡‡ç”¨ç”Ÿæˆç›®æ ‡ç±»subclassæ–¹å¼æ¥ä»£ç†ç›®æ ‡ç±»çš„ï¼Œæ‰€ä»¥å¦‚æœç›®æ ‡ç±»çš„æ–¹æ³•æ˜¯finalçš„è¯ï¼Œå°±ä¼šç›´æ¥è°ƒç”¨ç›®æ ‡ç±»çš„æ–¹æ³•ã€‚Springçš„cglibä»£ç†å®ç°æœ‰ç‚¹å‘ï¼Œå°±æ˜¯ç”Ÿæˆçš„ä»£ç†å¯¹è±¡æ˜¯æ²¡æœ‰è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°çš„ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡çš„æˆå‘˜å˜é‡ä¸ä¼šåˆå§‹åŒ–ã€‚ 2. nullSpringçš„aopæ˜¯åŸºäºä»£ç†çš„ï¼Œè€Œé‡‡ç”¨cglibçš„å®ç°ä¸‹ï¼Œå¯¹äºä¸€ä¸ªbeanï¼Œå‡è®¾åªä»£ç†ä¸€æ¬¡çš„æƒ…å†µä¸‹ï¼ˆå¢å¼ºä¸€æ¬¡ï¼‰ï¼Œå†…å­˜å®é™…æ˜¯æœ‰ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä¸€ä¸ªç›®æ ‡å¯¹è±¡ã€‚å½“æˆ‘ä»¬è°ƒç”¨ä»£ç†å¯¹è±¡çš„éfianlæ–¹æ³•ï¼Œä»£ç†å¯¹è±¡è°ƒç”¨å®Œåˆ‡é¢é€»è¾‘ï¼Œä¸æ˜¯è°ƒç”¨è‡ªå·±çˆ¶ç±»æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•ï¼›å¦‚æœè°ƒç”¨ä»£ç†å¯¹è±¡çš„finalæ–¹æ³•ï¼Œä»£ç†å¯¹è±¡ä¼šç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚ çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031public class DefaultRunner implements Runner &#123; protected final Logger log = LoggerFactory.getLogger(getClass()); @Override public final void run(String name) &#123; log.info(\"I'm &#123;&#125;\", name); &#125;&#125;public class CglibProxy implements MethodInterceptor &#123; private Enhancer enhancer = new Enhancer();Â· @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; objects[0] = \"hijacked!\"; return methodProxy.invokeSuper(o, objects); &#125; public Object newProxy(Class klass) &#123; enhancer.setSuperclass(klass); enhancer.setCallback(new CglibProxy()); return enhancer.create(); &#125;&#125;@Testpublic void testCglib() &#123; CglibProxy cglibProxy = new CglibProxy(); DefaultRunner runner = (DefaultRunner) cglibProxy.newProxy(DefaultRunner.class); runner.run(\"proxy\");&#125; å¦‚æœæˆ‘ä»¬è°ƒç”¨ä»£ç†å¯¹è±¡çš„runner.run(&quot;Tony&quot;)ï¼Œæ—¥å¿—è¾“å‡ºçš„å°†ä¼šæ˜¯â€œIâ€™m Tonyâ€è€Œä¸æ˜¯â€œIâ€™m hijacked!â€ã€‚ è€ŒSpringä½¿ç”¨org.springframework.aop.framework.CglibAopProxyå¯¹ç›®æ ‡å¯¹è±¡è¿›è¡Œä»£ç†ï¼Œæˆ‘çš„ç¨‹åºåœ¨è°ƒç”¨ä¸€ä¸ªfianlæ–¹æ³•çš„æ—¶å€™ï¼ŒæŠ¥äº†ä¸€ä¸ªNPEå¼‚å¸¸ï¼Œdebugè¿›å»ä¸€çœ‹ï¼Œæˆå‘˜å˜é‡loggerå±…ç„¶æ˜¯nullã€‚äº‹å®ä¸Šï¼ŒSpringçš„CglibAopProxyç”Ÿæˆçš„ä»£ç†å¯¹è±¡çš„æˆå‘˜å˜é‡éƒ½æ˜¯nullï¼Œå› ä¸ºä»Springè®¾è®¡ä¸Šï¼Œä»£ç†ç±»åªè´Ÿè´£å¢å¼ºé€»è¾‘ï¼Œç„¶åå†è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰åˆå§‹åŒ–æˆå‘˜å˜é‡çš„å¿…è¦ã€‚ å®é™…ä¸Šæˆ‘ä¹Ÿä¸éœ€è¦è¿™ä¸ªå¯¹è±¡è¢«ä»£ç†ã€‚ã€‚æ‰‹åŠ¨newä¸€ä¸ªå¯¹è±¡å°±æ­£å¸¸äº†ã€‚ 3. ä¸ºä»€ä¹ˆæ²¡æœ‰åˆå§‹åŒ–æˆå‘˜å˜é‡ï¼Ÿæˆ‘ä»¬åœ¨åå°„ç”Ÿæˆä»£ç†å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æ„é€ æ–¹æ³•ã€‚å¦‚æœå­ç±»æ— å‚æ„é€ å‡½æ•°æ²¡æœ‰å†™super()ï¼Œç¼–è¯‘çš„æ—¶å€™ï¼Œæ˜¯ä¼šå†™è¿›ä¸€å¥super()çš„ã€‚ ä½†æ˜¯ç”±äºæ˜¯ä»£ç†ç±»æ˜¯ç”¨å­èŠ‚ç ç”Ÿæˆçš„ï¼Œæ‰€ä»¥ä»£ç†ç±»æ„é€ å‡½æ•°æ˜¯æ²¡æœ‰è°ƒç”¨super()çš„ï¼Œæ•…æ²¡æœ‰åˆå§‹åŒ–æˆå‘˜å˜é‡ã€‚ 4. å‚è€ƒ Spring AOPé¿å‘æŒ‡å—","categories":[{"name":"Proxy","slug":"Proxy","permalink":"https://htchz.cc/categories/Proxy/"}],"tags":[{"name":"AOP","slug":"AOP","permalink":"https://htchz.cc/tags/AOP/"},{"name":"BUG","slug":"BUG","permalink":"https://htchz.cc/tags/BUG/"}]},{"title":"[Mysql]Innodbçš„å¿«ç…§è¯»å®ç°","slug":"Mysql-Innodbçš„å¿«ç…§è¯»å®ç°","date":"2019-12-11T14:08:30.000Z","updated":"2020-06-05T09:01:20.519Z","comments":true,"path":"3647734067.html","link":"","permalink":"https://htchz.cc/3647734067.html","excerpt":"","text":"1. å‰è¨€æœ‰ä¸€æ¬¡é¢è¯•ï¼Œé¢è¯•å®˜é—®æˆ‘ï¼šmysqläº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼Ÿæˆ‘ï¼šbalabalaâ€¦â€¦é¢è¯•å®˜é—®ï¼šé‚£å¯é‡å¤è¯»æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿæˆ‘ï¼šemmã€‚ã€‚ç¬¬ä¸€æ¬¡è¯»ä¼šæœ‰å¿«ç…§ã€‚ã€‚é¢è¯•å®˜ï¼šå—¯ã€‚ã€‚æˆ‘ï¼šã€‚ã€‚ã€‚ ç„¶åå‘¢ï¼Œç„¶åå°±ä¸çŸ¥é“å•¦ã€‚ äº‹å®ä¸Šï¼ŒInnodbçš„RCå’ŒRRéš”ç¦»çº§åˆ«ä¸‹ï¼Œè¯»æœ‰å¿«ç…§è¯»ï¼ˆsnapshot readï¼‰å’Œå½“å‰è¯»ï¼ˆcurrent readï¼‰ä¹‹åˆ†ï¼Œå½“å‰è¯»å°±æ˜¯SELECT ... LOCK IN SHARE MODEå’ŒSELECT ... FOR UPDATEï¼Œå¿«ç…§è¯»å°±æ˜¯æ™®é€šçš„SELECTæ“ä½œã€‚ å¿«ç…§è¯»çš„å®ç°ï¼Œåˆ©ç”¨äº†undo logå’Œread viewã€‚ å¿«ç…§è¯»ä¸æ˜¯åœ¨è¯»çš„æ—¶å€™ç”Ÿæˆå¿«ç…§ï¼Œè€Œæ˜¯åœ¨å†™çš„æ—¶å€™ä¿ç•™äº†å¿«ç…§ã€‚ å¿«ç…§è¯»å®ç°äº†Multi-Version Concurrent Controlï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ï¼Œç®€ç§°MVCCï¼ŒæŒ‡å¯¹äºåŒä¸€ä¸ªè®°å½•ï¼Œä¸åŒçš„äº‹åŠ¡ä¼šæœ‰ä¸åŒçš„ç‰ˆæœ¬ï¼Œä¸åŒç‰ˆæœ¬äº’ä¸å½±å“ï¼Œæœ€åäº‹åŠ¡æäº¤æ—¶æ ¹æ®ç‰ˆæœ¬å…ˆåç¡®å®šèƒ½å¦æäº¤ã€‚ ä½†æ˜¯ï¼ŒInnodbçš„è¯»å†™äº‹åŠ¡ä¼šåŠ æ’ä»–é”ï¼Œä¸åŒç‰ˆæœ¬å…¶å®æ˜¯ä¸²è¡Œçš„ï¼Œæ‰€ä»¥é¦–å…ˆè¦æŒ‡å‡ºçš„æ˜¯ï¼ŒInnodbäº‹åŠ¡å¿«ç…§è¯»ä¸æ˜¯ä¸¥æ ¼çš„MVCCå®ç°ã€‚ 2. å®ç°2.1. éšè—å­—æ®µInnodbæ¯ä¸€è¡Œéƒ½æœ‰ä¸‰ä¸ªéšè—å­—æ®µï¼Œåˆ†åˆ«æ˜¯DB_ROW_IDã€DB_TRX_IDã€DB_ROLL_PTRã€‚ DB_ROW_IDï¼šå¦‚æœè¡¨æ²¡æœ‰è®¾ç½®ä¸»é”®ï¼Œç”¨æ¥ä½œä¸ºè®°å½•çš„ä¸»é”®ï¼Œå› ä¸ºInnodbä½¿ç”¨èšç°‡ç´¢å¼•çš„æ–¹å¼å­˜å‚¨ï¼Œè®°å½•å¿…é¡»æœ‰ä¸»é”®ã€‚DB_TRX_IDï¼šè®°å½•ä¿®æ”¹è¿™è¡Œè®°å½•äº‹åŠ¡çš„idã€‚DB_ROLL_PTRï¼šæŒ‡å‘è¿™è¡Œè®°å½•çš„å‰ä¸€ä¸ªç‰ˆæœ¬ã€‚ 2.2. undo logå¤šç‰ˆæœ¬å…¶å®æ˜¯ç”¨undo logæ¥å®ç°çš„ï¼Œundo logå¬èµ·æ¥æ˜¯åšå›æ»šä½¿ç”¨çš„ï¼Œæ²¡é”™ï¼Œä½†æ˜¯äº‹åŠ¡æäº¤åundo logå¯ä¸ä¼šç«‹åˆ»æ¸…é™¤ï¼Œå®ƒä½œä¸ºå†å²ç‰ˆæœ¬å­˜åœ¨ç€ã€‚åªæœ‰å½“å‰æ²¡æœ‰äº‹åŠ¡ä¾èµ–åœ¨è¿™è¡Œè®°å½•ä¸Šæ—¶ï¼Œmysqlçš„æ¸…ç†çº¿ç¨‹æ‰ä¼šæ¸…ç†æ‰æ— ç”¨çš„undo logã€‚ insertæ“ä½œçš„undo logåœ¨äº‹åŠ¡å›æ»šæˆ–æäº¤åå°±ä¼šåˆ é™¤ï¼Œå› ä¸ºåªæœ‰å›æ»šä¼šç”¨åˆ°ã€‚updateã€deleteçš„undo logéœ€è¦ä¿ç•™ï¼ˆå¯è§deleteåªæ˜¯é€»è¾‘åˆ é™¤ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸ªupdateæ“ä½œï¼Œé€»è¾‘åˆ é™¤åç”±åå°çº¿ç¨‹æ¸…ç†ï¼‰ã€‚ ä¸‹é¢å‡è®¾æœ‰ä¸€æ¡è®°å½•å¦‚ä¸‹ï¼Œcolumn_1ã€column_2åˆå§‹å€¼ä¸º1å’Œ2ã€‚å‡è®¾è¿™æ—¶æœ‰ä¸ªä¸‰ä¸ªäº‹åŠ¡ABCï¼ŒA,Cäº‹åŠ¡å¼€å§‹ï¼Œå¯¹è¿™æ¡è®°å½•çš„æŸ¥è¯¢ç»“æœå¦‚ä¸‹ï¼š column_1 column_2 1 2 æ¥ç€Aäº‹åŠ¡æ‰§è¡Œæ›´æ–°column_1ä¸º11ï¼›å…·ä½“è¿‡ç¨‹æ˜¯ï¼šç»™è®°å½•åŠ Xé”ï¼Œå¤åˆ¶è®°å½•ä¸ºundo_log_1ï¼Œç„¶åå†å°†è®°å½•çš„column_1æ”¹ä¸º11ï¼ŒDB_TRX_IDä¸ºAï¼ŒDB_ROLL_PTRæŒ‡å‘å‰ä¸€ä¸ªç‰ˆæœ¬ã€‚ è™½ç„¶æ•°æ®è¡Œå’Œundo logç”»çš„ä¸€æ ·ï¼Œä½†å®é™…undo logæœ‰è‡ªå·±çš„æ•°æ®ç»“æ„ã€‚ Aäº‹åŠ¡æäº¤ï¼Œé‡Šæ”¾Xé”ã€‚ æ¥ç€Bå¼€å¯äº‹åŠ¡ï¼Œæ‰§è¡Œæ›´æ–°column_2ä¸º22ï¼›å…·ä½“è¿‡ç¨‹æ˜¯ï¼šç»™è®°å½•åŠ Xé”ï¼Œå¤åˆ¶Aäº‹åŠ¡æ›´æ–°å®Œçš„è®°å½•ä¸ºundo_log_2ï¼Œç„¶åå†å°†è®°å½•çš„column_2æ”¹ä¸º22ï¼ŒDB_TRX_IDä¸ºBï¼ŒDB_ROLL_PTRæŒ‡å‘å‰ä¸€ä¸ªç‰ˆæœ¬ã€‚ç„¶åBäº‹åŠ¡æäº¤ã€‚ æ³¨æ„ï¼ï¼å¦‚æœAäº‹åŠ¡æ²¡æœ‰æäº¤ï¼ŒXé”æ˜¯ä¸ä¼šé‡Šæ”¾çš„ï¼Œé‚£ä¹ˆBäº‹åŠ¡å¯¹è¿™è¡Œè®°å½•æ‰§è¡Œupdateä¸ºäº†è·å–Xé”ä¼šé˜»å¡ä½çš„ï¼Œè€ŒMVCCæ ‡å‡†å„ä¸ªç‰ˆæœ¬åº”è¯¥æ˜¯ä¸ä¼šç›¸äº’å½±å“çš„ï¼Œæ‰€ä»¥è¯´Innodbäº‹åŠ¡å¿«ç…§è¯»ä¸æ˜¯ä¸¥æ ¼çš„MVCCå®ç°ã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒCäº‹åŠ¡è¿™æ—¶æ‰§è¡Œç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ŒæŸ¥è¯¢ç»“æœä¼šæ˜¯ä»€ä¹ˆå‘¢ã€‚ 2.3. read viewå…‰æœ‰å¤šç‰ˆæœ¬è¿˜ä¸å¤Ÿï¼Œéœ€è¦ä¸€ä¸ªæœºåˆ¶å¯¹undo logè¿›è¡Œå¯è§æ€§åˆ¤æ–­ï¼Œå†³å®šå½“å‰äº‹åŠ¡è¯»åˆ°çš„æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸ªæœºåˆ¶å°±æ˜¯é€šè¿‡read viewå®Œæˆï¼Œ read viewæ˜¯å¯¹å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„æ‰€æœ‰äº‹åŠ¡åˆ—è¡¨çš„å°è£…ï¼Œæ³¨æ„æ˜¯æ‰€æœ‰äº‹åŠ¡ï¼Œè€Œä¸æ˜¯ä½œç”¨äºç›®æ ‡è¡Œçš„äº‹åŠ¡ã€‚ read viewæœ€æ—©çš„äº‹åŠ¡idè®°ä¸ºup_limit_idï¼Œæœ€è¿Ÿçš„äº‹åŠ¡idè®°ä¸ºlow_limit_idï¼ˆlow_limit_id = æœªå¼€å¯çš„äº‹åŠ¡id = å½“å‰æœ€å¤§äº‹åŠ¡id+1ï¼‰ï¼Œæ´»è·ƒäº‹åŠ¡idåˆ—è¡¨è®°ä¸ºdescriptorsã€‚ RCå’ŒRRçš„åŒºåˆ«å°±æ˜¯ï¼ŒRRåœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢ä¼šåˆ›å»ºæ–°çš„read viewï¼ŒRCæ˜¯æ¯æ¬¡æŸ¥è¯¢éƒ½åˆ›å»ºread viewã€‚ å¦‚æœè®°å½•ä¸Šçš„trx_idå°äºread_view_t-&gt;up_limit_idï¼Œåˆ™è¯´æ˜è¿™æ¡è®°å½•çš„æœ€åä¿®æ”¹åœ¨readviewåˆ›å»ºä¹‹å‰ï¼Œå› æ­¤è¿™æ¡è®°å½•å¯ä»¥è¢«çœ‹è§ã€‚ å¦‚æœè®°å½•ä¸Šçš„trx_idå¤§äºç­‰äºread_view_t-&gt;low_limit_idï¼Œåˆ™è¯´æ˜è¿™æ¡è®°å½•çš„æœ€åä¿®æ”¹åœ¨readviewåˆ›å»ºä¹‹åï¼Œå› æ­¤è¿™æ¡è®°å½•è‚¯å®šä¸å¯ä»¥è¢«çœ‹è§ã€‚ å¦‚æœè®°å½•ä¸Šçš„trx_idåœ¨up_limit_idå’Œlow_limit_idä¹‹é—´ï¼Œä¸”trx_idåœ¨read_view_t-&gt;descriptorsä¹‹ä¸­ï¼Œåˆ™è¡¨ç¤ºè¿™æ¡è®°å½•çš„æœ€åä¿®æ”¹æ˜¯åœ¨readviewåˆ›å»ºä¹‹åï¼Œè¢«å¦å¤–ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡æ‰€ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™æ¡è®°å½•ä¹Ÿä¸å¯ä»¥è¢«çœ‹è§ã€‚å¦‚æœtrx_idä¸åœ¨read_view_t-&gt;descriptorsä¹‹ä¸­ï¼Œåˆ™è¡¨ç¤ºè¿™æ¡è®°å½•çš„æœ€åä¿®æ”¹åœ¨readviewåˆ›å»ºä¹‹å‰ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°ã€‚ åŸºäºä¸Šè¿°åˆ¤æ–­ï¼Œå¦‚æœè®°å½•ä¸å¯è§ï¼Œåˆ™å°è¯•ä½¿ç”¨undoå»æ„å»ºè€çš„ç‰ˆæœ¬(row_vers_build_for_consistent_read)ï¼Œç›´åˆ°æ‰¾åˆ°å¯ä»¥è¢«çœ‹è§çš„è®°å½•æˆ–è€…è§£æå®Œæ‰€æœ‰çš„undoã€‚ ä¸Šä¸€èŠ‚é‡Œï¼Œå‡è®¾äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯RRï¼Œäº‹åŠ¡idå¤§å°é¡ºåºæ˜¯ï¼šX &lt; C &lt; A &lt; B &lt; D(Dæ˜¯æœªå¼€å¯çš„äº‹åŠ¡Id)ï¼Œäº‹åŠ¡éƒ½æ˜¯è¯»å†™äº‹åŠ¡ï¼ˆåªè¯»äº‹åŠ¡ä¸ä¼šåŠ å…¥read viewï¼‰ é‚£ä¹ˆCäº‹åŠ¡ç¬¬ä¸€æ¬¡æŸ¥è¯¢åˆ›å»ºä¸€ä¸ªread viewï¼Œup_limit_idä¸ºCï¼Œlow_limit_idä¸ºBï¼Œdescriptorsä¸º{Cï¼ŒA}ï¼Œè¿™æ—¶è®°å½•çš„DB_TRX_IDæ˜¯Xï¼ŒA &gt; Xï¼Œè¯´æ˜è®°å½•å¯è§ã€‚ å½“Aäº‹åŠ¡æ›´æ–°å®Œæ¯•Bäº‹åŠ¡æ›´æ–°å®Œæ¯•åï¼ŒCäº‹åŠ¡æ‰§è¡Œç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œread viewè¿˜æ˜¯æœ€å¼€å§‹çš„é‚£ä¸ªï¼Œæ­¤æ—¶è®°å½•çš„DB_TRX_IDæ˜¯Bï¼Œ&gt;= low_limit_idï¼Œ å› æ­¤è¿™æ¡è®°å½•è‚¯å®šä¸å¯ä»¥è¢«çœ‹è§ï¼Œéœ€è¦æ²¿ç€å†å²ç‰ˆæœ¬æ‰¾ã€‚ è®°å½•çš„å‰ä¸€ä¸ªç‰ˆæœ¬çš„DB_TRX_IDæ˜¯Aï¼Œåœ¨up_limit_idå’Œlow_limit_idä¹‹é—´, ä¸”åœ¨descriptorsä¹‹é—´ï¼Œæ‰€ä»¥æ­¤ç‰ˆæœ¬è¿˜æ˜¯ä¸å¯ä»¥è¢«çœ‹è§ï¼Œç»§ç»­å¾€å†å²ç‰ˆæœ¬æ‰¾ã€‚ å‰ä¸€ä¸ªç‰ˆæœ¬çš„DB_TRX_IDæ˜¯Xï¼Œ&lt; up_limit_id, æ‰€ä»¥è¯¥ç‰ˆæœ¬å¯è§ï¼Œæ‰€ä»¥Cäº‹åŠ¡ç¬¬äºŒæ¬¡æŸ¥è¯¢ç»“æœä¾æ—§æ˜¯ï¼š column_1 column_2 1 2 è¿™å°±åšåˆ°äº†å¯é‡å¤è¯»ã€‚ å¦‚æœæ˜¯RCå‘¢ï¼Ÿ Cäº‹åŠ¡æ‰§è¡Œç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œåˆ›å»ºæ–°çš„read viewï¼Œup_limit_idä¸ºCï¼Œlow_limit_idä¸ºDï¼Œdescriptorsä¸º{C}ï¼Œæ­¤æ—¶è®°å½•çš„DB_TRX_IDæ˜¯Bï¼Œåœ¨up_limit_idå’Œlow_limit_idä¹‹é—´ï¼Œä½†æ˜¯ä¸åœ¨åœ¨descriptorsä¹‹ä¸­ï¼Œæ‰€ä»¥è®°å½•æ˜¯å¯è§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Cäº‹åŠ¡å¯ä»¥è¯»åˆ°Bäº‹åŠ¡æäº¤çš„ç»“æœï¼Œè¿™å°±æ˜¯RCå¿«ç…§è¯»çš„å®ç°ã€‚ 2.4. å¹»è¯»RRçº§åˆ«ä¸‹ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œï¼Œå¦‚æœå…¨ç¨‹åªè¿›è¡Œå¿«ç…§è¯»æ“ä½œï¼Œé‚£ä¹ˆæ˜¯ä¸ä¼šå‘ç”Ÿå¹»è¯»çš„ï¼Œä¹Ÿä¸ä¼šåŠ é”ï¼›å¦‚æœäº‹åŠ¡è¿›è¡Œå¿«ç…§è¯»åˆè¿›è¡Œäº†å†™æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿå¹»è¯»ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼šRRçš„å¹»è¯»åªå‘ç”Ÿåœ¨å†™æ“ä½œä¸­ å¯ä»¥ç”¨å½“å‰è¯»è§£å†³å¹»è¯»ã€‚ 2.5. èšç°‡ç´¢å¼•èšç°‡ç´¢å¼•åœ¨æ›´æ–°ä¸»é”®çš„æ—¶å€™ï¼Œä¼šåˆ æ‰æ—§è®°å½•ï¼Œæ’å…¥å¸¦æœ‰æ–°ä¸»é”®çš„è®°å½•ã€‚ 2.6. äºŒçº§ç´¢å¼•äºŒçº§ç´¢å¼•æ˜¯æ²¡æœ‰éšè—å­—æ®µçš„ï¼Œæ‰€ä»¥æ²¡æœ‰undo logï¼Œåªæœ‰ä¸€ä¸ªæ ‡å¿—ä½ã€‚ å¦‚æœä¸€ä¸ªupdateè¯­å¥æ›´æ–°åˆ°äº†äºŒçº§ç´¢å¼•ï¼Œæ—§äºŒçº§ç´¢å¼•delete_markç½®1ï¼Œæ’å…¥æ–°äºŒçº§ç´¢å¼•ã€‚æŸ¥è¯¢çš„æ—¶å€™ï¼Œè¦åˆ¤æ–­å¯è§æ€§æ€ä¹ˆåŠï¼Ÿæ ¹æ®äºŒçº§ç´¢å¼•æ‰¾åˆ°èšç°‡ç´¢å¼•ï¼ˆæ— è§†delete_markï¼‰ï¼Œå†ä»èšç°‡ç´¢å¼•å¼€å§‹å¯è§æ€§åˆ¤æ–­ï¼Œæ‰¾åˆ°å¯è§è®°å½•ï¼Œå¦‚æœå¯è§è®°å½•å’ŒäºŒçº§ç´¢å¼•ç»´æŠ¤çš„ç»“æœä¸€è‡´ï¼ˆç´¢å¼•å€¼å’Œä¸»é”®å€¼ä¸€æ ·ï¼‰ï¼Œå°±è¿”å›è®°å½•ï¼Œå¦åˆ™è¿”å›ç©ºã€‚ è¿™æ ·æ•ˆç‡æ¯”è¾ƒä½ï¼Œæ¯”å¦‚studentè¡¨é‡Œageæ˜¯äºŒçº§ç´¢å¼•ï¼ŒæŸ¥è¯¢æ¡ä»¶æ˜¯age=10ï¼Œæ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„age-&gt;student_idçš„äºŒçº§ç´¢å¼•ä¼šæœ‰å¤šä¸ªï¼Œäº‹åŠ¡äº‹åŠ¡éœ€è¦éå†æ‰€æœ‰age=10çš„ç´¢å¼•è¿›è¡Œå¯è§æ€§åˆ¤æ–­æ‰èƒ½æ‹¿åˆ°æ—§å€¼ã€‚ äºæ˜¯innodbç»™äºŒçº§ç´¢å¼•åŠ äº†ä¸ªMAX_TRX_IDè®°å½•æœ€åæ›´æ–°äºŒçº§ç´¢å¼•çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰äº‹åŠ¡read_viewçš„ up_limit_id &gt; MAX_TRX_IDï¼Œè¯´æ˜åœ¨åˆ›å»ºread_viewæ—¶æœ€åä¸€æ¬¡æ›´æ–°äºŒçº§ç´¢å¼•çš„äº‹åŠ¡å·²ç»ç»“æŸï¼Œå°±å¯ä»¥æ— è§†delete_mark=1çš„äºŒçº§ç´¢å¼•ã€‚å¦‚æœMAX_TRX_IDå¤±æ•ˆï¼Œä¾æ—§è¦éå†æ‰€æœ‰age=10çš„äºŒçº§ç´¢å¼•ã€‚ 2.7. é¢˜å¤–è¯åœ¨InnoDBé‡Œé¢æœ‰ä¸¤ç§äº‹åŠ¡æ¨¡å¼ï¼Œä¸€ç§æ˜¯è¯»å†™äº‹åŠ¡ï¼Œå°±æ˜¯ä¼šå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„äº‹åŠ¡ï¼Œå¦å¤–ä¸€ç§æ˜¯åªè¯»äº‹åŠ¡ï¼Œä»…ä»…å¯¹æ•°æ®è¿›è¡Œè¯»å–ã€‚å¼€å¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡è¦åšçš„äº‹æ¯”å¼€å¯ä¸€ä¸ªåªè¯»äº‹åŠ¡å¤šè®¸å¤šï¼Œéœ€è¦åˆ†é…å›æ»šæ®µæ¥è®°å½•undo logï¼Œéœ€è¦æŠŠè¯»å†™äº‹åŠ¡åŠ å…¥åˆ°å…¨å±€è¯»å†™äº‹åŠ¡é“¾è¡¨ï¼ŒæŠŠäº‹åŠ¡idåŠ å…¥æ´»è·ƒè¯»å†™äº‹åŠ¡æ•°ç»„ä¸­ï¼Œæ‰€ä»¥ä½ çš„äº‹åŠ¡æ²¡æœ‰å†™æ“ä½œçš„è¯ï¼Œå£°æ˜ä¸ºåªè¯»äº‹åŠ¡æ˜¯ä¸ªä¸é”™çš„ä¼˜åŒ–ã€‚ 5.6 å¦‚æœè¦å¼€å§‹åªè¯»äº‹åŠ¡ï¼Œéœ€è¦æ˜¾å¼æŒ‡æ˜äº‹åŠ¡æ¨¡å¼ä¸ºåªè¯»ï¼› 5.7å¦‚æœä¸æŒ‡æ˜äº‹åŠ¡æ¨¡å¼ï¼Œmysqlä¼šåˆå§‹åŒ–ä¸ºåªè¯»äº‹åŠ¡ï¼Œå¦‚æœå‘ç”Ÿå†™æ“ä½œï¼Œå†å°†äº‹åŠ¡æå‡ä¸ºè¯»å†™äº‹åŠ¡ï¼Œåˆ†é…å›æ»šæ®µï¼Œåˆ†é…äº‹åŠ¡idï¼ˆåªè¯»äº‹åŠ¡ä¹Ÿæœ‰idå•¦ï¼‰ï¼ŒåŠ å…¥è¯»å†™äº‹åŠ¡é“¾è¡¨ã€‚5.7å¦‚æœä¸€æ¬¡read viewä½¿ç”¨å®Œåï¼Œæ²¡æœ‰æ–°çš„è¯»å†™äº‹åŠ¡åˆ›å»ºï¼Œé‚£ä¹ˆå¯ä»¥ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡å¤ç”¨ã€‚ è¿˜æœ‰æ€§èƒ½ï¼Œç”±äºè¯»æ˜¯ä¸åŠ é”çš„ï¼ŒRRä¼¼ä¹æ¯”RCå¼€é”€å°ï¼Œé‚£æ˜¯ä¸æ˜¯RRçš„æ€§èƒ½æ¯”RCå¥½ï¼Ÿäº‹å®æ˜¯ä¸ä¸€å®šçš„ï¼Œåœ¨å†™çš„æ—¶å€™ï¼ŒRRä¸ºäº†é˜²æ­¢å¹»è¯»ï¼ŒåŠ å…¥äº†gapå’Œnext-keyé”ï¼Œè¿™é€šå¸¸æ˜¯RRä¼šé€ æˆæ­»é”ï¼Œå¯¼è‡´RRæ¯”RCå·®çš„åŸå› ã€‚ 3. åè®°åœ¨è¿™ä¹‹å‰ï¼Œä¸æ˜ç™½ä¸ºä»€ä¹ˆäº‹åŠ¡å¯ä»¥ä¸´æ—¶æŒ‡å®šéš”ç¦»çº§åˆ«ï¼Œä¸´æ—¶æŒ‡å®šä¸éœ€è¦å…¶ä»–äº‹åŠ¡é…åˆä¹ˆï¼Œç°åœ¨åº”è¯¥æ‡‚äº†ğŸ˜ï¼Œä¸è¿‡äº‹åŠ¡è¿˜æœ‰å¥½å¤šä¸æ‡‚ğŸ˜ 4. å‚è€ƒ ã€ŠMySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB äº‹åŠ¡ç³»ç»Ÿã€‹ ã€ŠMySQL InnoDB MVCCæ·±åº¦åˆ†æã€‹","categories":[{"name":"Mysql","slug":"Mysql","permalink":"https://htchz.cc/categories/Mysql/"}],"tags":[{"name":"äº‹åŠ¡","slug":"äº‹åŠ¡","permalink":"https://htchz.cc/tags/äº‹åŠ¡/"}]},{"title":"[Redis]ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹","slug":"Redis -ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹","date":"2019-12-03T01:01:33.000Z","updated":"2020-07-14T07:09:34.390Z","comments":true,"path":"1473130276.html","link":"","permalink":"https://htchz.cc/1473130276.html","excerpt":"","text":"1. å‰è¨€ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹ç¬¬äºŒç‰ˆåŸºäºredis3.0ï¼Œç°åœ¨6.0éƒ½å¿«å‡ºäº†ã€‚ç°åœ¨rediså’Œä¹¦é‡Œæœ‰äº›å†…å®¹å·²ç»ä¸ä¸€è‡´äº†ï¼Œä¸è¿‡ç”¨æ¥æ¢ç´¢redisæ˜¯æŒºå¥½çš„ã€‚ 2. ç¢ç¢å¿µ2.1. ç¼–ç ç°åœ¨çš„rediså·²ç»å¢åŠ äº†quicklistã€streamç¼–ç ã€‚ quicklistæ˜¯ziplistå’Œlinkedlistçš„æ•´åˆï¼Œä½œä¸ºlistçš„å”¯ä¸€ç¼–ç ï¼Œå…¶æ€æƒ³å°±æ˜¯å°†zipliståˆ†æ®µï¼Œziplistå†…å­˜ç¢ç‰‡å°‘ä½†æ¯æ¬¡æ“ä½œéƒ½è¦ç”³è¯·å†…å­˜ï¼Œå°†zipliståˆ†æ®µï¼Œå¹¶ç”¨æ“ä½œæ€§èƒ½æ¯”è¾ƒå¥½çš„åŒå‘é“¾è¡¨æŠŠæ®µä¸²èµ·æ¥ï¼Œè¿™ç®—æ˜¯æ—¶é—´ä¸ç©ºé—´çš„æŠ˜ä¸­ã€‚ streamç¼–ç ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ²¡æœ‰å»äº†è§£ã€‚ 2.2. å­—å…¸å­—å…¸expand/resizeæ˜¯redisçš„ä¸€ä¸ªå¤§è¯é¢˜ã€‚ å­—å…¸æ‰§è¡ŒBGSAVEæˆ–BGREWRITEAOFæ—¶è´Ÿè½½å› å­å¿…é¡»è¾¾åˆ°5æ‰èƒ½è¿›è¡Œæ‰©å®¹ï¼Œæ‰§è¡ŒBGSAVEæˆ–BGREWRITEAOFæ—¶ä¸èƒ½è¿›è¡Œç¼©å®¹ã€‚ ä¹‹æ‰€ä»¥ï¼Œæ˜¯å› ä¸ºBGSAVEæˆ–BGREWRITEAOFä½¿ç”¨äº†copy-on-writeï¼Œä¹Ÿå°±æ˜¯å†™æ—¶å¤åˆ¶ã€‚æ‰§è¡ŒBGSAVEæˆ–BGREWRITEAOFæ—¶redisä¼šforkå­è¿›ç¨‹ï¼Œè¿™æ—¶å€™å¦‚æœè¿›è¡Œä¸€ä¸ªå†…å­˜çš„æ‹·è´ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰ï¼Œé‚£ä¹ˆå†…å­˜çš„æµªè´¹æ˜¯å¾ˆå¤§çš„ã€‚ä½¿ç”¨å†™æ—¶å¤åˆ¶ï¼Œä¼šå°†çˆ¶è¿›ç¨‹çš„å†…å­˜è®¾ç½®ä¸ºåªè¯»ï¼Œå°†å†…å­˜å’Œå­è¿›ç¨‹å…±äº«ï¼Œç”±äºå†…å­˜æ˜¯åˆ†é¡µæœºåˆ¶ï¼Œå½“æŸä¸€é¡µå†…å­˜è¦å‘ç”Ÿå†™æ“ä½œæ—¶ï¼Œä¼šå‘ç”Ÿä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠè¿™ä¸€é¡µå†…å­˜å¤åˆ¶å‡ºæ¥è¿›è¡Œä¿®æ”¹ã€‚ å› æ­¤ï¼Œä¸ºäº†å‡å°‘å†™æ“ä½œå¯¼è‡´å†…å­˜é¡µå¤åˆ¶ï¼Œredisæ‰æœ‰äº†åœ¨ä¸Šé¢çš„ç­–ç•¥ã€‚ 2.3. ä¸‹ä¸ª2çš„å¹‚redisåœ¨expand/resizeéƒ½å°†æ–°æ•°ç»„çš„é•¿åº¦è®¾ç½®ä¸º2çš„å¹‚ï¼Œè¿™æ˜¯å› ä¸ºæŠŠæ•°ç»„é•¿åº¦è®¾ç½®ä¸º2çš„å¹‚ï¼Œå°±å¯ä»¥æŠŠå–æ¨¡è¿ç®—è½¬åŒ–ä¸ºä½è¿ç®—ï¼Œjavaé‡Œä¹Ÿæ˜¯è¿™ä¹ˆåšã€‚ redisä½œè€…ä½¿ç”¨äº†è¿™ä¹ˆä¸€ä¸ªç®—æ³•æ¥æ±‚ç»™å®šä¸€ä¸ªæ•°çš„ä¸‹ä¸ª2çš„å¹‚ 123456789101112/* Our hash table capability is a power of two */static unsigned long _dictNextPower(unsigned long size)&#123; unsigned long i = DICT_HT_INITIAL_SIZE; if (size &gt;= LONG_MAX) return LONG_MAX + 1LU; while(1) &#123; if (i &gt;= size) return i; i *= 2; &#125;&#125; å¾ˆç®€å•çš„å¾ªç¯ï¼Œä¸è¿‡æœ‰äººç»™ä»–æå‡ºå¯ä»¥ç”¨ä½è¿ç®—ï¼šä¼ é€é—¨ï¼Œjavaé‡Œç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªç®—æ³•ï¼ŒHashMapçš„tableSizeFor()ã€‚ ä½œè€…è¯´ä¸é”™ï¼Œä½†æ˜¯æ²¡å¿…è¦ï¼Œè¿™ç§ä½è¿ç®—çš„é­”æ³•å¯¹ç°å®æ¥è¯´éƒ½æ˜¯å‡çš„ï¼Œåªä¼šæŠŠä»£ç æå¤æ‚ğŸ˜® 2.4. EMBSTRä¹¦é‡Œçš„REDIS_ENCODING_EMBSTRæ”¯æŒæœ€å¤§é•¿åº¦39å­—èŠ‚ï¼Œè€Œç°åœ¨æœ€å¤§æ”¯æŒ44å­—èŠ‚ï¼ŒåŸå› æ˜¯3.2ç‰ˆæœ¬ä¹‹åsdshdrå˜äº†ã€‚REDIS_ENCODING_EMBSTRä½¿ç”¨sdshdr8æ¥è¡¨ç¤ºï¼ŒåŸæ¥çš„sdshdréœ€è¦8å­—èŠ‚ï¼Œç°åœ¨ä½¿ç”¨sdshdr8åªéœ€è¦ä¸‰å­—èŠ‚ï¼Œé‚£ä¹ˆï¼š44 + 1ï¼ˆ&#39;\\0&#39;ï¼‰+ 3 + 16(robj) = 64ï¼Œåˆšå¥½æ˜¯64å­—èŠ‚ï¼Œå¯ä»¥è¾¾åˆ°64å­—èŠ‚å†…å­˜å¯¹é½ã€‚ ä½œè€…ä¸€åº¦ç”¨ç€44çš„é™åˆ¶ï¼Œå†™ç€39çš„æ³¨é‡Šï¼Œè®©æˆ‘ä¸€åº¦è¿·æƒ‘ã€‚ 2.5. å¤šçº¿ç¨‹redis6.0åŠ å…¥äº†å¤šçº¿ç¨‹ï¼Œä¸çŸ¥é“å’Œé˜¿é‡Œäº‘çš„å¤šçº¿ç¨‹redisæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œçœ‹èµ·æ¥éƒ½æ˜¯åœ¨ioçº¿ç¨‹å¹¶è¡Œï¼Œå·¥ä½œçº¿ç¨‹ä¸²è¡Œã€‚ 2.6. raftredis sentinelå’Œredis clusteré€‰ä¸¾éƒ½æ˜¯é‡‡ç”¨raftåè®®çš„é€‰ä¸¾æ–¹å¼ï¼šåŒä¸€ä¸ªtermé‡Œï¼Œä¸€äººä¸€ç¥¨ï¼›å½“å¾—åˆ°majorityçš„ç¥¨æ—¶é€‰ä¸¾æˆåŠŸï¼Œå½“ç¥¨è¢«ç“œåˆ†é€‰ä¸¾å¤±è´¥å¼€å§‹æ–°ä¸€è½®ã€‚ åœ¨sentinelæ¨¡å¼ä¸‹ï¼Œè´Ÿè´£æ•…éšœè½¬ç§»çš„sentinelæ˜¯é€šè¿‡rafté€‰ä¸¾å‡ºæ¥çš„ï¼šåªéœ€è¦å…ˆå‘èµ·æŠ•ç¥¨çš„sentinelèŠ‚ç‚¹å°±èƒ½æ‹¿åˆ°ç¥¨ã€‚æ¥ç€é¢†å¤´sentinelåœ¨ä»èŠ‚ç‚¹ä¸­é€‰å‡ºå¤åˆ¶åç§»é‡æœ€å¤§çš„ä»èŠ‚ç‚¹ä½œä¸ºæ–°masterï¼›å¦‚æœä»èŠ‚ç‚¹çš„å¤åˆ¶åç§»é‡ä¸€è‡´ï¼Œåˆ™é€‰å–æœåŠ¡å™¨idè¾ƒå°çš„é‚£ä¸ªã€‚ åœ¨clusteræ¨¡å¼ä¸‹ï¼Œä»èŠ‚ç‚¹æ™‹å‡ä¸ºä¸»èŠ‚ç‚¹æ¯”sentinelæ¨¡å¼å¤æ‚ä¸€äº›ï¼Œéœ€è¦å¾—åˆ°majorityä¸»èŠ‚ç‚¹çš„ç¥¨ã€‚åœ¨é€‰ä¸¾è¿‡ç¨‹ï¼Œå½“candidateæ”¶åˆ°æŠ•ç¥¨è¯·æ±‚æ—¶ï¼Œåˆ¤æ–­æŠ•ç¥¨è¯·æ±‚æ˜¯å¦è¿‡æœŸã€candidateæ˜¯å¦æœ‰é€‰ç¥¨ï¼Œæ¯”è¾ƒä¸»ä»å¤åˆ¶åç§»é‡ï¼Œç¬¦åˆçš„è¯é‚£å°±æŠ•ç»™é‚£ä¸ªèŠ‚ç‚¹ã€‚ 2.7. LFUredis4.0æ–°å¢äº†lfuç­–ç•¥æ¥æ·˜æ±°key 123456789typedef struct redisObject &#123; unsigned type:4; unsigned encoding:4; unsigned lru:LRU_BITS; /* LRU time (relative to global lru_clock) or * LFU data (least significant 8 bits frequency * and most significant 16 bits access time). */ int refcount; void *ptr;&#125; robj; é€šè¿‡redis.confçš„è®¾ç½®ï¼Œunsigned lru:LRU_BITSçš„æœ‰ä¸åŒçš„è¡¨ç¤ºã€‚å½“è¡¨ç¤ºlfuæ—¶ï¼Œè¿™ä¸ªå­—æ®µç”¨8ä½æ¥å½“ä½œè®¡æ•°å™¨ï¼Œç”¨16ä½å½“æ—¶é—´æˆ³ï¼Œ16ä½é•¿åº¦åªæœ‰ä¸¤ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å­˜çš„æ—¶é—´æ˜¯ä»¥ç§’ä½å•ä½ã€‚ åœ¨redisé‡Œlfuç­–ç•¥ä¸‹ï¼Œå¦‚æœä¸€ä¸ªkeyè¢«è®¿é—®ï¼Œé‚£ä¹ˆè®¡æ•°å™¨ä¼šå¢åŠ ï¼Œä¸è¿‡è¿™ç§å¢åŠ æ˜¯éœ€è¦ä¹˜ä¸Šä¸€ä¸ªæ¦‚ç‡çš„ï¼Œè®¡æ•°å™¨è¶Šå¤§ï¼Œè®¡æ•°å¢åŠ çš„å‡ ç‡è¶Šå°ï¼›è€ŒåŒæ—¶keyè¿˜è¦æ ¹æ®æ—¶é—´æˆ³åˆ¤æ–­è¦ä¸è¦è¡°å‡è®¡æ•°å™¨ï¼Œä»¥æ­¤è°ƒæ•´è®¡æ•°ã€‚ åœ¨è¿™ç§ç­–ç•¥ä¸‹ï¼Œredisä¼šä¸ºkeyåˆå§‹åŒ–ä¸€ä¸ª5çš„è®¡æ•°å™¨ï¼Œé˜²æ­¢keyåˆšè¢«åˆå§‹åŒ–å°±è¢«æ·˜æ±°ã€‚ 2.8. BITSETä½å›¾ç”¨æ¥ç»Ÿè®¡æ˜¯å¾ˆä¸é”™çš„ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œåœ¨redisé‡Œä½å›¾ä¹Ÿæ˜¯ä¸€ä¸ªsdshdrï¼Œrediså°†ä¸€ä¸ªå­—ç¬¦ç”¨ä½œ8ä½ï¼Œå¹¶æŠŠä½å›¾ä»ä½ä½å¾€é«˜ä½å­˜å‚¨ï¼ˆsdshdrç”¨bufæ•°ç»„å­˜å‚¨å­—ç¬¦ä¸²ï¼Œå½“sdshdrè¡¨ç¤ºä½å›¾æ—¶ï¼Œbufæ•°ç»„ä»å·¦å¾€å³æ˜¯ä»ä½ä½åˆ°é«˜ä½ï¼‰ï¼Œè¿™æ ·å½“ä½å›¾éœ€è¦æ‰©å¤§çš„æ—¶å€™ï¼Œåªéœ€è¦åœ¨bufæ•°ç»„å°¾éƒ¨å¢åŠ å­—ç¬¦å°±å¯ä»¥äº†ã€‚ ä½å›¾çš„ç»Ÿè®¡çš„æ˜¯ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ç»Ÿè®¡ä¸€ä¸ªäºŒè¿›åˆ¶æ•°çš„1æœ‰å¤šå°‘ä¸ªã€‚ æš´åŠ›æ³•ä¸è€ƒè™‘ï¼Œè¦è¯´çš„æ˜¯ä¸¤ä¸ªæ–¹æ³•ï¼ŒæŸ¥è¡¨æ³•è¿˜æœ‰variable-precision SWARç®—æ³• 2.8.1. æŸ¥è¡¨æ³•æŸ¥è¡¨æ³•å°±æ˜¯é¢„å…ˆç»™å‡ºå„ä¸ªæ•°çš„äºŒè¿›åˆ¶çš„1çš„æ•°é‡ï¼Œå¯¹äºæ¯”è¾ƒå°çš„æ•°å­—ï¼Œè¿™æ˜¯ä¸€ä¸ªé€Ÿåº¦æœ€å¿«çš„æ–¹æ³•ã€‚ 2.8.2. variable-precision SWARç®—æ³•è¿™ä¸ªæ–¹æ³•é‡‡ç”¨ä½è¿ç®—ï¼Œè€Œä¸”è¿˜ä¸å é¢å¤–å†…å­˜ 123456789101112int swar(uint32_t i)&#123; //è®¡ç®—æ¯ä¸¤ä½äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•° i = ( i &amp; 0x55555555) + ((i &gt;&gt; 1) &amp; 0x55555555); //è®¡ç®—æ¯å››ä½äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•° i = (i &amp; 0x33333333) + ((i &gt;&gt; 2) &amp; 0x33333333); //è®¡ç®—æ¯å…«ä½äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•° i = (i &amp; 0x0F0F0F0F) + ((i &gt;&gt; 4) &amp; 0x0F0F0F0F); //å°†æ¯å…«ä½äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•°å’Œç›¸åŠ ï¼Œå¹¶ç§»è‡³æœ€ä½ä½å…«ä½ i = (i * 0x01010101) &gt;&gt; 24); return i;&#125; å¯¹äºä¸€ä¸ª32ä½çš„æ•°ï¼Œé€šè¿‡ä½è¿ç®—å½’å¹¶1çš„æ•°é‡åˆ°4ä¸ªå­—èŠ‚ä¸­ï¼Œæœ€åç”¨ä¸€ä¸ªä¹˜æ³•æ±‡æ€»4ä¸ªå­—èŠ‚çš„1çš„æ•°é‡åˆ°é«˜8ä½ï¼Œè¿™ä¸ªä¹˜æ³•è¿‡ç¨‹å¦‚ä¸‹ï¼š 12345678910111213 00000001 00000010 00000011 00000100 x 00000001 00000001 00000001 00000001------------------------------------------------------------------- 00000001 00000010 00000011 00000100 00000001 00000010 00000011 00000100 00000001 00000010 00000011 00000100 00000001 00000010 00000011 00000100------------------------------------------------------------------- |00001010|Â·Â·Â·Â·Â·Â·Â·no sense bitÂ·Â·Â·Â·Â·Â·Â· æœ€åå³ç§»24ä½å¾—åˆ°è¿™8ä½çš„å€¼ã€‚ 2.8.3. redis bitcountredisé‡‡ç”¨æŸ¥æ³•å’Œvariable-precision SWARç®—æ³•ç»“åˆçš„æ–¹æ³•æ¥å®ç°bitcountã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253size_t redisPopcount(void *s, long count) &#123; size_t bits = 0; unsigned char *p = s; uint32_t *p4; static const unsigned char bitsinbyte[256] = &#123;0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8&#125;; /* Count initial bytes not aligned to 32 bit. */ while((unsigned long)p &amp; 3 &amp;&amp; count) &#123; bits += bitsinbyte[*p++]; count--; &#125; /* Count bits 28 bytes at a time */ p4 = (uint32_t*)p; while(count&gt;=28) &#123; uint32_t aux1, aux2, aux3, aux4, aux5, aux6, aux7; aux1 = *p4++; aux2 = *p4++; aux3 = *p4++; aux4 = *p4++; aux5 = *p4++; aux6 = *p4++; aux7 = *p4++; count -= 28; aux1 = aux1 - ((aux1 &gt;&gt; 1) &amp; 0x55555555); aux1 = (aux1 &amp; 0x33333333) + ((aux1 &gt;&gt; 2) &amp; 0x33333333); aux2 = aux2 - ((aux2 &gt;&gt; 1) &amp; 0x55555555); aux2 = (aux2 &amp; 0x33333333) + ((aux2 &gt;&gt; 2) &amp; 0x33333333); aux3 = aux3 - ((aux3 &gt;&gt; 1) &amp; 0x55555555); aux3 = (aux3 &amp; 0x33333333) + ((aux3 &gt;&gt; 2) &amp; 0x33333333); aux4 = aux4 - ((aux4 &gt;&gt; 1) &amp; 0x55555555); aux4 = (aux4 &amp; 0x33333333) + ((aux4 &gt;&gt; 2) &amp; 0x33333333); aux5 = aux5 - ((aux5 &gt;&gt; 1) &amp; 0x55555555); aux5 = (aux5 &amp; 0x33333333) + ((aux5 &gt;&gt; 2) &amp; 0x33333333); aux6 = aux6 - ((aux6 &gt;&gt; 1) &amp; 0x55555555); aux6 = (aux6 &amp; 0x33333333) + ((aux6 &gt;&gt; 2) &amp; 0x33333333); aux7 = aux7 - ((aux7 &gt;&gt; 1) &amp; 0x55555555); aux7 = (aux7 &amp; 0x33333333) + ((aux7 &gt;&gt; 2) &amp; 0x33333333); bits += ((((aux1 + (aux1 &gt;&gt; 4)) &amp; 0x0F0F0F0F) + ((aux2 + (aux2 &gt;&gt; 4)) &amp; 0x0F0F0F0F) + ((aux3 + (aux3 &gt;&gt; 4)) &amp; 0x0F0F0F0F) + ((aux4 + (aux4 &gt;&gt; 4)) &amp; 0x0F0F0F0F) + ((aux5 + (aux5 &gt;&gt; 4)) &amp; 0x0F0F0F0F) + ((aux6 + (aux6 &gt;&gt; 4)) &amp; 0x0F0F0F0F) + ((aux7 + (aux7 &gt;&gt; 4)) &amp; 0x0F0F0F0F))* 0x01010101) &gt;&gt; 24; &#125; /* Count the remaining bytes. */ p = (unsigned char*)p4; while(count--) bits += bitsinbyte[*p++]; return bits;&#125; é¦–å…ˆå¯¹äºä½å›¾éœ€è¦4å­—èŠ‚å¯¹é½ï¼Œå› ä¸ºredisé‡Œçš„SWARç®—æ³•ä¸€æ¬¡æ“ä½œ4ä¸ªå­—èŠ‚ï¼Œä¿è¯å­—èŠ‚å¯¹é½å¯ä»¥æé«˜å†…å­˜è¯»å–é€Ÿåº¦ï¼Œç„¶åæºç é‡Œæœ‰è¿™ä¹ˆä¸€æ®µ 12345/* Count initial bytes not aligned to 32 bit. */while((unsigned long)p &amp; 3 &amp;&amp; count) &#123; bits += bitsinbyte[*p++]; count--;&#125; è¿™æ®µæˆ‘çœ‹äº†åŠå¤©çœ‹ä¸æ‡‚ï¼Œæœ€ååœ¨stackoverflowHow Do I check a Memory address is 32 bit aligned in Cæ‰¾åˆ°ç­”æ¡ˆï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯åœ°å€ç»“å°¾æ˜¯0b100çš„å€æ•°ï¼Œä¹Ÿå°±æ˜¯&amp; 0b11 = 0ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€å°±æ˜¯å¯ä»¥4å­—èŠ‚å¯¹é½çš„ã€‚æ‰€ä»¥å¦‚æœ(unsigned long)p &amp; 3ä¸ºtrueï¼Œè¯´æ˜åœ°å€ä¸å¯¹é½ï¼Œå°±è¦æŒ‡é’ˆå‰è¿›ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶é€šè¿‡æŸ¥è¡¨æ³•è®¡ç®—è¿™ä¸ªå­—èŠ‚çš„1çš„æ•°é‡ã€‚ æ¥ç€åŒæ—¶è®¡ç®—è¿ç»­çš„28ä¸ªå­—èŠ‚ï¼Œæ¯4å­—èŠ‚ä½¿ç”¨ä¸€æ¬¡SWARç®—æ³•ï¼Œå†æŠŠ7æ¬¡ç»“æœæ±‡æ€»ã€‚ æœ€åä½™ä¸‹ä¸è¶³28å­—èŠ‚çš„å†ç”¨æŸ¥è¡¨æ³•è®¡ç®—ã€‚æ•´ä¸ªbitcountçš„è¿‡ç¨‹å°±æ˜¯è¿™æ ·ã€‚ ç»Ÿè®¡ä¸€ä¸ªä½æ•°ç»„ä¸­é0ä½çš„æ•°é‡ï¼Œæ•°å­¦ä¸Šç§°ä½œï¼šâ€Hanmming Weightâ€œ(æ±‰æ˜é‡é‡)ã€‚ 2.9. AOFå³ä½¿å¼€å¯appendfsync alwaysé…ç½®ï¼Œredisè¿˜æ˜¯å¯èƒ½ä¸¢æ•°æ®ã€‚ AOFä¸»è¦é aof_bufå’ŒAOFæ–‡ä»¶ã€‚ éƒ½è¯´redisæ˜¯åŸºäºäº‹ä»¶å¾ªç¯çš„ã€‚åœ¨ä¸€æ¬¡äº‹ä»¶å¾ªç¯é‡Œï¼Œæ¯ä¸ªå†™äº‹ä»¶rediséƒ½ä¼šè¿½åŠ åˆ°aof_bufä¸­ï¼›æ¯æ¬¡äº‹ä»¶å¾ªç¯åï¼Œrediséƒ½ä¼šæŠŠaof_bufçš„å†…å®¹å†™è¿›AOFæ–‡ä»¶é‡Œã€‚ä½†æ˜¯AOFæ–‡ä»¶æ˜¯ä¸ä¼šå®æ—¶åˆ·å…¥ç¡¬ç›˜çš„ï¼Œè€Œappendfsyncé…ç½®å…·ä½“å°±æ˜¯åˆ·ç›˜æ—¶æœºã€‚å¼€å¯appendfsync alwaysé…ç½®åï¼Œæ¯ä¸ªäº‹ä»¶å¾ªç¯éƒ½ä¼šè¿›è¡Œåˆ·ç›˜ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹rediså®•æœºï¼Œä¹Ÿä¼šè‡³å¤šä¸¢å¤±ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„å‘½ä»¤ã€‚ é¢˜å¤–è¯ï¼Œinnodbæ—¥å¿—ç³»ç»Ÿä¹Ÿæœ‰log bufferå’Œlog fileï¼Œç±»ä¼¼äºaof_bufå’ŒAOFæ–‡ä»¶ï¼Œè€Œinnodb_flush_log_at_trx_commitè¿™ä¸ªé…ç½®æ§åˆ¶çš„ä¹Ÿæ˜¯log fileåˆ·ç›˜ç­–ç•¥ï¼Œä¸è¿‡innodbå¯ä»¥åšåˆ°ä¸ä¸¢æ•°æ®ï¼Œè€Œredisä¸è¡Œã€‚ 3. å‚è€ƒ ã€Rediså­¦ä¹ ç¬”è®°ã€‘bitcountåˆ†æ","categories":[{"name":"redis","slug":"redis","permalink":"https://htchz.cc/categories/redis/"}],"tags":[]},{"title":"[åˆ†å¸ƒå¼]æ‰‹æ’•raft","slug":"åˆ†å¸ƒå¼-æ‰‹æ’•raft","date":"2019-10-03T08:27:57.000Z","updated":"2020-02-23T04:26:12.496Z","comments":true,"path":"1823228532.html","link":"","permalink":"https://htchz.cc/1823228532.html","excerpt":"","text":"1. å‰è¨€Raftä½œä¸ºä¸€ä¸ªç®€å•çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œå®ç°ä¸€ä¸‹è¿˜æ˜¯æŒºå¥½ç©çš„ã€‚ä»£ç åŸºäº6.824 lab-raftï¼Œ6.824æ˜¯éº»çœç†å·¥çš„åˆ†å¸ƒå¼è¯¾ç¨‹çš„ä¸€ä¸ªç¼–å·ï¼Œé‡Œé¢æœ‰4ä¸ªlabï¼Œç¬¬äºŒä¸ªå°±æ˜¯raftåè®®çš„å®ç°ï¼Œç¬¬ä¸‰ä¸ªæ˜¯åŸºäºraftåè®®çš„kvå­˜å‚¨è®¾è®¡ï¼Œæœ‰å¾…å®ç°ï¼ˆohæˆ‘å±…ç„¶åœ¨åšéº»çœç†å·¥çš„è¯¾ç¨‹è®¾è®¡ï¼‰ã€‚è¯¥labè¦æ±‚ä½¿ç”¨goå®ç°ç®—æ³•ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªå…·æœ‰æ•…éšœæ¨¡æ‹ŸåŠŸèƒ½çš„RPCï¼Œå³é€šè¿‡æ¨¡æ‹Ÿç½‘ç»œï¼Œåœ¨å•å°æœºå™¨æˆ‘ä»¬å°±å¯ä»¥è¿è¡Œraftç®—æ³•ã€‚ åšå®éªŒå‰ï¼Œä½ åº”è¯¥ç†Ÿè¯»raftè®ºæ–‡ï¼Œè¿™é‡Œæ˜¯ä¸­æ–‡ç‰ˆ 2. å®ç°å‚ç…§raftè®ºæ–‡å’Œlabæç¤ºï¼Œæ•´ä½“åˆ©ç”¨channelä½œä¸ºäº‹ä»¶é©±åŠ¨ã€mutexä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå†™å‡ºä¸€ä¸ªraftç®—æ³•éª¨æ¶è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ã€‚ä¸è¿‡åœ¨è·‘testçš„æ—¶å€™ï¼Œå°å°çš„ç»†èŠ‚ä¸å¯¹å°±ä¼šå¯¼è‡´test failedã€‚raft-labæä¾›äº†17ä¸ªtestï¼Œæ£€éªŒäº†å„ç§æƒ…å†µä¸‹çš„ä¸€è‡´æ€§ï¼Œæ¨¡æ‹Ÿäº†å„ç§å¥‡è‘©ç½‘ç»œå˜åŒ–ï¼ˆç½‘ç»œå˜æˆè¿™æ ·è¿˜æ˜¯è·‘è·¯å§ï¼‰ï¼Œè¦æ±‚4åˆ†é’Ÿå†…passã€‚ 2.1. æ•°æ®ç»“æ„å‚ç…§è®ºæ–‡ï¼Œå®šä¹‰å‡ ä¸ªæ•°æ®ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869const ( Follower = iota Candidate Leader HeartbeatInterval = 100 * time.Millisecond)type ApplyMsg struct &#123; CommandValid bool Command interface&#123;&#125; CommandIndex int&#125;type LogEntry struct &#123; Term int Command interface&#123;&#125;&#125;type AppendEntriesArgs struct &#123; Term int LeaderId int PrevLogIndex int PrevLogTerm int Entries []LogEntry LeaderCommit int&#125;type AppendEntriesReply struct &#123; Term int Success bool NextIndex int&#125;type Raft struct &#123; currentTerm int mu sync.Mutex // Lock to protect shared access to this peer's state peers []*labrpc.ClientEnd // RPC end points of all peers persister *Persister // Object to hold this peer's persisted state me int // this peer's index into peers[] state int // 0:Follower 1:Candidate 2:Leader votedFor int // è¿™ä¸ªå®éªŒç”¨indexæ¥ä»£æ›¿èŠ‚ç‚¹ voteCount int commitIndex int lastApplied int currentLeaderId int log []LogEntry nextIndex []int matchIndex []int applyCh chan ApplyMsg heartbeatCh chan bool leaderCh chan bool commitCh chan bool&#125;type RequestVoteArgs struct &#123; // Your data here (2A, 2B). Term int CandidateId int // è¿™ä¸ªå®éªŒç”¨indexæ¥ä»£æ›¿èŠ‚ç‚¹ LastLogIndex int LastLogTerm int&#125;type RequestVoteReply struct &#123; // Your data here (2A). VoteGranted bool // æ˜¯å¦æ”¯æŒ Term int&#125; å°å£°bbï¼ŒAppendEntriesReplyè®ºæ–‡æ˜¯æ²¡æœ‰è¿”å›nextIndexçš„ï¼Œè€Œæ˜¯ç”±leaderè‡ªå·±å»å‡ä¸€é‡è¯•ï¼Œè¿™å…¶å®æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œåœ¨è®¾ç½®äº†ç½‘ç»œæ•…éšœunreliableçš„testä¸­ï¼Œå•çº¯çš„å‡ä¸€é‡è¯•ä¼šå¯¼è‡´rafté›†ç¾¤åœ¨ä¸€å®šæ—¶é—´å†…ä¸èƒ½è¾¾åˆ°ä¸€è‡´ã€‚è®©followerè¿‡æ»¤æ‰åŒä¸€ä¸ªtermçš„indexï¼Œå¹¶è¿”å›åº”è¯¥å°è¯•çš„nextIndexï¼Œè™½ç„¶ä¼šå¯¼è‡´ä¸€æ¬¡å¤åˆ¶çš„æ—¥å¿—å˜å¤šï¼Œä¸è¿‡æé«˜äº†é›†ç¾¤è¾¾åˆ°ä¸€è‡´çš„é€Ÿåº¦ã€‚ 2.2. ä¸€äº›å°è£…1234567891011121314151617// è·å–é”/é‡Šæ”¾é”çš„å°è£…ï¼Œå¯ä»¥åœ¨åˆ©ç”¨`runtime.Caller`æ‰“å°è·å–é”çš„è°ƒç”¨ç‚¹ï¼Œè™½ç„¶æ€§èƒ½æŸå¤±æ¯”è¾ƒå¤§ã€‚func (rf *Raft) Lock() &#123; rf.mu.Lock()&#125;func (rf *Raft) Unlock() &#123; rf.mu.Unlock()&#125;// å­—å¦‚å…¶åfunc (rf *Raft) getLastLogTerm() int &#123; return rf.log[len(rf.log)-1].Term&#125;func (rf *Raft) getLastLogIndex() int &#123; return len(rf.log) - 1&#125; 2.3. raftå®ä¾‹åˆå§‹åŒ–123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960func Make(peers []*labrpc.ClientEnd, me int, persister *Persister, applyCh chan ApplyMsg) *Raft &#123; rf := &amp;Raft&#123;&#125; rf.peers = peers rf.persister = persister rf.me = me // Your initialization code here (2A, 2B, 2C). rf.state = Follower rf.currentTerm = 0 rf.votedFor = -1 rf.currentLeaderId = -1 // åˆå§‹åŒ–ç©ºç™½æ—¥å¿— rf.log = append(rf.log, LogEntry&#123;Term: 0&#125;) rf.applyCh = applyCh rf.heartbeatCh = make(chan bool, 100) rf.leaderCh = make(chan bool, 100) rf.commitCh = make(chan bool, 100) // initialize from state persisted before a crash rf.readPersist(persister.ReadRaftState()) // åˆå§‹åŒ–éšæœºæ•°èµ„æºåº“ rand.Seed(time.Now().UnixNano()) go func() &#123; for &#123; switch rf.state &#123; case Follower: select &#123; case &lt;-rf.heartbeatCh: // è¿™æ˜¯labè¦æ±‚å¿ƒè·³ case &lt;-time.After(time.Duration(rand.Int63()%333+550) * time.Millisecond): rf.state = Candidate &#125; case Leader: rf.broadcastAppendEntries() time.Sleep(HeartbeatInterval) case Candidate: go rf.broadcastVote() select &#123; case &lt;-time.After(time.Duration(rand.Int63()%300+500) * time.Millisecond): //éšæœºæŠ•ç¥¨è¶…æ—¶æ˜¯å¿…é¡»çš„ï¼Œä¸ºäº†é˜²æ­¢ç¥¨è¢«ç“œåˆ†å®Œã€‚ case &lt;-rf.heartbeatCh: rf.state = Follower case &lt;-rf.leaderCh: &#125; &#125; &#125; &#125;() go func() &#123; for &#123; &lt;-rf.commitCh rf.applyMsg(applyCh) &#125; &#125;() return rf&#125; è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªraftå®ä¾‹ï¼Œè¯»å–æŒä¹…åŒ–æ•°æ®ï¼Œèµ·äº†ä¸¤ä¸ªgoroutineã€‚ goroutine1æ˜¯raftä¸‰ç§çŠ¶æ€çš„è½¬åŒ–ï¼Œè¿™é‡Œçš„è¶…æ—¶æ—¶é—´ä¸å®œè®¾çš„å¤ªçŸ­ï¼ˆå¤ªçŸ­æŒ‡è®ºæ–‡é‡Œçš„æ—¶é—´ï¼‰ï¼Œåœ¨labæ–‡æ¡£é‡Œæœ‰æŒ‡å‡ºä¸ºäº†é…åˆtestï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´åº”è¯¥larger than the paperâ€™s 150 to 300 milliseconds goroutine2åº”ç”¨å·²æäº¤æ—¥å¿—ã€‚ åœ¨åˆå§‹åŒ–channelçš„æ—¶å€™åº”è¯¥è®¾ç½®ç¼“å†²å¤§äº1ã€‚å¤šä½™çš„äº‹ä»¶å¹¶ä¸ä¼šå¯¼è‡´ç³»ç»Ÿä¸ä¸€è‡´ï¼Œä½†æ˜¯è‹¥ç”±äºchannelç¼“å†²ä¸å¤Ÿè€Œå¯¼è‡´é˜»å¡ï¼Œå°±ä¼šä½¿raftèŠ‚ç‚¹æ­»é”ã€‚ 2.4. votedForæ¸…ç©ºæ—¶æœºä¸€æ¬¡rpcï¼Œæ— è®ºæ˜¯å‘èµ·ç«¯è¿˜æ˜¯æ¥æ”¶ç«¯ï¼Œåªè¦æ”¶åˆ°æ›´å¤§çš„termï¼Œå°±è¦è°ƒæ•´è‡ªå·±çš„çŠ¶æ€ï¼Œå‘ç”Ÿä¸‹é¢å˜åŒ–ï¼š 123rf.votedFor = -1rf.state = Followerrf.currentTerm = remoteTerm å¯ä»¥çœ‹åˆ°stateä¼šå˜æˆFollowerã€‚ å‡è®¾ä¸€ç§æƒ…æ™¯ï¼ŒABCä¸‰ä¸ªèŠ‚ç‚¹ä¸‹ï¼ŒAä¸ºleaderï¼Œæ­¤æ—¶Cå‘ç”Ÿåˆ†åŒºï¼Œé‚£ä¹ˆCä¸€å®šä¼šä¸æ–­å¾ªç¯è¿›è¡Œè¶…æ—¶é€‰ä¸¾ï¼ŒCçš„termä¼šä¸€ç›´å¢å¤§ï¼Œå½“Cç½‘ç»œæ¢å¤é‡æ–°åŠ å…¥é›†ç¾¤åä¼šç»§ç»­å‘æŠ•ç¥¨è¯·æ±‚rpcã€‚ç”±äºCçš„æŠ•ç¥¨è¯·æ±‚rpcä¸­çš„termè¾ƒå¤§ï¼Œé›†ç¾¤å°±ä¼šè°ƒæ•´currentTermä»¥åŠstateï¼Œå·²æœ‰leaderä¼šåºŸæ‰ã€‚è€Œé—®é¢˜æ˜¯ï¼ŒCçš„è¯·æ±‚æŠ•ç¥¨æ˜¯æ— æ„ä¹‰çš„ï¼Œå´ä½¿é›†ç¾¤è¿›è¡Œäº†ä¸€æ¬¡é€‰ä¸¾ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜æœ‰ä¸ªpreVoteæ–¹æ¡ˆï¼Œå°±æ˜¯åœ¨æŠ•ç¥¨å‰è°ƒç ”ä¸€ä¸‹è‡ªå·±æ˜¯å¦æœ‰æŠ•ç¥¨å¿…è¦ï¼Œå¦‚æœæ²¡å¿…è¦ï¼Œå°±ä¸å‘èµ·æŠ•ç¥¨ã€‚è¿™ç¯‡æ–‡ç« æš‚æ— æ¶‰åŠpreVoteã€‚ 2.5. æŠ•ç¥¨å‘èµ·ä¸æ¥æ”¶2.5.1. broadcastVote() å‘èµ·æŠ•ç¥¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354func (rf *Raft) broadcastVote() &#123; rf.Lock() rf.currentTerm++ rf.voteCount = 1 rf.votedFor = rf.me vote := &amp;RequestVoteArgs&#123; Term: rf.currentTerm, CandidateId: rf.me, LastLogIndex: rf.getLastLogIndex(), LastLogTerm: rf.getLastLogTerm(), &#125; rf.persist() rf.Unlock() for i := 0; i &lt; len(rf.peers); i++ &#123; if rf.state != Candidate &#123; // å‘é€ break &#125; if vote.CandidateId == i &#123; // è‡ªå·±çš„ç¥¨å·²ç»ç»™è‡ªå·±äº† continue &#125; go func(server int) &#123; var reply RequestVoteReply ok := rf.sendRequestVote(server, vote, &amp;reply) if !ok &#123; return &#125; rf.Lock() defer rf.Unlock() // ä¸€èˆ¬æ¥è¯´ï¼Œreply.Term &gt; rf.currentTerm çš„æƒ…å†µä¸‹ reply.VoteGranted ä¸ä¼šä¸ºtrue if reply.Term &gt; rf.currentTerm &#123; rf.votedFor = -1 rf.state = Follower rf.currentTerm = reply.Term rf.persist() &#125; if reply.VoteGranted &#123; rf.voteCount++ if rf.state == Candidate &amp;&amp; rf.voteCount &gt; len(rf.peers)/2 &#123; rf.becomeLeader() &#125; &#125; &#125;(i) &#125;&#125;func (rf *Raft) sendRequestVote(server int, args *RequestVoteArgs, reply *RequestVoteReply) bool &#123; ok := rf.peers[server].Call(\"Raft.RequestVote\", args, reply) return ok&#125; åœ¨æ¥æ”¶åˆ°æŠ•ç¥¨replyåï¼ŒæŸ¥çœ‹ç¥¨æ ¹æ˜¯å¦è¿‡åŠï¼Œå¦‚æœè¿‡åŠè½¬åŒ–ä¸ºleaderã€‚ 1234567891011// æ²¡æœ‰åŠ é”ï¼Œå¤–éƒ¨è°ƒç”¨å·²ç»åŠ é”äº†func (rf *Raft) becomeLeader() &#123; rf.state = Leader rf.nextIndex = make([]int, len(rf.peers)) rf.matchIndex = make([]int, len(rf.peers)) // åˆå§‹åŒ–ä¸º0 for i := 0; i &lt; len(rf.peers); i++ &#123; rf.nextIndex[i] = rf.getLastLogIndex() + 1 &#125; rf.leaderCh &lt;- true // ç»“æŸé€‰ä¸¾é˜»å¡&#125; 2.5.2. RequestVote æ¥æ”¶æŠ•ç¥¨12345678910111213141516171819202122232425262728293031323334353637func (rf *Raft) RequestVote(args *RequestVoteArgs, reply *RequestVoteReply) &#123; rf.Lock() defer rf.Unlock() defer rf.persist() // Your code here (2A, 2B). reply.VoteGranted = false reply.Term = rf.currentTerm // è¿‡æœŸçš„æŠ•ç¥¨è¯·æ±‚ if rf.currentTerm &gt; args.Term &#123; return &#125; // å¦‚æœå‘èµ·æ–¹çš„termæ¯”æ¥æ”¶æ–¹å¤§ // adjust current term if rf.currentTerm &lt; args.Term &#123; rf.currentTerm = args.Term rf.state = Follower rf.votedFor = -1 &#125; upToDate := false if args.LastLogTerm &gt; rf.getLastLogTerm() &#123; upToDate = true &#125; if args.LastLogTerm == rf.getLastLogTerm() &amp;&amp; args.LastLogIndex &gt;= rf.getLastLogIndex() &#123; upToDate = true &#125; if (rf.votedFor == -1 || rf.votedFor == args.CandidateId) &amp;&amp; // ä¿è¯æœ‰ç¥¨ upToDate &#123; reply.VoteGranted = true rf.state = Follower rf.votedFor = args.CandidateId rf.heartbeatCh &lt;- true return &#125;&#125; 1ï¼Œè¿›è¡ŒæŠ•ç¥¨åè¦å‘é€å¿ƒè·³rf.heartbeatCh &lt;- trueï¼Œä¸ç„¶èŠ‚ç‚¹ä¼šç”±Followerè¶…æ—¶ï¼Œä»è€Œä½¿é›†ç¾¤é€‰ä¸¾å¾ªç¯ä¸‹å»ã€‚2ï¼Œåˆ¤æ–­æ—¥å¿—æ˜¯å¦è¾ƒæ–°è¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶ï¼šä¸€ï¼Œtermè¾ƒå¤§ï¼ŒäºŒï¼Œtermä¸€æ ·ï¼Œä½†æ—¥å¿—indexæ¯”è¾ƒå¤§ 2.6. æ—¥å¿—å¤åˆ¶ä¸æ¥æ”¶2.6.1. broadcastAppendEntries å¹¿æ’­æ—¥å¿—/å¿ƒè·³æ—¥å¿—å¤åˆ¶labæ–‡æ¡£è¦æ±‚ä¸€ç§’ä¸èƒ½è¶…è¿‡10æ¬¡ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455func (rf *Raft) broadcastAppendEntries() &#123; rf.Lock() defer rf.Unlock() N := rf.commitIndex for i := rf.commitIndex + 1; i &lt;= rf.getLastLogIndex(); i++ &#123; // 1 æ˜¯leaderæœ¬èº« num := 1 for j := range rf.peers &#123; // åªèƒ½æäº¤æœ¬termçš„ï¼Œä¸€æ—¦æäº¤äº†æœ¬termçš„ï¼Œæ—§termä¹Ÿç®—æäº¤äº† if rf.me != j &amp;&amp; rf.matchIndex[j] &gt;= i &amp;&amp; rf.log[i].Term == rf.currentTerm &#123; num++ &#125; &#125; if num &gt; len(rf.peers)/2 &#123; N = i &#125; &#125; if N != rf.commitIndex &#123; rf.commitIndex = N rf.commitCh &lt;- true &#125; for i := 0; i &lt; len(rf.peers); i++ &#123; if rf.state != Leader &#123; break &#125; if i == rf.me &#123; // ä¸ç”¨ç»™è‡ªå·±å¿ƒè·³ continue &#125; var args AppendEntriesArgs args.Term = rf.currentTerm args.LeaderCommit = rf.commitIndex args.LeaderId = rf.me args.PrevLogIndex = rf.nextIndex[i] - 1 args.PrevLogTerm = rf.log[args.PrevLogIndex].Term args.Entries = make([]LogEntry, len(rf.log[args.PrevLogIndex+1:])) // å¤åˆ¶ copy(args.Entries, rf.log[args.PrevLogIndex+1:]) go func(i int, args AppendEntriesArgs) &#123; var reply AppendEntriesReply ok := rf.sendAppendEntries(i, &amp;args, &amp;reply) if !ok &#123; return &#125; rf.handleAppendEntriesReply(&amp;args, &amp;reply, i) &#125;(i, args) &#125;&#125;func (rf *Raft) sendAppendEntries(server int, args *AppendEntriesArgs, reply *AppendEntriesReply) bool &#123; ok := rf.peers[server].Call(\"Raft.AppendEntries\", args, reply) return ok&#125; æ¯æ¬¡å‘é€æ—¥å¿—å‰ï¼Œleaderä»matchIndex[]é‡Œç»Ÿè®¡å‡ºåº”è¯¥commitçš„indexï¼Œå¦‚æœindexå‰è¿›ï¼Œå‘é€commitäº‹ä»¶ã€‚ç»Ÿè®¡æ—¶è¦åˆ¤æ–­rf.log[i].Term == rf.currentTermï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½æäº¤è‡ªå·±termçš„logï¼Œä¸€æ—¦æäº¤äº†è‡ªå·±termçš„logï¼Œä¹‹å‰termæœªè¢«æäº¤çš„logä¹Ÿç®—æäº¤äº†ã€‚è¿™ä¸ªåœ¨è®ºæ–‡æœ‰æåˆ°ã€‚ ä¸‹é¢æ˜¯å¤åˆ¶æ—¥å¿—çš„å“åº”ä»£ç ï¼Œä¹Ÿå¾ˆç›´ç™½ã€‚ 123456789101112131415161718192021222324252627282930// reply ä¸º falseï¼Œ å¦‚æœä¸æ˜¯ä»»æœŸé—®é¢˜ï¼Œå°±æ˜¯æ—¥å¿—ä¸åŒ¹é…func (rf *Raft) handleAppendEntriesReply(args *AppendEntriesArgs, reply *AppendEntriesReply, i int) &#123; rf.Lock() defer rf.Unlock() if rf.state != Leader &#123; // è·å–é”åæ ¡éªŒè‡ªå·±çš„çŠ¶æ€ return &#125; if args.Term != rf.currentTerm &#123; return &#125; if reply.Term &gt; rf.currentTerm &#123; rf.votedFor = -1 rf.currentTerm = reply.Term rf.state = Follower rf.persist() return &#125; if reply.Success &#123; // len(args.Entries) == 0 å°±æ˜¯å¿ƒè·³äº†ï¼Œä¸ç”¨å¤„ç† if len(args.Entries) &gt; 0 &#123; rf.matchIndex[i] = args.PrevLogIndex + len(args.Entries) rf.nextIndex[i] = rf.matchIndex[i] + 1 &#125; &#125; else &#123; rf.nextIndex[i] = reply.NextIndex // ç›´æ¥é‡‡ç”¨followerçš„å»ºè®® &#125;&#125; 2.6.2. AppendEntries æ¥æ”¶æ—¥å¿—12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455func (rf *Raft) AppendEntries(args *AppendEntriesArgs, reply *AppendEntriesReply) &#123; rf.Lock() defer rf.Unlock() defer rf.persist() reply.Success = false // å‘Šè¯‰è€termçš„èŠ‚ç‚¹è¯¥æ›´æ–°å•¦ if rf.currentTerm &gt; args.Term &#123; reply.Term = rf.currentTerm return &#125; // å¿ƒè·³ rf.heartbeatCh &lt;- true // adjust current term if args.Term &gt; rf.currentTerm &#123; rf.currentTerm = args.Term rf.state = Follower rf.votedFor = -1 &#125; reply.Term = rf.currentTerm // è¿™å¨æ˜¯åœ¨æ—¥å¿—ä¸åŒ¹é…çš„æƒ…å†µä¸‹ï¼Œå¯¹leaderçš„NextIndexå»ºè®® if rf.getLastLogIndex() &lt; args.PrevLogIndex &#123; reply.NextIndex = rf.getLastLogIndex() + 1 return &#125; else if rf.log[args.PrevLogIndex].Term != args.PrevLogTerm &#123; term := rf.log[args.PrevLogIndex].Term if args.PrevLogTerm != term &#123; for i := args.PrevLogIndex - 1; i &gt;= 0; i-- &#123; if rf.log[i].Term != term &#123; reply.NextIndex = i + 1 break &#125; &#125; return &#125; &#125; reply.Success = true reply.NextIndex = rf.getLastLogIndex() + 1 // åˆ é™¤å·²å­˜åœ¨æ—¥å¿— rf.log = rf.log[:args.PrevLogIndex+1] // é™„åŠ æ–°æ—¥å¿— rf.log = append(rf.log, args.Entries...) if args.LeaderCommit &gt; rf.commitIndex &#123; rf.commitIndex = Min(args.LeaderCommit, rf.getLastLogIndex()) rf.commitCh &lt;- true &#125; return&#125; è¿™ç†ä¸»è¦æ˜¯NextIndexå»ºè®®å€¼çš„è®¡ç®—ã€‚ 2.7. å°†æäº¤çš„æ—¥å¿—åº”ç”¨è‡³çŠ¶æ€æœº12345678910111213func (rf *Raft) applyMsg(applyCh chan ApplyMsg) &#123; rf.Lock() defer rf.Unlock() for i := rf.lastApplied + 1; i &lt;= rf.commitIndex; i++ &#123; msg := ApplyMsg&#123; true, rf.log[i].Command, i, &#125; applyCh &lt;- msg rf.lastApplied = i &#125;&#125; åº”ç”¨è¿‡ç¨‹å…¶å®æ˜¯ç”±testå»ç®¡ç†çš„ï¼Œæˆ‘ä»¬åªè¦è´Ÿè´£æŠŠéœ€è¦åº”ç”¨çš„æ—¥å¿—æ”¾å…¥chan ApplyMsgã€‚ 2.8. æŒä¹…åŒ–12345678910111213141516171819202122func (rf *Raft) persist() &#123; // Your code here (2C). // Example: w := new(bytes.Buffer) e := gob.NewEncoder(w) e.Encode(rf.currentTerm) e.Encode(rf.votedFor) e.Encode(rf.log) data := w.Bytes() rf.persister.SaveRaftState(data)&#125;func (rf *Raft) readPersist(data []byte) &#123; if data == nil || len(data) &lt; 1 &#123; // bootstrap without any state? return &#125; r := bytes.NewBuffer(data) d := gob.NewDecoder(r) d.Decode(&amp;rf.currentTerm) d.Decode(&amp;rf.votedFor) d.Decode(&amp;rf.log)&#125; ä¸¤ä¸ªæŒä¹…åŒ–å‡½æ•°ï¼ŒæŒä¹…åŒ–äº†currentTermå½“å‰term,votedForå¾—ç¥¨è€…,logæ—¥å¿—æ•°ç»„ï¼Œå½“è¿™ä¸‰ä¸ªå±æ€§å˜åŒ–æ—¶ï¼Œéƒ½æ‰§è¡Œä¸€æ¬¡rf.persist()å°±æ²¡é”™å•¦ã€‚ 3. åè®°è¡¨é¢æ˜¯åœ¨è´´ä»£ç ï¼Œå®é™…å°±æ˜¯åœ¨è´´ä»£ç ã€‚ ç”±äºå®éªŒæ˜¯å¹¶å‘è¿‡ç¨‹ï¼Œä¸€æ—¦test failedæ˜¯ä¸å®¹æ˜“æŒ‰çº¿æ€§çš„è¿‡ç¨‹æ¥åˆ†æçš„ã€‚æˆ‘çš„æ–¹æ³•æ˜¯å¤šæ‰“æ—¥å¿—ï¼Œä»¥åŠåˆ©ç”¨net/http/pprofåŒ…å¯¹ç¨‹åºçš„goroutineã€mutexçŠ¶æ€è¿›è¡Œåˆ†æã€‚ å®ç°å®Œä»¥åæˆ‘æ„Ÿè§‰åˆå˜å¼ºäº†ï¼ˆå¹¶æ²¡æœ‰ï¼‰ã€‚","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://htchz.cc/categories/åˆ†å¸ƒå¼/"}],"tags":[{"name":"raft","slug":"raft","permalink":"https://htchz.cc/tags/raft/"}]},{"title":"[k8s]k8séƒ¨ç½²è¸©å‘","slug":"k8s-k8séƒ¨ç½²è¸©å‘","date":"2019-08-25T06:06:02.000Z","updated":"2020-02-26T16:06:20.434Z","comments":true,"path":"2102019255.html","link":"","permalink":"https://htchz.cc/2102019255.html","excerpt":"","text":"1. å‰è¨€è‡ªå·±æ­ä¸ªk8sé›†ç¾¤ï¼Œè¸©äº†ä¸€äº›å‘ 2. é•œåƒkubeadm initå‘½ä»¤ä¼šå»k8s.gcr.ioæ‹‰é•œåƒï¼Œè¿™ä¸ªåœ°å€æ˜¯å¾—æŒ‚ä»£ç†æ‰èƒ½ä¸Šçš„ï¼ˆå¯ä»¥æŒ‡å®šåœ°å€å¿½ç•¥ä»£ç†ï¼‰ï¼Œå¯ä»¥ç”¨kubeadm config images pullå°è¯•ä¸€ä¸‹ï¼Œåæœ‰å…«ä¹æ˜¯ä¸è¡Œã€‚ä¸æƒ³æŒ‚ä»£ç†çš„è¯ï¼Œç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•ã€‚ å…ˆæ‰§è¡Œkubeadm config images liståˆ—å‡ºé•œåƒï¼Œè¾“å‡ºä¿¡æ¯ä¸­æœ‰ä¸¤è¡ŒWARNæ˜¯è·å–ç‰ˆæœ¬timeoutå¯ä»¥ä¸ç†ä¼šã€‚ æ¥ç€æŠŠåˆ—å‡ºæ¥çš„ä¿¡æ¯æ”¾åˆ°ä¸‹é¢çš„bashè„šæœ¬ä¸­ï¼Œè¿è¡Œè„šæœ¬å°±æŠŠé•œåƒä¸‹è½½å¥½å•¦(å…¶å®å°±æ˜¯ä»é˜¿é‡Œäº‘ä¸‹é•œåƒæ”¹tag)ã€‚ 123456789101112131415images=( # ä¸‹é¢çš„é•œåƒåº”è¯¥å»é™¤\"k8s.gcr.io\"çš„å‰ç¼€ï¼Œç‰ˆæœ¬æ¢æˆä¸Šé¢è·å–åˆ°çš„ç‰ˆæœ¬kube-apiserver:v1.15.3kube-controller-manager:v1.15.3kube-scheduler:v1.15.3kube-proxy:v1.15.3pause:3.1etcd:3.3.10coredns:1.3.1)for imageName in $&#123;images[@]&#125; ; do docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/$imageNamedone 3. tokenå’Œca-cert-hashåœ¨masterè¿›è¡Œkubeadm initåä¼šè¾“å‡ºtokenå’Œca-cert-hashï¼Œè¿™ä¸ªè¦è®°ä½ï¼Œå¦‚æœå¿˜è®°äº†è™½ç„¶å¯ä»¥æ‰§è¡Œkubeadm token listè·å–tokenï¼Œä½†æ˜¯ca-cert-hashæ˜¯ä¸ä¼šè¾“å‡ºçš„ï¼Œå¿˜è®°ca-cert-hashåªèƒ½é‡æ–°æ‰§è¡Œkubeadm token createä»è¾“å‡ºä¸­æ‹¿åˆ°ã€‚ 4. ipè½¬å‘åœ¨nodeä¸»æœºæ‰§è¡Œkubeadm joinçš„æ—¶å€™ï¼ŒæŠ¥ [ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1`æ„æ€æ˜¯æ²¡æœ‰å¼€å¯ipv4è½¬å‘ï¼Œè®¾ç½®ä¸€ä¸‹å°±å¥½äº†ï¼šecho 1 &gt; /proc/sys/net/ipv4/ip_forward 5. æ—¶é—´åŒæ­¥åœ¨nodeä¸»æœºæ‰§è¡Œkubeadm joinçš„æ—¶å€™ï¼Œä¸€ç›´å¡ä½ï¼ŒåŠ ä¸Š--v=2å¯ä»¥è¾“å‡ºè¯¦ç»†ä¿¡æ¯ï¼Œè¾“å‡ºäº†ä¸€ä¸ªä¿¡æ¯ I0824 21:58:46.950161 16866 token.go:146] [discovery] Failed to request cluster info, will try again: [Get https://192.168.0.113:6443/api/v1/namespaces/kube-public/configmaps/cluster-info: x509: certificate has expired or is not yet valid]`ä½†æ˜¯æˆ‘çš„è¯ä¹¦æ²¡è¿‡æœŸå‘€ï¼Œåœ¨ä¸€ä¸ªissueé‡Œä¸€ä½è€å“¥è¯´æ˜¯ä¸æ˜¯å‡ å°æœºå™¨æ—¶é—´æ²¡åŒæ­¥ï¼Œæˆ‘åœ¨nodeä¸»æœºä¸Šæ‰§è¡Œdateï¼Œæœç„¶æ—¶é—´å’Œmasterå·®äº†å¥½ä¹…ï¼Œç”¨äºæ˜¯ntpå‘½ä»¤åŒæ­¥äº†ä¸€ä¸‹æ—¶é—´ã€‚ 12yum install -y ntpdatentpdate cn.pool.ntp.org 6. hostnameåœ¨nodeä¸»æœºæ‰§è¡Œkubeadm joinçš„æ—¶å€™ï¼Œè¦ç”¨--node-nameæŒ‡å®šèŠ‚ç‚¹åå­—ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œä¼šç”¨hostnameï¼Œå¦‚æœä½ å’Œæˆ‘ä¸€æ ·ä¸»æœºæ˜¯ç”¨vmwareå…‹éš†å‡ºæ¥çš„ï¼Œå‡ å°æœºå™¨çš„hostnameéƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°±ä¼šæ‰§è¡Œkubeadm joinæˆåŠŸï¼Œkubectl get nodesåªæœ‰ä¸€å°master(ä¸‰å°æœºhostnameéƒ½æ˜¯master)ï¼Œkubectl get pods --namespace kube-systemçš„podä¹Ÿéƒ½åªæœ‰ä¸€ä»½ã€‚ 7. ç½‘æ¡¥åœ°å€é‡å¤failed to set bridge addr: &quot;cni0&quot; already has an IP address different from 10.244.1.1/24ï¼Œæ‰§è¡Œip link delete cin0åˆ é™¤cni0ç½‘æ¡¥ã€‚ 8. dashboard 404é”™è¯¯è¾“å…¥tokenåæ˜¾ç¤ºçš„æ˜¯404ï¼Œæ‰§è¡Œkubectl logså‘ç°æ‰¾ä¸åˆ°æŸäº›Resourceï¼ŒæŸ¥çœ‹iusseï¼Œdashboard v1.Xå’Œæ–°ç‰ˆçš„k8sä¸å…¼å®¹ï¼Œå‡åˆ°v2.xå°±å¥½äº†ã€‚ä¸è¿‡v2.xè¿˜æ²¡æœ‰æ­£å¼ç‰ˆã€‚ #","categories":[{"name":"å®¹å™¨","slug":"å®¹å™¨","permalink":"https://htchz.cc/categories/å®¹å™¨/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://htchz.cc/tags/k8s/"},{"name":"deploy","slug":"deploy","permalink":"https://htchz.cc/tags/deploy/"}]},{"title":"[ç½‘ç»œ]åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªurlåˆ°é¡µé¢å±•ç°å‘ç”Ÿäº†ä»€ä¹ˆ","slug":"ç½‘ç»œ-åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªurlåˆ°é¡µé¢å±•ç°å‘ç”Ÿäº†ä»€ä¹ˆ","date":"2019-08-20T17:01:46.000Z","updated":"2020-06-11T04:10:48.382Z","comments":true,"path":"334107480.html","link":"","permalink":"https://htchz.cc/334107480.html","excerpt":"","text":"1. å‰è¨€è¢«é—®èµ·çš„æ—¶å€™æ€»æ˜¯ä¸¤ä¸‰å¥è¯å°±ç»“æŸäº†ã€‚è¿™ä¸€æ¬¡æƒ³å¥½å¥½æ€»ç»“ï¼Œæè¿°æˆ‘æ‰€çŸ¥é“çš„æµç¨‹ã€‚ 2. è¿‡ç¨‹2.1. DNSå‘DNSå‘èµ·è¯·æ±‚ï¼Œé€šå¸¸æ˜¯udpåè®®ï¼Œè·å¾—åŸŸåå¯¹åº”çš„ipåœ°å€ã€‚ æŸ¥æ‰¾é¡ºåºæ˜¯ï¼šæµè§ˆå™¨ç¼“å­˜ -&gt; æ“ä½œç³»ç»Ÿç¼“å­˜ -&gt; è·¯ç”±å™¨ç¼“å­˜ -&gt; ISPçš„DNSç¼“å­˜ -&gt; æ ¹æœåŠ¡å™¨ 2.2. ARPå¦‚æœä¸æ˜¯åŒä¸€ç½‘ç»œçš„åœ°å€ï¼ŒæŒ‰ç…§è·¯ç”±è¡¨æ‰¾ä¸‹ä¸€è·³çš„ipï¼Œé€šè¿‡å¹¿æ’­ARPè¯·æ±‚è·å¾—ä¸‹ä¸€è·³macåœ°å€ï¼Œå°†æŠ¥æ–‡å‘å¾€æ­¤åœ°å€ã€‚ ç›®æ ‡ç½‘ç»œçš„ç½‘å…³æ¥æ”¶åˆ°æ­¤æŠ¥æ–‡åï¼ŒåŒæ ·å‘èµ·ARPå¹¿æ’­è¯·æ±‚ï¼Œå¯»æ‰¾ç›®æ ‡ipå¯¹åº”çš„macåœ°å€ï¼Œå°†æŠ¥æ–‡å‘å¾€æ­¤åœ°å€ã€‚ 2.3. TCPä¸‰æ¬¡æ¡æ‰‹å‘é€ç«¯éšæœºé€‰æ‹©ä¸€ä¸ªç«¯å£å’Œæ¥æ”¶ç«¯ç«¯å£ä¹‹é—´å‘èµ·ä¸‰æ¬¡æ¡æ‰‹ï¼Œä¹‹åå»ºç«‹èµ·TCPè¿æ¥ã€‚ Linuxæ‰§è¡Œsysctl -a|grep ip_local_port_rangeå¯ä»¥çœ‹åˆ°éšæœºç«¯å£é€‰æ‹©èŒƒå›´ 2.4. MSSåå•†ä¸TCPåˆ†æ®µMSSï¼ŒMaximum Segment Sizeï¼ŒTCPæŠ¥æ–‡æ•°æ®ä¸èƒ½å¤§äºè¿™ä¸ªå€¼ï¼ŒMSS = MTU - IPé¦–éƒ¨é•¿åº¦ï¼Œ20 - TCPé¦–éƒ¨é•¿åº¦ï¼Œ20 ä¸ºäº†å¾—å‡ºè·¯å¾„æœ€å°MSSï¼ŒTCPä¸€ç«¯è®¾ç½®IPæŠ¥æ–‡\bDFæ ‡å¿—ï¼ˆDonâ€™t Fragment flagï¼‰å‘Šè¯‰IPå±‚ä¸è¦åˆ†ç‰‡ï¼Œè¿™æ ·IPå¿…é¡»åˆ†ç‰‡çš„æ—¶å€™ï¼Œå°±ä¼šä¼ å›ä¸€ä¸ªICMPå·®é”™æŠ¥æ–‡ã€‚ é«˜çº§çš„ICMPå·®é”™æŠ¥æ–‡ä¼šè¿”å›å‘ç”Ÿå·®é”™çš„MTUå¤§å°ï¼Œå¦‚æœICMPå·®é”™æŠ¥æ–‡æ²¡æœ‰å¸¦å›MTUå¤§å°ï¼Œéœ€è¦å‘é€ç«¯ä¸æ–­å‡å°‘MSSå¹¶é‡å‘æŠ¥æ–‡ï¼Œå¾—å‡ºåˆé€‚çš„MSSã€‚æ³¨æ„ï¼Œä¸€æ®µæ—¶é—´åTCPä¼šé‡æ–°åå•†è·¯å¾„æœ€å°MSSï¼Œè°ƒæ•´è·¯å¾„æœ€å°MSSã€‚ å°†ä¸€ä¸ªæ•°æ®åˆ†ç»„æ ¹æ®MSSæ‹†æˆå¤šä¸ªTCPæŠ¥æ–‡ï¼Œè¿™å°±æ˜¯TCPåˆ†æ®µã€‚ 2.5. HTTPå»ºç«‹èµ·è¿æ¥ä¹‹åï¼Œå‘é€HTTPæŠ¥æ–‡ã€‚HTTPç”±è¯·æ±‚è¡Œã€è¯·æ±‚å¤´ã€è¯·æ±‚ä¸»ä½“ç»„æˆã€‚ è¯·æ±‚è¡Œåªæœ‰ä¸€è¡Œï¼Œç”±æ–¹æ³•ï¼Œpathï¼Œåè®®ç‰ˆæœ¬ï¼Œä»¥ä¸€ä¸ª\\r\\nç»“æŸã€‚ è¯·æ±‚å¤´ç”±å¤šå¯¹key-valueç»„ç»‡è€Œæˆï¼Œä»¥ä¸€ä¸ª\\r\\næ¢è¡Œï¼Œä»¥ä¸¤ä¸ª\\r\\nç»“æŸã€‚ è¯·æ±‚ä¸»ä½“ï¼ŒåŒ…å«è¯·æ±‚çš„æ•°æ®/å“åº”æ•°æ®ã€‚ http1.1ç‰ˆæœ¬åŠ å…¥äº†Connection:Keep-Alive,ä½¿å¾—ä¸€ä¸ªTCPè¿æ¥å¯ä»¥å¤ç”¨å¤šæ¬¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè¯·æ±‚å»ºç«‹èµ·ä¸€æ¬¡è¿æ¥ã€‚http2ç‰ˆæœ¬åŠ å…¥TCPå¤šè·¯å¤ç”¨ã€‚è™½ç„¶http1.1ç‰ˆæœ¬å¯ä»¥å¤ç”¨TCPè¿æ¥ï¼Œä½†æ˜¯ä¸€æ¬¡åªèƒ½å‘ä¸€ä¸ªHTTPè¯·æ±‚æŠ¥æ–‡ï¼Œæƒ³è¦å¹¶è¡Œå‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œè¿½èƒ½å¤šå»ºç«‹TCPè¿æ¥ï¼Œè€Œæµè§ˆå™¨ä¸€èˆ¬ä¼šé™åˆ¶å¹¶å‘6ï½8ä¸ªè¿æ¥ï¼Œå…¶ä½™è¯·æ±‚åªèƒ½æ’é˜Ÿã€‚åŠ å…¥TCPå¤šè·¯å¤ç”¨ä¹‹åï¼Œå‡å°‘äº†è¿æ¥ï¼›æ­¤å¤–http2é‡‡ç”¨äº†äºŒè¿›åˆ¶ä¼ è¾“ï¼Œå¤´éƒ¨å‹ç¼©å¤§å¹…æé«˜äº†æ€§èƒ½ã€‚è™½ç„¶äºŒè¿›åˆ¶ä¼ è¾“åœ¨è°ƒè¯•è¿‡ç¨‹ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯è°ƒè¯•å·¥å…·éƒ½ä¼šå¸®æˆ‘ä»¬è½¬æˆæ˜æ–‡æ ¼å¼å±•ç¤ºã€‚ æ›´å¤šä¿¡æ¯http2å¯å‚è§å†è°ˆHTTP2æ€§èƒ½æå‡ä¹‹èƒŒååŸç†â€”HTTP2å†å²è§£å‰–ã€‚æœ¬ç«™ä¹Ÿæœ‰å¯ç”¨http2ã€‚ 2.6. HTTPSå¦‚æœå¯ç”¨ç”¨HTTPSï¼Œå®¢æˆ·ç«¯ä¼šæ ¡éªŒæœåŠ¡ç«¯çš„è¯ä¹¦ï¼Œæ ¹æ®è¯ä¹¦å’ŒæœåŠ¡å™¨åå•†ä¸€ä¸ªå¯¹ç§°åŠ å¯†ç®—æ³•å’Œä¸€ä¸ªå¯†é’¥ï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯RSAéå¯¹ç§°åŠ å¯†ï¼Œä¹‹åå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¼šä½¿ç”¨è¿™ä¸ªç®—æ³•å’Œå¯†é’¥è¿›è¡Œæ•°æ®åŠ å¯†ä¼ è¾“ã€‚HTTPSçš„åŸç†å‡ºé—¨å·¦è½¬TLSå®Œå…¨æŒ‡å—ï¼ˆä¸€ï¼‰ï¼šTLSå’Œå®‰å…¨é€šä¿¡ï¼Œè¿™æ–‡ç« è®²äº†HTTPSçš„éƒ¨åˆ†å†…å®¹ï¼Œä¸»è¦å†…å®¹æ˜¯è¯ä¹¦æ–¹é¢çš„å†…å®¹ï¼›è¿˜æœ‰ä¸€éƒ¨åˆ†å†…å®¹çœ‹å›¾è§£SSL/TLSåè®®ï¼Œä¸»è¦è¡¥å……äº†ç”¨DHç®—æ³•ä»£æ›¿RSAè¿›è¡Œå¯†é’¥äº¤æ¢ï¼Œé¿å…äº†å¯†é’¥åœ¨ç½‘ç»œä¸­ä¼ è¾“ã€‚ 2.7. TCPæ‹¥å¡æ§åˆ¶TCPéœ€è¦æ‹¥å¡æ§åˆ¶é€»è¾‘ä½¿ç”¨ç½‘ç»œä¸å¥½çš„æƒ…å†µï¼Œè¯¦è§TCPæ‹¥å¡æ§åˆ¶é‚£äº›äº‹ã€‚ 2.8. åº”ç”¨å…³äºåº”ç”¨å±‚, å¤§å¤šæ•°æ˜¯è¯·æ±‚èµ°cdn-&gt; 2.9. TCPå››æ¬¡æŒ¥æ‰‹å‘é€ç«¯å’Œæ¥æ”¶ç«¯ä¹‹é—´è¿›è¡Œå››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥ï¼Œæ¥ç€ä¸»åŠ¨æ–­å¼€çš„ç«¯å£è¿›å…¥FIN_WAIT_1ï¼Œæ”¶åˆ°ACKæŠ¥æ–‡åè¿›å…¥FIN_WAIT_2,æ”¶åˆ°æ¥æ”¶ç«¯çš„FINæŠ¥æ–‡åæœ€ç»ˆä¼šè¿›å…¥TIME_WAITçŠ¶æ€ï¼Œ é»˜è®¤ä¿æŒ2MSLçš„ä¸å¯ç”¨æ—¶é—´ï¼Œé˜²æ­¢ç›¸åŒäº”å…ƒç»„çš„è¿æ¥å»ºç«‹åï¼Œæ”¶åˆ°ä¸Šä¸€ä»£è¿æ¥çš„é‡å¤æŠ¥æ–‡ï¼Œè€Œäº§ç”Ÿæ··ä¹±ã€‚è¢«åŠ¨æ–­å¼€çš„ç«¯å£å…ˆè¿›å…¥CLOSE_WAITï¼Œç”±æœåŠ¡å™¨æ‰§è¡Œæ–­å¼€åå‘é€FINæŠ¥æ–‡è¿›å…¥LAST_ACKçŠ¶æ€ï¼Œæ”¶åˆ°å®¢æˆ·ç«¯ACKæŠ¥æ–‡è¿›å…¥CLOSEDçŠ¶æ€ã€‚ 3. åè®°è¿™ä¸ªé—®é¢˜èƒ½åæ˜ å‡ºå¯¹è®¡ç®—æœºçš„ç½‘ç»œçš„äº†è§£ï¼Œå…¶å®ç®—æ˜¯ä¸€ä¸ªèƒ½æ‰¯å¾ˆä¹…çš„é—®é¢˜ã€‚","categories":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"https://htchz.cc/categories/ç½‘ç»œ/"}],"tags":[{"name":"TCP","slug":"TCP","permalink":"https://htchz.cc/tags/TCP/"},{"name":"HTTP","slug":"HTTP","permalink":"https://htchz.cc/tags/HTTP/"}]},{"title":"[åˆ†å¸ƒå¼]Raftå’ŒZABçš„å¼‚åŒ","slug":"åˆ†å¸ƒå¼-Raftå’ŒZABçš„å¼‚åŒ","date":"2019-08-18T11:28:38.000Z","updated":"2020-06-18T14:22:32.262Z","comments":true,"path":"3841980432.html","link":"","permalink":"https://htchz.cc/3841980432.html","excerpt":"","text":"1. å‰è¨€ä¸ºäº†å­¦ä¹ etcd,å…ˆå­¦ä¹ äº†è§£ä¸€ä¸‹Raftåè®®ï¼Œæƒ³æ€»ç»“ä¸€ä¸‹Raftå’Œzookeeperçš„ZABåè®®åè®®çš„å¼‚åŒã€‚ ZABæ˜¯å¯¹PAXOSç®—æ³•çš„æ”¹è¿›ï¼ˆæ²¡çœ‹è¿‡PASXOSï¼Œå¥½åƒæ²¡æœ‰leaderæ¦‚å¿µï¼Œæˆ‘ç›´æ¥çœ‹çš„ZABï¼‰ï¼Œå¢åŠ äº†leaderã€followerã€learnerçš„è§’è‰²ã€‚ Raftè‡ªç§°æ˜¯æ¯”PAXOSæ›´å®¹æ˜“ç†è§£çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œå’ŒZABä¸€æ ·æœ‰leaderã€followerï¼Œè€Œä¸”ä¸€ä¸ªå¼ºleaderçš„ç®—æ³•ã€‚ 2. æ—¶é—´Raftï¼šä½¿ç”¨ä»»æœŸtermè¡¨ç¤ºä¸€ä¸ªé€‰ä¸¾è½®æ¬¡ã€‚ ZABï¼šä½¿ç”¨electionEpochè¡¨ç¤ºä¸€ä¸ªé€‰ä¸¾è½®æ¬¡ã€‚ 3. é€‰ä¸¾3.1. æŠ•ç¥¨Raftï¼šå¿½ç•¥ä¸Šä¸€è½®æŠ•ç¥¨ã€‚é€‰ä¸¾è¿‡ç¨‹åªèƒ½è¿›è¡Œä¸€æ¬¡æŠ•ç¥¨ï¼Œå¦‚æœæŠ•è¿‡ç¥¨äº†ï¼Œæ”¶åˆ°æŠ•ç¥¨è¯·æ±‚å°±ä¼šæ— è§†ã€‚è¿™æ ·è¶Šæ—©å‘èµ·æŠ•ç¥¨çš„äººè¶Šæœ‰å¯èƒ½å½“leaderï¼›åŒæ—¶ï¼Œä¹Ÿå¯èƒ½å‡ºç°æ¯ä¸ªèŠ‚ç‚¹éƒ½æ²¡æœ‰æ”¶åˆ°majorityçš„æŠ•ç¥¨ï¼Œå‡ºç°æŠ•ç¥¨è¢«ç“œåˆ†çš„æƒ…å†µã€‚Rafté‡‡ç”¨è®¾ç½®éšæœºçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´æ¥è§£å†³æŠ•ç¥¨è¢«ç“œåˆ†ã€‚ ZABï¼šå¿½ç•¥ä¸Šä¸€è½®æŠ•ç¥¨ã€‚æ¯æ¬¡æ”¶åˆ°æŠ•ç¥¨è¯·æ±‚éƒ½ä¼šè¿›è¡Œåˆ¤å®šï¼Œç„¶åè‹¥è‡ªå·±çš„æŠ•ç¥¨æœ‰å˜ï¼Œä¼šé‡æ–°é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹ã€‚è¿™æ ·ä¸ä¼šå‡ºç°æŠ•ç¥¨è¢«ç“œåˆ†ï¼Œä½†æ˜¯æ—¶é—´ä¼šæ¯”Raftå¤šå¾ˆå¤šï¼Œå¯¼è‡´æœåŠ¡å¯ç”¨æ€§é™ä½ã€‚ 3.2. æŠ•ç¥¨pkRaftï¼štermå¤§çš„èƒœå‡ºï¼Œç›¸åŒæ—¶indexå¤§çš„èƒœå‡º ZABï¼šelectionEpochå¤§çš„èƒœå‡ºï¼Œç›¸åŒæ—¶zxidå¤§çš„èƒœå‡º 3.3. æŠ•ç¥¨ç»“æœRaftï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½åªæœ‰è‡ªå·±çš„æŠ•ç¥¨ç»“æœï¼Œå¦‚æœå‘ç°è‡ªå·±æŠ•ç¥¨è¿‡åŠï¼Œè¦é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶å‘é€å¿ƒè·³ï¼Œå¿ƒè·³é—´éš” &lt; é€‰ä¸¾è¶…æ—¶æ—¶é—´. ZABï¼šæ¯ä¸ªèŠ‚ç‚¹ä¿å­˜æ‰€æœ‰èŠ‚ç‚¹çš„ç¥¨æ ¹ä¿¡æ¯ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ”¶åˆ°æŠ•ç¥¨è¯·æ±‚åéƒ½ä¼šæ£€æŸ¥æ˜¯å¦æœ‰è¿‡åŠçš„ç¥¨æ ¹ï¼Œå¦‚æœæœ‰ï¼Œä¼šå’Œleaderå»ºç«‹èµ·ä¸€ä¸ªè¿æ¥ï¼Œleaderä¼šå‘é€å¿ƒè·³ã€‚ 3.4. é€‰ä¸¾ç»“æŸRaftï¼šé€‰ä¸¾å®Œå¯ä»¥ç«‹åˆ»æä¾›æœåŠ¡ï¼Œå¯¹äºèŠ‚ç‚¹ä¸ä¸€è‡´çš„é—®é¢˜ï¼ŒRafté æ¥ä¸‹æ¥é™„åŠ æ¡ç›®RPCæ¥é€æ¸ä¿®å¤ã€‚æŒ‰è®ºæ–‡è¯´çš„5å°èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œé‡æ–°é€‰ä¸¾å®Œæˆçš„æ—¶é—´å¹³å‡æ˜¯35msï¼Œæœ€é•¿æ˜¯150msï¼ˆé€‰ä¸¾è¶…æ—¶æ—¶é—´é…ç½®ä¸º12-24msï¼‰ã€‚ ZABï¼šé€‰ä¸¾å®Œå¾—å®Œæˆæ—¥å¿—åŒæ­¥æ‰èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œè€Œä¸”ZABçš„é€‰ä¸¾å¯èƒ½é•¿è¾¾ç§’çº§çš„æ—¶é—´ï¼Œå¯¼è‡´æœåŠ¡å¯ç”¨æ€§é™ä½ã€‚ 4. åˆ†åŒºå®¹é”™æ€§å½“ å¯ç”¨èŠ‚ç‚¹ &gt; N/2ï¼ŒRaftå’ŒZABçš„é›†ç¾¤éƒ½æ˜¯å¯ç”¨çš„ã€‚ 5. å®¢æˆ·ç«¯è¯·æ±‚5.1. è¯»ï¼ˆé’ˆå¯¹è¯»è¯·æ±‚è½åˆ°followerçš„æƒ…å†µï¼‰Raftï¼šRaftçš„è¯»å…¶å®æœ‰å‡ ä¸ªæ–¹æ¡ˆ å¼ºä¸€è‡´è¯»ï¼šè½¬å‘ç»™leaderï¼›leaderæ’å…¥ä¸€ä¸ªç©ºæ—¥å¿—è·å¾—readIndexï¼›å¿ƒè·³å¹¿æ’­(ç¡®è®¤è‡ªå·±æ˜¯leaderï¼Œæ‰èƒ½æ‹¥æœ‰æœ€æ–°æ—¥å¿—)ï¼›ç­‰å¾…çŠ¶æ€æœºapplyIndexç»è¿‡readIndexï¼ˆåŒæ­¥æœ€æ–°æ—¥å¿—æ¡ç›®ï¼‰ï¼›è¿”å›ç»™followerï¼›è¿”å›ç»™å®¢æˆ·ç«¯ï¼› åœ¨followerè¯»ï¼šä»leaderè·å¾—readIndexï¼›ç­‰å¾…applyIndexç»è¿‡readIndexï¼›æŸ¥è¯¢è‡ªèº«çŠ¶æ€æœºï¼›ï¼ˆä»leaderè·å¾—readIndexæ—¶ï¼Œleaderä¹Ÿè¦è¿›è¡Œå¿ƒè·³å¹¿æ’­ï¼‰ æŠ˜ä¸­æ–¹æ¡ˆï¼šleaderåœ¨æ¥å—åˆ°majorityå¿ƒè·³å“åº”åä¸€æ®µæ—¶é—´å†…ä¸å¹¿æ’­ï¼Œè¿™æ˜¯è®ºæ–‡ä½œè€…ä¸æ¨èçš„ï¼Œå› ä¸ºâ€œå“åº”åä¸€æ®µæ—¶é—´å†…â€è¿™ä¸ªæ—¶é—´å¯èƒ½æ˜¯ä¸å‡†ç¡®çš„ã€‚ ZABï¼šfollowerç›´æ¥è¿”å›ï¼Œå¦‚æœä¸€ä¸ªfollowerå’ŒleaderæœªåŒæ­¥å®Œæˆï¼Œfollowerè¿”å›çš„æ˜¯è„æ•°æ®ï¼Œå¦‚æœè¦ä¿è¯æ•°æ®æœ€æ–°ï¼Œéœ€è¦å®¢æˆ·ç«¯è°ƒç”¨sync()æ–¹æ³•åŒæ­¥æ•°æ®ï¼Œæ­£å¸¸æƒ…å†µä¸‹ZABåªä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚ 5.2. å†™5.2.1. ä¸»è¦æµç¨‹Raft: è½¬å‘ç»™leader; leaderå°†è¯·æ±‚å°è£…ä¸ºentriesï¼Œå†™å…¥æ—¥å¿—ï¼Œå¾—åˆ°åœ¨æ—¥å¿—ä¸­çš„indexï¼Œè¿åŒentrieså‘é€ç»™followersï¼Œæ³¨æ„è¿™å¯ä»¥æ˜¯æ‰¹é‡çš„ followeræ‰§è¡Œæ¥æ”¶é€»è¾‘ï¼Œå¦‚æœæˆåŠŸå†™å…¥æ–‡ä»¶ï¼Œè¿”å›true leaderæ”¶åˆ°è¿‡åŠæˆåŠŸå›å¤å°±æ›´æ–°committIndexï¼ŒæŠŠentriesåº”ç”¨åˆ°çŠ¶æ€æœºä¸­ï¼Œå›å¤å®¢æˆ·ç«¯ leaderä¸‹æ¬¡å¿ƒè·³ä¼šå¸¦ä¸ŠcommittIndexçš„å€¼ç”¨leaderCommitè¡¨ç¤ºï¼Œfollowerså‘ç°leaderCommitå¤§äºè‡ªå·±ç»´æŠ¤çš„committIndexï¼Œå°±ä»¤ commitIndex ç­‰äº leaderCommit å’Œ æ–°æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼ä¸­è¾ƒå°çš„ä¸€ä¸ª ZABï¼šå…¸å‹çš„ä¸¤é˜¶æ®µæäº¤ è½¬å‘ç»™leader leaderå°è£…ä¸ºä¸€ä¸ªproposalï¼Œå†™å…¥æ—¥å¿—ï¼Œå‘é€ç»™followers followeræ‰§è¡Œæ¥æ”¶é€»è¾‘ï¼Œå¦‚æœæˆåŠŸå†™å…¥æ–‡ä»¶ï¼Œè¿”å›true leaderæ”¶åˆ°è¿‡åŠæˆåŠŸå›å¤å°±æäº¤proposalï¼ŒåŒæ—¶å¹¿æ’­ä¸€ä¸ªcommitæ¶ˆæ¯ï¼Œé€šçŸ¥followersæäº¤æè®® 5.2.2. æ¥æ”¶é€»è¾‘Raftï¼šå¦‚æœprevLogIndexå’ŒprevLogTermä¸åŒ¹é…ï¼Œè¿”å›falseï¼Œç”±leaderè°ƒæ•´ï¼Œä»è€Œè¾¾åˆ°åœ¨å†™è¯·æ±‚å†åŒæ­¥æ•°æ®çš„ç›®çš„ ZABï¼šæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæ¥æ”¶åˆ°proposalå†™å…¥æ–‡ä»¶ï¼Œæ¥æ”¶åˆ°commitæäº¤æ—¥å¿— 6. æ—§leaderæ•°æ®è¿™ä¸ªæ˜¯æŒ‡æ—§leaderå´©æºƒåï¼Œæ–°leaderå¯¹æ—§æ•°æ®çš„å¤„ç† Raftï¼šä¿å®ˆï¼Œè¿‡åŠæˆ–æœªè¿‡åŠæ—¥å¿—éƒ½æ˜¯æœªæäº¤ã€‚åªèƒ½æäº¤å½“å‰termçš„æ—¥å¿—ï¼Œå¦‚æœæäº¤äº†å½“å‰æ—¥å¿—ï¼Œé‚£ä¹ˆæ—§termçš„æ—¥å¿—ä¹Ÿä¼šè¢«ä¸€æ³¢æäº¤ï¼ˆæ—§termçš„æ—¥å¿—åªèƒ½è¢«é—´æ¥æäº¤ï¼‰ã€‚å…è®¸å‡ºç°æœªæäº¤çš„æ•°æ®è¢«è¦†ç›–ã€‚ ZABï¼šæ¿€è¿›ï¼Œè¿‡åŠæˆ–æœªè¿‡åŠæ—¥å¿—éƒ½è¢«æäº¤ï¼Œç”±zookeeperé€‰ä¸¾å®Œæˆåçš„æ•°æ®åŒæ­¥å®Œæˆã€‚ 7. leaderå‡æ­»Raftï¼šleaderå’Œfolloweræ˜¯æ²¡æœ‰è¿æ¥çš„ã€‚æ—§leaderå‡æ­»åï¼Œæ–°leaderè¯ç”Ÿï¼Œæ—§leaderå¤æ´»åå‘é€å¸¦æœ‰æ—§termçš„RPCsï¼Œfolloweræ”¶åˆ°ä¹‹åè¿”å›æ–°termç»™æ—§leaderï¼Œæ—§leaderæ›´æ–°termï¼ŒåŠ å…¥followerå¤§å†›ã€‚ ZABï¼šleaderå’Œfollowerå­˜åœ¨è¿æ¥ã€‚æ—§leaderå‡æ­»åï¼Œè¿æ¥æ–­å¼€ï¼Œæ—§leaderè¿›å…¥LOOKINGçŠ¶æ€ï¼Œä»é›†ç¾¤ä¸­å­¦ä¹ æŠ•ç¥¨ç»“æœ/é‡æ–°é€‰ä¸¾ï¼Œæœ€ç»ˆæ‰¾åˆ°leaderå»ºç«‹èµ·è¿æ¥ã€‚ 8. è¯·æ±‚å¼‚å¸¸Raftï¼šé‡è¯•ï¼ŒRaftè¦ä¿è¯RPCsæ˜¯å¹‚ç­‰çš„ã€‚ ZABï¼šfollowerå’Œleaderæ–­å¼€è¿æ¥ï¼Œé‡æ–°åŠ å…¥é›†ç¾¤ 9. æŒ‚äº†çš„æœºå™¨åŠ å…¥ä¸€ä¸ªé€‰ä¸¾å®Œæˆçš„é›†ç¾¤ï¼ˆä¸æ˜¯æ–°åŠ æœºå™¨ï¼‰Raftï¼šleaderä¼šå¯¹followerè¿›è¡ŒRPCsé‡è¯•ï¼Œæ‰€ä»¥æ¢å¤çš„followerä¼šæ”¶åˆ°leaderçš„å¿ƒè·³è¯·æ±‚ã€‚ ZABï¼šæ¢å¤çš„followerä¼šå­¦ä¹ é›†ç¾¤ä¸­çš„æŠ•ç¥¨ç»“æœï¼Œå¯ä»¥è¯†åˆ«åˆ°leader 10. æ—¥å¿—å¤åˆ¶çš„é¡ºåºRaftï¼šç”±leaderç»´æŠ¤logé¡ºåºã€‚å¦‚æœfolloweré‡å¯ï¼Œä¸ä¼šé˜»å¡leaderå†™å…¥è¯·æ±‚ï¼Œä¼šæŒ‰ç…§leaderé¡ºåºè¿½èµ¶æ—¥å¿—ï¼›å¦‚æœleaderæŒ‚äº†ï¼Œæ–°leaderä¹Ÿå¯ä»¥å°†æ—§termã€æ–°termæ—¥å¿—æŒ‰é¡ºåºæäº¤ã€‚ ZABï¼šç”±leaderç»´æŠ¤logé¡ºåºã€‚å¦‚æœfolloweré‡å¯ï¼Œä¼šè·å–leaderè¯»é”ï¼Œleaderé˜»å¡å†™å…¥è¯·æ±‚ï¼Œæ¥ç€è¿½èµ¶å·®å¼‚ï¼Œè·å–leaderå·²æäº¤proposalå’Œæœªæäº¤proposalï¼Œç„¶åå†é‡Šæ”¾leaderè¯»é”ï¼›å¦‚æœleaderé‡å¯ï¼Œæ–°leaderé€‰ä¸¾åä¼šè¿›è¡Œæ•°æ®åŒæ­¥ 11. é›†ç¾¤æˆå‘˜å˜æ›´é›†ç¾¤é…ç½®ä¸èƒ½ä¸€ä¸‹å­å…¨åˆ‡æ¢ï¼Œå¦åˆ™åŒä¸€ä¸ªæ—¶æœŸå¯èƒ½ä¼šå‡ºç°ä¸¤ä¸ªleaderã€‚Raftï¼šä½¿ç”¨ä¸¤é˜¶æ®µå˜æ›´ã€‚æ—§é…ç½®ä¸ºC-oldï¼Œæ–°é…ç½®ä¸ºC-newï¼ŒC-old-newè¡¨ç¤ºä¸­é—´é…ç½®ã€‚é…ç½®å˜æ›´å‘½ä»¤ç”±å®¢æˆ·ç«¯å‘èµ·ï¼Œleaderä»¥logä¼ æ’­C-old-newï¼Œç­‰C-old-newæäº¤ä¹‹åï¼Œå†å¹¿æ’­C-newé…ç½®ï¼Œè¿™æ—¶ä¸åœ¨C-newé‡Œçš„æœºå™¨å°±è¦è‡ªè§‰é€€å‡ºã€‚Raftè®ºæ–‡å‚ä¸è€…åæ¥è¿˜æå‡ºä¸€ä¸ªä¸€é˜¶æ®µå˜æ›´ï¼Œæå‡ºé™åˆ¶ä¸€æ¬¡å˜æ›´åªèƒ½æ·»åŠ æˆ–åˆ é™¤ä¸€ä¸ªæˆå‘˜æ¥ç®€åŒ–é—®é¢˜ï¼Œå¦‚æœè¦å˜æ›´å¤šä¸ªæˆå‘˜ï¼Œéœ€è¦æ‰§è¡Œå¤šæ¬¡æˆå‘˜å˜æ›´ã€‚ ZABï¼š3.5ç‰ˆæœ¬ä»¥å‰æ˜¯åœæœºçš„ï¼Œä½†åœæœºå˜æ›´ä¹Ÿæœ‰é—®é¢˜ï¼Œ3.5å¼€å§‹ä½¿ç”¨äº†åŠ¨æ€å˜æ›´æˆå‘˜ï¼Œå‡ºé—¨å·¦è½¬Zabåè®®ä¸­çš„åŠ¨æ€æˆå‘˜å˜æ›´ï¼Œæ¯”Raftéš¾ç†è§£ğŸ˜ï¼Œåæ­£æˆ‘æ˜¯çœ‹ä¸ä¸‹å»ğŸ˜ã€‚ 12. æ€»ç»“Raftæ˜¯åœ¨æƒ³è§£å†³PAXOSè¿‡äºå¤æ‚çš„ç¼ºç‚¹çš„èƒŒæ™¯ä¸‹æå‡ºæ¥çš„ä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•ï¼Œä¹‹å‰ä¹Ÿçœ‹è¿‡ZABåè®®ï¼Œæ„Ÿè§‰Raftå¯ç”¨æ€§æ¯”ZABé«˜å¾ˆå¤šã€‚ ä¸è¿‡æœ‰ä¸ªé—®é¢˜è®©æˆ‘è¿·æƒ‘æ˜¯ï¼Œåœ¨ä¸¤é˜¶æ®µæˆå‘˜å˜æ›´æ–¹æ¡ˆé‡Œï¼Œå¦‚æœæäº¤äº†C-old-newåï¼Œè¿˜æœ‰æ—§çš„Server1ï¼ŒServer2æ²¡æœ‰å¤åˆ¶åˆ°ï¼ŒServer1ï¼ŒServer2çš„é…ç½®è¿˜æ˜¯C-oldè¿™æ—¶å€™Server1ï¼ŒServer2å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºï¼Œé‚£ä¹ˆè¿™ä¸¤å°æœåŠ¡å™¨è¿˜æ˜¯å¯ä»¥äº§ç”ŸåŸºäºC-oldçš„leaderï¼Œè€ŒServer3ï¼ŒServer4ï¼ŒServer5å½¢æˆå¦ä¸€ä¸ªmajorityï¼Œä¹Ÿå¯ä»¥äº§ç”Ÿä¸€ä¸ªleaderï¼Œä¸ä¸€æ ·è¿˜ä¼šå‡ºç°åŒleaderé—®é¢˜ä¹ˆï¼Ÿè‹¥ä½¿ç”¨ä¸€é˜¶æ®µæˆå‘˜å˜æ›´ï¼Œå°±å¯ä»¥é˜»æ­¢å¤šä¸ªmajorityäº§ç”Ÿï¼Œæœç»è¿™ç§æƒ…å†µå§ã€‚ å¾ˆæœ‰å…´è¶£å®ç°ä¸€ä¸ªRaftç®—æ³•ã€‚ 13. å‚è€ƒ \bå¯»æ‰¾ä¸€ç§æ˜“äºç†è§£çš„ä¸€è‡´æ€§ç®—æ³•ï¼ˆæ‰©å±•ç‰ˆï¼‰Raftè®ºæ–‡æ±‰åŒ– In Search of an Understandable Consensus Algorithm(Extended Version)Raftè®ºæ–‡åŸç‰ˆ Raftå¯¹æ¯”ZABåè®®","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://htchz.cc/categories/åˆ†å¸ƒå¼/"}],"tags":[{"name":"ä¸€è‡´æ€§ç®—æ³•","slug":"ä¸€è‡´æ€§ç®—æ³•","permalink":"https://htchz.cc/tags/ä¸€è‡´æ€§ç®—æ³•/"},{"name":"raft","slug":"raft","permalink":"https://htchz.cc/tags/raft/"},{"name":"ZAB","slug":"ZAB","permalink":"https://htchz.cc/tags/ZAB/"}]},{"title":"[ç½‘ç»œ]TCPæ‹¥å¡æ§åˆ¶é‚£äº›äº‹","slug":"ç½‘ç»œ-TCPæ‹¥å¡æ§åˆ¶é‚£äº›äº‹","date":"2019-08-15T02:05:00.000Z","updated":"2020-06-08T09:53:39.710Z","comments":true,"path":"3284953854.html","link":"","permalink":"https://htchz.cc/3284953854.html","excerpt":"","text":"1. å‰è¨€çœ‹å®Œäº†ã€ŠTCP/IPè¯¦è§£ å·ä¸€ã€‹ï¼Œå¯¹TCP/IPåè®®ç°‡çš„è®¤çŸ¥å¤šäº†ä¸€äº›ã€‚æ€»ç»“ä¸€ä¸‹TCPçª—å£æœ‰å…³çš„æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤çš„æ¦‚å¿µã€‚ 2. TCPæ»‘åŠ¨çª—å£çª—å£æœ‰ä¸¤ç§ï¼Œé€šå‘Šçª—å£(Receiver Window,rwnd)å’Œæ‹¥å¡çª—å£(Congestion Window,cwnd)ã€‚ é€šå‘Šçª—å£ï¼šé€šå‘Šçª—å£è¡¨æ˜äº†æ¥æ”¶ç«¯å½“å‰çš„æ¥å—èƒ½åŠ›ã€‚TCPåœ¨å‘é€ç«¯å’Œæ¥æ”¶ç«¯éƒ½æ˜¯æœ‰ç¼“å†²åŒºçš„ï¼Œé€šå‘Šçª—å£å£°æ˜äº†å½“å‰æ¥æ”¶ç«¯çš„ç¼“å†²åŒºè¿˜èƒ½æ¥æ”¶çš„å­—èŠ‚å¤§å°ã€‚è¿™ä¸ªæ•°å€¼ä¼šåœ¨TCPæŠ¥æ–‡é‡Œæºå¸¦ã€‚ æ‹¥å¡çª—å£ï¼šæ‹¥å¡çª—å£ä¸è¢«TCPæŠ¥æ–‡ä¼ è¾“ï¼Œæ˜¯å‘é€ç«¯åŸºäºæ‹¥å¡é¿å…ç®—æ³•ç®—å‡ºæ¥çš„ä¸€ä¸ªçª—å£ã€‚è¿™ä¸ªçª—å£é™åˆ¶äº†å‘é€æ–¹çš„å‘é€é€Ÿç‡é¿å…ç½‘ç»œæ‹¥å¡ã€‚ ä¸¤ä¸ªçª—å£å…±åŒç»„æˆäº†ä¸€ä¸ªæ»‘åŠ¨çª—å£ã€‚ç®€å•æ¥è¯´ï¼Œé€šå‘Šçª—å£æ˜¯å¼ºåˆ¶é™åˆ¶ï¼Œæ‹¥å¡çª—å£æ˜¯è‡ªå‘é™åˆ¶ã€‚ æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼Œçª—å£çš„å•ä½ç”¨å­—èŠ‚è¡¨ç¤ºï¼Œä½†æ˜¯æ‹¥å¡çª—å£çš„è°ƒæ•´æ€»æ˜¯ä»¥ä¸€ä¸ªMSSçš„å€æ•°æ¥è°ƒæ•´ã€‚ è¿™é‡Œç”¨ä¹¦ä¸Šçš„å›¾æè¿°æ»‘åŠ¨çª—å£ï¼Œå½“ä¸€ä¸ªTCPå‘é€æ–¹å‘é€æ•°æ®çš„æ—¶å€™å°±ä¼šæŸ¥çœ‹å¯ç”¨çª—å£èƒ½å¦å‘é€ï¼ˆå¦‚æœå¯ç”¨äº†Nagleç®—æ³•ï¼Œå¯ç”¨çª—å£å¿…é¡»å¤§äºç­‰äºä¸€ä¸ªMSSï¼Œå‘é€æ–¹æ‰å‘é€æ•°æ®ï¼‰ ä¸Šé¢æ˜¯æŠ“åŒ…å¾—åˆ°çš„ä¸€ä¸ªæŠ¥æ–‡ï¼ŒWin=2027æ˜¯ä¸€ä¸ªé€šå‘Šçª—å£ï¼Œè¡¨ç¤ºæœåŠ¡å™¨çš„ç¼“å†²åŒºè¿˜èƒ½æ¥å—2027å­—èŠ‚çš„æ•°æ®ã€‚ 3. æ‹¥å¡æ§åˆ¶ä¸Šå›¾æ˜¯ä¸€ä¸ªtcpåˆšå¼€å§‹ä¼ è¾“æ•°æ®æ—¶çš„é€Ÿç‡å˜åŒ–èµ°å‘ã€‚ æ‹¥å¡é¿å…ã€æ…¢å¯åŠ¨ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤è¿™å››ä¸ªè¯å…¶å®å¹¶ä¸èƒ½å•ç‹¬åˆ†å¼€è®²ã€‚å½“ä¸€ä¸ªè¿æ¥çš„ç½‘ç»œæƒ…å†µä¸å¥½çš„æ—¶å€™ï¼Œå°±ä¼šä¸¢åŒ…æˆ–è¶…æ—¶ï¼Œè¿™æ—¶å°±è¦é™ä½å‘é€æ–¹çš„å‘é€é€Ÿç‡é˜²æ­¢æ¶åŒ–ï¼Œè¿™ç§å°±æ˜¯æ‹¥å¡æ§åˆ¶ã€‚ è¿™ç§æœºåˆ¶æ¶‰åŠåˆ°cwndå’Œssthreshä¸¤ä¸ªæŒ‡æ ‡ï¼Œssthreshæ˜¯ä¸€ä¸ªåŒºåˆ†æ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…çš„é˜ˆå€¼ï¼Œå½“æ‹¥å¡å‘ç”Ÿæ—¶ï¼Œåˆ†ä¸¤ç§æƒ…å†µè¶…æ—¶ï¼šssthresh = cwnd / 2ï¼ˆæœ€å°ä¸º2MSSï¼‰ï¼Œcwnd = 1MSSï¼Œè¿›å…¥æ…¢å¯åŠ¨ä¸¢åŒ…ï¼šssthresh = cwnd / 2ï¼ˆæœ€å°ä¸º2MSSï¼‰ï¼Œcwnd = ssthresh + 3MSSï¼Œè¿›å…¥å¿«é€Ÿé‡ä¼  4. æ…¢å¯åŠ¨æ…¢å¯åŠ¨å…¶å®æ˜¯å‘é€é€Ÿç‡é‡æ–°è®¡ç®—ï¼Œcwnd åˆå§‹å€¼ä¸ºä¸€ä¸ªæ•°æ®æŠ¥å¤§å°ï¼Œssthreshåˆå§‹å€¼ä¸º65535ï¼Œæ˜¯ä¸€ä¸ªç„¶ååœ¨åˆ°è¾¾é˜ˆå€¼ä¹‹å‰ï¼Œæ¯æ¥æ”¶åˆ°ä¸€ä¸ªæ–°çš„ACKï¼Œcwndå°±ä¼šå¢åŠ ä¸€ä¸ªæŠ¥æ–‡æ®µçš„å¤§å°ï¼Œè¿™æ ·å­æ…¢å¯åŠ¨å…¶å®æ˜¯ä»¥æŒ‡æ•°å¢åŠ é€Ÿç‡. 5. æ‹¥å¡æ§åˆ¶ä¸Šå›¾æ˜¯ä¸€ä¸ªtcpåˆšå¼€å§‹ä¼ è¾“æ•°æ®æ—¶çš„é€Ÿç‡å˜åŒ–èµ°å‘ã€‚ æ‹¥å¡é¿å…ã€æ…¢å¯åŠ¨ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤è¿™å››ä¸ªè¯å…¶å®å¹¶ä¸èƒ½å•ç‹¬åˆ†å¼€è®²ã€‚å½“ä¸€ä¸ªè¿æ¥çš„ç½‘ç»œæƒ…å†µä¸å¥½çš„æ—¶å€™ï¼Œå°±ä¼šä¸¢åŒ…æˆ–è¶…æ—¶ï¼Œè¿™æ—¶å°±è¦é™ä½å‘é€æ–¹çš„å‘é€é€Ÿç‡é˜²æ­¢æ¶åŒ–ï¼Œè¿™ç§å°±æ˜¯æ‹¥å¡æ§åˆ¶ã€‚ è¿™ç§æœºåˆ¶æ¶‰åŠåˆ°cwndå’Œssthreshä¸¤ä¸ªæŒ‡æ ‡ï¼Œssthreshæ˜¯ä¸€ä¸ªåŒºåˆ†æ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…çš„é˜ˆå€¼ï¼Œå½“æ‹¥å¡å‘ç”Ÿæ—¶ï¼Œåˆ†ä¸¤ç§æƒ…å†µè¶…æ—¶ï¼šssthresh = cwnd / 2ï¼ˆæœ€å°ä¸º2MSSï¼‰ï¼Œcwnd = 1MSSï¼Œè¿›å…¥æ…¢å¯åŠ¨ä¸¢åŒ…ï¼šè¿›å…¥å¿«é€Ÿé‡ä¼  5.1. æ…¢å¯åŠ¨æ…¢å¯åŠ¨å…¶å®æ˜¯å‘é€é€Ÿç‡é‡æ–°è®¡ç®—ï¼Œcwnd åˆå§‹å€¼ä¸ºä¸€ä¸ªæ•°æ®æŠ¥å¤§å°ï¼Œssthreshåˆå§‹å€¼ä¸º65535ï¼Œæ˜¯ä¸€ä¸ªç„¶ååœ¨åˆ°è¾¾é˜ˆå€¼ä¹‹å‰ï¼Œæ¯æ¥æ”¶åˆ°ä¸€ä¸ªæ–°çš„ACKï¼Œcwndå°±ä¼šå¢åŠ ä¸€ä¸ªæŠ¥æ–‡æ®µçš„å¤§å°ï¼Œè¿™æ ·å­æ…¢å¯åŠ¨å…¶å®æ˜¯ä»¥æŒ‡æ•°å¢åŠ ç½‘é€Ÿåˆ°ä¸€ä¸ªæ¯”è¾ƒå¹³è¡¡çš„æ°´å¹³ã€‚ 5.2. æ‹¥å¡é¿å…å½“cwndå¤§äºç­‰äºssthreshæ—¶è¿›å…¥æ‹¥å¡é¿å…çŠ¶æ€ï¼Œåœ¨ä¸€ä¸ªRTTå†…æ— è®ºæ”¶åˆ°å¤šå°‘ACKéƒ½åªå°†cwndå¢åŠ ä¸€ä¸ªæŠ¥æ–‡å¤§å°ï¼Œä»æ—¶é—´ä¸Šæ¥çœ‹ç½‘é€Ÿçº¿æ€§å¢åŠ ã€‚ 5.3. å¿«é€Ÿé‡ä¼ å’Œå¿«é€Ÿæ¢å¤å¿«é€Ÿé‡ä¼ æŒ‡ï¼Œå½“æ”¶åˆ°é‡å¤çš„3ä¸ªACKæŠ¥æ–‡æ—¶ï¼ˆduplicate ackï¼‰ï¼Œè®¾ç½®ssthresh = cwnd / 2ï¼ˆæœ€å°ä¸º2MSSï¼‰ï¼Œcwnd = ssthresh + 3MSSï¼Œç„¶åè¿›å…¥å¿«é€Ÿæ¢å¤é˜¶æ®µã€‚ æš‚åœå‘é€æ–°çš„æŠ¥æ–‡ï¼Œé‡ä¼ ä¸¢å¤±æŠ¥æ–‡ã€‚ æ¥ä¸‹æ¥æ¯æ”¶åˆ°é‡å¤çš„ACKæ—¶ï¼Œå°†cwndå¢åŠ ä¸€ä¸ªæŠ¥æ–‡å¤§å°ã€‚å¦‚æœcwndå¤§äºæœªç¡®è®¤æŠ¥æ–‡å¤§å°ï¼ˆæŠ¥æ–‡ä¸¢å¤±åæˆ‘ä»¬è¿˜åœ¨å‘æ–°çš„æŠ¥æ–‡ï¼Œæœªç¡®è®¤æŠ¥æ–‡æŒ‡ä¸¢å¤±æŠ¥æ–‡åˆ°æœ€åä¸€ä¸ªæŠ¥æ–‡ä¹‹é—´æŠ¥æ–‡æ€»å¤§å°ï¼‰ï¼Œå¯ä»¥å‘é€æ–°æŠ¥æ–‡ã€‚ æ¥ä¸‹æ¥å¦‚æœæ”¶åˆ°æ–°çš„ACKæŠ¥æ–‡ï¼Œå°†cwndè®¾ç½®ä¸ºssthreshï¼Œä¹Ÿå°±æ˜¯ç½‘é€Ÿé™ä¸ºä¸€åŠï¼Œå¹¶è¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µã€‚ æ€»çš„æ¥è¯´ï¼Œç½‘é€Ÿä¸€ç›´å¤„äºä¸€ä¸ªåŠ¨æ€è°ƒæ•´çš„è¿‡ç¨‹ï¼Œä¸€ä¸ªè¿æ¥ä¸Šcwndéšæ—¶é—´çš„å˜åŒ–å¦‚å›¾æ‰€ç¤º è¿˜æœ‰ä¸€ç‚¹ï¼Œä¸Šé¢å…³äºcwndçš„æ¯”è¾ƒå…¶å®è¿˜è¦è€ƒè™‘rwndçš„å€¼ï¼Œå¦‚æœrwnd&gt;cwndï¼Œåº”å–rwndå»æ¯”è¾ƒï¼Œæ¯•ç«Ÿä¸¤è€…å†³å®šäº†å¯ç”¨çª—å£å¤§å°ã€‚ 6. åè®°TCPæ‹¥å¡æ§åˆ¶å…¶å®è¿˜æœ‰å¾ˆå¤šæ”¹è¿›æœªå»äº†è§£ã€‚æ¯”å¦‚å½“æ”¶åˆ°é‡å¤çš„3ä¸ªACKæŠ¥æ–‡æ—¶ï¼Œå…¶å®ä¸ä¸€å®šåªä¸¢äº†ä¸€ä¸ªæŠ¥æ–‡ï¼Œæ‰€ä»¥ç½‘é€Ÿå¯èƒ½æŒ‡æ•°ä¸‹é™ï¼Œä¸èƒ½è¾¾åˆ°å¿«é€Ÿæ¢å¤çš„ç›®çš„ã€‚","categories":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"https://htchz.cc/categories/ç½‘ç»œ/"}],"tags":[{"name":"TCP","slug":"TCP","permalink":"https://htchz.cc/tags/TCP/"}]},{"title":"[FCM]ç”¨FCMåšä¸€ä¸ªè·¨è®¾å¤‡æ¶ˆæ¯åŒæ­¥å·¥å…·","slug":"FCM-ç”¨FCMåšä¸€ä¸ªè·¨è®¾å¤‡æ¶ˆæ¯åŒæ­¥å·¥å…·","date":"2019-05-18T03:00:00.000Z","updated":"2019-05-20T07:45:55.000Z","comments":true,"path":"2379284348.html","link":"","permalink":"https://htchz.cc/2379284348.html","excerpt":"FcmçœŸæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œå¸Œæœ›ä½ ä¹Ÿæœ‰ã€‚","text":"FcmçœŸæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œå¸Œæœ›ä½ ä¹Ÿæœ‰ã€‚ 1. éœ€æ±‚èƒŒæ™¯ä½œä¸ºä¸€ä¸ªç©·äººï¼Œæ‰‹æŒä¸äº†iPhone(æ»‘ç¨½)ï¼Œå½“åŒæ—¶ä½¿ç”¨ç€macOSã€windowsã€å®‰å“ä¸‰ä¸ªå¹³å°æ—¶ï¼Œæˆ‘é¢ä¸´ç€å‡ ä¸ªé—®é¢˜ï¼š ä¼ æ–‡ä»¶ã€‚å¯¹äºä¼ æ–‡ä»¶ï¼Œæœ‰è®¸å¤šæ–¹æ¡ˆï¼Œæˆ‘åå‘äºç”¨Feemæˆ–è€…å…±äº«æ–‡ä»¶å¤¹ï¼Œéƒ½æ˜¯å±€åŸŸç½‘ä¼ è¾“ï¼Œåˆå¿«åˆä¸ç”¨ç»è¿‡ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ã€‚ å¤åˆ¶æ–‡æœ¬ã€‚iPhoneå’Œmacä¹‹é—´æœ‰é€šç”¨å‰ªåˆ‡æ¿ï¼Œwin10å’ŒiPhoneã€å®‰å“ä¹‹é—´æœ‰å¾®è½¯å°å¨œã€‚ é€šçŸ¥åŒæ­¥ã€‚ä¸»è¦æ˜¯æ‰‹æœºé€šçŸ¥ï¼Œä¸Šç­å·¥ä½œæ—¶ï¼Œå¬åˆ°æ‰‹æœºæ¨é€çš„å£°éŸ³æƒ³çŸ¥é“æ—¶ä»€ä¹ˆä¸œè¥¿åˆæ‡’å¾—å»çœ‹æ‰‹æœºã€‚ çŸ­ä¿¡éªŒè¯ç ã€‚ç”µè„‘ä¸Šç”¨çŸ­ä¿¡éªŒè¯ç åœºæ™¯å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œä¸è¿‡æˆ‘ä»¬å…¬å¸çš„çº¿ä¸ŠæœåŠ¡å™¨ç™»å½•æ—¶éœ€è¦çŸ­ä¿¡éªŒè¯ç çš„äºŒæ¬¡éªŒè¯ï¼Œè¿™æ—¶å€™å»è§£é”æ‰‹æœºã€çœ‹éªŒè¯ç ã€ä¸€ä¸ªä¸€ä¸ªè¾“å…¥ç»ˆç«¯ã€‚ã€‚ã€‚å¦ˆè›‹å¾ˆçƒ¦ã€‚ äºæ˜¯æ‰¾äº†ä¸€å †ï¼ŒAirDroidã€Pushbulletç­‰ç­‰ï¼Œåœ¨åˆ°å¤„è®²éšç§çš„ä»Šå¤©ï¼Œæˆ‘è§‰å¾—æŠŠè‡ªå·±çš„å‰ªåˆ‡æ¿ã€çŸ­ä¿¡ã€é€šçŸ¥å°±è¿™ä¹ˆå‘é€ç»™äººå®¶æ€»æ˜¯æœ‰ç‚¹ä¸å®‰ï¼ˆä¸è¿‡ç”¨fcmä¹Ÿæ˜¯æŠŠæ•°æ®ç»™å·ç§°â€˜ä¸ä½œæ¶â€™å£å·çš„è°·æ­Œï¼‰ã€‚å¶ç„¶çœ‹åˆ°äº†å‰ªçº¸äº‘ï¼Œæ˜¯ä¸ªæ”¶è´¹è½¯ä»¶ï¼Œä¸è¿‡çœ‹äº†ç®€ä»‹è¯´æ˜¯ç”¨FCMåšçš„ï¼Œæ‰¾äº†ä¸‹FCMçš„æ¥å…¥æŒ‡åŒ—ï¼Œè‡ªå·±åšä¸€ä¸ªåŒæ­¥å·¥å…·ã€‚ 2. æ•´ä½“æµç¨‹ æ•°æ®çš„æµå‘å¦‚å›¾ï¼Œç»ˆç«¯æŠŠè¦åŒæ­¥çš„æ•°æ®å‘åˆ°è‡ªå·±çš„åº”ç”¨æœåŠ¡å™¨ï¼Œåº”ç”¨æœåŠ¡å™¨è½½æŠŠæ•°æ®å‘åˆ°FCMï¼Œäº¤ç”±FCMæ¨é€åˆ°è®¾å¤‡ç»„ã€‚ å¯¹äºæ¯ä¸€å°è®¾å¤‡ï¼Œå½“åº”ç”¨ä¸FCMå»ºç«‹èµ·è¿æ¥åå¯ä»¥å¾—åˆ°ä¸€ä¸ªfcm tokenï¼Œè¿™ä¸ªtokenå°±æ˜¯è¿™å°è®¾å¤‡è¿™ä¸ªåº”ç”¨çš„idäº†ã€‚ è‡³äºè®¾å¤‡ç»„idï¼Œæˆ‘æ˜¯ç”¨Firebase-Authçš„userIdä½œä¸ºè®¾å¤‡ç»„idçš„ã€‚ ç¨‹åºä¸»è¦æµç¨‹æ˜¯ï¼š å®¢æˆ·ç«¯å¯åŠ¨æ—¶è·å–fcm tokenï¼ŒæŒä¹…åŒ–å­˜å‚¨ï¼ˆè¿™ä¸ªfcm tokené™¤éæŠŠåº”ç”¨åˆ äº†å’Œæˆ‘ä¸çŸ¥é“çš„æƒ…å†µï¼Œå¦åˆ™ä¸‡å¹´ä¸æ›´æ–°ä¸€æ¬¡ï¼Œå½“ç„¶fcm sdkæä¾›äº†æ›´æ–°çš„å›è°ƒï¼Œæˆ‘ä»¬è¦å®ç°è¿™ä¸ªæ–¹æ³•ã€‚ï¼‰ å®¢æˆ·ç«¯ç™»å½•ï¼Œæ‹‰èµ·è°·æ­Œçš„OAuth2.0æˆæƒï¼ˆChromeæ’ä»¶ç”¨çš„clientIdæ¨¡å¼ï¼‰ï¼Œç™»å½•æˆåŠŸåè·å–åˆ°firebase-authçš„userIdï¼ŒæŒä¹…åŒ–å­˜å‚¨ ç™»å½•æˆåŠŸåæŠŠuserIdå’Œfcm tokenå‘é€åˆ°åº”ç”¨æœåŠ¡å™¨ä¿å­˜ï¼Œç»´æŠ¤åŒå‘å…³ç³»ï¼Œå®Œæˆæ³¨å†Œã€‚ å®¢æˆ·ç«¯æ¯æ¬¡å‘é€åŒæ­¥æ•°æ®æ—¶ï¼Œå¸¦ä¸Šæ—¶é—´æˆ³ã€åŒæ­¥ç±»å‹ã€fcm tokenç­‰å†…å®¹ã€‚ å®¢æˆ·ç«¯æ¥å—åˆ°fcmæ¨é€æ—¶ï¼Œè§æœºè¡Œäº‹ã€‚ åŒæ­¥æ•°æ®çš„æ•°æ®ç»“æ„ å­—æ®µ è¯´æ˜ type çŸ­ä¿¡ã€é€šçŸ¥ã€å‰ªåˆ‡æ¿ time æ¯«ç§’æ—¶é—´æˆ³ï¼Œä¹Ÿä½œä¸ºåˆ†ç‰‡idï¼ˆå…¶å®æ˜¯å·æ‡’ï¼‰ text æ–‡æœ¬å†…å®¹ head é¢å¤–å†…å®¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å­˜é€šçŸ¥çš„é€šçŸ¥æ ‡é¢˜ fcm_token è®¾å¤‡id mark åˆ†ç‰‡çš„æ ‡è¯†ï¼Œ8ä½æ•´æ•°ï¼Œé«˜ä½èµ·ç¬¬ä¸€ä½è¡¨ç¤ºæ˜¯å¦åˆ†ç‰‡ï¼Œç¬¬äºŒä½è¡¨ç¤ºæ˜¯å¦è¿˜æœ‰åˆ†ç‰‡ï¼Œä½™ä¸‹6ä½è¡¨ç¤ºåˆ†ç‰‡é¡ºåº 3. æœåŠ¡ç«¯æœåŠ¡ç«¯ç”¨goå†™çš„ï¼Œæ¡†æ¶ä½¿ç”¨ginï¼Œæ•°æ®åº“ç”¨redisã€‚ ä¸»è¦ç»´æŠ¤ä¸¤ä¸ªå…³ç³»ã€‚ è®¾å¤‡idåˆ°è®¾å¤‡ç»„idçš„å…³ç³» è®¾å¤‡ç»„idåˆ°æ‰€æœ‰è®¾å¤‡idçš„å…³ç³» ç¬¬ä¸€ä¸ªç›´æ¥ç”¨redisçš„kvæ¨¡å‹ï¼Œç¬¬äºŒä¸ªç”¨redisçš„å“ˆå¸Œæ¨¡å‹ã€‚ å½“æœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„åŒæ­¥è¯·æ±‚æ—¶ï¼Œæ¨é€åˆ°fcmæœ‰ä¸¤ç§æ–¹å¼ã€‚ ä½¿ç”¨fcmçš„è®¾å¤‡ç»„ç®¡ç†ï¼Œfcmè®¾å¤‡ç»„ç®¡ç†éœ€è¦æ–°å»ºè®¾å¤‡ç»„ï¼ŒæŠŠfcm tokenæ·»åŠ åˆ°è®¾å¤‡ç»„ï¼Œå‘é€åŒæ­¥æ•°æ®æ—¶ï¼Œå¸¦ä¸Šfcmè®¾å¤‡ç»„idï¼Œfcmå°±ä¼šæŠŠåŒæ­¥æ•°æ®æ¨é€åˆ°æ‰€æœ‰ç»„ã€‚å¯¹äºå·²ç»å¤±æ•ˆçš„fcm tokenï¼Œfcmè®¾å¤‡ç»„ç®¡ç†ä¼šè‡ªå·±æ¸…ç†ã€‚ è‡ªå·±ç»´æŠ¤è®¾å¤‡ç»„ï¼Œéå†è®¾å¤‡ç»„çš„è®¾å¤‡ï¼Œä¸€ä¸ªä¸ªå¸¦ä¸Šfcm tokenæ¨åˆ°fcmã€‚å¦‚æœæ¥æ”¶åˆ°fcm tokenæ— æ•ˆçš„å“åº”ï¼Œå°±ä»redisæŠŠfcm tokençš„kvå…³ç³»ã€å“ˆå¸Œå…³ç³»åˆ é™¤ã€‚ ä½¿ç”¨fcmçš„è®¾å¤‡ç»„ç®¡ç†çš„å¥½å¤„æ˜¯åªéœ€è¦ç»´æŠ¤è®¾å¤‡idåˆ°è®¾å¤‡ç»„idçš„å…³ç³»ï¼Œå¯¹äºä¸€äº›æ— æ•ˆçš„fcm tokenç”±fcmè‡ªå·±å»ç®¡ç†ï¼Œä¸è¶³çš„æ˜¯ç›®å‰fcmè®¾å¤‡ç»„ç®¡ç†æ²¡æœ‰æä¾›APIè·å–è®¾å¤‡ç»„çš„è®¾å¤‡ç»„åˆ—è¡¨ï¼Œè€Œä¸”ä¸€å‘å°±æ˜¯å‘å…¨éƒ¨ï¼Œå®¢æˆ·ç«¯å‘æ¶ˆæ¯å‡ºå»ï¼Œå¾…ä¼šåˆæ”¶åˆ°è‡ªå·±çš„æ¶ˆæ¯ã€‚æ­¤å¤–ï¼Œfcmè®¾å¤‡ç»„ç®¡ç†åœ¨goæ²¡æœ‰sdkã€‚ã€‚ã€‚ æ‰€ä»¥æˆ‘å†³å®šè‡ªå·±ç®¡ç†è®¾å¤‡ç»„ã€‚ è¿™é‡Œæœ‰ä¸€ä¸ªâ˜ï¸å‰ªåˆ‡æ¿çš„é—®é¢˜ï¼Œå½“å‘é€åˆ°fcmçš„payloadå¤§äº4kbçš„æ—¶å€™ï¼Œä¼šè¿”å› 400; reason: request contains an invalid argument; code: invalid-argument; details: Request contains an invalid argument.ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦æ§åˆ¶å¥½æ•°æ®å¤§å°ã€‚ä½œä¸ºctrl cvå·¥ç¨‹å¸ˆï¼Œå¦‚æœè¦ä»macå¾€windowså¤åˆ¶1000è¡Œä»£ç æ€ä¹ˆåŠï¼Ÿç­”æ¡ˆæ˜¯åˆ†ç‰‡ã€‚ æ­£å¦‚ipåˆ†ç‰‡å’Œtcpåˆ†æ®µä¸ºäº†è§£å†³æŠ¥æ–‡çš„å¤§å°é™åˆ¶ï¼Œæˆ‘ä»¬è¦åœ¨åº”ç”¨å±‚è¿›è¡Œåˆ†ç‰‡é‡ç»„ã€‚ä¸è¿‡è¿™ä¸ªç”±äºæ˜¯åº”ç”¨å±‚çš„åˆ†ç‰‡è¦ç®€å•çš„å¤šã€‚ åº”ç”¨æœåŠ¡å™¨æ¥æ”¶åˆ°åŒæ­¥æ•°æ®åï¼Œå¦‚æœtextæ–‡æœ¬å¤§äº4kbï¼Œåˆ™è¿›è¡Œåˆ†ç‰‡ï¼Œmarké«˜ä½ç¬¬ä¸€ä½ç½®0ï¼Œå¦åˆ™ç½®1ç›´æ¥æ¨åˆ°FCMã€‚ ç¬¬äºŒæ­¥ï¼Œç”±äºjsonæ˜¯ä¸ªæ–‡æœ¬åè®®ï¼Œæˆ‘ä»¬åˆ†ç‰‡çš„æ—¶å€™æœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œç¬¬ä¸€ç§è½¬æ¢ä¸ºå­—èŠ‚åˆ†ç‰‡ï¼Œç¬¬äºŒç§è½¬æ¢ä¸ºruneåˆ†ç‰‡ï¼ˆruneæ˜¯goçš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥è¡¨ç¤ºä¸€ä¸ªutf8å­—ç¬¦ï¼‰ï¼Œä¸€ä¸ªruneçš„å¤§å°æ˜¯4ä¸ªå­—èŠ‚ï¼Œä¸ºäº†é˜²æ­¢è¾¾åˆ°é™åˆ¶ï¼Œruneåˆ†ç‰‡å¤§å°åº”ä¸º1000ä¸ªruneï¼Œä¸è¿‡è¿™æ ·å°±å¯èƒ½ä¼šå¯¼è‡´ä¸€æ¬¡payloadåˆ©ç”¨ç‡ä¸é«˜ï¼Œæ¯•ç«Ÿ1000ä¸ªæ±‰å­—æ˜¯1000ä¸ªruneï¼Œè‡³å°‘å 3000å­—èŠ‚ï¼Œ1000ä¸ªå­—æ¯ä¹Ÿæ˜¯1000ä¸ªruneï¼Œå 1000ä¸ªå­—èŠ‚ï¼›å¥½å¤„æ˜¯åœ¨å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦‚æœä½¿ç”¨å­—èŠ‚åˆ†ç‰‡ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°åˆ†ç‰‡åéœ€è¦è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ï¼Œç»„åˆå­—èŠ‚æ•°ç»„ï¼Œå†å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç‚’é¸¡éº»çƒ¦ã€‚ æ¥ä¸‹æ¥åœ¨åˆ†ç‰‡marké«˜ä½èµ·ä½6ä½è®¾ç½®å¥½åˆ†ç‰‡é¡ºåºï¼Œåªè¦ç®€å•çš„0ï¼Œ1ï¼Œ2..è¿™æ ·å°±å¥½äº†ï¼ˆä¸åŒäºipåˆ†ç‰‡ï¼Œipåˆ†ç‰‡ä½¿ç”¨çš„æ˜¯æ•°æ®åç§»é‡ä½œä¸ºä½ç½®ç´¢å¼•ï¼‰ã€‚å¦‚æœæ˜¯æœ€åä¸€ç‰‡åˆ†ç‰‡ï¼Œmarké«˜ä½èµ·ç¬¬äºŒä½è¦ç½®1è¡¨ç¤ºæ²¡æœ‰æ›´å¤šåˆ†ç‰‡ã€‚ æ¥ä¸‹æ¥åˆ©ç”¨sdkæ¨é€åˆ°fcmå°±å¥½äº†ã€‚åº”ç”¨æœåŠ¡å™¨çš„æ¥å…¥fcmæœ‰å¤šç§æ–¹å¼ï¼Œæ–‡æ¡£çœŸæ˜¯å‚»ç“œå¼æ•™ç¨‹ã€‚ 4. å®¢æˆ·ç«¯å®¢æˆ·ç«¯å†™Chromeæ‹“å±•å’Œandroidã€‚ä¸»è¦æµç¨‹æ˜¯ æ ¹æ®æ¥æ”¶åˆ°çš„æ•°æ®ç±»å‹å¤„ç†ï¼Œï¼ˆ1ï¼‰é€šçŸ¥ç›´æ¥æ˜¾ç¤ºï¼Œï¼ˆ2ï¼‰çŸ­ä¿¡æ˜¾ç¤ºå¹¶ä¸”æ£€éªŒæœ‰æ²¡æœ‰éªŒè¯ç ï¼Œæœ‰åˆ™å°†éªŒè¯ç æå–æ”¾å…¥å‰ªåˆ‡æ¿ï¼Œï¼ˆ3ï¼‰å‰ªåˆ‡æ¿è¿›è¡Œåˆ†ç‰‡åˆ¤æ–­ å¦‚æœä¸æ˜¯åˆ†ç‰‡ï¼Œç›´æ¥æ”¾å…¥å‰ªåˆ‡æ¿ï¼Œå¦åˆ™è¿›è¡Œé‡ç»„ã€‚ é‡ç»„éœ€è¦ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨ï¼Œkeyä¸ºæ—¶é—´æˆ³ï¼Œä¹Ÿæ˜¯åˆ†ç‰‡idï¼ˆè¿™é‡Œç”¨æ—¶é—´æˆ³æ˜¯å·æ‡’ï¼Œæ¯•ç«Ÿä¸€ä¸ªäºº1æ¯«ç§’å†…ä¹Ÿä¸èƒ½å¤åˆ¶ä¸¤æ¬¡å­ï¼‰ï¼›valueæ˜¯ç»´æŠ¤åˆ†ç‰‡çš„æ•°æ®ç»“æ„FragHoldï¼Œå¦‚ä¸‹ å­—æ®µ è¯´æ˜ count æ•´å‹ length æ•´å‹ text æ•°ç»„ å½“ç¬¬ä¸€ä¸ªåˆ†ç‰‡åˆ°æ¥æ—¶ï¼Œå°†åˆ†ç‰‡timeä½œä¸ºkeyï¼Œåˆå§‹åŒ–ä¸€ä¸ªFragHoldã€‚æ¯æ¬¡åˆ°è¾¾ä¸€ä¸ªåˆ†ç‰‡ï¼ŒFragHold.countåŠ 1ï¼Œå½“æœ€åä¸€ä¸ªåˆ†ç‰‡åˆ°æ¥ï¼ŒFragHold.lengthå¯ä»¥ç¡®å®šã€‚å¦‚æœFragHoldçš„count == lengthï¼Œé‚£ä¹ˆåˆ†ç‰‡é‡ç»„å®Œæˆï¼Œç›´æ¥å¯¹æ•°ç»„ä¸€ä¸ªjoinæ“ä½œå¾—åˆ°ä¸€ç¯‡å®Œæ•´çš„åƒå­—æ–‡ï¼Œåˆå¯ä»¥æ„‰å¿«åœ°ctrl cväº†ã€‚ æ­¤å¤–èµ·ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä¸æ–­å°†å…¨å±€å“ˆå¸Œè¡¨é‡Œè¿‡æœŸçš„FragHoldå‰”é™¤ï¼Œæ¯•ç«Ÿè¿™ä¸ªæ˜¯æ²¡æœ‰è¶…æ—¶é‡ä¼ çš„ï¼Œä¸€æ—¦ä¸¢äº†å°±å†å¤åˆ¶ä¸€æ¬¡å‘—ã€‚ 5. ç»“è¯­è¿™é‡Œè¦è¯´ä¸€ä¸‹åœ¨è®¾å¤‡ç»„ç®¡ç†é‡åˆ°çš„é—®é¢˜ï¼Œä¸€å¼€å§‹æˆ‘ä¹Ÿæ˜¯ç”¨fcmçš„è®¾å¤‡ç»„ç®¡ç†ï¼Œå¯¼è‡´å‘é€æ–¹ä¼šæ¥æ”¶åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯ã€‚è¿™ä¸ªæœ¬æ¥æ— æ‰€è°“ï¼Œæ ¹æ®æ¶ˆæ¯çš„fcm_tokenåˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœç­‰äºè‡ªå·±çš„fcm_tokenï¼Œå°±ä¸å¤„ç†ã€‚ä½†æ˜¯jså®¢æˆ·ç«¯æ˜¯ç”¨service workeræ¥å¤„ç†ï¼Œå½“service workeré‡æ–°å”¤é†’æ—¶ï¼Œå› ä¸ºæŸ¥è¯¢indexedDBå’Œè°ƒç”¨fcmæ¥å£éƒ½è¦åœ¨ç¬¬äºŒè½®äº‹ä»¶å¾ªç¯æ‰èƒ½æ‹¿åˆ°è‡ªå·±çš„fcm_token, è€Œservice workerè¢«å”¤é†’åçš„ç¬¬ä¸€ä¸ªäº‹ä»¶å¾ªç¯å°±è¦å¤„ç†æ¶ˆæ¯äº†ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡è¢«å”¤é†’æ—¶æ˜¯ä¸çŸ¥é“è‡ªå·±fcm_tokençš„ã€‚ è¿˜æœ‰ä¸€ç‚¹ï¼Œfcm jsè¦æ±‚ä½ å¿…é¡»å¯¹æ”¶åˆ°çš„pushå¼¹çª—ï¼Œå¦åˆ™ä»–ä¼šå¸®ä½ å¼¹çª—ï¼Œæœ‰çŸ¥é“æ€ä¹ˆè§£å†³çš„å‘Šè¯‰æˆ‘ä¸€ä¸‹ã€‚ã€‚ã€‚","categories":[{"name":"Firebase","slug":"Firebase","permalink":"https://htchz.cc/categories/Firebase/"}],"tags":[{"name":"æ•°æ®åˆ†ç‰‡","slug":"æ•°æ®åˆ†ç‰‡","permalink":"https://htchz.cc/tags/æ•°æ®åˆ†ç‰‡/"}]},{"title":"[Dubbo]Dubbo SPI æœºåˆ¶","slug":"Dubbo-Dubboçš„SPI","date":"2019-03-25T03:44:00.000Z","updated":"2020-06-13T08:53:55.080Z","comments":true,"path":"2436052280.html","link":"","permalink":"https://htchz.cc/2436052280.html","excerpt":"","text":"1. å‰è¨€ä¹‹å‰ä¸€ç¯‡[JavaåŸºç¡€]Javaçš„SPIæœºåˆ¶è®²åˆ°Java spiçš„ç¼ºé™·æ˜¯åœ¨æŸ¥æ‰¾æ‰€éœ€å®ç°çš„æ—¶å€™ï¼Œä¼šå®ä¾‹åŒ–æ— å…³çš„å®ç°ï¼Œé‚£ä¹ˆè¿™ç¯‡çœ‹çœ‹Dubboæ˜¯æ€ä¹ˆè§„é¿è¿™ä¸ªé—®é¢˜çš„ã€‚ 2. Dubbo spiçš„ç‰¹ç‚¹1234567891011@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE&#125;)public @interface SPI &#123; /** * default extension name */ String value() default \"\";&#125; ç”±äºé…ç½®æ–‡ä»¶æ˜¯ä»¥key-valueé…ç½®çš„ï¼Œè¿™é‡Œå¯ä»¥ä¸ºSPIæ¥å£æŒ‡å®šä¸€ä¸ªé»˜è®¤å®ç°çš„key Dubbo spiæœ‰ä»¥ä¸‹ç‰¹ç‚¹ ä¸éœ€è¦éå†æ‰€æœ‰å®ä¾‹åŒ–æ‰€æœ‰å®ç°ç±» å¢åŠ äº†å¯¹æ‰©å±•ç‚¹IoCå’ŒAOPçš„æ”¯æŒï¼Œä¸€ä¸ªæ‰©å±•ç‚¹å¯ä»¥ç›´æ¥setteræ³¨å…¥å…¶å®ƒæ‰©å±•ç‚¹ã€‚ 3. Demoæ¥å£,éœ€è¦åŠ ä¸Šorg.apache.dubbo.common.extension.SPIæ³¨è§£ 1234@SPIpublic interface Runner &#123; void run(String name);&#125; ä¸¤ä¸ªå®ç° 1234567891011121314151617public class DefaultRunner implements Runner &#123; private Logger log = LoggerFactory.getLogger(getClass()); @Override public void run(String name) &#123; log.info(\"I'm a DefaultRunner\"); &#125;&#125;public class ExcitedRunner implements Runner &#123; private Logger log = LoggerFactory.getLogger(getClass()); @Override public void run(String name) &#123; log.info(\"I'm a ExcitedRunner!\"); &#125;&#125; åœ¨èµ„æºç›®å½•META-INF/dubboä¸‹åˆ›å»ºæ–‡ä»¶com.htc.learning.api.Runner å†…å®¹æ˜¯ä¸€è¡Œä¸€è¡Œçš„é”®å€¼å¯¹ï¼Œvalueæ˜¯å®ç°ç±»ï¼Œæˆ‘ä»¬åªè¦é€šè¿‡keyå°±èƒ½ç›´æ¥æ‹¿åˆ°æ‰€éœ€ç±»ã€‚ 12default=com.htc.learning.api.impl.DefaultRunnerexcited=com.htc.learning.api.impl.ExcitedRunner æµ‹è¯•æ–¹æ³• 12345678@Testpublic void dubboSpiTest() &#123; ExtensionLoader&lt;Runner&gt; extensionLoader = ExtensionLoader.getExtensionLoader(Runner.class); Runner defaultRunner = extensionLoader.getExtension(\"default\"); defaultRunner.run(\"htc\"); Runner excitedRunner = extensionLoader.getExtension(\"excited\"); excitedRunner.run(\"htc\");&#125; è¾“å‡º 2019-03-23 12:20:50.681 INFO --- [ main] com.htc.learning.api.impl.DefaultRunner : I&apos;m a DefaultRunner 2019-03-23 12:20:50.681 INFO --- [ main] com.htc.learning.api.impl.ExcitedRunner : I&apos;m a ExcitedRunner!4. åŸç†4.1. getExtensionLoaderDubbo spiä¸java spiçš„ServiceLoaderå¯¹åº”çš„ï¼Œæ˜¯ExtensionLoaderã€‚ä¸åŒäºServiceLoaderçš„loadæ–¹æ³•æ¯æ¬¡è¿”å›éƒ½è¦å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼ŒExtensionLoaderæ¯æ¬¡getExtensionLoaderä¼šè¿›è¡Œç¼“å­˜ã€‚ 1234567891011121314151617181920public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(Class&lt;T&gt; type) &#123; if (type == null) &#123; throw new IllegalArgumentException(\"Extension type == null\"); &#125; if (!type.isInterface()) &#123; throw new IllegalArgumentException(\"Extension type(\" + type + \") is not interface!\"); &#125; if (!withExtensionAnnotation(type)) &#123; throw new IllegalArgumentException(\"Extension type(\" + type + \") is not extension, because WITHOUT @\" + SPI.class.getSimpleName() + \" Annotation!\"); &#125; ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type); if (loader == null) &#123; EXTENSION_LOADERS.putIfAbsent(type, new ExtensionLoader&lt;T&gt;(type)); loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type); &#125; return loader;&#125; ExtensionLoaderæ„é€ å‡½æ•° 1234private ExtensionLoader(Class&lt;?&gt; type) &#123; this.type = type; objectFactory = (type == ExtensionFactory.class ? null : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());&#125; å…¶ä¸­objectFactoryæ˜¯ä¸€ä¸ªæ¥å£,ä¸IOCç›¸å…³ï¼Œè¯¥æ¥å£æ ¹æ®typeå’Œnameæ‰¾åˆ°ä¸€ä¸ªbeanï¼Œè¿™ä¸ªbeanå¯ä»¥æ˜¯Springçš„beanï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªdubbo spiå®ç°ç±»ã€‚ 12345678910111213@SPIpublic interface ExtensionFactory &#123; /** * Get extension. * * @param type object type. * @param name object name. * @return object instance. */ &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name);&#125; å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¹Ÿæ˜¯ä¸€ä¸ªSPIæ¥å£ï¼Œæ¥ä¸‹æ¥è°ƒç”¨çš„getExtensionLoaderé€»è¾‘å°±æ˜¯é€šè¿‡ä»–å®ç°çš„ã€‚ 4.2. getExtension12345678910111213141516171819202122232425262728public T getExtension(String name) &#123; if (name == null || name.length() == 0) throw new IllegalArgumentException(\"Extension name == null\"); if (\"true\".equals(name)) &#123; // è·å–é»˜è®¤çš„æ‹“å±•å®ç°ç±» return getDefaultExtension(); &#125; // Holderï¼Œé¡¾åæ€ä¹‰ï¼Œç”¨äºæŒæœ‰ç›®æ ‡å¯¹è±¡ Holder&lt;Object&gt; holder = cachedInstances.get(name); if (holder == null) &#123; cachedInstances.putIfAbsent(name, new Holder&lt;Object&gt;()); holder = cachedInstances.get(name); &#125; Object instance = holder.get(); // åŒé‡æ£€æŸ¥ if (instance == null) &#123; synchronized (holder) &#123; instance = holder.get(); if (instance == null) &#123; // åˆ›å»ºæ‹“å±•å®ä¾‹ instance = createExtension(name); // è®¾ç½®å®ä¾‹åˆ° holder ä¸­ holder.set(instance); &#125; &#125; &#125; return (T) instance;&#125; 123456789101112131415161718192021222324252627282930private T createExtension(String name) &#123; // ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½æ‰€æœ‰çš„æ‹“å±•ç±»ï¼Œå¯å¾—åˆ°â€œé…ç½®é¡¹åç§°â€åˆ°â€œé…ç½®ç±»â€çš„æ˜ å°„å…³ç³»è¡¨ Class&lt;?&gt; clazz = getExtensionClasses().get(name); if (clazz == null) &#123; throw findException(name); &#125; try &#123; T instance = (T) EXTENSION_INSTANCES.get(clazz); if (instance == null) &#123; // é€šè¿‡åå°„åˆ›å»ºå®ä¾‹ EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance()); instance = (T) EXTENSION_INSTANCES.get(clazz); &#125; // å‘å®ä¾‹ä¸­æ³¨å…¥ä¾èµ– injectExtension(instance); Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses; if (wrapperClasses != null &amp;&amp; !wrapperClasses.isEmpty()) &#123; // å¾ªç¯åˆ›å»º Wrapper å®ä¾‹ for (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123; // å°†å½“å‰ instance ä½œä¸ºå‚æ•°ä¼ ç»™ Wrapper çš„æ„é€ æ–¹æ³•ï¼Œå¹¶é€šè¿‡åå°„åˆ›å»º Wrapper å®ä¾‹ã€‚ // ç„¶åå‘ Wrapper å®ä¾‹ä¸­æ³¨å…¥ä¾èµ–ï¼Œæœ€åå°† Wrapper å®ä¾‹å†æ¬¡èµ‹å€¼ç»™ instance å˜é‡ instance = injectExtension( (T) wrapperClass.getConstructor(type).newInstance(instance)); &#125; &#125; return instance; &#125; catch (Throwable t) &#123; throw new IllegalStateException(\"...\"); &#125;&#125; è¿™é‡ŒæŒ‰é€»è¾‘å¯ä»¥æ‹†åˆ†æˆå››æ­¥ getExtensionClasses()è·å–æ¥å£çš„æ‰€æœ‰å®ç°ç±»ã€‚è¿™ä¸ªæ–¹æ³•ä¼šåœ¨å¾ˆå¤šåœ°æ–¹è¢«è°ƒç”¨ï¼Œä¿è¯æ‰€æœ‰ç±»è¢«è·å–åˆ°ã€‚ç”±äºå¤šæ¬¡è°ƒç”¨ç¼“å­˜ä¹Ÿæ˜¯å¿…é¡»çš„ã€‚ å®ä¾‹åŒ–ç›®æ ‡ç±»çš„å¯¹è±¡ã€‚ IOCæ³¨å…¥ã€‚æ³¨å…¥å…¶ä»–SPIå®ç°ã€‚ AOPå®ç°ã€‚å¦‚æœéœ€è¦ï¼ŒæŠŠå¯¹è±¡å®ä¾‹åŒ…è£¹åœ¨Wrapperä¸­ã€‚ 4.2.1. getExtensionClasses12345678910111213141516private Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123; // ä»ç¼“å­˜ä¸­è·å–å·²åŠ è½½çš„æ‹“å±•ç±» Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get(); // åŒé‡æ£€æŸ¥ if (classes == null) &#123; synchronized (cachedClasses) &#123; classes = cachedClasses.get(); if (classes == null) &#123; // åŠ è½½æ‹“å±•ç±» classes = loadExtensionClasses(); cachedClasses.set(classes); &#125; &#125; &#125; return classes;&#125; å…¸å‹çš„åŒé‡æ ¡éªŒï¼Œè¿™é‡Œçš„ç¼“å­˜keyæ˜¯å®ç°ç±»çš„keyï¼Œå€¼å°±æ˜¯å®ç°ç±»äº†ã€‚å¦‚æœç¼“å­˜ä¸ºnullï¼Œè°ƒç”¨loadExtensionClassesåˆå§‹åŒ–ç¼“å­˜ã€‚ 123456789101112131415161718192021222324252627// synchronized in getExtensionClassesprivate Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123; final SPI defaultAnnotation = type.getAnnotation(SPI.class); if (defaultAnnotation != null) &#123; // å¦‚æœè®¾ç½®äº†é»˜è®¤å®ç°ï¼Œå°±ç¼“å­˜ä»¥ä¸‹è¿™ä¸ªé»˜è®¤å®ç°çš„key String value = defaultAnnotation.value(); if ((value = value.trim()).length() &gt; 0) &#123; String[] names = NAME_SEPARATOR.split(value); if (names.length &gt; 1) &#123; throw new IllegalStateException(\"more than 1 default extension name on extension \" + type.getName() + \": \" + Arrays.toString(names)); &#125; if (names.length == 1) &#123; cachedDefaultName = names[0]; &#125; &#125; &#125; Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = new HashMap&lt;String, Class&lt;?&gt;&gt;(); loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY, type.getName()); loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY, type.getName().replace(\"org.apache\", \"com.alibaba\")); loadDirectory(extensionClasses, DUBBO_DIRECTORY, type.getName()); loadDirectory(extensionClasses, DUBBO_DIRECTORY, type.getName().replace(\"org.apache\", \"com.alibaba\")); loadDirectory(extensionClasses, SERVICES_DIRECTORY, type.getName()); loadDirectory(extensionClasses, SERVICES_DIRECTORY, type.getName().replace(\"org.apache\", \"com.alibaba\")); return extensionClasses;&#125; java spiçš„é…ç½®åªèƒ½æ”¾åœ¨ä¸€ä¸ªç›®å½•META-INF/services/,dubbo spiçš„é…ç½®å¯ä»¥æ”¾åœ¨ä¸‰ä¸ªç›®å½• 12345private static final String SERVICES_DIRECTORY = \"META-INF/services/\";private static final String DUBBO_DIRECTORY = \"META-INF/dubbo/\";private static final String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + \"internal/\"; è¿™é‡Œçš„ä¾èµ–æˆ‘ç”¨çš„æ˜¯apache-dubboï¼Œç›¸å¯¹äºalibaba-dubboä¸‰ä¸ªç›®å½•ï¼Œä¼°è®¡ä¸ºäº†å…¼å®¹ï¼Œapache-dubboç‰ˆæœ¬çš„loadDirectoryæ–¹æ³•è¿›è¡Œäº†ä¸€ä¸ªåŒ…åçš„æ›¿æ¢ã€‚ 1234567891011121314151617181920212223private void loadDirectory(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir) &#123; // fileName = æ–‡ä»¶å¤¹è·¯å¾„ + type å…¨é™å®šå String fileName = dir + type.getName(); try &#123; Enumeration&lt;java.net.URL&gt; urls; ClassLoader classLoader = findClassLoader(); // æ ¹æ®æ–‡ä»¶ååŠ è½½æ‰€æœ‰çš„åŒåæ–‡ä»¶ if (classLoader != null) &#123; urls = classLoader.getResources(fileName); &#125; else &#123; urls = ClassLoader.getSystemResources(fileName); &#125; if (urls != null) &#123; while (urls.hasMoreElements()) &#123; java.net.URL resourceURL = urls.nextElement(); // åŠ è½½èµ„æº loadResource(extensionClasses, classLoader, resourceURL); &#125; &#125; &#125; catch (Throwable t) &#123; logger.error(\"...\"); &#125;&#125; æ¥ä¸‹æ¥â€œçœŸÂ·è¯»å–é…ç½®æ–‡ä»¶â€ 123456789101112131415161718192021222324252627282930313233343536373839404142private void loadResource(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, ClassLoader classLoader, java.net.URL resourceURL) &#123; try &#123; BufferedReader reader = new BufferedReader( new InputStreamReader(resourceURL.openStream(), \"utf-8\")); try &#123; String line; // æŒ‰è¡Œè¯»å–é…ç½®å†…å®¹ while ((line = reader.readLine()) != null) &#123; // å®šä½ # å­—ç¬¦ final int ci = line.indexOf('#'); if (ci &gt;= 0) &#123; // æˆªå– # ä¹‹å‰çš„å­—ç¬¦ä¸²ï¼Œ# ä¹‹åçš„å†…å®¹ä¸ºæ³¨é‡Šï¼Œéœ€è¦å¿½ç•¥ line = line.substring(0, ci); &#125; line = line.trim(); if (line.length() &gt; 0) &#123; try &#123; String name = null; int i = line.indexOf('='); if (i &gt; 0) &#123; // ä»¥ç­‰äºå· = ä¸ºç•Œï¼Œæˆªå–é”®ä¸å€¼ name = line.substring(0, i).trim(); line = line.substring(i + 1).trim(); &#125; if (line.length() &gt; 0) &#123; // åŠ è½½ç±»ï¼Œå¹¶é€šè¿‡ loadClass æ–¹æ³•å¯¹ç±»è¿›è¡Œç¼“å­˜ loadClass(extensionClasses, resourceURL, Class.forName(line, true, classLoader), name); &#125; &#125; catch (Throwable t) &#123; IllegalStateException e = new IllegalStateException(\"Failed to load extension class...\"); &#125; &#125; &#125; &#125; finally &#123; reader.close(); &#125; &#125; catch (Throwable t) &#123; logger.error(\"Exception when load extension class...\"); &#125;&#125; è¯»å®Œé…ç½®æ–‡ä»¶ï¼Œä¸‹é¢ä¸å•æ˜¯å¯¹ç±»è¿›è¡ŒåŠ è½½ï¼Œè€Œä¸”è¿˜å¯¹Adaptiveã€Wrapperç±»è¿›è¡Œç¼“å­˜ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455private void loadClass(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, java.net.URL resourceURL, Class&lt;?&gt; clazz, String name) throws NoSuchMethodException &#123; if (!type.isAssignableFrom(clazz)) &#123; throw new IllegalStateException(\"Error when load extension class(interface: \" + type + \", class line: \" + clazz.getName() + \"), class \" + clazz.getName() + \"is not subtype of interface.\"); &#125; // åªèƒ½æœ‰ä¸€ä¸ªè‡ªé€‚åº”å®ç°ç±» if (clazz.isAnnotationPresent(Adaptive.class)) &#123; if (cachedAdaptiveClass == null) &#123; cachedAdaptiveClass = clazz; &#125; else if (!cachedAdaptiveClass.equals(clazz)) &#123; throw new IllegalStateException(...); &#125; &#125; else if (isWrapperClass(clazz)) &#123; Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses; if (wrappers == null) &#123; cachedWrapperClasses = new ConcurrentHashSet&lt;Class&lt;?&gt;&gt;(); wrappers = cachedWrapperClasses; &#125; wrappers.add(clazz); &#125; else &#123; clazz.getConstructor(); if (name == null || name.length() == 0) &#123; name = findAnnotationName(clazz); if (name.length() == 0) &#123; throw new IllegalStateException(...); &#125; &#125; String[] names = NAME_SEPARATOR.split(name); if (names != null &amp;&amp; names.length &gt; 0) &#123; Activate activate = clazz.getAnnotation(Activate.class); if (activate != null) &#123; cachedActivates.put(names[0], activate); &#125; else &#123; // support com.alibaba.dubbo.common.extension.Activate com.alibaba.dubbo.common.extension.Activate oldActivate = clazz.getAnnotation(com.alibaba.dubbo.common.extension.Activate.class); if (oldActivate != null) &#123; cachedActivates.put(names[0], oldActivate); &#125; &#125; for (String n : names) &#123; if (!cachedNames.containsKey(clazz)) &#123; cachedNames.put(clazz, n); &#125; Class&lt;?&gt; c = extensionClasses.get(n); if (c == null) &#123; extensionClasses.put(n, clazz); // å®ç°ç±»é‡å¤æŠ¥é”™ &#125; else if (c != clazz) &#123; throw new IllegalStateException(...); &#125; &#125; &#125; &#125;&#125; è¦æ³¨æ„çš„å‡ ç‚¹ï¼š @Adaptiveæ³¨è§£æ˜¯æ ‡æ˜ä¸€ä¸ªSPIå®ç°ç±»æ˜¯å±äºè‡ªé€‚åº”ç±»ï¼Œä¸€ä¸ªSPIæ¥å£åªèƒ½æœ‰ä¸€ä¸ªè‡ªé€‚åº”å®ç°ï¼Œè¿™ä»ä»£ç é€»è¾‘å¯ä»¥çœ‹å‡ºæ¥ï¼Œå¦‚æœ!cachedAdaptiveClass.equals(clazz)åˆ™æŠ¥é”™ã€‚å…·ä½“è¿™ä¸ªè‡ªé€‚åº”ç±»å¯ä»¥åšä»€ä¹ˆï¼Œä¸‹é¢ä¼šè¯´ã€‚ Wrapperç±»æ˜¯AOPç±» è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª@Activeæ³¨è§£ï¼Œæ ‡æ˜å®ç°ç±»çš„æ¿€æ´»æ¡ä»¶ï¼Œæ˜¯ä¸€ç§æ¡ä»¶æœºåˆ¶ã€‚ 4.2.2. IOC1234567891011121314151617181920212223242526272829303132333435private T injectExtension(T instance) &#123; try &#123; if (objectFactory != null) &#123; for (Method method : instance.getClass().getMethods()) &#123; if (method.getName().startsWith(\"set\") &amp;&amp; method.getParameterTypes().length == 1 &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123; /** * Check &#123;@link DisableInject&#125; to see if we need auto injection for this property */ if (method.getAnnotation(DisableInject.class) != null) &#123; continue; &#125; Class&lt;?&gt; pt = method.getParameterTypes()[0]; if (ReflectUtils.isPrimitives(pt)) &#123; continue; &#125; try &#123; String property = method.getName().length() &gt; 3 ? method.getName().substring(3, 4).toLowerCase() + method.getName().substring(4) : \"\"; Object object = objectFactory.getExtension(pt, property); if (object != null) &#123; method.invoke(instance, object); &#125; &#125; catch (Exception e) &#123; logger.error(\"fail to inject via method \" + method.getName() + \" of interface \" + type.getName() + \": \" + e.getMessage(), e); &#125; &#125; &#125; &#125; &#125; catch (Exception e) &#123; logger.error(e.getMessage(), e); &#125; return instance;&#125; dubboçš„IOCç›®å‰åªå¯¹setteræ–¹æ³•æ”¯æŒï¼Œå¦‚æœsetçš„æ–¹æ³•å‚æ•°åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆå°±æ‹¿å‚æ•°ç±»å‹ptå’ŒsetPropertyçš„propertyå»objectFactoryæ‰¾ã€‚objectFactoryæ˜¯ExtensionFactoryæ¥å£ï¼Œæœ‰ä¸¤ä¸ªå®ç°ï¼Œ ä¸Šé¢æåˆ°ExtensionLoaderæ„é€ å‡½æ•° 1234private ExtensionLoader(Class&lt;?&gt; type) &#123; this.type = type; objectFactory = (type == ExtensionFactory.class ? null : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());&#125; è¿™é‡Œçš„getAdaptiveExtension()æ˜¯ä»€ä¹ˆï¼Ÿ 4.2.3. @AdaptivegetAdaptiveExtension()çš„å®ç°å¦‚ä¸‹ï¼Œ 12345678910111213141516171819202122232425public T getAdaptiveExtension() &#123; Object instance = cachedAdaptiveInstance.get(); if (instance == null) &#123; if (createAdaptiveInstanceError == null) &#123; synchronized (cachedAdaptiveInstance) &#123; // è¿™æ˜¯å‰é¢spi load classç¼“å­˜çš„ instance = cachedAdaptiveInstance.get(); if (instance == null) &#123; try &#123; // åˆ°è¿™é‡Œè¯´æ˜æ²¡æœ‰è‡ªé€‚åº”æ‰©å±•ç±»,éœ€è¦åŠ¨æ€åˆ›å»º instance = (); cachedAdaptiveInscreateAdaptiveExtensiontance.set(instance); &#125; catch (Throwable t) &#123; createAdaptiveInstanceError = t; throw new IllegalStateException(...); &#125; &#125; &#125; &#125; else &#123; throw new IllegalStateException(...); &#125; &#125; return (T) instance;&#125; dubboçš„Adaptiveæœºåˆ¶å¦‚ä¸‹ å¦‚æœä¸€ä¸ªSPIæ¥å£å®ç°ç±»å­˜åœ¨è‡ªé€‚åº”å®ç°ï¼Œé‚£ä¹ˆç›´æ¥æ‹¿è¿™ä¸ªç±»ï¼› å¦åˆ™åŠ¨æ€åˆ›å»ºè‡ªé€‚åº”ç±»(æ‰‹åŠ¨æ‹¼æ¥ä»£ç å­—ç¬¦ï¼Œå¹¶è½¬ä¸ºå­—èŠ‚ç ï¼ŒåŠ è½½åˆ°jvmä¸­)ï¼Œç”±äºdubboæ˜¯ä»¥urlä¸ºåè®®çš„ï¼Œæ‰€ä»¥åˆ›å»ºçš„è‡ªé€‚åº”ä»£ç æ˜¯æ ¹æ®urlä¸­çš„å†…å®¹å†³å®šä½¿ç”¨é‚£ç§å®ç°ã€‚ å½“ Adaptive æ³¨è§£åœ¨ç±»ä¸Šæ—¶ï¼ŒDubbo ä¸ä¼šä¸ºè¯¥ç±»ç”Ÿæˆä»£ç†ç±»ã€‚æ³¨è§£åœ¨æ–¹æ³•ï¼ˆæ¥å£æ–¹æ³•ï¼‰ä¸Šæ—¶ï¼ŒDubbo åˆ™ä¼šä¸ºè¯¥æ–¹æ³•ç”Ÿæˆä»£ç†é€»è¾‘ã€‚Adaptive æ³¨è§£åœ¨ç±»ä¸Šçš„æƒ…å†µå¾ˆå°‘ï¼Œåœ¨ Dubbo ä¸­ï¼Œä»…æœ‰ä¸¤ä¸ªç±»è¢« Adaptive æ³¨è§£äº†ï¼Œåˆ†åˆ«æ˜¯ AdaptiveCompiler å’Œ AdaptiveExtensionFactoryã€‚æ­¤ç§æƒ…å†µï¼Œè¡¨ç¤ºæ‹“å±•çš„åŠ è½½é€»è¾‘ç”±äººå·¥ç¼–ç å®Œæˆã€‚æ›´å¤šæ—¶å€™ï¼ŒAdaptive æ˜¯æ³¨è§£åœ¨æ¥å£æ–¹æ³•ä¸Šçš„ï¼Œè¡¨ç¤ºæ‹“å±•çš„åŠ è½½é€»è¾‘éœ€ç”±æ¡†æ¶è‡ªåŠ¨ç”Ÿæˆã€‚ ä¸‹é¢æ˜¯alibaba dubbo çš„ä¸­æ–‡æ³¨é‡Š 12345678910111213141516171819202122232425@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)public @interface Adaptive &#123; /** * ä»&#123;@link URL&#125;çš„Keyåï¼Œå¯¹åº”çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåã€‚ * &lt;p&gt; * å¦‚æœ&#123;@link URL&#125;è¿™äº›Keyéƒ½æ²¡æœ‰Valueï¼Œä½¿ç”¨ ç”¨ ç¼ºçœçš„æ‰©å±•ï¼ˆåœ¨æ¥å£çš„&#123;@link SPI&#125;ä¸­è®¾å®šçš„å€¼ï¼‰ã€‚&lt;br&gt; * æ¯”å¦‚ï¼Œ&lt;code&gt;String[] &#123;\"key1\", \"key2\"&#125;&lt;/code&gt;ï¼Œè¡¨ç¤º * &lt;ol&gt; * &lt;li&gt;å…ˆåœ¨URLä¸Šæ‰¾key1çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåï¼› * &lt;li&gt;key1æ²¡æœ‰Valueï¼Œåˆ™ä½¿ç”¨key2çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåã€‚ * &lt;li&gt;key2æ²¡æœ‰Valueï¼Œä½¿ç”¨ç¼ºçœçš„æ‰©å±•ã€‚ * &lt;li&gt;å¦‚æœæ²¡æœ‰è®¾å®šç¼ºçœæ‰©å±•ï¼Œåˆ™æ–¹æ³•è°ƒç”¨ä¼šæŠ›å‡º&#123;@link IllegalStateException&#125;ã€‚ * &lt;/ol&gt; * &lt;p&gt; * å¦‚æœä¸è®¾ç½®åˆ™ç¼ºçœä½¿ç”¨Extensionæ¥å£ç±»åçš„ç‚¹åˆ†éš”å°å†™å­—ä¸²ã€‚&lt;br&gt; * å³å¯¹äºExtensionæ¥å£&#123;@code com.alibaba.dubbo.xxx.YyyInvokerWrapper&#125;çš„ç¼ºçœå€¼ä¸º&lt;code&gt;String[] &#123;\"yyy.invoker.wrapper\"&#125;&lt;/code&gt; * * @see SPI#value() */ String[] value() default &#123;&#125;;&#125; ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ@Adaptiveä¸Šçš„keyä»urlè·å–ä¸åˆ°ï¼Œå°±ä»¥@SPIä¸Šçš„é»˜è®¤æ‰©å±•å€¼ä½œä¸ºkeyå»urlæ‰¾ï¼Œå¦‚æœ@SPIéƒ½æ²¡é»˜è®¤å€¼ï¼Œå°±å°†æ¥å£ç±»åç”¨.åˆ†éš”ï¼Œä½œä¸ºæ¥å£ç¼ºçœå€¼ï¼ˆè¿™ä¹ˆå¥‡æ€ªçš„keyå— =ã€‚=ï¼‰ ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹ï¼Œ 123456789101112@SPI(\"dubbo\")public interface Protocol &#123; int getDefaultPort(); @Adaptive &lt;T&gt; Exporter&lt;T&gt; export(Invoker&lt;T&gt; invoker) throws RpcException; @Adaptive &lt;T&gt; Invoker&lt;T&gt; refer(Class&lt;T&gt; type, URL url) throws RpcException; void destroy();&#125; 1Protocol protocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension(); è¿™é‡Œä¼šè¿”å›ä¸€ä¸ªProtocol$Adaptiveç±»ï¼Œå› ä¸ºProtocolæ²¡æœ‰ä¸€ä¸ªè‡ªé€‚åº”å®ç°ç±»ï¼Œæ‰€ä»¥dubboåŠ¨æ€ç”Ÿæˆäº†ä¸€ä¸ªè‡ªé€‚åº”ç±»ï¼Œé€šè¿‡debugå¾— 12345678910111213141516171819202122232425262728293031323334353637package org.apache.dubbo.rpc;import org.apache.dubbo.common.extension.ExtensionLoader;public class Protocol$Adaptive implements org.apache.dubbo.rpc.Protocol &#123; public void destroy() &#123; throw new UnsupportedOperationException(\"method public abstract void org.apache.dubbo.rpc.Protocol.destroy() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!\"); &#125; public int getDefaultPort() &#123; throw new UnsupportedOperationException(\"method public abstract int org.apache.dubbo.rpc.Protocol.getDefaultPort() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!\"); &#125; public org.apache.dubbo.rpc.Exporter export(org.apache.dubbo.rpc.Invoker arg0) throws org.apache.dubbo.rpc.RpcException &#123; if (arg0 == null) throw new IllegalArgumentException(\"org.apache.dubbo.rpc.Invoker argument == null\"); if (arg0.getUrl() == null) throw new IllegalArgumentException(\"org.apache.dubbo.rpc.Invoker argument getUrl() == null\"); org.apache.dubbo.common.URL url = arg0.getUrl(); // è¿™é‡Œé»˜è®¤ä½¿ç”¨dubbo String extName = (url.getProtocol() == null ? \"dubbo\" : url.getProtocol()); if (extName == null) throw new IllegalStateException(\"Fail to get extension(org.apache.dubbo.rpc.Protocol) name from url(\" + url.toString() + \") use keys([protocol])\"); org.apache.dubbo.rpc.Protocol extension = (org.apache.dubbo.rpc.Protocol) ExtensionLoader.getExtensionLoader(org.apache.dubbo.rpc.Protocol.class).getExtension(extName); return extension.export(arg0); &#125; public org.apache.dubbo.rpc.Invoker refer(java.lang.Class arg0, org.apache.dubbo.common.URL arg1) throws org.apache.dubbo.rpc.RpcException &#123; if (arg1 == null) throw new IllegalArgumentException(\"url == null\"); org.apache.dubbo.common.URL url = arg1; // è¿™é‡Œé»˜è®¤ä½¿ç”¨dubbo String extName = (url.getProtocol() == null ? \"dubbo\" : url.getProtocol()); if (extName == null) throw new IllegalStateException(\"Fail to get extension(org.apache.dubbo.rpc.Protocol) name from url(\" + url.toString() + \") use keys([protocol])\"); org.apache.dubbo.rpc.Protocol extension = (org.apache.dubbo.rpc.Protocol) ExtensionLoader.getExtensionLoader(org.apache.dubbo.rpc.Protocol.class).getExtension(extName); return extension.refer(arg0, arg1); &#125;&#125; è¿™é‡ŒProtocol$Adaptiveä»£ç é‡Œï¼Œå¦‚æœæ¥å£æ–¹æ³•æ²¡æœ‰è®¾ç½®@Adaptiveæ³¨è§£ï¼Œä»¥æŠ›å¼‚å¸¸å¤„ç†ã€‚ åœ¨ç”Ÿæˆçš„æ–¹æ³•ä¸­ï¼Œä»¥protocolä¸ºkeyå»urlé‡ŒæŸ¥æ‰¾è¿™ä¸ªkeyçš„å€¼ï¼Œå¦‚æœurlé‡Œæ²¡æœ‰è®¾ç½®ï¼Œå°±ä»¥Protocolæ¥å£ä¸Šçš„@SPIæ³¨è§£é»˜è®¤å€¼â€”â€”â€œdubboâ€ä½œä¸ºè‡ªé€‚åº”ç±»è¦æ‰¾çš„æ‰©å±•çš„nameã€‚ åˆ›å»ºcodeä»£ç å¤ªé•¿ï¼Œä¸è´´ã€‚ æ‹¿ExtensionFactoryæ¥è¯´ï¼Œä»–æœ‰ä¸‰ä¸ªå®ç°ï¼ˆæœ‰ä¸€ä¸ªåºŸå¼ƒçš„ï¼‰ ä¸€ä¸ªè‡ªé€‚åº”å®ç°ç±»ï¼Œä»¥@Adaptiveæ ‡æ³¨ 1234567891011121314151617181920212223242526@Adaptivepublic class AdaptiveExtensionFactory implements ExtensionFactory &#123; private final List&lt;ExtensionFactory&gt; factories; public AdaptiveExtensionFactory() &#123; ExtensionLoader&lt;ExtensionFactory&gt; loader = ExtensionLoader.getExtensionLoader(ExtensionFactory.class); List&lt;ExtensionFactory&gt; list = new ArrayList&lt;ExtensionFactory&gt;(); for (String name : loader.getSupportedExtensions()) &#123; list.add(loader.getExtension(name)); &#125; factories = Collections.unmodifiableList(list); &#125; @Override public &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name) &#123; for (ExtensionFactory factory : factories) &#123; T extension = factory.getExtension(type, name); if (extension != null) &#123; return extension; &#125; &#125; return null; &#125;&#125; ä¸€ä¸ªç”¨äºè·å–dubbo Spiå®ç°ç±» 1234567891011121314public class SpiExtensionFactory implements ExtensionFactory &#123; @Override public &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name) &#123; if (type.isInterface() &amp;&amp; type.isAnnotationPresent(SPI.class)) &#123; ExtensionLoader&lt;T&gt; loader = ExtensionLoader.getExtensionLoader(type); if (!loader.getSupportedExtensions().isEmpty()) &#123; return loader.getAdaptiveExtension(); &#125; &#125; return null; &#125;&#125; ä¸€ä¸ªæ˜¯ç”¨äºè·å–Springçš„beanï¼Œä»£ç å¤ªé•¿ä¸è´´ 4.2.4. @Active@Activeæ³¨è§£ç”¨äºå®ç°ç±»ä¸Šï¼Œè¡¨ç¤ºä¸€äº›æ¿€æ´»æ¡ä»¶ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)public @interface Activate &#123; /** * Activate the current extension when one of the groups matches. The group passed into * &#123;@link ExtensionLoader#getActivateExtension(URL, String, String)&#125; will be used for matching. * * @return group names to match * @see ExtensionLoader#getActivateExtension(URL, String, String) */ String[] group() default &#123;&#125;; /** * Activate the current extension when the specified keys appear in the URL's parameters. * &lt;p&gt; * For example, given &lt;code&gt;@Activate(\"cache, validation\")&lt;/code&gt;, the current extension will be return only when * there's either &lt;code&gt;cache&lt;/code&gt; or &lt;code&gt;validation&lt;/code&gt; key appeared in the URL's parameters. * &lt;/p&gt; * * @return URL parameter keys * @see ExtensionLoader#getActivateExtension(URL, String) * @see ExtensionLoader#getActivateExtension(URL, String, String) */ String[] value() default &#123;&#125;; /** * Relative ordering info, optional * Deprecated since 2.7.0 * * @return extension list which should be put before the current one */ @Deprecated String[] before() default &#123;&#125;; /** * Relative ordering info, optional * Deprecated since 2.7.0 * * @return extension list which should be put after the current one */ @Deprecated String[] after() default &#123;&#125;; /** * Absolute ordering info, optional * * @return absolute ordering info */ int order() default 0;&#125; åŒæ ·ç”±äºdubboæ˜¯é¢å‘urlçš„åè®®ï¼Œæ‰€ä»¥è¿™äº›æ¿€æ´»æ¡ä»¶éœ€è¦é€šè¿‡urlåŒ¹é…ã€‚ åœ¨åŠ è½½ç±»çš„æ—¶å€™ï¼Œæœ‰è¿™ä¹ˆå‡ è¡Œä»£ç ï¼Œä»¥æ‰©å±•åå­—ä¸ºkeyï¼Œä»¥æ‰©å±•ä¸Šçš„æ³¨è§£ä¸ºå€¼è¿›è¡Œmapç¼“å­˜ã€‚ 1234567891011// org.apache.dubbo.common.extension.ExtensionLoader#loadClassActivate activate = clazz.getAnnotation(Activate.class);if (activate != null) &#123; cachedActivates.put(names[0], activate);&#125; else &#123; // support com.alibaba.dubbo.common.extension.Activate com.alibaba.dubbo.common.extension.Activate oldActivate = clazz.getAnnotation(com.alibaba.dubbo.common.extension.Activate.class); if (oldActivate != null) &#123; cachedActivates.put(names[0], oldActivate); &#125;&#125; è·å–æ¿€æ´»çš„çš„æ‰©å±•å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•è°ƒç”¨ 123456789101112131415161718192021222324252627282930313233public List&lt;T&gt; getActivateExtension(URL url, String key) &#123; return getActivateExtension(url, key, null);&#125;/** * This is equivalent to &lt;pre&gt; * getActivateExtension(url, values, null); * &lt;/pre&gt; * * @param url url * @param values extension point names * @return extension list which are activated * @see #getActivateExtension(com.alibaba.dubbo.common.URL, String[], String) */public List&lt;T&gt; getActivateExtension(URL url, String[] values) &#123; return getActivateExtension(url, values, null);&#125;/** * This is equivalent to &lt;pre&gt; * getActivateExtension(url, url.getParameter(key).split(\",\"), null); * &lt;/pre&gt; * * @param url url * @param key url parameter key which used to get extension point names * @param group group * @return extension list which are activated. * @see #getActivateExtension(com.alibaba.dubbo.common.URL, String[], String) */public List&lt;T&gt; getActivateExtension(URL url, String key, String group) &#123; String value = url.getParameter(key); return getActivateExtension(url, value == null || value.length() == 0 ? null : Constants.COMMA_SPLIT_PATTERN.split(value), group);&#125; è¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950/** * Get activate extensions. * * @param url url * @param values extension point names * @param group group * @return extension list which are activated * @see com.alibaba.dubbo.common.extension.Activate */public List&lt;T&gt; getActivateExtension(URL url, String[] values, String group) &#123; List&lt;T&gt; exts = new ArrayList&lt;T&gt;(); List&lt;String&gt; names = values == null ? new ArrayList&lt;String&gt;(0) : Arrays.asList(values); if (!names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) &#123; getExtensionClasses(); for (Map.Entry&lt;String, Activate&gt; entry : cachedActivates.entrySet()) &#123; String name = entry.getKey(); Activate activate = entry.getValue(); if (isMatchGroup(group, activate.group())) &#123; T ext = getExtension(name); if (!names.contains(name) &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name) &amp;&amp; isActive(activate, url)) &#123; exts.add(ext); &#125; &#125; &#125; // order å€¼è¶Šå°è¶Šé å‰ Collections.sort(exts, ActivateComparator.COMPARATOR); &#125; List&lt;T&gt; usrs = new ArrayList&lt;T&gt;(); for (int i = 0; i &lt; names.size(); i++) &#123; String name = names.get(i); if (!name.startsWith(Constants.REMOVE_VALUE_PREFIX) &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name)) &#123; if (Constants.DEFAULT_KEY.equals(name)) &#123; if (usrs.size() &gt; 0) &#123; exts.addAll(0, usrs); usrs.clear(); &#125; &#125; else &#123; T ext = getExtension(name); usrs.add(ext); &#125; &#125; &#125; if (usrs.size() &gt; 0) &#123; exts.addAll(usrs); &#125; return exts;&#125; 123456789101112131415161718private boolean isActive(String[] keys, URL url) &#123; if (keys.length == 0) &#123; return true; &#125; // ä¸¤æ¬¡forå¾ªç¯ for (String key : keys) &#123; for (Map.Entry&lt;String, String&gt; entry : url.getParameters().entrySet()) &#123; String k = entry.getKey(); String v = entry.getValue(); // å¦‚æœkeyå­˜åœ¨ä¸”å¯¹åº”çš„valueä¸ä¸ºç©º if ((k.equals(key) || k.endsWith(\".\" + key)) &amp;&amp; ConfigUtils.isNotEmpty(v)) &#123; return true; &#125; &#125; &#125; return false;&#125; åŒ¹é…æ¡ä»¶çš„é€»è¾‘æ˜¯ï¼Œå…ˆåŒ¹é…ç»„ï¼Œå†åŒ¹é…é”®ï¼Œé”®åªè¦éƒ½å­˜åœ¨å€¼ï¼Œé‚£ä¹ˆå³åŒ¹é…æˆåŠŸã€‚å½“æ³¨è§£ä¸Šorderå€¼è¶Šå°ï¼Œè¿™ä¸ªå®ç°ç±»çš„æ’åºè¶Šé å‰ã€‚ å…³äºæ’åºï¼Œè¿™é‡Œçš„ä¸€ä¸ªå…·ä½“ä¾‹å­æ˜¯DubboæœåŠ¡çš„è¿‡æ»¤å™¨å¾€å¾€åŠ ä¸Šäº†@Activeæ³¨è§£ï¼Œè¿™æ—¶å€™å¦‚æœè¦è®¾ç½®è¿‡æ»¤å™¨çš„å¤„ç†é¡ºåºï¼Œå°±å¯ä»¥é€šè¿‡è¯¥æ³¨è§£ä¸Šçš„orderå±æ€§è®¾ç½®ã€‚ 5. ç»“æŸè¯­è¿˜å·®Wrapperæœºåˆ¶æ²¡çœ‹ï¼Œwrapperå°±æ˜¯ä¸€ç§aopæœºåˆ¶ï¼Œé€šè¿‡æ‰‹å·¥ç¼–ç çš„æ–¹å¼å®Œæˆaopã€‚å…³äºä¸‹é¢é‚£æ®µè¯æˆ‘ä¹Ÿæ²¡çœ‹åˆ°å…·ä½“çš„ä¾‹å­ã€‚ å¦‚æœæ‰©å±•ç‚¹åŠ è½½å¤±è´¥ï¼Œè¿æ‰©å±•ç‚¹çš„åç§°éƒ½æ‹¿ä¸åˆ°äº†ã€‚æ¯”å¦‚ï¼šJDKæ ‡å‡†çš„ScriptEngineï¼Œé€šè¿‡getName();è·å–è„šæœ¬ç±»å‹çš„åç§°ï¼Œä½†å¦‚æœRubyScriptEngineå› ä¸ºæ‰€ä¾èµ–çš„jruby.jarä¸å­˜åœ¨ï¼Œå¯¼è‡´RubyScriptEngineç±»åŠ è½½å¤±è´¥ï¼Œè¿™ä¸ªå¤±è´¥åŸå› è¢«åƒæ‰äº†ï¼Œå’Œrubyå¯¹åº”ä¸èµ·æ¥ï¼Œå½“ç”¨æˆ·æ‰§è¡Œrubyè„šæœ¬æ—¶ï¼Œä¼šæŠ¥ä¸æ”¯æŒrubyï¼Œè€Œä¸æ˜¯çœŸæ­£å¤±è´¥çš„åŸå› ã€‚ 6. å‚è€ƒ Apache Dubbo SPI","categories":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://htchz.cc/categories/Dubbo/"}],"tags":[{"name":"OOP","slug":"OOP","permalink":"https://htchz.cc/tags/OOP/"}]},{"title":"[Javaä»£ç†]Cglibä»£ç†","slug":"Javaä»£ç†-cglibä»£ç†","date":"2019-03-10T06:03:00.000Z","updated":"2019-08-15T16:08:49.216Z","comments":true,"path":"3922793788.html","link":"","permalink":"https://htchz.cc/3922793788.html","excerpt":"","text":"1. Cglib CGLIBæ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜æ€§èƒ½çš„ä»£ç ç”ŸæˆåŒ…ã€‚CGLIBåŒ…çš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå°è€Œå¿«çš„å­—èŠ‚ç å¤„ç†æ¡†æ¶ASMï¼Œæ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»ã€‚é™¤äº†CGLIBåŒ…ï¼Œè„šæœ¬è¯­è¨€ä¾‹å¦‚Groovyå’ŒBeanShellï¼Œä¹Ÿæ˜¯ä½¿ç”¨ASMæ¥ç”Ÿæˆjavaçš„å­—èŠ‚ç ã€‚å½“ç„¶ä¸é¼“åŠ±ç›´æ¥ä½¿ç”¨ASMï¼Œå› ä¸ºå®ƒè¦æ±‚ä½ å¿…é¡»å¯¹JVMå†…éƒ¨ç»“æ„åŒ…æ‹¬classæ–‡ä»¶çš„æ ¼å¼å’ŒæŒ‡ä»¤é›†éƒ½å¾ˆç†Ÿæ‚‰ã€‚ 2. Demoç›´æ¥ä¸ŠDemoï½ 1234567891011/** * ç›®æ ‡ç±» */public class RunnerDefault implements Runner &#123; private Logger log = LoggerFactory.getLogger(getClass()); @Override public void run(String name) &#123; log.info(&quot;run: &quot; + name); &#125;&#125; æŒ‡å®šCallbackçš„é¡ºåº 123456789public class CglibCallbackFilter implements CallbackFilter &#123; @Override public int accept(Method method) &#123; if (&quot;toString&quot;.equals(method.getName())) &#123; return 1; &#125; return 0; &#125;&#125; ä»£ç†é€»è¾‘åŠç”Ÿæˆä»£ç†çš„å°è£… 1234567891011121314151617// æ‹¦æˆªæ‰€æœ‰æ–¹æ³•public class CglibProxy implements MethodInterceptor &#123; private Enhancer enhancer = new Enhancer(); @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; objects[0] = &quot;cglib &quot; + objects[0]; return methodProxy.invokeSuper(o, objects); &#125; public Object newProxy(Class klass) &#123; enhancer.setSuperclass(klass); enhancer.setCallbackFilter(new CglibCallbackFilter()); enhancer.setCallbacks(new Callback[]&#123;new CglibProxy(), new CglibStringProxy()&#125;); return enhancer.create(); &#125;&#125; 123456789// ä¸ºäº†æ‹¦æˆªtoStringæ–¹æ³•public class CglibStringProxy implements MethodInterceptor &#123; private Logger logger = LoggerFactory.getLogger(this.getClass()); @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; logger.info(\"toString hijacked\"); return null; &#125;&#125; æµ‹è¯•ç±» 123456789@Testpublic void testCglib() &#123; // ç”Ÿæˆclassæ–‡ä»¶ System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, \"./\"); CglibProxy cglibProxy = new CglibProxy(); RunnerDefault runner = (RunnerDefault) cglibProxy.newProxy(RunnerDefault.class); runner.run(\"proxy\"); runner.toString();&#125; è¾“å‡º: 2019-03-07 16:48:44.248 INFO --- [ main] RunnerDefault$$EnhancerByCGLIB$$5b557d48 : run: cglib proxy 2019-03-07 16:48:44.254 INFO --- [ main] com.htc.learning.proxy.CglibStringProxy : toString hijacked ä¹Ÿå¯ä»¥ä¸é…ç½®CallbackFilterï¼Œåªèƒ½é…ä¸€ä¸ªCallbackï¼ŒEnhancerä¼šæŠŠå•ä¸ªçš„Callbackè½¬ä¸ºæ•°ç»„,å¹¶ä¸”æŠŠCallbackFilterè®¾ç½®ä¸ºALL_ZEROï¼Œå›ºå®šè¿”å›0 ä¸‹é¢æ˜¯ä¸Šé¢testæ‰§è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ–‡ä»¶ 3. NamingPolicyä¸Šé¢çš„RunnerDefault$$EnhancerByCGLIB$$16487fcæ˜¯cglibå‘½åè€Œæ¥çš„ï¼Œé»˜è®¤å®ç°ç±»æ˜¯net.sf.cglib.core.DefaultNamingPolicyå‘½åè§„åˆ™å¦‚ä¸‹ï¼š ç›®æ ‡ClassName + &quot;$$&quot; + ä½¿ç”¨cglibå¤„ç†çš„ClassName + &quot;ByCGLIB&quot; + &quot;$$&quot; + keyçš„hashcode4. Keyå’Œç¼“å­˜4.1. KeyFactoryå…ˆçœ‹KeyFactoryï¼Œè¿™ä¸ªç±»å¯ä»¥ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ï¼Œè¿™ä¸ªä»£ç†ç±»å¯¹äºç»™å®šçš„å‚æ•°ï¼Œæ¯æ¬¡è°ƒç”¨è¿”å›çš„å¯¹è±¡çš„equalsã€hashcodeæ–¹æ³•éƒ½æ˜¯è¿”å›ç›¸åŒçš„å€¼ã€‚ç”±äºcglibçš„é…ç½®é¡¹æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ä¸ªç±»ç”¨äºç”Ÿæˆç¼“å­˜keyçš„ã€‚ ç›®æ ‡ç±»éœ€è¦æä¾›ä¸€ä¸ªpublic Object newInstance(...)çš„å£°æ˜ï¼Œå‚æ•°æ•°é‡ç±»å‹éšæ„ã€‚ ä¸‹é¢æ˜¯cglib 12345678910111213141516public class KeySample &#123; private interface MyFactory &#123; public Object newInstance(int a, char[] b, String d); &#125; public static void main(String[] args) &#123; // æºç æ²¡æœ‰è¿™ä¸€è¡Œï¼ŒåŠ ä¸Šè¿™ä¸€è¡Œï¼Œcglibçš„debugæ¨¡å¼æ‰“å¼€ï¼Œå°±å¯ä»¥è¾“å‡ºç”Ÿæˆä»£ç†ç±»çš„classæ–‡ä»¶äº†ã€‚ System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, \"./\"); MyFactory f = (MyFactory)KeyFactory.create(MyFactory.class); Object key1 = f.newInstance(20, new char[]&#123; 'a', 'b' &#125;, \"hello\"); Object key2 = f.newInstance(20, new char[]&#123; 'a', 'b' &#125;, \"hello\"); Object key3 = f.newInstance(20, new char[]&#123; 'a', '_' &#125;, \"hello\"); System.out.println(key1.equals(key2));// true System.out.println(key2.equals(key3));// false &#125;&#125; ä¸‰æ¬¡ç”Ÿæˆçš„æ˜¯ä¸åŒå¯¹è±¡ã€‚key1å’Œkey2æ˜¯ç›¸ç­‰çš„ï¼Œkey2å’Œkey3æ˜¯ä¸ç­‰çš„ã€‚è¿½è¸ªä»£ç å¯ä»¥çœ‹åˆ°KeyFactoryé‡å†™äº†ä»£ç†ç±»çš„equalsã€hashcode 123456789101112131415161718192021222324252627282930313233343536// net.sf.cglib.core.KeyFactory.Generator#generateClass...// hash codee = ce.begin_method(Constants.ACC_PUBLIC, HASH_CODE, null);int hc = (constant != 0) ? constant : PRIMES[(int)(Math.abs(seed) % PRIMES.length)];int hm = (multiplier != 0) ? multiplier : PRIMES[(int)(Math.abs(seed * 13) % PRIMES.length)];e.push(hc);for (int i = 0; i &lt; parameterTypes.length; i++) &#123; e.load_this(); e.getfield(getFieldName(i)); EmitUtils.hash_code(e, parameterTypes[i], hm, customizers);&#125;e.return_value();e.end_method();// equalse = ce.begin_method(Constants.ACC_PUBLIC, EQUALS, null);Label fail = e.make_label();e.load_arg(0);e.instance_of_this();e.if_jump(e.EQ, fail);for (int i = 0; i &lt; parameterTypes.length; i++) &#123; e.load_this(); e.getfield(getFieldName(i)); e.load_arg(0); e.checkcast_this(); e.getfield(getFieldName(i)); EmitUtils.not_equals(e, parameterTypes[i], fail, customizers);&#125;e.push(1);e.return_value();e.mark(fail);e.push(0);e.return_value();e.end_method();... 4.2. ä»£ç†ç¼“å­˜æ‰€æœ‰cglibä»£ç†ç±»çš„ç¼“å­˜éƒ½å­˜åœ¨äºnet.sf.cglib.core.AbstractClassGeneratorçš„staticå˜é‡é‡Œï¼Œ 123private static volatile Map&lt;ClassLoader, ClassLoaderData&gt; CACHE = new WeakHashMap&lt;ClassLoader, ClassLoaderData&gt;();private static final boolean DEFAULT_USE_CACHE = Boolean.parseBoolean(System.getProperty(\"cglib.useCache\", \"true\")); è¿™ä¸ªç¼“å­˜æ˜¯ä¸€ä¸ªWeakHashMapï¼Œkeyå’Œjdkä»£ç†ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä»¥ClassLoaderä¸ºä¸ºkeyï¼Œè‡³äºClassLoaderDataæ˜¯ä¸€ä¸ªå…³äºinterfacesçš„å°è£…ï¼Œåˆ°æœ€åº•å±‚å…¶å®æ˜¯ä¸€ä¸ªConcurrentHashMapã€‚çœ‹net.sf.cglib.core.AbstractClassGenerator#createçš„ä»£ç  1234567891011121314151617181920212223242526272829protected Object create(Object key) &#123; try &#123; ClassLoader loader = getClassLoader(); Map&lt;ClassLoader, ClassLoaderData&gt; cache = CACHE; ClassLoaderData data = cache.get(loader); // ç»´æŠ¤å¤šçº¿ç¨‹ if (data == null) &#123; synchronized (AbstractClassGenerator.class) &#123; cache = CACHE; data = cache.get(loader); if (data == null) &#123; Map&lt;ClassLoader, ClassLoaderData&gt; newCache = new WeakHashMap&lt;ClassLoader, ClassLoaderData&gt;(cache); data = new ClassLoaderData(loader); newCache.put(loader, data); CACHE = newCache; &#125; &#125; &#125; this.key = key; // è¿™é‡Œå‘ç”Ÿäº†äºŒçº§ç¼“å­˜çš„putæ“ä½œ Object obj = data.get(this, getUseCache()); if (obj instanceof Class) &#123; return firstInstance((Class) obj); &#125; return nextInstance(obj); &#125; catch (...) &#123; ... &#125;&#125; çœ‹net.sf.cglib.core.AbstractClassGenerator.ClassLoaderData#getæ–¹æ³• 12345678910public Object get(AbstractClassGenerator gen, boolean useCache) &#123; // ä¸ä½¿ç”¨ç¼“å­˜ç›´æ¥ç”Ÿæˆ if (!useCache) &#123; return gen.generate(ClassLoaderData.this); &#125; else &#123; // åº•å±‚æ˜¯å»ConcurrentHashMapæ‹¿ Object cachedValue = generatedClasses.get(gen); return gen.unwrapCachedValue(cachedValue); &#125;&#125; å‰é¢è¯´åˆ°äºŒçº§ç¼“å­˜å…¶å®æ˜¯ConcurrentHashMap,é‚£ä¹ˆkeyï¼Œvalueåˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿkeyæ˜¯AbstractClassGeneratorå­ç±»å†³å®šçš„ï¼Œæ¯”å¦‚KeyFactoryä½¿ç”¨çš„æ˜¯ç›®æ ‡ç±»åï¼›è‡³äºvalueåˆæœ‰jdkä»£ç†çš„å‘³é“â€”â€”valueå€¼ä¸æ˜¯å›ºå®šçš„ï¼Œå¯èƒ½æ˜¯ç”Ÿæˆçš„ä»£ç†ç±»ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªFutureTaskï¼Œå¤šä¸ªçº¿ç¨‹ä¸‹å¤šä¸ªFutureTaskè°ƒç”¨get()åªä¼šæœ‰ä¸€ä¸ªåœ¨æ‰§è¡Œï¼Œé¿å…äº†é‡å¤ç”Ÿæˆå­—èŠ‚ç ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041protected V createEntry(final K key, KK cacheKey, Object v) &#123; FutureTask&lt;V&gt; task; boolean creator = false; if (v != null) &#123; // Another thread is already loading an instance task = (FutureTask&lt;V&gt;) v; &#125; else &#123; task = new FutureTask&lt;V&gt;(new Callable&lt;V&gt;() &#123; public V call() throws Exception &#123; return loader.apply(key); &#125; &#125;); Object prevTask = map.putIfAbsent(cacheKey, task); if (prevTask == null) &#123; // creator does the load creator = true; task.run(); &#125; else if (prevTask instanceof FutureTask) &#123; task = (FutureTask&lt;V&gt;) prevTask; &#125; else &#123; return (V) prevTask; &#125; &#125; V result; try &#123; result = task.get(); &#125; catch (InterruptedException e) &#123; throw new IllegalStateException(\"Interrupted while loading cache item\", e); &#125; catch (ExecutionException e) &#123; Throwable cause = e.getCause(); if (cause instanceof RuntimeException) &#123; throw ((RuntimeException) cause); &#125; throw new IllegalStateException(\"Unable to load cache item\", cause); &#125; if (creator) &#123; map.put(cacheKey, result); &#125; return result;&#125; 5. EnhancerEnhanceræ˜¯CGLibä¸­çš„ä¸€ä¸ªå­—èŠ‚ç å¢å¼ºå™¨ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½ç”¨è¿™ä¸ªæ¥è¿›è¡Œç”Ÿæˆcglibä»£ç†ç±»ã€‚ 123456789101112131415private Class[] interfaces;private CallbackFilter filter;private Callback[] callbacks;// å›è°ƒé€»è¾‘çš„ç±»å‹ï¼ŒåŒ…æ‹¬ MethodInterceptor|NoOp|LazyLoader|Dispatcher|InvocationHandler|FixedValueprivate Type[] callbackTypes;private boolean validateCallbackTypes;// create()æ˜¯å¦åªç”Ÿæˆä»£ç†ç±»,è€Œä¸æ˜¯è¿”å›ä¸€ä¸ªå¯¹è±¡,å¦‚æœåªç”Ÿæˆä»£ç†ç±»ï¼Œcallbackä¸èƒ½è®¾ç½®ï¼Œä¼šæŠ¥é”™private boolean classOnly;private Class superclass;private Class[] argumentTypes;private Object[] arguments;// æ˜¯å¦ä½¿ç”¨å·¥å‚ç±»private boolean useFactory = true;private Long serialVersionUID;private boolean interceptDuringConstruction = true; ä¸‹é¢æ˜¯åˆ›å»ºé€»è¾‘ 123456789101112131415private Object createHelper() &#123; // è¿™é‡Œè¿›è¡Œä¸€äº›é…ç½®æ ¡éªŒï¼Œæ¯”å¦‚è®¾ç½®äº†å¤šä¸ªCallbackä½†æ˜¯æ²¡æœ‰è®¾ç½®filter preValidate(); // è¿™é‡ŒKEY_FACTORYæ˜¯KeyFactoryå®ä¾‹ Object key = KEY_FACTORY.newInstance((superclass != null) ? superclass.getName() : null, ReflectUtils.getNames(interfaces), filter == ALL_ZERO ? null : new WeakCacheKey&lt;CallbackFilter&gt;(filter), callbackTypes, useFactory, interceptDuringConstruction, serialVersionUID); this.currentKey = key; Object result = super.create(key); return result;&#125; Object result = super.create(key);åˆæ˜¯è·³åˆ°ä¸Šé¢æåˆ°è¿‡çš„net.sf.cglib.core.AbstractClassGenerator#create 123456789101112131415161718192021222324252627protected Object create(Object key) &#123; try &#123; ClassLoader loader = getClassLoader(); Map&lt;ClassLoader, ClassLoaderData&gt; cache = CACHE; ClassLoaderData data = cache.get(loader); if (data == null) &#123; synchronized (AbstractClassGenerator.class) &#123; cache = CACHE; data = cache.get(loader); if (data == null) &#123; Map&lt;ClassLoader, ClassLoaderData&gt; newCache = new WeakHashMap&lt;ClassLoader, ClassLoaderData&gt;(cache); data = new ClassLoaderData(loader); newCache.put(loader, data); CACHE = newCache; &#125; &#125; &#125; this.key = key; Object obj = data.get(this, getUseCache()); if (obj instanceof Class) &#123; return firstInstance((Class) obj); &#125; return nextInstance(obj); &#125; catch (...) &#123; ... &#125;&#125; å¦‚ä¸Šä¸€å°èŠ‚æåˆ°ï¼Œè¿™é‡Œé¢æ˜¯æœ‰ç¼“å­˜çš„ã€‚ 5.1. ä»£ç†ä¸»æµç¨‹net.sf.cglib.proxy.Enhancer#generateClassæ–¹æ³•è´Ÿè´£ç”Ÿæˆä»£ç†ï¼Œä¸»è¦æ˜¯é€šè¿‡CallbackFilterä¸ºä¸åŒçš„Methodæä¾›ä¸åŒçš„Callback 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596public void generateClass(ClassVisitor v) throws Exception &#123; Class sc = (superclass == null) ? Object.class : superclass; if (TypeUtils.isFinal(sc.getModifiers())) throw new IllegalArgumentException(\"Cannot subclass final class \" + sc.getName()); List constructors = new ArrayList(Arrays.asList(sc.getDeclaredConstructors())); filterConstructors(sc, constructors); // Order is very important: must add superclass, then // its superclass chain, then each interface and // its superinterfaces. List actualMethods = new ArrayList(); List interfaceMethods = new ArrayList(); final Set forcePublic = new HashSet(); // çœ‹ä¸‹é¢ä»£ç  getMethods(sc, interfaces, actualMethods, interfaceMethods, forcePublic); // è¿™é‡ŒæŠŠactualMethodsä¸­ï¼Œéabstract,énative,ésynchronizedæ–¹æ³•çš„ä¿®é¥°ç¬¦å…¨éƒ¨å˜æˆfinalï¼Œå°†è½¬åŒ–åçš„æ–¹æ³•ä¿¡æ¯MethodInfoåˆ—è¡¨ è®°å½•åœ¨methodsä¸­ List methods = CollectionUtils.transform(actualMethods, new Transformer() &#123; public Object transform(Object value) &#123; Method method = (Method)value; int modifiers = Constants.ACC_FINAL | (method.getModifiers() &amp; ~Constants.ACC_ABSTRACT &amp; ~Constants.ACC_NATIVE &amp; ~Constants.ACC_SYNCHRONIZED); if (forcePublic.contains(MethodWrapper.create(method))) &#123; modifiers = (modifiers &amp; ~Constants.ACC_PROTECTED) | Constants.ACC_PUBLIC; &#125; return ReflectUtils.getMethodInfo(method, modifiers); &#125; &#125;); ClassEmitter e = new ClassEmitter(v); // è¿™ä¸ªcurrentDataä¸çŸ¥é“æ˜¯å¹²å˜›çš„ if (currentData == null) &#123; e.begin_class(Constants.V1_2, Constants.ACC_PUBLIC, getClassName(), Type.getType(sc), (useFactory ? TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) : TypeUtils.getTypes(interfaces)), Constants.SOURCE_FILE); &#125; else &#123; e.begin_class(Constants.V1_2, Constants.ACC_PUBLIC, getClassName(), null, new Type[]&#123;FACTORY&#125;, Constants.SOURCE_FILE); &#125; List constructorInfo = CollectionUtils.transform(constructors, MethodInfoTransformer.getInstance()); e.declare_field(Constants.ACC_PRIVATE, BOUND_FIELD, Type.BOOLEAN_TYPE, null); e.declare_field(Constants.ACC_PUBLIC | Constants.ACC_STATIC, FACTORY_DATA_FIELD, OBJECT_TYPE, null); if (!interceptDuringConstruction) &#123; e.declare_field(Constants.ACC_PRIVATE, CONSTRUCTED_FIELD, Type.BOOLEAN_TYPE, null); &#125; e.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, null); e.declare_field(Constants.PRIVATE_FINAL_STATIC, STATIC_CALLBACKS_FIELD, CALLBACK_ARRAY, null); if (serialVersionUID != null) &#123; e.declare_field(Constants.PRIVATE_FINAL_STATIC, Constants.SUID_FIELD_NAME, Type.LONG_TYPE, serialVersionUID); &#125; // æ ¹æ®callbackTypeså¢åŠ å±æ€§ï¼Œåå­—ä¸ºCGLIB$CALLBACK_xx(xxæ˜¯åºå·) for (int i = 0; i &lt; callbackTypes.length; i++) &#123; e.declare_field(Constants.ACC_PRIVATE, getCallbackField(i), callbackTypes[i], null); &#125; // This is declared private to avoid \"public field\" pollution e.declare_field(Constants.ACC_PRIVATE | Constants.ACC_STATIC, CALLBACK_FILTER_FIELD, OBJECT_TYPE, null); if (currentData == null) &#123; // ä¸ºç›®æ ‡æ–¹æ³•é…ç½®Callback emitMethods(e, methods, actualMethods); emitConstructors(e, constructorInfo); &#125; else &#123; emitDefaultConstructor(e); &#125; emitSetThreadCallbacks(e); emitSetStaticCallbacks(e); emitBindCallbacks(e); if (useFactory || currentData != null) &#123; int[] keys = getCallbackKeys(); emitNewInstanceCallbacks(e); emitNewInstanceCallback(e); emitNewInstanceMultiarg(e, constructorInfo); emitGetCallback(e, keys); emitSetCallback(e, keys); emitGetCallbacks(e); emitSetCallbacks(e); &#125; e.end_class();&#125; 5.2. è·å–è¦ä»£ç†çš„æ–¹æ³•123456789101112131415161718192021222324252627private static void getMethods(Class superclass, Class[] interfaces, List methods, List interfaceMethods, Set forcePublic)&#123; // ä¸‹é¢è¿™ä¸€å¨æ˜¯æŠŠç›®æ ‡ç±»çš„æ–¹æ³•ï¼Œæ¥å£æ–¹æ³•çš„ä¿¡æ¯ï¼ˆç±»å‹æ˜¯ MethodInfoï¼‰éƒ½åŠ å…¥åˆ°methodsåˆ—è¡¨é‡Œ ReflectUtils.addAllMethods(superclass, methods); List target = (interfaceMethods != null) ? interfaceMethods : methods; if (interfaces != null) &#123; for (int i = 0; i &lt; interfaces.length; i++) &#123; if (interfaces[i] != Factory.class) &#123; ReflectUtils.addAllMethods(interfaces[i], target); &#125; &#125; &#125; if (interfaceMethods != null) &#123; if (forcePublic != null) &#123; forcePublic.addAll(MethodWrapper.createSet(interfaceMethods)); &#125; methods.addAll(interfaceMethods); &#125; // è¿‡æ»¤staticæ–¹æ³• CollectionUtils.filter(methods, new RejectModifierPredicate(Constants.ACC_STATIC)); // æ ¹æ®å¸ƒå°”å€¼å†³å®šæ˜¯å¦è¿‡æ»¤protectedçš„æ–¹æ³•ï¼Œè¿‡æ»¤privateæ–¹æ³• CollectionUtils.filter(methods, new VisibilityPredicate(superclass, true)); // è¿‡æ»¤é‡å¤ CollectionUtils.filter(methods, new DuplicatesPredicate(methods)); // è¿‡æ»¤finalæ–¹æ³• CollectionUtils.filter(methods, new RejectModifierPredicate(Constants.ACC_FINAL));&#125; é’ˆå¯¹demoçš„RunnerDefaultï¼Œè·å–åˆ°çš„æœ€ç»ˆæ–¹æ³•ä¸º 5.3. ä¸ºç›®æ ‡æ–¹æ³•é…ç½®Callback123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144// methodsçš„ç±»å‹æ˜¯MethodInfoï¼Œä¸»è¦æ˜¯æ”¹äº†åŸæ–¹æ³•çš„modifiers// actualMethodsçš„ç±»å‹Methodprivate void emitMethods(final ClassEmitter ce, List methods, List actualMethods) &#123; CallbackGenerator[] generators = CallbackInfo.getGenerators(callbackTypes); Map groups = new HashMap(); final Map indexes = new HashMap(); final Map originalModifiers = new HashMap(); final Map positions = CollectionUtils.getIndexMap(methods); final Map declToBridge = new HashMap(); Iterator it1 = methods.iterator(); Iterator it2 = (actualMethods != null) ? actualMethods.iterator() : null; while (it1.hasNext()) &#123; MethodInfo method = (MethodInfo)it1.next(); Method actualMethod = (it2 != null) ? (Method)it2.next() : null; // è·å– index int index = filter.accept(actualMethod); if (index &gt;= callbackTypes.length) &#123; throw new IllegalArgumentException(\"Callback filter returned an index that is too large: \" + index); &#125; originalModifiers.put(method, new Integer((actualMethod != null) ? actualMethod.getModifiers() : method.getModifiers())); // æŠŠindexæ”¾å…¥map indexes.put(method, new Integer(index)); List group = (List)groups.get(generators[index]); if (group == null) &#123; groups.put(generators[index], group = new ArrayList(methods.size())); &#125; group.add(method); // Optimization: build up a map of Class -&gt; bridge methods in class // so that we can look up all the bridge methods in one pass for a class. if (TypeUtils.isBridge(actualMethod.getModifiers())) &#123; Set bridges = (Set)declToBridge.get(actualMethod.getDeclaringClass()); if (bridges == null) &#123; bridges = new HashSet(); declToBridge.put(actualMethod.getDeclaringClass(), bridges); &#125; bridges.add(method.getSignature()); &#125; &#125; final Map bridgeToTarget = new BridgeMethodResolver(declToBridge, getClassLoader()).resolveAll(); Set seenGen = new HashSet(); CodeEmitter se = ce.getStaticHook(); se.new_instance(THREAD_LOCAL); se.dup(); se.invoke_constructor(THREAD_LOCAL, CSTRUCT_NULL); se.putfield(THREAD_CALLBACKS_FIELD); final Object[] state = new Object[1]; CallbackGenerator.Context context = new CallbackGenerator.Context() &#123; public ClassLoader getClassLoader() &#123; return Enhancer.this.getClassLoader(); &#125; public int getOriginalModifiers(MethodInfo method) &#123; return ((Integer)originalModifiers.get(method)).intValue(); &#125; public int getIndex(MethodInfo method) &#123; return ((Integer)indexes.get(method)).intValue(); &#125; // æ ¹æ®indexè·å–å¯¹åº”çš„Callbackï¼ˆä»DeclaredFieldè·å–ï¼‰ public void emitCallback(CodeEmitter e, int index) &#123; emitCurrentCallback(e, index); &#125; public Signature getImplSignature(MethodInfo method) &#123; return rename(method.getSignature(), ((Integer)positions.get(method)).intValue()); &#125; public void emitLoadArgsAndInvoke(CodeEmitter e, MethodInfo method) &#123; // If this is a bridge and we know the target was called from invokespecial, // then we need to invoke_virtual w/ the bridge target instead of doing // a super, because super may itself be using super, which would bypass // any proxies on the target. Signature bridgeTarget = (Signature)bridgeToTarget.get(method.getSignature()); if (bridgeTarget != null) &#123; // checkcast each argument against the target's argument types for (int i = 0; i &lt; bridgeTarget.getArgumentTypes().length; i++) &#123; e.load_arg(i); Type target = bridgeTarget.getArgumentTypes()[i]; if (!target.equals(method.getSignature().getArgumentTypes()[i])) &#123; e.checkcast(target); &#125; &#125; e.invoke_virtual_this(bridgeTarget); Type retType = method.getSignature().getReturnType(); // Not necessary to cast if the target &amp; bridge have // the same return type. // (This conveniently includes void and primitive types, // which would fail if casted. It's not possible to // covariant from boxed to unbox (or vice versa), so no having // to box/unbox for bridges). // TODO: It also isn't necessary to checkcast if the return is // assignable from the target. (This would happen if a subclass // used covariant returns to narrow the return type within a bridge // method.) if (!retType.equals(bridgeTarget.getReturnType())) &#123; e.checkcast(retType); &#125; &#125; else &#123; e.load_args(); e.super_invoke(method.getSignature()); &#125; &#125; public CodeEmitter beginMethod(ClassEmitter ce, MethodInfo method) &#123; CodeEmitter e = EmitUtils.begin_method(ce, method); if (!interceptDuringConstruction &amp;&amp; !TypeUtils.isAbstract(method.getModifiers())) &#123; Label constructed = e.make_label(); e.load_this(); e.getfield(CONSTRUCTED_FIELD); e.if_jump(e.NE, constructed); e.load_this(); e.load_args(); e.super_invoke(); e.return_value(); e.mark(constructed); &#125; return e; &#125; &#125;; for (int i = 0; i &lt; callbackTypes.length; i++) &#123; CallbackGenerator gen = generators[i]; if (!seenGen.contains(gen)) &#123; seenGen.add(gen); final List fmethods = (List)groups.get(gen); if (fmethods != null) &#123; try &#123; gen.generate(ce, context, fmethods); gen.generateStatic(se, context, fmethods); &#125; catch (RuntimeException x) &#123; throw x; &#125; catch (Exception x) &#123; throw new CodeGenerationException(x); &#125; &#125; &#125; &#125; se.return_value(); se.end_method();&#125; è¿™é‡Œä»£ç æ²¡æœ‰çœ‹çš„å¾ˆç»†ï¼Œäº†è§£äº†å¤§æ¦‚ã€‚ ä¸€ä¸ªæ–¹æ³•åªä¼šæœ‰ä¸€ä¸ªCallbackã€‚ è¿™ä¸€èŠ‚ï¼Œæœ€åçœ‹ä¸€ä¸‹ä»£ç†å‡ºæ¥çš„ç±»çš„ä»£ç  12345678910111213public final void run(String var1) &#123; MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (var10000 == null) &#123; CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; &#125; if (var10000 != null) &#123; var10000.intercept(this, CGLIB$run$0$Method, new Object[]&#123;var1&#125;, CGLIB$run$0$Proxy); &#125; else &#123; super.run(var1); &#125;&#125; å…¶ä¸­ 12345// CGLIB$run$0$Method Method CGLIB$run$0$Method = ReflectUtils.findMethods(new String[]&#123;\"run\", \"(Ljava/lang/String;)V\"&#125;, (var1 = Class.forName(\"com.htc.learning.api.impl.RunnerDefault\")).getDeclaredMethods())[0];// CGLIB$run$0$ProxyMethodProxy CGLIB$run$0$Proxy = MethodProxy.create(var1, var0, \"(Ljava/lang/String;)V\", \"run\", \"CGLIB$run$0\"); æ‰€ä»¥é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œä»£ç†ç±»å°†è°ƒç”¨è½¬å‘ç»™ä¸€ä¸ªCallbackï¼Œåœ¨Callbacké‡Œï¼Œå¦‚æœè¦æ‰§è¡Œç›®æ ‡ç±»çš„ç›®æ ‡æ–¹æ³•ï¼Œå³è°ƒç”¨net.sf.cglib.proxy.MethodProxy#invokeSuper ç­‰ç­‰ï¼ŒMethodProxyæ˜¯ä»€ä¹ˆ æ­¤å¤–ä»ç”Ÿæˆçš„ç±»é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹é™¤äº†Enhancerå’ŒKeyFactoryçš„å¢å¼ºç±»ä¹‹å¤–ï¼Œè¿˜ç”Ÿæˆäº†ä¸‰ä¸ªç±» ç¬¬äºŒä¸ªæ˜¯æˆ‘ä»¬çš„ä»£ç†ç±»ï¼Œé‚£ä¹ˆå…¶ä½™ä¸¤ä¸ªæ˜¯å¹²å˜›çš„ï¼ŒFastClassåˆæ˜¯ä»€ä¹ˆ? 6. MethodProxyä¸Fastclass6.1. ä¸ºä»€ä¹ˆè¦æœ‰MethodProxyã€Fastclassæˆ‘ä»¬é…ç½®ä»£ç†çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ä¼ å…¥ä¸€ä¸ªç›®æ ‡ç±»å®ä¾‹ï¼Œè€Œæ˜¯ä¼ å…¥ç›®æ ‡ç±»çš„classï¼Œè¿™æ—¶æˆ‘ä»¬è¦å»è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœæ¯æ¬¡éƒ½é åå°„ï¼Œé‚£å°±æ²¡æœ‰ç›´æ¥è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ¥çš„å¿«ã€‚ æ²¡é”™æ¯æ¬¡éƒ½é åå°„è¯´çš„å°±æ˜¯ä½ jdkä»£ç†ã€‚ 6.2. MethodProxyMethodProxyè¡¨æ˜äº†ä¸€ä¸ªæ–¹æ³•åˆ°å¦ä¸€ä¸ªæ–¹æ³•çš„æ˜ å°„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£ç†ç±»runæ–¹æ³•çš„ä»£ç  1234567891011121314public final void run(String var1) &#123; MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (var10000 == null) &#123; CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; &#125; if (var10000 != null) &#123; // CGLIB$run$0$Proxy å³æ˜¯ MethodProxy var10000.intercept(this, CGLIB$run$0$Method, new Object[]&#123;var1&#125;, CGLIB$run$0$Proxy); &#125; else &#123; super.run(var1); &#125;&#125; å…¶ä¸­, 123Class var0 = Class.forName(\"com.htc.learning.api.impl.RunnerDefault$$EnhancerByCGLIB$$5b557d48\"); Class var1 = Class.forName(\"com.htc.learning.api.impl.RunnerDefault\")CGLIB$run$0$Proxy = MethodProxy.create(var1, var0, \"(Ljava/lang/String;)V\", \"run\", \"CGLIB$run$0\"); å†å…¶ä¸­ï¼Œ&quot;CGLIB$run$0&quot;æ˜¯Enhancerä»£ç†ç±»é‡Œçš„ä¸€ä¸ªå·²ç»ç”Ÿæˆçš„æ–¹æ³•ï¼Œ 123final void CGLIB$run$0(String var1) &#123; super.run(var1);&#125; MethodProxyçš„createæ–¹æ³•ï¼Œ 1234567public static MethodProxy create(Class c1, Class c2, String desc, String name1, String name2) &#123; MethodProxy proxy = new MethodProxy(); proxy.sig1 = new Signature(name1, desc); proxy.sig2 = new Signature(name2, desc); proxy.createInfo = new MethodProxy.CreateInfo(c1, c2); return proxy;&#125; è¿™ä¸€æ®µå°±æ˜¯è¯´c1çš„æ–¹æ³•name1,å¯¹åº”çš„ä»£ç†æ–¹æ³•æ˜¯å®ç°ç±»c2çš„æ–¹æ³•name2ã€‚å†å…·ä½“ä¸€ç‚¹ï¼ŒRunnerDefaultçš„runæ–¹æ³•ï¼Œå¯¹åº”çš„å°±æ˜¯com.htc.learning.api.impl.RunnerDefault$$EnhancerByCGLIB$$5b557d48çš„CGLIB$run$0æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªç­¾åæ²¡æœ‰ä¾èµ–ï¼ŒMethodProxyåˆ©ç”¨è¿™ä¸¤ä¸ªç­¾åï¼Œæä¾›ä¸¤ç§ä¸åŒçš„ç›®æ ‡æ–¹æ³•è°ƒç”¨ï¼Œ 6.3. FastClassä¸Šé¢åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå…³è”å…³ç³»ï¼Œæ¥ä¸‹æ¥çœ‹net.sf.cglib.proxy.MethodProxy#invokeSuper 12345678910111213141516171819202122232425262728293031323334353637383940public Object invokeSuper(Object obj, Object[] args) throws Throwable &#123; try &#123; this.init(); MethodProxy.FastClassInfo fci = this.fastClassInfo; // f2æ˜¯Enhancerä»£ç†ç±»ï¼Œi2æ˜¯é…ç½®å¥½çš„å¯ä»¥è°ƒç”¨åˆ°ç›®æ ‡æ–¹æ³•çš„ç´¢å¼•ï¼Œinvokeæ ¹æ®ç´¢å¼•ï¼Œä½¿ç”¨switchå—ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼Œè€Œä¸æ˜¯åˆ©ç”¨åå°„ return fci.f2.invoke(fci.i2, obj, args); &#125; catch (InvocationTargetException var4) &#123; throw var4.getTargetException(); &#125;&#125;private void init() &#123; // å•ä¾‹æ¨¡å¼ï¼Œé˜²æ­¢é‡å¤åˆ›å»º if (this.fastClassInfo == null) &#123; synchronized(this.initLock) &#123; if (this.fastClassInfo == null) &#123; MethodProxy.CreateInfo ci = this.createInfo; MethodProxy.FastClassInfo fci = new MethodProxy.FastClassInfo(); fci.f1 = helper(ci, ci.c1); fci.f2 = helper(ci, ci.c2); fci.i1 = fci.f1.getIndex(this.sig1); fci.i2 = fci.f2.getIndex(this.sig2); this.fastClassInfo = fci; this.createInfo = null; &#125; &#125; &#125;&#125;private static FastClass helper(MethodProxy.CreateInfo ci, Class type) &#123; Generator g = new Generator(); g.setType(type); g.setClassLoader(ci.c2.getClassLoader()); g.setNamingPolicy(ci.namingPolicy); g.setStrategy(ci.strategy); g.setAttemptLoad(ci.attemptLoad); // è¿›å»ä»£ç åå¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†ç¼“å­˜ï¼Œæ‰€ä»¥ä¸ä¼šé‡å¤ç”ŸæˆFastClass return g.create();&#125; 123456789private static class FastClassInfo &#123; FastClass f1; FastClass f2; int i1; int i2; private FastClassInfo() &#123; &#125;&#125; è¿™ä¸ªå‚æ•°å‘½ä»¤å®åœ¨æœ‰ç‚¹éš¾æ‡‚ï¼Œæ¢³ç†ä¸€ä¸‹ï¼Œé’ˆå¯¹runæ–¹æ³•ï¼Œ å‚æ•° è¯´æ˜ c1 RunnerDefault f1 RunnerDefault$$FastClassByCGLIB$$a60a67a3 i1 ç›®æ ‡ç±»runçš„ç´¢å¼• c2 RunnerDefault$$EnhancerByCGLIB$$5b557d48 (Enhancerä»£ç†ç±») f2 RunnerDefault$$EnhancerByCGLIB$$5b557d48$$FastClassByCGLIB$$9f176e41ï¼ˆEnhancerä»£ç†ç±»çš„ä¸€ä¸ªå¿«é€ŸæŸ¥æ‰¾ç±»ï¼‰ i2 Enhancerä»£ç†ç±»è°ƒç”¨runçš„ç´¢å¼• ä¸‹é¢æ˜¯RunnerDefault$$FastClassByCGLIB$$a60a67a3çš„éƒ¨åˆ†ä»£ç (å¦‚æœæ˜¯RunnerDefault$$EnhancerByCGLIB$$5b557d48$$FastClassByCGLIB$$9f176e41switchå—ä¼šæ›´å¤§ï¼Œå› ä¸ºRunnerDefault$$EnhancerByCGLIB$$5b557d48çš„æ–¹æ³•æ›´å¤š) 1234567891011121314151617181920212223242526public int getIndex(Signature var1) &#123; String var10000 = var1.toString(); switch(var10000.hashCode()) &#123; case -1717138348: if (var10000.equals(\"run(Ljava/lang/String;)V\")) &#123; return 0; &#125; break; case 1826985398: if (var10000.equals(\"equals(Ljava/lang/Object;)Z\")) &#123; return 1; &#125; break; case 1913648695: if (var10000.equals(\"toString()Ljava/lang/String;\")) &#123; return 2; &#125; break; case 1984935277: if (var10000.equals(\"hashCode()I\")) &#123; return 3; &#125; &#125; return -1;&#125; 1234567891011121314151617181920212223// æ³¨æ„è¿™çš„var2æ˜¯Enhancerä»£ç†ç±»public Object invoke(int var1, Object var2, Object[] var3) throws InvocationTargetException &#123; RunnerDefault var10000 = (RunnerDefault)var2; int var10001 = var1; try &#123; switch(var10001) &#123; case 0: var10000.run((String)var3[0]); return null; case 1: return new Boolean(var10000.equals(var3[0])); case 2: return var10000.toString(); case 3: return new Integer(var10000.hashCode()); &#125; &#125; catch (Throwable var4) &#123; throw new InvocationTargetException(var4); &#125; throw new IllegalArgumentException(\"Cannot find matching method/constructor\");&#125; 6.4. StackOverflowErrorå¦‚æœæˆ‘ä»¬å†™Callbackçš„æ—¶å€™ï¼ŒæŠŠinvokeSuperå†™æˆinvokeä¼šæ€ä¹ˆæ ·ï¼Œç­”æ¡ˆæ˜¯ï¼šæ ˆæº¢å‡ºã€‚MethodProxyçš„invokeæ–¹æ³•æ˜¯è¿™æ ·çš„ï¼Œ 123456789public Object invoke(Object obj, Object[] args) throws Throwable &#123; try &#123; this.init(); MethodProxy.FastClassInfo fci = this.fastClassInfo; return fci.f1.invoke(fci.i1, obj, args); &#125; catch (...) &#123; ... &#125;&#125; è¿™é‡Œçš„objæ˜¯Enhancerä»£ç†ç±»ï¼Œè€Œf1æ˜¯RunnerDefault$$FastClassByCGLIB$$a60a67a3ï¼Œæ‰€ä»¥åˆä¼šç´¢å¼•åˆ°Enhancerä»£ç†ç±»çš„ä»£ç†runæ–¹æ³•ï¼Œæ¥ç€åˆæ‰§è¡Œä¸Šé¢çš„invoke,balabalaâ€¦é™·å…¥æ­»å¾ªç¯ã€‚ 6.5. invokeä¸invokeSuperé‚£æ˜¯ä¸æ˜¯invokeä¸èƒ½è¢«è°ƒç”¨äº†ï¼Ÿä¸æ˜¯ï¼Œä¸Šé¢è¯´åˆ°MethodProxyåˆ©ç”¨è¿™ä¸¤ä¸ªç­¾åï¼Œæä¾›ä¸¤ç§ä¸åŒçš„ç›®æ ‡æ–¹æ³•è°ƒç”¨ï¼Œæ‰€ä»¥ï¼Œinvokeæ˜¯å¦ä¸€ç§è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„å§¿åŠ¿ã€‚ å†™Callbackçš„æ—¶å€™ï¼Œ 12345@Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; objects[0] = \"cglib \" + objects[0]; return methodProxy.invokeSuper(o, objects); &#125; ä¼ å…¥çš„Object oæ˜¯Enhancerä»£ç†ç±»ï¼Œè€Œæˆ‘ä»¬ä¸èƒ½æ‰§è¡ŒmethodProxy.invoke(o, objects)é™·å…¥æ­»å¾ªç¯ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨Callbackéœ€è¦ä¿å­˜ä¸€ä¸ªç›®æ ‡ç±»å®ä¾‹çš„å¼•ç”¨targetï¼Œç„¶åmethodProxy.invoke(target, objects)ã€‚ 6.6. æ€»ç»“MethodProxyä¸Fastclassæä¾›äº†ä¸€ä¸ª Signature -&gt; index -&gt; invokeçš„æœºåˆ¶ã€‚ 7. ç¼ºé™·å¦‚æœç†è§£äº†FastClassï¼Œé‚£ä¹ˆå¾ˆå®¹çŒœæµ‹cglibçš„æ€§èƒ½ç“¶é¢ˆåœ¨äºï¼Œå½“ç›®æ ‡ç±»çš„æ–¹æ³•å¾ˆå¤šçš„æ—¶å€™ï¼Œswitchå—å°±æ˜¯ä¸€ä¸ªå¾ˆæ…¢çš„æŸ¥æ‰¾ï¼Œè¿™ä¸ªæŸ¥æ‰¾æ˜¯æœ‰ä¼˜åŒ–ç©ºé—´çš„ã€‚æ­¤å¤–ï¼Œcglibä»£ç†çš„åˆ›å»ºæ—¶é—´ä¼šæ¯”jdkä»£ç†çš„åˆ›å»ºæ›´è€—æ—¶é—´ï¼Œä¸è¿‡æˆ‘è§‰å¾—è¿™éƒ½ä¸æ˜¯äº‹ã€‚ 8. å‚è€ƒ cglib demoä»¥åŠEnhanceræºç è§£æ","categories":[{"name":"Proxy","slug":"Proxy","permalink":"https://htchz.cc/categories/Proxy/"}],"tags":[{"name":"AOP","slug":"AOP","permalink":"https://htchz.cc/tags/AOP/"}]},{"title":"[Javaä»£ç†]Jdkä»£ç†","slug":"Javaä»£ç†-jdkä»£ç†","date":"2019-03-04T16:16:00.000Z","updated":"2019-08-15T16:08:49.215Z","comments":true,"path":"68869360.html","link":"","permalink":"https://htchz.cc/68869360.html","excerpt":"","text":"1. å‰è¨€ç›¸æ¯”é™æ€ä»£ç†éœ€è¦æ‰‹åŠ¨å†™ä»£ç†ç±»ï¼ŒåŠ¨æ€ä»£ç†å¯ä»¥é€šè¿‡æŠ½è±¡ä»£ç å®Œæˆå¯¹ä¸€å®šè§„åˆ™çš„ç±»çš„ä»£ç†ï¼Œç”Ÿæˆçš„ä»£ç†ç±»ç›´æ¥ä»¥å­—èŠ‚ç çš„å½¢å¼å­˜åœ¨äºå†…å­˜ä¸­ã€‚Springé‡ŒAopçš„å®ç°ä½¿ç”¨äº†ä¸¤ç§åŠ¨æ€ä»£ç†æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯jdkä»£ç†ï¼Œä¸€ç§æ˜¯cglibä»£ç†ã€‚ jdkä»£ç†æ˜¯ä»ç›®æ ‡ç±»çš„æ¥å£ç”Ÿæˆå®ç°ç±»ï¼Œcglibæ˜¯ç»§æ‰¿ç›®æ ‡ç±»ç”Ÿæˆå­ç±»ã€‚ 2. Demo123456/** * æ¥å£ */public interface Runner &#123; void run(String name);&#125; 123456789101112/** * æ¥å£å®ç°ç±» * created by Huang.Zhen on 2019-02-22 */public class RunnerDefault implements Runner &#123; private Logger log = LoggerFactory.getLogger(getClass()); @Override public void run(String name) &#123; log.info(\"run: \" + name); &#125;&#125; 1234567891011121314151617181920212223242526272829/** * ä»£ç†ç±» * created by Huang Zhen on 2019-02-22 */public class JdkProxyHandler implements InvocationHandler &#123; private Logger log = LoggerFactory.getLogger(getClass()); private Object target; // ä¿å­˜ç›®æ ‡ç±»çš„å¼•ç”¨ public JdkProxyHandler(Object target) &#123; this.target = target; &#125; /** * å¯¹newProxyInstanceæ–¹æ³•çš„å°è£… * @return ä»£ç†ç±» */ public Object getProxy() &#123; // ç”Ÿæˆä»£ç†ç±» return Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), this); &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; args[0] = \"jdk \" + args[0]; return method.invoke(target, args); &#125;&#125; ç”¨ä¸‹é¢çš„ä»£ç è·å–ä»£ç†ç±»å¹¶è¿è¡Œ 12345@Testpublic void testJdk() &#123; Runner runner = (Runner) new JdkProxyHandler(new RunnerDefault()).getProxy(); runner.run(\"proxy\");&#125; è¾“å‡º 2019-03-01 16:02:17.623 INFO --- [ main] com.htc.learning.api.impl.RunnerDefault : run: jdk proxy3. åŸç†3.1. æ€ä¹ˆç”Ÿæˆä»£ç†ç±»classæ–‡ä»¶ç›´æ£Proxy.newProxyInstanceæ–¹æ³•ï¼Œ 1234/* * Look up or generate the designated proxy class. */Class&lt;?&gt; cl = getProxyClass0(loader, intfs); è¿›å…¥getProxyClass0ï¼Œä»proxyClassCacheå­—é¢ä¸Šç†è§£ï¼Œjdkä»£ç†æ˜¯æœ‰ç¼“å­˜çš„ 1234// If the proxy class defined by the given loader implementing// the given interfaces exists, this will simply return the cached copy;// otherwise, it will create the proxy class via the ProxyClassFactoryreturn proxyClassCache.get(loader, interfaces); è¿›å…¥getæ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°å‡ºç°äº†jdk8çº§åˆ«çš„ä»£ç ï¼Œè¯´æ˜jdk8é‡Œjdkä»£ç†åˆè¢«ä¼˜åŒ–äº† 1234567891011// create subKey and retrieve the possible Supplier&lt;V&gt; stored by that// subKey from valuesMap// subKeyFactory å…¶å®æ˜¯ java.lang.reflect.Proxy.ProxyClassFactoryObject subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));Supplier&lt;V&gt; supplier = valuesMap.get(subKey);...V value = supplier.get();if (value != null) &#123; return value;&#125;... è¿›å…¥java.lang.reflect.Proxy.ProxyClassFactory#applyæ–¹æ³• 1234567.../* * Generate the specified proxy class. */byte[] proxyClassFile = ProxyGenerator.generateProxyClass( proxyName, interfaces, accessFlags);... 123456789101112131415161718192021222324252627282930public static byte[] generateProxyClass(final String var0, Class&lt;?&gt;[] var1, int var2) &#123; ProxyGenerator var3 = new ProxyGenerator(var0, var1, var2); // ç”Ÿæˆå­—èŠ‚ç çš„æ–¹æ³•ï¼Œä¸æƒ³çœ‹ final byte[] var4 = var3.generateClassFile(); // è¿™é‡Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è®¾ç½®è¦ä¸è¦å­˜å‚¨ç”Ÿæˆçš„classæ–‡ä»¶ if (saveGeneratedFiles) &#123; AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123; public Void run() &#123; try &#123; int var1 = var0.lastIndexOf(46); Path var2; if (var1 &gt; 0) &#123; Path var3 = Paths.get(var0.substring(0, var1).replace('.', File.separatorChar)); Files.createDirectories(var3); var2 = var3.resolve(var0.substring(var1 + 1, var0.length()) + \".class\"); &#125; else &#123; var2 = Paths.get(var0 + \".class\"); &#125; Files.write(var2, var4, new OpenOption[0]); return null; &#125; catch (IOException var4x) &#123; throw new InternalError(\"I/O exception saving generated file: \" + var4x); &#125; &#125; &#125;); &#125; return var4;&#125; ä»¥å¾€éƒ½æ˜¯è¯´jdkä»£ç†æ¯”cglibæ€§èƒ½å·®ï¼Œå…¶å®ä¼˜åŒ–åˆ°ç°åœ¨éƒ½æ²¡å·®å¤šå°‘äº†ï¼Œæ›´å¤šçš„æ—¶å€™æ˜¯ä»ä¸¤è€…çš„ç‰¹æ€§æŒ‰éœ€æ±‚é‡‡å–ä¸åŒçš„ã€‚ 3.2. ç¼“å­˜jdkä»£ç†è·å–Classçš„æ—¶å€™ä½¿ç”¨äº†ç¼“å­˜ 1234567891011private static Class&lt;?&gt; getProxyClass0(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123; if (interfaces.length &gt; 65535) &#123; throw new IllegalArgumentException(\"interface limit exceeded\"); &#125; // If the proxy class defined by the given loader implementing // the given interfaces exists, this will simply return the cached copy; // otherwise, it will create the proxy class via the ProxyClassFactory return proxyClassCache.get(loader, interfaces);&#125; proxyClassCacheçš„å£°æ˜æ˜¯è¿™æ ·çš„ 12345/** * a cache of proxy classes */ private static final WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt; proxyClassCache = new WeakCache&lt;&gt;(new KeyFactory(), new ProxyClassFactory()); ä¸»è¦çš„æˆå‘˜å˜é‡ 123456789101112131415// å¼•ç”¨é˜Ÿåˆ—private final ReferenceQueue&lt;K&gt; refQueue = new ReferenceQueue&lt;&gt;();// ç¼“å­˜æœ¬å­˜// the key type is Object for supporting null keyprivate final ConcurrentMap&lt;Object, ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt;&gt; map = new ConcurrentHashMap&lt;&gt;();// åå‘ç´¢å¼•ï¼Œç”¨æ¥å¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å­˜åœ¨ç¼“å­˜é‡Œprivate final ConcurrentMap&lt;Supplier&lt;V&gt;, Boolean&gt; reverseMap = new ConcurrentHashMap&lt;&gt;();// ä¸¤ä¸ªäºŒå…ƒè¿ç®—æ–¹æ³•// subKeyFactory = new KeyFactory()private final BiFunction&lt;K, P, ?&gt; subKeyFactory;// valueFactory = new ProxyClassFactory()private final BiFunction&lt;K, P, V&gt; valueFactory; è¿™é‡Œé‡Œçš„ç¼“å­˜mapçš„valueåˆæ˜¯ä¸€ä¸ªConcurrentMap,è¯´æ˜è¿™ä¸ªç¼“å­˜æ˜¯ä¸€ä¸ªäºŒçº§ç¼“å­˜ã€‚ å­—æ®µå è¯´æ˜ ä¸€çº§ç¼“å­˜key ä¸€ä¸ªCacheKeyç±»å‹çš„å¯¹è±¡ï¼Œä»¥ClassLoaderä½œä¸ºhash ä¸€çº§ç¼“å­˜value ä¸€çº§ç¼“å­˜ å­—æ®µå è¯´æ˜ äºŒçº§ç¼“å­˜key ä»¥interfacesä¸ºkey äºŒçº§ç¼“å­˜value Supplieræ¥å£ï¼Œå¯èƒ½æ˜¯CacheValue æˆ–è€… ä»£ç†å·¥å‚å¯¹è±¡ çœ‹ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263// åœ¨Proxyç±»çš„ä»£ç ä¸­ï¼Œkeyæ˜¯ClassLoaderï¼Œparameteræ˜¯interfaceæ•°ç»„public V get(K key, P parameter) &#123; Objects.requireNonNull(parameter); expungeStaleEntries(); Object cacheKey = CacheKey.valueOf(key, refQueue); // lazily install the 2nd level valuesMap for the particular cacheKey // åˆå§‹åŒ–äºŒçº§ç¼“å­˜ï¼Œç”¨äº†åŒé‡æ ¡éªŒï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹æ‹¿åˆ°çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹ ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap = map.get(cacheKey); if (valuesMap == null) &#123; ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; oldValuesMap = map.putIfAbsent(cacheKey, valuesMap = new ConcurrentHashMap&lt;&gt;()); if (oldValuesMap != null) &#123; valuesMap = oldValuesMap; &#125; &#125; // create subKey and retrieve the possible Supplier&lt;V&gt; stored by that // subKey from valuesMap Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter)); Supplier&lt;V&gt; supplier = valuesMap.get(subKey); Factory factory = null; while (true) &#123; if (supplier != null) &#123; // supplier might be a Factory or a CacheValue&lt;V&gt; instance V value = supplier.get(); if (value != null) &#123; return value; &#125; &#125; // else no supplier in cache // or a supplier that returned null (could be a cleared CacheValue // or a Factory that wasn't successful in installing the CacheValue) // lazily construct a Factory if (factory == null) &#123; factory = new Factory(key, parameter, subKey, valuesMap); &#125; if (supplier == null) &#123; supplier = valuesMap.putIfAbsent(subKey, factory); if (supplier == null) &#123; // successfully installed Factory supplier = factory; &#125; // else retry with winning supplier &#125; else &#123; if (valuesMap.replace(subKey, supplier, factory)) &#123; // successfully replaced // cleared CacheEntry / unsuccessful Factory // with our Factory supplier = factory; &#125; else &#123; // retry with current supplier supplier = valuesMap.get(subKey); &#125; &#125; &#125;&#125; è¿™é‡Œçš„ä»£ç ä¸»è¦æ˜¯ç»´æŠ¤Map.putæ“ä½œå¤šçº¿ç¨‹ä¸‹çš„ä¸€äº›åŒæ­¥ï¼Œé˜²æ­¢é‡å¤å®ä¾‹åŒ–ã€‚è™½ç„¶mapæ˜¯ConcurrentHashMap,ä½†é‡å¤putè¿˜æ˜¯å¾—é¿å…çš„ã€‚ äºŒçº§ç¼“å­˜Mapçš„valueä¸ºSupplierç±»å‹ï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ˜¯ Factoryå¯¹è±¡ï¼Œç¬¬äºŒæ¬¡è®¿é—®å°±å¯èƒ½æ˜¯CacheValueï¼Œå› ä¸ºFactoryå­˜æœ‰äºŒçº§ç¼“å­˜mapçš„å¼•ç”¨ï¼Œä¼šæŠŠvalueä»thisï¼ˆFactoryæœ¬èº«ï¼‰æ›¿æ¢ä¸ºCacheValue å…¶å®ä¸å¤ªæ˜ç™½è¿™ç§æœºåˆ¶,å¯èƒ½ä¸ºäº†æé«˜å¹¶å‘æ€§èƒ½ï¼Ÿå…ˆè¿”å›å€¼ï¼Œå†ä¸ºå€¼æ„é€ ç¼“å­˜ã€‚ 3.3. ç¼“å­˜è¿‡æœŸæœºåˆ¶CacheKeyæ˜¯ä¸€ä¸ªWeakReferenceï¼Œå½“gcæ—¶å°±ä¼šè¢«æ¸…ç†æ‰å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™æ—¶éœ€è¦æŠŠCacheKeyä»Mapé‡Œremoveï¼Œä¸‹é¢è¿™ä¸ªæ–¹æ³•åœ¨WeakCacheæ‰§è¡Œè¯»æ“ä½œçš„æ—¶å€™ä¼šæ‰§è¡Œä¸€éã€‚ 123456private void expungeStaleEntries() &#123; CacheKey&lt;K&gt; cacheKey; while ((cacheKey = (CacheKey&lt;K&gt;)refQueue.poll()) != null) &#123; cacheKey.expungeFrom(map, reverseMap); &#125;&#125; CacheValueä¹Ÿæ˜¯è™šå¼•ç”¨ã€‚ 3.4. InvocationHandleræ³¨å…¥ä»£ç†ç±»å·²ç»ç”Ÿæˆäº†ï¼Œæˆ‘ä»¬å†™çš„InvocationHandlerè¿˜æ²¡æœ‰æ³¨å…¥ï¼Œæ‰€ä»¥ç”Ÿæˆä»£ç†ç±»çš„æ—¶å€™æ˜¯ä¸åŒ…å«ä»£ç†é€»è¾‘çš„ã€‚ æˆ‘ä»¬å›åˆ°Proxy.newProxyInstanceæ–¹æ³•ï¼Œè¿™æ—¶å·²ç»è·å–åˆ°classï¼Œ 123456789101112...final Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);final InvocationHandler ih = h;if (!Modifier.isPublic(cl.getModifiers())) &#123; AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123; public Void run() &#123; cons.setAccessible(true); return null; &#125; &#125;);&#125;return cons.newInstance(new Object[]&#123;h&#125;); InvocationHandleræ˜¯é€šè¿‡æ„é€ å‚æ•°æ³¨å…¥çš„ã€‚ 3.5. ä»£ç†classæ–‡ä»¶çš„å†…å®¹æˆ‘ä»¬ç”ŸæˆåŸºæœ¬çš„classæ–‡ä»¶åªéœ€è¦ç»™ä¸€ä¸ªè‡ªå®šä¹‰ç±»åå’Œä¸€ä¸ªç›®æ ‡ç±»å°±å¯ä»¥äº†ã€‚ 123456789101112131415@Test public void saveJdkProxyClass() throws IOException &#123; String path = \"./$Proxy0.class\"; byte[] classFile = ProxyGenerator.generateProxyClass(\"$Proxy0\", RunnerDefault.class.getInterfaces()); FileOutputStream out = null; try &#123; out = new FileOutputStream(path); out.write(classFile); out.flush(); &#125; finally &#123; if (out != null) &#123; out.close(); &#125; &#125; &#125; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374//// Source code recreated from a .class file by IntelliJ IDEA// (powered by Fernflower decompiler)//import com.htc.learning.api.Runner;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;import java.lang.reflect.UndeclaredThrowableException;public final class $Proxy0 extends Proxy implements Runner &#123; private static Method m1; private static Method m2; private static Method m3; private static Method m0; public $Proxy0(InvocationHandler var1) throws &#123; super(var1); &#125; public final boolean equals(Object var1) throws &#123; try &#123; return (Boolean)super.h.invoke(this, m1, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final String toString() throws &#123; try &#123; return (String)super.h.invoke(this, m2, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final void run(String var1) throws &#123; try &#123; super.h.invoke(this, m3, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final int hashCode() throws &#123; try &#123; return (Integer)super.h.invoke(this, m0, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; static &#123; try &#123; m1 = Class.forName(\"java.lang.Object\").getMethod(\"equals\", Class.forName(\"java.lang.Object\")); m2 = Class.forName(\"java.lang.Object\").getMethod(\"toString\"); m3 = Class.forName(\"com.htc.learning.api.Runner\").getMethod(\"run\", Class.forName(\"java.lang.String\")); m0 = Class.forName(\"java.lang.Object\").getMethod(\"hashCode\"); &#125; catch (NoSuchMethodException var2) &#123; throw new NoSuchMethodError(var2.getMessage()); &#125; catch (ClassNotFoundException var3) &#123; throw new NoClassDefFoundError(var3.getMessage()); &#125; &#125;&#125; é‚£ä¹ˆcglibæ–¹æ¡ˆçš„ä»£ç†ç±»classæ–‡ä»¶åˆè¦æ€ä¹ˆè·å–å‘¢ï¼Œä¸‹ç¯‡å†è¯´ã€‚ å¯ä»¥çœ‹åˆ°å­—èŠ‚ç é‡Œæ¯ä¸ªç›®æ ‡æ–¹æ³•éƒ½æœ‰ä¸€ä¸ªåŒåçš„ä»£ç†æ–¹æ³•åŒ…ç€ï¼Œä»£ç†é€»è¾‘å·²ç»å†™åœ¨InvocationHandlerï¼Œä»£ç†æ–¹æ³•ç›´æ¥è°ƒç”¨InvocationHandlerå°±å¯ä»¥äº†ã€‚ 4. ä»ä»£ç†ç±»è·å–åŸå§‹å¯¹è±¡çš„Classåœ¨Springé‡Œï¼Œbeanè¢«ä»£ç†æ˜¯å¾ˆå¸¸è§çš„ï¼Œå‡å¦‚æˆ‘ä»¬è¦è·å–ç›®æ ‡beanä¸Šçš„æ³¨è§£ï¼Œè¿™æ—¶å€™æˆ‘ä»¬æ‹¿åˆ°çš„å¦‚æœæ˜¯ä»£ç†ç±»ï¼Œæ˜¯è·å–ä¸åˆ°çš„ç›®æ ‡beanä¸Šçš„æ³¨è§£çš„ã€‚æ‰€ä»¥è¿™æ—¶æˆ‘ä»¬å¾—ä»ä»£ç†ç±»è·å–åŸå§‹å¯¹è±¡ï¼Œå†è·å¾—å¯¹åº”çš„Classã€‚ 4.1. æˆ‘çš„åšæ³•åœ¨InvocationHandlerå®ç°ç±»é‡Œï¼ŒæŠŠç›®æ ‡ç±»å¯¹è±¡æ”¾å…¥äº†ä¸€ä¸ªtargetæˆå‘˜å˜é‡ï¼Œç„¶åå½“æˆ‘ä»¬æ‹¿åˆ°ä»£ç†ç±»åï¼Œé€šè¿‡è°ƒç”¨java.lang.reflect.Proxy#getInvocationHandleræ–¹æ³•ï¼Œå†é€šè¿‡åå°„å³å¯è·å–åˆ°åŸå§‹å¯¹è±¡targetã€‚ 4.2. Springçš„åšæ³•Springæœ‰ä¸€ä¸ªAopProxyUtilsçš„å·¥å…·ï¼Œå…¶ä¸­æœ‰ä¸ªæ–¹æ³•å¯ä»¥è·å–åˆ°jdkä»£ç†æˆ–cglibä»£ç†çš„åŸå§‹å¯¹è±¡ã€‚å…³äºè¿™ä¸ªå·¥å…·æ›´å¤šä½¿ç”¨å‚è€ƒAopProxyUtilsè¯¦è§£ 12345678910111213141516 // candidateå³ä¼ å…¥çš„ä»£ç†ç±»å®ä¾‹public static Class&lt;?&gt; ultimateTargetClass(Object candidate) &#123; Assert.notNull(candidate, \"Candidate object must not be null\"); Object current = candidate; Class&lt;?&gt; result = null; // Springçš„ä»£ç†ç±»éƒ½å®ç°äº† TargetClassAwareï¼Œè°ƒç”¨getTargetClass()å¯è·å–åˆ°ç›®æ ‡å¯¹è±¡ï¼Œæ³¨æ„ï¼Œè¿™é‡Œä¸ä¸€å®šæ˜¯åŸå§‹å¯¹è±¡ï¼Œå› ä¸ºå¯èƒ½åˆ‡é¢åˆ‡äº†å¾ˆå¤šæ¬¡ï¼Œç”Ÿæˆäº†å¾ˆå¤šå±‚çš„ä»£ç†ç±»ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªwhileå¾ªç¯ while (current instanceof TargetClassAware) &#123; result = ((TargetClassAware) current).getTargetClass(); current = getSingletonTarget(current); &#125; if (result == null) &#123; // å¦‚æœæ˜¯cglibä»£ç†ï¼Œåˆ™è·å–å¯¹è±¡çˆ¶ç±»ï¼Œå¦åˆ™æ˜¯jdkä»£ç†ï¼Œç›´æ¥è·å–å¯¹è±¡ç±»å‹ result = (AopUtils.isCglibProxy(candidate) ? candidate.getClass().getSuperclass() : candidate.getClass()); &#125; return result;&#125; 123456789public static Object getSingletonTarget(Object candidate) &#123; if (candidate instanceof Advised) &#123; TargetSource targetSource = ((Advised) candidate).getTargetSource(); if (targetSource instanceof SingletonTargetSource) &#123; return ((SingletonTargetSource) targetSource).getTarget(); &#125; &#125; return null;&#125; è¿™é‡Œçš„ä»£ç é€»è¾‘çœ‹èµ·æ¥ä¸éš¾ï¼Œä½†æ˜¯æ¶‰åŠäº†Spring Aopçš„æ¥å£æ¦‚å¿µï¼Œæ‰€ä»¥å…·ä½“è°ƒç”¨æˆ‘ä¹Ÿä¸å¤ªæ‡‚æ˜¯å¹²å˜›çš„ã€‚ Springåœ¨ä»£ç†é€»è¾‘ä¸­æ‹¦æˆªäº†getTargetClass()ç­‰åˆ‡é¢æ–¹æ³•ï¼Œå°†è¿™äº›æ–¹æ³•è½¬å‘ç»™Advisedå»æ‰§è¡Œã€‚ 5. ç¼ºé™·ä»classæ–‡ä»¶çœ‹ï¼Œç”±äºä»£ç†ç±»ç»§æ‰¿äº†Proxyç±»ï¼ˆå…¶å®è¿™ä¸ªç±»çœ‹èµ·æ¥ä¹Ÿåªæœ‰ä¸€ä¸ªjava.lang.reflect.Proxy#getInvocationHandleræ¯”è¾ƒé€šç”¨çš„æ–¹æ³•ï¼Œå…¶å®æˆ‘è§‰å¾—è¿™ä¸ªInvocationHandlerå¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°ï¼Œä¸æ‡‚ä¸ºä»€ä¹ˆéè¦ç»§æ‰¿è¿™ä¸ªç±»ï¼Œå–µï¼Ÿï¼‰ï¼Œå¯¼è‡´jdkä»£ç†ä¸èƒ½é€šè¿‡ç»§æ‰¿ç›®æ ‡ç±»æ¥è¾¾åˆ°ä»£ç†çš„ç›®çš„ã€‚ 6. å…³äºSpringSpringæœ‰ä¸ªå±æ€§æ˜¯proxy-target-classï¼Œé»˜è®¤å€¼æ˜¯falseï¼Œè¡¨ç¤ºé»˜è®¤ä½¿ç”¨jdkä»£ç†ï¼Œè¿™æ—¶ä½¿ç”¨å¸¸å¸¸ä¼šå‘ç”Ÿç±»å‹è½¬æ¢çš„é”™è¯¯ï¼Œå› ä¸ºæœ€ç»ˆbeançš„classå·²ç»ä¸æ˜¯æœ€åˆçš„beançš„ç±»å‹ã€‚åœ¨Springbooté‡Œï¼Œproxy-target-classä½¿ç”¨spring.aop.proxy-target-classå±æ€§æ¥é…ç½®ï¼Œé»˜è®¤ä¸ºtrueï¼Œå³éƒ½ä½¿ç”¨cglibæ¥ä»£ç†ã€‚å¦‚æœé…ç½®ä¸ºfalseï¼ŒSpringbootä¼šå¯¹å®ç°æ¥å£çš„beanä½¿ç”¨jdkä»£ç†ï¼Œå¯¹äºæ²¡æœ‰å®ç°æ¥å£çš„ç±»ä¾æ—§ä½¿ç”¨cglibä»£ç†ã€‚ 7. å‚è€ƒ AopProxyUtilsè¯¦è§£","categories":[{"name":"Proxy","slug":"Proxy","permalink":"https://htchz.cc/categories/Proxy/"}],"tags":[{"name":"AOP","slug":"AOP","permalink":"https://htchz.cc/tags/AOP/"}]},{"title":"[NIO]linuxçš„I/Oå¤šè·¯å¤ç”¨","slug":"NIO-linuxçš„I-Oå¤šè·¯å¤ç”¨","date":"2019-01-30T18:07:00.000Z","updated":"2019-12-10T08:01:45.304Z","comments":true,"path":"3010153098.html","link":"","permalink":"https://htchz.cc/3010153098.html","excerpt":"","text":"1. å‰è¨€ä¸Šç¯‡æåˆ°i/oå¤šè·¯å¤ç”¨ï¼Œæ˜¯é€šè¿‡å•è¿›ç¨‹ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°çš„çŠ¶æ€ï¼Œè¾¾åˆ°å‡å°‘çº¿ç¨‹é˜»å¡çš„ç›®çš„ã€‚ å†…æ ¸ï¼ˆkernelï¼‰åˆ©ç”¨æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰æ¥è®¿é—®æ–‡ä»¶ã€‚ æ–‡ä»¶æè¿°ç¬¦æ˜¯éè´Ÿæ•´æ•°ã€‚ æ‰“å¼€ç°å­˜æ–‡ä»¶æˆ–æ–°å»ºæ–‡ä»¶æ—¶(åŒ…æ‹¬socketè¢«æ‰“å¼€)ï¼Œå†…æ ¸ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚ è¯»å†™æ–‡ä»¶ä¹Ÿéœ€è¦ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ¥æŒ‡å®šå¾…è¯»å†™çš„æ–‡ä»¶ã€‚åœ¨linuxç¯å¢ƒä¸‹ï¼Œè¿›å…¥/procç›®å½•å¯ä»¥çœ‹åˆ°è®¸å¤šä»£è¡¨æ–‡ä»¶æè¿°ç¬¦çš„æ–‡ä»¶å¤¹ã€‚ linux i/oå¤šè·¯å¤ç”¨çš„ç³»ç»Ÿè°ƒç”¨æ¥å£æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯ select,poll,epollã€‚ 2. æ¥å£ä½œä¸ºä¸€ä¸ªå­¦javaçš„ï¼Œäº†è§£ä¸€ä¸‹javaåº•å±‚è°ƒç”¨çš„å‡½æ•°ï¼Œè¿˜æ˜¯æŒºæœ‰åŠ©äºç†è§£çš„ã€‚ 2.1. i/oå¤šè·¯å¤ç”¨åŸç†linux(2.6+)å†…æ ¸çš„äº‹ä»¶wakeup callbackæœºåˆ¶ï¼Œæ˜¯linux i/oå¤šè·¯å¤ç”¨çš„åŸç†ã€‚å†…æ ¸ç®¡ç†ä¸€ä¸ªprocessçš„ç¡çœ é˜Ÿåˆ—ï¼Œå½“socketäº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œå”¤é†’é˜Ÿåˆ—çš„processï¼Œè°ƒç”¨callbackå‡½æ•°å®Œæˆé€šçŸ¥ã€‚æ€»ä½“ä¸Šä¼šæ¶‰åŠä¸¤å¤§é€»è¾‘ï¼šï¼ˆ1ï¼‰ç¡çœ ç­‰å¾…é€»è¾‘ï¼›ï¼ˆ2ï¼‰å”¤é†’é€»è¾‘ã€‚ 1.ç¡çœ ç­‰å¾…é€»è¾‘ï¼šæ¶‰åŠselectã€pollã€epoll_waitçš„é˜»å¡ç­‰å¾…é€»è¾‘ selectã€pollã€epoll_waité™·å…¥å†…æ ¸ï¼Œåˆ¤æ–­ç›‘æ§çš„socketæ˜¯å¦æœ‰å…³å¿ƒçš„äº‹ä»¶å‘ç”Ÿäº†ï¼Œå¦‚æœæ²¡ï¼Œåˆ™ä¸ºå½“å‰processæ„å»ºä¸€ä¸ªwait_entryèŠ‚ç‚¹ï¼Œç„¶åæ’å…¥åˆ°ç›‘æ§socketçš„sleep_list è¿›å…¥å¾ªç¯çš„scheduleç›´åˆ°å…³å¿ƒçš„äº‹ä»¶å‘ç”Ÿäº† å…³å¿ƒçš„äº‹ä»¶å‘ç”Ÿåï¼Œå°†å½“å‰processçš„wait_entryèŠ‚ç‚¹ä»socketçš„sleep_listä¸­åˆ é™¤ã€‚ 2.å”¤é†’é€»è¾‘ã€‚ socketçš„äº‹ä»¶å‘ç”Ÿäº†ï¼Œç„¶åsocketé¡ºåºéå†å…¶ç¡çœ é˜Ÿåˆ—ï¼Œä¾æ¬¡è°ƒç”¨æ¯ä¸ªwait_entryèŠ‚ç‚¹çš„callbackå‡½æ•° ç›´åˆ°å®Œæˆé˜Ÿåˆ—çš„éå†æˆ–é‡åˆ°æŸä¸ªwait_entryèŠ‚ç‚¹æ˜¯æ’ä»–çš„æ‰åœæ­¢ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹callbackåŒ…å«ä¸¤ä¸ªé€»è¾‘ï¼š1.wait_entryè‡ªå®šä¹‰çš„ç§æœ‰é€»è¾‘ï¼›2.å”¤é†’çš„å…¬å…±é€»è¾‘ï¼Œä¸»è¦ç”¨äºå°†è¯¥wait_entryçš„processæ”¾å…¥CPUçš„å°±ç»ªé˜Ÿåˆ—ï¼Œè®©CPUéšåå¯ä»¥è°ƒåº¦å…¶æ‰§è¡Œã€‚ 2.2. select12345678#include &lt;sys/select.h&gt;#include &lt;sys/time.h&gt;int select(int max_fd, fd_set *readset, fd_set *writeset, fd_set *exceptset, struct timeval *timeout)FD_ZERO(int fd, fd_set* fds) //æ¸…ç©ºé›†åˆFD_SET(int fd, fd_set* fds) //å°†ç»™å®šçš„æè¿°ç¬¦åŠ å…¥é›†åˆFD_ISSET(int fd, fd_set* fds) //å°†ç»™å®šçš„æè¿°ç¬¦ä»æ–‡ä»¶ä¸­åˆ é™¤ FD_CLR(int fd, fd_set* fds) //åˆ¤æ–­æŒ‡å®šæè¿°ç¬¦æ˜¯å¦åœ¨é›†åˆä¸­ select æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°max_fdæŒ‡å¾…æµ‹è¯•çš„fdï¼ˆfdå³æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€ä¸ªsocketä¼šæœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼‰ä¸ªæ•°ï¼Œå®ƒçš„å€¼æ˜¯å¾…æµ‹è¯•çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦åŠ 1ï¼Œæ–‡ä»¶æè¿°ç¬¦ä»0å¼€å§‹åˆ°max_fd-1éƒ½å°†è¢«æµ‹è¯•ã€‚ä¸­é—´ä¸‰ä¸ªå‚æ•°readsetã€writesetå’ŒexceptsetæŒ‡å®šè¦è®©å†…æ ¸æµ‹è¯•è¯»ã€å†™å’Œå¼‚å¸¸æ¡ä»¶çš„fdé›†åˆï¼Œå¦‚æœä¸éœ€è¦æµ‹è¯•çš„å¯ä»¥è®¾ç½®ä¸ºNULLã€‚ selectè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œè¢«ç›‘æ§çš„readset(å‡è®¾å¯¹socketçš„è¯»äº‹ä»¶æ„Ÿå…´è¶£)ä¼šä»ç”¨æˆ·ç©ºé—´å¤åˆ¶åˆ°å†…æ ¸ç©ºé—´ï¼Œç„¶åéå†ç›‘å¬çš„socketï¼Œå¦‚æœåœ¨è¶…æ—¶æˆ–è€…æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªsocketäº§ç”Ÿäº†è¯»äº‹ä»¶ï¼Œé‚£ä¹ˆselectå”¤é†’çº¿ç¨‹ï¼Œæ³¨æ„è¿™é‡Œåªæ˜¯å”¤é†’ï¼Œå¹¶æ²¡æœ‰è¿”å›å°±ç»ªçš„fdï¼Œæ¥ä¸‹æ¥çº¿ç¨‹è¦å†æ¬¡éå†readsetï¼Œæ”¶é›†å¯è¯»äº‹ä»¶ã€‚ selectçš„é—®é¢˜æ˜¯ï¼š ç›‘å¬çš„socketæ•°é‡æœ‰é™ï¼Œä¸ºäº†å‡å°‘fdæ‹·è´çš„æ€§èƒ½æŸè€—ï¼Œé™å®šäº†1024ä¸ªæ–‡ä»¶æè¿°ç¬¦ çº¿ç¨‹è¢«å”¤é†’çš„æ—¶å€™ï¼Œéœ€è¦å†æ¬¡éå†fdåˆ—è¡¨ã€‚ 2.3. poll12345678#include &lt;poll.h&gt;int poll(struct pollfd fds[], nfds_t nfds, int timeout);typedef struct pollfd &#123; int fd; // éœ€è¦è¢«æ£€æµ‹æˆ–é€‰æ‹©çš„æ–‡ä»¶æè¿°ç¬¦ short events; // å¯¹æ–‡ä»¶æè¿°ç¬¦fdä¸Šæ„Ÿå…´è¶£çš„äº‹ä»¶ short revents; // æ–‡ä»¶æè¿°ç¬¦fdä¸Šå½“å‰å®é™…å‘ç”Ÿçš„äº‹ä»¶*/&#125; pollfd_t; pollæ¢äº†ä¸ªæ•°æ®ç»“æ„ï¼Œè§£å†³äº†selectå…¶ä¸­ä¸€ä¸ªé—®é¢˜ï¼šç›‘å¬çš„æ•°é‡æœ‰é™ã€‚ä½†å®é™…ä¸Šå¹¶æœ‰è§£å†³æ‹·è´çš„æ€§èƒ½æŸè€—å’Œéœ€è¦å†æ¬¡éå†fdåˆ—è¡¨è·å–å°±ç»ªäº‹ä»¶ã€‚ 2.4. epoll1234#include &lt;sys/epoll.h&gt;int epoll_create(int size);int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout); epollä¸æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œæ˜¯ç”±ä¸‰ä¸ªå‡½æ•°ç»„æˆ; epoll_createåˆ›å»ºäº†ä¸€ä¸ªepollçš„fdï¼Œå‚æ•°sizeè¡¨æ˜å†…æ ¸è¦ç›‘å¬çš„æè¿°ç¬¦æ•°é‡ epoll_ctlç”¨æ¥å¯¹fdé›†åˆè¿›è¡Œä¿®æ”¹ï¼Œå‚ç…§selectï¼Œpollæ¯æ¬¡è°ƒç”¨éƒ½æ˜¯å°†æ‰€æœ‰fdé›†åˆå¤åˆ¶ï¼Œé‰´äºfdé›†åˆçš„å˜åŒ–ä¸é¢‘ç¹ï¼Œå…¶å®æ¯æ¬¡å…¨é‡å¤åˆ¶è¿‡å»æ˜¯æ²¡å¿…è¦çš„ã€‚ epoll_waitç›¸å½“äºå‰ä¸¤ç§i/oå¤šè·¯å¤ç”¨è°ƒç”¨ï¼Œè¯¥å‡½æ•°ç­‰å¾…äº‹ä»¶çš„å°±ç»ªï¼ŒæˆåŠŸæ—¶è¿”å›å°±ç»ªçš„äº‹ä»¶æ•°ç›®ï¼Œè°ƒç”¨å¤±è´¥æ—¶è¿”å› -1ï¼Œç­‰å¾…è¶…æ—¶è¿”å› 0ï¼ŒeventsæŒ‡é’ˆæŒ‡å‘äº†å°±ç»ªçš„é›†åˆã€‚ epollé€šè¿‡epoll_ctlæ¥å¯¹ç›‘æ§çš„fdsé›†åˆæ¥è¿›è¡Œå¢ã€åˆ ã€æ”¹ï¼Œé‚£ä¹ˆå¿…é¡»æ¶‰åŠåˆ°fdçš„å¿«é€ŸæŸ¥æ‰¾é—®é¢˜ï¼Œäºæ˜¯ï¼Œä¸€ä¸ªä½æ—¶é—´å¤æ‚åº¦çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥çš„æ•°æ®ç»“æ„æ¥ç»„ç»‡è¢«ç›‘æ§çš„fdsé›†åˆæ˜¯å¿…ä¸å¯å°‘çš„äº†ã€‚åœ¨linux 2.6.8ä¹‹å‰çš„å†…æ ¸ï¼Œepollä½¿ç”¨hashæ¥ç»„ç»‡fdsé›†åˆï¼Œäºæ˜¯åœ¨åˆ›å»ºepoll fdçš„æ—¶å€™ï¼Œepolléœ€è¦åˆå§‹åŒ–hashçš„å¤§å°ã€‚äºæ˜¯epoll_create(int size)æœ‰ä¸€ä¸ªå‚æ•°sizeï¼Œä»¥ä¾¿å†…æ ¸æ ¹æ®sizeçš„å¤§å°æ¥åˆ†é…hashçš„å¤§å°ã€‚åœ¨linux 2.6.8ä»¥åçš„å†…æ ¸ä¸­ï¼Œepollä½¿ç”¨çº¢é»‘æ ‘æ¥ç»„ç»‡ç›‘æ§çš„fdsé›†åˆï¼Œäºæ˜¯epoll_create(int size)çš„å‚æ•°sizeå®é™…ä¸Šå·²ç»æ²¡æœ‰æ„ä¹‰äº†ã€‚ epollè§£å†³äº†selectã€pollçš„ä¸»è¦é—®é¢˜ï¼š æ²¡æœ‰æœ€å¤§å¹¶å‘è¿æ¥çš„é™åˆ¶ï¼Œèƒ½æ‰“å¼€çš„fdä¸Šé™è¿œå¤§äº1024 é‡‡ç”¨å›è°ƒçš„æ–¹å¼ï¼Œæ•ˆç‡æå‡ã€‚åªæœ‰æ´»è·ƒå¯ç”¨çš„fdæ‰ä¼šè°ƒç”¨callbackå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ epoll åªç®¡ä½ â€œæ´»è·ƒâ€çš„è¿æ¥ï¼Œè€Œè·Ÿè¿æ¥æ€»æ•°æ— å…³ï¼Œå› æ­¤åœ¨å®é™…çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œepollçš„æ•ˆç‡å°±ä¼šè¿œè¿œé«˜äºselectå’Œpollã€‚ epollå¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæœ‰ä¸¤ç§æ¨¡å¼ï¼šLT(level triggerï¼Œæ°´å¹³è§¦å‘)å’ŒET(Edge triggerï¼Œè¾¹ç¼˜è§¦å‘)ã€‚ LT:è¿™æ¬¡äº‹ä»¶æ²¡å¤„ç†ï¼Œä¸‹æ¬¡è¿˜å‘Šè¯‰ä½ ã€‚ET:è¿™æ¬¡äº‹ä»¶æ²¡å¤„ç†ï¼Œä¸‹æ¬¡ä¸å‘Šè¯‰ä½ ã€‚ 3. java nioåœ¨linuxç¯å¢ƒä¸‹ï¼Œjava nio åº•å±‚è°ƒç”¨æ˜¯epollï¼Œè¿™é‡Œæœ‰ä¸ªåšä¸»å†™äº†ä¸€ä¸ªåŸºäºepollå®ç°çš„webæœåŠ¡å™¨ï¼Œåœ¨linuxä¸‹ç¼–è¯‘å®Œæˆåï¼Œå¯ä»¥æµè§ˆå™¨è®¿é—®8080ç«¯å£ï¼Œè§‚å¯Ÿè¾“å‡ºã€‚ å¦å¤–ï¼Œjavaä½¿ç”¨çš„æ¨¡å¼æ˜¯æ°´å¹³è§¦å‘ã€‚ä¼ é€é—¨ 4. ç»“æŸè¯­ä½œä¸ºlinuxé—¨å¤–æ±‰ï¼Œäº†è§£çš„ä¸æ˜¯å¾ˆæ·±å…¥ã€‚ 5. å‚è€ƒ å¤§è¯ Selectã€Pollã€Epoll åŸºäºepollå®ç°ç®€å•çš„webæœåŠ¡å™¨","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"NIO","slug":"NIO","permalink":"https://htchz.cc/tags/NIO/"}],"author":"åœŸå·"},{"title":"[NIO]äº”ä¸ªI/Oæ¨¡å‹","slug":"NIO-IOæ¨¡å‹","date":"2019-01-27T14:35:00.000Z","updated":"2019-01-31T07:24:21.000Z","comments":true,"path":"2990610001.html","link":"","permalink":"https://htchz.cc/2990610001.html","excerpt":"","text":"1. å‰è¨€ä¸å…ˆäº†è§£ä¸€ä¸‹Linuxçš„IOæ¨¡å‹ï¼Œçœ‹javaçš„nioçœŸæ˜¯ä¸€è„¸æ‡µé€¼ã€‚ã€‚ 2. linuxçš„ioæ¨¡å‹2.1. Blocking (I/Oé˜»å¡IOæ¨¡å‹)åˆšå­¦javaçš„æ—¶å€™æƒ³å¿…å­¦çš„éƒ½æ˜¯é˜»å¡IOä¼ è¾“ï¼Œåº•å±‚è°ƒç”¨å°±æ˜¯ä¸Šé¢çš„å›¾é”å±•ç¤ºçš„è¿‡ç¨‹ï¼Œè¿›ç¨‹è°ƒç”¨recvfromï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç„¶åç³»ç»Ÿå°†æ•°æ®ä»ç½‘å¡/ç¡¬ç›˜è¯»å–åˆ°å†…æ ¸ï¼Œç”±ä»å†…æ ¸å¤åˆ¶åˆ°ç”¨æˆ·æ€ï¼Œæœ€ç»ˆè¿”å›ç»™è¿›ç¨‹ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œã€‚ è¿™æ˜¯æ¯”è¾ƒè€—æ—¶å’Œæµªè´¹CPUçš„åšæ³•ï¼Œéœ€è¦é˜»å¡æ•°æ®åˆ°è¾¾ï¼Œæ•°æ®å¤åˆ¶ 2.2. Nonblocking I/Oï¼ˆéé˜»å¡IOæ¨¡å‹ï¼‰åº•å±‚è½®è¯¢è°ƒç”¨recvfromï¼Œç³»ç»Ÿä¼šç«‹åˆ»è¿”å›è¯»å–ç»“æœï¼Œå¦‚æœè¯»å–ä¸åˆ°æ•°æ®ï¼Œåˆ™å¼€å¯ä¸‹ä¸€æ¬¡è°ƒç”¨ï¼Œç›´åˆ°æ•°æ®è¿”å›ã€‚ è¿™ç§æ¨¡å¼ä¸ç”¨é˜»å¡æ•°æ®åˆ°è¾¾ï¼Œéœ€è¦é˜»å¡æ•°æ®å¤åˆ¶ã€‚ä½†æ˜¯å¤„äºè½®è¯¢çŠ¶æ€çš„è¿›ç¨‹åˆæ˜¯å¦ä¸€ç§æ„ä¹‰ä¸Šçš„é˜»å¡ï¼Œæ‰€ä»¥å…¶å®æ•ˆç‡æ²¡æœ‰æé«˜å¤šå°‘ã€‚ 2.3. I/O Multiplexing(å¤šè·¯å¤ç”¨)Unix/Linux ç¯å¢ƒä¸‹çš„ I/O å¤ç”¨æ¨¡å‹åŒ…å«ä¸‰ç»„ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ†åˆ«æ˜¯ selectã€poll å’Œ epollï¼Œåœ¨å†å²ä¸Šä¾æ¬¡å‡ºç°ã€‚select æœ‰ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†ï¼ˆreadfdsï¼‰ï¼Œåˆ†åˆ«æ˜¯å¯è¯»æ–‡ä»¶æè¿°ç¬¦é›†ï¼ˆwritefdsï¼‰ã€å¯å†™æ–‡ä»¶æè¿°ç¬¦é›†å’Œå¼‚å¸¸æ–‡ä»¶æè¿°ç¬¦é›†ï¼ˆexceptfdsï¼‰ã€‚è¿›ç¨‹å°†æ–‡ä»¶æè¿°ç¬¦ï¼ˆsocketä¹Ÿæœ‰æ–‡ä»¶æè¿°ç¬¦è¡¨ç¤ºï¼‰æ³¨å†Œåˆ°æ„Ÿå…´è¶£çš„æ–‡ä»¶æè¿°ç¬¦é›†ä¸­ï¼Œ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œselectå…ˆè¢«è°ƒç”¨ï¼Œè¿›ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´è‡³ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶è¿”å›ã€‚ç„¶åä½¿ç”¨recvfromè¯»å–æ•°æ®ã€‚ è¿™ç§æ¨¡å¼éœ€è¦é˜»å¡æ•°æ®åˆ°è¾¾ï¼Œæ•°æ®å¤åˆ¶ã€‚ä½†æ˜¯BIOç”±äºä¸€æ¬¡åªç­‰å¾…ä¸€ä¸ªæ•°æ®åˆ°è¾¾ï¼Œæ‰€ä»¥æ€§èƒ½ä¸Šå¤šè·¯å¤ç”¨æ›´ä¼˜ã€‚ 2.4. Signal-Driven I/Oï¼ˆä¿¡å·é©±åŠ¨I/Oï¼‰è¿›ç¨‹å‘Šè¯‰å†…æ ¸ï¼ŒæŸä¸ªsocket çš„æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå‘è¿›ç¨‹å‘é€ä¿¡å·ã€‚æ¥æ”¶åˆ°ä¿¡å·åï¼Œå¯¹åº”çš„å‡½æ•°å›å»å¤„ç†äº‹ä»¶ã€‚ è¿™ç§æ¨¡å¼ä¸ç”¨é˜»å¡æ•°æ®åˆ°è¾¾ï¼Œéœ€è¦é˜»å¡æ•°æ®å¤åˆ¶ æƒ³æƒ³ï¼Œå¦‚æœæ•°æ®å¤åˆ¶å®Œå†é€šçŸ¥è¿›ç¨‹ï¼Œä¸å°±ä¸ç”¨é˜»å¡äº†ã€‚äºæ˜¯æœ‰ä¸‹é¢çš„å¼‚æ­¥IOçš„æ¨¡å‹å‡ºç°ã€‚ 2.5. Asynchronous I/O ï¼ˆå¼‚æ­¥I/Oï¼‰è¿™å°±æ˜¯ä¿¡å·é©±åŠ¨I/Oçš„å‡çº§ç‰ˆï¼Œå®Œå…¨å¼‚æ­¥ï¼Œè¿›ç¨‹æ— é˜»å¡ã€‚å¯¹äºå¤§éƒ¨åˆ†å¹³å°æ¥è¯´ï¼Œåº•å±‚åˆ©ç”¨çš„è¿˜æ˜¯éå¼‚æ­¥æ¨¡å‹ç»“åˆå›è°ƒå‡½æ•°æ¥å®ç°ã€‚ é—æ†¾çš„æ˜¯ï¼Œlinuxçš„ç½‘ç»œIOä¸­æ˜¯ä¸å­˜åœ¨å¼‚æ­¥IOçš„ï¼Œlinuxçš„ç½‘ç»œIOå¤„ç†çš„ç¬¬äºŒé˜¶æ®µæ€»æ˜¯é˜»å¡ç­‰å¾…æ•°æ®copyå®Œæˆçš„ã€‚çœŸæ­£æ„ä¹‰ä¸Šçš„ç½‘ç»œå¼‚æ­¥IOæ˜¯Windowsä¸‹çš„IOCPï¼ˆIOå®Œæˆç«¯å£ï¼‰æ¨¡å‹ã€‚ 3. å¯¹æ¯” 4. æ€»ç»“ Unixç½‘ç»œç¼–ç¨‹ã€ä¸­è¯´é“ï¼ŒæŒ‰ç…§POSIXæ ‡å‡†ä¸­çš„æœ¯è¯­ï¼ŒåŒæ­¥æŒ‡çš„æ˜¯I/OåŠ¨ä½œä¼šå¯¼è‡´ç”¨æˆ·è¿›ç¨‹é˜»å¡ï¼Œå¼‚æ­¥åˆ™åˆšå¥½ç›¸åã€‚æŒ‰ç…§è¿™ç§åˆ†ç±»ï¼Œä¸Šè¾¹5ç§I/Oæ¨¡å‹ä¸­ï¼Œåªæœ‰AIOä¸€ç§æ˜¯å¼‚æ­¥çš„ï¼Œå…¶ä»–éƒ½æ˜¯åŒæ­¥çš„ã€‚ ä½†æ˜¯è¿™äº›åªæ˜¯ç›¸å¯¹çš„ï¼Œç¨‹åºå¾€å¾€æ˜¯å¤šçº¿ç¨‹è¿è¡Œï¼Œæ‹¿Javaæ¥è¯´ï¼Œä¸»çº¿ç¨‹è°ƒç”¨selectæ“ä½œæ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯æ•°æ®å¤åˆ¶è¿™ä¸ªé˜»å¡è¿‡ç¨‹æ”¾åˆ°å­çº¿ç¨‹ä¸­ï¼Œå¯¹ä¸»çº¿ç¨‹æ¥è¯´æ²¡æœ‰å½±å“ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆjavaçš„NIOç§°ä¸ºåŒæ­¥éé˜»å¡IOã€‚ 5. å‚è€ƒ IOå¤ç”¨","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"NIO","slug":"NIO","permalink":"https://htchz.cc/tags/NIO/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]SimpleDateFormatçº¿ç¨‹å®‰å…¨çš„é—®é¢˜","slug":"JavaåŸºç¡€-SimpleDateFormatçº¿ç¨‹å®‰å…¨","date":"2018-12-25T10:19:00.000Z","updated":"2019-08-15T16:08:49.213Z","comments":true,"path":"3683368056.html","link":"","permalink":"https://htchz.cc/3683368056.html","excerpt":"ä»Šå¤©æŠŠSimpleDateFormatè®¾ç½®ä¸ºstaticï¼Œè€å“¥è¯´ä½ é”™äº†ï¼Œä½ çœŸçš„é”™äº†ã€‚","text":"ä»Šå¤©æŠŠSimpleDateFormatè®¾ç½®ä¸ºstaticï¼Œè€å“¥è¯´ä½ é”™äº†ï¼Œä½ çœŸçš„é”™äº†ã€‚ 1. å‰è¨€SimpleDateFormatæ˜¯ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„ç±»ï¼Œä¸å¯ä»¥åœ¨å¤šçº¿ç¨‹é‡Œé¢ä½¿ç”¨ã€‚ 2. ä»£ç 123456789101112131415private static int num = 4;private static ExecutorService executorService = Executors.newFixedThreadPool(num);private static SimpleDateFormat simpleDateFormat = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");public static void main(String[] args) &#123; IntStream.range(0, num).parallel().forEach(a -&gt; executorService.submit(() -&gt; &#123; try &#123; System.out.println(simpleDateFormat.parse(\"2017-12-13 15:17:27\")); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;)); executorService.shutdown();&#125; è¿™ä¸ªç¨‹åºä¼šè¿™ä¹ˆæŠ¥ï¼š 1234567891011121314151617181920212223242526272829303132java.lang.NumberFormatException: multiple points at java.base/jdk.internal.math.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1890) at java.base/jdk.internal.math.FloatingDecimal.parseDouble(FloatingDecimal.java:110) at java.base/java.lang.Double.parseDouble(Double.java:543) at java.base/java.text.DigitList.getDouble(DigitList.java:169) at java.base/java.text.DecimalFormat.parse(DecimalFormat.java:2128) at java.base/java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:2240) at java.base/java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1541) at java.base/java.text.DateFormat.parse(DateFormat.java:393) at com.htc.learning.main.SimpleDateFormatTest.lambda$main$0(SimpleDateFormatTest.java:18) at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264) at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) at java.base/java.lang.Thread.run(Thread.java:834)java.lang.NumberFormatException: multiple points at java.base/jdk.internal.math.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1890) at java.base/jdk.internal.math.FloatingDecimal.parseDouble(FloatingDecimal.java:110) at java.base/java.lang.Double.parseDouble(Double.java:543) at java.base/java.text.DigitList.getDouble(DigitList.java:169) at java.base/java.text.DecimalFormat.parse(DecimalFormat.java:2128) at java.base/java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:2240) at java.base/java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1541) at java.base/java.text.DateFormat.parse(DateFormat.java:393) at com.htc.learning.main.SimpleDateFormatTest.lambda$main$0(SimpleDateFormatTest.java:18) at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264) at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) at java.base/java.lang.Thread.run(Thread.java:834)Wed Dec 13 15:17:27 CST 2017Tue Dec 13 15:17:27 CST 12 è¿™æ®µä»£ç æœ‰æ—¶æŠ¥é”™ï¼Œæœ‰æ—¶èƒ½æ­£å¸¸è¾“å‡ºï¼Œä½†ä¹Ÿä¸æ˜¯æ­£ç¡®è¾“å‡ºã€‚ 3. SimpleDateFormatçš„ç±»å›¾ç»“æ„å¯ä»¥çœ‹åˆ°å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªCalendarç±»ï¼Œå½’æ ¹åˆ°åº•å°±æ˜¯è¿™ä¸ªå®¶ä¼™çº¿ç¨‹ä¸å®‰å…¨ã€‚ 4. æºç çœ‹parse(String)æ–¹æ³•ï¼Œ 12345678910111213141516171819202122public Date parse(String text, ParsePosition pos)&#123; // è§£æå­—ç¬¦ä¸²å°†æ¯æ­¥çš„æ‰§è¡Œç»“æœæ”¾å…¥CalendarBuilderçš„å®ä¾‹calbä¸­ ... Date parsedDate; try &#123; parsedDate = calb.establish(calendar).getTime(); // If the year value is ambiguous, // then the two-digit year == the default start year if (ambiguousYear[0]) &#123; if (parsedDate.before(defaultCenturyStart)) &#123; parsedDate = calb.addYear(100).establish(calendar).getTime(); &#125; &#125; &#125; // An IllegalArgumentException will be thrown by Calendar.getTime() // if any fields are out of range, e.g., MONTH == 17. catch (IllegalArgumentException e) &#123; ... &#125; return parsedDate;&#125; çœ‹calb.establish(calendar).getTime(),è¿™é‡Œä¼ å…¥çš„æ˜¯ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œæ¯ä¸ªSimpleDateFormatä½¿ç”¨ä¸€ä¸ªCalendarå®ä¾‹ 12345678Calendar establish(Calendar cal) &#123; ... // resetæ—¥æœŸå¯¹è±¡calçš„å±æ€§å€¼ cal.clear(); // ä½¿ç”¨calbä¸­ä¸­å±æ€§è®¾ç½®cal ... // return cal; ç”±äºå¤šä¸ªçº¿ç¨‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªCalendarï¼Œå°±ä¼šå‡ºç°ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é”™è¯¯ã€‚ é‚£ä¹ˆformat()å‘¢ 12345678910111213141516public StringBuffer format(Date date, StringBuffer toAppendTo, FieldPosition pos) &#123; pos.beginIndex = pos.endIndex = 0; return format(date, toAppendTo, pos.getFieldDelegate()); &#125; // Called from Format after creating a FieldDelegate private StringBuffer format(Date date, StringBuffer toAppendTo, FieldDelegate delegate) &#123; // Convert input date to time field list calendar.setTime(date); ... return toAppendTo; &#125; ä¸»è¦çœ‹è¿™é‡Œcalendar.setTime(date);,åŒæ ·çš„åŸå› ï¼Œcalendarè¢«å¹¶å‘æ“ä½œï¼Œæœ€åå¤šä¸ªçº¿ç¨‹ä¼šè¾“å‡ºåŒæ ·çš„å€¼ã€‚ 5. è§£å†³æ–¹æ¡ˆ æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªSimpleDateFormatå®ä¾‹ï¼Œä¸è¿‡æˆ‘è§‰å¾—è¿™æ ·æ²¡å¿…è¦ã€‚ ä½¿ç”¨Apacheçš„FastDateFormatç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨ç±» FastDateFormatä¹Ÿæ˜¯ä¾èµ–Calendarï¼Œä¸è¿‡æ¯æ¬¡æ–¹æ³•è°ƒç”¨éƒ½ä¼šå®ä¾‹åŒ–ä¸€æ¬¡ï¼Œé¿å…å¤šçº¿ç¨‹æ“ä½œåŒä¸€ä¸ªCalendarã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}]},{"title":"[JavaåŸºç¡€]Javaçš„SPIæœºåˆ¶","slug":"JavaåŸºç¡€-Javaçš„SPIæœºåˆ¶","date":"2018-11-29T08:04:00.000Z","updated":"2019-07-18T09:55:56.000Z","comments":true,"path":"754409717.html","link":"","permalink":"https://htchz.cc/754409717.html","excerpt":"","text":"1. ä¸ºä»€ä¹ˆè¦SPISPI, Service Provider Interface, ç®€å•æ¥è¯´å°±æ˜¯è°ƒç”¨æ–¹æä¾›æ¥å£ï¼Œæ¥å…¥æ–¹æä¾›å®ç°ã€‚æ¯”å¦‚ä¸€ä¸ªåº”ç”¨ç¨‹åºè°ƒç”¨JDBCçš„æ¥å£ï¼Œä½ è¦æ˜¯ä½¿ç”¨mysqlï¼Œå°±å¾—æä¾›mysqlæä¾›çš„jdbcå®ç°ã€‚è¿™å’Œæˆ‘ä»¬å®šä¹‰æ¥å£ç„¶åå†™å®ç°ç±»å·®ä¸å¤šï¼Œåªä¸è¿‡å®ç°ç±»æ˜¯å¯ä»¥åœ¨jar/warå¤–æä¾›ã€‚ 2. åŸç†javaçš„å®ç°æ— éæ˜¯è¯»å–æ–‡ä»¶ï¼ŒæŒ‰ç±»ååŠ è½½ã€‚ 2.1. è°ƒç”¨æ–¹å®šä¹‰æ¥å£123public interface Name &#123; String getName();&#125; 2.2. ç¬¬ä¸‰æ–¹å®ç°æ¥å£123456public class HtcName implements Name &#123; @Override public String getName() &#123; return \"htc\"; &#125;&#125; 123456public class DefaultName implements Name &#123; @Override public String getName() &#123; return \"default\"; &#125;&#125; 2.3. å£°æ˜ç¬¬ä¸‰æ–¹å®ç°åœ¨CLASSPATHä¸‹å»ºMETA-INF/services,è¿™ä¸ªè·¯å¾„æ˜¯javaçš„ä»£ç å†™æ­»çš„ã€‚ç„¶åæ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ºæ¥å£åã€‚ æ–‡ä»¶çš„å†…å®¹å°±æ˜¯å£°æ˜è¦åŠ è½½çš„å®ç°ç±»ã€‚ com.htc.learning.api.impl.DefaultName com.htc.learning.api.impl.HtcName2.4. è°ƒç”¨æ–¹åŠ è½½å®ç°ç±»ä½¿ç”¨ServiceLoaderç±»åŠ è½½å®ç°ç±»ï¼Œä»–ä¼šæœç´¢CLASSPATHä¸‹çš„æ‰€æœ‰çš„â€META-INF/services/com.htc.learning.api.Nameâ€æ–‡ä»¶ï¼Œè·å–æ‰€æœ‰å£°æ˜ä¸€ä¸€åŠ è½½ã€‚æ³¨æ„,ç±»çš„å®ä¾‹åŒ–å‘ç”Ÿåœ¨éå†çš„æ—¶å€™ 12345678public class SpiTest &#123; public static void main(String[] args) &#123; ServiceLoader&lt;Name&gt; serviceLoader = ServiceLoader.load(Name.class); for (Name name : serviceLoader) &#123; System.out.println(name.getName()); &#125; &#125;&#125; 3. æºç çœ‹çœ‹ServiceLoader.load(Name.class)åšäº†ä»€ä¹ˆäº‹ã€‚ 1234public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service) &#123; ClassLoader cl = Thread.currentThread().getContextClassLoader(); return ServiceLoader.load(service, cl);&#125; è¿™é‡Œä½¿ç”¨äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå› ä¸ºå†…ç½®Spiæ¥å£éƒ½æ˜¯ç”±Bootstrapç±»åŠ è½½å™¨åŠ è½½ï¼ŒBootstrapç±»åŠ è½½å™¨åˆåŠ è½½ä¸äº†ç¬¬ä¸‰æ–¹å®ç°ç±»ï¼Œæ‰€ä»¥è¦ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆé»˜è®¤æ˜¯Appç±»åŠ è½½å™¨ï¼‰ è¿›å…¥æ–¹æ³•åï¼Œè·å–äº†ClassLoader,æ¥ä¸‹æ¥ç»§ç»­è¿›å…¥ServiceLoader.load(service, cl);æ–¹æ³•ã€‚ 12345public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service, ClassLoader loader)&#123; return new ServiceLoader&lt;&gt;(service, loader);&#125; è¿”å›äº†ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆæŸ¥çœ‹ä»–çš„æ„é€ æ–¹æ³•ã€‚ 1234567891011public void reload() &#123; providers.clear(); lookupIterator = new LazyIterator(service, loader);&#125;private ServiceLoader`(Class&lt;S&gt; svc, ClassLoader cl) &#123; service = Objects.requireNonNull(svc, \"Service interface cannot be null\"); loader = (cl == null) ? ClassLoader.getSystemClassLoader() : cl; acc = (System.getSecurityManager() != null) ? AccessController.getContext() : null; reload();&#125; åˆ°è¿™é‡Œï¼Œå®Œå…¨æ²¡æœ‰ä»»ä½•å®ä¾‹åŒ–çš„ä»£ç ã€‚ å‰é¢è¯´åˆ°æ˜¯å®ä¾‹åŒ–å‘ç”Ÿåœ¨éå†çš„æ—¶å€™ï¼Œåœ¨æ„é€ å‡½æ•°é‡Œä¹Ÿæœ‰å®ä¾‹åŒ–ä¸€ä¸ªLazyIteratorçš„ç±»ï¼Œæˆ‘ä»¬è½¬åˆ°ServiceLoaderçš„iterator()æ–¹æ³•ã€‚ 123456789101112131415161718192021222324public Iterator&lt;S&gt; iterator() &#123; return new Iterator&lt;S&gt;() &#123; Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders = providers.entrySet().iterator(); public boolean hasNext() &#123; if (knownProviders.hasNext()) return true; return lookupIterator.hasNext(); &#125; public S next() &#123; if (knownProviders.hasNext()) return knownProviders.next().getValue(); return lookupIterator.next(); &#125; public void remove() &#123; throw new UnsupportedOperationException(); &#125; &#125;;&#125; å…ˆæ˜¯hasNext(),æœ‰ä¸€ä¸ªknownProvidersçš„å˜é‡ï¼Œå®ƒä»providerså±æ€§è·å¾—ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªLinkedHashMap&lt;String,S&gt;ï¼Œèµ·åˆ°ä¸€ä¸ªç¼“å­˜çš„ä½œç”¨ï¼Œä¿è¯å®ç°ç±»åªè¢«åŠ è½½ä¸€æ¬¡ã€‚æˆ‘ä»¬å¯ä»¥ä¸å…³æ³¨ç¼“å­˜ï¼Œçœ‹lookupIterator.hasNext()ã€‚lookupIteratoråœ¨ä¸Šé¢lookupIterator = new LazyIterator(service, loader);è¢«èµ‹å€¼äº†çš„ï¼Œä¸‹é¢æ˜¯LazyIteratorçš„ä»£ç  12345678910public boolean hasNext() &#123; if (acc == null) &#123; return hasNextService(); &#125; else &#123; PrivilegedAction&lt;Boolean&gt; action = new PrivilegedAction&lt;Boolean&gt;() &#123; public Boolean run() &#123; return hasNextService(); &#125; &#125;; return AccessController.doPrivileged(action, acc); &#125;&#125; è¿™é‡Œæœ‰java SecurityManagerçš„ç®¡ç†ï¼Œç›´æ¥çœ‹hasNextService()çš„ä»£ç å°±å¥½äº†ã€‚ 123456789101112131415161718192021222324252627private boolean hasNextService() &#123; //nextNameåœ¨ä¸Šä¸€æ¬¡æŸ¥è¯¢æå‰ç¼“å­˜å®ç°ç±»çš„åå­—ï¼Œåšåˆ°å¿«é€Ÿåˆ¤æ–­ if (nextName != null) &#123; return true; &#125; if (configs == null) &#123; try &#123; // è¿™é‡Œçš„ PREFIX å°±æ˜¯ \"META-INF/services/\" String fullName = PREFIX + service.getName(); if (loader == null) configs = ClassLoader.getSystemResources(fullName); else configs = loader.getResources(fullName); &#125; catch (IOException x) &#123; fail(service, \"Error locating configuration files\", x); &#125; &#125; while ((pending == null) || !pending.hasNext()) &#123; if (!configs.hasMoreElements()) &#123; return false; &#125; pending = parse(service, configs.nextElement()); &#125; // æå‰ç¼“å­˜å®ç°ç±»çš„åå­—ï¼Œä¸‹ä¸€æ¬¡æŸ¥è¯¢åšåˆ°å¿«é€Ÿåˆ¤æ–­ nextName = pending.next(); return true;&#125; æ¥ä¸‹æ¥çœ‹next()æ“ä½œã€‚ 12345public S next() &#123; if (knownProviders.hasNext()) return knownProviders.next().getValue(); return lookupIterator.next();&#125; è½¬åˆ°lookupIterator.next() 12345678910public S next() &#123; if (acc == null) &#123; return nextService(); &#125; else &#123; PrivilegedAction&lt;S&gt; action = new PrivilegedAction&lt;S&gt;() &#123; public S run() &#123; return nextService(); &#125; &#125;; return AccessController.doPrivileged(action, acc); &#125;&#125; çœ‹nextService() 12345678910111213141516171819202122232425262728private S nextService() &#123; // è¿™é‡Œä¼šæ‰§è¡ŒhasNextService()çš„åˆ¤æ–­ if (!hasNextService()) throw new NoSuchElementException(); String cn = nextName; nextName = null; Class&lt;?&gt; c = null; try &#123; c = Class.forName(cn, false, loader); &#125; catch (ClassNotFoundException x) &#123; fail(service, \"Provider \" + cn + \" not found\"); &#125; if (!service.isAssignableFrom(c)) &#123; fail(service, \"Provider \" + cn + \" not a subtype\"); &#125; try &#123; S p = service.cast(c.newInstance()); providers.put(cn, p); return p; &#125; catch (Throwable x) &#123; fail(service, \"Provider \" + cn + \" could not be instantiated\", x); &#125; throw new Error(); // This cannot happen&#125; å®é™…ä¸ŠnextService()æ²¡å‚ä¸éå†ï¼Œå®ç°ç±»çš„éå†æ˜¯äº¤ç»™äº†hasNextService()å¹¶æŠŠéå†åˆ°çš„ClassNameå­˜æ”¾åˆ°nextNameå±æ€§ï¼ŒnextService()åªè´Ÿè´£æŠŠnextNameå®ä¾‹åŒ–ï¼Œå¹¶ä¸”æ”¾å…¥ç¼“å­˜ä¸­ã€‚ 4. ç¼ºç‚¹javaçš„SPIæ˜¯æœ‰ç¼ºç‚¹çš„ï¼Œè¿™ä¹Ÿæ˜¯dubboä¸ºä»€ä¹ˆè¦å®ç°è‡ªå·±çš„SPIæœºåˆ¶ã€‚ JDK æ ‡å‡†çš„ SPI ä¼šä¸€æ¬¡æ€§å®ä¾‹åŒ–æ‰©å±•ç‚¹æ‰€æœ‰å®ç°ï¼Œå¦‚æœæœ‰æ‰©å±•å®ç°åˆå§‹åŒ–å¾ˆè€—æ—¶ï¼Œä½†å¦‚æœæ²¡ç”¨ä¸Šä¹ŸåŠ è½½ï¼Œä¼šå¾ˆæµªè´¹èµ„æºã€‚ 5. é¢˜å¤–è¯æˆ‘ä»¬javaç¨‹åºåŠ è½½æ•°æ®åº“é©±åŠ¨çš„æ—¶å€™ï¼Œåˆ©ç”¨çš„å°±æ˜¯javaçš„spiæœºåˆ¶ã€‚å¦‚æœæˆ‘ä»¬å¼•å…¥äº†å¤šä¸ªæ•°æ®åº“çš„jdbcé©±åŠ¨jarï¼Œé‚£ä¹ˆjavaæ€ä¹ˆçŸ¥é“åŠ è½½å“ªä¸€ä¸ªå‘¢ã€‚ æˆ‘ä»¬æˆ‘çš„æ•°æ®åº“é©±åŠ¨æ˜¯ç”±java.sql.DriverManagerç®¡ç†çš„ï¼Œç°åœ¨çœ‹ä»–çš„ä¸€ä¸ªgetDriver()æ–¹æ³•ï¼Œ 123456789101112131415161718192021222324252627@CallerSensitivepublic static Driver getDriver(String url) throws SQLException &#123; ... // who understands the given URL. for (DriverInfo aDriver : registeredDrivers) &#123; // If the caller does not have permission to load the driver then // skip it. if(isDriverAllowed(aDriver.driver, callerClass)) &#123; try &#123; // å°±æ˜¯è¿™ä¸€è¡Œï¼ if(aDriver.driver.acceptsURL(url)) &#123; // Success! println(\"getDriver returning \" + aDriver.driver.getClass().getName()); return (aDriver.driver); &#125; &#125; catch(SQLException sqe) &#123; // Drop through and try the next driver. &#125; &#125; else &#123; println(\" skipping: \" + aDriver.driver.getClass().getName()); &#125; &#125; ...&#125; çœ‹if(aDriver.driver.acceptsURL(url))è¿™ä¸€è¡Œï¼ŒDriverManagerç”¨è¿æ¥çš„urlå¯¹æ¯ä¸€ä¸ªé©±åŠ¨è¿›è¡Œå°è¯•ï¼Œå°è¯•å¾—é€šå°±æ˜¯è¿™ä¸ªé©±åŠ¨æ²¡è·‘äº†ã€‚ã€‚ã€‚ 6. ç»“æŸè¯­æ— ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"OOP","slug":"OOP","permalink":"https://htchz.cc/tags/OOP/"}],"author":"åœŸå·"},{"title":"[Dubbo]æ¢ç´¢dubbo2.6.3ç‰ˆæœ¬ä¹‹å‰çš„ä¸€ä¸ªé—®é¢˜","slug":"ç¢§æ²¹é¸¡-æ¢ç´¢dubbo2-6-3ç‰ˆæœ¬ä¹‹å‰çš„ä¸€ä¸ªé—®é¢˜","date":"2018-10-20T02:55:00.000Z","updated":"2020-01-12T06:32:46.524Z","comments":true,"path":"1632594101.html","link":"","permalink":"https://htchz.cc/1632594101.html","excerpt":"ç”±äºdubboç‰ˆæœ¬è¾ƒä½é‡åˆ°äº†ä¸€ä¸ªè¯¡å¼‚çš„é—®é¢˜ã€‚","text":"ç”±äºdubboç‰ˆæœ¬è¾ƒä½é‡åˆ°äº†ä¸€ä¸ªè¯¡å¼‚çš„é—®é¢˜ã€‚ 1. åœºæ™¯dubboçš„RpcContextå­˜æ”¾äº†ä¸€ä¸ªattachmentså±æ€§ï¼Œç”¨äºéšå¼ä¼ é€’å‚æ•°ï¼Œæ¯æ¬¡å‘èµ·è°ƒç”¨ä¹‹åä¼šclearæ¸…ç©ºã€‚ ä½¿ç”¨äº†catç›‘æ§ä¹‹åï¼Œå¯ä»¥åœ¨dubboæœåŠ¡è°ƒç”¨ä¹‹é—´ä¼ é€’ä¸€ä¸ªidä½œä¸ºé“¾è·¯è·Ÿè¸ªã€‚è€Œè¿™ä¸ªå‚æ•°å°±æ˜¯åœ¨Comsumerå‘èµ·è¯·æ±‚å‰æ”¾å…¥attachmentsï¼Œåœ¨Provideræ¥æ”¶åˆ°è¯·æ±‚åä»attachmentsæ‹¿å‡ºã€‚ æµ‹è¯•ç¯å¢ƒè°ƒç”¨æŸæœåŠ¡ä¼šå‡ºç°è¿™ä¸ªidæ—¶æœ‰æ—¶æ— çš„æƒ…å†µï¼Œäºæ˜¯åˆ†ææ—¥å¿—ï¼Œå‘ç°æ²¡æœ‰è¿™ä¸ªidçš„æƒ…å†µä¸‹ï¼Œdubboåè®®èµ°çš„æ˜¯hessianåè®®ã€‚åŸæ¥æ­¤æœåŠ¡æä¾›äº†hessianè®¿é—®ï¼Œäºæ˜¯å®¢æˆ·ç«¯ä¼šéšæœºèµ°dubboæˆ–è€…hessianåè®®ã€‚ ä¸ºä»€ä¹ˆhessianåè®®ä¼šä¸¢attachmentsï¼Ÿè¿™ä¸ªidæ˜¯é€šè¿‡å®ç°dubboçš„Filterå¡è¿›å»çš„ï¼Œç†è®ºä¸ŠFilteråº”è¯¥æ˜¯åè®®æ— å…³çš„ã€‚é€šè¿‡debugå‘ç°ï¼Œåœ¨å‘é€è¯·æ±‚ä¹‹å‰çš„RpcContext.attachmentsé‡Œä¹Ÿçš„ç¡®æ˜¯æœ‰è¿™ä¸ªidã€‚ 2. æ¢ç´¢2.1. dubboåè®®dubboçš„consumerè°ƒç”¨æŠ½è±¡ä¸ºInvokerå’ŒInvocationï¼Œåœ¨Invokeræ‰§è¡Œinvokeæ–¹æ³•ä¹‹å‰ï¼Œéœ€è¦æ‰§è¡Œè´Ÿè½½å‡è¡¡ã€é‡è¯•è®¡æ•°ã€æ‹¦æˆªå™¨è°ƒç”¨é“¾ï¼Œæœ€åæ‰§è¡ŒæŠ½è±¡ç±»AbstractInvoker.invokeæ–¹æ³•ï¼Œç»§è€Œè°ƒç”¨ä¸åŒåè®®çš„doInvokeæ–¹æ³• çœ‹çœ‹dubboåè®®çš„doInvokeæ–¹æ³•ï¼Œ å¯ä»¥çœ‹åˆ°è¯·æ±‚æ˜¯ç”±ä¸€ä¸ªHeaderExchangeClientå»å‘èµ·ï¼Œè¿™é‡Œçš„çš„channelæ˜¯ä¸€ä¸ªnettyClientï¼Œè€Œrequestçš„å†…å®¹å¦‚ä¸‹ï¼šdubboåè®®çš„å®ç°æ˜¯åˆ©ç”¨socketé•¿è¿æ¥ï¼Œå°†æ•´ä¸ªrequestå¯¹è±¡å‘é€è¿‡å»çš„,æ²¡æœ‰ä¸¢attachments 2.2. hessianåè®®hessianåè®®ä¸‹æ˜¯é€šè¿‡com.caucho.hessian.client.HessianProxy#invokeæ¥å‘èµ·è¯·æ±‚ï¼Œè¿™ä¸ªæ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š 1public Object invoke(Object proxy, Method method, Object[] args) ç¬¬ä¸€ä¸ªå‚æ•°ä¸çŸ¥é“æ˜¯å¹²å˜›çš„ï¼Œç¬¬äºŒä¸ªå‚æ•°å’Œç¬¬ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯è°ƒç”¨æœåŠ¡çš„æ–¹æ³•å¯¹è±¡å’Œå‚æ•°ã€‚åæ­£è¿™ä¸ªæ–¹æ³•æ˜¯æ²¡åœ°æ–¹æ”¾attchmentsè¿™ç§éšå¼å‚æ•°å«ä¹‰çš„ä¸œè¥¿ã€‚ debugçœ‹ä»–çš„è°ƒç”¨æ ˆï¼Œ å®šä½åˆ°è¿™ä¸ªcom.alibaba.dubbo.rpc.proxy.AbstractProxyInvoker#invokeæ–¹æ³• 123456789public Result invoke(Invocation invocation) throws RpcException &#123; try &#123; return new RpcResult(doInvoke(proxy, invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments())); &#125; catch (InvocationTargetException e) &#123; return new RpcResult(e.getTargetException()); &#125; catch (Throwable e) &#123; throw new RpcException(\"Failed to invoke remote proxy method \" + invocation.getMethodName() + \" to \" + getUrl() + \", cause: \" + e.getMessage(), e); &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œä»è¿™é‡Œå¼€å§‹ 1return new RpcResult(doInvoke(proxy, invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments())); å°±æŠŠinvocationé‡Œçš„attachmentsä¸¢äº† 3. è§£å†³æ–¹æ³•dubboç‰ˆæœ¬è‡³å°‘å‡çº§ç›´2.6.3ï¼Œè¿™ä¸ªç‰ˆæœ¬å¯¹æä¾›äº†å¯¹hessianåè®®çš„attachmentsæ”¯æŒã€‚ ä¸‹é¢æ˜¯éƒ¨åˆ†ä»£ç ï¼Œ 12345678910111213public class DubboHessianURLConnectionFactory extends HessianURLConnectionFactory &#123; @Override public HessianConnection open(URL url) throws IOException &#123; HessianConnection connection = super.open(url); RpcContext context = RpcContext.getContext(); for (String key : context.getAttachments().keySet()) &#123; connection.addHeader(Constants.DEFAULT_EXCHANGER + key, context.getAttachment(key)); &#125; return connection; &#125;&#125; dubboé€šè¿‡ç»§æ‰¿hessianåº“çš„ç±»ï¼Œåœ¨å¤„ç†URLçš„æ—¶å€™æŠŠattachmentsæ”¾åˆ°headeré‡Œå»äº†ï¼Œæ¥æ”¶è¯·æ±‚æ—¶å†ä»headeré‡Œæ‹¿å‡ºæ¥ã€‚","categories":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://htchz.cc/categories/Dubbo/"}],"tags":[{"name":"BUG","slug":"BUG","permalink":"https://htchz.cc/tags/BUG/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]æ­£ç¡®ä½¿ç”¨CompletableFuture","slug":"JavaåŸºç¡€-æ­£ç¡®ä½¿ç”¨CompletableFuture","date":"2018-10-12T05:36:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"1193009570.html","link":"","permalink":"https://htchz.cc/1193009570.html","excerpt":"ç”¨ä¸å¥½å¯å°±æç¬‘äº†å“¦","text":"ç”¨ä¸å¥½å¯å°±æç¬‘äº†å“¦ 1. å‰è¨€è¿™ä¸ªç±»æ˜¯jdk8æä¾›çš„ç±»ï¼Œåœ¨è¿™ä¸ªç±»ä¹‹å‰çš„å…¶ä»–Futureå®ç°ç±»ï¼Œå­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼Œæ¯”å¦‚ç¼ºå°‘ä¸€äº›ä»»åŠ¡å®Œæˆçš„é€šçŸ¥æœºåˆ¶ã€‚ äºæ˜¯CompletableFutureè¯ç”Ÿäº†ï¼Œä»–æä¾›äº†ä»»åŠ¡å›è°ƒçš„æœºåˆ¶ï¼Œè¿˜å¯ä»¥ç®€æ´çš„ç»„åˆä¸¤ä¸ªä»»åŠ¡ï¼›æ›´å¯ä»¥èšåˆnä¸ªä»»åŠ¡ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªä»»åŠ¡å®Œæˆçš„å…¨éƒ¨ä»»åŠ¡å®Œæˆåè¿›è¡ŒæŸç§æ“ä½œã€‚å…³äºå®ƒçš„ç‰¹æ€§ä¸å¤šè¯´ã€‚ jdk8é‡Œçš„ParallelStreamå’ŒCompletableFutureçš„å‡ºç°è®©javaçš„å¼‚æ­¥ç¼–ç¨‹å˜çš„æ›´ä¸ºè‡ªç„¶çµæ´»ã€‚ 2. çº¿ç¨‹æ± é‚£äº›äº‹jdk1.7è€æè®¾è®¡äº†ForkJoinPoolæ¡†æ¶ï¼Œæ ¸å¿ƒå°±æ˜¯ä»»åŠ¡çªƒå–ç®—æ³•ã€‚ForkJoinPoolæœ‰ä¸ªé€šç”¨çº¿ç¨‹æ± ï¼Œä»–çš„å·¥ä½œçº¿ç¨‹æ•°åœ¨å¤šæ ¸ç¯å¢ƒä¸‹é»˜è®¤æ˜¯Runtime.getRuntime().availableProcessors() - 1,ä¹Ÿå°±â€œæœºå™¨cpuçš„çº¿ç¨‹æ•° - 1â€œï¼ˆå‡ä¸€å¯èƒ½æ˜¯æœ€ä½³å®è·µå§ï¼‰ï¼Œ 1234public static ForkJoinPool commonPool() &#123; // assert common != null : \"static init error\"; return common;&#125; ParallelStreamæ–°ä»»åŠ¡æ˜¯åªèƒ½æäº¤åˆ°è¿™ä¸ªçº¿ç¨‹æ± çš„ï¼Œè€ŒCompletableFutureé»˜è®¤ä½¿ç”¨è¿™ä¸ªçº¿ç¨‹æ± ï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒè‡ªå·±æä¾›çº¿ç¨‹æ± ã€‚ å¯ä»¥çœ‹åˆ°runAsyncå’ŒsupplyAsyncæœ‰é‡è½½æ–¹æ³•æä¾›Executorã€‚ é‚£ä¹ˆæˆ‘ä»¬ä»€ä¹ˆæ—¶å€™è¦æä¾›çº¿ç¨‹æ± å‘¢ï¼Œè¿™é‡Œçœ‹ã€Šjava8å®æˆ˜ã€‹çš„ä¸€æ®µè¯ï¼Œ å¹¶è¡Œâ€”â€”ä½¿ç”¨æµè¿˜æ˜¯CompletableFutures?é›†åˆè¿›è¡Œå¹¶è¡Œè®¡ç®—æœ‰ä¸¤ç§æ–¹å¼:è¦ä¹ˆå°†å…¶è½¬åŒ–ä¸ºå¹¶è¡Œæµï¼Œåˆ©ç”¨mapè¿™æ ·çš„æ“ä½œå¼€å±•å·¥ä½œï¼Œè¦ä¹ˆæšä¸¾å‡ºé›†åˆä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œåˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œåœ¨CompletableFutureå†…å¯¹å…¶è¿›è¡Œæ“ä½œã€‚åè€…æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œä½ å¯ä»¥è°ƒæ•´çº¿ç¨‹æ± çš„å¤§å°ï¼Œè€Œè¿™èƒ½å¸®åŠ©ä½ ç¡®ä¿æ•´ä½“çš„è®¡ç®—ä¸ä¼šå› ä¸ºçº¿ç¨‹éƒ½åœ¨ç­‰å¾…I/Oè€Œå‘ç”Ÿé˜»å¡ã€‚æˆ‘ä»¬å¯¹ä½¿ç”¨è¿™äº›APIçš„å»ºè®®å¦‚ä¸‹ã€‚ å¦‚æœä½ è¿›è¡Œçš„æ˜¯è®¡ç®—å¯†é›†å‹çš„æ“ä½œï¼Œå¹¶ä¸”æ²¡æœ‰I/Oï¼Œé‚£ä¹ˆæ¨èä½¿ç”¨Streamæ¥å£ï¼Œå› ä¸ºå®ç°ç®€å•ï¼ŒåŒæ—¶æ•ˆç‡ä¹Ÿå¯èƒ½æ˜¯æœ€é«˜çš„(å¦‚æœæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯è®¡ç®—å¯†é›†å‹çš„ï¼Œé‚£å°±æ²¡æœ‰å¿…è¦åˆ›å»ºæ¯”å¤„ç†å™¨æ ¸æ•°æ›´å¤šçš„çº¿ç¨‹)ã€‚ å¦‚æœä½ å¹¶è¡Œçš„å·¥ä½œå•å…ƒè¿˜æ¶‰åŠç­‰å¾…I/Oçš„æ“ä½œ(åŒ…æ‹¬ç½‘ç»œè¿æ¥ç­‰å¾…)ï¼Œé‚£ä¹ˆä½¿ç”¨CompletableFutureçµæ´»æ€§æ›´å¥½ï¼Œä½ å¯ä»¥åƒå‰æ–‡è®¨è®ºçš„é‚£æ ·ï¼Œä¾æ®ç­‰å¾…/è®¡ç®—ï¼Œæˆ–è€… W/Cçš„æ¯”ç‡è®¾å®šéœ€è¦ä½¿ç”¨çš„çº¿ç¨‹æ•°ã€‚è¿™ç§æƒ…å†µä¸ä½¿ç”¨å¹¶è¡Œæµçš„å¦ä¸€ä¸ªåŸå› æ˜¯ï¼Œå¤„ç†æµçš„æµæ°´çº¿ä¸­å¦‚æœå‘ç”ŸI/Oç­‰å¾…ï¼Œæµçš„å»¶è¿Ÿç‰¹æ€§(æµçš„ä¸­é—´æ“ä½œä¼šåœ¨ä¸€èµ·æ‰§è¡Œ)ä¼šè®©æˆ‘ä»¬å¾ˆéš¾åˆ¤æ–­åˆ°åº•ä»€ä¹ˆæ—¶å€™è§¦å‘äº†ç­‰å¾…ã€‚ ç®€å•åœ°è¯´ï¼ŒForkJoinPoolé€šç”¨çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°æ¯”è¾ƒå°‘ï¼Œä¸é€‚åˆç”¨æ¥è¿›è¡Œéœ€è¦I/Oç­‰å¾…çš„ä»»åŠ¡ã€‚å¦‚æœç”¨CompletableFutureæäº¤ä¸€äº›éœ€è¦I/Oç­‰å¾…çš„ä»»åŠ¡ï¼Œéœ€è¦æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„Executorã€‚ ä¸‹é¢ç”¨ç¨‹åºæ¼”ç¤ºä¸€ä¸‹ï¼Œ 12345678910111213141516171819202122232425262728public class CompletableTest &#123; public static void main(String[] args) &#123; ExecutorService service = Executors.newFixedThreadPool(100); Stopwatch stopwatch = Stopwatch.createUnstarted(); stopwatch.start(); // ä¸æä¾›Executorï¼ŒUninterruptibles.sleepUninterruptibly(1, TimeUnit.SECONDS)æ¨¡æ‹Ÿç½‘ç»œI/O 1ç§’ CompletableFuture.allOf( IntStream.rangeClosed(1, 100).boxed() .map(a -&gt; CompletableFuture.runAsync(() -&gt; Uninterruptibles.sleepUninterruptibly(1, TimeUnit.SECONDS))) .toArray(CompletableFuture[]::new)) .join(); System.out.println(\"elapsed with ForkJoinPool:\" + stopwatch.stop().elapsed(TimeUnit.MILLISECONDS) + \" ms\"); stopwatch.reset().start(); // æä¾›Executor CompletableFuture.allOf( IntStream.rangeClosed(1, 100).boxed() .map(a -&gt; CompletableFuture.runAsync(() -&gt; Uninterruptibles.sleepUninterruptibly(1, TimeUnit.SECONDS), service)) .toArray(CompletableFuture[]::new)) .join(); System.out.println(\"elapsed with Executor:\" + stopwatch.stop().elapsed(TimeUnit.MILLISECONDS) + \" ms\"); service.shutdown(); &#125;&#125; elapsed with ForkJoinPool:15100 ms elapsed with Executor:1019 msæˆ‘çš„ç”µè„‘æ˜¯8çº¿ç¨‹ï¼Œé‚£ä¹ˆForkJoinPoolé€šç”¨çº¿ç¨‹æ± å°±æ˜¯ (8 - 1 = 7 )ä¸ªçº¿ç¨‹ï¼Œ å¯ä»¥çœ‹åˆ°100ä¸ªä»»åŠ¡æ‰§è¡Œäº†15ç§’ ( çº¦ç­‰äº 100 / 7)ã€‚æ‰€ä»¥ä½¿ç”¨CompletableFutureçš„æ—¶å€™è¦æ³¨æ„è¿™ç‚¹ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[åˆ†å¸ƒå¼]æ¥å£é™æµ","slug":"åˆ†å¸ƒå¼-æ¥å£é™æµ","date":"2018-09-29T07:51:00.000Z","updated":"2020-06-30T08:47:42.817Z","comments":true,"path":"2168043814.html","link":"","permalink":"https://htchz.cc/2168043814.html","excerpt":"å°è¯•ä¸€ä¸‹ç”¨luaè„šæœ¬æ‰§è¡Œrediså‘½ä»¤","text":"å°è¯•ä¸€ä¸‹ç”¨luaè„šæœ¬æ‰§è¡Œrediså‘½ä»¤ 1. å‰è¨€å¯¹äºåº”ç”¨å†…éƒ¨çš„æœåŠ¡é™æµï¼Œç†”æ–­å™¨Hystrixï¼Œä½œå‡ºå¾ˆå¥½çš„å®è·µã€‚æœ€è¿‘å¼€æºçš„Sentinelä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ ä¸è¿‡å¯¹äºé›†ç¾¤æ¥å£é™æµï¼Œå¥½åƒæ²¡æœ‰ä»€ä¹ˆæ¡†æ¶ã€‚å¸¸ç”¨çš„é™æµç®—æ³•å°±æ˜¯ï¼šæ¼æ¡¶ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•ã€‚æœ¬æ–‡å°†åˆ©ç”¨rediså’Œluaè„šæœ¬å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ŒåŒæ—¶é€šè¿‡springæ¥é©±åŠ¨è„šæœ¬ã€‚Guavaæä¾›äº†ä¸€ä¸ªRateLimiterï¼Œæˆ‘ä»¬ä¹Ÿçœ‹ä¸€ä¸‹ã€‚ å½“ç„¶è¿˜å¯ä»¥ç”¨è®¡æ•°å™¨æ–¹æ³•ï¼Œå¦‚è®¾å®šä¸€ä¸ªè®¡æ•°keyï¼Œä¸€ç§’è¿‡æœŸï¼Œä¸€ç§’å†…è¾¾åˆ°næ¬¡å°±æ‹’ç»æœåŠ¡ã€‚ 2. ä¸¤ä¸ªç®—æ³•Googleäº†åå‡ ä¸ªä¸­æ–‡åšå®¢ï¼Œæ¯ä¸€ç¯‡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¯´ä¸¤ç§ç®—æ³•èƒ½é™åˆ¶é€Ÿç‡ï¼Œä½†æ˜¯æ¼æ¡¶ç®—æ³•ä¸èƒ½åº”å¯¹çªå‘æµé‡è€Œä»¤ç‰Œæ¡¶å¯ä»¥ï¼Œåˆæ²¡è¯´ä¸ºä»€ä¹ˆã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œä¸¤ç§ç®—æ³•çš„ç®—æ³•ä¸è¿‡æ˜¯â€œä¸€æ­£ä¸€åâ€ï¼Œæœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚æ— å¥ˆè‹±è¯­æ¸£çœ‹äº†ä¸€ä¸‹ç»´åŸºç™¾ç§‘â€LeakyBucketâ€è¯æ¡ï¼ŒOverviewé‡Œæåˆ°ï¼Œæœ‰ä¸¤ç§ç‰ˆæœ¬çš„æ¼æ¡¶ç®—æ³•ï¼š 2.1. æ¼æ¡¶ç®—æ³•ï¼ˆLeakyBucketï¼‰ as a meterï¼ˆä½œä¸ºè®¡é‡å™¨ï¼‰ as a queueï¼ˆä½œä¸ºè°ƒåº¦é˜Ÿåˆ—ï¼‰ ç¬¬ä¸€ç§ç‰ˆæœ¬æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•çš„é•œåƒå®ç°ï¼Œä¹Ÿå°±æ˜¯æè¿°èµ·æ¥ä¸ä¸€æ ·ï¼ŒåŸç†ä¸€æ ·ã€‚åªè¦å…ƒç´ èƒ½æ”¾è¿›æ¡¶ï¼Œå°±æ˜¯å…è®¸é€šè¿‡ã€‚ ç¬¬äºŒç§ç‰ˆæœ¬æ˜¯æŠŠæ¡¶ä½œä¸ºé˜Ÿåˆ—ï¼Œåªæœ‰å…ƒç´ æ¼å‡ºæ¡¶ï¼Œè¿™ä¸ªå…ƒç´ æ‰ç®—é€šè¿‡ã€‚å› ä¸ºæ¼æ¡¶çš„é€Ÿç‡æ˜¯æ’å®šçš„ï¼Œæ‰€ä»¥èƒ½èµ·åˆ°æµé‡æ•´å½¢çš„ä½œç”¨ã€‚ æ¼æ¡¶ç®—æ³•æŒ‡ä¸€å®šé€Ÿç‡æ¼æ°´ï¼Œæµé‡è¿›æ¥çš„æ—¶å€™æ˜¯æŠŠæ°´åŠ å…¥æ¡¶é‡Œï¼Œå½“æ°´&gt; å®¹é‡çš„æ—¶å€™æ‹’ç»æœåŠ¡ï¼ˆæˆ–è€…å…¶ä»–ç­–ç•¥balabalaï¼‰ã€‚ ä¸¤ä¸ªé‡è¦å‚æ•°ï¼š æ¼æ°´é€Ÿç‡ æ¡¶å®¹é‡ ä¸‹é¢æ˜¯è®¡é‡å™¨ç‰ˆæœ¬ä¼ªä»£ç ï¼š 12345678910111213141516171819double rate; // leak rate in calls/sdouble burst; // bucket size in callslong refreshTime; // time for last water refreshdouble water; // water count at refreshTimerefreshWater() &#123; long now = getTimestamp(); //è®¡ç®—ä¸¤æ¬¡è¯·æ±‚ä¹‹é—´æµå¤±çš„æ°´å¹¶ç›¸å‡ water = max(0, water- (now - refreshTime)*rate); refreshTime = now;&#125;bool check() &#123; refreshWater(); if (water &lt; burst) &#123; // æ°´æ¡¶è¿˜æ²¡æ»¡,ç»§ç»­åŠ 1 water ++; return true; &#125; else &#123; return false; &#125;&#125; 2.2. ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆTokenBucketï¼‰ ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯ç½‘ç»œæµé‡æ•´å½¢ï¼ˆTraffic Shapingï¼‰å’Œé€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰ä¸­æœ€å¸¸ä½¿ç”¨çš„ä¸€ç§ç®—æ³•ã€‚å…¸å‹æƒ…å†µä¸‹ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•ç”¨æ¥æ§åˆ¶å‘é€åˆ°ç½‘ç»œä¸Šçš„æ•°æ®å­—èŠ‚æ•°ç›®ï¼Œå¹¶å…è®¸çªå‘æ•°æ®çš„å‘é€ï¼Œç”¨ä»¤ç‰Œæ•°é‡ä»£è¡¨å­—èŠ‚æ•°é‡ã€‚ ä¸¤ä¸ªé‡è¦å‚æ•°ï¼š å‘ç‰Œé€Ÿç‡ ä»¤ç‰Œæ¡¶å®¹é‡ å¯¹äºä»¤ç‰Œä¸è¶³çš„æƒ…å†µï¼Œå¯¹æµé‡å¯ä»¥è¿›è¡Œä¸‰ç§æ–¹å¼çš„å¤„ç†ï¼š ä¸¢å¼ƒæ•°æ®åŒ… æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ç›´è‡³ä»¤ç‰Œè¶³å¤Ÿ è¿›è¡Œæ ‡è®°ï¼Œè¿‡è½½æƒ…å†µä¸‹å¯ä»¥è¿›è¡Œä¸¢å¼ƒ ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†æ˜¯ç³»ç»Ÿä¼šä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿåº¦å¾€æ¡¶é‡Œæ”¾å…¥ä»¤ç‰Œï¼Œè€Œå¦‚æœè¯·æ±‚éœ€è¦è¢«å¤„ç†ï¼Œåˆ™éœ€è¦å…ˆä»æ¡¶é‡Œè·å–ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æ¡¶é‡Œæ²¡æœ‰ä»¤ç‰Œå¯å–æ—¶ï¼Œåˆ™æ‹’ç»æœåŠ¡(æˆ–è€…å…¶ä»–ç­–ç•¥balabala)ã€‚ä»åŸç†ä¸Šçœ‹ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•å’Œæ¼æ¡¶ç®—æ³•æ˜¯ç›¸åçš„ï¼Œä¸€ä¸ªâ€œè¿›æ°´â€ï¼Œä¸€ä¸ªæ˜¯â€œæ¼æ°´â€ã€‚ ä¸¢å¼ƒæ•°æ®åŒ…çš„å®ç°çœ‹æ¥¼ä¸‹luaè„šæœ¬ Guavaçš„RateLimiterå°±æ˜¯ä½¿ç”¨äº†ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚ 3. rediså®ç°redisåœ¨2.6ä¹‹åå†…ç½®äº†å¯¹luaè„šæœ¬çš„æ”¯æŒã€‚é€šè¿‡luaè„šæœ¬æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€äº›å¤æ‚çš„é€»è¾‘æ“ä½œï¼ŒåŒæ—¶ä¿è¯æ•´ä¸ªæ“ä½œè¿‡ç¨‹çš„åŸå­æ€§ã€‚ luaè„šæœ¬å†™åœ¨å®¢æˆ·ç«¯ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªluaè„šæœ¬ï¼Œåº”è¯¥å¾ˆå®¹æ˜“ç†è§£ 12345678910111213141516171819202122232425262728293031323334353637383940--token_bucket.lua--keyså’Œargvéƒ½æ˜¯æ•°ç»„--tonumber()æ–¹æ³•æ˜¯è½¬æ•´æ•°--localè¡¨ç¤ºæœ¬åœ°å˜é‡ï¼Œé€Ÿåº¦æ¯”å…¨å±€å˜é‡å¿«--..è¡¨ç¤ºæ‹¼æ¥å­—ç¬¦ä¸²local key = KEYS[1];--local limit = tonumber(ARGV[1]);local step = tonumber(ARGV[2]);local interval = tonumber(ARGV[3]);local nowTime = tonumber(ARGV[4]);local lastClearTimeKey = 'lastTimeOf' .. keylocal lastClearTime = redis.call('GET', lastClearTimeKey);local existKey = redis.call('EXISTS', key);if existKey == 1 then local diff = tonumber(nowTime) - tonumber(lastClearTime); local value = tonumber(redis.call('GET', key)); if diff &gt; interval then local maxValue = value + diff / interval * step; if maxValue &gt; step then value = step; else value = maxValue; end redis.call('SET', lastClearTimeKey, nowTime); redis.call('SET', key, math.floor(value)); end if value &lt;= 0 then return 0; else redis.call('DECR', key); endelse redis.call('SET', key, step - 1); redis.call('SET', lastClearTimeKey, nowTime);endreturn 1; 4. ä½¿ç”¨springé©±åŠ¨ç”±äºä½¿ç”¨çš„æ˜¯spring-bootï¼Œredis-serveråœ¨æœ¬åœ°ï¼Œæ‰€ä»¥åªè¦å¼•å…¥spring-data-rediså’Œjedis,å…¶ä»–é…ç½®é»˜è®¤ 12345678910&lt;dependency&gt; &lt;groupId&gt;org.springframework.data&lt;/groupId&gt; &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt; &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;redis.clients&lt;/groupId&gt; &lt;artifactId&gt;jedis&lt;/artifactId&gt; &lt;version&gt;2.9.0&lt;/version&gt;&lt;/dependency&gt; è®¾ç½®åºåˆ—åŒ–å™¨ 1234567891011@Bean@SuppressWarnings(\"unchecked\")public RedisTemplate redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123; RedisTemplate redisTemplate = new RedisTemplate(); redisTemplate.setConnectionFactory(redisConnectionFactory); // è®¾ç½®é”®çš„åºåˆ—åŒ–å™¨ redisTemplate.setKeySerializer(new StringRedisSerializer()); // é»˜è®¤Serializer,RedisTemplateåœ¨åºåˆ—åŒ–keyã€ååºåˆ—åŒ–è¿”å›å€¼çš„æ—¶å€™æ‰¾ä¸åˆ°è®¾ç½®çš„Serializerä¼šä½¿ç”¨é»˜è®¤Serializerï¼Œè€Œé»˜è®¤çš„é»˜è®¤Serializeræ˜¯JdkSerializationRedisSerializerï¼Œè¿™ä¸ªä¼šè½¬æˆå¾ˆéš¾çœ‹çš„ç å¯èƒ½å¯¼è‡´luaæ‰§è¡Œå‡ºé”™ redisTemplate.setDefaultSerializer( new GenericJackson2JsonRedisSerializer()); return redisTemplate;&#125; è„šæœ¬çš„æŠ½è±¡ç±»æ˜¯DefaultRedisScript, ä½¿ç”¨RedisTemplateè°ƒç”¨ã€‚keysæ˜¯Listç±»å‹ï¼Œargvsæ˜¯æ•°ç»„ç±»å‹ï¼Œä¸å¯ä»¥ææ··ã€‚ 123456789101112131415161718public class RedisScriptService &#123; private final static Logger log = LoggerFactory.getLogger(RedisScriptService.class); @Resource private RedisTemplate redisTemplate; public void counterConsume(String key, int limit, int step, int interval) &#123; DefaultRedisScript&lt;Long&gt; consumeRedisScript = new DefaultRedisScript&lt;&gt;(); consumeRedisScript.setResultType(Long.class); consumeRedisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(\"script/token_bucket.lua\")));//åŠ è½½luaè„šæœ¬æ–‡ä»¶ List&lt;Object&gt; keyList = new LinkedList&lt;&gt;(); keyList.add(key);//é€šè¿‡KEYS[1]å–å€¼ for (int i = 0; i &lt; 15; i++) &#123; log.info(\"result:\" + redisTemplate.execute(consumeRedisScript, keyList, new Object[]&#123;limit, step, interval, System.currentTimeMillis()&#125;).toString()); &#125; &#125;&#125; 2018-09-30 16:23:17.066 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.067 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.067 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.068 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.069 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.070 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.071 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.072 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.072 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.073 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:1 2018-09-30 16:23:17.074 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:0 2018-09-30 16:23:17.075 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:0 2018-09-30 16:23:17.076 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:0 2018-09-30 16:23:17.077 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:0 2018-09-30 16:23:17.078 INFO 18660 --- [ main] c.h.learning.service.RedisScriptService : result:0resultçš„1æ˜¯é€šè¿‡ï¼Œ0æ˜¯ä¸é€šè¿‡ã€‚ é”®æ²¡æœ‰è®¾ç½®è¿‡æœŸï¼Œå¯ä»¥ä¼˜åŒ–ã€‚ 5. Guava RateLimiterGuava RateLimiterå®ç°äº†ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªä¸­æ–‡ç‰ˆçš„å®˜æ–¹æ–‡æ¡£ï¼šGuavaå®˜æ–¹æ–‡æ¡£ï¼Œä¸»è¦å°±æ˜¯å£°æ˜å‘ç‰Œé€Ÿç‡ï¼Œç„¶åéœ€è¦åˆ¤æ–­èƒ½å¦è·å–ä»¤ç‰Œï¼Œåˆ™è°ƒç”¨tryAcquire()æˆ–tryAcquire(int)æ–¹æ³•ï¼›éœ€è¦é˜»å¡ç›´è‡³ä»¤ç‰Œè¶³å¤Ÿï¼Œåˆ™è°ƒç”¨acquire()æˆ–acquire(int)ã€‚ 5.1. qpsé™åˆ¶å™¨å‡è®¾æˆ‘ä»¬è¦é™åˆ¶æ¯ç§’å¤„ç†taskæˆ–è€…qpsçš„å€¼ï¼Œä»£ç ï¼š 1234567891011121314public class RateLimiterTest &#123; public static void main(String[] args) &#123; RateLimiter rateLimiter = RateLimiter.create(5); IntStream.range(0, 15).forEach((a) -&gt; &#123; if (a == 5) &#123; SleepUtil.sleep(2000); &#125; System.out.println(rateLimiter.acquire()); if ((a + 1) % 5 == 0) &#123; System.out.println(); &#125; &#125;); &#125;&#125; 0.0// 0ä»¤ç‰Œï¼Œè¿˜ä¸ç”¨é˜»å¡ 0.143213 0.196686 0.198948 0.199056 0.0// åœäº†2ç§’ï¼Œå‘äº†5ä¸ªä»¤ç‰Œ 0.0 0.0 0.0 0.0 0.0// 0ä»¤ç‰Œï¼Œè¿˜ä¸ç”¨é˜»å¡ 0.199505 0.198738 0.197634 0.196273ç¤ºä¾‹é‡Œå…ˆå®ä¾‹ä¸€ä¸ªé™æµå™¨ï¼Œé€Ÿç‡ä¸º1ç§’5æ¬¡ï¼Œé€šè¿‡acquire()é˜»å¡è·å¾—ä»¤ç‰Œï¼Œæ€»è°ƒç”¨15æ¬¡ï¼Œå¹¶è¿”å›ç­‰å¾…æ—¶é—´ã€‚ç¬¬5æ¬¡acquire()å®Œçš„æ—¶å€™ï¼ŒæŒ‚èµ·2ç§’ã€‚ ä»è¾“å‡ºæ¥çœ‹ï¼Œç¬¬ä¸€æ¬¡å–å¾—ä»¤ç‰Œæ˜¯ä¸ç”¨ç­‰å¾…çš„ã€‚ æŒ‚èµ·2ç§’åï¼Œæ¥ä¸‹æ¥çš„5æ¬¡ä¸ç”¨é˜»å¡ï¼Œå†æ¥ä¸‹æ¥çš„5æ¬¡é™¤äº†ä»¥ç¬¬ä¸€æ¬¡å‘ç”Ÿäº†é˜»å¡(ç¬¬ä¸€æ¬¡)ï¼Œä¹Ÿå°±æ˜¯2ç§’å†…åªå‘äº†5ä¸ªä»¤ç‰Œï¼Œä¸ä¼šç´¯ç§¯ã€‚ ä¸ºä»€ä¹ˆçœ‹èµ·æ¥0ä»¤ç‰Œçš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨é˜»å¡æ—¶é—´éƒ½æ˜¯0å‘¢ï¼Ÿé‚£æ˜¯å› ä¸ºRateLimiterå¯ä»¥é¢„æ¶ˆè´¹ï¼ˆacquire()å®é™…ä¸Šæ˜¯è°ƒç”¨acquire(1), è¿™å’Œè°ƒç”¨acquire(1000) å°†å¾—åˆ°ç›¸åŒçš„é™åˆ¶æ•ˆæœï¼Œå¦‚æœå­˜åœ¨è¿™æ ·çš„è°ƒç”¨çš„è¯ï¼‰ï¼Œä½†ä¼šå½±å“ä¸‹ä¸€æ¬¡è¯·æ±‚çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªé«˜å¼€é”€çš„ä»»åŠ¡æŠµè¾¾ä¸€ä¸ªç©ºé—²çš„RateLimiterï¼Œå®ƒä¼šè¢«é©¬ä¸Šè®¸å¯ï¼Œä½†æ˜¯ä¸‹ä¸€ä¸ªè¯·æ±‚ä¼šç»å†é¢å¤–çš„é™åˆ¶ï¼Œä»è€Œæ¥å¿ä»˜é«˜å¼€é”€ä»»åŠ¡ã€‚ æ­¤å¤–éœ€æ³¨æ„ï¼šRateLimiter å¹¶ä¸æä¾›å…¬å¹³æ€§çš„ä¿è¯ï¼Œæ²¡æœ‰å…ˆæ¥å…ˆå¾—çš„æ¦‚å¿µã€‚ è¿™ä¸ªç±»å…¶å®å®ç°äº†ä»¤ç‰Œä¸è¶³ä¸‹å¤šç§åº”å¯¹ç­–ç•¥ require()å±äºæµé‡æ•´å½¢çš„å®ç° tryRequire()å±äºæœåŠ¡é™æµçš„å®ç° 6. åè®°é™¤æ­¤ä¹‹å¤–ï¼Œnginxä¹Ÿæœ‰é™æµæ¨¡å—ï¼Œä¸€ç§æ˜¯é™åˆ¶è¿æ¥æ•°ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå…·ä½“æ•ˆæœæ²¡å®æˆ˜ã€‚ 7. å‚è€ƒ Leaky bucket","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://htchz.cc/categories/åˆ†å¸ƒå¼/"}],"tags":[{"name":"æœåŠ¡é™æµ","slug":"æœåŠ¡é™æµ","permalink":"https://htchz.cc/tags/æœåŠ¡é™æµ/"}],"author":"åœŸå·"},{"title":"[GolangåŸºç¡€]Goroutineè°ƒåº¦","slug":"GolangåŸºç¡€-Goroutineè°ƒåº¦","date":"2018-09-28T06:48:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"2747343217.html","link":"","permalink":"https://htchz.cc/2747343217.html","excerpt":"æ‘˜æŠ„è‡ªå°ç±³è¿ç»´","text":"æ‘˜æŠ„è‡ªå°ç±³è¿ç»´ 1. å‰è¨€éšç€æœåŠ¡å™¨ç¡¬ä»¶è¿­ä»£å‡çº§ï¼Œé…ç½®ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚ä¸ºå……åˆ†åˆ©ç”¨æœåŠ¡å™¨èµ„æºï¼Œå¹¶å‘ç¼–ç¨‹ä¹Ÿå˜çš„è¶Šæ¥è¶Šé‡è¦ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œéœ€è¦äº†è§£ä¸€ä¸‹å¹¶å‘(concurrency)å’Œå¹¶è¡Œ(parallesim)çš„åŒºåˆ«ã€‚ å¹¶å‘: é€»è¾‘ä¸Šå…·æœ‰å¤„ç†å¤šä¸ªåŒæ—¶æ€§ä»»åŠ¡çš„èƒ½åŠ›ã€‚ å¹¶è¡Œ: ç‰©ç†ä¸ŠåŒä¸€æ—¶åˆ»æ‰§è¡Œå¤šä¸ªå¹¶å‘ä»»åŠ¡ã€‚ é€šå¸¸æ‰€è¯´çš„å¹¶å‘ç¼–ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå…è®¸å¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œä½†å®é™…ä¸Šå¹¶ä¸ä¸€å®šåœ¨åŒä¸€æ—¶åˆ»è¢«æ‰§è¡Œã€‚åœ¨å•æ ¸å¤„ç†å™¨ä¸Šï¼Œé€šè¿‡å¤šçº¿ç¨‹å…±äº«CPUæ—¶é—´ç‰‡ä¸²è¡Œæ‰§è¡Œ(å¹¶å‘éå¹¶è¡Œ)ã€‚è€Œå¹¶è¡Œåˆ™ä¾èµ–äºå¤šæ ¸å¤„ç†å™¨ç­‰ç‰©ç†èµ„æºï¼Œè®©å¤šä¸ªä»»åŠ¡å¯ä»¥å®ç°å¹¶è¡Œæ‰§è¡Œ(å¹¶å‘ä¸”å¹¶è¡Œ)ã€‚ å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹æ˜¯å¹¶è¡Œçš„åŸºæœ¬æ¡ä»¶ï¼Œä½†å•çº¿ç¨‹ä¹Ÿå¯ä»¥ç”¨åç¨‹(coroutine)åšåˆ°å¹¶å‘ã€‚ç®€å•å°†Goroutineå½’çº³ä¸ºåç¨‹å¹¶ä¸åˆé€‚ï¼Œå› ä¸ºå®ƒè¿è¡Œæ—¶ä¼šåˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥æ‰§è¡Œå¹¶å‘ä»»åŠ¡ï¼Œä¸”ä»»åŠ¡å•å…ƒå¯è¢«è°ƒåº¦åˆ°å…¶å®ƒçº¿ç¨‹æ‰§è¡Œã€‚è¿™æ›´åƒæ˜¯å¤šçº¿ç¨‹å’Œåç¨‹çš„ç»“åˆä½“ï¼Œèƒ½æœ€å¤§é™åº¦æå‡æ‰§è¡Œæ•ˆç‡ï¼Œå‘æŒ¥å¤šæ ¸å¤„ç†å™¨èƒ½åŠ›ã€‚ Goç¼–å†™ä¸€ä¸ªå¹¶å‘ç¼–ç¨‹ç¨‹åºå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨å‡½æ•°ä¹‹å‰ä½¿ç”¨ä¸€ä¸ªGoå…³é”®å­—å°±å¯ä»¥å®ç°å¹¶å‘ç¼–ç¨‹ã€‚ 12345func main() &#123; go func()&#123; fmt.Println(\"Hello,World!\") &#125;()&#125; 2. Goè°ƒåº¦å™¨ç»„æˆGoè¯­è¨€è™½ç„¶ä½¿ç”¨ä¸€ä¸ª Go å…³é”®å­—å³å¯å®ç°å¹¶å‘ç¼–ç¨‹ï¼Œä½†Goroutineè¢«è°ƒåº¦åˆ°åç«¯ä¹‹åï¼Œå…·ä½“çš„å®ç°æ¯”è¾ƒå¤æ‚ã€‚å…ˆçœ‹çœ‹è°ƒåº¦å™¨æœ‰å“ªå‡ éƒ¨åˆ†ç»„æˆã€‚ G M P 2.1. GGæ˜¯ Go routineçš„ç¼©å†™ï¼Œç›¸å½“äºæ“ä½œç³»ç»Ÿä¸­çš„è¿›ç¨‹æ§åˆ¶å—ï¼Œåœ¨è¿™é‡Œå°±æ˜¯Goroutineçš„æ§åˆ¶ç»“æ„ï¼Œæ˜¯å¯¹Goroutineçš„æŠ½è±¡ã€‚å…¶ä¸­åŒ…æ‹¬æ‰§è¡Œçš„å‡½æ•°æŒ‡ä»¤åŠå‚æ•°ï¼›Gä¿å­˜çš„ä»»åŠ¡å¯¹è±¡ï¼›çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç°åœºä¿æŠ¤å’Œç°åœºæ¢å¤éœ€è¦çš„å¯„å­˜å™¨(SPã€IP)ç­‰ä¿¡æ¯ã€‚ Goä¸åŒç‰ˆæœ¬Goroutineé»˜è®¤æ ˆå¤§å°ä¸åŒã€‚ 12345678910111213141516171819202122// Go1.11ç‰ˆæœ¬é»˜è®¤stackå¤§å°ä¸º2KB_StackMin = 2048 // åˆ›å»ºä¸€ä¸ªgå¯¹è±¡,ç„¶åæ”¾åˆ°gé˜Ÿåˆ—// ç­‰å¾…è¢«æ‰§è¡Œfunc newproc1(fn *funcval, argp *uint8, narg int32, callergp *g, callerpc uintptr) &#123; _g_ := getg() _g_.m.locks++ siz := narg siz = (siz + 7) &amp;^ 7 _p_ := _g_.m.p.ptr() newg := gfget(_p_) if newg == nil &#123; // åˆå§‹åŒ–g stackå¤§å° newg = malg(_StackMin) casgstatus(newg, _Gidle, _Gdead) allgadd(newg) &#125; // ä»¥ä¸‹çœç•¥&#125; 2.2. MMæ˜¯ä¸€ä¸ªçº¿ç¨‹æˆ–ç§°ä¸ºMachineï¼Œå¯¹åº”æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚æ‰€æœ‰Mæ˜¯æœ‰çº¿ç¨‹æ ˆçš„ã€‚å¦‚æœä¸å¯¹è¯¥çº¿ç¨‹æ ˆæä¾›å†…å­˜çš„è¯ï¼Œç³»ç»Ÿä¼šç»™è¯¥çº¿ç¨‹æ ˆæä¾›å†…å­˜(ä¸åŒæ“ä½œç³»ç»Ÿæä¾›çš„çº¿ç¨‹æ ˆå¤§å°ä¸åŒ)ã€‚å½“æŒ‡å®šäº†çº¿ç¨‹æ ˆï¼Œåˆ™M.stackâ†’G.stackï¼ŒMçš„PCå¯„å­˜å™¨æŒ‡å‘Gæä¾›çš„å‡½æ•°ï¼Œç„¶åå»æ‰§è¡Œã€‚ 1234567891011121314type m struct &#123; /* 1. æ‰€æœ‰è°ƒç”¨æ ˆçš„Goroutine,è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„Goroutineã€‚ 2. æ™®é€šçš„Goroutineæ ˆæ˜¯åœ¨Heapåˆ†é…çš„å¯å¢é•¿çš„stack,è€Œg0çš„stackæ˜¯Må¯¹åº”çš„çº¿ç¨‹æ ˆã€‚ 3. æ‰€æœ‰è°ƒåº¦ç›¸å…³ä»£ç ,ä¼šå…ˆåˆ‡æ¢åˆ°è¯¥Goroutineçš„æ ˆå†æ‰§è¡Œã€‚ */ g0 *g curg *g // Må½“å‰ç»‘å®šçš„ç»“æ„ä½“G // SPã€PCå¯„å­˜å™¨ç”¨äºç°åœºä¿æŠ¤å’Œç°åœºæ¢å¤ vdsoSP uintptr vdsoPC uintptr // çœç•¥â€¦&#125; 2.3. PP(Processor)æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†é™åˆ¶å¹¶å‘ä»»åŠ¡çš„æ•°é‡ï¼Œå¹¶ä¸æ˜¯ç‰©ç†CPUçš„æŠ½è±¡ã€‚æ‰€ä»¥å½“Pæœ‰ä»»åŠ¡æ—¶éœ€è¦åˆ›å»ºæˆ–è€…å”¤é†’ä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹æ¥æ‰§è¡Œå®ƒé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚æ‰€ä»¥P/Méœ€è¦è¿›è¡Œç»‘å®šï¼Œæ„æˆä¸€ä¸ªæ‰§è¡Œå•å…ƒã€‚ På†³å®šäº†åŒæ—¶å¯ä»¥å¹¶å‘ä»»åŠ¡çš„æ•°é‡ï¼Œå¯é€šè¿‡GOMAXPROCSé™åˆ¶åŒæ—¶æ‰§è¡Œç”¨æˆ·çº§ä»»åŠ¡çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚å¯ä»¥é€šè¿‡runtime.GOMAXPROCSè¿›è¡ŒæŒ‡å®šã€‚åœ¨Go1.5ä¹‹åGOMAXPROCSè¢«é»˜è®¤è®¾ç½®å¯ç”¨çš„æ ¸æ•°ï¼Œè€Œä¹‹å‰åˆ™é»˜è®¤ä¸º1ã€‚ 1234567891011121314// è‡ªå®šä¹‰è®¾ç½®GOMAXPROCSæ•°é‡func GOMAXPROCS(n int) int &#123; /* 1. GOMAXPROCSè®¾ç½®å¯æ‰§è¡Œçš„CPUçš„æœ€å¤§æ•°é‡,åŒæ—¶è¿”å›ä¹‹å‰çš„è®¾ç½®ã€‚ 2. å¦‚æœn &lt; 1,åˆ™ä¸æ›´æ”¹å½“å‰çš„å€¼ã€‚ */ ret := int(gomaxprocs) stopTheWorld(\"GOMAXPROCS\") // startTheWorldå¯åŠ¨æ—¶,ä½¿ç”¨newprocsã€‚ newprocs = int32(n) startTheWorld() return ret&#125; 123456789101112131415161718192021222324252627282930313233343536373839// é»˜è®¤Pè¢«ç»‘å®šåˆ°æ‰€æœ‰CPUæ ¸ä¸Š// P == cpu.coresfunc getproccount() int32 &#123; const maxCPUs = 64 * 1024 var buf [maxCPUs / 8]byte // è·å–CPU Core r := sched_getaffinity(0, unsafe.Sizeof(buf), &amp;buf[0]) n := int32(0) for _, v := range buf[:r] &#123; for v != 0 &#123; n += int32(v &amp; 1) v &gt;&gt;= 1 &#125; &#125; if n == 0 &#123; n = 1 &#125; return n&#125;// ä¸€ä¸ªè¿›ç¨‹é»˜è®¤è¢«ç»‘å®šåœ¨æ‰€æœ‰CPUæ ¸ä¸Š,è¿”å›æ‰€æœ‰CPU coreã€‚// è·å–è¿›ç¨‹çš„CPUäº²å’Œæ€§æ©ç ç³»ç»Ÿè°ƒç”¨// rax 204 ; ç³»ç»Ÿè°ƒç”¨ç // system_call sys_sched_getaffinity; ç³»ç»Ÿè°ƒç”¨åç§°// rid pid ; è¿›ç¨‹å·// rsi unsigned int len // rdx unsigned long *user_mask_ptrsys_linux_amd64.s:TEXT runtimeÂ·sched_getaffinity(SB),NOSPLIT,$0 MOVQ pid+0(FP), DI MOVQ len+8(FP), SI MOVQ buf+16(FP), DX MOVL $SYS_sched_getaffinity, AX SYSCALL MOVL AX, ret+24(FP) RET 3. è°ƒåº¦è¿‡ç¨‹é¦–å…ˆåˆ›å»ºä¸€ä¸ªGå¯¹è±¡ï¼ŒGå¯¹è±¡ä¿å­˜åˆ°Pæœ¬åœ°é˜Ÿåˆ—æˆ–è€…æ˜¯å…¨å±€é˜Ÿåˆ—ã€‚Pæ­¤æ—¶å»å”¤é†’ä¸€ä¸ªMã€‚Pç»§ç»­æ‰§è¡Œå®ƒçš„æ‰§è¡Œåºã€‚Må¯»æ‰¾æ˜¯å¦æœ‰ç©ºé—²çš„Pï¼Œå¦‚æœæœ‰åˆ™å°†è¯¥Gå¯¹è±¡ç§»åŠ¨åˆ°å®ƒæœ¬èº«ã€‚æ¥ä¸‹æ¥Mæ‰§è¡Œä¸€ä¸ªè°ƒåº¦å¾ªç¯(è°ƒç”¨Gå¯¹è±¡-&gt;æ‰§è¡Œ-&gt;æ¸…ç†çº¿ç¨‹â†’ç»§ç»­æ‰¾æ–°çš„Goroutineæ‰§è¡Œ)ã€‚ Mæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéšæ—¶ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚å½“å‘ç”Ÿä¸Šçº¿æ–‡åˆ‡æ¢æ—¶ï¼Œéœ€è¦å¯¹æ‰§è¡Œç°åœºè¿›è¡Œä¿æŠ¤ï¼Œä»¥ä¾¿ä¸‹æ¬¡è¢«è°ƒåº¦æ‰§è¡Œæ—¶è¿›è¡Œç°åœºæ¢å¤ã€‚Goè°ƒåº¦å™¨Mçš„æ ˆä¿å­˜åœ¨Gå¯¹è±¡ä¸Šï¼Œåªéœ€è¦å°†Mæ‰€éœ€è¦çš„å¯„å­˜å™¨(SPã€PCç­‰)ä¿å­˜åˆ°Gå¯¹è±¡ä¸Šå°±å¯ä»¥å®ç°ç°åœºä¿æŠ¤ã€‚å½“è¿™äº›å¯„å­˜å™¨æ•°æ®è¢«ä¿æŠ¤èµ·æ¥ï¼Œå°±éšæ—¶å¯ä»¥åšä¸Šä¸‹æ–‡åˆ‡æ¢äº†ï¼Œåœ¨ä¸­æ–­ä¹‹å‰æŠŠç°åœºä¿å­˜èµ·æ¥ã€‚å¦‚æœæ­¤æ—¶Gä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼ŒMå¯ä»¥å°†ä»»åŠ¡é‡æ–°ä¸¢åˆ°Pçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«è°ƒåº¦æ‰§è¡Œã€‚å½“å†æ¬¡è¢«è°ƒåº¦æ‰§è¡Œæ—¶ï¼ŒMé€šè¿‡è®¿é—®Gçš„vdsoSPã€vdsoPCå¯„å­˜å™¨è¿›è¡Œç°åœºæ¢å¤(ä»ä¸Šæ¬¡ä¸­æ–­ä½ç½®ç»§ç»­æ‰§è¡Œ)ã€‚ å½“Mä»é˜Ÿåˆ—ä¸­æ‹¿åˆ°ä¸€ä¸ªå¯æ‰§è¡Œçš„Gåï¼Œé¦–å…ˆä¼šå»æ£€æŸ¥ä¸€ä¸‹Pé˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰ç­‰å¾…çš„Gï¼Œå¦‚æœè¿˜æœ‰ç­‰å¾…çš„Gï¼Œå¹¶ä¸”ä¹Ÿè¿˜æœ‰ç©ºé—²çš„Pï¼Œæ­¤æ—¶å°±ä¼šé€šçŸ¥runtimeåˆ†é…ä¸€ä¸ªæ–°çš„Mï¼ˆå¦‚æœæœ‰åœ¨ç¡è§‰çš„OSçº¿ç¨‹ï¼Œåˆ™ç›´æ¥å”¤é†’å®ƒï¼Œæ²¡æœ‰çš„è¯åˆ™ç”Ÿæˆä¸€ä¸ªæ–°çš„OSçº¿ç¨‹ï¼‰æ¥åˆ†æ‹…ä»»åŠ¡ã€‚ å¦‚æœæŸä¸ªMå‘ç°é˜Ÿåˆ—ä¸ºç©ºä¹‹åï¼Œä¼šé¦–å…ˆä»å…¨å±€é˜Ÿåˆ—ä¸­å–ä¸€ä¸ªGæ¥å¤„ç†ã€‚å¦‚æœå…¨å±€é˜Ÿåˆ—ä¹Ÿç©ºäº†ï¼Œåˆ™ä¼šéšæœºä»åˆ«çš„Pé‚£é‡Œç›´æ¥æˆªå–ä¸€åŠçš„é˜Ÿåˆ—è¿‡æ¥ï¼ˆå·çªƒä»»åŠ¡ï¼‰ï¼Œå¦‚æœå‘ç°æ‰€æœ‰çš„Péƒ½æ²¡æœ‰å¯ä¾›å·çªƒçš„Gäº†ï¼Œè¯¥Må°±ä¼šé™·å…¥æ²‰ç¡ã€‚ è¿™ç§åä½œè°ƒåº¦å›å¯¼è‡´å…¨å‰§é˜Ÿåˆ—ä¼šå“åº”å¾—æ…¢ä¸€ä¸¢ä¸¢ï¼Œä½†æ˜¯åœ¨æ€»ä½“ä¸Šè¿™ç§è°ƒåº¦å°†å¤„ç†å™¨çš„æœºå™¨æ€§èƒ½å……åˆ†å‘æŒ¥ã€‚ 3.1. P é˜Ÿåˆ—é€šè¿‡ä¸Šå›¾å¯ä»¥å‘ç°ï¼ŒPæœ‰ä¸¤ç§é˜Ÿåˆ—ï¼šæœ¬åœ°é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—ã€‚ æœ¬åœ°é˜Ÿåˆ—ï¼š å½“å‰Pçš„é˜Ÿåˆ—ï¼Œæœ¬åœ°é˜Ÿåˆ—æ˜¯Lock-Freeï¼Œæ²¡æœ‰æ•°æ®ç«äº‰é—®é¢˜ï¼Œæ— éœ€åŠ é”å¤„ç†ï¼Œå¯ä»¥æå‡å¤„ç†é€Ÿåº¦ã€‚ å…¨å±€é˜Ÿåˆ—ï¼š å…¨å±€é˜Ÿåˆ—ä¸ºäº†ä¿è¯å¤šä¸ªPä¹‹é—´ä»»åŠ¡çš„å¹³è¡¡ã€‚æ‰€æœ‰Må…±äº«På…¨å±€é˜Ÿåˆ—ï¼Œä¸ºä¿è¯æ•°æ®ç«äº‰é—®é¢˜ï¼Œéœ€è¦åŠ é”å¤„ç†ã€‚ç›¸æ¯”æœ¬åœ°é˜Ÿåˆ—å¤„ç†é€Ÿåº¦è¦ä½äºå…¨å±€é˜Ÿåˆ—ã€‚ 3.2. ä¸Šçº¿æ–‡åˆ‡æ¢ç®€å•ç†è§£ä¸ºå½“æ—¶çš„ç¯å¢ƒå³å¯ï¼Œç¯å¢ƒå¯ä»¥åŒ…æ‹¬å½“æ—¶ç¨‹åºçŠ¶æ€ä»¥åŠå˜é‡çŠ¶æ€ã€‚ä¾‹å¦‚çº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™åœ¨å†…æ ¸ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™é‡Œçš„ä¸Šä¸‹æ–‡å°±åŒ…æ‹¬äº†å½“æ—¶å¯„å­˜å™¨çš„å€¼ï¼ŒæŠŠå¯„å­˜å™¨çš„å€¼ä¿å­˜èµ·æ¥ï¼Œç­‰ä¸‹æ¬¡è¯¥çº¿ç¨‹åˆå¾—åˆ°cpuæ—¶é—´çš„æ—¶å€™å†æ¢å¤å¯„å­˜å™¨çš„å€¼ï¼Œè¿™æ ·çº¿ç¨‹æ‰èƒ½æ­£ç¡®è¿è¡Œã€‚ å¯¹äºä»£ç ä¸­æŸä¸ªå€¼è¯´ï¼Œä¸Šä¸‹æ–‡æ˜¯æŒ‡è¿™ä¸ªå€¼æ‰€åœ¨çš„å±€éƒ¨(å…¨å±€)ä½œç”¨åŸŸå¯¹è±¡ã€‚ç›¸å¯¹äºè¿›ç¨‹è€Œè¨€ï¼Œä¸Šä¸‹æ–‡å°±æ˜¯è¿›ç¨‹æ‰§è¡Œæ—¶çš„ç¯å¢ƒï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å„ä¸ªå˜é‡å’Œæ•°æ®ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„å¯„å­˜å™¨å˜é‡ã€è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ã€å†…å­˜(å †æ ˆ)ä¿¡æ¯ç­‰ã€‚ 3.3. çº¿ç¨‹æ¸…ç†Goroutineè¢«è°ƒåº¦æ‰§è¡Œå¿…é¡»ä¿è¯P/Mè¿›è¡Œç»‘å®šï¼Œæ‰€ä»¥çº¿ç¨‹æ¸…ç†åªéœ€è¦å°†Pé‡Šæ”¾å°±å¯ä»¥å®ç°çº¿ç¨‹çš„æ¸…ç†ã€‚ä»€ä¹ˆæ—¶å€™Pä¼šé‡Šæ”¾ï¼Œä¿è¯å…¶å®ƒGå¯ä»¥è¢«æ‰§è¡Œã€‚Pè¢«é‡Šæ”¾ä¸»è¦æœ‰ä¸¤ç§æƒ…å†µã€‚ ä¸»åŠ¨é‡Šæ”¾ï¼š æœ€å…¸å‹çš„ä¾‹å­æ˜¯ï¼Œå½“æ‰§è¡ŒGä»»åŠ¡æ—¶æœ‰ç³»ç»Ÿè°ƒç”¨ï¼Œå½“å‘ç”Ÿç³»ç»Ÿè°ƒç”¨æ—¶Mä¼šå¤„äºBlockçŠ¶æ€ã€‚è°ƒåº¦å™¨ä¼šè®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå½“è¶…æ—¶æ—¶ä¼šå°†Pé‡Šæ”¾ã€‚ è¢«åŠ¨é‡Šæ”¾ï¼š å¦‚æœå‘ç”Ÿç³»ç»Ÿè°ƒç”¨ï¼Œæœ‰ä¸€ä¸ªä¸“é—¨ç›‘æ§ç¨‹åºï¼Œè¿›è¡Œæ‰«æå½“å‰å¤„äºé˜»å¡çš„P/Mç»„åˆã€‚å½“è¶…è¿‡ç³»ç»Ÿç¨‹åºè®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œä¼šè‡ªåŠ¨å°†Pèµ„æºæŠ¢èµ°ã€‚å»æ‰§è¡Œé˜Ÿåˆ—çš„å…¶å®ƒGä»»åŠ¡ã€‚","categories":[{"name":"GolangåŸºç¡€","slug":"GolangåŸºç¡€","permalink":"https://htchz.cc/categories/GolangåŸºç¡€/"}],"tags":[{"name":"goroutine","slug":"goroutine","permalink":"https://htchz.cc/tags/goroutine/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]ForkJoinPool","slug":"JavaåŸºç¡€-ForkJoinPool","date":"2018-09-20T09:01:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"2843017067.html","link":"","permalink":"https://htchz.cc/2843017067.html","excerpt":"jdk8çš„parallerStreamçš„å®ç°ä¾èµ–è¿™ç§çº¿ç¨‹æ± ã€‚è¿™ä¸ªç±»å¸¦ä¸Šæ³¨é‡Š3478è¡Œï¼Œè¡¨ç¤ºå¾ˆæ…Œã€‚","text":"jdk8çš„parallerStreamçš„å®ç°ä¾èµ–è¿™ç§çº¿ç¨‹æ± ã€‚è¿™ä¸ªç±»å¸¦ä¸Šæ³¨é‡Š3478è¡Œï¼Œè¡¨ç¤ºå¾ˆæ…Œã€‚ 1. å‰è¨€è®¾è®¡è¿™ä¸ªçº¿ç¨‹æ± çš„åŸå› ä¸æ˜¯ä¸ºäº†å–ä»£ThreadPoolExecutorï¼ŒForkJoinPool æœ€é€‚åˆçš„æ˜¯è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œå¦‚æœå­˜åœ¨ I/Oï¼Œçº¿ç¨‹é—´åŒæ­¥ï¼Œsleep() ç­‰ä¼šé€ æˆçº¿ç¨‹é•¿æ—¶é—´é˜»å¡çš„æƒ…å†µæ—¶ï¼Œæœ€å¥½é…åˆä½¿ç”¨ ManagedBlockerã€‚ 2. ä½¿ç”¨ä¾‹å­æ ¸å¿ƒæ€æƒ³å°±æ˜¯æ‹†åˆ†ä»»åŠ¡ï¼Œè¿™å¾ˆå¿«æ’çš„åŸç†æ˜¯ä¸€æ ·çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889package com.htc.learning.main;import java.util.concurrent.ForkJoinPool;import java.util.concurrent.RecursiveAction;import java.util.concurrent.RecursiveTask;import java.util.stream.LongStream;public class ForkJoinPoolTest &#123; public static void main(String[] args) &#123; long[] numbers = LongStream.rangeClosed(1, 100).toArray(); fork(numbers); forkAndJoin(numbers); &#125; private static void fork(long[] numbers) &#123; ForkJoinPool pool = ForkJoinPool.commonPool(); pool.invoke(new PrintTask(0, numbers.length -1 , numbers)); &#125; private static void forkAndJoin(long[] numbers) &#123; ForkJoinPool pool = ForkJoinPool.commonPool(); long sum = pool.invoke(new SumTask(0, numbers.length - 1, numbers)); System.out.println(\"sum is :\" + sum); &#125;&#125;// è¿™æ˜¯æ²¡æœ‰joinç»“æœçš„class PrintTask extends RecursiveAction &#123; // å°ä»»åŠ¡çš„æ‰“å°é‡ private static final int THRESHOLD = 10; private int start; private int end; private long[] list; public PrintTask(int start, int end, long[] List) &#123; this.start = start; this.end = end; this.list = List; &#125; @Override protected void compute() &#123; if (end - start &lt; THRESHOLD) &#123; for (int i = start; i &lt;= end; i++) &#123; System.out.print(list[i] + \",\"); &#125; System.out.println(); &#125; else &#123; int middle = (start + end) / 2; PrintTask leftTask = new PrintTask(start, middle, list); PrintTask rightTask = new PrintTask(middle + 1, end, list); leftTask.fork(); rightTask.fork(); &#125; &#125;&#125;// è¿™æ˜¯joinç»“æœçš„class SumTask extends RecursiveTask&lt;Long&gt; &#123; // å°ä»»åŠ¡çš„è®¡ç®—é‡ private static final int THRESHOLD = 10; private int start; private int end; private long[] list; public SumTask(int start, int end, long[] list) &#123; this.start = start; this.end = end; this.list = list; &#125; @Override protected Long compute() &#123; if (end - start &lt; THRESHOLD) &#123; long sum = 0; for (int i = start; i &lt;= end; i++) &#123; sum += list[i]; &#125; return sum; &#125; else &#123; int middle = (start + end) / 2; SumTask leftTask = new SumTask(start, middle, list); SumTask rightTask = new SumTask(middle + 1, end, list); leftTask.fork(); rightTask.fork(); return leftTask.join() + rightTask.join(); &#125; &#125;&#125; è¿è¡Œç»“æœ ç»“æœå¾ˆä¹±ï¼Œå¯ä»¥çœ‹å‡ºfork()æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœä½¿ç”¨join()é˜»å¡çš„è¯ï¼Œå¯ä»¥å°†è®¡ç®—å˜ä¸ºåŒæ­¥ã€‚ 3. åŸç†è€æçš„è®ºæ–‡ åˆ†æ²»ã€‚è¿™ä¸ªä»ä½¿ç”¨æ–¹å¼å°±å¯ä»¥çœ‹å‡ºæ¥ã€‚ å·¥ä½œçªƒå–ï¼ˆwork-stealingï¼‰ã€‚ æ¯ä¸ªå·¥ä½œé˜Ÿåˆ—ä¸€ä¸ªçº¿ç¨‹ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨å·¥ä½œçªƒå–ç®—æ³•å‘¢ï¼Ÿå‡å¦‚æˆ‘ä»¬éœ€è¦åšä¸€ä¸ªæ¯”è¾ƒå¤§çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªä»»åŠ¡åˆ†å‰²ä¸ºè‹¥å¹²äº’ä¸ä¾èµ–çš„å­ä»»åŠ¡ï¼Œä¸ºäº†å‡å°‘çº¿ç¨‹é—´çš„ç«äº‰ï¼Œäºæ˜¯æŠŠè¿™äº›å­ä»»åŠ¡åˆ†åˆ«æ”¾åˆ°ä¸åŒçš„é˜Ÿåˆ—é‡Œï¼Œå¹¶ä¸ºæ¯ä¸ªé˜Ÿåˆ—åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œçº¿ç¨‹å’Œé˜Ÿåˆ—ä¸€ä¸€å¯¹åº”ï¼Œæ¯”å¦‚Açº¿ç¨‹è´Ÿè´£å¤„ç†Aé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯æœ‰çš„çº¿ç¨‹ä¼šå…ˆæŠŠè‡ªå·±é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¹²å®Œï¼Œè€Œå…¶ä»–çº¿ç¨‹å¯¹åº”çš„é˜Ÿåˆ—é‡Œè¿˜æœ‰ä»»åŠ¡ç­‰å¾…å¤„ç†ã€‚å¹²å®Œæ´»çš„çº¿ç¨‹ä¸å…¶ç­‰ç€ï¼Œä¸å¦‚å»å¸®å…¶ä»–çº¿ç¨‹å¹²æ´»ï¼Œäºæ˜¯å®ƒå°±å»å…¶ä»–çº¿ç¨‹çš„é˜Ÿåˆ—é‡Œçªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚è€Œåœ¨è¿™æ—¶å®ƒä»¬ä¼šè®¿é—®åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ºäº†å‡å°‘çªƒå–ä»»åŠ¡çº¿ç¨‹å’Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œé€šå¸¸ä¼šä½¿ç”¨åŒç«¯é˜Ÿåˆ—ï¼Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–ä»»åŠ¡çš„çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œã€‚ å·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹æ˜¯å……åˆ†åˆ©ç”¨çº¿ç¨‹è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œå¹¶å‡å°‘äº†çº¿ç¨‹é—´çš„ç«äº‰ï¼Œå…¶ç¼ºç‚¹æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹è¿˜æ˜¯å­˜åœ¨ç«äº‰ï¼Œæ¯”å¦‚åŒç«¯é˜Ÿåˆ—é‡Œåªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶ã€‚å¹¶ä¸”æ¶ˆè€—äº†æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚åˆ›å»ºå¤šä¸ªçº¿ç¨‹å’Œå¤šä¸ªåŒç«¯é˜Ÿåˆ—ã€‚ æ®è¯´ForkJoinPoolåœ¨jdk7å’Œjdk8çš„å®ç°ä¸ä¸€æ ·ã€‚ç°åœ¨æ˜¯jdk8çš„æ—¶ä»£ï¼Œæˆ‘æš‚æ—¶ä¸å»çœ‹jdk7çš„å®ç°å•¦ã€‚ ForkJoinPool çš„æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼ˆWorkQueueï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼ˆDequeï¼‰ï¼Œé‡Œé¢å­˜æ”¾çš„å¯¹è±¡æ˜¯ä»»åŠ¡ï¼ˆForkJoinTaskï¼‰ã€‚ æ¯ä¸ªå·¥ä½œçº¿ç¨‹åœ¨è¿è¡Œä¸­äº§ç”Ÿæ–°çš„ä»»åŠ¡ï¼ˆé€šå¸¸æ˜¯å› ä¸ºè°ƒç”¨äº† fork()ï¼‰æ—¶ï¼Œä¼šæ”¾å…¥å·¥ä½œé˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ LIFO æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ä»é˜Ÿå°¾å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚ æ¯ä¸ªå·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—åŒæ—¶ï¼Œä¼šå°è¯•çªƒå–ä¸€ä¸ªä»»åŠ¡ï¼ˆæˆ–æ˜¯æ¥è‡ªäºåˆšåˆšæäº¤åˆ° pool çš„ä»»åŠ¡ï¼Œæˆ–æ˜¯æ¥è‡ªäºå…¶ä»–å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ï¼‰ï¼Œçªƒå–çš„ä»»åŠ¡ä½äºå…¶ä»–çº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—çš„é˜Ÿé¦–ï¼Œä¹Ÿå°±æ˜¯è¯´å·¥ä½œçº¿ç¨‹åœ¨çªƒå–å…¶ä»–å·¥ä½œçº¿ç¨‹çš„ä»»åŠ¡æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ FIFO æ–¹å¼ã€‚ åœ¨é‡åˆ° join() æ—¶ï¼Œå¦‚æœéœ€è¦ join çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œåˆ™ä¼šå…ˆå¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…å…¶å®Œæˆã€‚ï¼ˆå…¶å®æˆ‘ä¸ç†è§£è¿™å¥è¯ï¼Œä»€ä¹ˆå«é‡åˆ°join()æ—¶ï¼‰ åœ¨æ—¢æ²¡æœ‰è‡ªå·±çš„ä»»åŠ¡ï¼Œä¹Ÿæ²¡æœ‰å¯ä»¥çªƒå–çš„ä»»åŠ¡æ—¶ï¼Œè¿›å…¥ä¼‘çœ ã€‚ é‚£ä¹ˆfork()æ¯æ¬¡è°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å—ï¼Œç­”æ¡ˆå¹¶ä¸æ˜¯ï¼Œå¯¹äºForkJoinPoolæ„é€ å‡½æ•°ç»™å‡ºçº¿ç¨‹æ•°å°±åˆ›å»ºå¤šå°‘çº¿ç¨‹ã€‚é‚£ä¹ˆjoin()ä¹Ÿä¼šé˜»å¡å—ï¼Œä¸ä¸€å®šï¼Œå…·ä½“æˆ‘ä»¬åé¢çœ‹æºç å®ç°ã€‚ 4. æ¦‚å¿µ ForkJoinPool: ç”¨äºæ‰§è¡ŒForkJoinTaskä»»åŠ¡çš„æ‰§è¡Œæ± ,ä¸å†æ˜¯ä¼ ç»Ÿæ‰§è¡Œæ±  Worker+Queue çš„ç»„åˆæ¨¡å¼,è€Œæ˜¯ç»´æŠ¤äº†ä¸€ä¸ªé˜Ÿåˆ—æ•°ç»„WorkQueue,è¿™æ ·åœ¨æäº¤ä»»åŠ¡å’Œçº¿ç¨‹ä»»åŠ¡çš„æ—¶å€™å¤§å¹…åº¦çš„å‡å°‘ç¢°æ’ã€‚] WorkQueue: åŒå‘åˆ—è¡¨,ç”¨äºä»»åŠ¡çš„æœ‰åºæ‰§è¡Œ,å¦‚æœWorkQueueç”¨äºè‡ªå·±çš„æ‰§è¡Œçº¿ç¨‹Thread,çº¿ç¨‹é»˜è®¤å°†ä¼šä»topç«¯é€‰å–ä»»åŠ¡ç”¨æ¥æ‰§è¡Œ - LIFOã€‚å› ä¸ºåªæœ‰ownerçš„Threadæ‰èƒ½ä»topç«¯å–ä»»åŠ¡,æ‰€ä»¥åœ¨è®¾ç½®å˜é‡æ—¶, int top; ä¸éœ€è¦ä½¿ç”¨ volatileã€‚ ForkJoinWorkThread: ç”¨äºæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹,ç”¨äºåŒºåˆ«ä½¿ç”¨éForkJoinWorkThreadçº¿ç¨‹æäº¤çš„task;å¯åŠ¨ä¸€ä¸ªè¯¥Thread,ä¼šè‡ªåŠ¨æ³¨å†Œä¸€ä¸ªWorkQueueåˆ°Pool,è¿™é‡Œè§„å®š,æ‹¥æœ‰Threadçš„WorkQueueåªèƒ½å‡ºç°åœ¨WorkQueueæ•°ç»„çš„å¥‡æ•°ä½ ForkJoinTask: ä»»åŠ¡, å®ƒæ¯”ä¼ ç»Ÿçš„ä»»åŠ¡æ›´åŠ è½»é‡ï¼Œä¸å†å¯¹æ˜¯RUNNABLEçš„å­ç±»,æä¾›fork/joinæ–¹æ³•ç”¨äºåˆ†å‰²ä»»åŠ¡ä»¥åŠèšåˆç»“æœã€‚ ä¸ºäº†å……åˆ†æ–½å±•å¹¶è¡Œè¿ç®—,è¯¥æ¡†æ¶å®ç°äº†å¤æ‚çš„ worker stealç®—æ³•,å½“ä»»åŠ¡å¤„äºç­‰å¾…ä¸­,threadé€šè¿‡ä¸€å®šç­–ç•¥,ä¸è®©è‡ªå·±æŒ‚èµ·ï¼Œå……åˆ†åˆ©ç”¨èµ„æºï¼Œå½“ç„¶ï¼Œå®ƒæ¯”å…¶ä»–è¯­è¨€çš„åç¨‹è¦é‡ä¸€äº›ã€‚ 5. sun.misc.Contendedæ‰“å¼€ForkJoinPoolï¼Œç¬¬ä¸€è¡Œå°±æ˜¯è¿™ä¹ˆä¸ªæ³¨è§£ï¼š 12@sun.misc.Contendedpublic class ForkJoinPool extends AbstractExecutorService &#123;...&#125; åº¦å¨˜ä¸€ä¸‹ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå«ç¼“å­˜è¡Œçš„ä¸œè¥¿ï¼Œè¿™ä¸ªæ³¨è§£å°±æ˜¯ä¸ºäº†è§£å†³ç¼“å­˜è¡Œçš„ä¼ªå…±äº«False Sharing ç¼“å­˜ç³»ç»Ÿä¸­æ˜¯ä»¥ç¼“å­˜è¡Œï¼ˆcache lineï¼‰ä¸ºå•ä½å­˜å‚¨çš„ã€‚ç¼“å­˜è¡Œæ˜¯2çš„æ•´æ•°å¹‚ä¸ªè¿ç»­å­—èŠ‚ï¼Œä¸€èˆ¬ä¸º32-256ä¸ªå­—èŠ‚ã€‚æœ€å¸¸è§çš„ç¼“å­˜è¡Œå¤§å°æ˜¯64ä¸ªå­—èŠ‚ã€‚å½“å¤šçº¿ç¨‹ä¿®æ”¹äº’ç›¸ç‹¬ç«‹çš„å˜é‡æ—¶ï¼Œå¦‚æœè¿™äº›å˜é‡å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œå°±ä¼šæ— æ„ä¸­å½±å“å½¼æ­¤çš„æ€§èƒ½ï¼Œè¿™å°±æ˜¯ä¼ªå…±äº«ã€‚ç¼“å­˜è¡Œä¸Šçš„å†™ç«äº‰æ˜¯è¿è¡Œåœ¨SMPç³»ç»Ÿä¸­å¹¶è¡Œçº¿ç¨‹å®ç°å¯ä¼¸ç¼©æ€§æœ€é‡è¦çš„é™åˆ¶å› ç´ ã€‚æœ‰äººå°†ä¼ªå…±äº«æè¿°æˆæ— å£°çš„æ€§èƒ½æ€æ‰‹ï¼Œå› ä¸ºä»ä»£ç ä¸­å¾ˆéš¾çœ‹æ¸…æ¥šæ˜¯å¦ä¼šå‡ºç°ä¼ªå…±äº«ã€‚ çœ‹å›¾ï¼šåœ¨ç¼“å­˜è¡ŒL3 Cacheé‡Œæœ‰xï¼Œyï¼Œçº¿ç¨‹1æƒ³å»ä¿®æ”¹xï¼Œçº¿ç¨‹2æƒ³å»ä¿®æ”¹yï¼Œé‚£ä¹ˆè¿™è¡Œç¼“å­˜è¡Œå°±ä¼šç§°è°“ç«äº‰å¯¹è±¡ï¼Œç«äº‰çš„è¿‡ç¨‹å°±ä¼šäº§ç”Ÿæ€§èƒ½çš„æŸè€—ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667public class FalseSharing implements Runnable &#123; public final static int NUM_THREADS = 4; // change public final static long ITERATIONS = 500L * 1000L * 1000L; private final int arrayIndex; // è¿™é‡Œåˆ†åˆ«æ¢æˆä¸åŒçš„ç±»çš„æ•°ç»„ï¼Œä½¿ç”¨æ•°ç»„æ˜¯ä¸ºäº†å†…å­˜è¿ç»­ private static VolatileLong3[] longs = new VolatileLong3[NUM_THREADS]; static &#123; for (int i = 0; i &lt; longs.length; i++) &#123; longs[i] = new VolatileLong3(); &#125; &#125; public FalseSharing(final int arrayIndex) &#123; this.arrayIndex = arrayIndex; &#125; public static void main(final String[] args) throws Exception &#123; long start = System.nanoTime(); runTest(); System.out.println(\"duration = \" + (System.nanoTime() - start)); &#125; private static void runTest() throws InterruptedException &#123; Thread[] threads = new Thread[NUM_THREADS]; for (int i = 0; i &lt; threads.length; i++) &#123; threads[i] = new Thread(new FalseSharing(i)); &#125; for (Thread t : threads) &#123; t.start(); &#125; for (Thread t : threads) &#123; t.join(); &#125; &#125; public void run() &#123; long i = ITERATIONS + 1; while (0 != --i) &#123; longs[arrayIndex].value = i; &#125; &#125; public final static class VolatileLong &#123; public volatile long value = 0L; &#125; // long paddingé¿å…false sharing // æŒ‰ç†è¯´jdk7ä»¥ålong paddingåº”è¯¥è¢«ä¼˜åŒ–æ‰äº†ï¼Œä½†æ˜¯ä»æµ‹è¯•ç»“æœçœ‹paddingä»ç„¶èµ·ä½œç”¨ public final static class VolatileLong2 &#123; volatile long p0, p1, p2, p3, p4, p5, p6; public volatile long value = 0L; volatile long q0, q1, q2, q3, q4, q5, q6; &#125; // jdk8æ–°ç‰¹æ€§ï¼ŒContendedæ³¨è§£é¿å…false sharing // Restricted on user classpath // Unlock: -XX:-RestrictContended @sun.misc.Contended public final static class VolatileLong3 &#123; public volatile long value = 0L; &#125; &#125; æ›¿æ¢ä¸‰ç§å£°æ˜ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ VolatileLong: duration = 31605817365 VolatileLong2:duration = 3725651254 VolatileLong3:duration = 3762335746VolatileLong2çš„åŸç†ï¼šç¼“å†²è¡Œæœ‰64å­—èŠ‚ï¼Œé‚£ä¹ˆåœ¨å±æ€§valueå‰é¢æ’åˆ—7ä¸ªlongï¼Œåé¢æ’åˆ—7ä¸ªlongï¼Œæ”¾åˆ°å†…å­˜çš„æ—¶å€™ï¼Œvalueæ— è®ºå¦‚ä½•éƒ½ä¼šå’Œå‘¨å›´çš„longæˆå‘˜ç»„æˆä¸€ä¸ª8ä¸ªlongï¼Œå³64å­—èŠ‚ï¼Œä»è€Œé¿å…ç¼“å­˜è¡Œçš„ç«äº‰ã€‚ è€Œjdk8æä¾›äº†@sun.misc.Contendedæ³¨è§£åå°±ä¸ç”¨å†™çš„è¿™ä¹ˆéº»çƒ¦äº†(ä¹Ÿæ˜¯å¡«å……äº†å­—èŠ‚ï¼Œå…·ä½“çœ‹Java8ä½¿ç”¨@sun.misc.Contendedé¿å…ä¼ªå…±äº«)ã€‚ 6. åŸºæœ¬è¯´æ˜6.1. ForkJoinPoolForkJoinPoolæœ‰è¶…å¤šçš„å¸¸é‡,ä¸‹é¢æ˜¯ä¸€éƒ¨åˆ† 123456789101112131415161718192021222324252627282930313233343536373839404142434445/* * Bits and masks for field ctl, packed with 4 16 bit subfields: * AC: Number of active running workers minus target parallelism * TC: Number of total workers minus target parallelism * SS: version count and status of top waiting thread * ID: poolIndex of top of Treiber stack of waiters * * When convenient, we can extract the lower 32 stack top bits * (including version bits) as sp=(int)ctl. The offsets of counts * by the target parallelism and the positionings of fields makes * it possible to perform the most common checks via sign tests of * fields: When ac is negative, there are not enough active * workers, when tc is negative, there are not enough total * workers. When sp is non-zero, there are waiting workers. To * deal with possibly negative fields, we use casts in and out of * \"short\" and/or signed shifts to maintain signedness. * * Because it occupies uppermost bits, we can add one active count * using getAndAddLong of AC_UNIT, rather than CAS, when returning * from a blocked join. Other updates entail multiple subfields * and masking, requiring CAS. */ // Lower and upper word masksprivate static final long SP_MASK = 0xffffffffL;private static final long UC_MASK = ~SP_MASK;// Active countsprivate static final int AC_SHIFT = 48;private static final long AC_UNIT = 0x0001L &lt;&lt; AC_SHIFT;private static final long AC_MASK = 0xffffL &lt;&lt; AC_SHIFT;// Total countsprivate static final int TC_SHIFT = 32;private static final long TC_UNIT = 0x0001L &lt;&lt; TC_SHIFT;private static final long TC_MASK = 0xffffL &lt;&lt; TC_SHIFT;private static final long ADD_WORKER = 0x0001L &lt;&lt; (TC_SHIFT + 15); // sign// runState bits: SHUTDOWN must be negative, others arbitrary powers of twoprivate static final int RSLOCK = 1;private static final int RSIGNAL = 1 &lt;&lt; 1;private static final int STARTED = 1 &lt;&lt; 2;private static final int STOP = 1 &lt;&lt; 29;private static final int TERMINATED = 1 &lt;&lt; 30;private static final int SHUTDOWN = 1 &lt;&lt; 31; runstateï¼šå¦‚æœæ‰§è¡Œ runState &amp; RSLOCK ==0 å°±èƒ½ç›´æ¥è¯´æ˜,ç›®å‰çš„è¿è¡ŒçŠ¶æ€æ²¡æœ‰è¢«é”ä½,å…¶ä»–æƒ…å†µä¸€æ ·ã€‚ configï¼šparallelismï¼Œ modeã€‚parallelismæ˜¯æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œè¡¨ç¤ºå¹¶è¡Œç­‰çº§ï¼Œä¸ç­‰äºå·¥ä½œé˜Ÿåˆ—çš„æ•°é‡ã€‚éœ€è¦æ³¨æ„ä¸€ä¸‹å®ƒçš„ç•Œé™ï¼Œæœ€å¤§æ˜¯0x7fffã€‚ 1static final int MAX_CAP = 0x7fff; // max #workers - 1 ctlï¼šctlæ˜¯Poolçš„çŠ¶æ€å˜é‡,ç±»å‹æ˜¯long - è¯´æ˜æœ‰64ä½,æ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰ä¸åŒçš„ä½œç”¨ã€‚æˆ‘ä»¬ä½¿ç”¨åå…­è¿›åˆ¶æ¥æ ‡è¯†ctlï¼Œä¾æ¬¡è¯´æ˜ä¸åŒéƒ¨åˆ†çš„ä½œç”¨ã€‚ï¼ˆè¿™å’Œæ™®é€šçº¿ç¨‹æ± ä¸€æ ·ï¼‰ ä»¥ä¸‹æ˜¯æ„é€ å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°ctlçš„åˆå§‹åŒ–ï¼Œæˆ‘ä»¬æŠŠctlæ ‡è¯†ä¸º4éƒ¨åˆ†ï¼Œ0x xxxx-1 xxxx-2 xxxx-3 xxxx-4 1234567891011121314151617/** * Creates a &#123;@code ForkJoinPool&#125; with the given parameters, without * any security checks or parameter validation. Invoked directly by * makeCommonPool. */private ForkJoinPool(int parallelism, ForkJoinWorkerThreadFactory factory, UncaughtExceptionHandler handler, int mode, String workerNamePrefix) &#123; this.workerNamePrefix = workerNamePrefix; this.factory = factory; this.ueh = handler; this.config = (parallelism &amp; SMASK) | mode; long np = (long)(-parallelism); // offset ctl counts this.ctl = ((np &lt;&lt; AC_SHIFT) &amp; AC_MASK) | ((np &lt;&lt; TC_SHIFT) &amp; TC_MASK);&#125; 1å·16ä½ï¼Œè¡¨ç¤ºAC(Active counts)å¹¶è¡Œæ•°çš„è´Ÿæ•°ã€‚å½“ctlå˜æˆæ­£æ•°çš„æ—¶å€™è¡¨ç¤ºçº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼äº†ã€‚(ä¸ºä»€ä¹ˆä¸èƒ½ç”¨æ­£æ•°ï¼Œç„¶åè´Ÿæ•°çš„æ—¶å€™å°±è¡¨ç¤ºè¾¾åˆ°é˜ˆå€¼ï¼Ÿï¼Ÿ) 2å·16ä½ï¼Œè¡¨ç¤ºTC(Total counts)å¹¶è¡Œæ•°ã€‚Total countsç­‰äºæŒ‚èµ·çš„çº¿ç¨‹æ•°+ACï¼Œ(ä¹Ÿæ˜¯ç”¨è´Ÿæ•°è¡¨ç¤º) 3å·16ä½ï¼Œè¡¨ç¤ºSSï¼Œå32ä½æ ‡è¯†idle workers å‰é¢16ä½ç¬¬ä¸€ä½æ ‡è¯†æ˜¯activeçš„è¿˜æ˜¯inactiveçš„,å…¶ä»–ä¸ºæ˜¯ç‰ˆæœ¬æ ‡è¯†ã€‚ 4å·16ä½ï¼Œè¡¨ç¤ºID(Index)ï¼Œæ ‡è¯†idle workersåœ¨WorkQueue[]æ•°ç»„ä¸­çš„indexã€‚è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯,ctlçš„å32ä½å…¶å®åªèƒ½è¡¨ç¤ºä¸€ä¸ªidle workersï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚æœæœ‰å¾ˆå¤šä¸ªidle workerè¦æ€ä¹ˆåŠå‘¢ï¼Ÿè€æä½¿ç”¨çš„æ˜¯stackçš„æ¦‚å¿µæ¥ä¿å­˜è¿™äº›ä¿¡æ¯ã€‚å32ä½æ ‡è¯†çš„æ˜¯æ ˆé¡¶çš„é‚£ä¸ª,æˆ‘ä»¬èƒ½ä»æ ˆé¡¶ä¸­çš„å˜é‡stackPredè¿½è¸ªåˆ°ä¸‹ä¸€ä¸ªidle worker 6.2. WorkQueueWorkQueueæ˜¯ä¸€ä¸ªåŒå‘åˆ—è¡¨,å­˜æ”¾ä»»åŠ¡taskã€‚WorkQueueç±»ä¹Ÿç”¨äº†@sun.misc.Contendedæ³¨è§£ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950@sun.misc.Contended static final class WorkQueue &#123; /** * Capacity of work-stealing queue array upon initialization. * Must be a power of two; at least 4, but should be larger to * reduce or eliminate cacheline sharing among queues. * Currently, it is much larger, as a partial workaround for * the fact that JVMs often place arrays in locations that * share GC bookkeeping (especially cardmarks) such that * per-write accesses encounter serious memory contention. */ static final int INITIAL_QUEUE_CAPACITY = 1 &lt;&lt; 13; /** * Maximum size for queue arrays. Must be a power of two less * than or equal to 1 &lt;&lt; (31 - width of array entry) to ensure * lack of wraparound of index calculations, but defined to a * value a bit less than this to help users trap runaway * programs before saturating systems. */ static final int MAXIMUM_QUEUE_CAPACITY = 1 &lt;&lt; 26; // 64M // Instance fields volatile int scanState; // versioned, &lt;0: inactive; odd:scanning int stackPred; // pool stack (ctl) predecessor int nsteals; // number of steals int hint; // randomization and stealer index hint int config; // pool index and mode volatile int qlock; // 1: locked, &lt; 0: terminate; else 0 volatile int base; // index of next slot for poll int top; // index of next slot for push ForkJoinTask&lt;?&gt;[] array; // the elements (initially unallocated) final ForkJoinPool pool; // the containing pool (may be null) final ForkJoinWorkerThread owner; // owning thread or null if shared volatile Thread parker; // == owner during call to park; else null volatile ForkJoinTask&lt;?&gt; currentJoin; // task being joined in awaitJoin volatile ForkJoinTask&lt;?&gt; currentSteal; // mainly used by helpStealer WorkQueue(ForkJoinPool pool, ForkJoinWorkerThread owner) &#123; this.pool = pool; this.owner = owner; // Place indices in the center of array (that is not yet allocated) base = top = INITIAL_QUEUE_CAPACITY &gt;&gt;&gt; 1; &#125; ... &#125; static final int SCANNING = 1; // false when running tasks static final int INACTIVE = 1 &lt;&lt; 31; // must be negative scanState:è´Ÿæ•°è¡¨ç¤ºinactive; å¥‡æ•°è¡¨ç¤ºscanningã€‚å¦‚æœWorkQueueæ²¡æœ‰å±äºè‡ªå·±çš„owner(ä¸‹æ ‡ä¸ºå¶æ•°çš„éƒ½æ²¡æœ‰),è¯¥å€¼ä¸º inactive ä¹Ÿå°±æ˜¯ä¸€ä¸ªè´Ÿæ•°ã€‚å¦‚æœæœ‰è‡ªå·±çš„ownerï¼Œè¯¥å€¼çš„åˆå§‹å€¼ä¸ºå…¶åœ¨WorkQueue[]æ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼Œä¹Ÿè‚¯å®šæ˜¯ä¸ªå¥‡æ•°ã€‚å¦‚æœè¿™ä¸ªå€¼ï¼Œå˜æˆäº†å¶æ•°ï¼Œè¯´æ˜è¯¥é˜Ÿåˆ—æ‰€å±çš„Threadæ­£åœ¨æ‰§è¡ŒTaskstackPred: è®°å½•å‰ä»»çš„ idle workerconfigï¼šindex | modeã€‚ å¦‚æœä¸‹æ ‡ä¸ºå¶æ•°çš„WorkQueue,åˆ™å…¶modeæ˜¯å…±äº«ç±»å‹ã€‚å¦‚æœæœ‰è‡ªå·±çš„owner é»˜è®¤æ˜¯ LIFOã€‚modeæ˜¯ç”±ForkJoinPoolå…¶ä¸­ä¸€ä¸ªæ„é€ å‡½æ•°ä¼ è¿›æ¥çš„ï¼Œ 1234567891011121314151617181920212223242526272829303132333435/** * Creates a &#123;@code ForkJoinPool&#125; with the given parameters. * * @param parallelism the parallelism level. For default value, * use &#123;@link java.lang.Runtime#availableProcessors&#125;. * @param factory the factory for creating new threads. For default value, * use &#123;@link #defaultForkJoinWorkerThreadFactory&#125;. * @param handler the handler for internal worker threads that * terminate due to unrecoverable errors encountered while executing * tasks. For default value, use &#123;@code null&#125;. * @param asyncMode if true, * establishes local first-in-first-out scheduling mode for forked * tasks that are never joined. This mode may be more appropriate * than default locally stack-based mode in applications in which * worker threads only process event-style asynchronous tasks. * For default value, use &#123;@code false&#125;. * @throws IllegalArgumentException if parallelism less than or * equal to zero, or greater than implementation limit * @throws NullPointerException if the factory is null * @throws SecurityException if a security manager exists and * the caller is not permitted to modify threads * because it does not hold &#123;@link * java.lang.RuntimePermission&#125;&#123;@code (\"modifyThread\")&#125; */public ForkJoinPool(int parallelism, ForkJoinWorkerThreadFactory factory, UncaughtExceptionHandler handler, boolean asyncMode) &#123; this(checkParallelism(parallelism), checkFactory(factory), handler, asyncMode ? FIFO_QUEUE : LIFO_QUEUE, \"ForkJoinPool-\" + nextPoolId() + \"-worker-\"); checkPermission();&#125; è‹±æ–‡ä¸å¤ªokï¼Œçœ‹äº†æ³¨é‡Šåº”è¯¥æ˜¯ï¼ŒasyncModeä¸‹å·¥ä½œçº¿ç¨‹åœ¨å¤„ç†æœ¬åœ°ä»»åŠ¡æ—¶ä¹Ÿä½¿ç”¨ FIFO é¡ºåºã€‚è¿™ç§æ¨¡å¼ä¸‹çš„ ForkJoinPool æ›´æ¥è¿‘äºæ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œä¸æ˜¯ç”¨æ¥å¤„ç†é€’å½’å¼çš„ä»»åŠ¡ã€‚stackoverflowæœ‰ä¸ªå›ç­”ä¸¾äº†ä¸ªä¾‹å­ï¼Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°asyncModeçš„å…ˆè¿›å…ˆå‡ºçš„æ‰§è¡Œæ–¹å¼ã€‚æˆ‘æƒ³ä½ çš„ForkJoinPoolä¸æ˜¯ç§æœ‰çš„ï¼Œé‚£å°±è®¾ç½®æˆå¼‚æ­¥æ¨¡å¼å§ã€‚ qlockï¼šé˜Ÿåˆ—é”baseï¼šworker stealçš„åç§»é‡,å› ä¸ºå…¶ä»–çš„çº¿ç¨‹éƒ½å¯ä»¥å·è¯¥é˜Ÿåˆ—çš„ä»»åŠ¡,æ‰€æœ‰baseä½¿ç”¨volatileæ ‡è¯†ã€‚top:owneræ‰§è¡Œä»»åŠ¡çš„åç§»é‡ã€‚parker:å¦‚æœ owner æŒ‚èµ·ï¼Œåˆ™ä½¿ç”¨è¯¥å˜é‡åšè®°å½•currentJoin:å½“å‰æ­£åœ¨joinç­‰å¾…ç»“æœçš„ä»»åŠ¡ã€‚currentSteal:å½“å‰æ‰§è¡Œçš„ä»»åŠ¡æ˜¯stealè¿‡æ¥çš„ä»»åŠ¡ï¼Œè¯¥å˜é‡åšè®°å½•ã€‚ 6.3. ForkJoinTaskè¿™æ˜¯ä¸ªæŠ½è±¡ç±»,æˆ‘ä»¬å£°æ˜çš„ä»»åŠ¡æ˜¯ä»–çš„å­ç±»ï¼Œä¸‹é¢æ˜¯ä»–çš„çŠ¶æ€ 12345678/** The run status of this task */volatile int status; // accessed directly by pool and workersstatic final int DONE_MASK = 0xf0000000; // mask out non-completion bitsstatic final int NORMAL = 0xf0000000; // must be negativestatic final int CANCELLED = 0xc0000000; // must be &lt; NORMALstatic final int EXCEPTIONAL = 0x80000000; // must be &lt; CANCELLEDstatic final int SIGNAL = 0x00010000; // must be &gt;= 1 &lt;&lt; 16static final int SMASK = 0x0000ffff; // short bits for tags å¦‚æœstatus &lt; 0ï¼Œè¡¨ç¤ºä»»åŠ¡å·²ç»ç»“æŸ((s &gt;&gt;&gt; 16) != 0)è¡¨ç¤ºéœ€è¦signalå…¶ä»–çº¿ç¨‹ 6.4. ForkJoinWorkerThreadè¿™å°±æ˜¯å·¥ä½œçº¿ç¨‹çš„å°è£…ï¼Œç»§æ‰¿è‡ªThreadç±»ã€‚ 12345678910111213141516171819202122public class ForkJoinWorkerThread extends Thread &#123; /* * ForkJoinWorkerThreads are managed by ForkJoinPools and perform * ForkJoinTasks. For explanation, see the internal documentation * of class ForkJoinPool. * * This class just maintains links to its pool and WorkQueue. The * pool field is set immediately upon construction, but the * workQueue field is not set until a call to registerWorker * completes. This leads to a visibility race, that is tolerated * by requiring that the workQueue field is only accessed by the * owning thread. * * Support for (non-public) subclass InnocuousForkJoinWorkerThread * requires that we break quite a lot of encapsulation (via Unsafe) * both here and in the subclass to access and set Thread fields. */ final ForkJoinPool pool; // the pool this thread works in final ForkJoinPool.WorkQueue workQueue; // work-stealing mechanics ...&#125; ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼ŒForkJoinWorkThreadæŒæœ‰ForkJoinPoolå’ŒForkJoinPool.WorkQueueçš„å¼•ç”¨ï¼Œä»¥è¡¨æ˜è¯¥çº¿ç¨‹å±äºå“ªä¸ªçº¿ç¨‹æ± ï¼Œå®ƒçš„å·¥ä½œé˜Ÿåˆ—æ˜¯å“ªä¸ª 7. é‡åœºæˆ7.1. é€šç”¨ForkJoinPoolçš„åˆå§‹åŒ–ForkJoinPoolç±»çš„staticä»£ç å—åˆå§‹åŒ–äº†ä¸€ä¸ªå…¨å±€é€šç”¨çš„ForkJoinPoolï¼Œè¿™æ˜¯è€ææ¨èçš„ä½¿ç”¨æ–¹å¼ï¼Œä¸ç”¨è‡ªå·±new new newã€‚ 1234public static ForkJoinPool commonPool() &#123; // assert common != null : \"static init error\"; return common;&#125; 123456789101112131415161718192021222324252627282930313233343536373839/** * Creates and returns the common pool, respecting user settings * specified via system properties. */private static ForkJoinPool makeCommonPool() &#123; int parallelism = -1; ForkJoinWorkerThreadFactory factory = null; UncaughtExceptionHandler handler = null; try &#123; // ignore exceptions in accessing/parsing properties String pp = System.getProperty (\"java.util.concurrent.ForkJoinPool.common.parallelism\"); String fp = System.getProperty (\"java.util.concurrent.ForkJoinPool.common.threadFactory\"); String hp = System.getProperty (\"java.util.concurrent.ForkJoinPool.common.exceptionHandler\"); if (pp != null) parallelism = Integer.parseInt(pp); if (fp != null) factory = ((ForkJoinWorkerThreadFactory)ClassLoader. getSystemClassLoader().loadClass(fp).newInstance()); if (hp != null) handler = ((UncaughtExceptionHandler)ClassLoader. getSystemClassLoader().loadClass(hp).newInstance()); &#125; catch (Exception ignore) &#123; &#125; if (factory == null) &#123; if (System.getSecurityManager() == null) factory = defaultForkJoinWorkerThreadFactory; else // use security-managed default factory = new InnocuousForkJoinWorkerThreadFactory(); &#125; if (parallelism &lt; 0 &amp;&amp; // default 1 less than #cores (parallelism = Runtime.getRuntime().availableProcessors() - 1) &lt;= 0) parallelism = 1; if (parallelism &gt; MAX_CAP) parallelism = MAX_CAP; return new ForkJoinPool(parallelism, factory, handler, LIFO_QUEUE, \"ForkJoinPool.commonPool-worker-\");&#125; æœ‰å‡ ä¸ªå‚æ•°å¯ä»¥é€šè¿‡java -DæŒ‡å®šï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé‚£ä¹ˆä½¿ç”¨é»˜è®¤å‚æ•°æ„é€ ï¼Œå¹¶è¡Œæ•°é»˜è®¤æƒ…å†µæ˜¯è®¡ç®—æœºå¤„ç†å™¨æ•°-1 7.2. ä»»åŠ¡æäº¤æˆ‘ä»¬æäº¤çš„ä»»åŠ¡ï¼Œä¸ç®¡æ˜¯Runnable,Callableï¼ŒForkJoinTaskï¼Œæœ€ç»ˆéƒ½ä¼šå˜æˆå°è£…ä¸ºForkJoinTaskã€‚ ç”±äºå®ç°äº†ExecutorServiceï¼Œè‡ªç„¶å®ç°äº†submit(task)ã€execute(task)æ–¹æ³•ï¼Œè€Œä»–è‡ªå·±è¿˜åˆä¸€ä¸ªinvoke(task)çš„æ–¹æ³•ï¼Œè¿™ä¹ˆå¤šä¸ªæ‰§è¡Œï¼Œä»€ä¹ˆæ—¶å€™ç”¨ä»€ä¹ˆå‘¢ã€‚ 12345678910111213141516171819public void execute(ForkJoinTask&lt;?&gt; task) &#123; if (task == null) throw new NullPointerException(); externalPush(task);&#125;public &lt;T&gt; ForkJoinTask&lt;T&gt; submit(ForkJoinTask&lt;T&gt; task) &#123; if (task == null) throw new NullPointerException(); externalPush(task); return task;&#125;public &lt;T&gt; T invoke(ForkJoinTask&lt;T&gt; task) &#123; if (task == null) throw new NullPointerException(); externalPush(task); return task.join();&#125; å¯ä»¥çœ‹åˆ°execute(task)å’Œæ™®é€šçº¿ç¨‹æ± ä¸€æ ·æ— è¿”å›ï¼Œsubmit(task)è¿”å›äº†ä¸€ä¸ªForkJoinTask,è€Œinvoke(task)è¿”å›ç›´æ¥è°ƒç”¨join()é˜»å¡ï¼ŒçŸ¥é“è®¡ç®—å¾—å‡ºç»“æœè¿”å›ã€‚ è¿™å‡ ä¸ªéƒ½æ˜¯è°ƒç”¨externalPush(task);æ–¹æ³•ï¼Œå’Œæ™®é€šçº¿ç¨‹æ± ä¸€æ ·ï¼Œåœ¨æäº¤ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ä¼šè§†æƒ…å†µå¢åŠ å·¥ä½œçº¿ç¨‹ï¼Œå’Œæ™®é€šçº¿ç¨‹æ± ä¸ä¸€æ ·çš„æ˜¯è¿˜è¦åŒæ—¶å¢åŠ å·¥ä½œé˜Ÿåˆ—ã€‚ æ³¨æ„ï¼šå·¥ä½œçº¿ç¨‹å’Œå·¥ä½œé˜Ÿåˆ—çš„ä¸æ˜¯ä¸€å¯¹ä¸€å…³ç³» 12345678910111213141516171819202122232425262728293031323334353637383940414243/** * Tries to add the given task to a submission queue at * submitter's current queue. Only the (vastly) most common path * is directly handled in this method, while screening for need * for externalSubmit. * * @param task the task. Caller must ensure non-null. */final void externalPush(ForkJoinTask&lt;?&gt; task) &#123; WorkQueue[] ws; WorkQueue q; int m; // å–å¾—ä¸€ä¸ªéšæœºæ¢æŸ¥æ•°ï¼Œå¯èƒ½ä¸º0ä¹Ÿå¯èƒ½ä¸ºå…¶å®ƒæ•° // åˆ©ç”¨è¿™ä¸ªæ•°æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—æ•°ç»„ä¸­çš„éšæœºä¸€ä¸ªé˜Ÿåˆ— int r = ThreadLocalRandom.getProbe(); int rs = runState; // ä»–å–µçš„è¿™ä¸ªifæœ‰å¤Ÿå¤æ‚ // SQMASK = 0x007eï¼Œä¹Ÿå°±æ˜¯0000 0000 0111 1110ï¼Œä¸è¿™ä¸ªæ•°ä¸å‡ºæ¥çš„ç»“æœï¼Œåªèƒ½æ˜¯ä¸ªå¶æ•° // å¦‚æœï¼ˆï¼ˆä»»åŠ¡é˜Ÿåˆ—æ•°ç»„éç©ºï¼‰ä¸”ï¼ˆæ•°ç»„é•¿åº¦&gt;=1ï¼‰ä¸”ï¼ˆæ•°ç»„é•¿åº¦-1ä¸éšæœºæ•°ä¸0x007eå¾—å‡ºæ¥çš„ä¸‹æ ‡å¤„æœ‰å·¥ä½œé˜Ÿåˆ—ï¼‰ä¸”ï¼ˆéšæœºæ•°!=0ï¼‰ä¸”ï¼ˆçº¿ç¨‹æ± åœ¨è¿è¡Œï¼‰ä¸”ï¼ˆè·å–é”æˆåŠŸï¼‰ï¼‰ if ((ws = workQueues) != null &amp;&amp; (m = (ws.length - 1)) &gt;= 0 &amp;&amp; (q = ws[m &amp; r &amp; SQMASK]) != null &amp;&amp; r != 0 &amp;&amp; rs &gt; 0 &amp;&amp; U.compareAndSwapInt(q, QLOCK, 0, 1)) &#123; ForkJoinTask&lt;?&gt;[] a; int am, n, s;// am=æ•°ç»„é•¿åº¦ï¼Œn=top-baseï¼Œs=top if ((a = q.array) != null &amp;&amp; // æ„Ÿè§‰è¿™ä¸ªä¸ä¸ºtrueçš„æƒ…å†µåªèƒ½æ˜¯==ï¼Œä¸ä¼š&lt; (am = a.length - 1) &gt; (n = (s = q.top) - q.base)) &#123; // ABASEæ˜¯åˆ©ç”¨Unsafeå¾—åˆ°çš„é˜Ÿåˆ—baseå±æ€§å†…å­˜åœ°å€ï¼Œå› ä¸ºç”¨UnsafeåŠ å…¥é˜Ÿåˆ—ï¼Œæ‰€ä»¥è¦è®¡ç®—å‡ºtopçš„å†…å­˜åœ°å€ int j = ((am &amp; s) &lt;&lt; ASHIFT) + ABASE; // ä»¥ä¸‹ä¸‰ä¸ªåŸå­æ“ä½œé¦–å…ˆæ˜¯å°†taskæ”¾å…¥é˜Ÿåˆ—, U.putOrderedObject(a, j, task); // ç„¶åå°†â€œqâ€è¿™ä¸ªsubmission queueçš„topæ ‡è®°+1,è®°å¾—queueçš„ownerçº¿ç¨‹æ˜¯é»˜è®¤ä»topæ‹¿çš„ä»»åŠ¡ U.putOrderedInt(q, QTOP, s + 1); // è§£é” U.putIntVolatile(q, QLOCK, 0); // å¦‚æœæ¡ä»¶æˆç«‹ï¼Œè¯´æ˜è¿™æ—¶å¤„äºactiveçš„å·¥ä½œçº¿ç¨‹å¯èƒ½è¿˜ä¸å¤Ÿï¼Œè°ƒç”¨signalWorkæ–¹æ³• if (n &lt;= 1) signalWork(ws, q); return; &#125; // å¯èƒ½ä¸Šé¢æ²¡æœ‰è§£é”ï¼Œä¿è¯èƒ½è§£é”ã€‚ // è¿™ä¸ä¼šè§£é”äº†å…¶ä»–å°å·å— = = U.compareAndSwapInt(q, QLOCK, 1, 0); &#125; externalSubmit(task);&#125; æˆ‘æ³¨æ„åˆ°äº†è¿™ä¸ªæ–¹æ³•ThreadLocalRandom.getProbe()ï¼Œè¿™æ˜¯ä¸ªä¸€ä¸ªåŒ…çº§åˆ«çš„æ–¹æ³•ï¼Œåªæœ‰concurrentåŒ…æ‰èƒ½ç”¨ä»–ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªéšæœºæ•°ï¼Œè€Œä¸”æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯å¦‚æœæ²¡æ‰§è¡ŒThreadLocalRandom.localInit();ï¼Œè°ƒç”¨ç»“æœä¼šæ˜¯0ã€‚ æŠŠä»–çš„æºç å¤åˆ¶å‡ºæ¥åæ‰§è¡Œå¾—å‡ºæ¥çš„ç»“è®ºã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸»çº¿ç¨‹æ‰§è¡ŒexternalPushçš„æ—¶å€™ï¼Œç”±äºThreadLocalRandom.getProbe();è¿”å›ä¸€ç›´0ï¼Œæ˜¯ç›´æ¥è¿›å…¥externalSubmit(task) é‚£å¨ifå—ä¸»è¦åšçš„æ˜¯æŒ‰çº¿ç¨‹ç»™çš„éšæœºæ•°éšæœºæ”¾å…¥workqueueæ•°ç»„ä¸­é˜Ÿåˆ—ï¼Œéšæœºæ–¹å¼æ˜¯m &amp; r &amp; SQMASKï¼Œ(æ•°ç»„å¤§å°-1)ä¸éšæœºæ•°ä¸å¶æ•°æ©ç  å…¥é˜Ÿçš„æ–¹å¼æ˜¯æ”¾åˆ°éšæœºé˜Ÿåˆ—çš„topä½ç½®ï¼Œåˆ©ç”¨Unsafeæ¥æ“ä½œï¼ŒçœŸæ˜¯ğŸ‚ğŸºï¼Œè€Œé˜Ÿåˆ—owneræ‹¿çš„æ—¶å€™ä¹Ÿæ˜¯ä»topæ‹¿ã€‚ externalSubmit(task)çš„ä»£ç å¾ˆé•¿ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778private void externalSubmit(ForkJoinTask&lt;?&gt; task) &#123; int r; // initialize caller's probe if ((r = ThreadLocalRandom.getProbe()) == 0) &#123; ThreadLocalRandom.localInit(); r = ThreadLocalRandom.getProbe(); &#125; for (;;) &#123; WorkQueue[] ws; WorkQueue q; int rs, m, k; boolean move = false; if ((rs = runState) &lt; 0) &#123; tryTerminate(false, false); // help terminate throw new RejectedExecutionException(); &#125; // å¦‚æœæ¡ä»¶æˆç«‹ï¼Œå°±è¯´æ˜å½“å‰ForkJoinPoolç±»ä¸­ï¼Œè¿˜æ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ï¼Œæ‰€ä»¥è¦è¿›è¡Œé˜Ÿåˆ—åˆå§‹åŒ– else if ((rs &amp; STARTED) == 0 || // initialize ((ws = workQueues) == null || (m = ws.length - 1) &lt; 0)) &#123; int ns = 0; // é˜»å¡ç­‰å¾… rs = lockRunState(); try &#123; if ((rs &amp; STARTED) == 0) &#123; U.compareAndSwapObject(this, STEALCOUNTER, null, new AtomicLong()); // create workQueues array with size a power of two int p = config &amp; SMASK; // ensure at least 2 slots int n = (p &gt; 1) ? p - 1 : 1; n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4; n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; n = (n + 1) &lt;&lt; 1; workQueues = new WorkQueue[n]; ns = STARTED; &#125; &#125; finally &#123; unlockRunState(rs, (rs &amp; ~RSLOCK) | ns); &#125; &#125; else if ((q = ws[k = r &amp; m &amp; SQMASK]) != null) &#123; if (q.qlock == 0 &amp;&amp; U.compareAndSwapInt(q, QLOCK, 0, 1)) &#123; ForkJoinTask&lt;?&gt;[] a = q.array; int s = q.top; boolean submitted = false; // initial submission or resizing try &#123; // locked version of push if ((a != null &amp;&amp; a.length &gt; s + 1 - q.base) || (a = q.growArray()) != null) &#123; int j = (((a.length - 1) &amp; s) &lt;&lt; ASHIFT) + ABASE; U.putOrderedObject(a, j, task); U.putOrderedInt(q, QTOP, s + 1); submitted = true; &#125; &#125; finally &#123; U.compareAndSwapInt(q, QLOCK, 1, 0); &#125; // æ–¹æ³•çš„å”¯ä¸€å‡ºå£ if (submitted) &#123; signalWork(ws, q); return; &#125; &#125; move = true; // move on failure &#125; // å³ä¸Šé¢çš„é˜Ÿåˆ—==nullä¸”runstateæ²¡æœ‰è¢«é”ä½ else if (((rs = runState) &amp; RSLOCK) == 0) &#123; // create new queue q = new WorkQueue(this, null); q.hint = r; q.config = k | SHARED_QUEUE; q.scanState = INACTIVE; rs = lockRunState(); // publish index if (rs &gt; 0 &amp;&amp; (ws = workQueues) != null &amp;&amp; k &lt; ws.length &amp;&amp; ws[k] == null) ws[k] = q; // else terminated unlockRunState(rs, rs &amp; ~RSLOCK); &#125; else move = true; // move if busy if (move) // é‡æ–°è·å–ä¸€ä¸ªéšæœºæ•° r = ThreadLocalRandom.advanceProbe(r); &#125;&#125; æ€»ç»“ï¼š å¦‚æœhashä¹‹åçš„é˜Ÿåˆ—å·²ç»å­˜åœ¨ lockä½é˜Ÿåˆ—,å°†æ•°æ®å¡åˆ°topä½ç½®ã€‚å¦‚æœè¯¥é˜Ÿåˆ—ä»»åŠ¡å¾ˆå°‘(n &lt;= 1)ä¹Ÿä¼šè°ƒç”¨signalWork å¦‚æœç¬¬ä¸€æ¬¡æäº¤(æˆ–è€…æ˜¯hashä¹‹åçš„é˜Ÿåˆ—è¿˜æœªåˆå§‹åŒ–),è°ƒç”¨externalSubmit ç¬¬ä¸€éå¾ªç¯: (runStateä¸æ˜¯å¼€å§‹çŠ¶æ€): 1.lock; 2.åˆ›å»ºæ•°ç»„WorkQueue[n]ï¼Œè¿™é‡Œçš„næ˜¯æ ¹æ®parallelismåˆå§‹åŒ–çš„; 3. runStateè®¾ç½®ä¸ºå¼€å§‹çŠ¶æ€ã€‚ ç¬¬äºŒéå¾ªç¯:(æ ¹æ®ThreadLocalRandom.getProbe()hashåçš„æ•°ç»„ä¸­ç›¸åº”ä½ç½®çš„WorkQueueæœªåˆå§‹åŒ–): åˆå§‹åŒ–WorkQueue,é€šè¿‡è¿™ç§æ–¹å¼åˆ›ç«‹çš„WorkQueueå‡æ˜¯SUBMISSIONS_QUEUE(ownerä¸ºnull),scanStateä¸ºINACTIVE ç¬¬ä¸‰éå¾ªç¯: æ‰¾åˆ°åˆšåˆšåˆ›å»ºçš„WorkQueue,lockä½é˜Ÿåˆ—,å°†æ•°æ®å¡åˆ°arraytopä½ç½®ã€‚å¦‚æ·»åŠ æˆåŠŸï¼Œå°±ç”¨è°ƒç”¨æ¥ä¸‹æ¥è¦æ‘Šå¼€è®²çš„é‡è¦çš„æ–¹æ³•signalWorkã€‚ 7.2.1. parallelismåˆå§‹åŒ–å…³äºparallelismï¼Œæˆ‘ä»¬æµ“ç¼©ä¸€ä¸‹ä»£ç  123456789101112131415161718......// SMASKæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå³ 00000000 00000000 11111111 11111111static final int SMASK = 0xffff;......// è¿™æ˜¯configçš„æ¥æº// modeæ˜¯ForkJoinPoolæ„é€ å‡½æ•°ä¸­è®¾å®šçš„asyncModeï¼Œå¦‚æœä¸ºLIFOï¼Œåˆ™modeä¸º0ï¼Œå¦åˆ™ä¸º1&lt;&lt;16(FIFO_QUEUE),ä¹Ÿå°±æ˜¯è¯´ï¼Œconfigä¸­ä½16ä½ä»£è¡¨å¹¶è¡Œåº¦// parallelism ä¸ºæŠ€æœ¯äººå‘˜è®¾ç½®çš„ï¼ˆæˆ–è€…ç¨‹åºè‡ªè¡Œè®¾å®šçš„ï¼‰å¹¶å‘ç­‰çº§this.config = (parallelism &amp; SMASK) | mode;......// ensure at least 2 slots// å–configçš„ä½16ä½int p = config &amp; SMASK; // nè¿™ä¸ªå˜é‡å°±æ˜¯è¦è®¡ç®—çš„WorkQueueæ•°ç»„çš„å¤§å°int n = (p &gt; 1) ? p - 1 : 1;......n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4;n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; n = (n + 1) &lt;&lt; 1;...... è¿™ä¹ˆå¤šä½æ“ä½œï¼Œåœ¨java.util.HashMap#tableSizeFor(æœ¬åšå®¢æœ‰)é‡Œä¹Ÿæœ‰å‡ºç°è¿‡ï¼ŒtableSizeForæ˜¯ä¸ºäº†è®¡ç®—å‡ºæœ€æ¥è¿‘ä¸”å¤§äºç»™å®šçš„æ„é€ å®¹é‡çš„2å¹‚æ•°ï¼Œè€Œè¿™é‡Œçš„ä½æ“ä½œï¼Œæ¯”tableSizeForå¤šäº†ä¸€ä¸ªn = (n + 1) &lt;&lt; 1;çš„è®¡ç®—ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—å‡ºæœ€æ¥è¿‘ä¸”å¤§äºç»™å®šçš„æ„é€ å®¹é‡çš„2å¹‚æ•°â€”â€”ç„¶ååœ¨*2ï¼ŒForkJoinPoolä¸­çš„è¿™äº›WorkQueueå’Œå·¥ä½œçº¿ç¨‹ForkJoinWorkerThreadå¹¶ä¸æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œè€Œæ˜¯éšæ—¶éƒ½æœ‰å¤šä½™ForkJoinWorkerThreadæ•°é‡çš„WorkQueueå…ƒç´ ã€‚è€Œè¿™ä¸ªForkJoinPoolä¸­çš„WorkQueueæ•°ç»„ä¸­ï¼Œç´¢å¼•ä½ä¸ºéå¥‡æ•°çš„å·¥ä½œé˜Ÿåˆ—ç”¨äºå­˜å‚¨ä»å¤–éƒ¨æäº¤åˆ°ForkJoinPoolä¸­çš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„submissions queueï¼›ç´¢å¼•ä½ä¸ºå¶æ•°çš„å·¥ä½œé˜Ÿåˆ—ç”¨äºå­˜å‚¨å½’å¹¶è®¡ç®—è¿‡ç¨‹ä¸­ç­‰å¾…å¤„ç†çš„å­ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯task queueã€‚ æˆ‘ä»¬çœ‹signalWork(ws, q)åšäº†ä»€ä¹ˆï¼Œè¿™ä¸ªä¼šè§¦å‘æ„é€ æ–°é˜Ÿåˆ—å’Œæ–°çº¿ç¨‹ 12345678910111213141516171819202122232425262728293031323334/** * Tries to create or activate a worker if too few are active. * * @param ws the worker array to use to find signallees * @param q a WorkQueue --if non-null, don't retry if now empty */final void signalWork(WorkQueue[] ws, WorkQueue q) &#123; // cæ˜¯ctlï¼Œspæ˜¯ctlä½32ä½ long c; int sp, i; WorkQueue v; Thread p; while ((c = ctl) &lt; 0L) &#123; // too few active if ((sp = (int)c) == 0) &#123; // no idle workers if ((c &amp; ADD_WORKER) != 0L) // too few workers tryAddWorker(c); break; &#125; if (ws == null) // unstarted/terminated break; if (ws.length &lt;= (i = sp &amp; SMASK)) // terminated break; if ((v = ws[i]) == null) // terminating break; int vs = (sp + SS_SEQ) &amp; ~INACTIVE; // next scanState int d = sp - v.scanState; // screen CAS long nc = (UC_MASK &amp; (c + AC_UNIT)) | (SP_MASK &amp; v.stackPred); if (d == 0 &amp;&amp; U.compareAndSwapLong(this, CTL, c, nc)) &#123; v.scanState = vs; // activate v if ((p = v.parker) != null) U.unpark(p); break; &#125; if (q != null &amp;&amp; q.base == q.top) // no more work break; &#125;&#125; è¿™ä¸ªæ–¹æ³•ä¸»è¦å°±æ˜¯ä¸€ä¸ªwhileå¾ªç¯å¾ªç¯ï¼Œå½“ctlå°äº0çš„æ—¶å€™æ‰è¦è¿›è¡Œåˆ›å»ºå’Œæ¿€æ´»æ–°çº¿ç¨‹ã€‚ å¦‚æœspç­‰äº0ï¼Œè¡¨ç¤ºæ²¡æœ‰ç©ºé—²çº¿ç¨‹ã€‚æ­¤æ—¶(c &amp; ADD_WORKER) != 0Lå³TCç¬¦å·ä½æ˜¯1ï¼ŒTCæ˜¯ä¸ªè´Ÿæ•°ï¼Œè¡¨ç¤ºworkerè¿˜å¯ä»¥å¢åŠ ã€‚ 12// ADD_WORKERæ˜¯ä¸€ä¸ªç¬¬48ä½ä¸º1ï¼Œå…¶ä½™ä¸º0çš„64æ•°ï¼Œå¯ä»¥åŒºåˆ†TCçš„ç¬¦å·ä½private static final long ADD_WORKER = 0x0001L &lt;&lt; (TC_SHIFT + 15); // sign ä¸‹é¢çœ‹tryAddWorker(c), 1234567891011121314151617181920private void tryAddWorker(long c) &#123; boolean add = false; do &#123; // new ctl long nc = ((AC_MASK &amp; (c + AC_UNIT)) | (TC_MASK &amp; (c + TC_UNIT))); if (ctl == c) &#123; int rs, stop; // check if terminating if ((stop = (rs = lockRunState()) &amp; STOP) == 0) add = U.compareAndSwapLong(this, CTL, c, nc); unlockRunState(rs, rs &amp; ~RSLOCK); if (stop != 0) break; if (add) &#123; createWorker(); break; &#125; &#125; &#125; while (((c = ctl) &amp; ADD_WORKER) != 0L &amp;&amp; (int)c == 0);&#125; æˆ‘ä»¬é¦–å…ˆéœ€è¦ä½¿ç”¨ctlæ¥è®°å½•æˆ‘ä»¬å¢åŠ çš„çº¿ç¨‹, ctlç¼–å·-1çš„16ä½å’Œç¼–å·-2çš„16ä½å‡éœ€è¦åŠ 1,è¡¨ç¤ºactiveçš„worker(AC)åŠ ä¸€ï¼Œæ€»çš„worker(TC)åŠ ä¸€ã€‚æˆåŠŸåæˆ‘ä»¬å°†è°ƒç”¨createWorkerã€‚ 12345678910111213141516private boolean createWorker() &#123; ForkJoinWorkerThreadFactory fac = factory; Throwable ex = null; ForkJoinWorkerThread wt = null; try &#123; if (fac != null &amp;&amp; (wt = fac.newThread(this)) != null) &#123; wt.start(); return true; &#125; &#125; catch (Throwable rex) &#123; ex = rex; &#125; // è·‘åˆ°è¿™é‡Œæ¥è¦æ³¨é”€çº¿ç¨‹ deregisterWorker(wt, ex); return false;&#125; çœ‹fac.newThread(this)æ€ä¹ˆå®ä¾‹åŒ–ä¸€ä¸ªçº¿ç¨‹ 123456static final class DefaultForkJoinWorkerThreadFactory implements ForkJoinWorkerThreadFactory &#123; public final ForkJoinWorkerThread newThread(ForkJoinPool pool) &#123; return new ForkJoinWorkerThread(pool); &#125;&#125; 123456protected ForkJoinWorkerThread(ForkJoinPool pool) &#123; // Use a placeholder until a useful name can be set in registerWorker super(\"aForkJoinWorkerThread\"); this.pool = pool; this.workQueue = pool.registerWorker(this);&#125; çœ‹pool.registerWorker(this); 12345678910111213141516171819202122232425262728293031323334353637final WorkQueue registerWorker(ForkJoinWorkerThread wt) &#123; UncaughtExceptionHandler handler; wt.setDaemon(true); // configure thread if ((handler = ueh) != null) wt.setUncaughtExceptionHandler(handler); WorkQueue w = new WorkQueue(this, wt); int i = 0; // assign a pool index int mode = config &amp; MODE_MASK; int rs = lockRunState(); try &#123; WorkQueue[] ws; int n; // skip if no array if ((ws = workQueues) != null &amp;&amp; (n = ws.length) &gt; 0) &#123; int s = indexSeed += SEED_INCREMENT; // unlikely to collide int m = n - 1; i = ((s &lt;&lt; 1) | 1) &amp; m; // odd-numbered indices if (ws[i] != null) &#123; // collision int probes = 0; // step by approx half n int step = (n &lt;= 4) ? 2 : ((n &gt;&gt;&gt; 1) &amp; EVENMASK) + 2; while (ws[i = (i + step) &amp; m] != null) &#123; if (++probes &gt;= n) &#123; workQueues = ws = Arrays.copyOf(ws, n &lt;&lt;= 1); m = n - 1; probes = 0; &#125; &#125; &#125; w.hint = s; // use as random seed w.config = i | mode; w.scanState = i; // publication fence ws[i] = w; &#125; &#125; finally &#123; unlockRunState(rs, rs &amp; ~RSLOCK); &#125; wt.setName(workerNamePrefix.concat(Integer.toString(i &gt;&gt;&gt; 1))); return w;&#125; æˆ‘ä»¬ä½¿ç”¨ForkJoinWorkerThreadFactoryæ¥äº§ç”Ÿä¸€ä¸ªForkJoinWorkerThreadç±»å‹çš„çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹å°†ä¼šæŠŠè‡ªå·±æ³¨å†Œåˆ°Poolä¸Š,æ€ä¹ˆæ³¨å†Œçš„å‘¢ï¼Ÿå®ç°åœ¨æ–¹æ³•registerWorker,å‰æ–‡æˆ‘ä»¬å·²ç»æåŠ,æ‹¥æœ‰çº¿ç¨‹çš„WorkQueueåªèƒ½å‡ºç°åœ¨æ•°ç»„çš„å¥‡æ•°ä¸‹æ ‡å¤„ã€‚æ‰€ä»¥çº¿ç¨‹é¦–å…ˆ,åˆ›å»ºä¸€ä¸ªæ–°çš„WorkQueueï¼Œå…¶æ¬¡åœ¨æ•°ç»„WorkQueue[]å¯»æ‰¾å¥‡æ•°ä¸‹æ ‡å°šæœªåˆå§‹åŒ–çš„ä½ç½®,å¦‚æœå¾ªç¯çš„æ¬¡æ•°å¤§äºæ•°ç»„é•¿åº¦,è¿˜å¯èƒ½éœ€è¦å¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹ï¼Œç„¶åï¼Œè®¾ç½®è¿™ä¸ªWorkQueueçš„ config ä¸º index | mode (ä¸‹æ ‡å’Œæ¨¡å¼),scanStateä¸º index (ä¸‹æ ‡&gt;0)ã€‚æœ€åå¯åŠ¨è¿™ä¸ªçº¿ç¨‹ã€‚çº¿ç¨‹çš„å¤„ç†æˆ‘ä»¬æ¥ä¸‹æ¥çš„ç« èŠ‚ä»‹ç»ã€‚ å›åˆ°signalWorkæ–¹æ³•,å¦‚æœ(sp = (int)c) == 0ä¸æˆç«‹ï¼Œè¡¨ç¤ºåˆç©ºé—²çº¿ç¨‹ï¼Œé‚£ä¹ˆä¸ç”¨æ–°å¢workerï¼Œç›´æ¥å”¤é†’å·¥ä½œé˜Ÿåˆ—çš„owner æˆ‘ä»¬ä¸Šæ–‡è¯´è¿‡SPçš„é«˜16ä½SS,æ ‡è®°inactiveå’Œç‰ˆæœ¬æ§åˆ¶,æˆ‘ä»¬å°†SSè®¾ç½®ä¸ºæ¿€æ´»çŠ¶æ€å¹¶ä¸”ç‰ˆæœ¬åŠ ä¸€ã€‚IDçš„16ä½æˆ‘ä»¬ä¹‹å‰ä¹Ÿè¯´è¿‡,æ”¾ç½®äº†æŒ‚èµ·çº¿ç¨‹æ ˆçš„indexæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªindexæ‹¿åˆ°WorkQueueâ€”â€”æ„å‘³ç€å°±æ˜¯è¿™ä¸ªWorkQueueçš„Ownerçº¿ç¨‹è¢«æŒ‚èµ·äº†ã€‚ workerä»€ä¹ˆæ—¶å€™æŒ‚èµ·ï¼Ÿ æˆ‘ä»¬å°†è¦æŠŠæ ˆé¡¶æŒ‚èµ·çº¿ç¨‹å”¤é†’,æ„å‘³ç€æˆ‘ä»¬è¦è®²ä¸‹ä¸€ä¸ªæŒ‚èµ·çš„çº¿ç¨‹çš„ä¿¡æ¯è®°å½•åˆ°ctlä¸Šã€‚å‰æ–‡ä¹Ÿè¯´åœ¨ä¸Šä¸€ä¸ªæŒ‚èµ·çš„çº¿ç¨‹çš„indexä¿¡æ¯åœ¨è¿™ä¸ªæŒ‚èµ·çš„çº¿ç¨‹çš„stackPredã€‚åˆ©ç”¨casè¿›è¡Œæ›´æ–°ã€‚ 123456789int vs = (sp + SS_SEQ) &amp; ~INACTIVE; // next scanStateint d = sp - v.scanState; // screen CASlong nc = (UC_MASK &amp; (c + AC_UNIT)) | (SP_MASK &amp; v.stackPred);if (d == 0 &amp;&amp; U.compareAndSwapLong(this, CTL, c, nc)) &#123; v.scanState = vs; // activate v if ((p = v.parker) != null) U.unpark(p); break;&#125; 7.3. å·¥ä½œçº¿ç¨‹çš„è¿è¡ŒThreadæ·»åŠ å®Œæˆä¹‹åï¼Œæ‰§è¡Œwt.start();ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä½¿å¾—run()æ–¹æ³•å¼€å§‹è¿è¡Œã€‚ çœ‹ForkJoinWorkerThreadçš„run()æ–¹æ³•ã€‚ 123456789101112131415161718192021public void run() &#123; if (workQueue.array == null) &#123; // only run once Throwable exception = null; try &#123; onStart(); // çœ‹èŠ‚é‡Œ pool.runWorker(workQueue); &#125; catch (Throwable ex) &#123; exception = ex; &#125; finally &#123; try &#123; onTermination(exception); &#125; catch (Throwable ex) &#123; if (exception == null) exception = ex; &#125; finally &#123; pool.deregisterWorker(this, exception); &#125; &#125; &#125;&#125; 123456789101112131415/** * Top-level runloop for workers, called by ForkJoinWorkerThread.run. */final void runWorker(WorkQueue w) &#123; w.growArray(); // allocate queue int seed = w.hint; // initially holds randomization hint int r = (seed == 0) ? 1 : seed; // avoid 0 for xorShift for (ForkJoinTask&lt;?&gt; t;;) &#123; if ((t = scan(w, r)) != null) w.runTask(t); else if (!awaitWork(w, r)) break; r ^= r &lt;&lt; 13; r ^= r &gt;&gt;&gt; 17; r ^= r &lt;&lt; 5; // xorshift éšæœºæ•°ç®—æ³• &#125;&#125; å·¥ä½œçº¿ç¨‹å…ˆå°è¯•scançªƒå–ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œå¦åˆ™æ‰§è¡ŒawaitWork()ï¼Œå¦‚æœawaitWork()è¿”å›falseï¼Œbreakç»“æŸæ­»å¾ªç¯ã€‚ 7.3.1. scanåˆæ˜¯ä¸€ä¸ªé•¿é•¿çš„æ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556private ForkJoinTask&lt;?&gt; scan(WorkQueue w, int r) &#123; WorkQueue[] ws; int m; if ((ws = workQueues) != null &amp;&amp; (m = ws.length - 1) &gt; 0 &amp;&amp; w != null) &#123; int ss = w.scanState; // initially non-negative for (int origin = r &amp; m, k = origin, oldSum = 0, checkSum = 0;;) &#123; WorkQueue q; ForkJoinTask&lt;?&gt;[] a; ForkJoinTask&lt;?&gt; t; int b, n; long c; if ((q = ws[k]) != null) &#123; if ((n = (b = q.base) - q.top) &lt; 0 &amp;&amp; (a = q.array) != null) &#123; // non-empty long i = (((a.length - 1) &amp; b) &lt;&lt; ASHIFT) + ABASE; if ((t = ((ForkJoinTask&lt;?&gt;) U.getObjectVolatile(a, i))) != null &amp;&amp; q.base == b) &#123; if (ss &gt;= 0) &#123; if (U.compareAndSwapObject(a, i, t, null)) &#123; q.base = b + 1; if (n &lt; -1) // signal others signalWork(ws, q); return t; &#125; &#125; else if (oldSum == 0 &amp;&amp; // try to activate w.scanState &lt; 0) tryRelease(c = ctl, ws[m &amp; (int)c], AC_UNIT); &#125; if (ss &lt; 0) // refresh ss = w.scanState; r ^= r &lt;&lt; 1; r ^= r &gt;&gt;&gt; 3; r ^= r &lt;&lt; 10; origin = k = r &amp; m; // move and rescan oldSum = checkSum = 0; continue; &#125; checkSum += b; &#125; if ((k = (k + 1) &amp; m) == origin) &#123; // continue until stable if ((ss &gt;= 0 || (ss == (ss = w.scanState))) &amp;&amp; oldSum == (oldSum = checkSum)) &#123; if (ss &lt; 0 || w.qlock &lt; 0) // already inactive break; int ns = ss | INACTIVE; // try to inactivate long nc = ((SP_MASK &amp; ns) | (UC_MASK &amp; ((c = ctl) - AC_UNIT))); w.stackPred = (int)c; // hold prev stack top U.putInt(w, QSCANSTATE, ns); if (U.compareAndSwapLong(this, CTL, c, nc)) ss = ns; else w.scanState = ss; // back out &#125; checkSum = 0; &#125; &#125; &#125; return null;&#125; å› ä¸ºæˆ‘ä»¬çš„WorkQueueæ˜¯æœ‰ownerçº¿ç¨‹çš„é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä»¥ä¸‹ä¿¡æ¯: config = index | mode scanState = index &gt; 0æˆ‘ä»¬é¦–å…ˆé€šè¿‡éšæœºæ•°ræ¥å¯»æ‰¾çªƒå–é˜Ÿåˆ—ã€‚ å¦‚æœæˆ‘ä»¬å‡†å¤‡å·å–çš„é˜Ÿåˆ—åˆšå¥½æœ‰ä»»åŠ¡(ä¹Ÿæœ‰å¯èƒ½æ˜¯ownerè‡ªå·±çš„é‚£ä¸ªé˜Ÿåˆ—)ï¼› ä»é˜Ÿåˆ—çš„é˜Ÿå°¾å³baseä½ç½®å–åˆ°ä»»åŠ¡è¿”å› base + 1 å¦‚æœæˆ‘ä»¬éå†äº†ä¸€åœˆ(((k = (k + 1) &amp; m) == origin))éƒ½æ²¡æœ‰å·åˆ°,æˆ‘ä»¬å°±è®¤ä¸ºå½“å‰çš„activeçº¿ç¨‹è¿‡å‰©äº†,æˆ‘ä»¬å‡†å¤‡å°†å½“å‰çš„çº¿ç¨‹(å³owner)æŒ‚èµ·,æˆ‘ä»¬é¦–å…ˆ index | INACTIVE å½¢æˆ ctlçš„å32ä½;å¹¶è¡Œå°†ACå‡ä¸€ã€‚å…¶æ¬¡ï¼Œå°†åŸæ¥çš„æŒ‚èµ·çš„æ ˆé¡¶çš„indexè®°å½•åˆ°stackPredä¸­ã€‚ ç»§ç»­éå†å¦‚æœä»ç„¶ä¸€æ— æ‰€è·,å°†è·³å‡ºå¾ªç¯ï¼›å¦‚æœå·åˆ°äº†ä¸€ä¸ªä»»åŠ¡,æˆ‘ä»¬å°†ä½¿ç”¨tryReleaseæ¿€æ´»ã€‚ 7.3.2. runTaskè·å–åˆ°ä»»åŠ¡ä¹‹åï¼Œæ‰§è¡Œ 12345678910111213141516final void runTask(ForkJoinTask&lt;?&gt; task) &#123; if (task != null) &#123; scanState &amp;= ~SCANNING; // mark as busy // æ‰§è¡Œçªƒå–æ¥çš„ä»»åŠ¡ (currentSteal = task).doExec(); U.putOrderedObject(this, QCURRENTSTEAL, null); // release for GC // è¿™é‡Œæ‰§è¡Œè‡ªå·±çš„çº¿ç¨‹çš„ä»»åŠ¡ execLocalTasks(); ForkJoinWorkerThread thread = owner; if (++nsteals &lt; 0) // collect on overflow transferStealCount(pool); scanState |= SCANNING; if (thread != null) thread.afterTopLevelExec(); &#125;&#125; é¦–å…ˆscanState &amp;= ~SCANNING;æ ‡è¯†è¯¥çº¿ç¨‹å¤„äºç¹å¿™çŠ¶æ€ã€‚ æ‰§è¡Œå·å–çš„Taskã€‚ è°ƒç”¨execLocalTaskså¯¹çº¿ç¨‹æ‰€å±çš„WorkQueueå†…çš„ä»»åŠ¡è¿›è¡Œæ‰§è¡Œ,æŒ‰configè®¾ç½®çš„modeè¿›è¡ŒFIFOæˆ–è€…LIFOæ‰§è¡Œã€‚1234567891011121314151617181920final void execLocalTasks() &#123; int b = base, m, s; ForkJoinTask&lt;?&gt;[] a = array; if (b - (s = top - 1) &lt;= 0 &amp;&amp; a != null &amp;&amp; (m = a.length - 1) &gt;= 0) &#123; if ((config &amp; FIFO_QUEUE) == 0) &#123; for (ForkJoinTask&lt;?&gt; t;;) &#123; if ((t = (ForkJoinTask&lt;?&gt;)U.getAndSetObject (a, ((m &amp; s) &lt;&lt; ASHIFT) + ABASE, null)) == null) break; U.putOrderedInt(this, QTOP, s); t.doExec(); if (base - (s = top - 1) &gt; 0) break; &#125; &#125; else pollAndExecAll(); &#125;&#125; 7.3.3. awaitWorkscanä¸åˆ°ä»»åŠ¡çš„æ—¶å€™ï¼Œå°±æ‰§è¡ŒæŒ‚èµ·ï¼Œå¦‚æœæŒ‚èµ·è¿”å›falseï¼Œè¡¨ç¤ºçº¿ç¨‹æ± ç»ˆæ­¢ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152private boolean awaitWork(WorkQueue w, int r) &#123; if (w == null || w.qlock &lt; 0) // w is terminating return false; for (int pred = w.stackPred, spins = SPINS, ss;;) &#123; if ((ss = w.scanState) &gt;= 0) break; else if (spins &gt; 0) &#123; r ^= r &lt;&lt; 6; r ^= r &gt;&gt;&gt; 21; r ^= r &lt;&lt; 7; if (r &gt;= 0 &amp;&amp; --spins == 0) &#123; // randomize spins WorkQueue v; WorkQueue[] ws; int s, j; AtomicLong sc; if (pred != 0 &amp;&amp; (ws = workQueues) != null &amp;&amp; (j = pred &amp; SMASK) &lt; ws.length &amp;&amp; (v = ws[j]) != null &amp;&amp; // see if pred parking (v.parker == null || v.scanState &gt;= 0)) spins = SPINS; // continue spinning &#125; &#125; else if (w.qlock &lt; 0) // recheck after spins return false; else if (!Thread.interrupted()) &#123; long c, prevctl, parkTime, deadline; int ac = (int)((c = ctl) &gt;&gt; AC_SHIFT) + (config &amp; SMASK); if ((ac &lt;= 0 &amp;&amp; tryTerminate(false, false)) || (runState &amp; STOP) != 0) // pool terminating return false; if (ac &lt;= 0 &amp;&amp; ss == (int)c) &#123; // is last waiter prevctl = (UC_MASK &amp; (c + AC_UNIT)) | (SP_MASK &amp; pred); int t = (short)(c &gt;&gt;&gt; TC_SHIFT); // shrink excess spares if (t &gt; 2 &amp;&amp; U.compareAndSwapLong(this, CTL, c, prevctl)) return false; // else use timed wait parkTime = IDLE_TIMEOUT * ((t &gt;= 0) ? 1 : 1 - t); deadline = System.nanoTime() + parkTime - TIMEOUT_SLOP; &#125; else prevctl = parkTime = deadline = 0L; Thread wt = Thread.currentThread(); U.putObject(wt, PARKBLOCKER, this); // emulate LockSupport w.parker = wt; if (w.scanState &lt; 0 &amp;&amp; ctl == c) // recheck before park U.park(false, parkTime); U.putOrderedObject(w, QPARKER, null); U.putObject(wt, PARKBLOCKER, null); if (w.scanState &gt;= 0) break; if (parkTime != 0L &amp;&amp; ctl == c &amp;&amp; deadline - System.nanoTime() &lt;= 0L &amp;&amp; U.compareAndSwapLong(this, CTL, c, prevctl)) return false; // shrink pool &#125; &#125; return true;&#125; å¦‚æœacè¿˜æ²¡åˆ°è¾¾é˜ˆå€¼,ä½†æ˜¯TC&gt;2è¯´æ˜ç°åœ¨ä»ç„¶è¿è¡Œä¸­çš„çº¿ç¨‹å’ŒæŒ‚èµ·çš„çº¿ç¨‹åŠ ä¸€èµ·å¤„äºè¿‡å‰©çŠ¶æ€,æˆ‘ä»¬å°†æ”¾å¼ƒè¯¥çº¿ç¨‹çš„æŒ‚èµ·,ç›´æ¥è®©å®ƒæ‰§è¡Œç»“æŸï¼Œä¸å†å¾ªç¯æ‰§è¡Œä»»åŠ¡ã€‚ å¦åˆ™ï¼Œæˆ‘ä»¬è®¡ç®—ä¸€ä¸ªæŒ‚èµ·çš„æ—¶é—´ï¼Œç­‰åˆ°äº†æ—¶é—´ä¹‹å(æˆ–è€…è¢«å¤–éƒ¨å”¤é†’),çº¿ç¨‹é†’äº†ä¹‹å,å¦‚æœå‘ç°è‡ªå·±çŠ¶æ€æ˜¯activeçŠ¶æ€(w.scanState &gt;= 0),åˆ™çº¿ç¨‹ç»§ç»­å›å»scanä»»åŠ¡ï¼Œå¦‚æœæŒ‚èµ·æ—¶é—´ç»“æŸï¼Œè‡ªå·±è¿˜æ˜¯inactiveçŠ¶æ€,ã€‚çº¿ç¨‹ä¹Ÿä¼šæ‰§è¡Œç»“æŸï¼Œä¸å†å¾ªç¯æ‰§è¡Œä»»åŠ¡ã€‚ 7.4. ä»»åŠ¡æ‰§è¡Œä»»åŠ¡çš„æ‰§è¡Œæ˜¯è°ƒç”¨äº†task.doExec()æ–¹æ³•ï¼Œå¯ä»¥åœ¨runTask(task)æ–¹æ³•çœ‹åˆ° 12345678910111213final int doExec() &#123; int s; boolean completed; if ((s = status) &gt;= 0) &#123; try &#123; completed = exec(); &#125; catch (Throwable rex) &#123; return setExceptionalCompletion(rex); &#125; if (completed) s = setCompletion(NORMAL); &#125; return s;&#125; ä»¥RecursiveTaskä¸ºä¾‹ï¼Œ 1234protected final boolean exec() &#123; result = compute(); return true;&#125; æœ€ç»ˆè°ƒç”¨äº†æˆ‘ä»¬é‡å†™çš„compute()æ–¹æ³•ã€‚ 7.4.1. forkfork()åƒå‰å­æŠŠæ–°ä»»åŠ¡æäº¤ï¼Œ 12345678public final ForkJoinTask&lt;V&gt; fork() &#123; Thread t; if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) ((ForkJoinWorkerThread)t).workQueue.push(this); else ForkJoinPool.common.externalPush(this); return this;&#125; å¦‚æœå½“å‰çº¿ç¨‹æ˜¯å·¥ä½œçº¿ç¨‹,ç›´æ¥pushåˆ°è‡ªå·±æ‰€æ‹¥æœ‰çš„é˜Ÿåˆ—çš„topä½ç½®ã€‚ å¦‚æœæ˜¯éå·¥ä½œçº¿ç¨‹,å°±æ˜¯ä¸€ä¸ªæäº¤åˆ°é€šç”¨poolçš„è¿‡ç¨‹ã€‚ 7.4.2. joinjoinæ˜¯ç­‰å¾…ä»»åŠ¡å®Œæˆ 123456public final V join() &#123; int s; if ((s = doJoin() &amp; DONE_MASK) != NORMAL) reportException(s); return getRawResult();&#125; å¦‚æœå¾—åˆ°çš„ç»“æœå¼‚å¸¸ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼› å¦‚æœå¾—åˆ°çš„æ­£å¸¸ï¼Œåˆ™è·å–è¿”å›å€¼ã€‚ çœ‹doJoin()ï¼Œ 123456789private int doJoin() &#123; int s; Thread t; ForkJoinWorkerThread wt; ForkJoinPool.WorkQueue w; return (s = status) &lt; 0 ? s : ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) (w = (wt = (ForkJoinWorkerThread)t).workQueue). tryUnpush(this) &amp;&amp; (s = doExec()) &lt; 0 ? s : wt.pool.awaitJoin(w, this, 0L) : externalAwaitDone();&#125; 1234567891011121314151617181920212223242526272829303132333435363738394041/** * Helps and/or blocks until the given task is done or timeout. * * @param w caller * @param task the task * @param deadline for timed waits, if nonzero * @return task status on exit */final int awaitJoin(WorkQueue w, ForkJoinTask&lt;?&gt; task, long deadline) &#123; int s = 0; if (task != null &amp;&amp; w != null) &#123; ForkJoinTask&lt;?&gt; prevJoin = w.currentJoin; U.putOrderedObject(w, QCURRENTJOIN, task); // è¿™é‡Œå¥½åƒæ˜¯jdk8ä»€ä¹ˆä¸å¾—äº†çš„ä¸œè¥¿ï¼Œæ™šç‚¹å†çœ‹ CountedCompleter&lt;?&gt; cc = (task instanceof CountedCompleter) ? (CountedCompleter&lt;?&gt;)task : null; for (;;) &#123; if ((s = task.status) &lt; 0) break; if (cc != null) helpComplete(w, cc, 0); else if (w.base == w.top || w.tryRemoveAndExec(task)) helpStealer(w, task); if ((s = task.status) &lt; 0) break; long ms, ns; if (deadline == 0L) ms = 0L; else if ((ns = deadline - System.nanoTime()) &lt;= 0L) break; else if ((ms = TimeUnit.NANOSECONDS.toMillis(ns)) &lt;= 0L) ms = 1L; if (tryCompensate(w)) &#123; task.internalWait(ms); U.getAndAddLong(this, CTL, AC_UNIT); &#125; &#125; U.putOrderedObject(w, QCURRENTJOIN, prevJoin); &#125; return s;&#125; å¦‚æœæ˜¯status&lt;0,è¡¨ç¤ºå®Œæˆï¼Œç›´æ¥è¿”å› å¦‚æœæ˜¯å·¥ä½œçº¿ç¨‹ï¼Œå°è¯•æŠŠtaskä»topä½ç½®å¼¹å‡ºï¼ŒæˆåŠŸåˆ™æ‰§è¡Œtask å¦‚æœè¯¥ä»»åŠ¡ä¸åœ¨topä½ç½®,åˆ™è°ƒç”¨awaitJoinæ–¹æ³•ï¼š è®¾ç½®currentJoinè¡¨æ˜è‡ªå·±æ­£åœ¨ç­‰å¾…è¯¥ä»»åŠ¡ï¼› å¦‚æœå‘ç° w.base == w.top(æ²¡ä»»åŠ¡) æˆ–è€… tryRemoveAndExecè¿”å›trueè¯´æ˜è‡ªå·±æ‰€å±çš„é˜Ÿåˆ—ä¸ºç©ºï¼Œä¹Ÿè¯´æ˜æœ¬çº¿ç¨‹çš„ä»»åŠ¡å·²ç»è¢«åˆ«çš„çº¿ç¨‹å·èµ°ï¼Œè¯¥çº¿ç¨‹ä¹Ÿä¸ä¼šé—²ç€ï¼Œå°†ä¼šhelpStealerå¸®åŠ©å¸®åŠ©è‡ªå·±æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡(äº’æƒ äº’åˆ©,ä½ æ¥æˆ‘å¾€) å¦‚æœtryCompensateä¸º true,åˆ™é˜»å¡æœ¬çº¿ç¨‹ï¼Œç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æŸçš„å”¤é†’ å¦‚æœä¸æ˜¯å·¥ä½œçº¿ç¨‹åœ¨joinï¼Œåˆ™é˜»å¡ç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚ 7.4.2.1. tryRemoveAndExec1234567891011121314151617181920212223242526272829303132333435363738394041424344/** * If present, removes from queue and executes the given task, * or any other cancelled task. Used only by awaitJoin. * * @return true if queue empty and task not known to be done */final boolean tryRemoveAndExec(ForkJoinTask&lt;?&gt; task) &#123; ForkJoinTask&lt;?&gt;[] a; int m, s, b, n; if ((a = array) != null &amp;&amp; (m = a.length - 1) &gt;= 0 &amp;&amp; task != null) &#123; while ((n = (s = top) - (b = base)) &gt; 0) &#123; for (ForkJoinTask&lt;?&gt; t;;) &#123; // traverse from s to b long j = ((--s &amp; m) &lt;&lt; ASHIFT) + ABASE; if ((t = (ForkJoinTask&lt;?&gt;)U.getObject(a, j)) == null) return s + 1 == top; // shorter than expected else if (t == task) &#123; boolean removed = false; if (s + 1 == top) &#123; // pop if (U.compareAndSwapObject(a, j, task, null)) &#123; U.putOrderedInt(this, QTOP, s); removed = true; &#125; &#125; else if (base == b) // replace with proxy removed = U.compareAndSwapObject( a, j, task, new EmptyTask()); if (removed) task.doExec(); break; &#125; else if (t.status &lt; 0 &amp;&amp; s + 1 == top) &#123; if (U.compareAndSwapObject(a, j, t, null)) U.putOrderedInt(this, QTOP, s); break; // was cancelled &#125; if (--n == 0) return false; &#125; if (task.status &lt; 0) return false; &#125; &#125; return true;&#125; å¦‚æœåˆšå¥½åœ¨topä½ç½®ï¼Œpopå‡ºæ¥æ‰§è¡Œã€‚ å¦‚æœåœ¨é˜Ÿåˆ—ä¸­é—´,åˆ™ä½¿ç”¨EmptyTaskæ¥å ä½,å°†ä»»åŠ¡å–å‡ºæ¥æ‰§è¡Œã€‚ å¦‚æœæ‰§è¡Œçš„ä»»åŠ¡è¿˜æ²¡ç»“æŸã€‚åˆ™è¿”å›falseï¼Œå¤–éƒ¨ä¸è¿›è¡ŒhelpStealerã€‚ 7.4.2.2. helpStealer éå†WorkQueue[]çš„å¥‡æ•°ä¸‹æ ‡ï¼ŒWorkQueueçš„currentStealå¦‚æœæ˜¯è‡ªå·±åœ¨æ‰¾çš„ä»»åŠ¡ï¼Œè¯´æ˜è¿™ä¸ªé˜Ÿåˆ—Aæ˜¯å°å· å¦‚æœAæœ‰ä»»åŠ¡ï¼Œåˆ™ä»é˜Ÿå°¾(base)å–å‡ºæ‰§è¡Œ å¦‚æœAæ²¡æœ‰ä»»åŠ¡ï¼Œåˆ™æ ¹æ®Açš„ownerçº¿ç¨‹æ­£åœ¨joinçš„ä»»åŠ¡,åœ¨æ‹“æ‰‘æ‰¾åˆ°ç›¸å…³çš„é˜Ÿåˆ—Bå»å·å–ä»»åŠ¡æ‰§è¡Œã€‚ï¼ˆä»£ç å¥½é¸¡å„¿å¤æ‚ï¼‰ 123456do &#123; U.putOrderedObject(w, QCURRENTSTEAL, t); t.doExec(); // clear local tasks too&#125; while (task.status &gt;= 0 &amp;&amp; // å°äº0è¡¨ç¤ºä»»åŠ¡ç»“æŸ w.top != top &amp;&amp; // topä½ç½®ç›¸åŒè¡¨ç¤ºæ²¡forkæ–°çš„å­ä»»åŠ¡åˆ°è‡ªå·±queueä¸Š (t = w.pop()) != null); // topä½ç½®ä¸åŒï¼ŒæŠŠå­ä»»åŠ¡popå‡ºæ¥ã€‚ å¸®å¿™æ‰§è¡Œä»»åŠ¡å®Œæˆåï¼Œå¦‚æœå‘ç°è‡ªå·±çš„é˜Ÿåˆ—æœ‰ä»»åŠ¡äº†(w.base != w.top)ï¼Œåœ¨ä¸å†å¸®åŠ©æ‰§è¡Œä»»åŠ¡äº†ã€‚ å¦åˆ™åœ¨ç­‰å¾…è‡ªå·±çš„joinçš„é‚£ä¸ªä»»åŠ¡ç»“æŸä¹‹å‰ï¼Œå¯ä»¥ä¸æ–­çš„å·å–ä»»åŠ¡æ‰§è¡Œã€‚ 7.4.2.3. tryCompensateå¦‚æœè‡ªå·±ç­‰å¾…çš„ä»»åŠ¡è¢«å·èµ°æ‰§è¡Œè¿˜æ²¡ç»“æŸ,è‡ªå·±çš„é˜Ÿåˆ—è¿˜æœ‰ä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›è¡¥å¿ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * Tries to decrement active count (sometimes implicitly) and * possibly release or create a compensating worker in preparation * for blocking. Returns false (retryable by caller), on * contention, detected staleness, instability, or termination. * * @param w caller */private boolean tryCompensate(WorkQueue w) &#123; boolean canBlock; WorkQueue[] ws; long c; int m, pc, sp; if (w == null || w.qlock &lt; 0 || // caller terminating (ws = workQueues) == null || (m = ws.length - 1) &lt;= 0 || (pc = config &amp; SMASK) == 0) // parallelism disabled canBlock = false; else if ((sp = (int)(c = ctl)) != 0) // release idle worker canBlock = tryRelease(c, ws[sp &amp; m], 0L); else &#123; int ac = (int)(c &gt;&gt; AC_SHIFT) + pc; int tc = (short)(c &gt;&gt; TC_SHIFT) + pc; int nbusy = 0; // validate saturation for (int i = 0; i &lt;= m; ++i) &#123; // two passes of odd indices WorkQueue v; if ((v = ws[((i &lt;&lt; 1) | 1) &amp; m]) != null) &#123; if ((v.scanState &amp; SCANNING) != 0) break; ++nbusy; &#125; &#125; if (nbusy != (tc &lt;&lt; 1) || ctl != c) canBlock = false; // unstable or stale else if (tc &gt;= pc &amp;&amp; ac &gt; 1 &amp;&amp; w.isEmpty()) &#123; long nc = ((AC_MASK &amp; (c - AC_UNIT)) | (~AC_MASK &amp; c)); // uncompensated canBlock = U.compareAndSwapLong(this, CTL, c, nc); &#125; else if (tc &gt;= MAX_CAP || (this == common &amp;&amp; tc &gt;= pc + commonMaxSpares)) throw new RejectedExecutionException( \"Thread limit exceeded replacing blocked worker\"); else &#123; // similar to tryAddWorker boolean add = false; int rs; // CAS within lock long nc = ((AC_MASK &amp; c) | (TC_MASK &amp; (c + TC_UNIT))); if (((rs = lockRunState()) &amp; STOP) == 0) add = U.compareAndSwapLong(this, CTL, c, nc); unlockRunState(rs, rs &amp; ~RSLOCK); canBlock = add &amp;&amp; createWorker(); // throws on exception &#125; &#125; return canBlock;&#125; å¦‚æœ ((sp = (int)(c = ctl)) != 0) è¯´æ˜è¿˜æœ‰ idle workeråˆ™å¯ä»¥é€‰æ‹©å”¤é†’çº¿ç¨‹æ›¿ä»£è‡ªå·±,æŒ‚èµ·è‡ªå·±ç­‰å¾…ä»»åŠ¡æ¥å”¤é†’è‡ªå·±ã€‚ å¦‚æœæ²¡æœ‰idle worker åˆ™é¢å¤–åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹æ›¿ä»£è‡ªå·±,æŒ‚èµ·è‡ªå·±ç­‰å¾…ä»»åŠ¡æ¥å”¤é†’è‡ªå·±ã€‚ 8. åè®°å¾ˆå¤šæ²¡ç»†çœ‹ï¼Œäº†è§£ä¸€ä¸‹æ€è·¯å°±æ²¡äº† = =","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]ScheduledThreadPoolExecutor","slug":"JavaåŸºç¡€-ScheduledThreadPoolExecutor","date":"2018-09-02T02:56:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"967765342.html","link":"","permalink":"https://htchz.cc/967765342.html","excerpt":"æåˆ°å®šæ—¶ä»»åŠ¡ï¼Œå°±ä¼šæƒ³åˆ°Quartzï¼Œäº‹å®ä¸ŠQuartzèµ·åˆ°äº†è°ƒåº¦çš„ä½œç”¨ï¼ŒçœŸæ­£çš„æ‰§è¡Œè€…è¿˜æ˜¯JDKçš„ScheduledThreadPoolExecutor","text":"æåˆ°å®šæ—¶ä»»åŠ¡ï¼Œå°±ä¼šæƒ³åˆ°Quartzï¼Œäº‹å®ä¸ŠQuartzèµ·åˆ°äº†è°ƒåº¦çš„ä½œç”¨ï¼ŒçœŸæ­£çš„æ‰§è¡Œè€…è¿˜æ˜¯JDKçš„ScheduledThreadPoolExecutor Javaæä¾›çš„Timeç±»å¯ä»¥å‘¨æœŸæ€§åœ°æˆ–è€…å»¶æœŸæ‰§è¡Œä»»åŠ¡ï¼Œä½†æ˜¯æœ‰æ—¶æˆ‘ä»¬éœ€è¦å¹¶è¡Œæ‰§è¡ŒåŒæ ·çš„ä»»åŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœåˆ›å»ºå¤šä¸ªTimeå¯¹è±¡ä¼šç»™ç³»ç»Ÿå¸¦æ¥è´Ÿæ‹…ï¼Œè§£å†³åŠæ³•æ˜¯å°†å®šæ—¶ä»»åŠ¡æ”¾åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚ Timerçš„ä»»åŠ¡æŒ‚äº†ä¼šè®©å…¶ä»–ä¸æƒ³å¹²çš„ä»»åŠ¡æŒ‚æ‰çš„ã€‚ ScheduledThreadPoolExecutorç±»å®ç°äº†ScheduledExecutorServiceæ¥å£ï¼Œç»§æ‰¿äº†ThreadPoolExecutorï¼Œä¸»è¦æ˜¯åˆ©ç”¨å»¶è¿Ÿé˜Ÿåˆ—çš„ç‰¹æ€§æ¥å®ç°å»¶è¿Ÿæ‰§è¡Œã€‚ 1. ScheduledExecutorService12345678910111213141516171819public interface ScheduledExecutorService extends ExecutorService &#123; public ScheduledFuture&lt;?&gt; schedule(Runnable command, long delay, TimeUnit unit); public &lt;V&gt; ScheduledFuture&lt;V&gt; schedule(Callable&lt;V&gt; callable, long delay, TimeUnit unit); public ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, long initialDelay, long period, TimeUnit unit); public ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, long initialDelay, long delay, TimeUnit unit);&#125; scheduleæ–¹æ³•éœ€è¦æä¾›ä¸€ä¸ªå»¶è¿Ÿçš„æ—¶é—´ï¼Œå¯ä»¥ä¼ å…¥Runnableæˆ–è€…Callableï¼Œä¸åŒäºThreadPoolExecutorçš„execute(Runnable command)è¿”å›voidï¼Œschedule(Runnable command,...)è¿”å›çš„æ˜¯ä¸€ä¸ªFutureï¼šScheduledFutureã€‚ scheduleAtFixedRateï¼šå‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡ã€‚ scheduleWithFixedDelayï¼šä»¥ç»™å®šçš„å»¶è¿Ÿæ—¶é—´æ‰§è¡Œä»»åŠ¡ï¼Œä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œç­‰å¾…delayæ—¶é—´å†æ‰§è¡Œä¸‹ä¸€ä¸ª 2. ScheduledThreadPoolExecutoräº‹å®ä¸Šï¼ŒScheduledThreadPoolExecutorçš„æ„é€ æ–¹æ³•éƒ½æ˜¯å¦‚ä¸‹è°ƒç”¨äº†super(â€¦) 1234567891011121314151617181920212223public ScheduledThreadPoolExecutor(int corePoolSize) &#123; super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new DelayedWorkQueue());&#125;public ScheduledThreadPoolExecutor(int corePoolSize, ThreadFactory threadFactory) &#123; super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new DelayedWorkQueue(), threadFactory);&#125;public ScheduledThreadPoolExecutor(int corePoolSize, RejectedExecutionHandler handler) &#123; super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new DelayedWorkQueue(), handler);&#125;public ScheduledThreadPoolExecutor(int corePoolSize, ThreadFactory threadFactory, RejectedExecutionHandler handler) &#123; super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new DelayedWorkQueue(), threadFactory, handler);&#125; å¯ä»¥çœ‹åˆ°ä¸èƒ½å®šåˆ¶BlockingQueueï¼Œåªèƒ½ç”¨å†…ç½®çš„DelayedWorkQueue 3. ScheduledFutureTaskä¸Šä¸€ç¯‡è¯´åˆ°submit(Runnabel task)ä¼šå°†ä»»åŠ¡å°è£…ï¼Œè¿™é‡ŒåŒæ ·æ˜¯æ˜¯å°è£…ï¼Œè€Œä¸”ä¸è®ºæ˜¯Callableè¿˜æ˜¯Runnableã€‚ 12345678910111213141516171819private class ScheduledFutureTask&lt;V&gt; extends FutureTask&lt;V&gt; implements RunnableScheduledFuture&lt;V&gt; &#123; // ä»»åŠ¡åºå· private final long sequenceNumber; // ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ private long time; // 0ï¼šä¸é‡å¤ // æ­£æ•°ï¼Œå›ºå®šå‘¨æœŸï¼Œå³scheduleAtFixedRate // è´Ÿæ•°ï¼Œå›ºå®šå»¶è¿Ÿï¼Œå³scheduleWithFixedDelay private final long period; /** The actual task to be re-enqueued by reExecutePeriodic */ RunnableScheduledFuture&lt;V&gt; outerTask = this; // è¿™é‡Œçœ‹å‡ºä»»åŠ¡é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ä¾æ—§æ˜¯ä¸ªå †ï¼Œè¿™ä¸ªè¡¨ç¤ºåœ¨ä»»åŠ¡é˜Ÿåˆ—çš„æ•°ç»„ä¸‹æ ‡ int heapIndex; æ„é€ æ–¹æ³• 1234567891011121314151617181920212223242526272829/** * Creates a one-shot action with given nanoTime-based trigger time. */ScheduledFutureTask(Runnable r, V result, long ns) &#123; super(r, result); this.time = ns; this.period = 0; this.sequenceNumber = sequencer.getAndIncrement();&#125;/** * Creates a periodic action with given nano time and period. */ScheduledFutureTask(Runnable r, V result, long ns, long period) &#123; super(r, result); this.time = ns; this.period = period; this.sequenceNumber = sequencer.getAndIncrement();&#125;/** * Creates a one-shot action with given nanoTime-based trigger time. */ScheduledFutureTask(Callable&lt;V&gt; callable, long ns) &#123; super(callable); this.time = ns; this.period = 0; this.sequenceNumber = sequencer.getAndIncrement();&#125; ç”±äºä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸ªå †ï¼Œå…¥é˜Ÿçš„æ—¶å€™éœ€è¦æ¯”è¾ƒå¤§å°ï¼Œçœ‹compareToæ–¹æ³• 12345678910111213141516171819public int compareTo(Delayed other) &#123; if (other == this) // compare zero if same object return 0; if (other instanceof ScheduledFutureTask) &#123; ScheduledFutureTask&lt;?&gt; x = (ScheduledFutureTask&lt;?&gt;)other; long diff = time - x.time; if (diff &lt; 0) return -1; else if (diff &gt; 0) return 1; // å¦‚æœæ‰§è¡Œæ—¶é—´ç›¸åŒï¼Œåˆ™æŒ‰å…¥é˜Ÿé¡ºåº else if (sequenceNumber &lt; x.sequenceNumber) return -1; else return 1; &#125; long diff = getDelay(NANOSECONDS) - other.getDelay(NANOSECONDS); return (diff &lt; 0) ? -1 : (diff &gt; 0) ? 1 : 0; &#125; 4. ä»»åŠ¡é˜Ÿåˆ—ä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨çš„æ˜¯WorkDelayQueueï¼Œå’ŒPriorityBlockingQueueçš„å®ç°å·®ä¸å¤šï¼Œä¸è¿‡å…ƒç´ çš„å¤§å°æ¯”è¾ƒåªèƒ½ç”¨ä¸Šä¸€èŠ‚å†…ç½®çš„compareTo(Delayed other)æ–¹æ³•ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œæ¯æ¬¡æ·»åŠ å…ƒç´ å®Œæˆä¹‹åä¼šåœ¨ScheduledFutureTaskè®¾ç½®heapIndex 1234private void setIndex(RunnableScheduledFuture&lt;?&gt; f, int idx) &#123; if (f instanceof ScheduledFutureTask) ((ScheduledFutureTask)f).heapIndex = idx;&#125; ç”±äºä»»åŠ¡æŒ‰å·²ç»æŒ‰æ‰§è¡Œæ—¶é—´æ’å¥½åºï¼Œé‚£ä¹ˆé˜Ÿé¦–ä»»åŠ¡è‚¯å®šæ˜¯æœ€è¿«åˆ‡éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚ ScheduledThreadPoolExecutorçš„å»¶è¿Ÿæ‰§è¡Œå®é™…ä¸Šæ˜¯é€šè¿‡DelayWorkQueueçš„é˜»å¡è·å–æ¥å®ç°çš„ï¼Œè¿™éƒ¨åˆ†ä»£ç å’Œå‰é¢DelayQueueçš„å®ç°ä¸€æ¯›ä¸€æ ·ï¼Œä¸ä½œè¯´æ˜ 123456789101112131415161718192021222324252627282930313233public RunnableScheduledFuture&lt;?&gt; take() throws InterruptedException &#123; final ReentrantLock lock = this.lock; lock.lockInterruptibly(); try &#123; for (;;) &#123; RunnableScheduledFuture&lt;?&gt; first = queue[0]; if (first == null) available.await(); else &#123; long delay = first.getDelay(NANOSECONDS); if (delay &lt;= 0) return finishPoll(first); first = null; // don't retain ref while waiting if (leader != null) available.await(); else &#123; Thread thisThread = Thread.currentThread(); leader = thisThread; try &#123; available.awaitNanos(delay); &#125; finally &#123; if (leader == thisThread) leader = null; &#125; &#125; &#125; &#125; &#125; finally &#123; if (leader == null &amp;&amp; queue[0] != null) available.signal(); lock.unlock(); &#125;&#125; 5. æäº¤ä»»åŠ¡submit()æ–¹æ³•ä¾æ—§æ˜¯æä¾›çš„ï¼Œä¸è¿‡æ˜¯ä»¥å»¶è¿Ÿæ—¶é—´ä¸º0çš„æ–¹å¼è°ƒç”¨scheduleæ–¹æ³•ã€‚ 123public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) &#123; return schedule(task, 0, NANOSECONDS);&#125; çœ‹scheduleæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031/** * @throws RejectedExecutionException &#123;@inheritDoc&#125; * @throws NullPointerException &#123;@inheritDoc&#125; */public ScheduledFuture&lt;?&gt; schedule(Runnable command, long delay, TimeUnit unit) &#123; if (command == null || unit == null) throw new NullPointerException(); RunnableScheduledFuture&lt;?&gt; t = decorateTask(command, new ScheduledFutureTask&lt;Void&gt;(command, null, triggerTime(delay, unit))); delayedExecute(t); return t;&#125;/** * @throws RejectedExecutionException &#123;@inheritDoc&#125; * @throws NullPointerException &#123;@inheritDoc&#125; */public &lt;V&gt; ScheduledFuture&lt;V&gt; schedule(Callable&lt;V&gt; callable, long delay, TimeUnit unit) &#123; if (callable == null || unit == null) throw new NullPointerException(); RunnableScheduledFuture&lt;V&gt; t = decorateTask(callable, new ScheduledFutureTask&lt;V&gt;(callable, triggerTime(delay, unit))); delayedExecute(t); return t;&#125; ä¸¤ç§å®ç°å¤§åŒå°å¼‚ï¼Œå¯¹äºRunnableä»»åŠ¡ï¼Œå®é™…ä¸Šnew ScheduledFutureTask&lt;Void&gt;(command, null,triggerTime(delay, unit)));å°è£…æˆäº†ä¸€ä¸ªè¿”å›nullçš„Callableä»»åŠ¡ 12345678910111213ScheduledFutureTask(Runnable r, V result, long ns) &#123; // çˆ¶ç±»æ„é€  super(r, result); this.time = ns; this.period = 0; this.sequenceNumber = sequencer.getAndIncrement();&#125;// ä¸Šé¢çš„superæ„é€ å‡½æ•°public FutureTask(Runnable runnable, V result) &#123; this.callable = Executors.callable(runnable, result); this.state = NEW; // ensure visibility of callable&#125; æ¥ä¸‹æ¥çœ‹çœ‹delayedExecute(t)ä¼šæ ¹æ®æ‰§è¡Œæ—¶é—´æ·»åŠ è¿›æœ‰åºä»»åŠ¡é˜Ÿåˆ— 12345678910111213141516171819202122private void delayedExecute(RunnableScheduledFuture&lt;?&gt; task) &#123; if (isShutdown()) reject(task); else &#123; super.getQueue().add(task); if (isShutdown() &amp;&amp; !canRunInCurrentRunState(task.isPeriodic()) &amp;&amp; remove(task)) task.cancel(false); else // å¥½åƒScheduledThreadPoolExecutorå…¶ä»–åœ°æ–¹æ²¡æœ‰addWorkerçš„ä»£ç ï¼Œè¿™é‡ŒaddWorkeréƒ¨åˆ† ensurePrestart(); &#125;&#125;void ensurePrestart() &#123; int wc = workerCountOf(ctl.get()); if (wc &lt; corePoolSize) addWorker(null, true); else if (wc == 0) addWorker(null, false);&#125; 6. ä»»åŠ¡è¿è¡Œ123456789101112131415161718public boolean isPeriodic() &#123; return period != 0;&#125;public void run() &#123; // æ˜¯å¦å‘¨æœŸæ€§ boolean periodic = isPeriodic(); if (!canRunInCurrentRunState(periodic)) // å–æ¶ˆä»»åŠ¡,å”¤é†’æ‰€æœ‰`get()`è°ƒç”¨ï¼Œä»»åŠ¡ç§»å‡ºé˜Ÿåˆ— cancel(false); else if (!periodic) ScheduledFutureTask.super.run(); // else if (ScheduledFutureTask.super.runAndReset()) &#123; setNextRunTime(); reExecutePeriodic(outerTask); &#125;&#125; ä¸»æµç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š åˆ¤æ–­å½“å‰taskæ˜¯å¦å¯ä»¥æ‰§è¡Œï¼Œå¦‚æœä¸èƒ½æ‰§è¡Œï¼Œè°ƒç”¨cancelæ–¹æ³•å–æ¶ˆtaskæ‰§è¡Œï¼Œå¦åˆ™ï¼Œè·³è½¬åˆ°æ­¥éª¤2ï¼› åˆ¤æ–­å½“å‰taskæ˜¯å¦å‘¨æœŸæ€§ä»»åŠ¡ï¼Œæ˜¯åˆ™è°ƒç”¨çˆ¶ç±»æ™®é€šæ‰§è¡Œè¯¥taskï¼Œå¦åˆ™è·³è½¬åˆ°æ­¥éª¤3ï¼› é‡ç½®çŠ¶æ€ï¼Œè®¡ç®—ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ï¼Œé‡æ–°æŠŠä»»åŠ¡æ·»åŠ åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ï¼Œè®©è¯¥ä»»åŠ¡å¯é‡å¤æ‰§è¡Œ 1234567891011boolean canRunInCurrentRunState(boolean periodic) &#123; // ä¸‹é¢ä¸¤ä¸ªé•¿é•¿çš„ç­–ç•¥æ˜¯å¯ä»¥é€šè¿‡setæ¥ä¿®æ”¹çš„ return isRunningOrShutdown(periodic ? continueExistingPeriodicTasksAfterShutdown : executeExistingDelayedTasksAfterShutdown);&#125;final boolean isRunningOrShutdown(boolean shutdownOK) &#123; int rs = runStateOf(ctl.get()); return rs == RUNNING || (rs == SHUTDOWN &amp;&amp; shutdownOK);&#125; ä¸Šä¸€ç¯‡æ²¡æœ‰è¯´åˆ°runAndReset(),æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£ç  123456789101112131415161718192021222324252627282930protected boolean runAndReset() &#123; if (state != NEW || !UNSAFE.compareAndSwapObject(this, runnerOffset, null, Thread.currentThread())) return false; boolean ran = false; int s = state; try &#123; Callable&lt;V&gt; c = callable; if (c != null &amp;&amp; s == NEW) &#123; try &#123; c.call(); // don't set result ran = true; &#125; catch (Throwable ex) &#123; setException(ex); &#125; // æ²¡æœ‰è°ƒç”¨setResult(...) &#125; &#125; finally &#123; // runner must be non-null until state is settled to // prevent concurrent calls to run() runner = null; // state must be re-read after nulling runner to prevent // leaked interrupts s = state; if (s &gt;= INTERRUPTING) handlePossibleCancellationInterrupt(s); &#125; return ran &amp;&amp; s == NEW;&#125; run()æ–¹æ³•æ˜¯æœ‰setResult(â€¦)çš„è°ƒç”¨ï¼Œæ›´æ–°FutureTaskçš„stateï¼ŒrunAndReset()æ²¡æœ‰è°ƒç”¨ï¼Œåˆ™æ­£å¸¸å®Œæˆçš„æƒ…å†µä¸‹æ˜¯s == NEWã€‚ è¿˜æœ‰ä¸€ç‚¹ï¼Œran==falseçš„æƒ…å†µä¸‹runAndReset()æ˜¯è¿”å›å¤±è´¥çš„ï¼Œæ‰€ä»¥å‡ºå¼‚å¸¸çš„è¯å‘¨æœŸä»»åŠ¡æ˜¯ä¸ä¼šç»§ç»­æ‰§è¡Œçš„ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬ä¸“æ³¨äºè¿™ä¸€éƒ¨åˆ†ä»»åŠ¡é‡å¤æ‰§è¡Œ 1234else if (ScheduledFutureTask.super.runAndReset()) &#123; setNextRunTime(); reExecutePeriodic(outerTask); &#125; 1234567891011121314private void setNextRunTime() &#123; long p = period; // å¤§äº0æ˜¯fixRate if (p &gt; 0) time += p; // å°äº0æ˜¯fixDelay else time = triggerTime(-p);&#125;long triggerTime(long delay) &#123; return now() + ((delay &lt; (Long.MAX_VALUE &gt;&gt; 1)) ? delay : overflowFree(delay));&#125; 123456789void reExecutePeriodic(RunnableScheduledFuture&lt;?&gt; task) &#123; if (canRunInCurrentRunState(true)) &#123; super.getQueue().add(task); if (!canRunInCurrentRunState(true) &amp;&amp; remove(task)) task.cancel(false); else ensurePrestart(); &#125;&#125; 7. ä»»åŠ¡çš„ä¸²è¡Œç°åœ¨æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘çš„çº¿ç¨‹æ‰§è¡Œéœ€è¦2sï¼Œè€Œè¿è¡Œå‘¨æœŸæ˜¯æ˜¯1sï¼Œçº¿ç¨‹æ•°é‡è®¾ç½®5ã€‚é‚£ä¹ˆç¬¬äºŒæ¬¡ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡å¼€å§‹å1sæ‰§è¡Œï¼Œè¿˜æ˜¯ç­‰å¾…ç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œå†æ‰§è¡Œï¼Ÿ çœ‹äº†ä¸Šé¢çš„run()çš„å®ç°åï¼Œå¯ä»¥çœ‹åˆ°reExecutePeriodic(...)æ˜¯åœ¨ç¬¬ä¸€æ¬¡è·‘å®Œä¹‹åï¼Œæ‰æ‰§è¡Œï¼Œä»»åŠ¡æ‰é‡æ–°åŠ å…¥é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥ä¸Šé¢çš„åœºæ™¯æ˜¯ï¼šç¬¬äºŒæ¬¡ä»»åŠ¡éœ€è¦ç­‰å¾…ç¬¬ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œï¼Œæ— è®ºæœ‰å¤šå°‘ç©ºé—²çº¿ç¨‹éƒ½æ— æ³•ä¿è¯ä»»åŠ¡1så‘¨æœŸè¿è¡Œã€‚ 8. å†™åœ¨æœ€åJavaå¥½åƒå¸¸ç”¨çš„å¤šçº¿ç¨‹ç¼–ç¨‹å·¥å…·éƒ½çœ‹å®Œäº†ï¼Œæ„Ÿè§‰ç”¨åˆ°å¤§é‡çš„cas+è‡ªæ—‹+æŒ‚èµ·/å”¤é†’+åŠ é”/è§£é”ã€‚æ„Ÿè§‰ä¸ºäº†åšåˆ°çº¿ç¨‹å®‰å…¨Javaä»˜å‡ºæ€§èƒ½ä»£ä»·æŒºå¤§çš„ã€‚è¿™æ–¹é¢æ˜¯ä¸æ˜¯Goå°±ç¨³çš„å¤šäº†å‘¢ğŸ§Goçš„å®˜æ–¹æœ‰å®šæ—¶ä»»åŠ¡åŒ…cronï¼Œæš‚æ—¶ä¹Ÿä¸æ¸…æ¥šæ˜¯æ€ä¹ˆå®ç°çš„ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]ThreadPoolExecutor","slug":"JavaåŸºç¡€-ThreadPoolExecutor","date":"2018-08-31T04:00:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"1860367337.html","link":"","permalink":"https://htchz.cc/1860367337.html","excerpt":"å‰é¢å·²ç»é“ºå«å¥½ï¼ŒBOSSç™»åœº","text":"å‰é¢å·²ç»é“ºå«å¥½ï¼ŒBOSSç™»åœº 1. çº¿ç¨‹æ± æ€»è§ˆ1.1. çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹çº¿ç¨‹æ± çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå›¾æºï¼Œjavaçš„çº¿ç¨‹æ± æ˜¯æ²¡æœ‰è°ƒåº¦å™¨çš„ã€‚ 1.2. javaçº¿ç¨‹æ± çš„ç»§æ‰¿ä½“ç³»javaçº¿ç¨‹æ± ç›¸å¯¹å‰é¢å‡ ç¯‡å®¹æ˜“çœ‹å¾—å¤šï¼Œå› ä¸ºç”¨äº†ä¸€å †ç°æˆçš„ä¸œè¥¿ğŸ™„ Executoræ¥å£ï¼šExecutoræ¥å£ä¸­å®šä¹‰äº†ä¸€ä¸ªexecuteæ–¹æ³•ï¼Œç”¨æ¥æäº¤çº¿ç¨‹çš„æ‰§è¡Œã€‚ ExecutorServiceï¼šExecutoræ¥å£çš„å­æ¥å£ï¼Œç”¨æ¥ç®¡ç†çº¿ç¨‹çš„æ‰§è¡Œï¼Œæ¯”å¦‚å…³é—­çº¿ç¨‹æ± (shutdown)ç­‰ã€‚ ThreadPoolExecutorï¼šå¤§éƒ¨åˆ†çº¿ç¨‹æ± çš„å®ç°ï¼Œé€šè¿‡ä¸åŒçš„ä¼ å…¥å‚æ•°å®ç°ä¸åŒç‰¹æ€§çš„çº¿ç¨‹æ± ã€‚ ScheduledExecutorServiceï¼šå»¶è¿Ÿæˆ–å‘¨æœŸæ€§çº¿ç¨‹æ± æ¥å£ï¼Œå®šä¹‰äº†å»¶è¿Ÿå’Œå‘¨æœŸæ‰§è¡Œæ¥å£ ScheduledThreadPoolExecutorï¼šå»¶è¿Ÿæˆ–å‘¨æœŸæ€§çº¿ç¨‹æ± å®ç°ã€‚ Executorsï¼šJavaæä¾›çš„ä¸€ä¸ªä¸“é—¨ç”¨äºåˆ›å»ºçº¿ç¨‹æ± çš„å·¥å‚ç±»ï¼ŒExecutorServiceçš„åˆå§‹åŒ–å¯ä»¥ä½¿ç”¨Executorsç±»çš„é™æ€æ–¹æ³•ã€‚ shutdownåªæ˜¯å°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®ä¸ºSHUTWDOWNçŠ¶æ€ï¼Œæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œæ²¡æœ‰è¢«æ‰§è¡Œçš„åˆ™ä¸­æ–­ã€‚è€ŒshutdownNowåˆ™æ˜¯å°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®ä¸ºSTOPï¼Œæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡åˆ™è¢«åœæ­¢ï¼Œæ²¡è¢«æ‰§è¡Œä»»åŠ¡çš„åˆ™è¿”å›ã€‚ 2. ThreadPoolExecutorçº¿ç¨‹æ± çš„æœ‰è®¸å¤šåˆå§‹åŒ–æ–¹å¼ï¼Œæœ€ç»ˆè½åˆ°è¿™ä¸ªæ„é€ å‡½æ•°: 123456789101112131415161718192021222324public ThreadPoolExecutor(int corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•° int maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•° long keepAliveTime, // å¤šä½™çº¿ç¨‹çš„æ´»è·ƒæ—¶é—´ TimeUnit unit, // æ´»è·ƒæ—¶é—´å•ä½ BlockingQueue&lt;Runnable&gt; workQueue, // ä»»åŠ¡é˜Ÿåˆ— ThreadFactory threadFactory, // çº¿ç¨‹å·¥å‚ RejectedExecutionHandler handler) &#123; // ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†çš„æ‰§è¡Œç­–ç•¥ if (corePoolSize &lt; 0 || maximumPoolSize &lt;= 0 || maximumPoolSize &lt; corePoolSize || keepAliveTime &lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this.acc = System.getSecurityManager() == null ? null : AccessController.getContext(); this.corePoolSize = corePoolSize; this.maximumPoolSize = maximumPoolSize; this.workQueue = workQueue; this.keepAliveTime = unit.toNanos(keepAliveTime); this.threadFactory = threadFactory; this.handler = handler;&#125; ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªå±æ€§allowCoreThreadTimeOutï¼Œé€šè¿‡allowCoreThreadTimeOut(boolean)è®¾ç½®ï¼Œè¡¨ç¤ºæ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ˜¯å¦è¦è¶…æ—¶é”€æ¯ï¼Œåæ­£æˆ‘æ˜¯æ²¡è®¾ç½®è¿‡ - - 123456789public void allowCoreThreadTimeOut(boolean value) &#123; if (value &amp;&amp; keepAliveTime &lt;= 0) throw new IllegalArgumentException(\"Core threads must have nonzero keep alive times\"); if (value != allowCoreThreadTimeOut) &#123; allowCoreThreadTimeOut = value; if (value) interruptIdleWorkers(); &#125;&#125; å¯ä»¥é€šè¿‡Executorsç±»å®ä¾‹åŒ–ä¸åŒçš„çº¿ç¨‹æ± ï¼š Executors.newCachedThreadPool Executors.newFixedThreadPool Executors.newWorkStealingPool Executors.newSingleThreadExecutor Executors.newScheduledThreadPool 2.1. ThreadPoolExecutorçš„é‡è¦å±æ€§ corePoolSizeï¼šçº¿ç¨‹çš„æ ¸å¿ƒæ•°é‡ maximumPoolSizeï¼šå½“ä»»åŠ¡é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œæäº¤æ–°ä»»åŠ¡ä¼šåˆ›å»ºæ–°çº¿ç¨‹ï¼Œè¿™ä¸ªå€¼å³æœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œ&gt;=æ ¸å¿ƒçº¿ç¨‹æ•°é‡ keepAliveTimeï¼šè¶…è¿‡æ ¸å¿ƒæ•°é‡æ—¶ï¼Œçº¿ç¨‹çš„æœ€å¤§ç©ºé—²æ—¶é—´/ threadFactoryï¼šåˆ›å»ºçº¿ç¨‹çš„å·¥å‚ç±»ï¼Œé»˜è®¤æ˜¯é»˜è®¤ä¸ºExecutors.DefaultThreadFactoryï¼Œå®šä¹‰äº†çº¿ç¨‹çš„åå­— handlerï¼šæ»¡ä»»åŠ¡é˜Ÿåˆ—æ»¡çº¿ç¨‹æ•°çš„æƒ…å†µä¸‹çš„æ‹’ç»ç­–ç•¥ï¼Œé»˜è®¤ä¸ºAbortPolicy,æŠ›ä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸ ctlï¼šctl æ˜¯ä¸€ä¸ª AtomicInteger ç±»å‹, å®ƒçš„ ä½29ä½ ç”¨äºå­˜æ”¾å½“å‰çš„çº¿ç¨‹æ•°, å› æ­¤ä¸€ä¸ªçº¿ç¨‹æ± åœ¨ç†è®ºä¸Šæœ€å¤§çš„çº¿ç¨‹æ•°æ˜¯ 536870911; é«˜ 3 ä½æ˜¯ç”¨äºè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€, å…¶ä¸­é«˜ä¸‰ä½çš„å€¼å’ŒçŠ¶æ€å¯¹åº”å¦‚ä¸‹: 1234567891011// COUNT_BITS = 32 - 3// å¯ä»¥æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡private static final int RUNNING = -1 &lt;&lt; COUNT_BITS;// ä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡private static final int SHUTDOWN = 0 &lt;&lt; COUNT_BITS;// ä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¸å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡private static final int STOP = 1 &lt;&lt; COUNT_BITS;// è¿‡æ¸¡çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†ï¼Œå½“å‰çº¿ç¨‹æ± å·²ç»æ²¡æœ‰æœ‰æ•ˆçš„çº¿ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹æ± çš„çŠ¶æ€å°†ä¼šTIDYINGï¼Œå¹¶ä¸”å°†è¦è°ƒç”¨terminatedæ–¹æ³•private static final int TIDYING = 2 &lt;&lt; COUNT_BITS;// ç»ˆæ­¢çŠ¶æ€ã€‚terminatedæ–¹æ³•è°ƒç”¨å®Œæˆä»¥åçš„çŠ¶æ€private static final int TERMINATED = 3 &lt;&lt; COUNT_BITS; è¿™äº›çŠ¶æ€æ˜¯æŒ‰ç€å¤§å°æ’åºçš„ï¼Œçº¿ç¨‹çš„ä»£ç è®¸å¤šåœ°æ–¹å°†çŠ¶æ€è¿›è¡Œå¤§å°æ¯”è¾ƒï¼Œå¾—å‡ºçº¿ç¨‹æ± çš„ç»ˆæ­¢çš„ç¨‹åº¦ã€‚ å…¶ä»–å±æ€§ï¼Œæœ‰äº›ä¸Šé¢å·²ç»ä»‹ç»äº†,ä¸»è¦æœ‰ä¸ªç‹¬å é”mainLcok,ç»ˆæ­¢æ¡ä»¶å˜é‡termination,å·¥ä½œçº¿ç¨‹å°è£…workers 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051 public class ThreadPoolExecutor extends AbstractExecutorService &#123; // è¿™ä¸ªæ˜¯ä¸€ä¸ªå¤ç”¨å­—æ®µ, å®ƒå¤ç”¨åœ°è¡¨ç¤ºäº†å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€, å½“å‰çº¿ç¨‹æ•°ä¿¡æ¯. private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0)); // ç”¨äºå­˜æ”¾æäº¤åˆ°çº¿ç¨‹æ± ä¸­, ä½†æ˜¯è¿˜æœªæ‰§è¡Œçš„é‚£äº›ä»»åŠ¡. private final BlockingQueue&lt;Runnable&gt; workQueue; // çº¿ç¨‹æ± å†…éƒ¨é”, å¯¹çº¿ç¨‹æ± å†…éƒ¨æ“ä½œåŠ é”, é˜²æ­¢ç«æ€æ¡ä»¶ // å¯¹ workers å­—æ®µçš„æ“ä½œå‰, éœ€è¦è·å–åˆ°è¿™ä¸ªé”. private final ReentrantLock mainLock = new ReentrantLock(); // ä¸€ä¸ª Set ç»“æ„, åŒ…å«äº†å½“å‰çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰å·¥ä½œçº¿ç¨‹. private final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;(); // æ¡ä»¶å˜é‡, ç”¨äºæ”¯æŒ awaitTermination æ“ä½œ private final Condition termination = mainLock.newCondition(); // è®°å½•çº¿ç¨‹æ± ä¸­æ›¾ç»åˆ°è¾¾è¿‡çš„æœ€å¤§çš„çº¿ç¨‹æ•°. // è¿™ä¸ªå­—æ®µåœ¨è·å– mainLock é”çš„å‰æä¸‹æ‰èƒ½æ“ä½œ. private int largestPoolSize; // è®°å½•å·²ç»å®Œæˆçš„ä»»åŠ¡æ•°. ä»…ä»…å½“å·¥ä½œçº¿ç¨‹ç»“æŸæ—¶æ‰æ›´æ–°æ­¤å­—æ®µ. // è¿™ä¸ªå­—æ®µåœ¨è·å– mainLock é”çš„å‰æä¸‹æ‰èƒ½æ“ä½œ. private long completedTaskCount; // çº¿ç¨‹å·¥å‚. å½“éœ€è¦ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ—¶, è¿™é‡Œç”Ÿæˆ. private volatile ThreadFactory threadFactory; // ä»»åŠ¡æäº¤å¤±è´¥åçš„å¤„ç† handler private volatile RejectedExecutionHandler handler; // ç©ºé—²çº¿ç¨‹çš„ç­‰å¾…ä»»åŠ¡æ—¶é—´, ä»¥çº³ç§’ä¸ºå•ä½. // å½“å½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äº corePoolSize æ—¶, // æˆ–è€… allowCoreThreadTimeOut ä¸ºçœŸæ—¶, çº¿ç¨‹æ‰æœ‰ idle ç­‰å¾…è¶…æ—¶æ—¶é—´, // å¦‚æœè¶…æ—¶åˆ™æ­¤çº¿ç¨‹ä¼šåœæ­¢.; // åä¹‹çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…æ–°ä»»åŠ¡åˆ°æ¥. private volatile long keepAliveTime; // é»˜è®¤ä¸º false. // å½“ä¸º false æ—¶, keepAliveTime ä¸èµ·ä½œç”¨, çº¿ç¨‹æ± ä¸­çš„ core çº¿ç¨‹ä¼šä¸€ç›´å­˜æ´», // å³ä½¿è¿™äº›çº¿ç¨‹æ˜¯ idle çŠ¶æ€. // å½“ä¸º true æ—¶, core çº¿ç¨‹ä½¿ç”¨ keepAliveTime ä½œä¸º idle è¶…æ—¶ // æ—¶é—´æ¥ç­‰å¾…æ–°çš„ä»»åŠ¡. private volatile boolean allowCoreThreadTimeOut; // æ ¸å¿ƒçº¿ç¨‹æ•°. private volatile int corePoolSize; // æœ€å¤§çº¿ç¨‹æ•°. private volatile int maximumPoolSize;&#125; 2.2. æäº¤ä»»åŠ¡è¿™ä¸ªæ–¹æ³•å°±æ˜¯æäº¤ä»»åŠ¡çš„ä¸»æµç¨‹äº†ï¼Œåˆ†ä¸ºä¸‰æ­¥ çº¿ç¨‹æ•°å°äºcorePoolSizeï¼Œå°è¯•æ·»åŠ Workerå¹¶æäº¤ä»»åŠ¡åˆ°ä»»åŠ¡åˆ°worker,trueè¡¨ç¤ºæ ¸å¿ƒçº¿ç¨‹ ä»»åŠ¡å…¥é˜ŸæˆåŠŸï¼ŒäºŒæ¬¡æ ¡éªŒçº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œæ˜¯å¦éœ€è¦æ‹’ç»ä»»åŠ¡æˆ–è€…å¢åŠ worker å¢åŠ å·¥ä½œçº¿ç¨‹ï¼Œfalseè¡¨ç¤ºè¶…æ ¸å¿ƒæ•°é‡çš„çº¿ç¨‹ 12345678910111213141516171819202122232425public void execute(Runnable command) &#123; if (command == null) throw new NullPointerException(); int c = ctl.get(); // step 1 // workerCountOf(c)å–ä½29ä½ if (workerCountOf(c) &lt; corePoolSize) &#123; if (addWorker(command, true)) return; c = ctl.get(); &#125; // step 2 if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; int recheck = ctl.get(); // å¦‚æœä¸åœ¨è¿è¡ŒçŠ¶æ€ä¸”ä»»åŠ¡æœªè¢«æ¶ˆè´¹ï¼Œremove(command)==trueï¼Œåˆ™æ‹’ç»ä»»åŠ¡ if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; // step 3 else if (!addWorker(command, false)) reject(command);&#125; çœ‹addWorker(command, true)å‰ï¼Œçœ‹Workerç±»ï¼Œæ˜¯å¯¹çº¿ç¨‹çš„å°è£…,å®ç°äº†Runnableï¼Œç»§æ‰¿äº†AQSï¼Œæ‰€æœ‰æœ‰é”çš„èƒ½åŠ›ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263 private final class Worker extends AbstractQueuedSynchronizer implements Runnable &#123; private static final long serialVersionUID = 6138294804551838833L; // çº¿ç¨‹å¼•ç”¨ final Thread thread; // åˆ›å»ºçº¿ç¨‹æ—¶å¸¦çš„ä»»åŠ¡ Runnable firstTask; /** Per-thread task counter */ volatile long completedTasks;// æ„é€ æ–¹æ³• Worker(Runnable firstTask) &#123; setState(-1); // inhibit interrupts until runWorker this.firstTask = firstTask; this.thread = getThreadFactory().newThread(this); &#125; /** Delegates main run loop to outer runWorker */ public void run() &#123; runWorker(this); &#125; // Lock methods // // The value 0 represents the unlocked state. // The value 1 represents the locked state.// é0è¡¨ç¤ºè¯¥å·¥ä½œçº¿ç¨‹è¢«å æœ‰ protected boolean isHeldExclusively() &#123; return getState() != 0; &#125; protected boolean tryAcquire(int unused) &#123; if (compareAndSetState(0, 1)) &#123; setExclusiveOwnerThread(Thread.currentThread()); return true; &#125; return false; &#125; protected boolean tryRelease(int unused) &#123; setExclusiveOwnerThread(null); setState(0); return true; &#125; public void lock() &#123; acquire(1); &#125; public boolean tryLock() &#123; return tryAcquire(1); &#125; public void unlock() &#123; release(1); &#125; public boolean isLocked() &#123; return isHeldExclusively(); &#125; void interruptIfStarted() &#123; Thread t; if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) &#123; try &#123; t.interrupt(); &#125; catch (SecurityException ignore) &#123; &#125; &#125; &#125; &#125; 2.3. è¿è¡Œä»»åŠ¡å¯ä»¥çœ‹åˆ°newThread(this)æ–¹æ³•æ˜¯ä¼ å…¥è‡ªèº«ï¼Œæˆ‘ä»¬çœ‹ä»–çš„run()æ–¹æ³•ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253public void run() &#123; runWorker(this);&#125;final void runWorker(Worker w) &#123; Thread wt = Thread.currentThread(); // å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡ Runnable task = w.firstTask; w.firstTask = null; w.unlock(); // allow interrupts boolean completedAbruptly = true; try &#123; è¿™é‡Œå°±æ˜¯çº¿ç¨‹ä¸æ–­æ‹¿ä»»åŠ¡çš„åŸç†ï¼Œé€šè¿‡ä¸€ä¸ªwhileå®ç° while (task != null || (task = getTask()) != null) &#123; w.lock(); // If pool is stopping, ensure thread is interrupted; // if not, ensure thread is not interrupted. This // requires a recheck in second case to deal with // shutdownNow race while clearing interrupt // ä¸€äº›ä¸­æ–­çš„åˆ¤æ–­ï¼Œlock()è°ƒç”¨äº†AQSçš„acquire()æ–¹æ³•ï¼Œä¸­æ–­æ˜¯ä¸ä¼šé‡Šæ”¾é”çš„ if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); try &#123; // å¥½å§ï¼Œé»˜è®¤å®ç°è¿™é‡Œæ˜¯ç©ºçš„ï¼Œå¦‚æœè¦è‡ªå·±å®šä¹‰çº¿ç¨‹æ± å¯ä»¥ beforeExecute(wt, task); Throwable thrown = null; try &#123; // è·‘taskå•¦ task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; // ä¾æ—§ç©ºå®ç° afterExecute(task, thrown); &#125; &#125; finally &#123; task = null; w.completedTasks++; w.unlock(); &#125; &#125; completedAbruptly = false; &#125; finally &#123; processWorkerExit(w, completedAbruptly); &#125;&#125; æ²¡ä»»åŠ¡å¯ä»¥æ‹¿çš„æ—¶å€™ï¼Œå·¥ä½œçº¿ç¨‹å°±ä¼šè·³å‡ºwhileä»è€Œç»ˆæ­¢äº†ï¼Œæ‰€ä»¥æ²¡ä»»åŠ¡çš„æ—¶å€™æƒ³ä¿æŒçº¿ç¨‹ä¸è¢«é”€æ¯ï¼Œå°±å¾—åœ¨getTask()é˜»å¡ï¼Œå…·ä½“åé¢å°èŠ‚ä¼šè®²ã€‚ å½“ä»»åŠ¡æ‹¿å®Œçš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šæ‰§è¡ŒprocessWorkerExit(w, completedAbruptly) 123456789101112131415161718192021222324252627282930private void processWorkerExit(Worker w, boolean completedAbruptly) &#123; // éæ­£å¸¸ç»“æŸï¼ˆæŠ›å¼‚å¸¸äº†ï¼‰ï¼Œé‚£ä¹ˆè¦å‡å»çº¿ç¨‹æ•°é‡è¡¥æ•‘ä¸€ä¸‹ if (completedAbruptly) // If abrupt, then workerCount wasn't adjusted decrementWorkerCount(); final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; completedTaskCount += w.completedTasks; workers.remove(w); &#125; finally &#123; mainLock.unlock(); &#125; tryTerminate(); // æ¸…é™¤çº¿ç¨‹åçš„æ£€æŸ¥ int c = ctl.get(); if (runStateLessThan(c, STOP)) &#123; if (!completedAbruptly) &#123; int min = allowCoreThreadTimeOut ? 0 : corePoolSize; if (min == 0 &amp;&amp; ! workQueue.isEmpty()) min = 1; if (workerCountOf(c) &gt;= min) return; // replacement not needed &#125; // å¦‚æœæ˜¯æ„å¤–ä¸­æ–­ï¼Œä¸”æ ¸å¿ƒå·¥ä½œçº¿ç¨‹ä¸å¤Ÿï¼Œè¦è¡¥å›worker addWorker(null, false); &#125;&#125; è¿™ä¸ªæ–¹æ³•ä¸€å¼€å§‹ä¼šåˆ¤æ–­æ˜¯å¦æ­£å¸¸ç»ˆæ­¢ï¼Œéæ­£å¸¸ç»ˆæ­¢ä¼šæ‰§è¡ŒdecrementWorkerCount()æ¥å‡å°‘å·¥ä½œçº¿ç¨‹æ•°é‡ã€‚ é‚£æ­£å¸¸ç»ˆæ­¢å‘¢æ€ä¹ˆå‡æ•°é‡å‘¢ï¼ŒrunWorkeræ²¡å†™ï¼Œè¿™ä¸€æ­¥éª¤ä¹Ÿæ”¾åˆ°getTask()é‡Œå»æ‰§è¡Œäº† å·¥ä½œçº¿ç¨‹ç»“æŸåï¼Œçœ‹æ˜¯å¦éœ€è¦ç»ˆæ­¢çº¿ç¨‹æ± ï¼ŒtryTerminate() 123456789101112131415161718192021222324252627282930313233 final void tryTerminate() &#123; for (;;) &#123; int c = ctl.get(); // å¦‚æœåœ¨è¿è¡Œï¼Œæˆ–è€…å·²ç»åœ¨ç»ˆæ­¢ä¸­ï¼ˆTIDYINGï¼‰ï¼Œæˆ–è€…åˆšå‘èµ·ç»ˆæ­¢æŒ‡ä»¤ï¼ˆSHUTDOWNï¼‰ä½†æ˜¯ä»»åŠ¡é˜Ÿåˆ—è¿˜æ²¡å®Œï¼ˆisEmptyï¼‰ï¼Œé‚£ä¹ˆä¸éœ€è¦æ‰§è¡Œç»ˆæ­¢çº¿ç¨‹æ± ã€‚ if (isRunning(c) || runStateAtLeast(c, TIDYING) || (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty())) return; if (workerCountOf(c) != 0) &#123; // Eligible to terminate // çº¿ç¨‹æ± SHUTFDOWNï¼Œä»»åŠ¡å¯¹åˆ—å·²ç©ºï¼Œä¸­æ–­æ‰€æœ‰å·¥ä½œçº¿ç¨‹ interruptIdleWorkers(ONLY_ONE); return; &#125; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // casè®¾ç½®ç»ˆæ­¢ä¸­ if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) &#123; try &#123; terminated(); &#125; finally &#123; ctl.set(ctlOf(TERMINATED, 0)); termination.signalAll(); &#125; return; &#125; &#125; finally &#123; mainLock.unlock(); &#125; // caså¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€è½®å§ &#125;&#125; tryTerminate()è¿”å›ä¹‹åï¼Œä¸»æµç¨‹æ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œçœ‹éœ€è¦ä¸éœ€è¦è¡¥å›é”€æ¯çš„å·¥ä½œçº¿ç¨‹ã€‚ ä»¥ä¸Šæ˜¯å·¥ä½œçº¿ç¨‹çš„è¿è¡Œè¿‡ç¨‹ã€‚ 2.4. æ·»åŠ å·¥ä½œçº¿ç¨‹ä¸‹é¢æ˜¯æ·»åŠ addWorkerçš„éƒ¨åˆ† retry:æ˜¯æ ‡ç­¾(Label)è¯­æ³•ï¼Œå¯ä»¥æ‰§è¡Œå¤šå±‚å¾ªç¯çš„breakå’Œcontinue 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374private boolean addWorker(Runnable firstTask, boolean core) &#123; retry: for (;;) &#123; int c = ctl.get(); // è·å–çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; // é€šè¿‡æ§åˆ¶æ•°é‡æ¥é˜²æ­¢å¹¶å‘ if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl // å¦‚æœè¿è¡ŒçŠ¶æ€ä¸ä¸€è‡´äº†ï¼Œé‡æ–°æ‰§è¡Œå¤–å±‚çš„è¿è¡ŒçŠ¶æ€æ ¡éªŒ if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125; &#125; boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try &#123; w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); // rs &lt; SHUTDOWN å³ rs = RUNNING if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); workers.add(w); int s = workers.size(); // æ›´æ–°æœ€å¤§è®°å½• if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; // å¦‚æœæˆåŠŸåˆ›å»ºå¹¶æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆé‡Œï¼Œçº¿ç¨‹å¼€å§‹è·‘ t.start(); workerStarted = true; &#125; &#125; &#125; finally &#123; // å–„åå·¥ä½œ if (! workerStarted) addWorkerFailed(w); &#125; return workerStarted;&#125; è¿”å›å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨ï¼Œå¦çš„æƒ…å†µä¸‹ï¼Œå¤–éƒ¨è°ƒç”¨ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼Œé»˜è®¤æŠ›å¼‚å¸¸ã€‚ 2.5. å·¥ä½œçº¿ç¨‹çš„ idle è¶…æ—¶å¤„ç†åœ¨è¿è¡Œä»»åŠ¡çš„å°èŠ‚ï¼Œæœ‰ä¸ªgetTask()æ–¹æ³•ï¼Œå¦‚æœæ‹¿ä¸åˆ°ä»»åŠ¡ï¼Œé‚£å·¥ä½œçº¿ç¨‹å°±å¾—ç»“æŸäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹çœ‹getTask()çš„ç­–ç•¥æ˜¯ä»€ä¹ˆã€‚ å·¥ä½œçº¿ç¨‹çš„ idle è¶…å‡ºå¤„ç†åœ¨åº•å±‚ä¾èµ–äº BlockingQueue å¸¦è¶…æ—¶çš„ poll æ–¹æ³•, å³å·¥ä½œçº¿ç¨‹ä¼šä¸æ–­åœ°ä» workQueue è¿™ä¸ª BlockingQueue ä¸­è·å–ä»»åŠ¡, å¦‚æœ allowCoreThreadTimeOut å­—æ®µä¸º true, æˆ–è€…å½“å‰çš„å·¥ä½œçº¿ç¨‹æ•°å¤§äº corePoolSize, é‚£ä¹ˆçº¿ç¨‹çš„ idle è¶…æ—¶æœºåˆ¶å°±ç”Ÿæ•ˆäº†, æ­¤æ—¶å·¥ä½œçº¿ç¨‹ä¼šä»¥å¸¦è¶…æ—¶çš„ poll æ–¹å¼ä» workQueue ä¸­è·å–ä»»åŠ¡. å½“è¶…æ—¶äº†è¿˜æ²¡æœ‰è·å–åˆ°ä»»åŠ¡, é‚£ä¹ˆæˆ‘ä»¬å°±çŸ¥é“æ­¤çº¿ç¨‹ä¸€ä¸ªåˆ°è¾¾ idle è¶…æ—¶æ—¶é—´, å› æ­¤ç»ˆæ­¢æ­¤å·¥ä½œçº¿ç¨‹. 12345678910111213141516171819202122232425262728293031323334353637private Runnable getTask() &#123; boolean timedOut = false; // Did the last poll() time out? for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123; decrementWorkerCount(); return null; &#125; int wc = workerCountOf(c); // Are workers subject to culling? boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize; if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c)) return null; continue; &#125; try &#123; Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); // é˜»å¡ if (r != null) return r; timedOut = true; &#125; catch (InterruptedException retry) &#123; timedOut = false; &#125; &#125;&#125; 2.6. Future Future å¯ä»¥æ‹¿åˆ°çº¿ç¨‹æ± ä»»åŠ¡çš„è¿è¡Œç»“æœï¼Œæ˜¯å¯¹ä»»åŠ¡çš„å°è£…ï¼Œ ä»»åŠ¡å¿…éœ€æ˜¯Callableç±»å‹çš„ä»»åŠ¡123456789public interface Callable&lt;V&gt; &#123; /** * Computes a result, or throws an exception if unable to do so. * * @return computed result * @throws Exception if unable to compute a result */ V call() throws Exception;&#125; 123456789101112131415public interface Future&lt;V&gt; &#123; // mayInterruptIfRunning ä»»åŠ¡åœ¨workerè·‘çš„æ—¶å€™æ˜¯å¦èƒ½è¢«å–æ¶ˆ boolean cancel(boolean mayInterruptIfRunning); boolean isCancelled(); boolean isDone(); // é˜»å¡ç›´åˆ°æ‹¿åˆ°è¿è¡Œç»“æœ V get() throws InterruptedException, ExecutionException; // å¸¦è¶…æ—¶çš„get(0 V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException;&#125; ThreadPoolExecutoré€šè¿‡çˆ¶ç±»AbstractExecutorServiceçš„submit(Runnable task)æ–¹æ³•ï¼Œ 123456public Future&lt;?&gt; submit(Runnable task) &#123; if (task == null) throw new NullPointerException(); RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, null); execute(ftask); return ftask;&#125; 123456public FutureTask(Callable&lt;V&gt; callable) &#123; if (callable == null) throw new NullPointerException(); this.callable = callable; this.state = NEW; // ensure visibility of callable&#125; å¯ä»¥çœ‹åˆ°Futureçš„åŸç†æ˜¯ç”¨ä¸€ä¸ªFutureTask(æˆ‘ä»¬è¿™ç¯‡å°±åªçœ‹è¿™ä¸ªç±»)ç±»å¯¹ä»»åŠ¡è¿›è¡Œå°è£…ï¼Œä¸‹é¢æ˜¯ FutureTaskçš„å‡ ä¸ªçŠ¶æ€å’Œä¸€äº›å±æ€§ï¼Œä»å­—é¢ä¸Šå¯ä»¥çœ‹å‡ºå„ä¸ªçŠ¶æ€ä»£è¡¨çš„æ„æ€ï¼Œè¿™å‡ ä¸ªçŠ¶æ€å’Œçº¿ç¨‹æ± çš„çŠ¶æ€ä¸€æ ·æ˜¯å¤§å°ä¸æ˜¯éšä¾¿å®šçš„ 12345678910111213141516171819202122/** * Possible state transitions: * NEW -&gt; COMPLETING -&gt; NORMAL * NEW -&gt; COMPLETING -&gt; EXCEPTIONAL * NEW -&gt; CANCELLED * NEW -&gt; INTERRUPTING -&gt; INTERRUPTED */ private volatile int state; private static final int NEW = 0; private static final int COMPLETING = 1; private static final int NORMAL = 2; private static final int EXCEPTIONAL = 3; private static final int CANCELLED = 4; private static final int INTERRUPTING = 5; private static final int INTERRUPTED = 6; // è¿è¡Œè¿™ä¸ªrunçš„çº¿ç¨‹ï¼Œå³çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹ private volatile Thread runner; // è°ƒç”¨äº†get()çš„ç­‰å¾…çº¿ç¨‹ï¼Œæ˜¯ä¸ªé“¾è¡¨ private volatile WaitNode waiters; 2.6.1. è¿è¡Œä»»åŠ¡å½“çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹çš„è¿è¡Œä»»åŠ¡çš„run()çš„çš„æ—¶å€™ï¼ŒFutureTaskå°±ä¼šè°ƒç”¨ä»»åŠ¡çš„call()ï¼Œå¹¶å°†å­˜å‚¨è¿è¡Œç»“æœã€‚ æˆ‘ä»¬çœ‹FutureTaskçš„run()æ–¹æ³• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public void run() &#123; // æ²¡æœ‰äººç»ˆæ­¢ä»»åŠ¡ï¼Œstateä¾æ—§æ˜¯NEWï¼Œåˆ™casè®¾ç½®å·¥ä½œçº¿ç¨‹ï¼Œå¤±è´¥åˆ™ç›´æ¥ç»“æŸ if (state != NEW || !UNSAFE.compareAndSwapObject(this, runnerOffset, null, Thread.currentThread())) return; try &#123; Callable&lt;V&gt; c = callable; if (c != null &amp;&amp; state == NEW) &#123; V result; boolean ran; try &#123; result = c.call(); ran = true; &#125; catch (Throwable ex) &#123; result = null; ran = false; // å¼‚å¸¸å®Œæˆçš„å¤„ç†æ–¹å¼ setException(ex); &#125; if (ran) // æ­£å¸¸å®Œæˆï¼Œæ›´æ–°çŠ¶æ€ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ set(result); &#125; &#125; finally &#123; // runner must be non-null until state is settled to // prevent concurrent calls to run() runner = null; // state must be re-read after nulling runner to prevent // leaked interrupts int s = state; // å¦‚æœä»»åŠ¡è¢«å–æ¶ˆï¼Œè°ƒç”¨Thread.yield();ç›´åˆ°å–„åå·¥ä½œåšå®Œï¼ŒçŠ¶æ€å˜æˆINTERRUPTED if (s &gt;= INTERRUPTING) handlePossibleCancellationInterrupt(s); &#125;&#125;// protected void set(V v) &#123; if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) &#123; outcome = v; UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state // æ›´æ–°çŠ¶æ€ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ finishCompletion(); &#125;&#125; 2.6.2. ä»»åŠ¡å®Œæˆä»»åŠ¡å®Œæˆçš„æ–¹æ³•ï¼Œåªæœ‰å››ç§ï¼šæ­£å¸¸ã€å¼‚å¸¸ã€å–æ¶ˆã€ä¸­æ–­å·¥ä½œçº¿ç¨‹ï¼Œæ¯ç§åˆ†åˆ«è°ƒç”¨set(result),setException(ex),cancel(boolean)ï¼Œå…¶ä¸­å–æ¶ˆå’Œä¸­æ–­éƒ½æ˜¯è°ƒç”¨cancel(boolean)ï¼Œé€šè¿‡å‚æ•°æ§åˆ¶ï¼Œè¿™å‡ ç§æ–¹æ³•éƒ½ä¼šè°ƒç”¨finishCompletion(),é€ä¸€å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ï¼ˆæ¯”å¦‚ä¸Šé¢set(V v)çš„è°ƒç”¨ï¼‰ 1234567891011121314151617181920212223242526private void finishCompletion() &#123; // assert state &gt; COMPLETING; for (WaitNode q; (q = waiters) != null;) &#123; // å°†æ•´ä¸ªwaitersé“¾è¡¨å¼•ç”¨ç½®ä¸ºnullï¼Œæ–¹ä¾¿gc if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) &#123; // ä¸€ä¸€å”¤é†’ for (;;) &#123; Thread t = q.thread; if (t != null) &#123; q.thread = null; LockSupport.unpark(t); &#125; WaitNode next = q.next; if (next == null) break; q.next = null; // unlink to help gc q = next; &#125; break; &#125; &#125; // é¢„ç•™ç»™å­ç±»çš„ç©ºå‡½æ•° done(); callable = null; // to reduce footprint&#125; 2.6.3. è·å–ç»“æœæŒºå®¹æ˜“ç†è§£çš„ä»£ç ï¼Œæ¥ä¸‹æ¥çœ‹get() 1234567public V get() throws InterruptedException, ExecutionException &#123; int s = state; if (s &lt;= COMPLETING) // 0Læ˜¯æ— è¶…æ—¶æ—¶é—´ s = awaitDone(false, 0L); return report(s);&#125; å¦‚æœget()è°ƒç”¨çš„æ—¶å€™s &lt;= COMPLETING,å³æœªç»ˆæ­¢æˆ–è€…æœªå®Œæˆï¼Œåˆ™è°ƒç”¨awaitDone(false, 0L)ï¼Œ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374// é“¾è¡¨ï¼Œå› ä¸ºget()å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œæ‰€ä»¥ç»´æŠ¤ä¸€ä¸ªé“¾è¡¨æ¥å­˜å‚¨è¿™äº›çº¿ç¨‹ã€‚ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼ˆæ— è®ºæ„å¤–è¿˜æ˜¯æ­£å¸¸ï¼‰ä¼šè°ƒç”¨`finishCompletion()`å”¤é†’æ‰€æœ‰è¿˜åœ¨æŒ‚èµ·çš„çº¿ç¨‹// è¿™æ˜¯ä¸€ä¸ªæ–°èŠ‚ç‚¹æ’åœ¨å¤´éƒ¨çš„é“¾è¡¨static final class WaitNode &#123; volatile Thread thread; volatile WaitNode next; WaitNode() &#123; thread = Thread.currentThread(); &#125;&#125;// å°†çº¿ç¨‹ä»åˆ—è¡¨private void removeWaiter(WaitNode node) &#123; // node == null ä»€ä¹ˆéƒ½ä¸åš if (node != null) &#123; node.thread = null; retry: for (;;) &#123; // restart on removeWaiter race for (WaitNode pred = null, q = waiters, s; q != null; q = s) &#123; s = q.next; if (q.thread != null) pred = q; else if (pred != null) &#123; pred.next = s; if (pred.thread == null) // check for race continue retry; &#125; else if (!UNSAFE.compareAndSwapObject(this, waitersOffset, q, s)) continue retry; &#125; break; &#125; &#125;&#125;private int awaitDone(boolean timed, long nanos) throws InterruptedException &#123; final long deadline = timed ? System.nanoTime() + nanos : 0L; WaitNode q = null; boolean queued = false; for (;;) &#123; // å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ if (Thread.interrupted()) &#123; removeWaiter(q); throw new InterruptedException(); &#125; int s = state; if (s &gt; COMPLETING) &#123; if (q != null) q.thread = null; return s; &#125; else if (s == COMPLETING) // cannot time out yet Thread.yield(); else if (q == null) q = new WaitNode(); else if (!queued) // å¾ˆèŠ±å“¨åœ°æŠŠæ–°åœ°é˜»å¡çº¿ç¨‹èŠ‚ç‚¹æ”¾åˆ°é“¾è¡¨å¤´ queued = UNSAFE.compareAndSwapObject(this, waitersOffset, q.next = waiters, q); // è®¾ç½®äº†è¶…æ—¶çš„æŒ‚èµ·æ–¹å¼ else if (timed) &#123; nanos = deadline - System.nanoTime(); if (nanos &lt;= 0L) &#123; removeWaiter(q); return state; &#125; // å®šæ—¶æŒ‚èµ· LockSupport.parkNanos(this, nanos); &#125; else // æ— é™æŒ‚èµ·ï¼Œç›´åˆ°å®Œæˆå”¤é†’ LockSupport.park(this); &#125;&#125;","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]BlockingQueue","slug":"JavaåŸºç¡€-BlockingQueue","date":"2018-08-28T12:54:00.000Z","updated":"2019-08-21T06:45:32.901Z","comments":true,"path":"3516892559.html","link":"","permalink":"https://htchz.cc/3516892559.html","excerpt":"javaçš„BlockingQueueè§£è¯»","text":"javaçš„BlockingQueueè§£è¯» Javaçš„BlockingQueueæœ‰ä»¥ä¸‹ ArrayBlockingQueue LinkedBlockingQueue SynchronousQueue PriorityBlockingQueue DelayQueue å¯¹äº BlockingQueueï¼Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹åº”è¯¥åœ¨ put(e) å’Œ take() è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯å¸¦é˜»å¡çš„ã€‚ 1. ArrayBlockingQueue1234567891011121314151617181920212223242526/** The queued items */final Object[] items;/** items index for next take, poll, peek or remove */int takeIndex;/** items index for next put, offer, or add */int putIndex;/** Number of elements in the queue */int count;/* * Concurrency control uses the classic two-condition algorithm * found in any textbook. *//** Main lock guarding all access */// åªæœ‰ä¸€ä¸ªé”final ReentrantLock lock;/** Condition for waiting takes */private final Condition notEmpty;/** Condition for waiting puts */private final Condition notFull; ä¸Šä¸€èŠ‚è®²è¿‡å®ç°ï¼Œå…ˆç•¥è¿‡ã€‚ æ³¨æ„ï¼š è¿™æ˜¯ä¸€ä¸ªå¾ªç¯æ•°ç»„ï¼ŒputIndexã€takeIndexåœ¨ç­‰äºitems.lengthçš„æ—¶å€™ä¼šé‡ç½®ä¸º0 ç”¨çš„æ‚²è§‚é”ï¼Œtake()å’Œput()ä¸èƒ½å¹¶è¡Œæ‰§è¡Œã€‚ 2. LinkedBlockingQueue12345678910111213141516171819202122232425262728293031323334353637383940414243444546/** * Linked list node class */static class Node&lt;E&gt; &#123; E item; /** * One of: * - the real successor Node * - this Node, meaning the successor is head.next * - null, meaning there is no successor (this is the last node) */ Node&lt;E&gt; next; Node(E x) &#123; item = x; &#125;&#125;/** The capacity bound, or Integer.MAX_VALUE if none */private final int capacity;/** Current number of elements */private final AtomicInteger count = new AtomicInteger();/** * Head of linked list. * Invariant: head.item == null */transient Node&lt;E&gt; head;/** * Tail of linked list. * Invariant: last.next == null */private transient Node&lt;E&gt; last;/** Lock held by take, poll, etc */private final ReentrantLock takeLock = new ReentrantLock();/** Wait queue for waiting takes */private final Condition notEmpty = takeLock.newCondition();/** Lock held by put, offer, etc */private final ReentrantLock putLock = new ReentrantLock();/** Wait queue for waiting puts */private final Condition notFull = putLock.newCondition(); å¯ä»¥æœ‰ç•Œå¯ä»¥æ— ç•Œï¼ˆæ— ç•Œå…¶å®å®¹é‡ä¸ºInteger.MAX_VALUEï¼‰ï¼Œä¾æ—§ç•¥è¿‡ã€‚ æ³¨æ„ï¼š ç”¨äº†åˆ†ç¦»çš„ä¸¤ä¸ªç‹¬å é”ï¼Œput()å’Œtake()å¯å¹¶è¡Œæ‰§è¡Œ æƒ³ä¸é€šä¸ºä»€ä¹ˆArrayBlockingQueueä¸ä½¿ç”¨åˆ†ç¦»çš„é”ï¼Œè¿™é‡Œè¯´æ˜¯å› ä¸ºQueueæ¥å£ç»§æ‰¿äº†Collectionæ¥å£ï¼Œæ‰€ä»¥å¾ªç¯æ•°ç»„è¿­ä»£åœ¨åŒé”ä¸‹è¿­ä»£æ¯”è¾ƒå¤æ‚ = = 2.1. ArrayBlockingQueueå’ŒLinkedBlockingQueueå¯¹æ¯” ArrayBlockingQueueå ç”¨å†…å­˜å°ï¼Œä½†æ˜¯ä¸èƒ½å¹¶è¡Œç”Ÿäº§æ¶ˆè´¹ï¼Œéœ€è¦ç¡®å®šå¥½é˜Ÿåˆ—å®¹é‡ LinkedBlockingQueueå ç”¨å†…å­˜å¤§ï¼Œä½†æ˜¯å¯ä»¥å¹¶è¡Œç”Ÿäº§æ¶ˆè´¹ï¼Œå¯ä»¥ä¸æŒ‡å®šé˜Ÿåˆ—å®¹é‡ 3. SynchronousQueueè¿™ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¾€é˜Ÿåˆ—ä¸­å†™å…¥ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå†™å…¥æ“ä½œä¸ä¼šç«‹å³è¿”å›ï¼Œéœ€è¦ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ¥å°†è¿™ä¸ªå…ƒç´ æ‹¿èµ°ï¼›åŒç†ï¼Œå½“ä¸€ä¸ªè¯»çº¿ç¨‹åšè¯»æ“ä½œçš„æ—¶å€™ï¼ŒåŒæ ·éœ€è¦ä¸€ä¸ªç›¸åŒ¹é…çš„å†™çº¿ç¨‹çš„å†™æ“ä½œã€‚è¿™é‡Œçš„ Synchronous æŒ‡çš„å°±æ˜¯è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹éœ€è¦åŒæ­¥ï¼Œä¸€ä¸ªè¯»çº¿ç¨‹åŒ¹é…ä¸€ä¸ªå†™çº¿ç¨‹ã€‚ è¿™è®©æˆ‘æƒ³åˆ°goä¸å¸¦ç¼“å†²çš„channelä¹Ÿæœ‰è¿™ç§ç‰¹ç‚¹ SynchronousQueueä¸æä¾›ä»»ä½•ç©ºé—´æ¥å­˜å‚¨å…ƒç´ ï¼ˆå®ƒå­˜åœ¨ä¸€ä¸ªnodeå…ƒç´ é‡Œï¼‰ï¼Œpeek()è¿”å›çš„æ˜¯nullï¼Œå’Œå…¶ä»–å¹¶å‘å®¹å™¨ä¸€æ ·ä¸å…è®¸æ’å…¥nullã€‚ 1234567// æŒ‡å®šå…¬å¹³æ¨¡å¼è¿˜æ˜¯éå…¬å¹³æ¨¡å¼public SynchronousQueue(boolean fair) &#123; transferer = fair ? new TransferQueue() : new TransferStack();&#125;abstract static class Transferer &#123; abstract Object transfer(Object e, boolean timed, long nanos);&#125; è¿™é‡Œé¢éœ€è¦è¯´æ˜ä¸€ä¸‹çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ®å‚æ•°eæ¥åŒºåˆ†è°ƒç”¨æ–¹æ³•çš„æ˜¯ä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹è¿˜æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå¦‚æœeä¸ºnullï¼Œåˆ™è¯´æ˜è¿™æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œæ¯”å¦‚ä¸€ä¸ªtakeæ“ä½œï¼Œå¦‚æœeä¸ä¸ºnullï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹ï¼Œè¿™ä¸ªæ•°æ®å°±æ˜¯è¿™ä¸ªçº¿ç¨‹éœ€è¦äº¤ä»˜çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸€ä¸ªputæ“ä½œã€‚SynchronousQueueæœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„Transfererå®ç°ï¼Œä¸€ç§ä¸ºå…¬å¹³äº¤æ˜“ç±»å‹ï¼Œä¸€ç§ä¸ºéå…¬å¹³äº¤æ˜“ç±»å‹ï¼Œå…¬å¹³äº¤æ˜“ç±»å‹çš„å®ç°ç±»ä¸ºTransferQueueï¼Œå®ƒä½¿ç”¨é˜Ÿåˆ—æ¥ä½œä¸ºäº¤æ˜“åª’ä»‹ï¼Œè¯·æ±‚äº¤æ˜“çš„çº¿ç¨‹æ€»æ˜¯å…ˆå°è¯•è·Ÿé˜Ÿåˆ—å¤´éƒ¨ï¼ˆæˆ–è€…å°¾éƒ¨ï¼‰çš„çº¿ç¨‹è¿›è¡Œäº¤æ˜“ï¼Œå¦‚æœå¤±è´¥å†å°†è¯·æ±‚çš„çº¿ç¨‹æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œè€Œéå…¬å¹³ç±»å‹çš„å®ç°ç±»ä¸ºTransferStackï¼Œå®ƒä½¿ç”¨ä¸€ä¸ªstackæ¥ä½œä¸ºäº¤æ˜“åª’ä»‹ï¼Œè¯·æ±‚äº¤æ˜“çš„çº¿ç¨‹æ€»æ˜¯è¯•å›¾ä¸æ ˆé¡¶çº¿ç¨‹è¿›è¡Œäº¤æ˜“ï¼Œå¤±è´¥åˆ™æ·»åŠ åˆ°æ ˆé¡¶ã€‚æ‰€ä»¥SynchronousQueueå°±æ˜¯ä½¿ç”¨é˜Ÿåˆ—å’Œæ ˆä¸¤ç§æ•°æ®ç»“æ„æ¥æ¨¡æ‹Ÿå…¬å¹³äº¤æ˜“å’Œéå…¬å¹³äº¤æ˜“çš„ã€‚ä¸‹é¢åˆ†åˆ«å¯¹ä¸¤ç§äº¤æ˜“ç±»å‹è¿›è¡Œåˆ†æã€‚ çœ‹put()å’Œtake() 12345678910111213141516// å†™å…¥å€¼public void put(E o) throws InterruptedException &#123; if (o == null) throw new NullPointerException(); if (transferer.transfer(o, false, 0) == null) &#123; // 1 Thread.interrupted(); throw new InterruptedException(); &#125;&#125;// è¯»å–å€¼å¹¶ç§»é™¤public E take() throws InterruptedException &#123; Object e = transferer.transfer(null, false, 0); // 2 if (e != null) return (E)e; Thread.interrupted(); throw new InterruptedException();&#125; 3.1. å…¬å¹³æ¨¡å¼å¯ä»¥çœ‹åˆ°ç”¨çš„æ˜¯åŒä¸€ä¸ªæ–¹æ³•ï¼Œæ ¹æ®nullæˆ–éç©ºobjectæ¥åˆ¤æ–­å‡ºé˜Ÿæˆ–è€…å…¥é˜Ÿã€‚ æˆ‘ä»¬çœ‹çœ‹ä»–çš„ç­‰å¾…é˜Ÿåˆ—çš„å®ç°æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ç­‰å¾…é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ï¼Œè¿˜å¸¦æœ‰ä¸€äº›CASæ–¹æ³• 12345678910111213/** Node class for TransferQueue. */static final class QNode &#123; volatile QNode next; // å•é“¾è¡¨ volatile Object item; // CAS'ed to or from null volatile Thread waiter; // æŒ‚èµ·ã€å”¤èµ·çº¿ç¨‹ final boolean isData; QNode(Object item, boolean isData) &#123; this.item = item; this.isData = isData; &#125; ... &#125; å…³äºè¿™ä¸ªitemï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨æ¥åŒ¹é…çš„å…³é”®å­—ï¼Œç§°ä½œmatch å½“tryCancel(e)ï¼Œè¢«è°ƒç”¨æ—¶ï¼Œå®ƒè¢«casæˆèŠ‚ç‚¹æœ¬èº« å½“æ¶ˆè´¹è€…è¿›å…¥transferå‡ºé˜Ÿæ—¶ï¼Œè¢«å‡ºé˜Ÿçš„èŠ‚ç‚¹çš„itemè¢«casæˆnull å½“ç”Ÿäº§è€…è¿›å…¥transferå…¥é˜Ÿæ—¶ï¼Œè¢«å…¥é˜Ÿçš„èŠ‚ç‚¹çš„itemè¢«casæˆEï¼ˆç”Ÿäº§å…ƒç´ ï¼‰ é€šå¸¸åŸæ¥çš„caså‰çš„å€¼ä¼šè¢«ä¿å­˜èµ·æ¥ï¼Œè¿”å›åˆ°æ–¹æ³•è°ƒç”¨ä¸Šå±‚ä»¥ä¾›åˆ¤æ–­å½“å‰å¤„äºä»€ä¹ˆæƒ…å†µã€‚ æ¥ä¸‹æ¥çœ‹transferæ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495 E transfer(E e, boolean timed, long nanos) &#123; /* Basic algorithm is to loop trying to take either of * two actions: * * 1. If queue apparently empty or holding same-mode nodes, * try to add node to queue of waiters, wait to be * fulfilled (or cancelled) and return matching item. * * 2. If queue apparently contains waiting items, and this * call is of complementary mode, try to fulfill by CAS'ing * item field of waiting node and dequeuing it, and then * returning matching item. * * In each case, along the way, check for and try to help * advance head and tail on behalf of other stalled/slow * threads. * * The loop starts off with a null check guarding against * seeing uninitialized head or tail values. This never * happens in current SynchronousQueue, but could if * callers held non-volatile/final ref to the * transferer. The check is here anyway because it places * null checks at top of loop, which is usually faster * than having them implicitly interspersed. */// ç´¢å¼•è¦æ’å…¥çš„èŠ‚ç‚¹ QNode s = null; // constructed/reused as needed // æ˜¯å¦å†™å…¥ boolean isData = (e != null); for (;;) &#123; QNode t = tail; QNode h = head; if (t == null || h == null) // saw uninitialized value continue; // spin // ç©ºæˆ–è€…å·²æœ‰nodeå’Œæ–°çš„nodeæ¨¡å¼ä¸€è‡´ï¼Œåˆ™æ’å…¥ if (h == t || t.isData == isData) &#123; QNode tn = t.next; // è„è¯»ï¼Œå·²ç»ä¸æ˜¯é˜Ÿå°¾ if (t != tail) continue; // é˜Ÿå°¾çš„nextæŒ‡é’ˆå·²ç»å¹¶å‘è¢«è®¾ç½®ï¼Œæå‰å°†æ–°å…ƒç´ ç½®ä¸ºé˜Ÿå°¾ï¼Œç»§ç»­è‡ªæ—‹ if (tn != null) &#123; advanceTail(t, tn); continue; &#125; // è¶…æ—¶ if (timed &amp;&amp; nanos &lt;= 0) return null; // åˆå§‹æ–°æ¥çš„å°è€å¼Ÿ if (s == null) s = new QNode(e, isData); // caså°†æ–°æ¥çš„å°è€å¼Ÿæ”¾åˆ°é˜Ÿå°¾nextæŒ‡é’ˆ if (!t.casNext(null, s)) continue; // æå‰å°†é˜Ÿå°¾ç½®ä¸ºå°è€å¼Ÿ advanceTail(t, s); // é˜»å¡è‡³æœ‰äººåŒ¹é…ï¼Œè¿”å›åŒ¹é…çš„èŠ‚ç‚¹ Object x = awaitFulfill(s, e, timed, nanos); // wait was cancelled if (x == s) &#123; clean(t, s); return null; &#125; if (!s.isOffList()) &#123; // not already unlinked advanceHead(t, s); // unlink if head if (x != null) // and forget fields s.item = s; s.waiter = null; &#125; return (x != null) ? (E)x : e; // ä¸‹é¢çš„çœ‹è‹±æ–‡æ³¨é‡Šå¥½äº† &#125; else &#123; // complementary-mode QNode m = h.next; // node to fulfill if (t != tail || m == null || h != head)x continue; // inconsistent read Object x = m.item; if (isData == (x != null) || // m already fulfilled x == m || // m cancelled // è¿™ä¸€æ­¥æ˜¯ä¼šæ‰§è¡Œçš„ !m.casItem(x, e)) &#123; // lost CAS advanceHead(h, m); // dequeue and retry continue; &#125; advanceHead(h, m); // successfully fulfilled LockSupport.unpark(m.waiter); return (x != null) ? (E)x : e; &#125; &#125; &#125; 123456789101112// æå‰ç½®ä¸ºé˜Ÿå°¾void advanceTail(QNode t, QNode nt) &#123; if (tail == t) UNSAFE.compareAndSwapObject(this, tailOffset, t, nt);&#125;//void advanceHead(QNode h, QNode nh) &#123; if (h == head &amp;&amp; UNSAFE.compareAndSwapObject(this, headOffset, h, nh)) h.next = h; // forget old next&#125; æ ¹æ®æ³¨é‡Šï¼Œä¸‹é¢æ¥è¯´æ˜ä¸€ä¸‹æ•´ä¸ªæ–¹æ³•çš„è¿è¡Œæµç¨‹ï¼š å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…è¯·æ±‚äº¤æ˜“çš„èŠ‚ç‚¹å’Œé˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„äº¤æ˜“ç±»å‹ï¼Œé‚£ä¹ˆå°±å°†è¯¥è¯·æ±‚äº¤æ˜“çš„èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨ç­‰å¾…äº¤æ˜“ï¼Œç›´åˆ°è¢«åŒ¹é…æˆ–è€…è¢«å–æ¶ˆ å¦‚æœé˜Ÿåˆ—ä¸­åŒ…å«äº†ç­‰å¾…çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”è¯·æ±‚çš„èŠ‚ç‚¹å’Œç­‰å¾…çš„èŠ‚ç‚¹æ˜¯äº’è¡¥çš„ï¼Œé‚£ä¹ˆè¿›è¡ŒåŒ¹é…å¹¶ä¸”è¿›è¡Œäº¤æ˜“ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061/** * The number of times to spin before blocking in timed waits. * The value is empirically derived -- it works well across a * variety of processors and OSes. Empirically, the best value * seems not to vary with number of CPUs (beyond 2) so is just * a constant. */static final int maxTimedSpins = (NCPUS &lt; 2) ? 0 : 32;/** * The number of times to spin before blocking in untimed waits. * This is greater than timed value because untimed waits spin * faster since they don't need to check times on each spin. */static final int maxUntimedSpins = maxTimedSpins * 16; /** * Spins/blocks until node s is fulfilled. * è‡ªæ—‹æˆ–è€…é˜»å¡ç›´åˆ°æœ‰å…¶ä»–çº¿ç¨‹åŒ¹é… * * @param s the waiting node * @param e the comparison value for checking match * @param timed true if timed wait * @param nanos timeout value * @return matched item, or s if cancelled */ Object awaitFulfill(QNode s, E e, boolean timed, long nanos) &#123; /* Same idea as TransferStack.awaitFulfill */ final long deadline = timed ? System.nanoTime() + nanos : 0L; Thread w = Thread.currentThread(); // å¤´èŠ‚ç‚¹çš„nextæŒ‡é’ˆæ‰è¦è‡ªæ—‹ int spins = ((head.next == s) ? (timed ? maxTimedSpins : maxUntimedSpins) : 0); for (;;) &#123; if (w.isInterrupted()) s.tryCancel(e); Object x = s.item; // æ–¹æ³•çš„å”¯ä¸€å‡ºå£ // åœ¨tryCancel(e)å–æ¶ˆçš„æ—¶å€™s.itemå¯èƒ½å˜æˆQNodeç±»å‹ï¼Œä»è€Œä¸‹ä¸€æ­¥é€€å‡ºæ–¹æ³•ï¼Œè¿”å›è¢«casçš„ç»“æœï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯å¦å–æ¶ˆ // åœ¨åŒ¹é…çš„æ—¶å€™ï¼Œs.itemä¼šæŒ‰åœºæ™¯casæˆnullæˆ–è€…æ˜¯Eï¼ˆç”Ÿæˆå…ƒç´ ï¼‰ï¼Œä»è€Œä¸‹ä¸€æ­¥é€€å‡ºæ–¹æ³•ï¼Œè¿”å›è¢«casçš„ç»“æœ if (x != e) return x; if (timed) &#123; nanos = deadline - System.nanoTime(); if (nanos &lt;= 0L) &#123; s.tryCancel(e); continue; &#125; &#125; // æ—¥å¸¸è‡ªå‡ if (spins &gt; 0) --spins; else if (s.waiter == null) s.waiter = w; // å¦‚æœè‡ªæ—‹æ¬¡æ•°å®Œæ¯•ï¼Œåˆæ²¡è¶…æ—¶é‚£å°±æŒ‚èµ·å§ else if (!timed) LockSupport.park(this); // åªæœ‰&gt; 1ms æ‰è¦æŒ‚èµ·çº¿ç¨‹ï¼Œä¸ç„¶è¿˜æ˜¯è‡ªæ—‹ï¼Œè¿™åœ¨Conditionç¯‡æœ‰æåˆ° else if (nanos &gt; spinForTimeoutThreshold) LockSupport.parkNanos(this, nanos); &#125; &#125; è¿™é‡Œçœ‹ä¸‹å–æ¶ˆäº¤æ˜“çš„ä»£ç  123456/** * Tries to cancel by CAS'ing ref to this as item. */void tryCancel(Object cmp) &#123; UNSAFE.compareAndSwapObject(this, itemOffset, cmp, this);&#125; å¯ä»¥çœ‹åˆ°ï¼Œå–æ¶ˆäº¤æ˜“å°±æ˜¯å°†matchæŒ‡å‘è‡ªå·±ï¼Œè€Œåœ¨awaitFulfillæ–¹æ³•ä¸­è¿”å›çš„å°±æ˜¯matchï¼Œé‚£ä¹ˆawaitFulfillæ–¹æ³•è¿”å›ä¹‹ååšä¸€ä¸‹åˆ¤æ–­ï¼Œå¦‚æœå’Œè‡ªå·±ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±æ˜¯è¢«å–æ¶ˆäº¤æ˜“äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦è°ƒç”¨æ–¹æ³•cleanæ¥æ¸…ç†ä¸€ä¸‹ï¼Œä¸‹é¢æ˜¯cleanæ–¹æ³•çš„ç»†èŠ‚ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/** * Gets rid of cancelled node s with original predecessor pred. */void clean(QNode pred, QNode s) &#123; s.waiter = null; // forget thread /* * At any given time, exactly one node on list cannot be * deleted -- the last inserted node. To accommodate this, * if we cannot delete s, we save its predecessor as * \"cleanMe\", deleting the previously saved version * first. At least one of node s or the node previously * saved can always be deleted, so this always terminates. */ while (pred.next == s) &#123; // Return early if already unlinked QNode h = head; QNode hn = h.next; // Absorb cancelled first node as head if (hn != null &amp;&amp; hn.isCancelled()) &#123; advanceHead(h, hn); continue; &#125; QNode t = tail; // Ensure consistent read for tail if (t == h) return; QNode tn = t.next; if (t != tail) continue; if (tn != null) &#123; advanceTail(t, tn); continue; &#125; if (s != t) &#123; // If not tail, try to unsplice QNode sn = s.next; if (sn == s || pred.casNext(s, sn)) return; &#125; QNode dp = cleanMe; if (dp != null) &#123; // Try unlinking previous cancelled node QNode d = dp.next; QNode dn; if (d == null || // d is gone or d == dp || // d is off list or !d.isCancelled() || // d not cancelled or (d != t &amp;&amp; // d not tail and (dn = d.next) != null &amp;&amp; // has successor dn != d &amp;&amp; // that is on list dp.casNext(d, dn))) // d unspliced casCleanMe(dp, null); if (dp == pred) return; // s is already saved node &#125; else if (casCleanMe(null, pred)) return; // Postpone cleaning s &#125;&#125; å¯ä»¥å‘ç°è¿™ä¸ªæ–¹æ³•è¾ƒä¸ºå¤æ‚ï¼Œç°åœ¨è¦æåˆ°ä¸€ä¸ªæˆå‘˜å˜é‡ï¼šcleanMeï¼Œè¿™ä¸ªå˜é‡ä¿å­˜çš„æ˜¯ä¸€ä¸ªè¢«å–æ¶ˆäº¤æ˜“ä½†æ˜¯æ²¡æœ‰è¢«ç§»é™¤é˜Ÿåˆ—çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ€»æ˜¯æœ€åè¢«æ·»åŠ åˆ°é˜Ÿåˆ—çš„ã€‚ 3.2. éå…¬å¹³æ¨¡å¼éå…¬å¹³æ¨¡å¼çš„æ›´éš¾ä¸€äº›ï¼Œæš‚ä¸è¯´æ˜ã€‚ 4. PriorityBlockingQueueå¸¦æ’åºçš„ BlockingQueue å®ç°ï¼Œå…¶å¹¶å‘æ§åˆ¶é‡‡ç”¨çš„æ˜¯ ReentrantLockï¼Œé˜Ÿåˆ—ä¸ºæ— ç•Œé˜Ÿåˆ—ï¼ˆArrayBlockingQueue æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼ŒLinkedBlockingQueue ä¹Ÿå¯ä»¥é€šè¿‡åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥ capacity æŒ‡å®šé˜Ÿåˆ—æœ€å¤§çš„å®¹é‡ï¼Œä½†æ˜¯ PriorityBlockingQueue åªèƒ½æŒ‡å®šåˆå§‹çš„é˜Ÿåˆ—å¤§å°ï¼Œåé¢æ’å…¥å…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿçš„è¯ä¼šè‡ªåŠ¨æ‰©å®¹ï¼‰ã€‚ ç®€å•åœ°è¯´ï¼Œå®ƒå°±æ˜¯ PriorityQueue çš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ã€‚ä¸å¯ä»¥æ’å…¥ null å€¼ï¼ŒåŒæ—¶ï¼Œæ’å…¥é˜Ÿåˆ—çš„å¯¹è±¡å¿…é¡»æ˜¯å¯æ¯”è¾ƒå¤§å°çš„ï¼ˆcomparableï¼‰ï¼Œå¦åˆ™æŠ¥ ClassCastException å¼‚å¸¸ã€‚å®ƒçš„æ’å…¥æ“ä½œ put æ–¹æ³•ä¸ä¼š blockï¼Œå› ä¸ºå®ƒæ˜¯æ— ç•Œé˜Ÿåˆ—ï¼ˆtake æ–¹æ³•åœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ä¼šé˜»å¡ï¼‰ã€‚ 12345678910111213141516171819202122232425// æ„é€ æ–¹æ³•ä¸­ï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°çš„è¯ï¼Œé»˜è®¤å¤§å°ä¸º 11private static final int DEFAULT_INITIAL_CAPACITY = 11;// æ•°ç»„çš„æœ€å¤§å®¹é‡private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;// å­˜æ”¾æ•°æ®çš„æ•°ç»„private transient Object[] queue;// é˜Ÿåˆ—å½“å‰å¤§å°private transient int size;// å¤§å°æ¯”è¾ƒå™¨ï¼Œå¦‚æœæŒ‰ç…§è‡ªç„¶åºæ’åºï¼Œé‚£ä¹ˆæ­¤å±æ€§å¯è®¾ç½®ä¸º nullprivate transient Comparator&lt;? super E&gt; comparator;// å¹¶å‘æ§åˆ¶æ‰€ç”¨çš„é”ï¼Œæ‰€æœ‰çš„ public ä¸”æ¶‰åŠåˆ°çº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ï¼Œéƒ½å¿…é¡»å…ˆè·å–åˆ°è¿™ä¸ªé”private final ReentrantLock lock;// éç©ºconditionprivate final Condition notEmpty;// è¿™ä¸ªä¹Ÿæ˜¯ç”¨äºé”ï¼Œç”¨äºæ•°ç»„æ‰©å®¹çš„æ—¶å€™ï¼Œéœ€è¦å…ˆè·å–åˆ°è¿™ä¸ªé”ï¼Œæ‰èƒ½è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œä½¿ç”¨ CAS æ“ä½œprivate transient volatile int allocationSpinLock;// ç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ—¶å€™ç”¨ï¼Œå¯¹äº PriorityBlockingQueue æˆ‘ä»¬åº”è¯¥æ¯”è¾ƒå°‘ä½¿ç”¨åˆ°åºåˆ—åŒ–private PriorityQueue q; çœ‹åˆå§‹åŒ–ä»£ç , æ¯”è¾ƒå™¨é»˜è®¤ä¸ºç©º 1234567891011121314151617181920212223// DEFAULT_INITIAL_CAPACITY = 11public PriorityBlockingQueue() &#123; this(DEFAULT_INITIAL_CAPACITY, null);&#125;public PriorityBlockingQueue(int initialCapacity) &#123; this(initialCapacity, null);&#125;public PriorityBlockingQueue(int initialCapacity, Comparator&lt;? super E&gt; comparator) &#123; if (initialCapacity &lt; 1) throw new IllegalArgumentException(); this.lock = new ReentrantLock(); this.notEmpty = lock.newCondition(); this.comparator = comparator; this.queue = new Object[initialCapacity];&#125;// åˆå§‹åŒ–å¡«å……æŒ‡å®šé›†åˆpublic PriorityBlockingQueue(Collection&lt;? extends E&gt; c)&#123; ...&#125; æ‰©å®¹æœºåˆ¶ 123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * Tries to grow array to accommodate at least one more element * (but normally expand by about 50%), giving up (allowing retry) * on contention (which we expect to be rare). Call only while * holding lock. * * @param array the heap array * @param oldCap the length of the array */private void tryGrow(Object[] array, int oldCap) &#123; // å…ˆé‡Šæ”¾é”ï¼Œæ‰©å®¹åå†è·å–é” lock.unlock(); // must release and then re-acquire main lock Object[] newArray = null; if (allocationSpinLock == 0 &amp;&amp; // casè·å–æ‰©å®¹é” UNSAFE.compareAndSwapInt(this, allocationSpinLockOffset, 0, 1)) &#123; try &#123; // ä»¥64ä¸ºä¸ºç•Œé™ï¼Œä¸åŒçš„å¢é•¿ç­–ç•¥ï¼Œ64ä»¥ä¸‹+2 int newCap = oldCap + ((oldCap &lt; 64) ? (oldCap + 2) : // grow faster if small (oldCap &gt;&gt; 1)); if (newCap - MAX_ARRAY_SIZE &gt; 0) &#123; // possible overflow int minCap = oldCap + 1; if (minCap &lt; 0 || minCap &gt; MAX_ARRAY_SIZE) throw new OutOfMemoryError(); newCap = MAX_ARRAY_SIZE; &#125; if (newCap &gt; oldCap &amp;&amp; queue == array) newArray = new Object[newCap]; &#125; finally &#123; // è§£é” allocationSpinLock = 0; &#125; &#125; // æ²¡è·å–æ‰©å®¹é” if (newArray == null) // back off if another thread is allocating Thread.yield(); // ä¸Šé”å¤åˆ¶ lock.lock(); if (newArray != null &amp;&amp; queue == array) &#123; queue = newArray; System.arraycopy(array, 0, newArray, 0, oldCap); &#125;&#125; è€ææŠŠæ•°ç»„æ‰©å®¹å’Œå¤åˆ¶åˆ†ä¸ºä¸¤æ­¥ï¼Œæ‰©å®¹äº¤ç»™æ‰©å®¹é”ï¼Œå¤åˆ¶äº¤ç»™æ‹ä»–ğŸ”’ï¼Œè¿™æ ·æ‰©å®¹çš„æ—¶å€™åŸæ•°ç»„å¯ä»¥ç»§ç»­è¢«è®¿é—®ï¼Œå¢åŠ ååé‡ã€‚ 4.1. put(e)123456789101112131415161718192021222324252627282930313233343536373839404142// ä¸ç”¨é˜»å¡ï¼Œå› ä¸ºæ— ç•Œï¼ˆå¤§çˆ±æ— ç–†ï¼‰ public void put(E e) &#123; offer(e); // never need to block &#125; public boolean offer(E e) &#123; if (e == null) throw new NullPointerException(); final ReentrantLock lock = this.lock; lock.lock(); int n, cap; Object[] array; while ((n = size) &gt;= (cap = (array = queue).length)) tryGrow(array, cap); try &#123; Comparator&lt;? super E&gt; cmp = comparator; if (cmp == null) siftUpComparable(n, e, array); else siftUpUsingComparator(n, e, array, cmp); size = n + 1; notEmpty.signal(); &#125; finally &#123; lock.unlock(); &#125; return true; &#125; // äºŒå‰å †çš„æ’å…¥ï¼Œä½¿ç”¨æ’å…¥å…ƒç´ é»˜è®¤çš„æ¯”è¾ƒæ–¹æ³• private static &lt;T&gt; void siftUpComparable(int k, T x, Object[] array) &#123; Comparable&lt;? super T&gt; key = (Comparable&lt;? super T&gt;) x; while (k &gt; 0) &#123; // äºŒå‰å †ä¸­ a[k] èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä½ç½® int parent = (k - 1) &gt;&gt;&gt; 1; Object e = array[parent]; if (key.compareTo((T) e) &gt;= 0) break; array[k] = e; k = parent; &#125; array[k] = key; &#125; ç»§ç»­ç›—å›¾ = = 4.2. take()123456789101112public E take() throws InterruptedException &#123; final ReentrantLock lock = this.lock; lock.lockInterruptibly(); E result; try &#123; while ( (result = dequeue()) == null) notEmpty.await(); &#125; finally &#123; lock.unlock(); &#125; return result;&#125; ä¸Šé”å‡ºé˜Ÿï¼Œçœ‹å‡ºé˜Ÿæ–¹æ³• 123456789101112131415161718private E dequeue() &#123; int n = size - 1; if (n &lt; 0) return null; else &#123; Object[] array = queue; E result = (E) array[0]; E x = (E) array[n]; array[n] = null; Comparator&lt;? super E&gt; cmp = comparator; if (cmp == null) siftDownComparable(0, x, array, n); else siftDownUsingComparator(0, x, array, n, cmp); size = n; return result; &#125;&#125; å‡ºé˜Ÿæ¯”è¾ƒå®¹æ˜“ï¼Œå› ä¸ºäºŒå‰å †çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯æœ€å°å…ƒç´  12345678910111213141516171819202122232425262728293031private static &lt;T&gt; void siftDownComparable(int k, T x, Object[] array, int n) &#123; if (n &gt; 0) &#123; Comparable&lt;? super T&gt; key = (Comparable&lt;? super T&gt;)x; // è¿™é‡Œå¾—åˆ°çš„ half è‚¯å®šæ˜¯éå¶èŠ‚ç‚¹ // a[n] æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå…¶çˆ¶èŠ‚ç‚¹æ˜¯ a[(n-1)/2]ã€‚æ‰€ä»¥ n &gt;&gt;&gt; 1 ä»£è¡¨çš„èŠ‚ç‚¹è‚¯å®šä¸æ˜¯å¶å­èŠ‚ç‚¹ // ä¸‹é¢ï¼Œæˆ‘ä»¬ç»“åˆå›¾æ¥ä¸€è¡Œè¡Œåˆ†æï¼Œè¿™æ ·æ¯”è¾ƒç›´è§‚ç®€å• // æ­¤æ—¶ k ä¸º 0, x ä¸º 17ï¼Œn ä¸º 9 int half = n &gt;&gt;&gt; 1; // å¾—åˆ° half = 4 while (k &lt; half) &#123; // å…ˆå–å·¦å­èŠ‚ç‚¹ int child = (k &lt;&lt; 1) + 1; // å¾—åˆ° child = 1 Object c = array[child]; // c = 12 int right = child + 1; // right = 2 // å¦‚æœå³å­èŠ‚ç‚¹å­˜åœ¨ï¼Œè€Œä¸”æ¯”å·¦å­èŠ‚ç‚¹å° // æ­¤æ—¶ array[right] = 20ï¼Œæ‰€ä»¥æ¡ä»¶ä¸æ»¡è¶³ if (right &lt; n &amp;&amp; ((Comparable&lt;? super T&gt;) c).compareTo((T) array[right]) &gt; 0) c = array[child = right]; // key = 17, c = 12ï¼Œæ‰€ä»¥æ¡ä»¶ä¸æ»¡è¶³ if (key.compareTo((T) c) &lt;= 0) break; // æŠŠ 12 å¡«å……åˆ°æ ¹èŠ‚ç‚¹ array[k] = c; // k èµ‹å€¼åä¸º 1 k = child; // ä¸€è½®è¿‡åï¼Œæˆ‘ä»¬å‘ç°ï¼Œ12 å·¦è¾¹çš„å­æ ‘å’Œåˆšåˆšçš„å·®ä¸å¤šï¼Œéƒ½æ˜¯ç¼ºå°‘æ ¹èŠ‚ç‚¹ï¼Œæ¥ä¸‹æ¥å¤„ç†å°±ç®€å•äº† &#125; array[k] = key; &#125;&#125; è®°ä½äºŒå‰å †æ˜¯ä¸€æ£µå®Œå…¨äºŒå‰æ ‘ï¼Œé‚£ä¹ˆæ ¹èŠ‚ç‚¹ 10 æ‹¿æ‰åï¼Œæœ€åé¢çš„å…ƒç´  17 å¿…é¡»æ‰¾åˆ°åˆé€‚çš„åœ°æ–¹æ”¾ç½®ã€‚é¦–å…ˆï¼Œ17 å’Œ 10 ä¸èƒ½ç›´æ¥äº¤æ¢ï¼Œé‚£ä¹ˆå…ˆå°†æ ¹èŠ‚ç‚¹ 10 çš„å·¦å³å­èŠ‚ç‚¹ä¸­è¾ƒå°çš„èŠ‚ç‚¹å¾€ä¸Šæ»‘ï¼Œå³ 12 å¾€ä¸Šæ»‘ï¼Œç„¶ååŸæ¥ 12 ç•™ä¸‹äº†ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œç„¶åå†æŠŠè¿™ä¸ªç©ºèŠ‚ç‚¹çš„è¾ƒå°çš„å­èŠ‚ç‚¹å¾€ä¸Šæ»‘ï¼Œå³ 13 å¾€ä¸Šæ»‘ï¼Œæœ€åï¼Œç•™å‡ºäº†ä½å­ï¼Œ17 è¡¥ä¸Šå³å¯ã€‚ è°ƒæ•´å›¾ 5. DelayQueueè¿™æ˜¯ä¸ªä¾èµ–äºPriorityQueueå»¶è¿Ÿé˜Ÿåˆ—ï¼Œä¸ŠèŠ‚è¯´åˆ°PriorityBlcokingQueueæ˜¯PriorityQueueçš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ã€‚DelayQueueçš„å…ƒç´ éœ€è¦å®ç°Delayedæ¥å£ï¼ŒDelayedæ¥å£åˆç»§æ‰¿äº†Comparable,éœ€è¦å®ç°çš„æ–¹æ³•æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªç”¨äºè·å–å½“å‰å‰©ä½™æ—¶é—´ï¼Œä¸€ä¸ªæ¯”è¾ƒå¤§å°ï¼Œå› ä¸ºPriorityQueueæ˜¯ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚ 12345678910111213141516171819202122private final transient ReentrantLock lock = new ReentrantLock();private final PriorityQueue&lt;E&gt; q = new PriorityQueue&lt;E&gt;();/** * Thread designated to wait for the element at the head of * the queue. This variant of the Leader-Follower pattern * (http://www.cs.wustl.edu/~schmidt/POSA/POSA2/) serves to * minimize unnecessary timed waiting. When a thread becomes * the leader, it waits only for the next delay to elapse, but * other threads await indefinitely. The leader thread must * signal some other thread before returning from take() or * poll(...), unless some other thread becomes leader in the * interim. Whenever the head of the queue is replaced with * an element with an earlier expiration time, the leader * field is invalidated by being reset to null, and some * waiting thread, but not necessarily the current leader, is * signalled. So waiting threads must be prepared to acquire * and lose leadership while waiting. */private Thread leader = null;private final Condition available = lock.newCondition(); 5.1. put(e)ç”±äºä½¿ç”¨çš„æ˜¯æ— ç•Œä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ‰€ä»¥putä¹Ÿæ˜¯è°ƒç”¨offer 12345678910111213141516171819public void put(E e) &#123; offer(e);&#125;// q å³ PriorityQueuepublic boolean offer(E e) &#123; final ReentrantLock lock = this.lock; lock.lock(); try &#123; q.offer(e); if (q.peek() == e) &#123; leader = null; available.signal(); &#125; return true; &#125; finally &#123; lock.unlock(); &#125;&#125; 5.2. take()1234567891011121314151617181920212223242526272829303132333435363738394041424344454647/** * Retrieves and removes the head of this queue, waiting if necessary * until an element with an expired delay is available on this queue. * * @return the head of this queue * @throws InterruptedException &#123;@inheritDoc&#125; */public E take() throws InterruptedException &#123; final ReentrantLock lock = this.lock; lock.lockInterruptibly(); try &#123; for (;;) &#123; // æŸ¥è¯¢é¦–å…ƒç´  E first = q.peek(); if (first == null) // conditionç»„ç´  available.await(); else &#123; long delay = first.getDelay(NANOSECONDS); if (delay &lt;= 0) // åˆæ—¶å·²åˆ°ï¼Œå…ƒç´ å‡ºé˜Ÿ return q.poll(); first = null; // don't retain ref while waiting if (leader != null) // conditioné˜»å¡ available.await(); else &#123; Thread thisThread = Thread.currentThread(); // å ç”¨é˜Ÿåˆ— leader = thisThread; try &#123; // ç­‰å¾…delayæ—¶é—´ï¼Œç„¶åè¿›è¡Œä¸‹ä¸€æ³¢è‡ªæ—‹ available.awaitNanos(delay); &#125; finally &#123; if (leader == thisThread) leader = null; &#125; &#125; &#125; &#125; &#125; finally &#123; // æ²¡äººå ç”¨é˜Ÿåˆ—äº† if (leader == null &amp;&amp; q.peek() != null) available.signal(); lock.unlock(); &#125;&#125; 6. å‚è€ƒè§£è¯» Java å¹¶å‘é˜Ÿåˆ— BlockingQueue","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]AQSä¸å…±äº«é”","slug":"JavaåŸºç¡€-AQSä¸å…±äº«é”","date":"2018-08-27T13:58:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"4255302597.html","link":"","permalink":"https://htchz.cc/4255302597.html","excerpt":"å ä¸ªå‘ã€ä¸æ‹‰ğŸ’©","text":"å ä¸ªå‘ã€ä¸æ‹‰ğŸ’©","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]AQSä¸Condition","slug":"JavaåŸºç¡€-Condition","date":"2018-08-27T03:43:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"2912753191.html","link":"","permalink":"https://htchz.cc/2912753191.html","excerpt":"è¿™æ˜¯ä¾èµ–äºReentrantLockçš„ä¸€ä¸ªç±»","text":"è¿™æ˜¯ä¾èµ–äºReentrantLockçš„ä¸€ä¸ªç±» ConditionåŸºäºReentrantLockï¼Œè¿™é‡Œæœ‰ Doug Lea ä¸¾çš„ğŸŒ°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344import java.util.concurrent.locks.Condition;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;class BoundedBuffer &#123; final Lock lock = new ReentrantLock(); // condition ä¾èµ–äº lock æ¥äº§ç”Ÿ final Condition notFull = lock.newCondition(); final Condition notEmpty = lock.newCondition(); final Object[] items = new Object[100]; int putptr, takeptr, count; // ç”Ÿäº§ public void put(Object x) throws InterruptedException &#123; lock.lock(); try &#123; while (count == items.length) notFull.await(); // é˜Ÿåˆ—å·²æ»¡ï¼Œç­‰å¾…ï¼Œç›´åˆ° not full æ‰èƒ½ç»§ç»­ç”Ÿäº§ items[putptr] = x; if (++putptr == items.length) putptr = 0; ++count; notEmpty.signal(); // ç”Ÿäº§æˆåŠŸï¼Œé˜Ÿåˆ—å·²ç» not empty äº†ï¼Œå‘ä¸ªé€šçŸ¥å‡ºå» &#125; finally &#123; lock.unlock(); &#125; &#125; // æ¶ˆè´¹ public Object take() throws InterruptedException &#123; lock.lock(); try &#123; while (count == 0) notEmpty.await(); // é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ— not emptyï¼Œæ‰èƒ½ç»§ç»­æ¶ˆè´¹ Object x = items[takeptr]; if (++takeptr == items.length) takeptr = 0; --count; notFull.signal(); // è¢«æˆ‘æ¶ˆè´¹æ‰ä¸€ä¸ªï¼Œé˜Ÿåˆ— not full äº†ï¼Œå‘ä¸ªé€šçŸ¥å‡ºå» return x; &#125; finally &#123; lock.unlock(); &#125; &#125;&#125; è¿™ä¸ªå…¶å®å°±æ˜¯ArrayBlockingQueueçš„åŸç†ã€‚ è·å–ä¸€ä¸ªConditionå®ä¾‹è¦é€šè¿‡ReentrantLockå®ä¾‹ 123public Condition newCondition() &#123; return sync.newCondition();&#125; 123final ConditionObject newCondition() &#123; return new ConditionObject();&#125; 12345678public class ConditionObject implements Condition, java.io.Serializable &#123; private static final long serialVersionUID = 1173984872572414699L; /** First node of condition queue. */ private transient Node firstWaiter; /** Last node of condition queue. */ private transient Node lastWaiter; ...&#125; å®é™…ä¸Šåˆ©ç”¨Nodeçš„nextWaiterå±æ€§ï¼Œconditionç»´æŠ¤äº†ä¸€ä¸ªå•å‘é“¾è¡¨ 1234567891011/** * Link to next node waiting on condition, or the special * value SHARED. Because condition queues are accessed only * when holding in exclusive mode, we just need a simple * linked queue to hold nodes while they are waiting on * conditions. They are then transferred to the queue to * re-acquire. And because conditions can only be exclusive, * we save a field by using special value to indicate shared * mode. */Node nextWaiter; å·æ¥ä¸€å¼ å›¾ï¼Œæˆ‘ä»¬æŠŠä¸Šä¸€èŠ‚çš„é˜Ÿåˆ—ç§°ä¸ºé˜»å¡é˜Ÿåˆ—ï¼ŒæŠŠconditionçš„é˜Ÿåˆ—å«åšæ¡ä»¶é˜Ÿåˆ—ã€‚ å½“conditionè°ƒç”¨await()çš„æ—¶å€™å°±æŠŠå½“å‰çº¿ç¨‹å°è£…ä¸ºä¸€ä¸ªNodeæ”¾åˆ°lastWaiterï¼Œå¹¶ä¸”æŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚ å½“conditionè°ƒç”¨signal()çš„æ—¶å€™å°±æŠŠfirstWaiteræ”¾åˆ°é˜»å¡é˜Ÿåˆ—ã€‚ 1. çº¿ç¨‹æŒ‚èµ·1234567891011121314151617181920212223242526// é¦–å…ˆï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¯è¢«ä¸­æ–­çš„ï¼Œä¸å¯è¢«ä¸­æ–­çš„æ˜¯å¦ä¸€ä¸ªæ–¹æ³• awaitUninterruptibly()// è¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°è°ƒç”¨ signal æ–¹æ³•ï¼ˆæŒ‡ signal() å’Œ signalAll()ï¼Œä¸‹åŒï¼‰ï¼Œæˆ–è¢«ä¸­æ–­public final void await() throws InterruptedException &#123; if (Thread.interrupted()) throw new InterruptedException(); // æ·»åŠ åˆ° condition çš„æ¡ä»¶é˜Ÿåˆ—ä¸­ Node node = addConditionWaiter(); // é‡Šæ”¾é”ï¼Œè¿”å›å€¼æ˜¯é‡Šæ”¾é”ä¹‹å‰çš„ state å€¼ int savedState = fullyRelease(node); int interruptMode = 0; // è¿™é‡Œé€€å‡ºå¾ªç¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¹‹åå†ä»”ç»†åˆ†æ // 1. isOnSyncQueue(node) è¿”å› trueï¼Œå³å½“å‰ node å·²ç»è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº† // 2. checkInterruptWhileWaiting(node) != 0 ä¼šåˆ° breakï¼Œç„¶åé€€å‡ºå¾ªç¯ï¼Œä»£è¡¨çš„æ˜¯çº¿ç¨‹ä¸­æ–­ while (!isOnSyncQueue(node)) &#123; LockSupport.park(this); if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; &#125; // è¢«å”¤é†’åï¼Œå°†è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…è·å–é” if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; if (node.nextWaiter != null) // clean up if cancelled unlinkCancelledWaiters(); if (interruptMode != 0) reportInterruptAfterWait(interruptMode);&#125; çœ‹addConditionWaiter()ï¼ŒæŠŠå½“å‰çº¿ç¨‹åŠ å…¥æ¡ä»¶é˜Ÿåˆ— 12345678910111213141516171819/** * Adds a new waiter to wait queue. * @return its new wait node */private Node addConditionWaiter() &#123; Node t = lastWaiter; // If lastWaiter is cancelled, clean out. if (t != null &amp;&amp; t.waitStatus != Node.CONDITION) &#123; unlinkCancelledWaiters(); t = lastWaiter; &#125; Node node = new Node(Thread.currentThread(), Node.CONDITION); if (t == null) firstWaiter = node; else t.nextWaiter = node; lastWaiter = node; return node;&#125; ä¸ºä»€ä¹ˆæ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿå› ä¸ºConditionéœ€è¦å’ŒReentrantLock.lock()ä¸€èµ·ä½¿ç”¨ï¼Œä¸ä¸€èµ·ä½¿ç”¨ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿå°±ä¸å®‰å…¨äº† å–æ¶ˆèŠ‚ç‚¹çš„ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021// ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œéå†é“¾è¡¨å°†å·²ç»å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹æ¸…é™¤å‡ºå»private void unlinkCancelledWaiters() &#123; Node t = firstWaiter; Node trail = null; while (t != null) &#123; Node next = t.nextWaiter; // å¦‚æœèŠ‚ç‚¹çš„çŠ¶æ€ä¸æ˜¯ Node.CONDITION çš„è¯ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯è¢«å–æ¶ˆçš„ if (t.waitStatus != Node.CONDITION) &#123; t.nextWaiter = null; if (trail == null) firstWaiter = next; else trail.nextWaiter = next; if (next == null) lastWaiter = trail; &#125; else trail = t; t = next; &#125;&#125; åŠ å…¥æ¡ä»¶é˜Ÿåˆ—ä¹‹åï¼Œå°±å®Œå…¨é‡Šæ”¾ç‹¬å é”ï¼Œè®©å‡ºé”ã€‚ 123456789101112131415161718192021// é¦–å…ˆï¼Œæˆ‘ä»¬è¦å…ˆè§‚å¯Ÿåˆ°è¿”å›å€¼ savedState ä»£è¡¨ release ä¹‹å‰çš„ state å€¼// å¯¹äºæœ€ç®€å•çš„æ“ä½œï¼šå…ˆ lock.lock()ï¼Œç„¶å condition1.await()ã€‚// é‚£ä¹ˆ state ç»è¿‡è¿™ä¸ªæ–¹æ³•ç”± 1 å˜ä¸º 0ï¼Œé”é‡Šæ”¾ï¼Œæ­¤æ–¹æ³•è¿”å› 1// ç›¸åº”çš„ï¼Œå¦‚æœ lock é‡å…¥äº† n æ¬¡ï¼ŒsavedState == n// å¦‚æœè¿™ä¸ªæ–¹æ³•å¤±è´¥ï¼Œä¼šå°†èŠ‚ç‚¹è®¾ç½®ä¸º\"å–æ¶ˆ\"çŠ¶æ€ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ IllegalMonitorStateExceptionfinal int fullyRelease(Node node) &#123; boolean failed = true; try &#123; int savedState = getState(); // è¿™é‡Œä½¿ç”¨äº†å½“å‰çš„ state ä½œä¸º release çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å®Œå…¨é‡Šæ”¾æ‰é”ï¼Œå°† state ç½®ä¸º 0 if (release(savedState)) &#123; failed = false; return savedState; &#125; else &#123; throw new IllegalMonitorStateException(); &#125; &#125; finally &#123; if (failed) node.waitStatus = Node.CANCELLED; &#125;&#125; é‡Šæ”¾æ‰é”ä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨é˜»å¡é˜Ÿåˆ—é‡Œé¢ï¼Œå¦‚æœä¸åœ¨ï¼ŒæŒ‚èµ·ï¼Œè‡ªæ—‹ç›´åˆ°è¿›å…¥é˜»å¡é˜Ÿåˆ—ã€‚ 12345678int interruptMode = 0;while (!isOnSyncQueue(node)) &#123; // çº¿ç¨‹æŒ‚èµ· LockSupport.park(this); if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break;&#125; isOnSyncQueue(Node node)ç”¨äºåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²ç»è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ— 1234567891011final boolean isOnSyncQueue(Node node) &#123; // ç§»åŠ¨è¿‡å»çš„æ—¶å€™ï¼Œnode çš„ waitStatus ä¼šç½®ä¸º 0ï¼Œè¿™ä¸ªä¹‹ååœ¨è¯´ signal æ–¹æ³•çš„æ—¶å€™ä¼šè¯´åˆ° // node.prev == nullï¼Œé‚£ä¹ˆè‚¯å®šæ²¡æœ‰è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œnode.prev != null, ä¸ä¸€å®šè¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå› ä¸ºä¸Šç¯‡çš„AQSè®²åˆ°Nodeå…¥é˜Ÿé¦–å…ˆè®¾ç½®çš„æ˜¯ node.prev æŒ‡å‘ tailï¼Œ // ç„¶åæ˜¯ CAS æ“ä½œå°†è‡ªå·±è®¾ç½®ä¸ºæ–°çš„ tailï¼Œå¯æ˜¯è¿™æ¬¡çš„ CAS æ˜¯å¯èƒ½å¤±è´¥çš„ã€‚ if (node.waitStatus == Node.CONDITION || node.prev == null) return false; if (node.next != null) // If has successor, it must be on queue return true; // return findNodeFromTail(node); &#125; 1234567891011// ä»åŒæ­¥é˜Ÿåˆ—(é˜»å¡é˜Ÿåˆ—)çš„é˜Ÿå°¾å¾€å‰éå†ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œè¿”å› trueprivate boolean findNodeFromTail(Node node) &#123; Node t = tail; for (;;) &#123; if (t == node) return true; if (t == null) return false; t = t.prev; &#125;&#125; 2. çº¿ç¨‹å”¤é†’12345678910// å”¤é†’ç­‰å¾…äº†æœ€ä¹…çš„çº¿ç¨‹// å…¶å®å°±æ˜¯ï¼Œå°†è¿™ä¸ªçº¿ç¨‹å¯¹åº”çš„ node ä»æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—public final void signal() &#123; // è°ƒç”¨ signal æ–¹æ³•çš„çº¿ç¨‹å¿…é¡»æŒæœ‰å½“å‰çš„ç‹¬å é” if (!isHeldExclusively()) throw new IllegalMonitorStateException(); Node first = firstWaiter; if (first != null) doSignal(first);&#125; 1234567891011121314// ä»æ¡ä»¶é˜Ÿåˆ—é˜Ÿå¤´å¾€åéå†ï¼Œæ‰¾å‡ºç¬¬ä¸€ä¸ªéœ€è¦è½¬ç§»çš„ node// å› ä¸ºå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œæœ‰äº›çº¿ç¨‹ä¼šå–æ¶ˆæ’é˜Ÿï¼Œä½†æ˜¯è¿˜åœ¨é˜Ÿåˆ—ä¸­private void doSignal(Node first) &#123; do &#123; // å°† firstWaiter æŒ‡å‘ first èŠ‚ç‚¹åé¢çš„ç¬¬ä¸€ä¸ª // å¦‚æœå°†é˜Ÿå¤´ç§»é™¤åï¼Œåé¢æ²¡æœ‰èŠ‚ç‚¹åœ¨ç­‰å¾…äº†ï¼Œé‚£ä¹ˆéœ€è¦å°† lastWaiter ç½®ä¸º null if ( (firstWaiter = first.nextWaiter) == null) lastWaiter = null; // å› ä¸º first é©¬ä¸Šè¦è¢«ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†ï¼Œå’Œæ¡ä»¶é˜Ÿåˆ—çš„é“¾æ¥å…³ç³»åœ¨è¿™é‡Œæ–­æ‰ first.nextWaiter = null; &#125; while (!transferForSignal(first) &amp;&amp; (first = firstWaiter) != null); // è¿™é‡Œ while å¾ªç¯ï¼Œå¦‚æœ first è½¬ç§»ä¸æˆåŠŸï¼Œé‚£ä¹ˆé€‰æ‹© first åé¢çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè½¬ç§»ï¼Œä¾æ­¤ç±»æ¨&#125; è½¬ç§»èŠ‚ç‚¹çš„ä»£ç ï¼Œå¹¶ä¸”å”¤é†’é˜»å¡çº¿ç¨‹ 12345678910111213141516171819202122// å°†èŠ‚ç‚¹ä»æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—// true ä»£è¡¨æˆåŠŸè½¬ç§»// false ä»£è¡¨åœ¨ signal ä¹‹å‰ï¼ŒèŠ‚ç‚¹å·²ç»å–æ¶ˆäº†final boolean transferForSignal(Node node) &#123; // CAS å¦‚æœå¤±è´¥ï¼Œè¯´æ˜æ­¤ node çš„ waitStatus å·²ä¸æ˜¯ Node.CONDITIONï¼Œè¯´æ˜èŠ‚ç‚¹å·²ç»å–æ¶ˆï¼Œ // æ—¢ç„¶å·²ç»å–æ¶ˆï¼Œä¹Ÿå°±ä¸éœ€è¦è½¬ç§»äº†ï¼Œæ–¹æ³•è¿”å›ï¼Œè½¬ç§»åé¢ä¸€ä¸ªèŠ‚ç‚¹ // å¦åˆ™ï¼Œå°† waitStatus ç½®ä¸º 0 if (!compareAndSetWaitStatus(node, Node.CONDITION, 0)) return false; // enq(node): è‡ªæ—‹è¿›å…¥é˜»å¡é˜Ÿåˆ—çš„é˜Ÿå°¾ // æ³¨æ„ï¼Œè¿™é‡Œçš„è¿”å›å€¼ p æ˜¯ node åœ¨é˜»å¡é˜Ÿåˆ—çš„å‰é©±èŠ‚ç‚¹ Node p = enq(node); int ws = p.waitStatus; // ws &gt; 0 è¯´æ˜ node åœ¨é˜»å¡é˜Ÿåˆ—ä¸­çš„å‰é©±èŠ‚ç‚¹å–æ¶ˆäº†ç­‰å¾…é”ï¼Œç›´æ¥å”¤é†’ node å¯¹åº”çš„çº¿ç¨‹ã€‚å”¤é†’ä¹‹åä¼šæ€ä¹ˆæ ·ï¼Œåé¢å†è§£é‡Š // å¦‚æœ ws &lt;= 0, é‚£ä¹ˆ compareAndSetWaitStatus å°†ä¼šè¢«è°ƒç”¨ï¼Œä¸Šç¯‡ä»‹ç»çš„æ—¶å€™è¯´è¿‡ï¼ŒèŠ‚ç‚¹å…¥é˜Ÿåï¼Œéœ€è¦æŠŠå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ä¸º Node.SIGNAL(-1) if (ws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL)) // å¦‚æœå‰é©±èŠ‚ç‚¹å–æ¶ˆæˆ–è€… CAS å¤±è´¥ï¼Œä¼šè¿›åˆ°è¿™é‡Œå”¤é†’çº¿ç¨‹ï¼Œä¹‹åçš„æ“ä½œçœ‹ä¸‹ä¸€èŠ‚ LockSupport.unpark(node.thread); return true;&#125; æ­£å¸¸æƒ…å†µä¸‹ï¼Œws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL) è¿™å¥ä¸­ï¼Œå¦‚æœws &lt;= 0ï¼Œé‚£ä¹ˆä¸€èˆ¬ compareAndSetWaitStatus(p, ws, Node.SIGNAL) ä¼šè¿”å› trueï¼Œæ‰€ä»¥ä¸€èˆ¬ä¹Ÿä¸ä¼šè¿›å» if è¯­å¥å—ä¸­å”¤é†’ node å¯¹åº”çš„çº¿ç¨‹ã€‚ç„¶åè¿™ä¸ªæ–¹æ³•è¿”å› trueï¼Œä¹Ÿå°±æ„å‘³ç€ signal æ–¹æ³•ç»“æŸäº†ï¼ŒèŠ‚ç‚¹è¿›å…¥äº†é˜»å¡é˜Ÿåˆ—ã€‚ å‡è®¾å‘ç”Ÿäº†é˜»å¡é˜Ÿåˆ—ä¸­çš„å‰é©±èŠ‚ç‚¹å–æ¶ˆç­‰å¾…ï¼Œæˆ–è€… CAS å¤±è´¥ï¼Œåªè¦å”¤é†’çº¿ç¨‹ï¼Œè®©å…¶è¿›åˆ°ä¸‹ä¸€æ­¥å³å¯ æ²¡æœ‰å”¤é†’çš„è¯ï¼Œå› ä¸ºå·²ç»åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…å‰é©±èŠ‚ç‚¹å»å”¤é†’ã€‚ 3. å”¤é†’åçš„æ“ä½œä¸Šä¸€æ­¥ signal ä¹‹åï¼Œæˆ‘ä»¬çš„çº¿ç¨‹ç”±æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°äº†é˜»å¡é˜Ÿåˆ—ï¼Œä¹‹åå°±å‡†å¤‡è·å–é”äº†ã€‚åªè¦é‡æ–°è·å–åˆ°é”äº†ä»¥åï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚ ç­‰çº¿ç¨‹ä»æŒ‚èµ·ä¸­æ¢å¤è¿‡æ¥ï¼Œç»§ç»­å¾€ä¸‹çœ‹ 12345678int interruptMode = 0;while (!isOnSyncQueue(node)) &#123; // çº¿ç¨‹æŒ‚èµ· LockSupport.park(this); if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break;&#125; 3.1. å…³äºinterruptMode REINTERRUPTï¼š ä»£è¡¨ await è¿”å›çš„æ—¶å€™ï¼Œéœ€è¦é‡æ–°è®¾ç½®ä¸­æ–­çŠ¶æ€ THROW_IEï¼š ä»£è¡¨ await è¿”å›çš„æ—¶å€™ï¼Œéœ€è¦æŠ›å‡ºInterruptedException å¼‚å¸¸ 0 ï¼šè¯´æ˜åœ¨ await æœŸé—´ï¼Œæ²¡æœ‰å‘ç”Ÿä¸­æ–­ æœ‰ä¸‰ç§æƒ…å†µå¯ä»¥è®©LockSupport.park(this);è¿”å›ï¼š å¸¸è§„è·¯å¾„ã€‚signal -&gt; è½¬ç§»èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ— -&gt; ç­‰å¾…å‰é©±èŠ‚ç‚¹å”¤é†’ çº¿ç¨‹ä¸­æ–­ã€‚åœ¨ park çš„æ—¶å€™ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªçº¿ç¨‹è¿›è¡Œäº†ä¸­æ–­ signal()çš„æ—¶å€™ï¼Œè½¬ç§»ä»¥åçš„å‰é©±èŠ‚ç‚¹å–æ¶ˆäº†ï¼Œæˆ–è€…å¯¹å‰é©±èŠ‚ç‚¹çš„CASæ“ä½œå¤±è´¥äº† å‡å”¤é†’ã€‚è¿™ä¸ªä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œå’Œ Object.wait() ç±»ä¼¼ï¼Œéƒ½æœ‰è¿™ä¸ªé—®é¢˜ çº¿ç¨‹å”¤é†’åç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨ checkInterruptWhileWaiting(node) è¿™ä¸ªæ–¹æ³•ï¼Œæ­¤æ–¹æ³•ç”¨äºåˆ¤æ–­æ˜¯å¦åœ¨çº¿ç¨‹æŒ‚èµ·æœŸé—´å‘ç”Ÿäº†ä¸­æ–­ï¼Œå¦‚æœå‘ç”Ÿäº†ä¸­æ–­ï¼Œæ˜¯ signal è°ƒç”¨ä¹‹å‰ä¸­æ–­çš„ï¼Œè¿˜æ˜¯ signal ä¹‹åå‘ç”Ÿçš„ä¸­æ–­ã€‚ 12345678// 1. å¦‚æœåœ¨ signal ä¹‹å‰å·²ç»ä¸­æ–­ï¼Œè¿”å› THROW_IE// 2. å¦‚æœæ˜¯ signal ä¹‹åä¸­æ–­ï¼Œè¿”å› REINTERRUPT// 3. æ²¡æœ‰å‘ç”Ÿä¸­æ–­ï¼Œè¿”å› 0private int checkInterruptWhileWaiting(Node node) &#123; return Thread.interrupted() ? (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : 0;&#125; åˆ¤æ–­signalä¹‹å‰è¿˜æ˜¯ä¹‹åä¸­æ–­çš„æ–¹æ³•ï¼š 1234567891011121314151617181920// åªæœ‰çº¿ç¨‹å¤„äºä¸­æ–­çŠ¶æ€ï¼Œæ‰ä¼šè°ƒç”¨æ­¤æ–¹æ³•// å¦‚æœéœ€è¦çš„è¯ï¼Œå°†è¿™ä¸ªå·²ç»å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—// è¿”å› trueï¼šå¦‚æœæ­¤çº¿ç¨‹åœ¨ signal ä¹‹å‰è¢«å–æ¶ˆï¼Œfinal boolean transferAfterCancelledWait(Node node) &#123; // ç”¨ CAS å°†èŠ‚ç‚¹çŠ¶æ€è®¾ç½®ä¸º 0 // å¦‚æœè¿™æ­¥ CAS æˆåŠŸï¼Œè¯´æ˜æ˜¯ signal æ–¹æ³•ä¹‹å‰å‘ç”Ÿçš„ä¸­æ–­ï¼Œå› ä¸ºå¦‚æœ signal å…ˆå‘ç”Ÿçš„è¯ï¼Œsignal ä¸­ä¼šå°† waitStatus è®¾ç½®ä¸º 0 if (compareAndSetWaitStatus(node, Node.CONDITION, 0)) &#123; // å°†èŠ‚ç‚¹æ”¾å…¥é˜»å¡é˜Ÿåˆ— // è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå³ä½¿ä¸­æ–­äº†ï¼Œä¾ç„¶ä¼šè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ— enq(node); return true; &#125; // åˆ°è¿™é‡Œæ˜¯å› ä¸º CAS å¤±è´¥ï¼Œè‚¯å®šæ˜¯å› ä¸º signal æ–¹æ³•å·²ç»å°† waitStatus è®¾ç½®ä¸ºäº† 0 // signal æ–¹æ³•ä¼šå°†èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯å¯èƒ½è¿˜æ²¡å®Œæˆï¼Œè¿™è¾¹è‡ªæ—‹ç­‰å¾…å…¶å®Œæˆ // å½“ç„¶ï¼Œè¿™ç§äº‹æƒ…è¿˜æ˜¯æ¯”è¾ƒå°‘çš„å§ï¼šsignal è°ƒç”¨ä¹‹åï¼Œæ²¡å®Œæˆè½¬ç§»ä¹‹å‰ï¼Œå‘ç”Ÿäº†ä¸­æ–­ while (!isOnSyncQueue(node)) Thread.yield(); return false;&#125; ä¸Šé¢çš„ä»£ç å°±æ˜¯è®¨è®ºçº¿ç¨‹ä¸­æ–­åæ€ä¹ˆè®©ç¨‹åºæ¢å¤æ­£å¸¸ã€‚ signalä¹‹å‰ä¸­æ–­ï¼Œæ‰§è¡Œenq(node)ï¼Œç¡®ä¿è¿›å…¥é˜»å¡é˜Ÿåˆ—ã€‚ signalä¹‹åä¸­æ–­ï¼Œæ²¡è½¬ç§»å®Œæˆï¼ˆåˆ¤æ–­waitStatus==0),è®©å‡ºcpuï¼Œè‡ªæ—‹ç›´è‡³enq(node)æ‰§è¡Œå®Œæˆã€‚ æ¥ç€è·å–ç‹¬å é”ï¼Œçœ‹æ¥ä¸‹æ¥çš„ä»£ç  12if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; ç”±äº while å‡ºæ¥åï¼Œæˆ‘ä»¬ç¡®å®šèŠ‚ç‚¹å·²ç»è¿›å…¥äº†é˜»å¡é˜Ÿåˆ—ï¼Œå‡†å¤‡è·å–é”ã€‚ è¿™é‡Œçš„ acquireQueued(node, savedState) çš„ç¬¬ä¸€ä¸ªå‚æ•° node ä¹‹å‰å·²ç»ç»è¿‡ enq(node) è¿›å…¥äº†é˜Ÿåˆ—ï¼Œå‚æ•° savedState æ˜¯ä¹‹å‰é‡Šæ”¾é”å‰çš„ stateï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„æ—¶å€™ï¼Œä»£è¡¨å½“å‰çº¿ç¨‹è·å–äº†é”ï¼Œè€Œä¸” state == savedStateäº†, åŸæ¥é‡å…¥äº†å‡ æ¬¡ï¼Œç°åœ¨è¿˜æ˜¯ç®—å‡ æ¬¡ã€‚ æ³¨æ„ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œä¸ç®¡æœ‰æ²¡æœ‰å‘ç”Ÿä¸­æ–­ï¼Œéƒ½ä¼šè¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œè€Œ acquireQueued(node, savedState) çš„è¿”å›å€¼å°±æ˜¯ä»£è¡¨çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ã€‚å¦‚æœè¿”å› trueï¼Œè¯´æ˜è¢«ä¸­æ–­äº†ï¼Œè€Œä¸” interruptMode != THROW_IEï¼Œè¯´æ˜åœ¨ signal ä¹‹å‰å°±å‘ç”Ÿä¸­æ–­äº†ï¼Œè¿™é‡Œå°† interruptMode è®¾ç½®ä¸º REINTERRUPTï¼Œç”¨äºå¾…ä¼šé‡æ–°ä¸­æ–­ã€‚ ç»§ç»­ 1234 if (node.nextWaiter != null) // clean up if cancelled unlinkCancelledWaiters();if (interruptMode != 0) reportInterruptAfterWait(interruptMode); node.nextWaiter != nullä¾æ—§æ˜¯å¯¹ä¸­æ–­çš„å–„åï¼Œå‰é¢signal çš„æ—¶å€™ä¼šå°†èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œæœ‰ä¸€æ­¥æ˜¯ node.nextWaiter = nullï¼Œå°†æ–­å¼€èŠ‚ç‚¹å’Œæ¡ä»¶é˜Ÿåˆ—çš„è”ç³»ã€‚ å¯æ˜¯ï¼Œåœ¨åˆ¤æ–­å‘ç”Ÿä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œæ˜¯ signal ä¹‹å‰è¿˜æ˜¯ä¹‹åå‘ç”Ÿçš„ï¼Ÿ è¿™éƒ¨åˆ†çš„æ—¶å€™ï¼Œæˆ‘ä¹Ÿä»‹ç»äº†ï¼Œå¦‚æœ signal ä¹‹å‰å°±ä¸­æ–­äº†ï¼Œä¹Ÿéœ€è¦å°†èŠ‚ç‚¹è¿›è¡Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œè¿™éƒ¨åˆ†è½¬ç§»çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰è®¾ç½® node.nextWaiter = null çš„ã€‚ ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œå¦‚æœæœ‰èŠ‚ç‚¹å–æ¶ˆï¼Œä¹Ÿä¼šè°ƒç”¨ unlinkCancelledWaiters è¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯è¿™é‡Œäº†ã€‚ æ¥ä¸‹æ¥æ˜¯è¿›å…¥reportInterruptAfterWaitä»£ç å—ï¼š 1234567891011121314/** * Throws InterruptedException, reinterrupts current thread, or * does nothing, depending on mode. */ private void reportInterruptAfterWait(int interruptMode) throws InterruptedException &#123; // THROW_IE è·‘å‡ºå¼‚å¸¸ if (interruptMode == THROW_IE) throw new InterruptedException(); // é‡æ–°ä¸­æ–­ï¼Œè‡ªæˆ‘äº†æ–­ else if (interruptMode == REINTERRUPT) selfInterrupt(); // 0ä¸å¤„ç† &#125; 4. å…¶ä»–await4.1. è¶…æ—¶awaitè¶…æ—¶çš„awaitéƒ½å·®ä¸å¤šï¼Œ 123456public final long awaitNanos(long nanosTimeout) throws InterruptedExceptionpublic final boolean awaitUntil(Date deadline) throws InterruptedExceptionpublic final boolean await(long time, TimeUnit unit) throws InterruptedException çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³• 12345678910111213141516171819202122232425262728293031public final long awaitNanos(long nanosTimeout) throws InterruptedException &#123; if (Thread.interrupted()) throw new InterruptedException(); Node node = addConditionWaiter(); int savedState = fullyRelease(node); final long deadline = System.nanoTime() + nanosTimeout; int interruptMode = 0; while (!isOnSyncQueue(node)) &#123; // è¶…æ—¶å•¦ if (nanosTimeout &lt;= 0L) &#123; transferAfterCancelledWait(node); break; &#125; // spinForTimeoutThreshold = 1000ï¼ˆ1msï¼‰ï¼Œå½“è¶…æ—¶æ—¶é—´å¤§äº1msæ‰æŒ‚èµ·ï¼Œå¦åˆ™ç»§ç»­è‡ªæ—‹ if (nanosTimeout &gt;= spinForTimeoutThreshold) // æŒ‡å®šæ—¶é—´çš„æŒ‚èµ· LockSupport.parkNanos(this, nanosTimeout); // é†’æ¥æ£€æŸ¥æ˜¯å¦signalå‘ç”Ÿä¸­æ–­ if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; nanosTimeout = deadline - System.nanoTime(); &#125; if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; if (node.nextWaiter != null) unlinkCancelledWaiters(); if (interruptMode != 0) reportInterruptAfterWait(interruptMode); return deadline - System.nanoTime();&#125; è¶…æ—¶çš„æ€è·¯è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä¸å¸¦è¶…æ—¶å‚æ•°çš„ await æ˜¯ parkï¼Œç„¶åç­‰å¾…åˆ«äººå”¤é†’ã€‚è€Œç°åœ¨å°±æ˜¯è°ƒç”¨ parkNanos æ–¹æ³•æ¥ä¼‘çœ æŒ‡å®šçš„æ—¶é—´ï¼Œé†’æ¥ååˆ¤æ–­æ˜¯å¦ signal è°ƒç”¨äº†ï¼Œè°ƒç”¨äº†å°±æ˜¯æ²¡æœ‰è¶…æ—¶ï¼Œå¦åˆ™å°±æ˜¯è¶…æ—¶äº†ã€‚è¶…æ—¶çš„è¯ï¼Œè‡ªå·±æ¥è¿›è¡Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼ˆcheckInterruptWhileWaitingæ–¹æ³•ï¼‰ï¼Œç„¶åacquireQueuedæŠ¢é”ã€‚ 5. ä¸æŠ›ä¸­æ–­å¼‚å¸¸çš„await123456789101112public final void awaitUninterruptibly() &#123; Node node = addConditionWaiter(); int savedState = fullyRelease(node); boolean interrupted = false; while (!isOnSyncQueue(node)) &#123; LockSupport.park(this); if (Thread.interrupted()) interrupted = true; &#125; if (acquireQueued(node, savedState) || interrupted) selfInterrupt();&#125; é†’æ¥åæ£€æŸ¥ä¸­æ–­ï¼ŒæŠŠä¸­æ–­åäº†,ä½¿ç”¨æ—¶ç¡®ä¿åˆ«äººä¸ä¼šæ¥ä¸­æ–­ä»–ã€‚ 6. ReentrantLockçš„ä¸­æ–­é”è¿™ç¯‡è®²äº†å¾ˆå¤šä¸­æ–­çš„å¤„ç†ï¼Œé‚£ä¹ˆå›å¤´çœ‹ReentrantLockçš„lock()æ–¹æ³•ï¼Œå®ƒé‡Œé¢å®é™…ä¸Šé»˜è®¤æ˜¯åäº†ä¸­æ–­çš„ï¼Œæƒ³é€šè¿‡ä¸­æ–­çº¿ç¨‹æ¥å–æ¶ˆä¸€ä¸ªé”çš„è·å–æ˜¯ä¸å¯ä»¥çš„ 123456789101112131415161718192021final boolean acquireQueued(final Node node, int arg) &#123; boolean failed = true; try &#123; boolean interrupted = false; for (;;) &#123; final Node p = node.predecessor(); if (p == head &amp;&amp; tryAcquire(arg)) &#123; setHead(node); p.next = null; // help GC failed = false; return interrupted; &#125; if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; å¯ä»¥çœ‹åˆ°interrupted = true;ä¹‹ååˆå¼€å§‹è‡ªæ—‹äº†ï¼Œæ‰“äº†ä¸ªæ ‡å¿—ä¹‹åè¿˜æ˜¯åƒæ²¡äº‹äººä¸€æ ·è·å–ğŸ”’ã€‚ è¿™æ—¶å€™è¯·çœ‹lockInterruptibly()æ–¹æ³•ï¼š 123public void lockInterruptibly() throws InterruptedException &#123; sync.acquireInterruptibly(1);&#125; 1234567public final void acquireInterruptibly(int arg) throws InterruptedException &#123; if (Thread.interrupted()) throw new InterruptedException(); if (!tryAcquire(arg)) doAcquireInterruptibly(arg);&#125; å¦‚æœçº¿ç¨‹ä¸­æ–­ï¼Œå¼€å§‹ç–¯ç‹‚æŠ›å¼‚å¸¸ 123456789101112131415161718192021222324252627/** * Acquires in exclusive interruptible mode. * @param arg the acquire argument */private void doAcquireInterruptibly(int arg) throws InterruptedException &#123; final Node node = addWaiter(Node.EXCLUSIVE); boolean failed = true; try &#123; for (;;) &#123; final Node p = node.predecessor(); if (p == head &amp;&amp; tryAcquire(arg)) &#123; setHead(node); p.next = null; // help GC failed = false; return; &#125; if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) // ç–¯ç‹‚æŠ›å¼‚å¸¸ throw new InterruptedException(); &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; è¿™é‡ŒæŠ›å¼‚å¸¸çš„è¯ï¼Œfailedæ˜¯trueçš„ï¼Œç»ˆäºæœ‰æœºä¼šè¿›å…¥cancelAcquire(node)äº†ï¼Œ 12345678910111213141516171819202122232425262728293031323334353637383940414243private void cancelAcquire(Node node) &#123; // Ignore if node doesn't exist if (node == null) return; node.thread = null; // Skip cancelled predecessors Node pred = node.prev; while (pred.waitStatus &gt; 0) node.prev = pred = pred.prev; // predNext is the apparent node to unsplice. CASes below will // fail if not, in which case, we lost race vs another cancel // or signal, so no further action is necessary. Node predNext = pred.next; // Can use unconditional write instead of CAS here. // After this atomic step, other Nodes can skip past us. // Before, we are free of interference from other threads. node.waitStatus = Node.CANCELLED; // If we are the tail, remove ourselves. if (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123; compareAndSetNext(pred, predNext, null); &#125; else &#123; // If successor needs signal, try to set pred's next-link // so it will get one. Otherwise wake it up to propagate. int ws; if (pred != head &amp;&amp; ((ws = pred.waitStatus) == Node.SIGNAL || (ws &lt;= 0 &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp; pred.thread != null) &#123; Node next = node.next; if (next != null &amp;&amp; next.waitStatus &lt;= 0) compareAndSetNext(pred, predNext, next); &#125; else &#123; unparkSuccessor(node); &#125; node.next = node; // help GC &#125;&#125; è¿™é‡Œä¼šæŠŠnode.waitStatus = Node.CANCELLED;ï¼Œå¦‚æœæ˜¯å¤´èŠ‚ç‚¹ï¼Œåˆ™å”¤é†’æŒ‚èµ·çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦åˆ™caså°†å‰é©±èŠ‚ç‚¹çš„nextæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„nextï¼ŒæŠŠè‡ªå·±ä»é˜»å¡é˜Ÿåˆ—æ¸…é™¤ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]AQSä¸ReentrantLock","slug":"JavaåŸºç¡€-AQSä¸Lock","date":"2018-08-22T15:54:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"2430429572.html","link":"","permalink":"https://htchz.cc/2430429572.html","excerpt":"AQSæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ˜¯javaè®¸å¤šLockå®ç°å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚","text":"AQSæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ˜¯javaè®¸å¤šLockå®ç°å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚ AQSï¼Œäººç§°AbstractQueuedSynchronizerï¼Œå®ƒçš„å­ç±»æœ‰å¦‚ä¸‹ï¼š æœ‰ReentrantLockå†…éƒ¨ç±»FairSyncã€NonfairSyncå³å…¬å¹³é”ä¸éå…¬å¹³é”ç­‰ã€‚ä»–æœ‰ä¸€ä¸ªvolatile int stateå±æ€§ï¼Œè¡¨æ˜é”çš„å æœ‰æƒ…å†µï¼š 1234/** * The synchronization state. */private volatile int state; è¿™é‡Œå…ˆå‰§é€ä¸€ä¸‹ï¼ŒAQSæ˜¯ä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆé˜Ÿå¤´çº¿ç¨‹ç†åº”æ‹¿åˆ°é”ï¼Œè¿™æ˜¯å…¬å¹³é”çš„æƒ…å†µã€‚è€Œéå…¬å¹³é”çš„æƒ…å†µä¸‹ï¼Œé”åœ¨åˆšé‡Šæ”¾çš„æ—¶å€™ï¼ˆstate==0ï¼‰ï¼Œé˜Ÿå¤´çº¿ç¨‹å¯èƒ½è¢«æ–°æ¥çš„æ’é˜Ÿï¼Œæ–°æ¥çš„æ’é˜Ÿå¤±è´¥ï¼Œæ‰ä¹–ä¹–åœ°æ’åˆ°é˜Ÿå°¾ï¼Œæ‰€ä»¥éå…¬å¹³é”å¹¶ä¸æ˜¯å°±æ²¡æœ‰é˜Ÿåˆ—çš„æ¦‚å¿µã€‚ æˆ‘ä»¬ç»“åˆReentrantLockæ¥çœ‹AQSåœ¨Locké‡Œçš„ä½¿ç”¨ä¾‹å­ã€‚ 1. åŠ é”çœ‹ReentrantLockçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š 123456789101112131415161718 /** * Creates an instance of &#123;@code ReentrantLock&#125;. * This is equivalent to using &#123;@code ReentrantLock(false)&#125;. */ public ReentrantLock() &#123; sync = new NonfairSync(); &#125; /** * Creates an instance of &#123;@code ReentrantLock&#125; with the * given fairness policy. * * @param fair &#123;@code true&#125; if this lock should use a fair ordering policy */ public ReentrantLock(boolean fair) &#123; sync = fair ? new FairSync() : new NonfairSync(); &#125;` å¾ˆæ˜æ˜¾ï¼ŒReentrantLockèƒ½æ„é€ å…¬å¹³æˆ–è€…ä¸å…¬å¹³çš„é”ï¼Œé»˜è®¤æ˜¯éå…¬å¹³çš„ã€‚æˆ‘ä»¬å…ˆçœ‹éå…¬å¹³é”çš„å®ç°ã€‚ 123456789101112131415161718192021/** * Sync object for non-fair locks */static final class NonfairSync extends Sync &#123; private static final long serialVersionUID = 7316153563782823691L; /** * Performs lock. Try immediate barge, backing up to normal * acquire on failure. */ final void lock() &#123; if (compareAndSetState(0, 1)) setExclusiveOwnerThread(Thread.currentThread()); else acquire(1); &#125; protected final boolean tryAcquire(int acquires) &#123; return nonfairTryAcquire(acquires); &#125;&#125; è¿™ä¸ªç±»ç»§æ‰¿äº†Syncï¼Œä¹Ÿæ˜¯AQSçš„å­ç±»ã€‚lock()æ–¹æ³•å…ˆé€šè¿‡CASå°è¯•å°†çŠ¶æ€ä»0ä¿®æ”¹ä¸º1ã€‚è‹¥ç›´æ¥ä¿®æ”¹æˆåŠŸï¼Œå‰ææ¡ä»¶è‡ªç„¶æ˜¯é”çš„çŠ¶æ€ä¸º0ï¼Œåˆ™ç›´æ¥å°†çº¿ç¨‹çš„OWNERä¿®æ”¹ä¸ºå½“å‰çº¿ç¨‹ï¼Œè¿™æ˜¯ä¸€ç§ç†æƒ³æƒ…å†µï¼Œå¦‚æœå¹¶å‘ç²’åº¦è®¾ç½®é€‚å½“ä¹Ÿæ˜¯ä¸€ç§ä¹è§‚æƒ…å†µã€‚è‹¥ä¸Šä¸€ä¸ªåŠ¨ä½œæœªæˆåŠŸï¼Œåˆ™ä¼šé—´æ¥è°ƒç”¨äº†acquire(1)æ¥ç»§ç»­æ“ä½œï¼Œè¿™ä¸ªacquire(int)æ–¹æ³•å°±æ˜¯åœ¨AbstractQueuedSynchronizerå½“ä¸­äº†ã€‚ 12345public final void acquire(int arg) &#123; if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt();&#125; é¦–å…ˆçœ‹tryAcquire(arg)è¿™é‡Œçš„è°ƒç”¨ï¼ˆå½“ç„¶ä¼ å…¥çš„å‚æ•°æ˜¯1ï¼‰,è¿™ä¸ªæ–¹æ³•åˆäº¤ç»™å­ç±»å®ç°äº†ï¼Œæœ€ç»ˆæ˜¯è½åˆ°Syncé‡Œ 123456789101112131415161718final boolean nonfairTryAcquire(int acquires) &#123; final Thread current = Thread.currentThread(); int c = getState(); if (c == 0) &#123; if (compareAndSetState(0, acquires)) &#123; setExclusiveOwnerThread(current); return true; &#125; &#125; else if (current == getExclusiveOwnerThread()) &#123; int nextc = c + acquires; if (nextc &lt; 0) // overflow throw new Error(\"Maximum lock count exceeded\"); setState(nextc); return true; &#125; return false;&#125; åˆ¤æ–­é”æ˜¯å¦è¢«å æœ‰ï¼šé¦–å…ˆè·å–è¿™ä¸ªé”çš„çŠ¶æ€ï¼Œå¦‚æœçŠ¶æ€ä¸º0ï¼Œåˆ™å°è¯•è®¾ç½®çŠ¶æ€ä¸ºä¼ å…¥çš„å‚æ•°ï¼ˆè¿™é‡Œå°±æ˜¯1ï¼‰ï¼Œè‹¥è®¾ç½®æˆåŠŸå°±ä»£è¡¨è‡ªå·±è·å–åˆ°äº†é”ï¼Œè¿”å›trueäº†ã€‚çŠ¶æ€ä¸º0è®¾ç½®1çš„åŠ¨ä½œåœ¨å¤–éƒ¨å°±æœ‰åšè¿‡ä¸€æ¬¡ï¼Œå†…éƒ¨å†ä¸€æ¬¡åšåªæ˜¯æå‡æ¦‚ç‡ï¼Œè€Œä¸”è¿™æ ·çš„æ“ä½œç›¸å¯¹é”æ¥è®²ä¸å å¼€é”€ã€‚ åˆ¤æ–­èƒ½å¦é‡å…¥ï¼šå¦‚æœçŠ¶æ€ä¸æ˜¯0ï¼Œåˆ™åˆ¤å®šå½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºæ’å®ƒé”çš„Ownerï¼Œå¦‚æœæ˜¯Owneråˆ™å°è¯•å°†çŠ¶æ€å¢åŠ acquiresï¼ˆä¹Ÿå°±æ˜¯å¢åŠ 1ï¼‰ï¼Œå¦‚æœè¿™ä¸ªçŠ¶æ€å€¼è¶Šç•Œï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸æç¤ºï¼Œè‹¥æ²¡æœ‰è¶Šç•Œï¼Œå°†çŠ¶æ€è®¾ç½®è¿›å»åè¿”å›trueï¼ˆå®ç°äº†ç±»ä¼¼äºåå‘çš„åŠŸèƒ½ï¼Œå¯é‡å…¥ï¼Œä½†æ˜¯æ— éœ€è¿›ä¸€æ­¥å¾ç”¨ï¼‰ã€‚ å¦‚æœçŠ¶æ€ä¸æ˜¯0ï¼Œä¸”è‡ªèº«ä¸æ˜¯ownerï¼Œåˆ™è¿”å›falseï¼Œè·å–é”å¤±è´¥ å›åˆ°AQSçš„acquireæ–¹æ³•ï¼Œåˆ¤å®šä¸­æ˜¯é€šè¿‡if(!tryAcquire())ä½œä¸ºç¬¬1ä¸ªæ¡ä»¶çš„ï¼Œå¦‚æœè¿”å›è·å–å¤±è´¥çš„è¯ï¼Œç»§ç»­acquireQueued(addWaiter(Node.EXCLUSIVE), arg))ä»£ç ï¼Œå…ˆçœ‹ç¬¬ä¸€ä¸ª 1234567891011121314151617181920/** * Creates and enqueues node for current thread and given mode. * * @param mode Node.EXCLUSIVE for exclusive, Node.SHARED for shared * @return the new node */private Node addWaiter(Node mode) &#123; Node node = new Node(Thread.currentThread(), mode); // Try the fast path of enq; backup to full enq on failure Node pred = tail; if (pred != null) &#123; node.prev = pred; if (compareAndSetTail(pred, node)) &#123; pred.next = node; return node; &#125; &#125; enq(node); return node;&#125; è¿™é‡Œçš„å‚æ•°ä½¿ç”¨äº†Node.EXCLUSIVE,å³æ’ä»–çš„æ„æ€ã€‚Nodeçš„ç»“æ„å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738static final class Node &#123; /** Marker to indicate a node is waiting in shared mode */ // æ ‡è¯†èŠ‚ç‚¹å½“å‰åœ¨å…±äº«æ¨¡å¼ä¸‹ static final Node SHARED = new Node(); /** Marker to indicate a node is waiting in exclusive mode */ // æ ‡è¯†èŠ‚ç‚¹å½“å‰åœ¨ç‹¬å æ¨¡å¼ä¸‹ static final Node EXCLUSIVE = null; // ======== ä¸‹é¢çš„å‡ ä¸ªintå¸¸é‡æ˜¯ç»™waitStatusç”¨çš„ =========== /** waitStatus value to indicate thread has cancelled */ // ä»£ç æ­¤çº¿ç¨‹å–æ¶ˆäº†äº‰æŠ¢è¿™ä¸ªé” static final int CANCELLED = 1; /** waitStatus value to indicate successor's thread needs unparking */ // å®˜æ–¹çš„æè¿°æ˜¯ï¼Œå…¶è¡¨ç¤ºå½“å‰nodeçš„åç»§èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹éœ€è¦è¢«å”¤é†’ static final int SIGNAL = -1; /** waitStatus value to indicate thread is waiting on condition */ // æœ¬æ–‡ä¸åˆ†æconditionï¼Œæ‰€ä»¥ç•¥è¿‡å§ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ä¼šä»‹ç»è¿™ä¸ª static final int CONDITION = -2; /** * waitStatus value to indicate the next acquireShared should * unconditionally propagate */ // åŒæ ·çš„ä¸åˆ†æï¼Œç•¥è¿‡å§ static final int PROPAGATE = -3; // ===================================================== // å–å€¼ä¸ºä¸Šé¢çš„1ã€-1ã€-2ã€-3ï¼Œæˆ–è€…0(ä»¥åä¼šè®²åˆ°) // è¿™ä¹ˆç†è§£ï¼Œæš‚æ—¶åªéœ€è¦çŸ¥é“å¦‚æœè¿™ä¸ªå€¼ å¤§äº0 ä»£è¡¨æ­¤çº¿ç¨‹å–æ¶ˆäº†ç­‰å¾…ï¼Œ // ä¹Ÿè®¸å°±æ˜¯è¯´åŠå¤©æŠ¢ä¸åˆ°é”ï¼Œä¸æŠ¢äº†ï¼ŒReentrantLockæ˜¯å¯ä»¥æŒ‡å®štimeouotçš„ã€‚ã€‚ã€‚ volatile int waitStatus; // å‰é©±èŠ‚ç‚¹çš„å¼•ç”¨ volatile Node prev; // åç»§èŠ‚ç‚¹çš„å¼•ç”¨ volatile Node next; // è¿™ä¸ªå°±æ˜¯çº¿ç¨‹æœ¬å°Š volatile Thread thread;&#125; å¾ˆæ˜æ˜¾ï¼ŒAQSæ˜¯ä¸ªé“¾è¡¨ç»“æ„ï¼Œè¿˜æ˜¯åŒå‘çš„ã€‚Nodeåˆå§‹åŒ–ï¼Œä¿å­˜äº†å½“å‰çº¿ç¨‹ï¼Œå¹¶èµ‹å€¼ç»™nextWaiterå±æ€§ã€‚ 1234Node(Thread thread, Node mode) &#123; // Used by addWaiter this.nextWaiter = mode; this.thread = thread;&#125; è€Œæœ€åˆï¼Œtailè‚¯å®šæ˜¯nullçš„ï¼Œç›´æ¥çœ‹enq(node)æ–¹æ³•ï¼š 1234567891011121314151617181920/** * Inserts node into queue, initializing if necessary. See picture above. * @param node the node to insert * @return node's predecessor */private Node enq(final Node node) &#123; for (;;) &#123; Node t = tail; if (t == null) &#123; // Must initialize if (compareAndSetHead(new Node())) tail = head; &#125; else &#123; node.prev = t; if (compareAndSetTail(t, node)) &#123; t.next = node; return t; &#125; &#125; &#125;&#125; ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè¿™æ®µä»£ç åˆ©ç”¨casæ’å…¥nodeï¼Œå¦‚æœcaså¤±è´¥ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ç»§ç»­å°è¯•ã€‚æœ€ç»ˆè¿”å›çš„æ˜¯Nodeçš„å‰é©±èŠ‚ç‚¹(addWaiteræ²¡æœ‰ç”¨åˆ°è¿™ä¸ªè¿”å›å€¼)ï¼Œç¬¬ä¸€ä¸ªæ’å…¥çš„ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªç©ºï¼ˆå®ä¾‹åŒ–ä½†æ²¡æœ‰ä¿¡æ¯ï¼‰çš„å¤´èŠ‚ç‚¹å†appendæ“ä½œã€‚å›åˆ°addWaiterï¼Œå¯ä»¥å‘ç°å¦‚æœtail==nullï¼Œæ¥ä¸‹æ¥æ‰§è¡Œçš„ä»£ç å—å’Œenqï¼ˆnodeï¼‰çš„éƒ¨åˆ†ä»£ç æ˜¯ä¸€æ ·çš„ï¼Œæ€»ä¹‹ï¼ŒaddWaiterä¼šåˆå§‹åŒ–ä¸€ä¸ªä¿å­˜åˆå§‹åŒ–çº¿ç¨‹çš„nodeï¼ŒåŠ å…¥AQSï¼Œå¹¶è¿”å›ã€‚è¿”å›çš„Nodeå’Œarg=1ä¼ å…¥acquireQueuedæ–¹æ³•ï¼Œ 123456789101112131415161718192021222324252627282930/** * Acquires in exclusive uninterruptible mode for thread already in * queue. Used by condition wait methods as well as acquire. * * @param node the node * @param arg the acquire argument * @return &#123;@code true&#125; if interrupted while waiting */final boolean acquireQueued(final Node node, int arg) &#123; boolean failed = true; try &#123; boolean interrupted = false; for (;;) &#123; // è¿™é‡Œåˆ¤æ–­å‰é©±èŠ‚ç‚¹æ˜¯ä¸æ˜¯headï¼Œè€Œä¸æ˜¯åˆ¤æ–­å½“å‰èŠ‚ç‚¹ï¼Œå› ä¸ºé˜Ÿå¤´æ˜¯å·²ç»å æœ‰é”çš„/æˆ–è€…æ˜¯ç©ºèŠ‚ç‚¹ï¼ˆè¯·çœ‹enqæ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥åªè¦é˜Ÿåˆ—è€äºŒå°±å¯ä»¥å¼€å§‹tryAcquireäº† final Node p = node.predecessor(); if (p == head &amp;&amp; tryAcquire(arg)) &#123; setHead(node); p.next = null; // help GC failed = false; return interrupted; &#125; if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; &#125; &#125; finally &#123; if (failed)// æ²¡æœ‰æ­£ç¡®é€€å‡ºï¼Œå°†æœ¬èŠ‚ç‚¹å–æ¶ˆ cancelAcquire(node); &#125;&#125; è¿™é‡Œåˆæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼ŒaddWaiteræ˜¯æ’å…¥çš„nodeèŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œå¦‚æœå‰é©±èŠ‚ç‚¹ä¸ºheadçš„è¯ï¼Œè¯´æ˜çº¿ç¨‹æ¥åˆ°äº†é˜Ÿå¤´ï¼Œç»§ç»­æ‰§è¡ŒtryRequireæ–¹æ³•ï¼ŒtryAcquire(arg)è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å‰é¢ä»‹ç»è¿‡ï¼Œæˆç«‹çš„æ¡ä»¶ä¸ºï¼šé”çš„çŠ¶æ€ä¸º0ï¼Œä¸”é€šè¿‡CASå°è¯•è®¾ç½®çŠ¶æ€æˆåŠŸæˆ–çº¿ç¨‹çš„æŒæœ‰è€…æœ¬èº«æ˜¯å½“å‰çº¿ç¨‹æ‰ä¼šè¿”å›trueï¼Œæˆ‘ä»¬ç°åœ¨æ¥è¯¦ç»†æ‹†åˆ†è¿™éƒ¨åˆ†ä»£ç ã€‚ å¦‚æœè¿™ä¸ªæ¡ä»¶æˆåŠŸåï¼Œå‘ç”Ÿçš„å‡ ä¸ªåŠ¨ä½œåŒ…å«ï¼š é¦–å…ˆè°ƒç”¨setHead(Node)çš„æ“ä½œï¼Œè¿™ä¸ªæ“ä½œå†…éƒ¨ä¼šå°†ä¼ å…¥çš„nodeèŠ‚ç‚¹ä½œä¸ºAQSçš„headæ‰€æŒ‡å‘çš„èŠ‚ç‚¹ã€‚çº¿ç¨‹å±æ€§è®¾ç½®ä¸ºç©ºï¼ˆå› ä¸ºç°åœ¨å·²ç»è·å–åˆ°é”ï¼Œä¸å†éœ€è¦è®°å½•ä¸‹è¿™ä¸ªèŠ‚ç‚¹æ‰€å¯¹åº”çš„çº¿ç¨‹äº†ï¼‰ï¼Œå†å°†è¿™ä¸ªèŠ‚ç‚¹çš„pervå¼•ç”¨èµ‹å€¼ä¸ºnullã€‚ è¿›ä¸€æ­¥å°†çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„nextå¼•ç”¨èµ‹å€¼ä¸ºnullã€‚ åœ¨è¿›è¡Œäº†è¿™æ ·çš„ä¿®æ”¹åï¼Œé˜Ÿåˆ—å°±å¯ä»¥è®©æ‰§è¡Œå®Œçš„èŠ‚ç‚¹é‡Šæ”¾æ‰å†…å­˜åŒºåŸŸï¼Œè€Œä¸æ˜¯æ— é™åˆ¶å¢é•¿é˜Ÿåˆ—ï¼Œä¹Ÿå°±çœŸæ­£å½¢æˆFIFOäº†ã€‚ 12345678910111213141516171819202122232425262728private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123; int ws = pred.waitStatus; if (ws == Node.SIGNAL) /* * This node has already set status asking a release * to signal it, so it can safely park. */ return true; if (ws &gt; 0) &#123; /* * Predecessor was cancelled. Skip over predecessors and * indicate retry. */ do &#123; node.prev = pred = pred.prev; &#125; while (pred.waitStatus &gt; 0); pred.next = node; &#125; else &#123; /* * waitStatus must be 0 or PROPAGATE. Indicate that we * need a signal, but don't park yet. Caller will need to * retry to make sure it cannot acquire before parking. */ // å¦‚æœå‰é¢çš„èŠ‚ç‚¹æ˜¯0ï¼ˆå› ä¸ºå‰é¢éƒ½æ²¡å‡ºç°è¿‡waitStatusçš„èµ‹å€¼ï¼Œæ‰€ä»¥åªèƒ½æ˜¯é»˜è®¤å€¼0ï¼‰ï¼Œ0æ˜¯åˆå§‹çŠ¶æ€ï¼Œé‚£ä¹ˆå°±æŠŠå®ƒç½®ä¸º**ç­‰å¾…å”¤é†’**çŠ¶æ€ï¼Œå¦‚æœä¸‹æ¬¡æŠ¢å é”å¤±è´¥ï¼Œå‰é©±èŠ‚ç‚¹å°±ä¼šæ˜¯-1ï¼Œä»è€Œè¿”å›trueï¼ŒæŒ‚èµ·çº¿ç¨‹ã€‚ compareAndSetWaitStatus(pred, ws, Node.SIGNAL); &#125; return false;&#125; å¦‚æœè·å–ä¸åˆ°é” åˆ¤æ–­shouldParkAfterFailedAcquire(p , node)ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šåˆ¤å®šå‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€æ˜¯å¦ä¸ºï¼šâ€œNode.SIGNALâ€ï¼Œè‹¥æ˜¯åˆ™è¿”å›trueï¼Œè‹¥ä¸æ˜¯éƒ½ä¼šè¿”å›falseï¼Œä¸è¿‡ä¼šå†åšä¸€äº›æ“ä½œï¼šåˆ¤å®šèŠ‚ç‚¹çš„çŠ¶æ€æ˜¯å¦å¤§äº0ï¼Œè‹¥å¤§äº0åˆ™è®¤ä¸ºè¢«â€œCANCELLEDâ€æ‰äº†ï¼ˆå¤§äº0çš„è¡¨ç¤ºCANCELLEDçš„çŠ¶æ€ï¼‰ï¼Œå› æ­¤ä¼šä»å‰ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹é€æ­¥å¾ªç¯æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰è¢«â€œCANCELLEDâ€èŠ‚ç‚¹ï¼Œç„¶åä¸è¿™ä¸ªèŠ‚ç‚¹çš„nextã€prevçš„å¼•ç”¨ç›¸äº’æŒ‡å‘ï¼ˆå³åˆ é™¤æ‰å–æ¶ˆçš„é˜Ÿåˆ—å…ƒç´ ï¼‰ï¼›å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¸æ˜¯å¤§äº0çš„ï¼Œåˆ™é€šè¿‡CASå°è¯•å°†çŠ¶æ€ä¿®æ”¹ä¸ºâ€œNode.SIGNALâ€ï¼Œè‡ªç„¶çš„å¦‚æœä¸‹ä¸€è½®å¾ªç¯çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æ‹¿åˆ°é”å°±ä¼šè¿”å›trueã€‚ å¦‚æœè¿™ä¸ªæ–¹æ³•è¿”å›äº†trueï¼Œåˆ™ä¼šæ‰§è¡Œï¼šâ€œparkAndCheckInterrupt()â€æ–¹æ³•ï¼Œå®ƒæ˜¯é€šè¿‡LockSupport.park(this)å°†å½“å‰çº¿ç¨‹æŒ‚èµ·åˆ°WATINGçŠ¶æ€ï¼Œå®ƒéœ€è¦ç­‰å¾…ä¸€ä¸ªä¸­æ–­ã€unparkæ–¹æ³•æ¥å”¤é†’å®ƒï¼Œé€šè¿‡è¿™æ ·ä¸€ç§FIFOçš„æœºåˆ¶çš„ç­‰å¾…ï¼Œæ¥å®ç°äº†Lockçš„æ“ä½œã€‚ è¿™é‡Œæœ‰ä¸ªèŠ‚ç‚¹çŠ¶æ€çš„å¯¹åº”å…³ç³» èŠ‚ç‚¹ç±»å‹ å€¼ è¯´æ˜ CANCELLED 1 çº¿ç¨‹å–æ¶ˆ SIGNAL -1 ç­‰å¾…å”¤é†’ CONDITION -2 ReenrantLockæ²¡ç”¨åˆ° PROPAGATE -3 ReenrantLockæ²¡ç”¨åˆ° ç®€å•åœ°è¯´ï¼Œé˜Ÿåˆ—ä¸­çš„çº¿ç¨‹è·å–ä¸åˆ°é”åˆæ£€æµ‹åˆ°å‰é¢æœ‰äººï¼Œé‚£å°±è¦æŒ‚èµ·ï¼Œç›´åˆ°æœ‰äººå”¤é†’ï¼Œè¿™ä¸ªå”¤é†’é å‰é¢çš„äººæ¥å”¤é†’ã€‚ è¿™é‡Œå†çœ‹ä¸‹éå…¬å¹³é”å’Œå…¬å¹³é”çš„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼šç›´æ¥ä¸Šæˆªå›¾è¿™æ˜¯éå…¬å¹³é” è¿™æ˜¯å…¬å¹³é” å¯ä»¥çœ‹å‡ºï¼Œéå…¬å¹³é”æ— è®ºæ˜¯åœ¨ç¬¬ä¸€æ¬¡å°è¯•lockï¼Œè¿˜æ˜¯åˆ°æœ‰æœºä¼štryAcquireæ—¶ï¼Œä¸Šæ¥å°±compareAndSetState(0,1)ï¼Œå®Œå…¨ä¸ç†ä¼šè‡ªå·±æ˜¯ä¸æ˜¯çœŸæ­£çš„é˜Ÿå¤´ï¼Œè€Œå…¬å¹³é”è¦å®¢æ°”åœ°è¿›è¡ŒhasQueuedPredecessors()åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯çœŸæ­£çš„é˜Ÿå¤´ã€‚ 1.1. å…¬å¹³é”å’Œéå…¬å¹³é”çš„å¯¹æ¯” å…¬å¹³é”ä¿è¯å„ä¸ªçº¿ç¨‹å¯ä»¥æ‹¿åˆ°é”ï¼Œä½†æ˜¯è¿™æ ·å¤§éƒ¨åˆ†çº¿ç¨‹ä¼šç»å†ä¸€ä¸ªæŒ‚èµ·ã€å”¤é†’çš„è€—æ€§èƒ½è¿‡ç¨‹ã€‚éå…¬å¹³é”å°½é‡å‡å°‘è¿™ä¸ªè€—æ€§èƒ½çš„è¿‡ç¨‹ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯ä¸šåŠ¡çš„é¡ºåºã€‚ å¦‚æœçº¿ç¨‹å æœ‰é”å¤„ç†ä¸šåŠ¡çš„æ—¶é—´è¿œå¤§äºæŒ‚èµ·ã€å”¤é†’çš„æ—¶é—´è€—è´¹ï¼Œé‚£ä¹ˆä½¿ç”¨å…¬å¹³é”å¯ä»¥å¢å¼ºå¯æ§æ€§ã€‚ 2. è§£é”è§£é”å°±æ²¡åˆ†å…¬å¹³ä¸ä¸å…¬å¹³äº†ï¼Œä¸»è¦ä»»åŠ¡å°±æ˜¯æ¶ˆé™¤é”å æœ‰æ ‡è¯†ï¼Œå”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ã€‚ æ¥ä¸‹æ¥ç®€å•çœ‹çœ‹unlock()è§£é™¤é”çš„æ–¹å¼ï¼Œå¦‚æœè·å–åˆ°äº†é”ä¸é‡Šæ”¾ï¼Œé‚£è‡ªç„¶å°±æˆäº†æ­»é”ï¼Œæ‰€ä»¥å¿…é¡»è¦é‡Šæ”¾ï¼Œæ¥çœ‹çœ‹å®ƒå†…éƒ¨æ˜¯å¦‚ä½•é‡Šæ”¾çš„ã€‚åŒæ ·ä»æ’å®ƒé”ï¼ˆReentrantLockï¼‰ä¸­çš„unlock()æ–¹æ³•å¼€å§‹ï¼š 123public void unlock() &#123; sync.release(1);&#125; 123456789public final boolean release(int arg) &#123; if (tryRelease(arg)) &#123; Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; &#125; return false;&#125; tryRelease(arg)è¿›å…¥åˆ°Syncçš„æ–¹æ³• 123456789101112protected final boolean tryRelease(int releases) &#123; int c = getState() - releases; if (Thread.currentThread() != getExclusiveOwnerThread()) throw new IllegalMonitorStateException(); boolean free = false; if (c == 0) &#123; free = true; setExclusiveOwnerThread(null); &#125; setState(c); return free;&#125; è¿™äº›æ˜¯é‡å…¥é€»è¾‘ï¼Œå¦‚æœstate==0é‚£ä¹ˆæ¸…ç©ºé”çš„å æœ‰è€…ã€‚ stateå‡çš„æ•°é‡æ˜¯æ ¹æ®å‚æ•°çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸‹å­æ¸…ç©ºï¼Œæ‰€ä»¥è°ƒç”¨å¤šå°‘æ¬¡lock(),åº”è¯¥è°ƒç”¨ç›¸å¯¹åº”æ¬¡æ•°çš„unlock() è™½ç„¶é”çŠ¶æ€æ¸…ç©ºäº†ï¼Œè¿™æ—¶è¢«é˜Ÿå¤´æŒ‚èµ·çš„çº¿ç¨‹è¿˜éœ€è¦unparkSuccessor(h)å”¤é†’ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªå¤´èŠ‚ç‚¹ã€‚å…ˆåˆ¤ç©ºå’Œåˆ¤æ–­å¤´èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯å¦é0ï¼ˆå‡ ä¸ªé‡è¦çš„çŠ¶æ€éƒ½ä¸æ˜¯0ï¼Œ0çš„èŠ‚ç‚¹è¦ä¹ˆæ˜¯ç©ºï¼Œè¦ä¹ˆæ˜¯è¢«æ¶ˆé™¤é”äº†ï¼‰ã€‚ 1234567891011121314151617181920212223242526private void unparkSuccessor(Node node) &#123; /* * If status is negative (i.e., possibly needing signal) try * to clear in anticipation of signalling. It is OK if this * fails or if status is changed by waiting thread. */ int ws = node.waitStatus; if (ws &lt; 0) compareAndSetWaitStatus(node, ws, 0); /* * Thread to unpark is held in successor, which is normally * just the next node. But if cancelled or apparently null, * traverse backwards from tail to find the actual * non-cancelled successor. */ Node s = node.next; if (s == null || s.waitStatus &gt; 0) &#123; s = null; for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev) if (t.waitStatus &lt;= 0) s = t; &#125; if (s != null) LockSupport.unpark(s.thread);&#125; unparkSuccessor(h)å†…éƒ¨é¦–å…ˆä¼šå‘ç”Ÿçš„åŠ¨ä½œæ˜¯è·å–headèŠ‚ç‚¹çš„nextèŠ‚ç‚¹ï¼Œå¦‚æœè·å–åˆ°çš„èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥é€šè¿‡â€œLockSupport.unpark()â€æ–¹æ³•æ¥é‡Šæ”¾å¯¹åº”çš„è¢«æŒ‚èµ·çš„çº¿ç¨‹(å¦åˆ™ä»åå¾€å‰éå†ï¼Œæ‹¿åˆ°æœ€å‰çš„ç­‰å¾…å”¤é†’çš„çº¿ç¨‹èŠ‚ç‚¹ï¼Œè™½ç„¶æˆ‘ä¸çŸ¥é“è¿™ä¸ªå¦åˆ™æ€è¿›æ¥ = =ï¼Œå¾…ç ”ç©¶)ï¼Œè¿™æ ·ä¸€æ¥å°†ä¼šæœ‰ä¸€ä¸ªèŠ‚ç‚¹å”¤é†’åç»§ç»­å¾ªç¯è¿›ä¸€æ­¥å°è¯•tryAcquire()æ–¹æ³•æ¥è·å–é”ï¼Œä½†æ˜¯ä¹Ÿæœªå¿…èƒ½å®Œå…¨è·å–åˆ°å“¦ï¼Œå› ä¸ºæ­¤æ—¶ä¹Ÿå¯èƒ½æœ‰ä¸€äº›å¤–éƒ¨çš„è¯·æ±‚æ­£å¥½ä¸ä¹‹å¾ç”¨(éå…¬å¹³é”)ï¼Œè€Œä¸”è¿˜å¥‡è¿¹èˆ¬çš„æˆåŠŸäº†ï¼Œé‚£è¿™ä¸ªçº¿ç¨‹çš„è¿æ°”å°±æœ‰ç‚¹æ‚²å‰§äº†ï¼Œä¸è¿‡é€šå¸¸ä¹è§‚è®¤ä¸ºä¸ä¼šæ¯ä¸€æ¬¡éƒ½é‚£ä¹ˆæ‚²å‰§ã€‚ 3. å†™åœ¨æœ€åæœ‰äº›åœ°æ–¹è¿˜æ²¡å¼„æ‡‚ï¼Œä¸è¿‡å¯¹AQSçš„ç»“æ„ï¼ŒReentrantLockæ˜¯æ€ä¹ˆåˆ©ç”¨AQSæ¥åšé”çš„æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„è®¤è¯†ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]CASä¸Atomic","slug":"JavaåŸºç¡€-javaçš„CAS","date":"2018-08-22T15:10:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"1213316024.html","link":"","permalink":"https://htchz.cc/1213316024.html","excerpt":"java.util.concurrent.atomic è¿™ä¸ªåŒ…æä¾›äº†ä¸€ç³»åˆ—çš„åŸå­å˜é‡æ“ä½œæ–¹æ³•ã€‚","text":"java.util.concurrent.atomic è¿™ä¸ªåŒ…æä¾›äº†ä¸€ç³»åˆ—çš„åŸå­å˜é‡æ“ä½œæ–¹æ³•ã€‚ 1. Atomicçœ‹çœ‹è¿™ä¸ªåŒ…ä¸‹çš„ç±» è¿™ä¸ªåŒ…å¯ä»¥ç®€å•åˆ†ä¸º4ç±» åˆ†åˆ«å¯¹Booleanã€Integerã€Longè¿›è¡Œæ“ä½œï¼Œæä¾›èƒ½è¿›è¡ŒåŸå­è®¡ç®—çš„ç±»ï¼Œjdk8ä»¥åè¿˜æä¾›äº†LongAdderã€LongAccumulatorç­‰è¿›è¡Œæ€§èƒ½æ›´å¥½ã€æ›´å¼ºå¤§çš„è®¡ç®—ï¼Œç†è®ºä¸Šå¯ä»¥ç”¨LongAdderä»£æ›¿AtomicIntegerï¼Œå…·ä½“åœ¨æ­¤åšå®¢ä¸­ä¹Ÿæœ‰ä»‹ç»LongAdderçš„å®ç°åŸç†ã€‚ å¯¹å¼•ç”¨ï¼ˆReferenceï¼‰çš„æ“ä½œï¼Œç”±äºå¤šçº¿ç¨‹çš„å¯¹åŒä¸€ä¸ªAtomicçš„ç±»å‹ä¿®æ”¹ï¼Œæ— æ³•é¿å…ABAçš„é—®é¢˜ï¼Œæ‰€ä»¥æä¾›æ­¤ç±»å‹çš„æ“ä½œã€‚ æ•°ç»„ï¼ˆArrayï¼‰æ“ä½œï¼Œé’ˆå¯¹æ•°ç»„çš„æ¯ä¸ªå…ƒç´ è¯»å†™æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ Updaterï¼šå¯¹æ™®é€šçš„å˜é‡è¿›è¡ŒåŸå­æ€§ç®¡ç†ï¼Œè€Œä¸ç”¨æ”¹å˜åŸæ¥å˜é‡çš„å®šä¹‰ã€‚ 2. CAScaså³compare and setï¼Œåœ¨AtomicIntegeré‡Œæœ‰è¿™ä¹ˆä¸€ä¸ªæ–¹æ³•ï¼š 123public final boolean compareAndSet(int expect, int update)&#123; return unsafe.compareAndSwapInt(this, valueOffset, expect, update);&#125; å…·ä½“è°ƒç”¨äº†public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);è¿™ä¸ªåŸç”Ÿæ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥å¯¹è±¡æœ¬èº«ã€å€¼åœ¨å†…å­˜ä¸­çš„åœ°å€åç§»ã€åŸå€¼ã€æ”¹å˜åçš„å€¼ï¼Œå³é€šè¿‡ä¸€ç»„å¯¹æ¯”ã€ä¿®æ”¹çš„åŸå­æ“ä½œï¼Œåœ¨å†™å…¥å‰è¯»å–åŸå€¼ï¼Œç„¶åå†™å…¥æ—¶å¦‚æœå€¼å’ŒåŸå€¼ä¸ä¸€è‡´ï¼Œå°±ä¼šæ›´æ–°å¤±è´¥ï¼Œå¦åˆ™æ›´æ–°æˆåŠŸã€‚ 3. casè‡ªæ—‹unsafeç±»æœ‰è¿™ä¹ˆä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿæ˜¯AtomicIntegerè‡ªå¢çš„å®ç°ï¼š 12345678public final int getAndAddInt(Object var1, long var2, int var4) &#123; int var5; do &#123; var5 = this.getIntVolatile(var1, var2); &#125; while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4)); return var5;&#125; å¦‚æœwhile()é‡Œä¸€ç›´è¿”å›çš„casç»“æœä¸ºfalseï¼Œé‚£ä¹ˆç¨‹åºå°±ç»§ç»­å°è¯•casæ“ä½œï¼Œè¿™å°±æ˜¯casè‡ªæ—‹","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]synchronizedå…³é”®å­—","slug":"JavaåŸºç¡€-synchronizedå…³é”®å­—","date":"2018-08-22T07:42:00.000Z","updated":"2019-07-20T03:59:13.000Z","comments":true,"path":"589479039.html","link":"","permalink":"https://htchz.cc/589479039.html","excerpt":"æ¥è®²è®²å±äºjvmçº§åˆ«çš„é”","text":"æ¥è®²è®²å±äºjvmçº§åˆ«çš„é” 1. ç®€ä»‹è¿™æ˜¯javaåŒæ­¥çš„æœ€ç®€å•çš„æ–¹æ³•ï¼ˆæœ‰äº†è¿™ä¸ªå¹¶ä¸æ˜¯ä»£ç å°±ä¿è¯çº¿ç¨‹å®‰å…¨äº†ï¼‰ åŒæ­¥æ™®é€šæ–¹æ³•ï¼Œé”çš„æ˜¯å½“å‰å¯¹è±¡ã€‚ åŒæ­¥é™æ€æ–¹æ³•ï¼Œé”çš„æ˜¯å½“å‰ Class å¯¹è±¡ã€‚ åŒæ­¥å—ï¼Œé”çš„æ˜¯ (){} ä¸­çš„()æ‹¬èµ·æ¥çš„å¯¹è±¡ã€‚ åœ¨JVMä¸­monitorenterå’Œmonitorexitå­—èŠ‚ç ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„Mutex Lockæ¥å®ç°çš„ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨Mutex Lockéœ€è¦å°†å½“å‰çº¿ç¨‹æŒ‚èµ·å¹¶ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ¥æ‰§è¡Œï¼Œè¿™ç§åˆ‡æ¢çš„ä»£ä»·æ˜¯éå¸¸æ˜‚è´µçš„ï¼›ç„¶è€Œåœ¨ç°å®ä¸­çš„å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒåŒæ­¥æ–¹æ³•æ˜¯è¿è¡Œåœ¨å•çº¿ç¨‹ç¯å¢ƒï¼ˆæ— é”ç«äº‰ç¯å¢ƒï¼‰å¦‚æœæ¯æ¬¡éƒ½è°ƒç”¨Mutex Locké‚£ä¹ˆå°†ä¸¥é‡çš„å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚åœ¨jdk1.6ä¸­å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚é”ç²—åŒ–ï¼ˆLock Coarseningï¼‰ã€é”æ¶ˆé™¤ï¼ˆLock Eliminationï¼‰ã€è½»é‡çº§é”ï¼ˆLightweight Lockingï¼‰ã€åå‘é”ï¼ˆBiased Lockingï¼‰ã€é€‚åº”æ€§è‡ªæ—‹ï¼ˆAdaptive Spinningï¼‰ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚ å…ˆçœ‹çœ‹åŠ äº†è¿™ä¸ªå…³é”®å­—çš„ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆ 12345678910111213141516package com.htc.learning.main;public class Sync &#123; public static void main(String[] args) &#123; Sync sync = new Sync(); synchronized (sync) &#123; System.out.println(\"go die\"); &#125; print(); &#125; public static synchronized void print() &#123; System.out.println(\"print oh that's good\"); &#125;&#125; è¿è¡Œjavap -c Sync 123456789101112131415161718192021222324252627282930313233343536373839404142434445$ javap -c Syncè­¦å‘Š: äºŒè¿›åˆ¶æ–‡ä»¶SyncåŒ…å«com.htc.learning.main.SyncCompiled from &quot;Sync.java&quot;public class com.htc.learning.main.Sync &#123; public com.htc.learning.main.Sync(); Code: 0: aload_0 1: invokespecial #1 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V 4: return public static void main(java.lang.String[]); Code: 0: new #2 // class com/htc/learning/main/Sync 3: dup 4: invokespecial #3 // Method &quot;&lt;init&gt;&quot;:()V 7: astore_1 8: aload_1 9: dup 10: astore_2 11: monitorenter 12: getstatic #4 // Field java/lang/System.out:Ljava/io/PrintStream; 15: ldc #5 // String go die 17: invokevirtual #6 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 20: aload_2 21: monitorexit 22: goto 30 25: astore_3 26: aload_2 27: monitorexit 28: aload_3 29: athrow 30: invokestatic #7 // Method print:()V 33: return Exception table: from to target type 12 22 25 any 25 28 25 any public static synchronized void print(); Code: 0: getstatic #4 // Field java/lang/System.out:Ljava/io/PrintStream; 3: ldc #8 // String print oh that&apos;s good 5: invokevirtual #6 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 8: return&#125; çœ‹20è¡Œå’Œ27è¡Œï¼Œåœ¨åŒæ­¥å—çš„å…¥å£å’Œå‡ºå£åˆ†åˆ«æœ‰ monitorenter,monitorexitæŒ‡ä»¤ã€‚ JVM æ˜¯é€šè¿‡è¿›å…¥ã€é€€å‡ºå¯¹è±¡ç›‘è§†å™¨( Monitor ï¼Œå³ä¸‹æ–‡çš„monitor record)æ¥å®ç°å¯¹æ–¹æ³•ã€åŒæ­¥å—çš„åŒæ­¥çš„ã€‚ å…·ä½“å®ç°æ˜¯åœ¨ç¼–è¯‘ä¹‹ååœ¨åŒæ­¥æ–¹æ³•è°ƒç”¨å‰åŠ å…¥ä¸€ä¸ª monitor.enter æŒ‡ä»¤ï¼Œåœ¨é€€å‡ºæ–¹æ³•å’Œå¼‚å¸¸å¤„æ’å…¥ monitor.exit çš„æŒ‡ä»¤ã€‚ å…¶æœ¬è´¨å°±æ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡ç›‘è§†å™¨( Monitor )è¿›è¡Œè·å–ï¼Œè€Œè¿™ä¸ªè·å–è¿‡ç¨‹å…·æœ‰æ’ä»–æ€§ä»è€Œè¾¾åˆ°äº†åŒä¸€æ—¶åˆ»åªèƒ½ä¸€ä¸ªçº¿ç¨‹è®¿é—®çš„ç›®çš„ã€‚ è€Œå¯¹äºæ²¡æœ‰è·å–åˆ°é”çš„çº¿ç¨‹å°†ä¼šé˜»å¡åˆ°æ–¹æ³•å…¥å£å¤„ï¼Œç›´åˆ°è·å–é”çš„çº¿ç¨‹ monitor.exit ä¹‹åæ‰èƒ½å°è¯•ç»§ç»­è·å–é”ã€‚ è¿™ä¸ªå…³é”®å­—å¯ä»¥å½¢æˆä¸‰ç§é”ï¼šåå‘é”ã€è½»é‡çº§é”ã€é‡é‡é”ï¼Œä¸‰ç§é”ä¾æ¬¡å‡çº§ï¼Œä¸èƒ½é™çº§ï¼Œç›´åˆ°è§£é”ã€‚ æ¥ä¸‹æ¥ä¼šæ¶‰åŠåˆ°jvmä¸­å¯¹è±¡çš„markwordï¼ˆå¯¹è±¡å¤´ï¼‰ï¼Œå…³äºå¯¹è±¡å¤´çœ‹å¯¹è±¡çš„ç»„æˆ 2. monitor recordMonitor Recordæ˜¯çº¿ç¨‹çš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå¯ç”¨monitor recordåˆ—è¡¨ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªå…¨å±€çš„å¯ç”¨åˆ—è¡¨ï¼›é‚£ä¹ˆè¿™äº›monitor recordæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæ¯ä¸€ä¸ªè¢«é”ä½çš„å¯¹è±¡éƒ½ä¼šå’Œä¸€ä¸ªmonitor recordå…³è”ï¼ˆå¯¹è±¡å¤´ä¸­çš„LockWordæŒ‡å‘monitor recordçš„èµ·å§‹åœ°å€ï¼Œç”±äºè¿™ä¸ªåœ°å€æ˜¯8byteå¯¹é½çš„æ‰€ä»¥LockWordçš„æœ€ä½ä¸‰ä½å¯ä»¥ç”¨æ¥ä½œä¸ºçŠ¶æ€ä½ï¼‰ï¼ŒåŒæ—¶monitor recordä¸­æœ‰ä¸€ä¸ªOwnerå­—æ®µå­˜æ”¾æ‹¥æœ‰è¯¥é”çš„çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ï¼Œè¡¨ç¤ºè¯¥é”è¢«è¿™ä¸ªçº¿ç¨‹å ç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼šMonitor Recordçš„å†…éƒ¨ç»“æ„ å±æ€§ è¯´æ˜ Owner åˆå§‹æ—¶ä¸ºNULLè¡¨ç¤ºå½“å‰æ²¡æœ‰ä»»ä½•çº¿ç¨‹æ‹¥æœ‰è¯¥monitor recordï¼Œå½“çº¿ç¨‹æˆåŠŸæ‹¥æœ‰è¯¥é”åä¿å­˜çº¿ç¨‹å”¯ä¸€æ ‡è¯†ï¼Œå½“é”è¢«é‡Šæ”¾æ—¶åˆè®¾ç½®ä¸ºNULL EntryQ å…³è”ä¸€ä¸ªç³»ç»Ÿäº’æ–¥é”ï¼ˆsemaphoreï¼‰ï¼Œé˜»å¡æ‰€æœ‰è¯•å›¾é”ä½monitor recordå¤±è´¥çš„çº¿ç¨‹ RcThis è¡¨ç¤ºblockedæˆ–waitingåœ¨è¯¥monitor recordä¸Šçš„æ‰€æœ‰çº¿ç¨‹çš„ä¸ªæ•° Nest ç”¨æ¥å®ç°é‡å…¥é”çš„è®¡æ•° HashCode ä¿å­˜ä»å¯¹è±¡å¤´æ‹·è´è¿‡æ¥çš„HashCodeå€¼ï¼ˆå¯èƒ½è¿˜åŒ…å«GC ageï¼‰ Candidate ç”¨æ¥é¿å…ä¸å¿…è¦çš„é˜»å¡æˆ–ç­‰å¾…çº¿ç¨‹å”¤é†’ï¼Œå› ä¸ºæ¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸæ‹¥æœ‰é”ï¼Œå¦‚æœæ¯æ¬¡å‰ä¸€ä¸ªé‡Šæ”¾é”çš„çº¿ç¨‹å”¤é†’æ‰€æœ‰æ­£åœ¨é˜»å¡æˆ–ç­‰å¾…çš„çº¿ç¨‹ï¼Œä¼šå¼•èµ·ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆä»é˜»å¡åˆ°å°±ç»ªç„¶åå› ä¸ºç«äº‰é”å¤±è´¥åˆè¢«é˜»å¡ï¼‰ä»è€Œå¯¼è‡´æ€§èƒ½ä¸¥é‡ä¸‹é™ã€‚Candidateåªæœ‰ä¸¤ç§å¯èƒ½çš„å€¼0è¡¨ç¤ºæ²¡æœ‰éœ€è¦å”¤é†’çš„çº¿ç¨‹1è¡¨ç¤ºè¦å”¤é†’ä¸€ä¸ªç»§ä»»çº¿ç¨‹æ¥ç«äº‰é” ä¸‹æ–‡çš„lockrecordå­—æ®µæŒ‡çš„å°±æ˜¯ptr to lock record 3. åå‘é”Biased Lockmarkwordçš„æ ‡å¿—ä½ï¼ˆbittagï¼‰ä¸º01ï¼Œç§°ä¸ºbiasableã€‚ 3.1. åå‘é”çš„è·å–è¿‡ç¨‹ åˆå§‹æ—¶å¯¹è±¡å¤„äºbiasableçŠ¶æ€ å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾é”ä½ä¸€ä¸ªå¤„äºbiasable&amp; unbiasedçŠ¶æ€çš„å¯¹è±¡æ—¶ï¼Œé€šè¿‡ä¸€ä¸ªCASå°†è‡ªå·±çš„ThreadIDæ”¾ç½®åˆ°Mark Wordä¸­ç›¸åº”çš„ä½ç½®ï¼Œå¦‚æœCASæ“ä½œæˆåŠŸè¿›å…¥ç¬¬ï¼ˆ3ï¼‰æ­¥å¦åˆ™è¿›å…¥ï¼ˆ4ï¼‰æ­¥ å½“è¿›å…¥åˆ°è¿™ä¸€æ­¥æ—¶ä»£è¡¨å½“å‰æ²¡æœ‰é”ç«äº‰ï¼ŒObjectç»§ç»­ä¿æŒbiasableçŠ¶æ€ï¼Œä½†æ˜¯è¿™æ—¶ThreadIDå­—æ®µè¢«è®¾ç½®æˆäº†åå‘é”æ‰€æœ‰è€…çš„IDï¼Œç„¶åè¿›å…¥åˆ°ç¬¬ï¼ˆ6ï¼‰æ­¥ å½“å‰çº¿ç¨‹æ‰§è¡ŒCASè·å–åå‘é”å¤±è´¥ï¼ˆè¿™ä¸€æ­¥æ˜¯åå‘é”çš„å…³é”®ï¼‰ï¼Œè¡¨ç¤ºåœ¨è¯¥é”å¯¹è±¡ä¸Šå­˜åœ¨ç«äº‰å¹¶ä¸”è¿™ä¸ªæ—¶å€™å¦å¤–ä¸€ä¸ªçº¿ç¨‹è·å¾—åå‘é”æ‰€æœ‰æƒã€‚å½“åˆ°è¾¾å…¨å±€å®‰å…¨ç‚¹ï¼ˆsafepointï¼Œgcæ—¶ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªæ—¶é—´ç‚¹ï¼‰æ—¶è·å¾—åå‘é”çš„çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œå¹¶ä»åå‘é”æ‰€æœ‰è€…çš„ç§æœ‰Monitor Recordåˆ—è¡¨ä¸­è·å–ä¸€ä¸ªç©ºé—²çš„è®°å½•ï¼Œå¹¶å°†Objectè®¾ç½®ä¸ºLightWeight LockçŠ¶æ€å¹¶ä¸”Mark Wordä¸­çš„LockRecordæŒ‡å‘åˆšæ‰æŒæœ‰åå‘é”çº¿ç¨‹çš„Monitor recordï¼Œæœ€åè¢«é˜»å¡åœ¨å®‰å…¨ç‚¹çš„çº¿ç¨‹è¢«é‡Šæ”¾ï¼Œè¿›å…¥åˆ°è½»é‡çº§é”çš„æ‰§è¡Œè·¯å¾„ä¸­ï¼ŒåŒæ—¶è¢«æ’¤é”€åå‘é”çš„çº¿ç¨‹ç»§ç»­å¾€ä¸‹æ‰§è¡ŒåŒæ­¥ä»£ç ã€‚ å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾é”ä½ä¸€ä¸ªå¤„äºbiasable &amp; biasedå¹¶ä¸”ThreadIDä¸ç­‰äºè‡ªå·±çš„IDæ—¶ï¼Œè¿™æ—¶ç”±äºå­˜åœ¨é”ç«äº‰å¿…é¡»è¿›å…¥åˆ°ç¬¬ï¼ˆ4ï¼‰æ­¥æ¥æ’¤é”€åå‘é”ã€‚ è¿è¡ŒåŒæ­¥ä»£ç å— 3.2. åå‘é”çš„è§£é”åå‘é”è§£é”è¿‡ç¨‹å¾ˆç®€å•ï¼Œåªéœ€è¦æµ‹è¯•ä¸‹æ˜¯å¦Objectä¸Šçš„åå‘é”æ¨¡å¼æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™è§£é”æˆåŠŸä¸éœ€è¦ä»»ä½•å…¶ä»–é¢å¤–çš„æ“ä½œã€‚ ç”±åå‘é”è½¬å‘è½»é‡çº§é”æ˜¯è€—æ€§èƒ½çš„ï¼Œå°¤å…¶å†çº¿ç¨‹ç«äº‰æ¿€çƒˆçš„æ—¶å€™ï¼Œæ‰€ä»¥å…³é—­åå‘é”çš„è¯å¯ä»¥åœ¨é«˜å¹¶å‘æé«˜æ€§èƒ½ã€‚-XX:-UseBiasedLocking 4. è½»é‡çº§é”ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿé€šè¿‡ä¸¤ç§æ–¹å¼é”ä½ä¸€ä¸ªå¯¹è±¡ï¼š1ã€é€šè¿‡è†¨èƒ€ä¸€ä¸ªå¤„äºæ— é”çŠ¶æ€ï¼ˆçŠ¶æ€ä½001ï¼‰çš„å¯¹è±¡è·å¾—è¯¥å¯¹è±¡çš„é”ï¼›2ã€å¯¹è±¡å·²ç»å¤„äºè†¨èƒ€çŠ¶æ€ï¼ˆçŠ¶æ€ä½00ï¼‰ä½†LockWordæŒ‡å‘çš„monitor recordçš„Ownerå­—æ®µä¸ºNULLï¼Œåˆ™å¯ä»¥ç›´æ¥é€šè¿‡CASåŸå­æŒ‡ä»¤å°è¯•å°†Ownerè®¾ç½®ä¸ºè‡ªå·±çš„æ ‡è¯†æ¥è·å¾—é”ã€‚ 4.1. è·å–é”ï¼ˆmonitorenterï¼‰ å½“å¯¹è±¡å¤„äºæ— é”çŠ¶æ€æ—¶ï¼ˆRecordWordå€¼ä¸ºHashCodeï¼ŒçŠ¶æ€ä½ä¸º001ï¼‰ï¼Œçº¿ç¨‹é¦–å…ˆä»è‡ªå·±çš„å¯ç”¨moniter recordåˆ—è¡¨ä¸­å–å¾—ä¸€ä¸ªç©ºé—²çš„moniter recordï¼Œåˆå§‹Nestå’ŒOwnerå€¼åˆ†åˆ«è¢«é¢„å…ˆè®¾ç½®ä¸º1å’Œè¯¥çº¿ç¨‹è‡ªå·±çš„æ ‡è¯†ï¼Œä¸€æ—¦monitor recordå‡†å¤‡å¥½ç„¶åæˆ‘ä»¬é€šè¿‡CASåŸå­æŒ‡ä»¤å®‰è£…è¯¥monitor recordçš„èµ·å§‹åœ°å€åˆ°å¯¹è±¡å¤´çš„LockWordå­—æ®µæ¥è†¨èƒ€è¯¥å¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨å…¶ä»–çº¿ç¨‹ç«äº‰é”çš„æƒ…å†µè€Œè°ƒç”¨CASå¤±è´¥ï¼Œåˆ™åªéœ€è¦ç®€å•çš„å›åˆ°monitorenteré‡æ–°å¼€å§‹è·å–é”çš„è¿‡ç¨‹å³å¯ã€‚ å¯¹è±¡å·²ç»è¢«è†¨èƒ€åŒæ—¶Ownerä¸­ä¿å­˜çš„çº¿ç¨‹æ ‡è¯†ä¸ºè·å–é”çš„çº¿ç¨‹è‡ªå·±ï¼Œè¿™å°±æ˜¯é‡å…¥ï¼ˆreentrantï¼‰é”çš„æƒ…å†µï¼Œåªéœ€è¦ç®€å•çš„å°†NeståŠ 1å³å¯ã€‚ä¸éœ€è¦ä»»ä½•åŸå­æ“ä½œï¼Œæ•ˆç‡éå¸¸é«˜ã€‚ å¯¹è±¡å·²è†¨èƒ€ä½†Ownerçš„å€¼ä¸ºNULLï¼Œå½“ä¸€ä¸ªé”ä¸Šå­˜åœ¨é˜»å¡æˆ–ç­‰å¾…çš„çº¿ç¨‹åŒæ—¶é”çš„å‰ä¸€ä¸ªæ‹¥æœ‰è€…åˆšé‡Šæ”¾é”æ—¶ä¼šå‡ºç°è¿™ç§çŠ¶æ€ï¼Œæ­¤æ—¶å¤šä¸ªçº¿ç¨‹é€šè¿‡CASåŸå­æŒ‡ä»¤åœ¨å¤šçº¿ç¨‹ç«äº‰çŠ¶æ€ä¸‹è¯•å›¾å°†Ownerè®¾ç½®ä¸ºè‡ªå·±çš„æ ‡è¯†æ¥è·å¾—é”ï¼Œç«äº‰å¤±è´¥çš„çº¿ç¨‹åœ¨åˆ™ä¼šè¿›å…¥åˆ°ç¬¬å››ç§æƒ…å†µï¼ˆ4ï¼‰çš„æ‰§è¡Œè·¯å¾„ã€‚ å¯¹è±¡å¤„äºè†¨èƒ€çŠ¶æ€åŒæ—¶Ownerä¸ä¸ºNULL(è¢«é”ä½)ï¼Œåœ¨è°ƒç”¨æ“ä½œç³»ç»Ÿçš„é‡é‡çº§çš„äº’æ–¥é”ä¹‹å‰å…ˆè‡ªæ—‹ä¸€å®šçš„æ¬¡æ•°ï¼Œå½“è¾¾åˆ°ä¸€å®šçš„æ¬¡æ•°æ—¶å¦‚æœä»ç„¶æ²¡æœ‰æˆåŠŸè·å¾—é”ï¼Œåˆ™å¼€å§‹å‡†å¤‡è¿›å…¥é˜»å¡çŠ¶æ€ï¼ˆè¿›å…¥é‡é‡çº§é”ï¼Œå°†ptr to heavy monitorçš„å€¼æ ‡å¿—ä¸ºmonitor recordçš„èµ·å§‹åœ°å€ï¼‰ï¼Œé¦–å…ˆå°†rcThisçš„å€¼åŸå­æ€§çš„åŠ 1ï¼Œç”±äºåœ¨åŠ 1çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¢«å…¶ä»–çº¿ç¨‹ç ´åObjectå’Œmonitor recordä¹‹é—´çš„å…³è”ï¼Œæ‰€ä»¥åœ¨åŸå­æ€§åŠ 1åéœ€è¦å†è¿›è¡Œä¸€æ¬¡æ¯”è¾ƒä»¥ç¡®ä¿LockWordçš„å€¼æ²¡æœ‰è¢«æ”¹å˜ï¼Œå½“å‘ç°è¢«æ”¹å˜ååˆ™è¦é‡æ–°è¿›è¡Œmonitorenterè¿‡ç¨‹ã€‚åŒæ—¶å†ä¸€æ¬¡è§‚å¯ŸOwneræ˜¯å¦ä¸ºNULLï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨CASå‚ä¸ç«äº‰é”ï¼Œé”ç«äº‰å¤±è´¥åˆ™è¿›å…¥åˆ°é˜»å¡çŠ¶æ€ã€‚ 4.2. é‡Šæ”¾é”ï¼ˆmonitorexitï¼‰ é¦–å…ˆæ£€æŸ¥è¯¥å¯¹è±¡æ˜¯å¦å¤„äºè†¨èƒ€çŠ¶æ€å¹¶ä¸”è¯¥çº¿ç¨‹æ˜¯è¿™ä¸ªé”çš„æ‹¥æœ‰è€…ï¼Œå¦‚æœå‘ç°ä¸å¯¹åˆ™æŠ›å‡ºå¼‚å¸¸ï¼› æ£€æŸ¥Nestå­—æ®µæ˜¯å¦å¤§äº1ï¼Œå¦‚æœå¤§äº1åˆ™ç®€å•çš„å°†Nestå‡1å¹¶ç»§ç»­æ‹¥æœ‰é”ï¼Œå¦‚æœç­‰äº1ï¼Œåˆ™è¿›å…¥åˆ°ç¬¬ï¼ˆ3ï¼‰æ­¥ï¼› æ£€æŸ¥RcThisæ˜¯å¦å¤§äº0ï¼Œè®¾ç½®Ownerä¸ºNULLç„¶åå”¤é†’ä¸€ä¸ªæ­£åœ¨é˜»å¡æˆ–ç­‰å¾…çš„çº¿ç¨‹å†ä¸€æ¬¡è¯•å›¾è·å–é”ï¼Œå¦‚æœç­‰äº0åˆ™è¿›å…¥åˆ°ç¬¬ï¼ˆ4ï¼‰æ­¥ ç¼©å°ï¼ˆdeflateï¼‰ä¸€ä¸ªå¯¹è±¡ï¼Œé€šè¿‡å°†å¯¹è±¡çš„LockWordç½®æ¢å›åŸæ¥çš„HashCodeå€¼æ¥è§£é™¤å’Œmonitor recordä¹‹é—´çš„å…³è”æ¥é‡Šæ”¾é”ï¼ŒåŒæ—¶å°†monitor recordæ”¾å›åˆ°çº¿ç¨‹æ˜¯æœ‰çš„å¯ç”¨monitor recordåˆ—è¡¨ã€‚ 5. é‡é‡çº§é”å³æ“ä½œç³»ç»Ÿçš„Mutex Locké”ã€‚æ‰€æœ‰caså¤±è´¥çš„çº¿ç¨‹ä¸ä¼šå†é‡è¯•ï¼ŒæŒ‚èµ·å¹¶ç­‰å¾…å”¤é†’ã€‚ è¿™é‡Œæœ‰ä¸€ç¯‡å¤–æ–‡æ–‡çŒ®ï¼šhttps://www.usenix.org/legacy/event/jvm01/full_papers/dice/dice.pdf","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[GoåŸºç¡€]goroutineçš„ä¸€ä¸ªç²¾å½©ç”¨æ³•","slug":"GoåŸºç¡€-goroutineçš„ä¸€ä¸ªç²¾å½©ç”¨æ³•","date":"2018-07-22T13:03:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"3042075373.html","link":"","permalink":"https://htchz.cc/3042075373.html","excerpt":"è¿™æ˜¯ä¸€ä¸ªåˆ©ç”¨goroutineè¾“å‡ºç´ æ•°çš„ä¸€ä¸ªç®—æ³•ï¼Œæ‰¾ä¸ªæ—¶é—´å†™ä¸ªjavaç‰ˆçš„å®ç°â€¦","text":"è¿™æ˜¯ä¸€ä¸ªåˆ©ç”¨goroutineè¾“å‡ºç´ æ•°çš„ä¸€ä¸ªç®—æ³•ï¼Œæ‰¾ä¸ªæ—¶é—´å†™ä¸ªjavaç‰ˆçš„å®ç°â€¦ 1. goroutineå®ç°ç®—æ³•çš„æ ¸å¿ƒæ˜¯ï¼Œåˆ©ç”¨åˆæ•°å¿…å®šæ˜¯ç´ æ•°çš„ä¹˜ç§¯çš„æ€§è´¨ã€‚ç”¨ä¸€ä¸ªåç¨‹ä½œä¸ºç”Ÿæˆå™¨ï¼ˆgenerateï¼‰å¼€å§‹ç”Ÿæˆâ€œ2ã€3ã€4.ã€‚ã€‚â€çš„è‡ªç„¶æ•°ï¼Œåˆ©ç”¨é€šé“å°†è‡ªç„¶æ•°æµå…¥ï¼ˆfilterçš„inã€outå‚æ•°ä¼ é€’ï¼‰ç´ æ•°è¿‡æ»¤å™¨ï¼ˆfilterï¼‰ä¸­ï¼Œè¿™æ ·ç”Ÿæˆå™¨ç”Ÿæˆçš„è‡ªç„¶æ•°å¦‚æœèƒ½ä»ç¬¬ä¸€ä¸ªç´ æ•°æµç»æ‰€æœ‰å·²ç»ç”Ÿæˆçš„filterï¼Œé‚£ä¹ˆä»–æ˜¯ç´ æ•°ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ç´ æ•°è¿‡æ»¤å™¨ã€‚ç¬¬ä¸€ç‰ˆ 12345678910111213141516171819202122232425262728293031323334353637// Copyright 2009 The Go Authors. All rights reserved.// Use of this source code is governed by a BSD-style// license that can be found in the LICENSE file.package mainpackage mainimport \"fmt\"// Send the sequence 2, 3, 4, ... to channel 'ch'.func generate(ch chan int) &#123; for i := 2; ; i++ &#123; ch &lt;- i // Send 'i' to channel 'ch'. &#125;&#125;// Copy the values from channel 'in' to channel 'out',// removing those divisible by 'prime'.func filter(in, out chan int, prime int) &#123; for &#123; i := &lt;-in // Receive value of new variable 'i' from 'in'. if i%prime != 0 &#123; out &lt;- i // Send 'i' to channel 'out'. &#125; &#125;&#125;// The prime sieve: Daisy-chain filter processes together.func main() &#123; ch := make(chan int) // Create a new channel. go generate(ch) // Start generate() as a goroutine. for &#123; prime := &lt;-ch fmt.Print(prime, \" \") ch1 := make(chan int) go filter(ch, ch1, prime) ch = ch1 &#125;&#125; ç¬¬äºŒç‰ˆ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253// Copyright 2009 The Go Authors. All rights reserved.// Use of this source code is governed by a BSD-style// license that can be found in the LICENSE file.package mainimport ( \"fmt\")// Send the sequence 2, 3, 4, ... to returned channelfunc generate() chan int &#123; ch := make(chan int) go func() &#123; for i := 2; ; i++ &#123; ch &lt;- i &#125; &#125;() return ch&#125;// Filter out input values divisible by 'prime', send rest to returned channelfunc filter(in chan int, prime int) chan int &#123; out := make(chan int) go func() &#123; for &#123; if i := &lt;-in; i%prime != 0 &#123; out &lt;- i &#125; &#125; &#125;() return out&#125;func sieve() chan int &#123; out := make(chan int) go func() &#123; ch := generate() for &#123; prime := &lt;-ch ch = filter(ch, prime) out &lt;- prime &#125; &#125;() return out&#125;func main() &#123; primes := sieve() for &#123; fmt.Println(&lt;-primes) &#125;&#125;","categories":[{"name":"GolangåŸºç¡€","slug":"GolangåŸºç¡€","permalink":"https://htchz.cc/categories/GolangåŸºç¡€/"}],"tags":[{"name":"goroutine","slug":"goroutine","permalink":"https://htchz.cc/tags/goroutine/"}],"author":"åœŸå·"},{"title":"[GoåŸºç¡€]Go deferçš„é‚£äº›å‘","slug":"GoåŸºç¡€-Go-deferçš„é‚£äº›å‘","date":"2018-06-24T17:07:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"3084756888.html","link":"","permalink":"https://htchz.cc/3084756888.html","excerpt":"Go deferçš„é‚£äº›å‘ä¸å¾—ä¸è¸©ä¸€ä¸‹æ‰çˆ½","text":"Go deferçš„é‚£äº›å‘ä¸å¾—ä¸è¸©ä¸€ä¸‹æ‰çˆ½ 1. é—­åŒ…å‡½æ•°ä¸ä¼šæ‰§è¡Œ1234567891011121314151617181920package mainimport \"fmt\"func main() &#123; db := &amp;database&#123;&#125; defer db.connect() fmt.Println(\"query db...\")&#125;type database struct&#123;&#125;func (db *database) connect() (disconnect func()) &#123; fmt.Println(\"connect\") return func() &#123; fmt.Println(\"disconnect\") &#125;&#125; ä½ çŒœè¾“å‡ºç»“æœï¼Œæ˜¯è¿™æ ·çš„ï¼š query db... connectdisconnectå¹¶æ²¡æœ‰è¢«æ‰“å°å‡ºæ¥ï¼Œconnectåœ¨deferé‡Œæ‰§è¡Œå®Œåä¿å­˜æ‰§è¡ŒåŸŸï¼Œè¿”å›çš„disconnectå‡½æ•°å¹¶æ²¡æœ‰è¢«æ‰§è¡Œï¼Œè¦æƒ³æ‰§è¡Œï¼Œå¾—ä½¿ç”¨è¿™ç§æ–¹å¼ 1234567func main() &#123; db := &amp;database&#123;&#125; defer db.connect()() fmt.Println(\"query db...\")&#125; é¢˜å¤–è¯ï¼Œæˆ‘ä¹Ÿä¸æ‡‚è¿™ç§å³è¿æ¥åˆå…³é—­çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Œåªæ˜¯åšä¸ªdeferæ‰§è¡Œé—­åŒ…çš„æ¼”ç¤º 2. åœ¨æ‰§è¡Œå—ä¸­ä½¿ç”¨ deferdeferæ˜¯åœ¨å‡½æ•°æ‰§è¡Œå®Œè¿è¡Œï¼Œè€Œä¸æ˜¯ä»£ç å—æ‰§è¡Œå®Œè¿è¡Œã€‚ 3. æƒ³è¦åœ¨å‡½æ•°æ‰§è¡Œå®Œåå¯¹ç»“æœå€¼è¿›è¡Œå˜¿å˜¿å˜¿å…ˆçœ‹javaçš„ä¸€æ®µä»£ç  123456789101112131415161718192021222324public class LambdaTest &#123; public static void main(String[] args) &#123; System.out.println(finalIntTest()); System.out.println(finalStringTest()); &#125; private static int finalIntTest()&#123; int i = 0; try &#123; return i; &#125; finally &#123; i++; &#125; &#125; private static String finalStringTest()&#123; String a = \"hi \"; try &#123; return a; &#125;finally &#123; a += \"en\"; &#125; &#125;&#125; javaæƒ³åœ¨å‡½æ•°è¿”å›å‰å¯¹è¿”å›ç»“æœè¿›è¡Œä¿®æ”¹ï¼Œå¯ä»¥ç”¨finallyç›´æ¥ä¿®æ”¹ï¼Œè¾“å‡ºæ˜¯è¿™æ ·çš„ 0 hi è™½ç„¶finallyå—å¯¹iè‡ªå¢ã€å¯¹å­—ç¬¦ä¸²ä¿®æ”¹ï¼Œä½†æ˜¯ä¸æ¯«ä¸å½±å“è¿”å›ç»“æœã€‚ è¿™æ˜¯å› ä¸ºreturnæ“ä½œä¸æ˜¯åŸå­æ€§çš„ã€‚è¿”å›å€¼æ˜¯ä½œä¸ºä¸´æ—¶å˜é‡è¿›è¡Œæš‚å­˜ï¼Œç„¶åfinallyæ‰§è¡Œå®Œååœ¨è¿”å›ä¸´æ—¶å˜é‡ åŸºæœ¬æ•°æ®ç±»å‹éƒ½å±äºå€¼ç±»å‹ï¼Œæ²¡æœ‰å¼•ç”¨ï¼Œfinallyé‡Œé¢è¿›è¡Œçš„æ“ä½œä¸ä¼šå¯¹ä¸´æ—¶å˜é‡é€ æˆå½±å“ã€‚è‡³äºStringå‘¢ï¼Œè™½ç„¶ä¸æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä½†æ˜¯ä»–æ˜¯finalç±»å‹ï¼Œæ¯æ¬¡æ“ä½œè¿”å›çš„éƒ½æ˜¯æ–°å¼•ç”¨ï¼Œæ‰€ä»¥finallyä¾æ—§ä¸èƒ½ä¿®æ”¹è¿”å›ç»“æœã€‚ æ˜ç™½è¿™ç‚¹åï¼Œå¯èƒ½å¯¹goçš„deferå‘æœ‰äº›ç†è§£ï¼Œä¸Šä¸€äº›ä»£ç ã€‚ 123456func f() (result int) &#123; defer func() &#123; result++ &#125;() return 0&#125; è¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯1ï¼Œgoçš„è¿”å›å€¼å£°æ˜ç‰¹æ€§ä½¿å¾—deferè¯­å¥é‡Œå¯ä»¥æŒæœ‰è¿”å›å€¼resultã€‚ 1234567func f() (r int) &#123; t := 5 defer func() &#123; t = t + 5 &#125;() return t&#125; è¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯5ï¼Œå› ä¸ºreturnæ—¶å°†tå½“æ—¶çš„å€¼æ”¾å…¥rä¸­ï¼Œdeferä¸­çš„æ“ä½œåªæ˜¯å¯¹tè¿›è¡Œè¿ç®— 123456func f() (r int) &#123; defer func(r int) &#123; r = r + 5 &#125;(r) return 1&#125; è¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯1ï¼Œå› ä¸ºåŒ¿åå‡½æ•°ä½“ä¸­çš„ræ˜¯å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥ä¸ä¼šå½±å“è¿”å›å€¼rã€‚ åœ¨golangä¸­åªæœ‰ä¸‰ç§å¼•ç”¨ç±»å‹å®ƒä»¬åˆ†åˆ«æ˜¯åˆ‡ç‰‡sliceã€å­—å…¸mapã€ç®¡é“channelï¼Œå…¶å®ƒçš„å…¨éƒ¨æ˜¯å€¼ç±»å‹ã€‚æ‰€ä»¥deferé‡Œçš„å‡½æ•°æ‹¿åˆ°è¿™äº›ç±»å‹çš„å¼•ç”¨çš„æ—¶å€™ï¼Œæ˜¯æ— è®ºå¦‚ä½•å¯ä»¥ä¿®æ”¹è¿”å›å€¼çš„ã€‚","categories":[{"name":"GolangåŸºç¡€","slug":"GolangåŸºç¡€","permalink":"https://htchz.cc/categories/GolangåŸºç¡€/"}],"tags":[{"name":"å‘","slug":"å‘","permalink":"https://htchz.cc/tags/å‘/"}],"author":"åœŸå·"},{"title":"[Json]secure json","slug":"Json-secure-json","date":"2018-06-08T05:31:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"235536411.html","link":"","permalink":"https://htchz.cc/235536411.html","excerpt":"å®‰å…¨çš„Json..","text":"å®‰å…¨çš„Json.. å­¦ä¹ goçš„åç«¯æ¡†æ¶ginçš„æ—¶å€™ï¼Œå®˜æ–¹æ–‡æ¡£æåˆ°äº†è¿™ç§ä»£ç æ¥è¿”å›å®‰å…¨çš„json 12345678910111213141516func main() &#123; r := gin.Default() // You can also use your own secure json prefix // r.SecureJsonPrefix(&quot;)]&#125;&apos;,\\n&quot;) r.GET(&quot;/someJSON&quot;, func(c *gin.Context) &#123; names := []string&#123;&quot;lena&quot;, &quot;austin&quot;, &quot;foo&quot;&#125; // Will output : while(1);[&quot;lena&quot;,&quot;austin&quot;,&quot;foo&quot;] c.SecureJSON(http.StatusOK, names) &#125;) // Listen and serve on 0.0.0.0:8080 r.Run(&quot;:8080&quot;)&#125; åœ¨ä¸è®¾ç½®å‰ç¼€çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤åœ¨è¿”å›çš„jsonåŠ ä¸Šwhile(1);stackoverflowæŸ¥é˜…ä¸€ä¸‹ï¼Œè¯´æ˜¯ä¸ºäº†é˜²æ­¢json hijackingï¼ˆjsonåŠ«æŒï¼‰ å…³äºè¿™æ–¹é¢çš„èµ„æ–™ä¸æ˜¯å¾ˆå¤šï¼Œä¸­æ–‡çš„æ›´å°‘äº†ã€‚ç›®å‰è¿™äº›æ¼æ´å¤§éƒ½ä¿®å¤äº†ã€‚ å‡è®¾æœ‰ä¸€ä¸ªhttp://www.safe.com/contactsçš„æ¥å£ï¼Œ è¿”å›çš„å†…å®¹å¦‚ä¸‹ 12345678910[ &#123; &quot;id&quot;: 1, &quot;name&quot;: &quot;Riven&quot; &#125;, &#123; &quot;id&quot;: 2, &quot;name&quot;: &quot;Miss Fortune&quot; &#125;] ç”±äºæµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼Œä½¿å¾—å’Œå®‰å…¨ç½‘ç«™çš„åŸŸåã€ç«¯å£ã€åè®®ä¸åŒçš„é¡µé¢æ˜¯ä¸èƒ½ç›´æ¥å‘èµ·ä¸Šé¢è¯·æ±‚çš„ï¼Œè¿™æ ·æ¶æ„ç½‘ç«™http://www.evil.com/index.htmlå¹¶ä¸èƒ½ç›´æ¥è¯·æ±‚å®‰å…¨æ¥å£ã€‚ä»¥ä¸‹æƒ…å†µæ˜¯æ²¡æœ‰åŒæºç­–ç•¥é™åˆ¶çš„ï¼š é¡µé¢ä¸­çš„é“¾æ¥ã€‚å¾ˆå¸¸è§çš„å°±æ˜¯å¯¼èˆªé¡µé¢ä¸­çš„é“¾æ¥ã€‚ è·¨åŸŸèµ„æºè·å–ï¼Œå½“ç„¶ï¼Œæµè§ˆå™¨é™åˆ¶äº†Javascriptä¸èƒ½è¯»å†™åŠ è½½çš„å†…å®¹ã€‚è¿™ç§å…è®¸çš„è·¨åŸŸè¯·æ±‚æœ‰:srcå±æ€§(æœåŠ¡å™¨å¯ä»¥æ‹’ç»)ã€&lt;iframe&gt;ï¼ˆæœåŠ¡å™¨å¯ä»¥æ‹’ç»ï¼‰ jsonåŠ«æŒæ˜¯é€šè¿‡&lt;script&gt;æ¥è¿›è¡Œçš„ã€‚ é¦–å…ˆï¼Œæ¶æ„è€…åœ¨http://www.evil.com/index.htmlçš„å†™å…¥ä¸€è¡Œ &lt;script src=&quot;http://www.safe.com/contacts&quot;&gt;&lt;/script&gt;ç”±äºè¿™ç§æ¥å£ä¸€èˆ¬åˆ©ç”¨cookieæ¥ä¿è¯ç™»å½•çŠ¶æ€ï¼Œæ‰€ä»¥æ¶æ„è€…æŠŠè¿™ä¸ªé’“é±¼ç½‘ç«™ä»¥é‚®ä»¶çš„å½¢å¼å‘åˆ°å—å®³è€…çš„é‚®ç®±ï¼Œ å—å®³è€…æ‡µé€¼ç‚¹å¼€ç½‘ç«™ä¹‹åï¼Œ&lt;script&gt;æ ‡ç­¾å°±è·‘èµ·æ¥äº†ï¼Œä¸€ä¸ªGetè¯·æ±‚å¸¦ä¸Šè¿˜æ²¡è¿‡æœŸçš„cookieä¿¡æ¯ï¼Œè¿”å›äº†jsonæ•°ç»„ã€‚ é‡ç‚¹æ¥äº†ï¼Œè™½ç„¶æµè§ˆå™¨ä¸å…è®¸å¯¹èµ„æºçš„æ“ä½œåŠ è½½çš„å†…å®¹ï¼Œå¯æ˜¯&lt;script&gt;æ˜¯ä¼šè¿è¡ŒåŠ è½½åˆ°çš„ä¸œè¥¿çš„(è¿™ä¹Ÿæ˜¯jsonpçš„è¿è¡Œæœºåˆ¶),è€Œjsonæ•°ç»„æ–‡æœ¬æ˜¯å¯ä»¥è¢«jså¼•æ“è¿è¡Œçš„ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¼šæ„é€ ä¸€ä¸ªArrayï¼Œä½†æ˜¯å¹¶æ²¡æœ‰èµ‹å€¼ç»™è°ã€‚ äºæ˜¯æ¶æ„è€…å°±ä»æ„é€ å‡½æ•°å¼€å§‹åŠ¨æ‰‹ï¼Œå¦‚è¿™ç¯‡æ–‡ç« ï¼Œé‡å†™Arrayçš„æ„é€ å‡½æ•°ï¼Œæˆ–è€…é‡å†™Objects.prototype.__defineSetter__æ¥è¿›è¡ŒåŸå‹å‡½æ•°çš„æ›¿æ¢ï¼Œä»è€ŒåŠ å…¥è‡ªå·±çš„æ¶æ„ä»£ç ï¼Œå¦‚æŠŠæ•°æ®å‘é€åˆ°è‡ªå·±çš„æœåŠ¡å™¨å»ã€‚ å¦‚æœhttp://www.safe.com/contactsæ¥å£è¿”å›çš„æ˜¯å¯¹è±¡è€Œä¸æ˜¯æ•°ç»„å‘¢ï¼Œæ¯”å¦‚è¯¥æ¥å£è¿”å›{&quot;id&quot;: 2, &quot;name&quot;: &quot;batman&quot;}ï¼Œé‚£ä¹ˆjså¼•æ“å°±ä¼šæŠ¥é”™ï¼Œæ— æ³•è¿è¡Œè¿™ä¸ªæ–‡æœ¬ã€‚ æˆ–è€…ï¼Œåœ¨jsonæ•°ç»„å‰åŠ ä¸Šä¸€äº›åƒåœ¾ä¸²ã€æ­»å¾ªç¯ä»£ç ï¼Œå†ç”¨è‡ªå·±çš„jsonè§£æå™¨è§£æå‡ºæ­£ç¡®çš„jsonæ•°ç»„ã€‚æ¯”å¦‚åœ¨Gmailç½‘é¡µç‰ˆé‡Œï¼Œå°±æœ‰è¿™æ ·çš„å¸¦æœ‰åƒåœ¾ä¸²çš„jsonæ•°ç»„è¿”å›ã€‚ åœ¨es5ä¹‹åï¼Œè¿™äº›æ¼æ´éƒ½ä¸èƒ½è¢«åˆ©ç”¨äº†ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬è¦æ¥åˆ«äººè¿™ç§è¿”å›å¸¦å‰ç¼€jsonçš„apiæ€ä¹ˆåŠå‘¢ï¼Œè¿™ä½è€å“¥è¯´JQueryç”¨ä¸€ä¸ªè¿‡æ»¤å™¨å¤„ç†ï¼ˆåªé’ˆå¯¹//, while(true);, for(;;);ï¼‰ 123456789101112131415161718192021$.ajaxSetup(&#123; dataFilter: function(data, type) &#123; var prefixes = [&apos;//&apos;, &apos;while(true);&apos;, &apos;for(;;);&apos;], i, l,, pos; if (type != &apos;json&apos; &amp;&amp; type != &apos;jsonp&apos;) &#123; return data; &#125; for (i = 0, l = prefixes.length; i &lt; l; i++) &#123; pos = data.indexOf(prefixes[i]); if (pos === 0) &#123; return data.substring(prefixes[i].length); &#125; &#125; return data; &#125;&#125;);","categories":[],"tags":[{"name":"Json","slug":"Json","permalink":"https://htchz.cc/tags/Json/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]æ‰¾åˆ°Javaè¿›ç¨‹ä¸­å“ªä¸ªçº¿ç¨‹å ç”¨äº†å¤§é‡CPUå¤„ç†æ—¶é—´","slug":"JavaåŸºç¡€-æ‰¾åˆ°-Java-è¿›ç¨‹ä¸­å“ªä¸ªçº¿ç¨‹å ç”¨äº†å¤§é‡-CPU-å¤„ç†æ—¶é—´","date":"2018-06-05T07:32:00.000Z","updated":"2020-03-27T03:12:02.253Z","comments":true,"path":"947951116.html","link":"","permalink":"https://htchz.cc/947951116.html","excerpt":"åœ¨Linuxç¯å¢ƒä¸‹æ‰¾åˆ°æœ€å¤§çº¿ç¨‹å ç”¨","text":"åœ¨Linuxç¯å¢ƒä¸‹æ‰¾åˆ°æœ€å¤§çº¿ç¨‹å ç”¨ åŸæ–‡ä¼ é€é—¨ æœ¬æ–‡çš„ç›®çš„æ˜¯åœ¨ Javaè¿›ç¨‹ä¸­ç¡®å®šå“ªä¸ªçº¿ç¨‹æ­£åœ¨å ç”¨CPUçš„æ—¶é—´ã€‚ å½“æ‚¨çš„ç³»ç»Ÿ CPU è´Ÿè½½å±…é«˜ä¸ä¸‹æ—¶ï¼Œè¿™æ˜¯ä¸€ç§æœ‰ç”¨çš„æ•…éšœæ’é™¤æŠ€æœ¯ã€‚ ä¸‹é¢æ˜¯è¯¦ç»†æ­¥éª¤ï¼š 1.é¦–å…ˆç¡®å®šè¿›ç¨‹çš„ ID ï¼Œå¯ä»¥ä½¿ç”¨ jps -v æˆ–è€… top å‘½ä»¤ç›´æ¥æŸ¥çœ‹ 2.æŸ¥çœ‹è¯¥è¿›ç¨‹ä¸­å“ªä¸ªçº¿ç¨‹å ç”¨å¤§é‡ CPUï¼Œæ‰§è¡Œ top -H -p [PID] ç»“æœå¦‚ä¸‹ï¼š Hå‚æ•°è¡¨ç¤ºæ˜¾ç¤ºçº¿ç¨‹æ¯”topé«˜çº§ç‚¹çš„è¿˜å¯ä»¥ç”¨htopå‘½ä»¤ï¼Œéœ€è¦è‡ªè¡Œå®‰è£… å¯ä»¥å‘ç°ç¼–å·ä¸º 350xx çš„å…±æœ‰ 9 ä¸ªçº¿ç¨‹å ç”¨äº† 100% çš„ CPUï¼Œå¥½ï¼Œæ¥ä¸‹æ¥å’±ä»¬éšä¾¿å–ä¸€ä¸ªçº¿ç¨‹ ID ï¼Œå‡è®¾æˆ‘ä»¬æƒ³çœ‹ç¼–å·ä¸º 35053 è¿™ä¸ªçº¿ç¨‹ã€‚ é¦–å…ˆå°† 35053 è½¬æˆ 16 è¿›åˆ¶æ˜¯ 88ED ï¼ˆå¯ä»¥ç”¨å¼€æºä¸­å›½åœ¨çº¿å·¥å…·è½¬æ¢ï¼‰ 3.æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹è¾“å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ‰§è¡Œï¼šjstack [PID] &gt; jstack.txt 4.åœ¨è¿›ç¨‹ä¸­æŸ¥æ‰¾å¯¹åº”çš„çº¿ç¨‹ IDï¼Œæ‰§è¡Œï¼šcat jstack.txt | grep -i 88ED ç»“æœæ˜¯ï¼š &quot;HTTP Request From : /xxxx/blog/323432(120.27.143.239)&quot; #266 daemon prio=5 os_prio=0 tid=0x00007fcda4146800 nid=0x88e runnable [0x00007fcd54178000]ç”±æ­¤å¯ä»¥çœ‹å‡ºåœ¨è¯·æ±‚ /xxxx/blog/323432 é“¾æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨çš„å¤„ç†çº¿ç¨‹å ç”¨äº† 100% çš„ CPUã€‚ æ‰¾åˆ°é—®é¢˜åï¼Œæ¥ä¸‹æ¥å»è§£å†³å°±å¥½äº†ï¼","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"è¿ç»´","slug":"è¿ç»´","permalink":"https://htchz.cc/tags/è¿ç»´/"}],"author":"åœŸå·"},{"title":"[æ­£åˆ™è¡¨è¾¾å¼]replaceAllä¸ä¸ºäººçŸ¥çš„æ•…äº‹","slug":"JavaåŸºç¡€-replaceAllä¸ä¸ºäººçŸ¥çš„æ•…äº‹","date":"2018-05-09T07:37:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"2850894714.html","link":"","permalink":"https://htchz.cc/2850894714.html","excerpt":"String.replaceAllå’ŒString.replaceçš„åŒºåˆ«æ˜¯ï¼ŒString.replaceAllä½¿ç”¨çš„åŒ¹é…æ¨¡å¼æ˜¯æ­£åˆ™è¡¨è¾¾å¼ã€‚ä½†æ˜¯ç¬¬äºŒå‚æ•°replacementä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œé‡Œé¢æœ‰ç‚¹ç‰¹æ®Šçš„ä¸œè¥¿ã€‚","text":"String.replaceAllå’ŒString.replaceçš„åŒºåˆ«æ˜¯ï¼ŒString.replaceAllä½¿ç”¨çš„åŒ¹é…æ¨¡å¼æ˜¯æ­£åˆ™è¡¨è¾¾å¼ã€‚ä½†æ˜¯ç¬¬äºŒå‚æ•°replacementä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œé‡Œé¢æœ‰ç‚¹ç‰¹æ®Šçš„ä¸œè¥¿ã€‚ 1. \\çš„é—®é¢˜å·²çŸ¥String str = &quot;a\\\\bc&quot;,è¯·é—®åˆ©ç”¨String.replaceAllæŠŠstrè¾“å‡ºä¸ºa\\\\bcåˆ°æ§åˆ¶å°æ€ä¹ˆåšï¼Ÿç­”æ¡ˆæ˜¯ï¼šSystem.out.println(str.replaceAll(&quot;\\\\\\\\&quot;, &quot;\\\\\\\\\\\\\\\\&quot;))æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªåæ–œæ ç”¨javaæ­£åˆ™æ¥è¡¨ç¤ºéœ€è¦è¿™ä¹ˆå†™&quot;\\\\\\\\&quot;ï¼Œæ‰€ä»¥æˆ‘ä¸€å¼€å§‹è¿™ä¹ˆå†™str.replaceAll(&quot;\\\\\\\\&quot;, &quot;\\\\\\\\&quot;,ç»“æœè¾“å‡ºçš„å´æ˜¯ï¼š a\\bcå°‘äº†ä¸€æ ï¼Œäºæ˜¯æˆ‘ä¸æ˜ç™½ï¼Œreplacementç”¨&quot;\\\\\\\\&quot;è¡¨ç¤ºä¸¤ä¸ªæ–œæ æœ‰é”™ï¼Ÿ 2. $ä¸\\åœ¨String.replaceAllçš„æ³¨é‡Šæ˜¯è¿™æ ·çš„ï¼Œ Note that backslashes ({@code }) and dollar signs ({@code $}) in the replacement string may cause the results to be different than if it were being treated as a literal replacement string; æ¥ä¸‹æ¥ä»–è®©æˆ‘è¯¦æƒ…è¯·çœ‹Matcherç±»æ³¨é‡Šï¼Œè€Œåœ¨java.util.regex.Matcher#replaceAllé‡Œæ˜¯è¿™ä¹ˆæ³¨é‡Šçš„ Dollar signs may be treated as references to captured subsequences as described above, and backslashes are used to escape literal characters in the replacement string. $åœ¨replacementé‡Œå¯ä»¥ç”¨æ¥è¡¨è¾¾patterné‡Œçš„å­åºåˆ—ï¼Œæ¯”å¦‚ä½ çœŸçš„ä¼šç”¨java replaceAllå‡½æ•°å—ï¼Ÿé‡Œä¸¾ä¾‹çš„ System.out.println(&quot;abac&quot;.replaceAll(&quot;a(\\\\w)&quot;, &quot;$1$1&quot;)); //bbcc System.out.println(&quot;abac&quot;.replaceFirst(&quot;a(\\\\w)&quot;, &quot;$1$1&quot;)); //bbacæ‰€ä»¥åœ¨replacementé‡Œï¼Œæˆ‘ä»¬è¦è¡¨è¾¾$æ€ä¹ˆåŠï¼Ÿç”¨\\æ¥è½¬ä¹‰ï¼Œäºæ˜¯ä»£ç é‡Œå°±è¿™ä¹ˆå†™&quot;\\\\$&quot;æ¥ç€åœ¨replacementé‡Œï¼Œæˆ‘ä»¬è¦è¡¨è¾¾ç‰¹æ®Šçš„\\æ€ä¹ˆåŠï¼Œéœ€è¦ç”¨\\æ¥è½¬ä¹‰\\ï¼Œäºæ˜¯ä»£ç é‡Œå°±è¿™ä¹ˆå†™\\\\\\\\ã€‚ è€Œåœ¨replacementé‡Œï¼Œå…¶ä»–çš„è½¬ä¹‰è¯¥æ€ä¹ˆå†™è¿˜æ˜¯æ€ä¹ˆå†™ï¼Œæ¯”å¦‚&quot;System.out.println(&quot;abcd&quot;.replaceAll(&quot;a&quot;, &quot;\\t&quot;));&quot;,â€aâ€å°±è¢«æ›¿æ¢æˆåˆ¶è¡¨ç¬¦äº† æŒ‰æˆ‘çš„ç†è§£æ˜¯å­˜åœ¨ä¸¤ç§è½¬ä¹‰ï¼Œå’Œæ­£åˆ™å¤„ç†ä¸€æ ·ï¼Œå½“ä½ å†™&quot;\\\\&quot;çš„æ—¶å€™ï¼ŒJavaç¬¬ä¸€æ¬¡è½¬ä¹‰ååœ¨å†…å­˜é‡Œå°±æ˜¯\\ï¼Œreplacementæ£€æµ‹åˆ°åæ–œæ ï¼Œä¼šå°†åé¢çš„å­—ç¬¦è¡¨ç¤ºä¸ºçº¯æ–‡æœ¬ï¼Œæ‰€ä»¥å†™System.out.println(s.replaceAll(&quot;a&quot;, &quot;\\\\&quot;));æ˜¯ä¼šæŠ¥å¼‚å¸¸çš„ï¼Œå› ä¸º&quot;\\\\&quot;å­˜åœ¨ç¬¬äºŒæ¬¡è½¬ä¹‰ï¼Œè€Œç¬¬äºŒæ¬¡è½¬ä¹‰çš„æ—¶å€™åé¢æ²¡è·Ÿå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æŠ¥å¼‚å¸¸ã€‚ideaåœ¨å†™æ­£åˆ™çš„æ—¶å€™ï¼Œ&quot;\\\\&quot;æ˜¯ä¼šæç¤ºé”™è¯¯çš„ï¼Œä½†æ˜¯String.replaceAllé‡Œreplacementå†™&quot;\\\\&quot;åªæœ‰åœ¨è¿è¡Œæ—¶æ‰æ£€æµ‹å¾—åˆ°ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"æ­£åˆ™","slug":"æ­£åˆ™","permalink":"https://htchz.cc/tags/æ­£åˆ™/"}],"author":"åœŸå·"},{"title":"[Time]ä¸€ä¸ªå…³äºè·å–ç³»ç»Ÿæ—¶é—´çš„ä¼˜åŒ–","slug":"Time-ä¸€ä¸ªå…³äºè·å–ç³»ç»Ÿæ—¶é—´çš„ä¼˜åŒ–","date":"2018-04-27T18:10:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"3428339883.html","link":"","permalink":"https://htchz.cc/3428339883.html","excerpt":"è¿™æ˜¯åœ¨æŸä¸ªæ’ä»¶é‡Œçœ‹åˆ°çš„ä»£ç [æ»‘ç¨½]","text":"è¿™æ˜¯åœ¨æŸä¸ªæ’ä»¶é‡Œçœ‹åˆ°çš„ä»£ç [æ»‘ç¨½] æŸ¥äº†ä¸€ä¸‹è¯´æ˜¯æŠŠSystem.currentTimeMillis()æ”¾åˆ°ä¸€ä¸ªå®šæ—¶ä»»åŠ¡é‡Œå¯ä»¥æé«˜æ€§èƒ½ï¼Œå…¶å®å†™ä¸ªmainæµ‹äº†ä¸€ä¸‹æ„Ÿè§‰è¦å¾ˆå¤§çš„é‡çº§æ‰æœ‰æ•ˆæœ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667import java.util.concurrent.BrokenBarrierException;import java.util.concurrent.CyclicBarrier;import java.util.concurrent.TimeUnit;/** * æ¯«ç§’çº§ç³»ç»Ÿæ—¶é—´, æ˜¾å¼è°ƒç”¨System.currentTimeMillis()æ®è¯´è´¹æ€§èƒ½ * */public class TimeUtil implements Runnable &#123; private static volatile long currentTimeMillis; static &#123; currentTimeMillis = System.currentTimeMillis(); // fetch system time for init Thread deamon = new Thread(new TimeUtil()); deamon.setDaemon(true); deamon.setName(\"time tick thread\"); deamon.start(); &#125; public void run() &#123; while(true)&#123; currentTimeMillis = System.currentTimeMillis(); try &#123; TimeUnit.MILLISECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; //unreachable &#125; &#125; &#125; public static long currentTimeMillis()&#123; return currentTimeMillis; &#125; public static void main(String[] args) &#123; int loop = 100000000; long start = System.currentTimeMillis(); CyclicBarrier barrier = new CyclicBarrier(2, () -&gt; System.out.println(\"begin\")); Thread thread1 = new Thread(() -&gt; &#123; try &#123; System.out.println(\"t1 start\"); barrier.await(); for (int i = 0; i &lt; loop; i++) &#123; System.currentTimeMillis(); &#125; System.out.println(\"t1:\" + (System.currentTimeMillis() - start) +\"ms\"); &#125; catch (InterruptedException | BrokenBarrierException e) &#123; e.printStackTrace(); &#125; &#125;); Thread thread2 = new Thread(() -&gt; &#123; try &#123; System.out.println(\"t2 start\"); barrier.await(); for (int i = 0; i &lt; loop; i++) &#123; TimeUtil.currentTimeMillis(); &#125; System.out.println(\"t2:\" + (System.currentTimeMillis() - start) +\"ms\"); &#125; catch (InterruptedException | BrokenBarrierException e) &#123; e.printStackTrace(); &#125; &#125;); thread2.start(); thread1.start(); &#125;&#125; è¾“å‡º t2 start t1 start begin t2:50ms t1:1135ms","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[],"author":"åœŸå·"},{"title":"[Cron]linuxå®šæ—¶ä»»åŠ¡çš„å‘","slug":"Cron-linuxå®šæ—¶ä»»åŠ¡çš„å‘","date":"2018-04-17T18:23:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"3058313917.html","link":"","permalink":"https://htchz.cc/3058313917.html","excerpt":"å†™äº†ä¸ªè„šæœ¬å®šæ—¶æ‰§è¡Œï¼Œæœ‰å¤©å‘ç°å‘½ä»¤æ²¡æœ‰æ­£ç¡®æ‰¾åˆ°æˆ‘é…åœ¨PATHçš„ç¯å¢ƒå˜é‡ã€‚","text":"å†™äº†ä¸ªè„šæœ¬å®šæ—¶æ‰§è¡Œï¼Œæœ‰å¤©å‘ç°å‘½ä»¤æ²¡æœ‰æ­£ç¡®æ‰¾åˆ°æˆ‘é…åœ¨PATHçš„ç¯å¢ƒå˜é‡ã€‚ ç”¨äº†gdriveæ¥å¤‡ä»½åšå®¢ï¼Œæ—¥å¿—çœ‹åˆ° /root/gdrive-bak-blog.sh: line 2: gdrive: command not foundç™¾åº¦ä¸€æ³¢å‘ç°cronè¯»å–ç¯å¢ƒå˜é‡æœ‰ç‚¹æ“ï¼Œæœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆ crontabé‡Œçš„å‘½ä»¤å…ˆæ‰§è¡Œsource 0 8 * * * source /etc/profile &amp;&amp; /root/gdrive-bak-blog.sh &gt; /root/blog-bak.out 2&gt;&amp;1 è„šæœ¬é‡Œæ‰§è¡ŒåŠ è½½ç¯å¢ƒå˜é‡ #!/bin/sh source /etc/profile ...é™„ä¸Šå¤‡ä»½è„šæœ¬ #! /bin/bash oldFileId=`gdrive list | grep &apos;hzblog.bak.tar.gz&apos; | awk &apos;{print $1}&apos;` if [ -z $oldFileId ] then echo &quot;no backup for hzblog.bak.tar.gz&quot; else gdrive delete $oldFileId echo &quot;hzblog.bak.tar.gz[id:$oldFileId] deleted&quot; fi rm -f /root/hzblog.bak.tar.gz tar -czPf hzblog.bak.tar.gz /root/hzblog parentId=`gdrive list | grep &apos;hzblog&apos; | awk &apos;{print $1}&apos;` gdrive upload -p $parentId /root/hzblog.bak.tar.gz echo &quot;hzblog.bak.tar.gz uploaded&quot;","categories":[{"name":"Linux","slug":"Linux","permalink":"https://htchz.cc/categories/Linux/"}],"tags":[],"author":"åœŸå·"},{"title":"[JDK8]Stream toMapé‡åˆ°çš„å‘","slug":"JDK8-Stream-toMapé‡åˆ°çš„å‘","date":"2018-04-17T03:19:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"2688045267.html","link":"","permalink":"https://htchz.cc/2688045267.html","excerpt":"ç•¥æ‡‚ç•¥æ‡‚ã€‚","text":"ç•¥æ‡‚ç•¥æ‡‚ã€‚ 1. keyé‡å¤å†™äº†è¿™ä¹ˆä¸€å¥ä»£ç  Map&lt;Long, Integer&gt; map = module.getStocks().stream().collect(Collectors.toMap(SkuStockDTO::getSkuId, SkuStockDTO::getSkuStock));å½“SkuStockDTO::getSkuIdæ‹¿åˆ°ç›¸åŒidæ—¶ä¼šæŠ¥java.lang.IllegalStateException: Duplicate key xxxå…¶å®java8å·²ç»ç»™æˆ‘ä»¬æä¾›äº†è§£å†³çš„æ–¹å¼: æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä½“ç°çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªmergeç­–ç•¥ 2. valueä¸ºnullvalueä¸ºnullçš„æ—¶å€™æ˜¯ä¼šæŠ¥ç©ºæŒ‡é’ˆï¼Œjava.util.stream.Collectors#toMapå…¶å®æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ä¸€ä¸ªæ–¹æ³• 12345678910111213141516171819202122232425262728293031 * @param &lt;T&gt; the type of the input elements * @param &lt;K&gt; the output type of the key mapping function * @param &lt;U&gt; the output type of the value mapping function * @param &lt;M&gt; the type of the resulting &#123;@code Map&#125; * @param keyMapper a mapping function to produce keys * @param valueMapper a mapping function to produce values * @param mergeFunction a merge function, used to resolve collisions between * values associated with the same key, as supplied * to &#123;@link Map#merge(Object, Object, BiFunction)&#125; * @param mapSupplier a function which returns a new, empty &#123;@code Map&#125; into * which the results will be inserted * @return a &#123;@code Collector&#125; which collects elements into a &#123;@code Map&#125; * whose keys are the result of applying a key mapping function to the input * elements, and whose values are the result of applying a value mapping * function to all input elements equal to the key and combining them * using the merge function * * @see #toMap(Function, Function) * @see #toMap(Function, Function, BinaryOperator) * @see #toConcurrentMap(Function, Function, BinaryOperator, Supplier) */public static &lt;T, K, U, M extends Map&lt;K, U&gt;&gt;Collector&lt;T, ?, M&gt; toMap(Function&lt;? super T, ? extends K&gt; keyMapper, Function&lt;? super T, ? extends U&gt; valueMapper, BinaryOperator&lt;U&gt; mergeFunction, Supplier&lt;M&gt; mapSupplier) &#123; BiConsumer&lt;M, T&gt; accumulator = (map, element) -&gt; map.merge(keyMapper.apply(element), valueMapper.apply(element), mergeFunction); return new CollectorImpl&lt;&gt;(mapSupplier, accumulator, mapMerger(mergeFunction), CH_ID);&#125; å¯ä»¥çœ‹åˆ°å§‹ç»ˆéƒ½ä¼šè°ƒç”¨Map.mergeï¼Œè€Œè¿™ä¸ªæ–¹æ³•æœ‰å¦‚ä¸‹ä»£ç  1Objects.requireNonNull(value); è§£å†³æ–¹æ³•æ˜¯ä¸ç”¨java.util.stream.Collectors#toMapï¼Œæ”¹ç”¨ä¸‹é¢çš„å§¿åŠ¿ 12Map&lt;Integer, Boolean&gt; collect = list.stream() .collect(HashMap::new, (m,v)-&gt;m.put(v.getId(), v.getAnswer()), HashMap::putAll);","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"jdk8","slug":"jdk8","permalink":"https://htchz.cc/tags/jdk8/"}],"author":"åœŸå·"},{"title":"[JVM]G1","slug":"JVM-G1","date":"2018-04-02T09:23:00.000Z","updated":"2020-06-04T03:51:48.841Z","comments":true,"path":"2687941502.html","link":"","permalink":"https://htchz.cc/2687941502.html","excerpt":"ä¸å¾—ä¸è¯´G1æœ‰ç‚¹éš¾ç†è§£","text":"ä¸å¾—ä¸è¯´G1æœ‰ç‚¹éš¾ç†è§£ G1ï¼ˆGarbage Firstæˆ–è€…åƒåœ¾ä¼˜å…ˆæ”¶é›†å™¨ï¼‰æ˜¯CMSçš„ä¸‹ä¸€ä»£åƒåœ¾æ”¶é›†å™¨ï¼Œè®¾è®¡åˆè¡·æ˜¯ä¸ºäº†å°½é‡ç¼©çŸ­å¤„ç†è¶…å¤§å †ï¼ˆå¤§äº4GBï¼‰æ—¶äº§ç”Ÿçš„åœé¡¿ã€‚ç›¸å¯¹äºCMSçš„ä¼˜åŠ¿è€Œè¨€æ˜¯å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿç‡å¤§å¤§é™ä½ã€‚ G1çš„è€å¹´ä»£ç”±äºåˆ†Regionçš„åŸå› ï¼Œå¯ä»¥å¯¹åƒåœ¾å¤šçš„ä¼˜å…ˆæ”¶é›†ï¼Œåƒåœ¾å°‘çš„å…ˆä¸å¤„ç†ï¼Œè¿™æ ·gcçš„æ—¶é—´å°±å¯æ§ã€‚è€Œæ–°ç”Ÿä»£åœ¨å›æ”¶æ—¶ä¼šå¤„ç†å…¨éƒ¨Regionã€‚ 1. RegionG1å°†æ•´ä¸ªå †åˆ†ä¸ºå¤šä¸ªRegionï¼Œä¸€ä¸ªRegionå¯ä»¥ä»£è¡¨Edenã€Survivorã€Oldã€Humongousï¼› å…¶ä¸­å¸¦æœ‰Humongousçš„Regionå­˜å‚¨çš„æ˜¯å·¨å¤§å¯¹è±¡(ç‹¬å )ï¼ŒHumongouså¯¹è±¡å¤§å°å¤§äºç­‰äºRegionä¸€åŠçš„å¯¹è±¡ï¼Œå¯èƒ½å æœ‰è¿ç»­å‡ ä¸ªRegionã€‚è¿™ç§ç‹¬å çš„ç¼ºç‚¹æ˜¯ä¼šé€ æˆç©ºé—´æµªè´¹ï¼Œæ‰€ä»¥regionå¤§å°æ˜¯ä¸€ä¸ªè°ƒä¼˜ç‚¹ã€‚ åˆ†åŒºçš„å¤§å°å¯ä»¥é€šè¿‡-XX:G1HeapRegionSizeè°ƒæ•´ï¼Œä¸º1ï½32mä¸”æ˜¯2çš„å¹‚ã€‚ 2. TLABThread Local Allocation Bufferï¼Œä»åå­—å¯ä»¥çŸ¥é“è¿™æ˜¯ä¸ªçº¿ç¨‹ç§æœ‰çš„ä¸œè¥¿ï¼ŒEden regionæœ‰ä¸€éƒ¨åˆ†ä¼šåˆ’åˆ†ç»™ç”¨æˆ·çº¿ç¨‹ï¼Œçº¿ç¨‹ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œç›´æ¥åœ¨è‡ªå·±TLABåˆ†é…ï¼›å¦‚æœæ–°å¯¹è±¡è¶…è¿‡TLABçš„èŒƒå›´ï¼Œéœ€è¦å¯¹å…¶ä»–regionè¿›è¡ŒåŠ é”åˆ†é…ï¼Œæˆ–è€…æ–°å¯¹è±¡æ˜¯Humongousï¼Œä¸“é—¨åˆ’åˆ†regionå­˜æ”¾ã€‚ 3. PLABPromotion Thread Local Bufferï¼Œå’ŒTLABç±»ä¼¼ï¼Œgcçº¿ç¨‹ç§æœ‰ï¼Œeden regionå¯¹è±¡æ™‹å‡åˆ°survivor regionæ—¶ä¼˜å…ˆåˆ†é…åœ¨çº¿ç¨‹ç§æœ‰çš„regionä¸Š 4. Collection Set(CSet)è¿™æ˜¯ä¸€ä¸ªé›†åˆï¼Œè®°å½•äº†å¯è¢«å›æ”¶çš„Regionï¼Œåœ¨gcæ—¶ä½¿ç”¨ã€‚G1åˆ©ç”¨Regionåˆ†å—çš„ç‰¹æ€§ï¼Œå¯¹æ¯ä¸€å—Regionåšä»·å€¼è¯„ä¼°ï¼Œæ„å»ºä¸€ä¸ªå¯é¢„æµ‹çš„æ—¶é—´åœé¡¿æ¨¡å‹ï¼Œå¦‚æœRegionå€¼å¾—å›æ”¶ï¼Œå°±ä¼šè¢«æ”¾å…¥CSetã€‚æ–°ç”Ÿä»£çš„Regionéƒ½ä¼šè¢«æ”¾å…¥CSet 5. Remembered RSet(RSet)åœ¨[JVM]CMSé‡Œè¯´è¿‡ï¼Œä½¿ç”¨äº†card tableæœºåˆ¶æ¥ç»´æŠ¤è€å¹´ä»£åˆ°æ–°ç”Ÿä»£çš„å¼•ç”¨å…³ç³»ã€‚G1æ²¡ç”¨card tableå¡è¡¨æ¥ç»´æŠ¤è¿™äº›å…³ç³»ï¼Œè€Œæ˜¯åœ¨card tableçš„åŸºç¡€ä¸Šå¼•å…¥äº†RSetï¼Œæ¯ä¸ªRegionéƒ½æœ‰ä¸€ä¸ªRSetï¼ŒRSetæ˜¯ä¸€ä¸ªhashtableï¼Œç”¨æ¥è®°å½•è°å¼•ç”¨äº†æˆ‘ï¼Œæ˜¯ä¸€ç§point-intoè®¾è®¡ï¼Œè€Œcard tableæ˜¯è®°å½•æˆ‘å¼•ç”¨äº†è°ï¼Œæ˜¯ä¸€ç§point-outè®¾è®¡ã€‚ å¼•å…¥RSetä¹‹åï¼Œå¯¹Regionå•ç‹¬å›æ”¶çš„æ—¶å€™å°±å¯ä»¥åˆ¤æ–­å½“å‰Regioné‡Œçš„å¯¹è±¡æœ‰æ²¡æœ‰è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œ cardä¸€èˆ¬æ˜¯512å­—èŠ‚ï¼Œæ‰€ä»¥Regionä¸cardæ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚å‰é¢è¯´RSetæ˜¯ä¸€ä¸ªhash tableï¼Œå‡å¦‚RegionAåœ¨ç´¢å¼•ä¸º8848çš„cardä¸Šæœ‰å¯¹è±¡å¼•ç”¨äº†RegionBï¼Œé‚£ä¹ˆBçš„RSetåº”è¯¥æœ‰è¿™æ ·çš„é”®å€¼å¯¹ï¼škeyä¸ºRegionAçš„èµ·å§‹åœ°å€ï¼Œvalueæ˜¯ä¸ªé›†åˆï¼Œcard8848çš„ç´¢å¼•æ˜¯å…ƒç´ ä¹‹ä¸€ã€‚ è¿™æ ·ï¼ŒRSetè´Ÿè´£è®°å½•äº†è€å¹´ä»£åˆ°æ–°ç”Ÿä»£çš„å¼•ç”¨ï¼Œè€å¹´ä»£åˆ°è€å¹´ä»£çš„å¼•ç”¨ã€‚è¿›è¡ŒYGCçš„æ—¶å€™ï¼Œæ‰«æYoung Regionçš„RSetï¼Œå°±å¯ä»¥çŸ¥é“è€å¹´ä»£å¯¹æ–°ç”Ÿä»£çš„å¼•ç”¨ï¼›è¿›è¡ŒMixed GCæ—¶åªéœ€è¦æ‰«æOld Regionçš„RSetå°±çŸ¥é“è€å¹´ä»£åˆ°è€å¹´ä»£çš„å¼•ç”¨. RSetçš„æ›´æ–°ä¹Ÿæ˜¯ä½¿ç”¨write barrieræ¥å®ç°ã€‚ æ³¨æ„âš ï¸å¦‚æœä¸€ä¸ªæ–°ç”Ÿä»£å¯¹è±¡å¼•ç”¨äº†è€å¹´ä»£å¯¹è±¡ï¼Œè€å¹´ä»£å¯¹åº”çš„çš„RSetæ˜¯ä¸ä¼šæ›´æ–°çš„ï¼Œè¿™æ˜¯å› ä¸ºè€å¹´ä»£gcæ—¶æ–°ç”Ÿä»£regionéƒ½ä¼šæ‰«æã€‚ 6. Snapshot-At-The-Beginning(SATB)SATBæ˜¯ä¸ªç®—æ³•ï¼Œç›®æ ‡æ˜¯ä¸ºäº†å‡å°‘é‡æ ‡è®°æ—¶é—´ï¼Œä½¿ç”¨bitmapä½œä¸ºå¿«ç…§SATBå°†Regionæ ‡ä¸Šäº†5ä¸ªæŒ‡é’ˆï¼Œbottomã€previous TAMSã€next TAMSã€topå’Œendï¼Œtopæ˜¯Regionæœ€åä¸€ä¸ªå¯¹è±¡çš„åœ°å€ï¼Œbottomå’Œendæ˜¯Regionçš„å…¶å§‹æœ«ï¼ŒTAMSæ˜¯top-at-mark-startï¼Œå°±æ˜¯topæŒ‡é’ˆçš„è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯´previous TAMSã€next TAMSæ˜¯å‰åä¸¤æ¬¡å‘ç”Ÿå¹¶å‘æ ‡è®°æ—¶topçš„ä½ç½®ï¼ˆè¿™é‡Œè¯´çš„æœ‰ç‚¹ä¹±ï¼‰ ä¸‹é¢æ˜¯G1è®ºæ–‡çš„ä¸¾ä¾‹ï¼ŒABCã€DEFæ˜¯ä¸¤ä¸ªå‘¨æœŸ å¦‚æœå¯å›æ”¶çš„ä»·å€¼ä¸å¤§ï¼Œä¸€ä¸ªRegionå¯èƒ½ä¼šç»å†å¤šä¸ªæ ‡è®°å‘¨æœŸç›´åˆ°æœ‰å›æ”¶çš„ä»·å€¼ã€‚ NextBitmapæ˜¯è¿™ä¸ªæ ‡è®°å‘¨æœŸçš„å¿«ç…§ï¼ŒPrevBitmapæ˜¯ä¸Šä¸€ä¸ªå‘¨æœŸçš„å¿«ç…§ã€‚ bitmapæ˜¯å…¨å±€çš„ã€‚ å¤§æ¦‚è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œå‡è®¾ç°åœ¨æ˜¯ç¬¬Nè½®ï¼ŒN=1 Aï¼Œåˆå§‹æ ‡è®°ï¼Œstwï¼Œtopèµ‹å€¼ç»™NextTAMSï¼Œæ¸…ç©ºNextBitmapï¼Œå°†GCROOTå¯ç›´æ¥åˆ°è¾¾çš„å¯¹è±¡å…¥æ ˆã€‚ Aå’ŒBä¹‹é—´æœ‰ä¸ªå¹¶å‘æ ‡è®°ï¼Œå®Œäº†Bçš„NextBitmapå°±æ˜¯æ ‡è®°çš„ç»“æœï¼Œåœ¨å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œåˆ†é…çš„æ–°å¯¹è±¡ä¼šéšå¼æ ‡è®°ï¼Œå³è§†ä¸ºå­˜æ´»å¯¹è±¡ã€‚ Bï¼Œé‡æ ‡è®°ï¼Œstwï¼Œå°†satb_mark_queueé‡Œçš„å¯¹è±¡è¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œå¹¶åœ¨NextBitmapæ ‡è®° Cï¼Œæ¸…ç†ï¼Œå°†NextBitmapèµ‹å€¼ç»™PrevBitmapï¼Œæ¸…ç©ºNextBitmapï¼ŒNextTAMSå’ŒPrevTAMSäº¤æ¢ä½ç½® Dï¼Œç¬¬N+1è½®åˆå§‹æ ‡è®°ã€‚ã€‚ã€‚ Eï¼Œç¬¬N+1è½®é‡æ ‡è®°ï¼Œå¯ä»¥çœ‹åˆ°PrevBitmapæ˜¯æœ‰å€¼çš„ï¼Œæ˜¯ä¸Šä¸€è½®çš„å¿«ç…§ï¼ˆæ³¨æ„ï¼Œä¸æ˜¯è¯´è¿™ä¸€è½®è¿™ä¸ªåŒºé—´çš„æ ‡è®°å°±ç…§æŠ„PrevBitmapï¼ŒNextBitmapå’ŒPrevBitmapæ²¡æœ‰å…³ç³»ï¼‰ Fï¼Œç¬¬N+1è½®æ¸…ç†ã€‚ã€‚ã€‚ æ€»ç»“ï¼š(1): [bottom, prevTAMS): è¿™éƒ¨åˆ†é‡Œçš„å¯¹è±¡å­˜æ´»ä¿¡æ¯å¯ä»¥é€šè¿‡prevBitmapæ¥å¾—çŸ¥(2): [prevTAMS, nextTAMS): è¿™éƒ¨åˆ†é‡Œçš„å¯¹è±¡åœ¨ç¬¬n-1è½®concurrent markingæ˜¯éšå¼å­˜æ´»çš„(3): [nextTAMS, top): è¿™éƒ¨åˆ†é‡Œçš„å¯¹è±¡åœ¨ç¬¬nè½®concurrent markingæ˜¯éšå¼å­˜æ´»çš„ (è¯è¯´ä¸ºä»€ä¹ˆè¦ä¸¤ä¸ªbitmapæ‰¾ä¸åˆ°èµ„æ–™ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºæ ‡è®°æ²¡å®Œæˆä¹Ÿå¯ä»¥gcï¼Œæ ‡è®°æ²¡å®Œæˆçš„æƒ…å†µä¸‹åªèƒ½ç”¨prevBitmapå¿«ç…§) åœ¨[JVM]JVMä¸­ä¸‰è‰²æ ‡è®°æ³•ä¸­æåˆ°ï¼Œä¸‰è‰²æ ‡è®°æ³•è¦è§£å†³æ¼æ ‡é—®é¢˜ï¼ŒCMSæ˜¯æ‰“ç ´äº†æ¡ä»¶ä¸€ï¼ŒG1å°±æ˜¯æ‰“ç ´æ¡ä»¶äºŒã€‚ åœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç™½è‰²å¯¹è±¡ä»ç°è‰²å¯¹è±¡åˆ é™¤ï¼Œåˆ é™¤æ—¶ä¼šæ‰§è¡Œpre_write_barrierï¼Œå°†ç™½å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œæ”¾å…¥ä¸€ä¸ªçº¿ç¨‹ç§æœ‰çš„satb_mark_queueï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œè¯¥é˜Ÿåˆ—ä¼šè¢«é€å»ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ï¼Œç„¶åä¸ºè¯¥çº¿ç¨‹åˆ†é…ä¸€ä¸ªæ–°é˜Ÿåˆ—ã€‚ 1234567891011121314151617181920212223// This notes that we don&apos;t need to access any BarrierSet data// structures, so this can be called from a static context.template &lt;class T&gt; static void write_ref_field_pre_static(T* field, oop newVal) &#123; T heap_oop = oopDesc::load_heap_oop(field); if (!oopDesc::is_null(heap_oop)) &#123; enqueue(oopDesc::decode_heap_oop(heap_oop)); &#125;&#125;void G1SATBCardTableModRefBS::enqueue(oop pre_val) &#123; // Nulls should have been already filtered. assert(pre_val-&gt;is_oop(true), &quot;Error&quot;); if (!JavaThread::satb_mark_queue_set().is_active()) return; Thread* thr = Thread::current(); if (thr-&gt;is_Java_thread()) &#123; JavaThread* jt = (JavaThread*)thr; jt-&gt;satb_mark_queue().enqueue(pre_val); &#125; else &#123; MutexLockerEx x(Shared_SATB_Q_lock, Mutex::_no_safepoint_check_flag); JavaThread::satb_mark_queue_set().shared_satb_queue()-&gt;enqueue(pre_val); &#125;&#125; 7. write barrierä¸Šé¢è¯´äº†RSetå’ŒSATBéƒ½æ˜¯ç”¨write_barrieræ¥å®ç°ï¼Œé‚£ä¹ˆå¯¹è±¡èµ‹å€¼æ—¶çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š 12345void oop_field_store(oop* field, oop new_value) &#123; pre_write_barrier(field); // pre-write barrier: for maintaining SATB invariant *field = new_value; // the actual store post_write_barrier(field, new_value); // post-write barrier: for tracking cross-region reference &#125; ä¸ºäº†å‡å°‘write_barrierçš„æ€§èƒ½å½±å“ï¼Œè¿™äº›éƒ½æ˜¯æ‰¹é‡å¤„ç†çš„(SATBæ˜¯å°†oldValueå…¥é˜Ÿsatb_mark_queueï¼ŒRSetæ˜¯å…¥é˜Ÿdirty_card_queue)ã€‚ 8. GCæ¨¡å¼8.1. YoungGC(YGC)å½“EdenåŒºæ»¡äº†ä¹‹åï¼Œéœ€è¦STWï¼Œè¿›è¡Œæ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†ã€‚ä»GCROOTå¼€å§‹æ ‡è®°ï¼Œå¹¶ä¸”è·³è¿‡è€å¹´ä»£ï¼ŒåŒæ—¶æ‰«ææ–°ç”Ÿä»£Regionçš„RSetï¼Œå¯¹äºå­˜æ´»çš„å¯¹è±¡ï¼Œç§»åŠ¨åˆ°survivorï¼Œå’ŒCMSå·®ä¸å¤šã€‚ 8.2. MixedGC8.2.1. global concurrent markingæŒ‡å…¨å±€å¹¶å‘æ ‡è®°ã€‚å¯ä»¥é€šè¿‡å‘½ä»¤-XX:InitiatingHeapOccupancyPercentæ¥è°ƒæ•´ï¼Œé»˜è®¤45ï¼Œä¸€æ—¦è¾¾åˆ°è¿™ä¸ªé˜ˆå€¼å°±å›è§¦å‘ä¸€æ¬¡å¹¶å‘æ”¶é›†å‘¨æœŸã€‚ å…¨å±€å¹¶å‘æ ‡è®°å…¶å®å°±æ˜¯åº”ç”¨SATBç®—æ³•çš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å¤šä¸ªé˜¶æ®µï¼š åˆå§‹æ ‡è®°ï¼ˆinitial-markï¼‰ï¼šSTWï¼Œä½†æ˜¯ï¼Œé€šå¸¸è¿™ä¸ªå·¥ä½œæ˜¯ç”±YGCæ¥æ‰¿æ‹…çš„ï¼Œä¹Ÿå°±æ˜¯è®©ä¸‹ä¸€æ¬¡YGCå·¥ä½œä¹…ä¸€ç‚¹ï¼Œè¿™ä¼šå¢åŠ CPUå¼€é”€ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯ä¸ºRegionè®¾ç½®previous TAMSã€next TAMSï¼Œæ‰€æœ‰åœ¨next TAMSä¹‹ä¸Šçš„å¯¹è±¡åœ¨è¿™ä¸ªå¹¶å‘å‘¨æœŸå†…ä¼šè¢«è¯†åˆ«ä¸ºéšå¼å­˜æ´»å¯¹è±¡ã€‚ä½¿ç”¨bitmapæ¥æ ‡è®°å¯¹è±¡ï¼Œä¸ä½¿ç”¨å¯¹è±¡å¤´çš„mark wordã€‚GC Rootç›´æ¥å¯è¾¾çš„å¯¹è±¡ä¼šè¢«å‹å…¥mark stack; å¹¶å‘æ ‡è®°ï¼ˆconcurrent-markï¼‰ï¼šå¯ä»¥é€šè¿‡-XX:ConcGCThreadsè®¾ç½®çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤æ˜¯-XX:ParallelGCThreadsçš„å››åˆ†ä¹‹ä¸€ã€‚è¿™ä¸ªé˜¶æ®µä¼šå¼¹å‡ºmark stackçš„å¯¹è±¡æ ‡è®°ï¼Œå¹¶å¯¹å…¶å­—æ®µè¿›è¡Œå‹æ ˆï¼Œè®°å½•åœ¨bitmapï¼›é‡å¤è‡³æ ˆç©º é‡æ ‡è®°ï¼ˆremarkingï¼‰ï¼šSTWï¼Œå°†çº¿ç¨‹ç§æœ‰å’Œå…¨å±€çš„satb_mark_queueé‡Œçš„å¯¹è±¡è¿›è¡Œåˆ†ææ ‡è®°ã€‚ æ¸…ç†ï¼ˆcleanupï¼‰ï¼šä¸æ˜¯åƒåœ¾å›æ”¶ï¼Œè¿™ä¸ªé˜¶æ®µä¸»è¦è¯†åˆ«ç©ºåˆ†åŒºã€RSetæ¢³ç†ã€å¸è½½classã€å›æ”¶Humongousï¼Œå¯¹è€å¹´ä»£Regionè¿›è¡Œæ´»åº¦æ’åºã€‚ 8.2.2. ä¸cmsçš„æ¯”è¾ƒè¿™ä¸ªè¿‡ç¨‹æœ‰ç‚¹åƒCMSçš„æ‰§è¡Œè¿‡ç¨‹ã€‚æ€»ä½“ä¸Šçœ‹ï¼ŒåŒºåˆ«æ˜¯é‡æ ‡è®°è¿™ä¸ªé˜¶æ®µï¼ŒCMSéœ€è¦ä»æ ¹é›†é‡æ–°æ‰«ï¼ˆè§CMSï¼‰ï¼Œè€ŒSTABç®—æ³•çš„å†™å±éšœæ˜¯åœ¨å¯¹è±¡åˆ é™¤æ—¶éƒ½è¦æ ‡è®°å¯¹è±¡ï¼Œé¿å…æ¼æ ‡è®°ã€‚æ‰€ä»¥åœ¨remarké˜¶æ®µåªéœ€è¦æ‰«æé˜Ÿåˆ—å¯¹è±¡å°±å¯ä»¥äº†ã€‚ 8.2.3. æ‹·è´å­˜æ´»å¯¹è±¡ï¼ˆevacuationï¼‰STWï¼Œå¯¹æ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡è¿›è¡Œæ¸…ç†ã€‚ä¸€æ¬¡å…¨å±€å¹¶å‘æ ‡è®°å®Œæˆåï¼Œå°±å¼€å§‹å›æ”¶äº†ã€‚ Young GCï¼šé€‰å®šæ‰€æœ‰æ–°ç”Ÿä»£é‡Œçš„Regionã€‚é€šè¿‡æ§åˆ¶æ–°ç”Ÿä»£çš„regionä¸ªæ•°æ¥æ§åˆ¶young GCçš„å¼€é”€ã€‚ Mixed GCï¼šé€‰å®šæ‰€æœ‰æ–°ç”Ÿä»£é‡Œçš„Regionï¼Œå¤–åŠ æ ¹æ®global concurrent markingç»Ÿè®¡å¾—å‡ºæ”¶é›†æ”¶ç›Šé«˜çš„è‹¥å¹²è€å¹´ä»£Regionã€‚åœ¨ç”¨æˆ·æŒ‡å®šçš„å¼€é”€ç›®æ ‡èŒƒå›´å†…å°½å¯èƒ½é€‰æ‹©æ”¶ç›Šé«˜çš„è€å¹´ä»£Regionã€‚ä¸¤ä»£Regionä¸€èµ·æ¸…ç†ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå«Mixed GCäº†ã€‚ å¯¹äºå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡ï¼Œè½¬ç§»åˆ°æ–°åˆ†åŒºä¸Šï¼Œè¿™æ ·ç›¸å¯¹äºCMSï¼Œå‡å°‘äº†å†…å­˜ç¢ç‰‡ã€‚ 8.3. å¯èƒ½çš„GCè¿‡ç¨‹ï¼ˆfrom RednaxelaFXï¼‰ ä¸€ä¸ªå‡æƒ³çš„æ··åˆçš„STWæ—¶é—´çº¿ï¼š å¯åŠ¨ç¨‹åº-&gt; young GC-&gt; young GC-&gt; young GC-&gt; young GC + initial marking(â€¦ concurrent marking â€¦)-&gt; young GC (â€¦ concurrent marking â€¦)(â€¦ concurrent marking â€¦)-&gt; young GC (â€¦ concurrent marking â€¦)-&gt; final marking-&gt; cleanup-&gt; mixed GC-&gt; mixed GC-&gt; mixed GCâ€¦-&gt; mixed GC-&gt; young GC + initial marking(â€¦ concurrent marking â€¦)â€¦ 9. å‚è€ƒ Java Hotspot G1 GCçš„ä¸€äº›å…³é”®æŠ€æœ¯ G1åƒåœ¾æ”¶é›†å™¨è¯¦è§£ https://hllvm-group.iteye.com/group/topic/44381 G1è®ºæ–‡åŸæ–‡ é¢è¯•å®˜é—®æˆ‘G1å›æ”¶å™¨æ€ä¹ˆçŸ¥é“ä½ æ˜¯ä»€ä¹ˆæ—¶å€™çš„åƒåœ¾ï¼Ÿ","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"GC","slug":"GC","permalink":"https://htchz.cc/tags/GC/"},{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}],"author":"åœŸå·"},{"title":"[JVM]CMS","slug":"JVM-CMS","date":"2018-04-02T00:20:00.000Z","updated":"2020-04-02T10:29:26.793Z","comments":true,"path":"4242301031.html","link":"","permalink":"https://htchz.cc/4242301031.html","excerpt":"","text":"1. ä»€ä¹ˆæ˜¯CMSConcurrent Mark Sweepã€‚çœ‹åå­—å°±çŸ¥é“ï¼ŒCMSæ˜¯ä¸€æ¬¾å¹¶å‘ã€ä½¿ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•çš„gcã€‚CMSæ˜¯é’ˆå¯¹è€å¹´ä»£è¿›è¡Œå›æ”¶çš„GCã€‚ 2. CMSæœ‰ä»€ä¹ˆç”¨CMSä»¥è·å–æœ€å°åœé¡¿æ—¶é—´ä¸ºç›®çš„ã€‚åœ¨ä¸€äº›å¯¹å“åº”æ—¶é—´æœ‰å¾ˆé«˜è¦æ±‚çš„åº”ç”¨æˆ–ç½‘ç«™ä¸­ï¼Œç”¨æˆ·ç¨‹åºä¸èƒ½æœ‰é•¿æ—¶é—´çš„åœé¡¿ï¼ŒCMS å¯ä»¥ç”¨äºæ­¤åœºæ™¯ã€‚ 3. æ‰§è¡Œæµç¨‹(6ä¸ªé˜¶æ®µ) åˆå§‹æ ‡è®°(STW) å¹¶å‘æ ‡è®° é¢„æ¸…ç† å¯ä¸­æ–­é¢„æ¸…ç† é‡æ ‡è®°(STW) å¹¶å‘æ¸…ç† é‡ç½® 3.1. åˆå§‹æ ‡è®° éœ€è¦stwï¼Œæš‚åœç”¨æˆ·çº¿ç¨‹ æ ‡è®°GC ROOTç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ è™½ç„¶CMSæ˜¯é’ˆå¯¹è€å¹´ä»£è¿›è¡Œå›æ”¶çš„GCï¼Œä½†ä¸ºäº†å®ŒæˆGCROOT TRACING, ä»è¦æ‰«ææ–°ç”Ÿä»£ 3.2. å¹¶å‘æ ‡è®° ç»§ç»­è¿è¡Œç”¨æˆ·çº¿ç¨‹ï¼Œæ ‡è®°æ´»åŠ¨å’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘è¿›è¡Œ ç”±åˆå§‹æ ‡è®°å‡ºå‘ï¼Œæ‰€æœ‰å¯åˆ°è¾¾çš„å¯¹è±¡éƒ½åœ¨æœ¬é˜¶æ®µä¸­æ ‡è®°ï¼Œä½¿ç”¨ä¸‰è‰²æ ‡è®°æ³•æ ‡è®°ã€‚ 3.3. é¢„æ¸…ç† ç”±äºé‡æ ‡è®°ä¼šå¯¼è‡´stwï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µç›®çš„ä¸ºäº†å°½å¯èƒ½å‡å°‘stwæ—¶é—´ æ­¤é˜¶æ®µæ‰«æã€‚ï¼ˆ1ï¼‰è€å¹´ä»£ä¸­cardä¸ºdirtyçš„å¯¹è±¡ï¼›ï¼ˆ2ï¼‰å¹¸å­˜åŒº(fromå’Œto)ä¸­å¼•ç”¨çš„è€å¹´ä»£å¯¹è±¡ã€‚å› æ­¤ï¼Œè¿™ä¸ªé˜¶æ®µä¹Ÿéœ€è¦æ‰«ææ–°ç”Ÿä»£+è€å¹´ä»£ã€‚ 3.3.1. cardCMSå°†è€å¹´ä»£åˆ†ä¸ºå¤šä¸ªcardï¼Œåˆä½¿ç”¨ä¸€ä¸ªcard tableç´¢å¼•cardï¼Œæœ‰ç‚¹åƒå†…å­˜åˆ†é¡µæœºåˆ¶ã€‚ ä¸€ä¸ªcardä¸€èˆ¬æ˜¯512å­—èŠ‚ã€‚ å½“ç™½è‰²å¯¹è±¡çš„å¼•ç”¨è¢«é»‘è‰²å¯¹è±¡æ—¶ï¼Œä¼šè§¦å‘ä¸€é“å†™å±éšœï¼ˆwrite barrierï¼‰ã€‚å†™å±éšœä¼šå°†é»‘è‰²å¯¹è±¡æ‰€åœ¨çš„cardå¯¹åº”çš„card tableç´¢å¼•å¤„ï¼Œæ ‡è®°ä¸ºdirty cardï¼Œå°†dirty cardå…¥é˜Ÿï¼Œå°†åŒæ—¶æŠŠç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚ æ‰€ä»¥é¢„æ¸…ç†å’Œé‡æ ‡è®°çš„å¯è¾¾æ€§åˆ†æä¼šå°†dirty cardçº³å…¥ã€‚ å¦å¤–ï¼Œæ–°ç”Ÿä»£çš„å¯¹è±¡å¦‚æœè¢«è€å¹´ä»£å¼•ç”¨ï¼Œå¦‚æœæ¯æ¬¡Young GCéƒ½è¦æ‰«æè€å¹´ä»£æ˜¯ä¸ç°å®çš„ï¼Œæ‰€ä»¥Young GCä¹Ÿä¼šæ‰«ædirty cardå¯¹åº”çš„å¯¹è±¡è¿›è¡Œåˆ†æã€‚card tableæœ‰ä¸ª8ä½å±æ€§å¯ä»¥è¡¨æ˜cardçš„ç±»å‹ã€‚ â€œå±éšœâ€è€è®©æˆ‘æƒ³åˆ°lolçš„â€œå±éšœâ€ï¼Œâ€œå±éšœâ€æ˜¯ä¿æŠ¤çš„ï¼Œä¸€ç›´ä»¥ä¸ºâ€œå†™å±éšœâ€æ˜¯â€œå†™ä¿æŠ¤â€ä¹‹ç±»çš„ä¸œè¥¿ã€‚å…¶å®å°±æ˜¯ä¸€ä¸ªå†™æ‹¦æˆªå™¨ã€‚ 3.3.2. incremental updatecmsçš„å†™å±éšœå‘ç”Ÿåœ¨å †å†…å¼•ç”¨èµ‹æ–°å€¼çš„æ—¶å€™ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼Œ 12345678public static void main(String[] args) &#123; Animal p = new Dog(); p.child = new Dog(); p.child.bark(); Animal q = p.child; p.child = null; q.bark();&#125; åœ¨ç¬¬4è¡Œcmså¼€å§‹æ ‡è®°ï¼Œp.childæ˜¯ç™½è‰²å¯¹è±¡ï¼Œåœ¨p.childè¢«æ ‡è®°å‰ï¼Œå°†p.childèµ‹å€¼ç»™qï¼Œç”±äºèµ‹å€¼å±€éƒ¨å˜é‡è¡¨æ²¡æœ‰å†™å±éšœï¼Œæ‰€ä»¥è¿™ä¸ªp.childä¸ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œè€Œp.childçš„å¼•ç”¨åˆåœ¨ç¬¬6è¡Œè§£é™¤ï¼ˆå¦‚æœæ˜¯SATBæ˜¯ä¼šè®°å½•çš„ï¼‰ï¼Œç„¶åå‡è®¾æ­¤æ—¶å¹¶å‘æ ‡è®°å®Œæˆã€‚è¿™æ ·remarké˜¶æ®µå°±éœ€è¦é‡æ–°æ‰«ä¸€éæ ¹ï¼Œå¦åˆ™å°±ä¼šæ¼æ‰è¿™ä¸ªç™½è‰²å¯¹è±¡ã€‚ ä¸ä¹‹ç›¸å¯¹çš„ï¼ŒG1çš„STABremarkä¸ç”¨é‡æ–°æ‰«ææ ¹é›†ï¼Œå› ä¸ºG1æ¯”è¾ƒç‹ ï¼Œåªè¦æ˜¯å¯¹è±¡è¢«åˆ é™¤å°±è®°å½•ä¸‹æ¥ã€‚ 3.4. å¯ä¸­æ–­çš„é¢„æ¸…ç†ï¼ˆabortable precleanï¼‰è¿™ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯ä¸åœå¾ªç¯æ‰§è¡Œé¢„æ¸…ç†ã€‚å¼€å¯æ¡ä»¶æ˜¯ï¼š Edençš„ä½¿ç”¨ç©ºé—´å¤§äºCMSScheduleRemarkEdenSizeThresholdï¼Œè¿™ä¸ªå‚æ•°çš„é»˜è®¤å€¼æ˜¯2Mï¼› Edençš„ä½¿ç”¨ç‡å°äºCMSScheduleRemarkEdenPenetrationï¼Œè¿™ä¸ªå‚æ•°çš„é»˜è®¤å€¼æ˜¯50%ã€‚ é€€å‡ºçš„æ¡ä»¶æ˜¯ å¾ªç¯çš„æ¬¡æ•°è¶…è¿‡äº†CMSMaxAbortablePrecleanLoopsï¼Œè¿™ä¸ªå‚æ•°å¦‚æœæ²¡æœ‰è®¾ç½®å°±ä¸ä¼šä½œä¸ºæ¡ä»¶ï¼› å¾ªç¯æ€»æ—¶é—´è¶…è¿‡äº†CMSMaxAbortablePrecleanLoopsï¼Œè¿™ä¸ªå‚æ•°é»˜è®¤å€¼5000msã€‚ Edençš„ä½¿ç”¨ç‡å¤§äºç­‰äºCMSScheduleRemarkEdenPenetrationã€‚ è¿™ä¸ªå°±å¾ˆå¥‡å¦™äº†ï¼Œå¤§éƒ¨åˆ†æ–‡ç« éƒ½æ˜¯è¯´å¯ä¸­æ–­çš„é¢„æ¸…ç†æ˜¯ä¸ºäº†ç¼©çŸ­é‡æ ‡è®°çš„æ—¶é—´ï¼Œä½†æ˜¯æˆ‘æœ‰å¦ä¸€ä¸ªç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆè¿™ä¸ªè¿‡ç¨‹è¦Edenä½¿ç”¨ç‡å°äº50%å¼€å§‹ï¼Œè¶…è¿‡50%ç»“æŸï¼Œæˆ‘çŒœ50%æ˜¯ä¸ªä¸¤æ¬¡Young GCçš„ä¸­é—´ï¼Œåœ¨è¿™ä¸ªæ—¶é—´é€€å‡ºabortable precleanè¿›å…¥remarké˜¶æ®µï¼Œå°±å¯ä»¥é˜²æ­¢remarkçš„STWå’ŒYoung GCçš„STWè¿ç»­ï¼Œä»è€Œé€ æˆæ¯”è¾ƒå¤§çš„åœé¡¿ã€‚ å¦å¤–ï¼Œå¯ä»¥å¼€å¯CMSScavengeBeforeRemarkï¼Œåœ¨remarkä¹‹å‰è¿›è¡Œä¸€æ¬¡å¼ºåˆ¶çš„Young GCã€‚ 3.5. é‡æ ‡è®°ï¼ˆremarkï¼‰ é‡æ ‡è®°éœ€è¦STWï¼ˆStop The Worldï¼‰ æš‚åœæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œä»æ–°ç”Ÿä»£ã€GCROOTè¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œæ ‡è®°æ´»ç€çš„å¯¹è±¡ã€‚ å¤šçº¿ç¨‹æ“ä½œ å·²æ ‡è®°è¿‡çš„ä¸ä¼šå†å¤„ç† é‡æ–°æ‰«æï¼Ÿé‚£å‰é¢çš„å·¥ä½œæ˜¯ç™½ç»™ï¼Ÿå…¶å®ä¸æ˜¯ï¼Œå·²æ ‡è®°è¿‡çš„ä¸ä¼šå†å¤„ç†ï¼Œæ‰€ä»¥é‡æ–°æ‰«æä¼šé‡åˆ°å¾ˆå¤šæ ‡è®°å®Œæˆçš„å¯¹è±¡ã€‚ 3.6. å¹¶å‘æ¸…ç†å¹¶å‘æ¸…ç†ã€‚ç”¨æˆ·çº¿ç¨‹è¢«é‡æ–°æ¿€æ´»ï¼ŒåŒæ—¶æ¸…ç†é‚£äº›æ— æ•ˆçš„å¯¹è±¡ã€‚ 3.7. é‡ç½®CMSæ¸…é™¤å†…éƒ¨çŠ¶æ€ï¼Œä¸ºä¸‹æ¬¡å›æ”¶åšå‡†å¤‡ã€‚ 4. å­˜åœ¨çš„é—®é¢˜ è´¹cpuï¼Œgcçº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘ cardè§£å†³äº†æ¼æ ‡çš„é—®é¢˜ï¼Œä½†è§£å†³ä¸äº†è¯¯æ ‡ï¼Œè¯¯æ ‡çš„å³æµ®åŠ¨åƒåœ¾ï¼Œéœ€è¦ä¸‹ä¸€è½®GCæ‰èƒ½æ¸…æ¥šã€‚ ç”±äºåƒåœ¾å›æ”¶é˜¶æ®µç”¨æˆ·çº¿ç¨‹ä»åœ¨æ‰§è¡Œï¼Œå¿…éœ€é¢„ç•™å‡ºå†…å­˜ç©ºé—´ç»™ç”¨æˆ·çº¿ç¨‹ä½¿ç”¨ã€‚å› æ­¤ä¸èƒ½åƒå…¶ä»–å›æ”¶å™¨é‚£æ ·ï¼Œç­‰åˆ°è€å¹´ä»£æ»¡äº†å†è¿›è¡ŒGCã€‚æœ‰ä¸ªCMSInitiatingOccupancyFractionè®¾ç½®ä¸€ä¸ªç™¾åˆ†æ¯”ï¼Œè¡¨æ˜è¾¾åˆ°è¿™ä¸ªå€¼å°±è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè§ã€ŠJVM-MinorGCä¸FullGCã€‹çš„concurrent mode failureå…³é”®å­— ä¸Šé¢å¹¶å‘é€ æˆçš„ï¼Œæ¥ä¸‹æ¥æ˜¯â€˜æ ‡è®°-æ¸…é™¤â€™ç®—æ³•é€ æˆçš„ï¼Œè¿™ä¸ªç®—æ³•é€ æˆç©ºé—´ç¢ç‰‡ï¼Œè™šæ‹Ÿæœºè¿˜æä¾›äº†å¦å¤–ä¸€ä¸ªå‚æ•°CMSFullGCsBeforeCompactionï¼Œç”¨äºè®¾ç½®æ‰§è¡Œå¤šå°‘æ¬¡ä¸å‹ç¼©çš„Full GCåï¼Œè·Ÿç€æ¥ä¸€æ¬¡å¸¦å‹ç¼©çš„ï¼ˆé»˜è®¤ä¸º0ï¼Œæ¯æ¬¡è¿›å…¥Full GCæ—¶éƒ½è¿›è¡Œç¢ç‰‡æ•´ç†ï¼‰ã€‚ 5. å‚è€ƒ å…³äºâ€œConcurrent Abortable Precleanâ€çš„ç–‘é—® CMSåƒåœ¾æ”¶é›†å™¨è¯¦è§£ â€“ é˜¿æœçš„ä¸–ç•Œ","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"GC","slug":"GC","permalink":"https://htchz.cc/tags/GC/"},{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}]},{"title":"[JVM]MinorGCä¸FullGC","slug":"JVM-MinorGCä¸FullGC","date":"2018-04-02T00:11:00.000Z","updated":"2020-03-17T14:37:38.140Z","comments":true,"path":"527051980.html","link":"","permalink":"https://htchz.cc/527051980.html","excerpt":"","text":"1. Minor GCï¼ŸFull GCï¼Ÿ minor gcæŒ‡çš„æ˜¯åœ¨å¹´è½»ä»£çš„gc full gcæŒ‡çš„æ˜¯æ•´ä¸ªå †çš„æ¸…ç†ï¼ŒåŒ…æ‹¬å¹´è½»ä»£å’Œè€å¹´ä»£(è€å¹´ä»£çš„gcä¸€èˆ¬å«major gc) 2. ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘Minor GCæˆ‘ä»¬æ‹¿CMSæ¥ä¸¾ä¾‹å­ã€‚ EdenåŒºåŸŸæ»¡äº†ï¼Œæˆ–è€…æ–°åˆ›å»ºçš„å¯¹è±¡å¤§å° &gt; Edenæ‰€å‰©ç©ºé—´ CMSè®¾ç½®äº†CMSScavengeBeforeRemarkå‚æ•°ï¼Œè¿™æ ·åœ¨CMSçš„Remarkä¹‹å‰ä¼šå…ˆåšä¸€æ¬¡Minor GCæ¥æ¸…ç†æ–°ç”Ÿä»£ï¼ŒåŠ é€Ÿä¹‹åçš„Remarkçš„é€Ÿåº¦ã€‚è¿™æ ·æ•´ä½“çš„stop-the worldæ—¶é—´åè€ŒçŸ­ Full GCçš„æ—¶å€™ä¼šå…ˆè§¦å‘Minor GC 3. ä»€ä¹ˆæ—¶å€™è§¦å‘Full GC Minor GCåå¯¹è±¡æ™‹å‡è€å¹´ä»£ï¼Œç”±äºæ‹…ä¿æœºåˆ¶(çœ‹ã€Š[JVM]GCé‚£äº›äº‹(å››)å¯¹è±¡çš„åˆ†é…å›æ”¶ç­–ç•¥ã€‹)ï¼Œä¸¤ç§æƒ…å†µè§¦å‘Full GCï¼Œä¸€ç§æ™‹å‡å¹³å‡å¤§å° &gt; è€å¹´ä»£å‰©ä½™ç©ºé—´ï¼ˆåŸºäºå†å²å¹³å‡æ°´å¹³ï¼‰ï¼Œå¦ä¸€ç§å­˜æ´»å¯¹è±¡ &gt; è€å¹´ä»£å‰©ä½™ç©ºé—´ï¼ˆåŸºäºä¸‹ä¸€æ¬¡å¯èƒ½è¦æ™‹å‡çš„æœ€å¤§æ°´å¹³ï¼‰ï¼Œä¸¤ç§æƒ…å†µéƒ½å±äºpromotion failure å‘ç”Ÿconcurrent mode failureä¼šå¼•èµ·Full GCï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šä½¿ç”¨Serial Oldæ”¶é›†å™¨ï¼Œæ˜¯å•çº¿ç¨‹çš„ï¼Œå¯¹GCçš„å½±å“å¾ˆå¤§ã€‚å¤§å¯¹è±¡(ç”±PretenureSizeThresholdæ§åˆ¶æ–°ç”Ÿä»£ç›´æ¥æ™‹å‡è€å¹´ä»£çš„å¯¹è±¡sizeé˜€å€¼)ä¸èƒ½è¿›å…¥åˆ°è€å¹´ä»£ï¼Œåªæœ‰stop the worldæ¥æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œæ‰§è¡ŒGCæ¸…ç†ã€‚å¯ä»¥é€šè¿‡è®¾ç½®CMSInitiatingOccupancyFractioné¢„ç•™åˆé€‚çš„CMSæ‰§è¡Œæ—¶å‰©ä½™çš„ç©ºé—´ ï¼ˆjdk8 å·²å®Œå…¨ç§»é™¤æ°¸ä¹…ä»£ï¼Œå°†æ­¤ç±»ä¿¡æ¯æ”¾å…¥æœ¬åœ°å†…å­˜ï¼‰Permæ°¸ä¹…ä»£ç©ºé—´ä¸è¶³ä¼šè§¦å‘Full GCï¼Œå¯ä»¥è®©CMSæ¸…ç†æ°¸ä¹…ä»£çš„ç©ºé—´ã€‚è®¾ç½®CMSClassUnloadingEnabledå³å¯ System.gc()å¼•èµ·çš„Full GCï¼Œå¯ä»¥è®¾ç½®DisableExplicitGCæ¥ç¦æ­¢è°ƒç”¨System.gcå¼•å‘Full GC concurrent mode failureï¼Œå³å¯åŠ¨ä¸äº†å¹¶å‘æ¸…ç†ï¼Œå› ä¸ºå†…å­˜ä¸è¶³å¯¼è‡´å¹¶å‘æƒ…å†µä¸‹ï¼Œè¿˜æ²¡æ¥å¾—åŠæ¸…ç†å†…å­˜å°±çˆ†äº†ï¼Œæ‰€ä»¥è¦é€€åŒ–ä¸ºä¸²è¡Œçš„åƒåœ¾æ”¶é›† promotion failureï¼Œå³æ‹…ä¿æœºåˆ¶å¤±è´¥ 4. ä»€ä¹ˆæ—¶å€™OOM OOMä¸æ˜¯å†…å­˜è¾¾åˆ°100%æ‰æŠ¥çš„ å½“èŠ±åœ¨GCçš„æ—¶é—´è¶…è¿‡äº†GCTimeLimitï¼Œè¿™ä¸ªå€¼é»˜è®¤æ˜¯98% å½“GCåçš„å®¹é‡å°äºGCHeapFreeLimitï¼Œè¿™ä¸ªå€¼é»˜è®¤æ˜¯2% 5. ä»€ä¹ˆæ˜¯ç©ºé—´ä¸å¤Ÿ å‰©ä½™ç©ºé—´ä¸å¤Ÿä¸æ˜¯è¯´æ•´ä½“çš„ç©ºé—´ä¸å¤Ÿåˆ†é…æŸä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯è¯´è¿ç»­çš„ç©ºé—´ä¸å¤Ÿåˆ†é…ç»™æŸä¸ªå¯¹è±¡ã€‚æ‰€ä»¥ä¸€æ—¦å†…å­˜ç¢ç‰‡å¤§å¤šå°±å¯èƒ½å‘ç”Ÿå‰©ä½™ç©ºé—´ä¸å¤Ÿçš„é—®é¢˜ï¼Œæ‰€ä»¥CMSè¿™ç§æ”¶é›†å™¨ï¼Œéœ€è¦åœ¨æ ‡è®°-æ¸…é™¤å‡ æ¬¡ä¹‹åè¿›è¡Œå‹ç¼©ï¼Œè¿›è¡Œä¼˜åŒ–ã€‚CMSFullGCsBeforeCompactionå¯ä»¥è®¾ç½®è¿›è¡Œå‡ æ¬¡æ¸…é™¤ä¹‹åè¿›è¡Œå‹ç¼© 6. å…¶ä»–çš„ä¸€äº›tip JMIé»˜è®¤ä¼šä¸€ä¸ªå°æ—¶è°ƒç”¨ä¸€æ¬¡System.gc()æ¸…ç†ç¼“å­˜ï¼Œæ‰€ä»¥å¯ä»¥DisableExplicitGCï¼Œä¹Ÿå¯ä»¥è®¾ç½®sun.rmi.dgc.client.gcIntervalå’Œsun.rmi.dgc.server.gcIntervalå‚æ•°æ¥è§„å®šJMIæ¸…ç†çš„æ—¶é—´ ä¸€æ—¦å¯¹è±¡è¿›å…¥äº†è€å¹´ä»£ï¼Œé‚£ä¹ˆåªæœ‰è§¦å‘CMS(åªé’ˆå¯¹CMSè€Œè¨€)æˆ–è€…Full GCçš„æ—¶å€™æ‰èƒ½è¢«æ¸…é™¤ã€‚ CMSä¸ç­‰äºFull GCï¼Œå¾ˆå¤šäººä¼šè®¤ä¸ºCMSè‚¯å®šä¼šå¼•å‘Minor GCã€‚CMSæ˜¯é’ˆå¯¹è€å¹´ä»£çš„GCç­–ç•¥ï¼ŒåŸåˆ™ä¸Šå®ƒä¸ä¼šå»æ¸…ç†æ–°ç”Ÿä»£ï¼Œåªæœ‰è®¾ç½®CMSScavengeBeforeRemarkä¼˜åŒ–æ—¶ï¼Œæˆ–è€…æ˜¯concurrent mode failureçš„æ—¶å€™æ‰ä¼šå»åšMinor GCã€‚ å¯¹äºæ€§èƒ½è°ƒä¼˜æ¥è¯´ï¼Œåº”è¯¥ç†è§£å¯¹äºç»™å®šçš„ç¡¬ä»¶ï¼Œç»™å®šçš„ç®—æ³•(åƒåœ¾æ”¶é›†å™¨)ï¼Œå•ä¸ª/å¤šä¸ªçº¿ç¨‹å•ä½æ—¶é—´å†…èƒ½å¤Ÿå›æ”¶çš„ç©ºé—´æ˜¯æ¥è¿‘ä¸€ä¸ªå¸¸é‡çš„ã€‚å¦‚æœæƒ³è¦ç¼©çŸ­GCçš„æ—¶å€™ï¼Œå°±è¦è€ƒè™‘æ˜¯å¦è¦ç›¸åº”è°ƒå°ç©ºé—´ CMSæ”¶é›†å™¨ä¼šäº†å‡å°‘stop the worldçš„æ—¶é—´ï¼Œè®©GCçº¿ç¨‹å’Œä¸šåŠ¡çº¿ç¨‹å¹¶å‘ï¼Œè¿™æ ·ä¹Ÿå°±ç›¸å¯¹æ‹‰é•¿äº†CMSæ”¶é›†å™¨å•æ¬¡GCçš„æ—¶é—´ å°½å¯èƒ½åœ°è®©å¯¹è±¡åœç•™åœ¨æ–°ç”Ÿä»£ï¼Œå› ä¸ºæ–°ç”Ÿä»£é‡‡ç”¨äº†å¤åˆ¶ç®—æ³•ï¼Œç›¸å¯¹æ”¶å›å¾—æ›´å¿«ï¼Œè€Œä¸”Minor GCçš„æ¬¡æ•°è‚¯å®šæ¯”Full GCå¤šï¼Œé‚£ä¹ˆå¯¹è±¡åœ¨æ–°ç”Ÿä»£è¢«æ¸…é™¤çš„æ›´èƒ½æ€§ä¼šæ›´é«˜ã€‚è€Œå¯¹è±¡ä¸€æ—¦è¿›å…¥åˆ°è€å¹´ä»£ï¼Œé‚£ä¹ˆåªæœ‰Full GCæ—¶æ‰ä¼šå›æ”¶ï¼Œå¯¹è±¡åœ¨æ•´ä¸ªç³»ç»Ÿåœç•™çš„æ—¶é—´å°±ä¼šå¾ˆé•¿ï¼Œå¾ˆå¯èƒ½åˆ›å»ºçš„å®ƒçš„çº¿ç¨‹æ—©å°±æ­»äº†ï¼Œè€Œå®ƒè¿˜æ´»ç€ ä¸ºäº†å°½å¯èƒ½è®©å¯¹è±¡åœç•™åœ¨æ–°ç”Ÿä»£ï¼Œå°±è¦æ³¨æ„è®¾ç½®SurvivoråŒºåŸŸçš„å¤§å°ï¼Œå› ä¸ºå®ƒç›´æ¥å’Œå¯¹è±¡æ˜¯å¦è¿›å…¥è€å¹´ä»£ç›¸å…³ã€‚ä¹‹å‰å°±é‡åˆ°è¿‡è¿™ç§æƒ…å†µï¼Œæ˜æ˜æ–°ç”Ÿä»£è¿˜æœ‰å¾ˆå¤§çš„ç©ºé—´ï¼Œä½†æ˜¯æ¯æ¬¡Minor GCåæ€»æ˜¯æœ‰å¯¹è±¡è¿›å…¥åˆ°äº†è€å¹´ä»£ã€‚åæ¥å‘ç°ç”±äºSurvivorå¤ªå°ï¼Œå¯¼è‡´Tenuring Thresholdä¸º1ï¼Œæ„æ€æ˜¯å¹´é¾„ä¸º1çš„å¯¹è±¡å¤§å°è¶…è¿‡äº†Survivor / 2(å¯é€šè¿‡TargetSurvivorRatioæ¥è°ƒèŠ‚ï¼Œé»˜è®¤æ˜¯50ï¼Œå³1/2)ï¼Œå¹´é¾„åªè¦è¶…è¿‡1çš„å¯¹è±¡è¿™æ—¶å€™å°±è¦ç›´æ¥è¿›å…¥è€å¹´ä»£äº†ã€‚è€Œè¿›å…¥è€å¹´ä»£ï¼Œå¯¹è±¡å°±åªæœ‰åœ¨Full GCçš„æ—¶å€™æ‰ä¼šè¢«æ¸…é™¤ã€‚è€Œå¦‚æœè°ƒå¤§äº†Survivorç©ºé—´ï¼Œè®©å¯¹è±¡å¯¹è±¡å°½é‡æ¥è¿‘Max Tenuring Thresholdæ—¶æ‰è¿›å…¥åˆ°è€å¹´ä»£ï¼Œè¿™æ—¶å€™ä¼šå¤§å¤§å‡å°‘è€å¹´ä»£çš„å¯¹è±¡å¤§å°ï¼Œå¹¶ä¸”è®©å¯¹è±¡åœ¨æ–°ç”Ÿä»£åœç•™æ—¶é—´å˜é•¿ï¼Œæé«˜äº†å®ƒä»¬è¢«å¿«é€Ÿæ¸…ç†å‡ºç³»ç»Ÿçš„æ¦‚ç‡ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"GC","slug":"GC","permalink":"https://htchz.cc/tags/GC/"},{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}],"author":"åœŸå·"},{"title":"[JVM]åƒåœ¾æ”¶é›†å™¨","slug":"JVM-åƒåœ¾æ”¶é›†å™¨","date":"2018-04-01T23:52:00.000Z","updated":"2020-03-17T14:54:15.191Z","comments":true,"path":"1597842502.html","link":"","permalink":"https://htchz.cc/1597842502.html","excerpt":"","text":"åˆ—ä¸€ä¸‹ä»å¤åˆ°ä»Šä¸»æµçš„åƒåœ¾æ”¶é›†å™¨ 1. Serialæ”¶é›†å™¨â€”â€”æœ€åŸºæœ¬ã€å‘å±•å†å²æœ€æ‚ ä¹…çš„ä»£æ”¶é›†å™¨Serialæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œè€Œä¸”è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œå¿…é¡»åœæ‰æ‰€æœ‰å…¶ä»–çº¿ç¨‹ä¼˜ç‚¹ï¼šç®€å•é«˜æ•ˆï¼Œå•çº¿ç¨‹å¯ä»¥è·å¾—æœ€é«˜çš„æ”¶é›†æ•ˆç‡ Clientç«¯ä¸‹çš„è™šæ‹Ÿæœºæ˜¯ä¸ªå¾ˆå¥½çš„æ–°ç”Ÿä»£æ”¶é›†å™¨ 2. ParNew æ”¶é›†å™¨â€”â€”Serialçš„å¤šçº¿ç¨‹ç‰ˆæœ¬é™¤äº†ä½¿ç”¨å¤šæ¡çº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†ä¹‹å¤–ï¼Œå…¶ä½™è¡Œä¸ºåŒ…æ‹¬Serialæ”¶é›†å™¨å¯ç”¨çš„æ‰€æœ‰æ§åˆ¶å‚æ•°ã€æ”¶é›†ç®—æ³•ã€stop the worldã€å¯¹è±¡åˆ†é…è§„åˆ™ã€å›æ”¶ç­–ç•¥ç­‰éƒ½ä¸Serialæ”¶é›†å™¨ä¸€æ · Serveræ¨¡å¼ä¸‹çš„çš„é¦–é€‰æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œå¯ä»¥å’ŒCMSé…åˆå·¥ä½œ æ•ˆæœä¸ä¸€å®šè¶…è¿‡Serialï¼Œä½†éšç€CPUæ•°é‡çš„å¢åŠ ï¼Œä»–å¯¹äºGCæ˜¯ç³»ç»Ÿèµ„æºçš„æœ‰æ•ˆåˆ©ç”¨è¿˜æ˜¯å¾ˆæœ‰å¥½å¤„çš„ã€‚ 3. Parallel Scavengeæ”¶é›†å™¨Parallel Scavengeæ˜¯ä¸€ä¸ªæ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œä¹Ÿä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¹¶è¡Œçš„å¤šçº¿ç¨‹æ”¶é›†å™¨ã€‚Parallel Scavengeçš„ç›®æ ‡æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ ååé‡ = è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ / ï¼ˆè¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ + åƒåœ¾æ”¶é›†æ—¶é—´ï¼‰ è™šæ‹Ÿæœºæ€»å…±è¿è¡Œäº†100åˆ†é’Ÿï¼Œå…¶ä¸­åƒåœ¾æ‰‹æœºèŠ±æ‰1åˆ†é’Ÿï¼Œååé‡å°±99% Parallel Scavengeç”¨äº†ä¸¤ä¸ªå‚æ•°ç”¨äºç²¾ç¡®æ§åˆ¶ååé‡ï¼Œåˆ†åˆ«æ˜¯æ§åˆ¶æœ€å¤§åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´ï¼ˆ-XX:MaxGCPauseMillisï¼‰å’Œç›´æ¥è®¾ç½®ååé‡å¤§å°ï¼ˆGCTimeRatioï¼‰çš„å‚æ•° MaxGCPauseMilliså‚æ•°å…è®¸çš„å€¼æ˜¯ä¸€ä¸ªå¤§äº0çš„æ¯«ç§’æ•°ï¼Œæ”¶é›†å™¨å°½å¯èƒ½åœ°ä¿è¯å†…å­˜å›æ”¶èŠ±è´¹æ—¶é—´ä¸è¶…è¿‡è®¾å®šå€¼ã€‚ è‹¥å‚æ•°å¤ªå°ï¼ŒGCåœé¡¿æ—¶é—´æ˜¯ä»¥ç‰ºç‰²ååé‡å’Œæ–°ç”Ÿä»£ç©ºé—´æ¥æ¢å–ã€‚æŠŠæ–°ç”Ÿä»£è°ƒå°ï¼Œæ”¶é›†é€Ÿåº¦å˜å¿«ï¼Œä½†GCä¼šæ›´é¢‘ç¹ï¼Œååé‡å°±ä¸‹é™äº†ã€‚ GCTimeRatioæ˜¯ä¸€ä¸ª[0,100]çš„æ•´æ•°ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ç‡ï¼Œç›¸å½“äºååé‡çš„å€’æ•°ã€‚ å¦‚æœæŠŠå‚æ•°è®¾ç½®ä¸º19ï¼Œ åˆ™å…è®¸çš„æœ€å¤§GCæ—¶é—´å°±å æ€»æ—¶é—´çš„5%5ï¼ˆå³1/ï¼ˆ1+19 ï¼‰ï¼‰ ç”±äºå’Œååé‡å…³ç³»å¯†åˆ‡ï¼ŒParallel Scavengeä¹Ÿè¢«ç§°ä¸ºâ€œååé‡ä¼˜å…ˆâ€æ”¶é›†å™¨ Parallel Scavengeè¿˜æœ‰ä¸€ä¸ªå‚æ•° -XX:+UseAdaptiveSizePolicy,è¿™æ˜¯ä¸ªå¼€å…³å‚æ•°ï¼Œå½“å¼€å…³æ‰“å¼€åï¼Œå°±ä¸éœ€è¦æ‰‹å·¥æŒ‡å®šï¼šæ–°ç”Ÿä»£çš„å¤§å°ï¼ˆ-Xmnï¼‰ã€Edenä¸Survivorçš„æ¯”ä¾‹ï¼ˆ-XX:SurvivorRatioï¼‰ã€æ™‹å‡è€å¹´ä»£å¯¹è±¡å¤§å°ï¼ˆ-XX:PretenureSizeThresholdï¼‰ç­‰ç»†èŠ‚å‚æ•°äº†ã€‚è™šæ‹Ÿæœºä¼šæ ¹æ®å½“å‰ç³»ç»Ÿæƒ…å†µæ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯ï¼ŒåŠ¨æ€è°ƒæ•´è¿™äº›å‚æ•°ä»¥è¾¾åˆ°æœ€åˆé€‚çš„åœé¡¿æ—¶é—´æˆ–ååé‡ï¼Œè¿™å«GCè‡ªé€‚åº”çš„è°ƒèŠ‚ç­–ç•¥ï¼ˆGC Ergonomicsï¼‰ å¦‚æœç”¨æˆ·å¯¹æ”¶é›†å™¨è¿ä½œä¸äº†è§£ï¼Œå¯ä»¥å°†ä¼˜åŒ–ä»»åŠ¡äº¤ç»™è™šæ‹Ÿæœºï¼Œåªè¦è®¾ç½®å¥½åŸºæœ¬å‚æ•°ï¼ˆå¦‚æœ€å¤§å †ï¼‰ï¼Œç„¶åä½¿ç”¨æ§åˆ¶æœ€å¤§åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´ï¼ˆ-XX:MaxGCPauseMillisï¼‰å’Œç›´æ¥è®¾ç½®ååé‡å¤§å°ï¼ˆGCTimeRatioï¼‰ç»™è™šæ‹Ÿæœºè®¾å®šä¸€ä¸ªä¼˜åŒ–ç›®æ ‡ è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ä¹Ÿæ˜¯Parallel Scavengeå’ŒParNewçš„é‡è¦åŒºåˆ« 4. Serial Oldæ”¶é›†å™¨Serial Oldæ˜¯Serialçš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œä¸»è¦ä¹Ÿæ˜¯ç»™Clientæ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºä½¿ç”¨ã€‚å¦‚æœåœ¨Server æ¨¡å¼ä¸‹ï¼Œè¿˜æœ‰ä¸¤å¤§ç”¨é€”ï¼š ä¸€ç§æ˜¯åœ¨jdk1.5åŠä»¥å‰ç‰ˆæœ¬ä¸­ä¸Parallel Scavengeæ”¶é›†å™¨æ­é…ä½¿ç”¨ ä¸€ç§æ˜¯ä½œä¸ºCMSçš„åå¤‡é¢„æ¡ˆï¼Œåœ¨å¹¶å‘æ”¶é›†å‘ç”ŸConcurrent Mode Failureæ—¶ä½¿ç”¨ 5. Parallel Old æ”¶é›†å™¨Parallel Old æ˜¯Parallel Scavengeçš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œjdk1.6ä¹‹åæ‰æä¾›ï¼Œè§£å†³åœ¨serverç«¯Serial Oldæ€§èƒ½ä¸Šçš„æ‹–ç´¯ï¼Œè‹¥ä½¿ç”¨Serial Old + Parallel Scavengeï¼Œè¿™ç§ç»„åˆçš„ååé‡ä¸ä¸€å®šæœ‰ ParNew + CMSçš„ç»„åˆç»™åŠ› æ³¨é‡ååé‡å’ŒCPUèµ„æºæ•æ„Ÿçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Old + Parallel Scavengede ç»„åˆ 6. CMS æ”¶é›†å™¨CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ï¼Œåœ¨ç½‘ç«™è®¾è®¡ä¸­æ­¤æ”¶é›†å™¨å°±ç¬¦åˆéœ€æ±‚ã€‚ è¿ä½œè¿‡ç¨‹ï¼š åˆå§‹æ ‡è®° å¹¶å‘æ ‡è®° é‡æ–°æ ‡è®° å¹¶å‘æ¸…é™¤ å…¶ä¸­åˆå§‹æ ‡è®°å’Œé‡æ–°æ ‡è®°è¿™ä¸¤ä¸ªæ­¥éª¤ä»ç„¶éœ€è¦â€œStop The Worldâ€ï¼Œåˆå§‹æ ‡è®°åªæ˜¯æ ‡è®°GC Rootsèƒ½ç›´æ¥å…³è”çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«å¹¶å‘æ ‡è®°è¿›è¡ŒGC Roots Tracing çš„è¿‡ç¨‹ï¼Œè€Œé‡æ–°æ ‡è®°é˜¶æ®µæ˜¯ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´äº§ç”Ÿå˜åŠ¨çš„æ ‡è®°ï¼Œåœé¡¿&gt;åˆå§‹æ ‡è®°ï¼Œ&lt;&lt;å¹¶å‘æ ‡è®° ç¼ºç‚¹ï¼š å¹¶å‘é˜¶æ®µï¼Œä¸ä¼šå¯¼è‡´ç”¨æˆ·çº¿ç¨‹åœé¡¿ï¼Œä½†ä¼šå ç”¨CPU èµ„æºå¯¼è‡´åº”ç”¨å˜æ…¢ï¼Œæ€»ååé‡é™ä½ã€‚ä¸ºäº†åº”ä»˜è¿™ç§æƒ…å†µï¼Œè™šæ‹Ÿæœºæä¾›äº†ä¸€ç§â€œå¢é‡å¼å¹¶å‘æ”¶é›†å™¨â€çš„CMSå˜ç§ï¼Œå°±æ˜¯åœ¨å¹¶å‘æ ‡è®°ã€æ¸…ç†çš„æ—¶å€™è®©GCçº¿ç¨‹ã€ç”¨æˆ·çº¿ç¨‹äº¤æ›¿è¿è¡Œï¼Œå°½é‡å‡å°‘GCçº¿ç¨‹ç‹¬å èµ„æºçš„æ—¶é—´ï¼Œè¿™æ ·æ•´ä¸ªGCæ”¶é›†æ—¶é—´ä¼šå˜é•¿ï¼Œä½†å¯¹ç¨‹åºçš„å½±å“å°±ä¼šå˜å°ä¸€äº›ã€‚ï¼ˆäº‹å®è¯æ˜ï¼Œæ•ˆæœä¸€èˆ¬ï¼Œä¸æ¨èä½¿ç”¨ï¼‰ CMSæ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ï¼ˆFloating Garbageï¼‰ï¼Œå¯èƒ½å‡ºç°Concurrent Mode Failureå¤±è´¥å¯¼è‡´å¦ä¸€æ¬¡Full GCçš„äº§ç”Ÿ åŸºäºâ€œæ ‡è®°-æ¸…é™¤â€ï¼Œäº§ç”Ÿè¿‡å¤šç¢ç‰‡ã€‚è®¾è®¡è€…è®¾ç½®äº†ä¸€ä¸ªå‚æ•°ï¼ˆé»˜è®¤å€¼ä¸º0ï¼‰ï¼Œç”¨äºè®¾ç½®æ‰§è¡Œå¤šå°‘æ¬¡ä¸å‹ç¼©çš„Full GC ä¹‹åæ¥ä¸€æ¬¡å‹ç¼©çš„ï¼ 7. G1æ”¶é›†å™¨â€”â€”æœ€å‰æ²¿çš„æˆæœä¹‹ä¸€ G1æ”¶é›†å™¨å·²åœ¨JDK 1.7 u4ç‰ˆæœ¬æ­£å¼æŠ•å…¥ä½¿ç”¨ã€‚ ä¸å…¶ä»–GCæ”¶é›†å™¨ç›¸æ¯”ï¼Œç‰¹ç‚¹ï¼š å¹¶è¡Œä¸å¹¶å‘ï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸ç¯å¢ƒï¼Œé€šè¿‡å¹¶å‘çš„æ–¹å¼åœ¨GCè¿‡ç¨‹ä¸­è®©javaç¨‹åºç»§ç»­è¿è¡Œï¼Œç¼©çŸ­Stop-The-Worldçš„æ—¶é—´ åˆ†ä»£æ”¶é›†ï¼š ç©ºé—´æ•´åˆï¼šä¸ä¼šäº§ç”Ÿç©ºé—´ç¢ç‰‡ å¯é¢„æµ‹çš„åœé¡¿ï¼šç›¸å¯¹äºCMSçš„å¦ä¸€å¤§ä¼˜åŠ¿ï¼Œå»ºç«‹å¯é¢„æµ‹çš„æ¨¡å‹ï¼Œä½¿ç”¨è€…æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªMç§’æ—¶é—´æ®µå†…GCæ—¶é—´ä¸èƒ½è¶…è¿‡Nç§’ åœ¨ä½¿ç”¨G1æ”¶é›†å™¨çš„æ—¶å€™ï¼Œjavaå †å†…å­˜å°±å’Œå…¶ä»–æ”¶é›†å™¨æœ‰å¾ˆå¤§çš„å·®åˆ«ã€‚å®ƒå°†å†…å­˜åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼Œè™½æœ‰è€å¹´ä»£å’Œæ–°ç”Ÿä»£ï¼Œä½†æ–°è€ä¸éš”ç¦»ï¼Œéƒ½æ˜¯Regionçš„ä¸€éƒ¨åˆ†é›†åˆå»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼šä¸ç”¨å†å †ä¸­å…¨åŒºåŸŸæ”¶é›†ã€‚ G1æ”¶é›†å™¨ä¼°è®¡æ‰€æœ‰regionçš„ä»·å€¼å¤§å°ï¼Œå»ºç«‹ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œå¤§çš„å…ˆæ”¶é›†ï¼Œæ‰€ä»¥å«â€œGarbage-Firstâ€ é™¤å»ç»´æŠ¤Remembered Set çš„æ“ä½œï¼ŒG1æ”¶é›†å™¨çš„è¿ä½œå¤§è‡´å¯ä»¥åˆ†ä¸º åˆå§‹æ ‡è®° å¹¶å‘æ ‡è®° æœ€ç»ˆæ ‡è®° ç­›é€‰å›æ”¶","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"GC","slug":"GC","permalink":"https://htchz.cc/tags/GC/"},{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}],"author":"åœŸå·"},{"title":"[JVM]å¯¹è±¡çš„åˆ†é…å›æ”¶ç­–ç•¥","slug":"JVM-å¯¹è±¡çš„åˆ†é…å›æ”¶ç­–ç•¥","date":"2018-03-29T08:10:00.000Z","updated":"2020-03-17T06:21:13.111Z","comments":true,"path":"476673891.html","link":"","permalink":"https://htchz.cc/476673891.html","excerpt":"ä¸€ä¸ªå¯¹è±¡è¢«newå‡ºæ¥åˆ†é…åœ¨å“ªå‘¢ã€‚ä¸€ä¸ªå¯¹è±¡çš„åˆ†é…ï¼Œå¾€å¤§æ–¹å‘ä¸Šè®²ï¼Œå°±æ˜¯åœ¨å †åˆ†é…","text":"ä¸€ä¸ªå¯¹è±¡è¢«newå‡ºæ¥åˆ†é…åœ¨å“ªå‘¢ã€‚ä¸€ä¸ªå¯¹è±¡çš„åˆ†é…ï¼Œå¾€å¤§æ–¹å‘ä¸Šè®²ï¼Œå°±æ˜¯åœ¨å †åˆ†é… å†…å­˜åˆ†é…è§„åˆ™ä¸æ˜¯å›ºå®šçš„ï¼Œå–å†³äºè™šæ‹Ÿæœºå‚æ•°ã€GCç»„åˆç±»å‹ 1. å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…å¤§å¤šæ•°æƒ…å†µä¸‹å¯¹è±¡å†æ–°ç”Ÿä»£EdenåŒºä¸­åˆ†é…ï¼Œå½“æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡Minor GCã€‚ 2. å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£æ‰€è°“çš„å¤§å¯¹è±¡å°±æ˜¯æŒ‡éœ€è¦è¿ç»­ç©ºé—´çš„javaå¯¹è±¡ï¼Œæœ€å…¸å‹çš„æ˜¯æ•°ç»„å’Œå­—ç¬¦ä¸²ã€‚ï¼ˆåº”é¿å…çŸ­å‘½å¤§å¯¹è±¡ï¼‰ 3. é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£æ¯ä¸ªå¯¹è±¡æœ‰å¯¹è±¡å¹´é¾„ï¼ˆAgeï¼‰è®¡æ•°å™¨ã€‚æ¯æ¬¡åœ¨minor GCåä»å­˜åœ¨ä¸”èƒ½è¢«survivoråŒºå®¹çº³çš„è¯ï¼Œå¹´é¾„å°±+1ï¼ˆåˆå§‹ä¸º0ï¼‰ï¼Œè¾¾åˆ°ä¸€ä¸ªé˜ˆå€¼ï¼ˆé»˜è®¤15ï¼‰ï¼Œå°±æ™‹å‡åˆ°è€å¹´ä»£ä¸­ 4. åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š å¹¶ä¸æ˜¯å¿…é¡»è¾¾åˆ°å¹´é¾„æ‰å¯ä»¥æ™‹å‡è€å¹´ä»£ å¦‚æœåœ¨Survivorç©ºé—´ä¸­ï¼Œç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚ 5. ç©ºé—´åˆ†é…æ‹…ä¿Minor GCä¹‹å‰ï¼Œå¦‚æœè€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡æ€»ç©ºé—´ï¼Œåˆ™GCå®‰å…¨ã€‚å¦åˆ™ï¼Œæ£€æŸ¥æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥ï¼ˆHandlePromotionFailureçš„å€¼ï¼‰ã€‚å¦‚æœå…è®¸ï¼Œåˆ™ç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹³å‡å¤§å°ã€‚å¦‚æœå¤§äºï¼Œåˆ™å°è¯•Minor GCã€‚å¦‚æœå°äºæˆ–è€…ä¸å…è®¸ï¼Œåˆ™æ”¹ä¸ºFull GC jdk 6u24 ä¹‹åï¼ŒHandlePromotionFailureå·²ç»ä¸å½±å“åˆ†é…æ‹…ä¿ç­–ç•¥äº†ã€‚å¦‚æœè€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡æ€»ç©ºé—´ï¼Œæˆ–è€…å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹³å‡å¤§å°ï¼Œåˆ™è¿›è¡ŒMinor GCï¼Œå¦åˆ™Full GCã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"GC","slug":"GC","permalink":"https://htchz.cc/tags/GC/"},{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}],"author":"åœŸå·"},{"title":"[JVM]HotSpotç®—æ³•çš„å®ç°","slug":"JVM-HotSpotç®—æ³•çš„å®ç°","date":"2018-03-29T07:59:00.000Z","updated":"2020-03-17T06:21:41.100Z","comments":true,"path":"1666990746.html","link":"","permalink":"https://htchz.cc/1666990746.html","excerpt":"ä»€ä¹ˆæ—¶æœºé€‚åˆè¿›è¡ŒGC","text":"ä»€ä¹ˆæ—¶æœºé€‚åˆè¿›è¡ŒGC HotSpotè™šæ‹Ÿæœºå®ç°è¿™äº›ç®—æ³•çš„æ—¶å€™ï¼Œå¿…é¡»å¯¹ç®—æ³•çš„æ‰§è¡Œæ•ˆç‡æœ‰ä¸¥æ ¼çš„è€ƒé‡ï¼Œæ‰èƒ½ä¿è¯è™šæ‹Ÿæœºçš„é«˜æ•ˆæ‰§è¡Œã€‚ 1. æšä¸¾æ ¹èŠ‚ç‚¹ä»GC Roots èŠ‚ç‚¹æ‰¾å¼•ç”¨é“¾è¿™ä¸ªæ“ä½œï¼Œä»…æ–¹æ³•åŒºå°±æœ‰æœ‰å‡ ç™¾å…†ï¼Œè‹¥é€ä¸ªæ£€æŸ¥ï¼Œå¿…å®šæ¶ˆè€—å¾ˆå¤šæ—¶é—´è€Œä¸”ï¼Œåœ¨æ£€æŸ¥çš„æ—¶å€™å¿…é¡» stop the world åœé¡¿ä¸€ä¸‹ï¼Œ å³ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œä¸èƒ½åœ¨åˆ†æçš„æ—¶å€™å¼•ç”¨é“¾è¿˜åœ¨å˜åŒ– HotSpotçš„å®ç°æ˜¯ä½¿ç”¨ä¸€ç»„OopMapçš„æ•°æ®ç»“æ„æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„çš„ã€‚åœ¨ç±»åŠ è½½å®Œæˆçš„æ—¶å€™ï¼ŒHotSpotå°±æŠŠå¯¹è±¡å†…ä»€ä¹ˆåç§»é‡ä¸Šçš„ä»€ä¹ˆç±»å‹çš„æ•°æ®è®¡ç®—å‡ºæ¥ã€‚åœ¨JITç¼–è¯‘ä¸­ï¼Œä¹Ÿä¼šåœ¨ç‰¹å®šçš„ä½ç½®è®°å½•ä¸‹æ ˆå’Œå¯„å­˜å™¨ã€‚è¿™æ ·GCåœ¨æ‰«æçš„æ—¶å€™å°±å¯ä»¥é€šè¿‡è®°å½•ä¸­çš„æŒ‡ä»¤ç›´æ¥å¾—åˆ°å¼•ç”¨çš„ä½ç½®ä¿¡æ¯ã€‚ 2. å®‰å…¨ç‚¹ï¼ˆSafe Pointï¼‰å‰é¢æåˆ°ï¼ŒOopMapæ˜¯åœ¨ç‰¹å®šçš„ä½ç½®è®°å½•äº†æŒ‡ä»¤ä¿¡æ¯ï¼Œè¿™äº›ä½ç½®ç§°ä¸ºå®‰å…¨ç‚¹ã€‚åªæœ‰åˆ°è¾¾å®‰å…¨ç‚¹çš„æ—¶å€™ï¼Œæ‰èƒ½è¿›è¡ŒGCã€‚å®‰å…¨ç‚¹ä¸èƒ½é€‰æ‹©å¤ªå°‘ä»¥è‡³äºè®©GCç­‰å¾…æ—¶é—´å¤ªé•¿ï¼Œä¸åˆèƒ½è¿‡äºé¢‘ç¹ä»¥è‡³äºå¢å¤§è¿è¡Œæ—¶è´Ÿè·ã€‚ å®‰å…¨ç‚¹çš„é€‰å®šæ˜¯ä»¥ç¨‹åºâ€œæ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾â€ä¸ºæ ‡å‡†è¿›è¡Œé€‰å®šçš„ï¼ˆä¹‹æ‰€ä»¥ä¸ä»¥æŒ‡ä»¤æµçš„é•¿åº¦ä¸ºæ ‡å‡†ï¼Œå› ä¸ºæŒ‡ä»¤æ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼‰ï¼Œé•¿æ—¶é—´æ‰§è¡Œçš„æœ€æ˜æ˜¾ç‰¹å¾å°±æ˜¯æŒ‡ä»¤åºåˆ—å¤ç”¨ï¼Œå¦‚æ–¹æ³•è°ƒç”¨ï¼Œå¾ªç¯è·³è½¬ï¼Œå¼‚å¸¸è·³è½¬ç­‰ GCå‘ç”Ÿæ—¶å¦‚ä½•è®©æ‰€æœ‰çº¿ç¨‹éƒ½è·‘åˆ°æœ€è¿‘çš„å®‰å…¨ç‚¹åœé¡¿ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼šæŠ¢å…ˆå¼ä¸­æ–­ï¼ˆPreemptive Suspensionï¼‰å’Œä¸»åŠ¨å¼ä¸­æ–­ï¼ˆVoluntary Suspensionï¼‰ æŠ¢å…ˆå¼ä¸­æ–­ï¼šGCæ—¶ä¸­æ–­æ‰€æœ‰çº¿ç¨‹ï¼Œè‹¥æŸçº¿ç¨‹ä¸­æ–­çš„åœ°æ–¹ä¸æ˜¯å®‰å…¨ç‚¹ï¼Œæ¢å¤çº¿ç¨‹ï¼Œè·‘åˆ°å®‰å…¨ç‚¹ã€‚ç°åœ¨å‡ ä¹æ²¡äººç”¨ ä¸»åŠ¨å¼ä¸­æ–­ï¼šGCéœ€è¦ä¸­æ–­æ—¶ï¼Œä¸å¯¹çº¿ç¨‹ç›´æ¥æ“ä½œï¼Œè®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼ˆä¸å®‰å…¨ç‚¹é‡åˆï¼Œå¦‚æŠŠå®‰å…¨ç‚¹çš„æŒ‡ä»¤çš„å†…å­˜é¡µè®¾ç½®ä¸ºä¸å¯è¯»ï¼Œçº¿ç¨‹ä¼šå¼‚å¸¸ä¸­æ–­å¹¶æŒ‚èµ·ï¼‰ï¼Œçº¿ç¨‹æ‰§è¡Œæ—¶è‡ªåŠ¨è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œç„¶åçº¿ç¨‹è¿è¡Œåˆ°ä¸­æ–­æ ‡å¿—çš„æ—¶å€™ä¼šè‡ªåŠ¨ä¸­æ–­å¹¶æŒ‚èµ· 3. å®‰å…¨åŒºåŸŸï¼ˆSafe Regionï¼‰è‹¥ç¨‹åºâ€ä¸æ‰§è¡Œâ€œï¼ˆå³æ²¡æœ‰åˆ†é…CPUæ—¶é—´ï¼Œå…¸å‹çš„ä¾‹å­æ˜¯çº¿ç¨‹å¤„äºâ€œSleepâ€â€œBlockedâ€çŠ¶æ€ï¼‰ï¼Œè¿™æ—¶ç¨‹åºä¸èƒ½ç»§ç»­è¿è¡Œåˆ°ä¸­æ–­æ ‡å¿—æŒ‚èµ·ï¼Œè¿™æ—¶éœ€è¦å®‰å…¨åŒºåŸŸæ¥è§£å†³ã€‚ å½“çº¿ç¨‹æ‰§è¡Œåˆ°å®‰å…¨åŒºåŸŸæ—¶ï¼Œæ ‡è¯†è‡ªå·±è¿›å…¥äº†å®‰å…¨åŒºåŸŸã€‚è‹¥å‘ç”ŸGCï¼Œå°±ä¸ç”¨ç®¡æ ‡è¯†ä¸ºå®‰å…¨åŒºåŸŸçš„çº¿ç¨‹ã€‚çº¿ç¨‹è‹¥è¦ç¦»å¼€å®‰å…¨åŒºåŸŸï¼Œå¿…é¡»æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å®Œæˆäº†æ ¹èŠ‚ç‚¹æšä¸¾ï¼ˆæˆ–è€…æ•´ä¸ªGCè¿‡ç¨‹ï¼‰ã€‚å¦‚æœå®Œæˆäº†ï¼Œå°±ç»§ç»­çº¿ç¨‹ã€‚å¦åˆ™ï¼Œç­‰å¾…ç›´åˆ°æ”¶åˆ°å¯ä»¥ç¦»å¼€å®‰å…¨åŒºåŸŸçš„ä¿¡å·ä¸ºæ­¢ã€‚","categories":[],"tags":[{"name":"GC","slug":"GC","permalink":"https://htchz.cc/tags/GC/"},{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}],"author":"åœŸå·"},{"title":"[JVM]åƒåœ¾å›æ”¶ç®—æ³•ç®€ä»‹","slug":"JVM-åƒåœ¾å›æ”¶ç®—æ³•ç®€ä»‹","date":"2018-03-27T03:08:00.000Z","updated":"2020-03-17T14:54:21.322Z","comments":true,"path":"2456754784.html","link":"","permalink":"https://htchz.cc/2456754784.html","excerpt":"è¯†åˆ«å‡ºäº†åƒåœ¾ä»¥åæ€ä¹ˆæ¸…é™¤å‘¢ã€‚","text":"è¯†åˆ«å‡ºäº†åƒåœ¾ä»¥åæ€ä¹ˆæ¸…é™¤å‘¢ã€‚ ä¸‹é¢çš„å‡ ç§åƒåœ¾å›æ”¶ç®—æ³•åœ¨ä¸åŒçš„ç©ºé—´éƒ½æœ‰ä¸åŒåº”ç”¨ã€‚ 1. æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-Sweepï¼‰æ ‡è®°å‡ºæ‰€æœ‰è¦å›æ”¶çš„å¯¹è±¡ï¼Œç„¶åç»Ÿä¸€å›æ”¶ã€‚ä¸è¶³ï¼š æ•ˆç‡ä½ä¸‹ ç©ºé—´ç¢ç‰‡å¤ªå¤šï¼ˆå¯¼è‡´åˆ†é…å¤§å¯¹è±¡æ²¡æœ‰è¿ç»­ç©ºé—´ï¼Œä¸å¾—ä¸è§¦å‘å¦ä¸€æ¬¡åƒåœ¾æ”¶é›†åŠ¨ä½œï¼‰ 2. å¤åˆ¶ç®—æ³•åŸºäºå‰é¢çš„ç®—æ³•ï¼ŒæŠŠå†…å­˜æŒ‰å®¹é‡åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œåœ¨gcå®Œæˆåå°†å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€éƒ¨åˆ†å†…å­˜ï¼Œæ¸…é™¤ç¬¬ä¸€éƒ¨åˆ†çš„å†…å­˜ã€‚ ä½†æ˜¯æŒ‰ç…§æŠŠå†…å­˜åˆ’åˆ†ä¸ºä¸¤åŠï¼Œå¯ç”¨å†…å­˜å°±ç¼©å°ä¸ºä¸€åŠï¼Œä»£ä»·çœŸä»–å¦ˆé«˜ äºæ˜¯ç°ä»£çš„å•†ä¸šè™šæ‹Ÿæœºéƒ½æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œä½†ä¸æ˜¯1ï¼š1åˆ†é…å†…å­˜è€Œæ˜¯åˆ†ä¸ºä¸€å—è¾ƒå¤§çš„Edenå’Œä¸¤å—è¾ƒå°çš„Survivor(ä¸€èˆ¬æ¥è¯´æ˜¯8ï¼š1ï¼š1)ã€‚å½“å›æ”¶æ—¶ï¼Œå°†Edenå’ŒSurvivorä¸­çš„å­˜æ´»å¯¹è±¡ä¸€æ¬¡æ€§åœ°å¤åˆ¶åˆ°å¦å¤–ä¸€å—Survivorç©ºé—´ä¸Šï¼Œæ¸…ç†æ‰åŸæ¥çš„Edenå’ŒSurvivorä¸­çš„ç©ºé—´ 2.1. ä¸ºä»€ä¹ˆè¦æœ‰ä¸¤å—Survivorå‡è®¾æœ‰survivor1å’Œsurvivor2ï¼Œé‚£ä¹ˆedenå’Œsurvivor1è¿›è¡Œminor gcåä¸€èˆ¬survivor1ä¼šæœ‰å†…å­˜ç¢ç‰‡ï¼Œè¿™æ—¶å€™æŠŠå­˜æ´»å¯¹è±¡æ”¾è¿›ç©ºçš„survivor2ï¼Œæ¸…ç©ºsurvivor1ï¼Œå°±èƒ½è§£å†³å†…å­˜ç¢ç‰‡åŒ–é—®é¢˜ã€‚ 2.2. ä¸ºä»€ä¹ˆä¸è®¾å¤šç‚¹survivorä¸¤å—å¤Ÿäº†ã€‚ã€‚ å¦‚æœç©ºé—´ä¸è¶³ï¼Œåˆ™ä½¿ç”¨åˆ†é…æ‹…ä¿æœºåˆ¶æ¥ç”³è¯·å†…å­˜ 3. æ ‡è®°-æ•´ç†ç®—æ³•å¤åˆ¶æ”¶é›†ç®—æ³•åœ¨å¯¹è±¡å­˜æ´»ç‡è¾ƒé«˜æ—¶å°±è¦è¿›è¡Œè¾ƒå¤šçš„å¤åˆ¶æ“ä½œï¼Œæ•ˆç‡å˜ä½ã€‚æ ‡è®°-æ•´ç†ç®—æ³•åœ¨æ ‡è®°ä¹‹åï¼Œå°†å­˜æ´»å¯¹è±¡éƒ½å¾€ä¸€ç«¯ç§»åŠ¨ï¼Œæœ€åç›´æ¥æ¸…ç†ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚ 4. åˆ†ä»£æ”¶é›†ç®—æ³•å°†å†…å­˜åˆ†ä¸ºâ€œæ–°ç”Ÿä»£â€â€œè€å¹´ä»£â€ï¼Œæ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ã€‚è€å¹´ä»£æ˜¯ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•ã€æ ‡è®°-æ•´ç†ç®—æ³•ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"GC","slug":"GC","permalink":"https://htchz.cc/tags/GC/"},{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}],"author":"åœŸå·"},{"title":"[JVM]åˆ¤æ–­å¯¹è±¡å·²æ­»ï¼ˆå«GC ROOTï¼‰","slug":"JVM-åˆ¤æ–­å¯¹è±¡å·²æ­»","date":"2018-03-26T18:17:00.000Z","updated":"2020-06-04T10:09:31.123Z","comments":true,"path":"2872318404.html","link":"","permalink":"https://htchz.cc/2872318404.html","excerpt":"","text":"çœ‹è¿‡ã€Šæ·±å…¥javaè™šæ‹Ÿæœºã€‹ï¼Œé‡Œé¢å¯¹GCçš„è®²è§£çœ‹å®Œæœ‰ä¸ªå¤§æ¦‚äº†è§£ã€‚äºæ˜¯è‡ªå·±æ€»ç»“ä¸€ä¸‹ã€‚ æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡å·²æ­»ï¼Œæ˜¯GCçš„ç¬¬ä¸€æ­¥ã€‚ 1. å¼•ç”¨è®¡æ•°æ³•å¼•ç”¨è®¡æ•°æ³•å°±æ˜¯å½“å¯¹è±¡çš„å¼•ç”¨ä¸º0æ—¶ï¼Œæ‰è¿›è¡ŒGCã€‚äº‹å®ä¸Šè¿™æ˜¯ä¸å¯è¡Œçš„ã€‚çœ‹ä¸‹é¢çš„ç¤ºä¾‹ã€‚ å¯¹è±¡aå’Œbéƒ½æœ‰ä¸€ä¸ªinstanceå­—æ®µï¼Œå¦‚æœæ‰§è¡Œa.instance = b;b.instance = a;a = null;b = null; ä¸Šé¢çš„ä¸¤ä¸ªå¯¹è±¡ç›¸äº’å¼•ç”¨ç€ï¼Œå¼•ç”¨æ•°éƒ½ä¸º1ï¼Œä½†æ˜¯aå’ŒbæŒ‡çš„å¯¹è±¡éƒ½ä¸èƒ½å†è¢«è®¿é—®ï¼Œç†è®ºä¸Šåœ¨å†…å­˜ä¸­æ˜¯åƒåœ¾ï¼Œä½†ä¸¤ä¸ªå¯¹è±¡æ— æ³•è¢«gcå›æ”¶ã€‚ 2. å¯è¾¾æ€§åˆ†æç®—æ³•æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡å¯è¾¾æ€§åˆ†æç®—æ³•æ¥ç¡®è®¤å¯¹è±¡çš„å­˜æ´»ã€‚ é€šè¿‡ä¸€ç³»åˆ—çš„æˆä¸ºGC Rootsçš„å¼•ç”¨ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼ˆReference Chainï¼‰ å½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œè¯æ˜æ­¤å¯¹è±¡ä¸å¯ç”¨ åœ¨javaä¸­å¯ä»¥ä½œä¸ºGC Rootsçš„åŒ…æ‹¬ä¸‹é¢å‡ ç§ è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ æœ¬åœ°æ–¹æ³•ä¸­JNIå¼•ç”¨çš„å¯¹è±¡ è¢«åŠ è½½çš„ç±» Javaä¸­ä»€ä¹ˆæ ·çš„å¯¹è±¡æ‰èƒ½ä½œä¸ºgc rootï¼Œgc rootsæœ‰å“ªäº›å‘¢ï¼Ÿ 3. å†è°ˆå¼•ç”¨javaå¼•ç”¨åœ¨jdk1.2ä¹‹åè¿›è¡Œäº†æ‰©å……ï¼Œåˆ†ä¸ºå¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰ã€è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰ã€å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰ã€è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰ å¼ºå¼•ç”¨æœ€æ™®éï¼ŒGCä¸ä¼šå›æ”¶è¢«å¼•ç”¨çš„å¯¹è±¡ è½¯å¼•ç”¨ç”¨æ¥æè¿°è¿˜æœ‰ç”¨ä½†éå¿…éœ€çš„å¯¹è±¡ï¼Œè¦å‘ç”ŸOOMæ—¶è¿›è¡Œæ¸…ç† å¼±å¼•ç”¨ç”¨æ¥æè¿°éå¿…éœ€çš„ï¼Œåªèƒ½ç”Ÿå­˜åˆ°ä¸‹æ¬¡GCæ”¶é›†ä¹‹å‰ã€‚å¦‚æœæ²¡æœ‰å¼ºå¼•ç”¨å¼•ç”¨ç€è¿™ä¸ªå¼±å¼•ç”¨å¯¹è±¡ï¼Œå°±å¯ä»¥åœ¨GCå›æ”¶æ‰ã€‚ è™šå¼•ç”¨ä¹Ÿç§°ä¸ºå¹½çµå¼•ç”¨å’Œå¹»å½±å¼•ç”¨ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨çš„å”¯ä¸€ç›®çš„ï¼šåœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ 4. ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡ä¸€ä¸ªå¯¹è±¡è¿›è¡Œå¯è¾¾æ€§åˆ†æç®—æ³•åå¦‚ä¸å¯è¾¾ï¼Œä¹Ÿåªæ˜¯è¿›å…¥ç¼“åˆ‘ã€‚çœŸæ­£å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œè¦ç»å†ä¸¤æ¬¡æ ‡è®°ï¼š æ²¡æœ‰å’ŒGC Rootsç›¸è¿æ¥ï¼Œæ²¡æœ‰åˆ™ç¬¬ä¸€æ¬¡æ ‡è®° è¢«ç¬¬ä¸€æ¬¡æ ‡è®°è¿‡çš„å¯¹è±¡è¿›è¡Œç­›é€‰ï¼Œè‹¥æœªé‡å†™finalize()æ–¹æ³•æˆ–å¯¹è±¡è¢«æ‰§è¡Œè¿‡ä¸€æ¬¡finalize()ï¼Œåˆ™æ²¡å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ï¼Œæ­»åˆ‘ è‹¥å¯¹è±¡æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ï¼Œåˆ™å¯¹è±¡ä¼šè¢«æ”¾åœ¨ä¸€ä¸ªF-Queueä¸­ï¼Œå¹¶ç¨åæœ‰è™šæ‹Ÿæœºåˆ›å»ºçš„ä¸€ä¸ªä½ä¼˜å…ˆçº§çš„çº¿ç¨‹å»è§¦å‘æ–¹æ³•ã€‚ å¯¹è±¡å¯ä»¥åœ¨finalize()æ–¹æ³•ä¸­è‡ªæ•‘ï¼Œæ¯”å¦‚æŠŠè‡ªå·±thisèµ‹å€¼ç»™æŸä¸ªå˜é‡ å°½é‡åˆ«ä½¿ç”¨è¿™ä¸ªè¿è¡Œä»£ä»·é«˜æ˜‚çš„æ–¹æ³•finalize() 5. å›æ”¶æ–¹æ³•åŒºæ­¤å¤„å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼š åºŸå¼ƒå¸¸é‡å’Œæ— ç”¨çš„ç±» å›æ”¶åºŸå¼ƒå¸¸é‡å’Œå›æ”¶javaå †ä¸­çš„å¯¹è±¡å¾ˆç›¸ä¼¼ï¼šå‡å¦‚ä¸€ä¸ªå­—ç¬¦ä¸²â€œabcâ€è¢«æ”¾è¿›å¸¸é‡æ± ï¼Œä½†ç³»ç»Ÿæ²¡æœ‰ä¸€ä¸ªstringå¯¹è±¡æ˜¯â€œabcâ€çš„ï¼Œé‚£ä¹ˆå†…å­˜å›æ”¶æ—¶ï¼Œâ€œabcâ€ä¼šè¢«æ¸…ç† åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦æ˜¯æ— ç”¨çš„ç±»æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œéœ€æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªï¼š è¯¥ç±»æ‰€æœ‰å®ä¾‹è¢«å›æ”¶ åŠ è½½è¯¥ç±»çš„ClassLoaderå·²ç»è¢«å›æ”¶ å¯¹åº”çš„java.lang.Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•é€šè¿‡åå°„è®¿é—®è¯¥æ–¹æ³• æ»¡è¶³ä»¥ä¸Šä¸‰ä¸ªæ‰â€œå¯ä»¥â€ï¼ˆä¸æ˜¯å¿…ç„¶ï¼‰è¢«å›æ”¶ã€‚è™šæ‹Ÿæœºæä¾›äº†ä¸€äº›å‚æ•°è¿›è¡Œå›æ”¶ åœ¨å¤§é‡ä½¿ç”¨åå°„çš„æ¡†æ¶ã€åŠ¨æ€ä»£ç†çš„æ¡†æ¶ã€jspç­‰é¢‘ç¹è‡ªå®šä¹‰ClassLoaderçš„åœºæ™¯éƒ½éœ€è¦å…·å¤‡ç±»å¸è½½åŠŸèƒ½","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"GC","slug":"GC","permalink":"https://htchz.cc/tags/GC/"},{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}],"author":"åœŸå·"},{"title":"[å»ºç«™]Linodeå¼€å¯Google BBRçš„æ­£ç¡®æ–¹æ³•","slug":"å»ºç«™-Linodeå¼€å¯Google-BBRçš„æ­£ç¡®æ–¹æ³•","date":"2018-03-26T15:55:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"1807419896.html","link":"","permalink":"https://htchz.cc/1807419896.html","excerpt":"åœ¨linodeä¸€ç›´å¼€å¯ä¸äº†bbråŠ é€Ÿï¼Œåœ¨ä¸€ä¸ªè€å“¥çš„åšå®¢çœ‹åˆ°è¿™ä¸ªä¼ é€é—¨","text":"åœ¨linodeä¸€ç›´å¼€å¯ä¸äº†bbråŠ é€Ÿï¼Œåœ¨ä¸€ä¸ªè€å“¥çš„åšå®¢çœ‹åˆ°è¿™ä¸ªä¼ é€é—¨ ç®€å•æ¥è¯´ï¼ŒLinodeæœåŠ¡å™¨çš„å†…æ ¸æ˜¯è¦åœ¨é…ç½®é¡µé¢ä¿®æ”¹æ‰èƒ½æ­£ç¡®å¼•å¯¼çš„ï¼Œè€Œä¸”4.9.0ä»¥ä¸Šçš„liuxå†…æ ¸éƒ½ç¼–è¯‘äº†tcp_bbråŠ é€Ÿæ¨¡å—ï¼Œæ‰€ä»¥ä¸ç”¨è‡ªå·±é…ç½®äº†ã€‚ è¿˜æœ‰ä¸€ç‚¹ï¼Œlsmodæ‰¾ä¸åˆ°tcp_bbrï¼Œåšä¸»è¯´æœ‰ä¸€ç§è¯´æ³•æ˜¯ï¼ŒLinodeè‡ªå¸¦çš„å†…æ ¸éƒ½æ˜¯æŠŠæ¨¡å—éƒ½ç¼–è¯‘ä¸€å—çš„ï¼Œæ‰€ä»¥lsmodé‡Œçœ‹ä¸åˆ°æ­£å¸¸ï¼Œlsmodæ˜¯çœ‹é¢å¤–åŠ è½½çš„æ¨¡å—çš„ã€‚ Linodeå†²5åˆ€é€20åˆ€ï¼Œå¿«å»å•Šï¼Œä¸è¿‡å¡«ä¸ªäººä¿¡æ¯å¾—å¡«ä¼˜æƒ ç å’Œå¦ä¸€ä¸ªå¿˜äº†ä»€ä¹ˆé¬¼ç ï¼Œå¦åˆ™æ²¡æœ‰20åˆ€ã€‚","categories":[{"name":"å»ºç«™","slug":"å»ºç«™","permalink":"https://htchz.cc/categories/å»ºç«™/"}],"tags":[{"name":"bbr","slug":"bbr","permalink":"https://htchz.cc/tags/bbr/"}],"author":"åœŸå·"},{"title":"[Mysql]æŸ¥è¯¢æ¡ä»¶çš„ç±»å‹å¼ºè½¬","slug":"Mysql-æŸ¥è¯¢æ¡ä»¶çš„ç±»å‹å¼ºè½¬","date":"2018-03-23T08:44:00.000Z","updated":"2020-04-25T16:11:44.442Z","comments":true,"path":"3095735483.html","link":"","permalink":"https://htchz.cc/3095735483.html","excerpt":"ç½‘ä¸Šçœ‹åˆ°çš„ç±»å‹å¼ºè½¬çš„å¼•èµ·äº†æ…¢æŸ¥è¯¢ï¼Œè‡ªå·±å»ºè¡¨è¯•äº†ä¸€ä¸‹æœçœŸå¦‚æ­¤ã€‚","text":"ç½‘ä¸Šçœ‹åˆ°çš„ç±»å‹å¼ºè½¬çš„å¼•èµ·äº†æ…¢æŸ¥è¯¢ï¼Œè‡ªå·±å»ºè¡¨è¯•äº†ä¸€ä¸‹æœçœŸå¦‚æ­¤ã€‚ 1. å»ºè¡¨CREATE TABLE `users` ( `userID` int(11) NOT NULL AUTO_INCREMENT, `username` varchar(20) NOT NULL, `password` varchar(20) NOT NULL, `age` int(4) DEFAULT NULL, PRIMARY KEY (`userID`), KEY `password` (`password`), KEY `age` (`age`) USING BTREE ) ENGINE=InnoDB AUTO_INCREMENT=100003 DEFAULT CHARSET=utf8;æ’å…¥äº†10wæ¡æ•°æ® 2. æ‰§è¡Œexplainè¿™æ˜¯ç¬¬ä¸€ç§ï¼šè¿™æ˜¯ç¬¬äºŒç§ï¼š ä¸¤æ¡è¯­å¥çš„å·®åˆ«æ˜¯å¯¹äºå­—ç¬¦ç´¢å¼•ï¼ŒæŸ¥è¯¢æ¡ä»¶åŠ ä¸åŠ å¼•å·çš„åŒºåˆ« ä»ä¸Šé¢å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ç”±äºpasswordæ˜¯varcharï¼Œåœ¨whereæ¡ä»¶ä¸­ä¸åŠ â€™â€™ï¼Œä¼šå¼•å‘å…¨ç´¢å¼•æŸ¥è¯¢(type=indexæ¯”type=allè¿˜æ˜¯å¿«çš„)ï¼ŒåŠ äº†å°±å¯ä»¥ç”¨åˆ°ç´¢å¼•ï¼ˆtype=refï¼‰ï¼Œè¿™æ‰«æçš„è¡Œæ•°å¯æ˜¯å¤©å·®åœ°åˆ«ï¼Œå¯¹äºæœåŠ¡å™¨çš„å‹åŠ›å’Œå“åº”æ—¶é—´è‡ªç„¶ä¹Ÿæ˜¯å¤©å·®åœ°åˆ«çš„ã€‚ æˆ‘ä»¬çœ‹ç¬¬ä¸‰ç§ï¼š æˆ‘ä»¬çœ‹ç¬¬å››ç§ å¯¹äºæ•´å‹ï¼ŒåŠ äº†å¼•å·ä¸å¦å½±å“ä¸å¤§ï¼Œåªæ˜¯å·®åˆ«åœ¨Extraæ  rowsæœ‰5wæ˜¯å› ä¸º10wè¡Œçš„ageéƒ½æ˜¯1ã€‚ã€‚ã€‚ï¼Œå¦‚æœæ”¹ä¸ºç¦»æ•£çš„å€¼ï¼Œrowsä¼šä¸‹é™å¾ˆå¤šã€‚ ä»¥ä¸‹æ˜¯5.5å®˜æ–¹æ‰‹å†Œçš„è¯´æ˜ï¼š If both arguments in a comparison operation are strings, they are compared as strings.ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œä¼šæŒ‰ç…§å­—ç¬¦ä¸²æ¥æ¯”è¾ƒï¼Œä¸åšç±»å‹è½¬æ¢ã€‚If both arguments are integers, they are compared as integers.ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯æ•´æ•°ï¼ŒæŒ‰ç…§æ•´æ•°æ¥æ¯”è¾ƒï¼Œä¸åšç±»å‹è½¬æ¢ã€‚Hexadecimal values are treated as binary strings if not compared to a number.åå…­è¿›åˆ¶çš„å€¼å’Œéæ•°å­—åšæ¯”è¾ƒæ—¶ï¼Œä¼šè¢«å½“åšäºŒè¿›åˆ¶ä¸²ã€‚If one of the arguments is a TIMESTAMP or DATETIME column and the other argument is a constant, the constant is converted to a timestamp before the comparison is performed. This is done to be more ODBC-friendly. Note that this is not done for the arguments to IN()! To be safe, always use complete datetime, date, or time strings when doing comparisons. For example, to achieve best results when using BETWEEN with date or time values, use CAST() to explicitly convert the values to the desired data type.æœ‰ä¸€ä¸ªå‚æ•°æ˜¯ TIMESTAMP æˆ– DATETIMEï¼Œå¹¶ä¸”å¦å¤–ä¸€ä¸ªå‚æ•°æ˜¯å¸¸é‡ï¼Œå¸¸é‡ä¼šè¢«è½¬æ¢ä¸º timestampIf one of the arguments is a decimal value, comparison depends on the other argument. The arguments are compared as decimal values if the other argument is a decimal or integer value, or as floating-point values if the other argument is a floating-point value.æœ‰ä¸€ä¸ªå‚æ•°æ˜¯ decimal ç±»å‹ï¼Œå¦‚æœå¦å¤–ä¸€ä¸ªå‚æ•°æ˜¯ decimal æˆ–è€…æ•´æ•°ï¼Œä¼šå°†æ•´æ•°è½¬æ¢ä¸º decimal åè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¦å¤–ä¸€ä¸ªå‚æ•°æ˜¯æµ®ç‚¹æ•°ï¼Œåˆ™ä¼šæŠŠ decimal è½¬æ¢ä¸ºæµ®ç‚¹æ•°è¿›è¡Œæ¯”è¾ƒIn all other cases, the arguments are compared as floating-point (real) numbers.æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªå‚æ•°éƒ½ä¼šè¢«è½¬æ¢ä¸ºæµ®ç‚¹æ•°å†è¿›è¡Œæ¯”è¾ƒ æ ¹æ®ä»¥ä¸Šçš„è¯´æ˜ï¼Œå½“whereæ¡ä»¶ä¹‹åçš„å€¼çš„ç±»å‹å’Œè¡¨ç»“æ„ä¸ä¸€è‡´çš„æ—¶å€™ï¼ŒMySQLä¼šåšéšå¼çš„ç±»å‹è½¬æ¢ï¼Œéƒ½å°†å…¶è½¬æ¢ä¸ºæµ®ç‚¹æ•°åœ¨æ¯”è¾ƒã€‚ mysql&gt; SELECT CAST(&apos; 1&apos; AS SIGNED)=1; +-------------------------+ | CAST(&apos; 1&apos; AS SIGNED)=1 | +-------------------------+ | 1 | +-------------------------+ 1 row in set (0.00 sec) mysql&gt; SELECT CAST(&apos; 1a&apos; AS SIGNED)=1; +--------------------------+ | CAST(&apos; 1a&apos; AS SIGNED)=1 | +--------------------------+ | 1 | +--------------------------+ 1 row in set, 1 warning (0.00 sec) mysql&gt; SELECT CAST(&apos;1&apos; AS SIGNED)=1; +-----------------------+ | CAST(&apos;1&apos; AS SIGNED)=1 | +-----------------------+ | 1 | +-----------------------+ 1 row in set (0.00 sec) æ¯”å¦‚where string = 1ï¼Œéœ€è¦å°†ç´¢å¼•ä¸­çš„å­—ç¬¦ä¸²è½¬æ¢æˆæµ®ç‚¹æ•°ï¼Œä½†æ˜¯ç”±äºâ€™1â€™,â€™ 1â€™,â€™1aâ€™éƒ½ä¼šæ¯”è½¬åŒ–æˆ1,æ•…MySQLæ— æ³•ç›´æ¥ä½¿ç”¨ç´¢å¼•åªèƒ½è¿›è¡Œå…¨è¡¨æ‰«æï¼Œæ•…é€ æˆäº†æ…¢æŸ¥è¯¢çš„äº§ç”Ÿã€‚ åŒæ—¶éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œç”±äºéƒ½ä¼šè½¬æ¢æˆæµ®ç‚¹æ•°è¿›è¡Œæ¯”è¾ƒï¼Œè€Œæµ®ç‚¹æ•°åªæœ‰53bitï¼Œæ•…å½“è¶…è¿‡æœ€å¤§å€¼çš„æ—¶å€™ï¼Œæ¯”è¾ƒä¼šå‡ºç°é—®é¢˜ã€‚ ç”±äºç´¢å¼•å»ºç«‹åœ¨intçš„åŸºç¡€ä¸Šï¼Œè€Œå°†çº¯æ•°å­—çš„å­—ç¬¦ä¸²å¯ä»¥ç™¾åˆ†ç™¾è½¬æ¢æˆæ•°å­—ï¼Œæ•…å¯ä»¥ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œè™½ç„¶ä¹Ÿä¼šè¿›è¡Œä¸€å®šçš„è½¬æ¢ï¼Œæ¶ˆè€—ä¸€å®šçš„èµ„æºï¼Œä½†æ˜¯æœ€ç»ˆä»ç„¶ä½¿ç”¨äº†ç´¢å¼•ï¼Œä¸ä¼šäº§ç”Ÿæ…¢æŸ¥è¯¢ã€‚ mysql&gt; select CAST( &apos;30&apos; as SIGNED) = 30; +----------------------------+ | CAST( &apos;30&apos; as SIGNED) = 30 | +----------------------------+ | 1 | +----------------------------+ 1 row in set (0.00 sec)","categories":[{"name":"Mysql","slug":"Mysql","permalink":"https://htchz.cc/categories/Mysql/"}],"tags":[{"name":"Mysql","slug":"Mysql","permalink":"https://htchz.cc/tags/Mysql/"}],"author":"åœŸå·"},{"title":"[JVM]Javaå¯¹è±¡çš„ç»„æˆã€å¤§å°è®¡ç®—","slug":"JVM-å¯¹è±¡çš„ç»„æˆ","date":"2018-03-22T14:23:00.000Z","updated":"2020-03-17T14:53:31.731Z","comments":true,"path":"2006878642.html","link":"","permalink":"https://htchz.cc/2006878642.html","excerpt":"åŸºäºHotspotï¼Œæˆ‘ä»¬ç»™è‡ªå·±ä¸€ä¸ªå¯¹è±¡ :(","text":"åŸºäºHotspotï¼Œæˆ‘ä»¬ç»™è‡ªå·±ä¸€ä¸ªå¯¹è±¡ :( 1. Javaå¯¹è±¡æ¨¡å‹Hotspotä¸»è¦æ˜¯ç”¨C++å†™çš„ï¼Œæ‰€ä»¥å®ƒå®šä¹‰çš„Javaå¯¹è±¡è¡¨ç¤ºæ¨¡å‹ä¹Ÿæ˜¯åŸºäºC++å®ç°çš„ã€‚ Javaå¯¹è±¡çš„è¡¨ç¤ºæ¨¡å‹å«åšâ€œOOP-Klassâ€äºŒåˆ†æ¨¡å‹ï¼ŒåŒ…æ‹¬ä¸¤éƒ¨åˆ†: OOPï¼Œå³Ordinary Object Pointï¼Œæ™®é€šå¯¹è±¡æŒ‡é’ˆï¼Œè¯´ç™½äº†å°±æ˜¯è¡¨ç¤ºå¯¹è±¡é™¤äº†å…ƒæ•°æ•°æ®ä¹‹å¤–çš„ä¿¡æ¯ã€‚ Klassï¼Œå³Javaç±»çš„C++å¯¹ç­‰ä½“ï¼Œç”¨æ¥æè¿°Javaç±»ï¼ŒåŒ…å«äº†å…ƒæ•°æ®å’Œæ–¹æ³•ä¿¡æ¯ ä¸€ä¸ªJavaå¯¹è±¡å°±åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œæ•°æ®å’Œæ–¹æ³•ï¼Œåˆ†åˆ«å¯¹åº”åˆ°OOPå’ŒKlassã€‚ JVMè¿è¡Œæ—¶åŠ è½½ä¸€ä¸ªClassæ—¶ï¼Œä¼šåœ¨JVMå†…éƒ¨åˆ›å»ºä¸€ä¸ªinstanceKlasså¯¹è±¡ï¼Œè¡¨ç¤ºè¿™ä¸ªç±»çš„è¿è¡Œæ—¶å…ƒæ•°æ®ã€‚åˆ›å»ºä¸€ä¸ªè¿™ä¸ªClassçš„Javaå¯¹è±¡æ—¶ï¼Œä¼šåœ¨JVMå†…éƒ¨ç›¸åº”çš„åˆ›å»ºä¸€ä¸ªinstanceOopæ¥è¡¨ç¤ºè¿™ä¸ªJavaå¯¹è±¡ã€‚ç†Ÿæ‚‰JVMçš„åŒå­¦å¯ä»¥æ˜ç™½ï¼ŒinstanceKlasså¯¹è±¡æ”¾åœ¨äº†æ–¹æ³•åŒºï¼ŒinstanceOopæ”¾åœ¨äº†å †ï¼ŒinstanceOopçš„å¼•ç”¨æ”¾åœ¨äº†JVMæ ˆã€‚ JVMæ˜¯åŸºäºæ ˆæ¥è¿è¡Œçš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šåœ¨å®ƒçš„JVMæ ˆçš„æ ˆé¡¶åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼ˆFrameï¼‰çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„æ˜¯ç”¨æ¥ä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ï¼Œæ“ä½œæ•°æ ˆï¼ŒåŠ¨æ€è¿æ¥å’Œæ–¹æ³•è¿”å›å€¼çš„ã€‚é€šè¿‡å‚æ•°ä¼ é€’çš„å€¼å’Œåœ¨æ–¹æ³•ä¸­newå‡ºæ¥çš„å¯¹è±¡çš„å¼•ç”¨éƒ½ä¿æŒåœ¨å±€éƒ¨å˜é‡è¡¨é‡Œé¢ã€‚ Javaçš„æ–¹æ³•è°ƒç”¨æ˜¯å€¼ä¼ é€’ï¼Œä¸æ˜¯å¼•ç”¨ä¼ é€’ï¼ŒåŸå› å°±åœ¨è¿™é‡Œï¼Œä¼ é€’è¿›æ¥çš„å‚æ•°ç›¸å½“äºåœ¨å±€éƒ¨å˜é‡è¡¨é‡Œé¢æ‹·è´äº†ä¸€ä»½ï¼Œå®é™…è®¡ç®—æ—¶ï¼Œæ“ä½œæ•°æ ˆæ“ä½œçš„æ˜¯å±€éƒ¨å˜é‡å˜é‡é‡Œé¢çš„å€¼ï¼Œè€Œä¸æ˜¯å¤–éƒ¨çš„å˜é‡ã€‚ åœ¨å †ä¸­åˆ›å»ºçš„Javaå¯¹è±¡å®é™…åªåŒ…å«æ•°æ®ä¿¡æ¯ï¼Œå®ƒä¸»è¦åŒ…å«ä¸‰ï¼ˆå››ï¼‰éƒ¨åˆ†ï¼š å¯¹è±¡å¤´ï¼Œä¹Ÿå«Markword å…ƒæ•°æ®æŒ‡é’ˆï¼Œå¯ä»¥ç†è§£ä¸ºç±»å¯¹è±¡æŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•åŒºçš„instanceKlasså®ä¾‹ã€‚å¦‚æœæ˜¯32ä½çš„ï¼Œé»˜è®¤å¼€å¯å¯¹è±¡æŒ‡é’ˆå‹ç¼©ï¼Œ4ä¸ªå­—èŠ‚ å®ä¾‹æ•°æ® (å¦‚æœæ˜¯æ•°ç»„å¯¹è±¡çš„è¯ï¼Œè¿˜å¤šäº†ä¸€ä¸ªéƒ¨åˆ†ï¼Œå°±æ˜¯æ•°ç»„é•¿åº¦)ï¼Œ4ä¸ªå­—èŠ‚ å¦å¤–è¿˜æœ‰Padding(å†…å­˜å¯¹é½)ï¼ŒæŒ‰ç…§8çš„å€æ•°å¯¹é½ å¯¹è±¡å¤´ä»£è¡¨çš„æ„ä¹‰æ˜¯å¯å˜çš„ï¼Œé€šè¿‡æ ‡å¿—ä½å†³å®šã€‚ä¸»è¦å­˜å‚¨å¯¹è±¡è¿è¡Œæ—¶è®°å½•ä¿¡æ¯ï¼Œå¦‚hashcode, GCåˆ†ä»£å¹´é¾„ï¼Œé”çŠ¶æ€æ ‡å¿—ï¼Œåå‘çº¿ç¨‹IDï¼Œåå‘æ—¶é—´æˆ³ç­‰ã€‚å¯¹è±¡å¤´çš„é•¿åº¦å’ŒJVMçš„å­—é•¿ä¸€è‡´ï¼Œæ¯”å¦‚32ä½JVMçš„å¯¹è±¡å¤´æ˜¯32ä½ï¼Œ64ä½JVMçš„å¯¹è±¡å¤´æ˜¯64ä½ã€‚ä¸‹é¢æ˜¯å¯¹äº64ä½jvmçš„markwordçš„è¯´æ˜ åå‘é”æ ‡è¯†ä½ é”æ ‡è¯†ä½ é”çŠ¶æ€ å­˜å‚¨å†…å®¹ 0 01 æœªé”å®š hashcode(31),å¹´é¾„(4) 1 01 åå‘é” çº¿ç¨‹ID(54),æ—¶é—´æˆ³(2),å¹´é¾„(4) æ—  00 è½»é‡çº§é” æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ(64) æ—  10 é‡é‡çº§é” monitorçš„æŒ‡é’ˆ(64) æ—  11 GCæ ‡è®° ç©ºï¼Œä¸éœ€è¦è®°å½•ä¿¡æ¯ æ‰€è°“çš„ç»™ä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå…¶å®å°±æ˜¯è®¾ç½®äº†å¯¹è±¡å¤´æ ‡å¿—ä½ã€‚å½“å…¶ä»–çº¿ç¨‹çœ‹åˆ°è¿™ä¸ªå¯¹è±¡çš„çŠ¶æ€æ˜¯åŠ é”çŠ¶æ€åï¼Œå°±ç­‰å¾…é‡Šæ”¾é”ã€‚å…³äºé”æˆ‘ä»¬å¦å¼€ä¸€ç¯‡ã€‚ åœ¨æ–¹æ³•åŒºçš„instanceKlasså¯¹è±¡ç›¸å½“äºClassåŠ è½½ååˆ›å»ºçš„è¿è¡Œæ—¶å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå­—æ®µï¼Œæ–¹æ³•ç­‰å…ƒæ•°æ®ï¼Œå½“è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå¦‚ä¸Šé¢çš„å›¾æ‰€ç¤ºï¼Œå®é™…å®šä½åˆ°äº†æ–¹æ³•åŒºçš„instanceKlasså¯¹è±¡çš„æ–¹æ³•å…ƒæ•°æ®ã€‚ 2. ä½¿ç”¨HSDBè°ƒè¯• HSDBæ˜¯ä¸€æ¬¾å†…ç½®ä¸SAçš„GUIè°ƒè¯•å·¥å…·ï¼Œé›†æˆäº†å„ç§JVMç›‘æ§å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥æ·±å…¥åˆ†æJVMå†…éƒ¨çŠ¶æ€ã€‚è¿™ç©æ„åœ¨windowsçš„jdk7æ‰è‡ªå¸¦ï¼Œmacå’Œlinuxå“å¾—jdk6å°±æœ‰äº†ã€‚ é¦–å…ˆæˆ‘ä»¬è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œå¹¶æ‰“ä¸Šæ–­ç‚¹ã€‚ 1234567891011121314151617181920public class Person &#123; private String name; private int age; private boolean sex; public void sayHi()&#123; System.out.println(&quot;Say hi from ITer_ZC&quot;); &#125; public static void main(String[] args)&#123; Person p = new Person(); p.sayHi(); try &#123; Thread.sleep(500000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125; ä¸Šé¢æ–­ç‚¹ç”¨sleepä»£æ›¿ã€‚å¥½åƒè¿˜å¯ä»¥ç”¨jdbå·¥å…·æ–­ç‚¹ï¼Œæ²¡ç ”ç©¶ - - å¯åŠ¨ç¨‹åºï¼Œè¿è¡Œjpså‘½ä»¤ï¼ŒæŸ¥çœ‹å½“å‰javaè¿›ç¨‹idï¼Œ 1234C:\\Users\\zack.huang&gt;jps75248276 Jps4552 Person ç”±4552 Personå¾—çŸ¥4552æ˜¯ä¸Šé¢javaç¨‹åºçš„idï¼Œæ¥ç€è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œ java -cp sa-jdi.jar sun.jvm.hotspot.HSDB sa-jdi.jaråœ¨%JAVA_HOME%\\libç›®å½•ä¸‹ï¼Œä¸è¿‡æˆ‘çš„JAVA_HOMEè·¯å¾„å¥½åƒå› ä¸ºå¸¦äº†ç©ºæ ¼è€å¯åŠ¨ä¸äº†ï¼Œç›´æ¥æŠŠjarå¤åˆ¶åˆ°æ¡Œé¢äº†å¯åŠ¨ã€‚ ç•Œé¢ä¸€ç‰‡ç™½ã€‚ è¾“å…¥pidä¹‹åï¼Œæ˜¾ç¤ºå¯ä»¥çœ‹åˆ°Persondeçš„åœ°å€ åœ¨inspectoré‡Œé¢æŸ¥çœ‹0x00000007c0060028ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°instanceKlassçš„å­—æ®µï¼Œæ–¹æ³•ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ï¼Œçˆ¶ç±»ï¼Œå…„å¼Ÿç±»ç­‰å…ƒæ•°æ®ä¿¡æ¯ åœ¨Object Histogramé‡Œé¢æ‰¾åˆ°Personå¯¹è±¡ æŸ¥çœ‹Person Oopçš„è¿è¡Œæ—¶å®ä¾‹ _markå°±æ˜¯å¯¹è±¡å¤´ï¼Œæ¥ç€æ˜¯å®ä¾‹æ•°æ®ä¿¡æ¯ã€‚HSDBæ²¡æœ‰æ˜¾ç¤ºç±»å¯¹è±¡æŒ‡é’ˆ 3. è®¡ç®—å¯¹è±¡çš„å¤§å°ç¨‹åºè®¡ç®—æ–¹æ³• é€šè¿‡java.lang.instrument.Instrumentationçš„getObjectSize(obj)ç›´æ¥è·å–å¯¹è±¡çš„å¤§å° é€šè¿‡sun.misc.Unsafeå¯¹è±¡çš„objectFieldOffset(field)ç­‰æ–¹æ³•ç»“åˆåå°„æ¥è®¡ç®—å¯¹è±¡çš„å¤§å° 3.1. java.lang.instrument.Instrumentation.getObjectSize()çš„æ–¹å¼è®²è®²java.lang.instrument.Instrumentation.getObjectSize()çš„æ–¹å¼ï¼Œè¿™ç§æ–¹æ³•å¾—åˆ°çš„æ˜¯Shallow Sizeï¼Œå³é‡åˆ°å¼•ç”¨æ—¶ï¼Œåªè®¡ç®—å¼•ç”¨çš„é•¿åº¦ï¼Œä¸è®¡ç®—æ‰€å¼•ç”¨çš„å¯¹è±¡çš„å®é™…å¤§å°ã€‚å¦‚æœè¦è®¡ç®—æ‰€å¼•ç”¨å¯¹è±¡çš„å®é™…å¤§å°ï¼Œå¯ä»¥é€šè¿‡é€’å½’çš„æ–¹å¼å»è®¡ç®—ã€‚ java.lang.instrument.Instrumentationçš„å®ä¾‹å¿…é¡»é€šè¿‡æŒ‡å®šjavaagentçš„æ–¹å¼æ‰èƒ½è·å¾—ï¼Œå…·ä½“çš„æ­¥éª¤å¦‚ä¸‹ï¼š å®šä¹‰ä¸€ä¸ªç±»ï¼Œæä¾›ä¸€ä¸ªpremainæ–¹æ³•: public static void premain(String agentArgs, Instrumentation instP) åˆ›å»ºMETA-INF/MANIFEST.MFæ–‡ä»¶ï¼Œå†…å®¹æ˜¯æŒ‡å®šPreMainçš„ç±»æ˜¯å“ªä¸ªï¼š Premain-Class: sizeof.ObjectShallowSize æŠŠè¿™ä¸ªç±»æ‰“æˆjarï¼Œç„¶åç”¨java -javaagent XXXX.jar XXX.mainçš„æ–¹å¼æ‰§è¡Œ ä¸‹é¢å…ˆå®šä¹‰ä¸€ä¸ªç±»æ¥è·å¾—java.lang.instrument.Instrumentationçš„å®ä¾‹,å¹¶æä¾›äº†ä¸€ä¸ªstaticçš„sizeOfæ–¹æ³•å¯¹å¤–æä¾›Instrumentationçš„èƒ½åŠ› 123456789101112131415package sizeof; import java.lang.instrument.Instrumentation; public class ObjectShallowSize &#123; private static Instrumentation inst; public static void premain(String agentArgs, Instrumentation instP)&#123; inst = instP; &#125; public static long sizeOf(Object obj)&#123; return inst.getObjectSize(obj); &#125; &#125; å®šä¹‰META-INF/MANIFEST.MFæ–‡ä»¶ Premain-Class: sizeof.ObjectShallowSize æ‰“æˆjaråŒ… cd ç¼–è¯‘åçš„ç±»å’ŒMETA-INFæ–‡ä»¶å¤¹æ‰€åœ¨ç›®å½• jar cvfm java-agent-sizeof.jar META-INF/MANIFEST.MF . å‡†å¤‡å¥½äº†è¿™ä¸ªjarä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å†™æµ‹è¯•ç±»æ¥æµ‹è¯•Instrumentationçš„getObjectSizeæ–¹æ³•äº†ã€‚åœ¨è¿™ä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹å¯¹è±¡åœ¨å†…å­˜ä¸­æ˜¯æŒ‰ç…§ä»€ä¹ˆé¡ºåºæ’åˆ—çš„ï¼Œå­—æ®µçš„å®šä¹‰æŒ‰å¦‚ä¸‹é¡ºåº 123456789private static class ObjectA &#123; // æ³¨é‡Šæ˜¯å¯¹åº”ç±»å‹å çš„å­—èŠ‚ç©ºé—´ String str; // 4 int i1; // 4 byte b1; // 1 byte b2; // 1 int i2; // 4 ObjectB obj; //4 byte b3; // 1 &#125; æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰è¯´çš„æ–¹æ³•æ¥è®¡ç®—ä¸€ä¸‹è¿™ä¸ªå¯¹è±¡æ‰€å å¤§å°ï¼Œæ³¨æ„æŒ‰8å¯¹é½ï¼š 8(_mark) + 4(å…ƒæ•°æ®æŒ‡é’ˆ) + 4(str) + 4(i1) + 1(b1) + 1(b2) + 2(padding) + 4(i2) + 4(obj) + 1(b3) + 7(padding) = 40 ?ä½†äº‹å®ä¸Šæ˜¯è¿™æ ·çš„å—ï¼Ÿ æˆ‘ä»¬æ¥ç”¨Instrumentationçš„getObjectSizeæ¥è®¡ç®—ä¸€ä¸‹å…ˆ: 1234567891011121314151617181920212223package test; import sizeof.ObjectShallowSize; public class SizeofWithInstrumetation &#123; private static class ObjectA &#123; String str; // 4 int i1; // 4 byte b1; // 1 byte b2; // 1 int i2; // 4 ObjectB obj; //4 byte b3; // 1 &#125; private static class ObjectB &#123; &#125; public static void main(String[] args)&#123; System.out.println(ObjectShallowSize.sizeOf(new ObjectA())); &#125; &#125; å¾—åˆ°çš„ç»“æœæ˜¯32ï¼ä¸æ˜¯ä¼šæŒ‰8å¯¹é½å—ï¼Œb3ä¹‹å‰çš„æ•°æ®åŠ èµ·æ¥å·²ç»æ˜¯32äº†ï¼Œå¤šäº†1ä¸ªb3ï¼Œä¸º33ï¼Œåº”è¯¥å¯¹é½åˆ°40æ‰å¯¹ã€‚äº‹å®ä¸Šï¼ŒHotSpotåˆ›å»ºçš„å¯¹è±¡çš„å­—æ®µä¼šå…ˆæŒ‰ç…§ç»™å®šé¡ºåºæ’åˆ—ä¸€ä¸‹,é»˜è®¤çš„é¡ºåºå¦‚ä¸‹ï¼Œä»é•¿åˆ°çŸ­æ’åˆ—ï¼Œå¼•ç”¨æ’æœ€å: long/double --&gt; int/float --&gt; short/char --&gt; byte/boolean --&gt; Referenceè¿™ä¸ªé¡ºåºå¯ä»¥ä½¿ç”¨JVMå‚æ•°: -XX:FieldsAllocationSylte=0(é»˜è®¤æ˜¯1)æ¥æ”¹å˜ã€‚æˆ‘ä»¬ä½¿ç”¨sun.misc.Unsafeå¯¹è±¡çš„objectFieldOffsetæ–¹æ³•æ¥éªŒè¯ä¸€ä¸‹: 1234Field[] fields = ObjectA.class.getDeclaredFields(); for(Field f: fields)&#123; System.out.println(f.getName() + \" offset: \" +unsafe.objectFieldOffset(f)); &#125; å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯æŒ‰ç…§ä»é•¿åˆ°çŸ­ï¼Œå¼•ç”¨æ’æœ€åçš„æ–¹å¼åœ¨å†…å­˜ä¸­æ’åˆ—çš„ã€‚æŒ‰ç…§è¿™ç§æ–¹æ³•æˆ‘ä»¬æ¥é‡æ–°è®¡ç®—ä¸‹ObjectAåˆ›å»ºçš„å¯¹è±¡çš„é•¿åº¦: 8(_mark) + 4(å…ƒæ•°æ®æŒ‡é’ˆ) + 4(i1) + + 4(i2) + 1(b1) + 1(b2) + 1(b3) + 1(padding) + 4(str) + 4(obj) = 32è¿™ç§è®¡ç®—æ–¹æ³•å’Œç¨‹åºè®¡ç®—æ–¹æ³•ä¸€æ · unsafeçš„æ–¹å¼å°±ä¸è®²äº†ï¼Œè¿™ç¯‡ä¸»è¦æƒ³è¯´æ€ä¹ˆè®¡ç®—ä¸€ä¸ªå¯¹è±¡å ç”¨çš„å†…å­˜å¤§å°ï¼Œå¯ä»¥ç‚¹å‡»åŸåšæŸ¥çœ‹unsafe","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"},{"name":"OOP","slug":"OOP","permalink":"https://htchz.cc/tags/OOP/"}],"author":"åœŸå·"},{"title":"[åˆ†å¸ƒå¼]å“ˆå¸Œä¸€è‡´æ€§","slug":"åˆ†å¸ƒå¼-å“ˆå¸Œä¸€è‡´æ€§","date":"2018-03-22T10:08:00.000Z","updated":"2019-08-18T11:29:43.108Z","comments":true,"path":"3621931521.html","link":"","permalink":"https://htchz.cc/3621931521.html","excerpt":"å“ˆå¸Œä¸€è‡´æ€§åœ¨å¾ˆå¤šåœ°æ–¹éƒ½æœ‰å‡ºç°ï¼ŒRedisã€MCã€Hadoopé‡Œéƒ½æœ‰å®ƒçš„èº«å½±ã€‚","text":"å“ˆå¸Œä¸€è‡´æ€§åœ¨å¾ˆå¤šåœ°æ–¹éƒ½æœ‰å‡ºç°ï¼ŒRedisã€MCã€Hadoopé‡Œéƒ½æœ‰å®ƒçš„èº«å½±ã€‚ ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•åœ¨1997å¹´ç”±éº»çœç†å·¥å­¦é™¢æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼å“ˆå¸Œï¼ˆDHTï¼‰å®ç°ç®—æ³•ï¼Œè®¾è®¡ç›®æ ‡æ˜¯ä¸ºäº†è§£å†³å› ç‰¹ç½‘ä¸­çš„çƒ­ç‚¹(Hot spot)é—®é¢˜ï¼Œåˆè¡·å’ŒCARPååˆ†ç±»ä¼¼ã€‚ä¸€è‡´æ€§å“ˆå¸Œä¿®æ­£äº†CARPä½¿ç”¨çš„ç®€ å•å“ˆå¸Œç®—æ³•å¸¦æ¥çš„é—®é¢˜ï¼Œä½¿å¾—åˆ†å¸ƒå¼å“ˆå¸Œï¼ˆDHTï¼‰å¯ä»¥åœ¨P2Pç¯å¢ƒä¸­çœŸæ­£å¾—åˆ°åº”ç”¨ã€‚ ä¸€è‡´æ€§hashç®—æ³•æå‡ºäº†åœ¨åŠ¨æ€å˜åŒ–çš„Cacheç¯å¢ƒä¸­ï¼Œåˆ¤å®šå“ˆå¸Œç®—æ³•å¥½åçš„å››ä¸ªæ¡ä»¶: å¹³è¡¡æ€§(Balance)ï¼šå¹³è¡¡æ€§æ˜¯æŒ‡å“ˆå¸Œçš„ç»“æœèƒ½å¤Ÿå°½å¯èƒ½åˆ†å¸ƒåˆ°æ‰€æœ‰çš„ç¼“å†²ä¸­å»ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—æ‰€æœ‰çš„ç¼“å†²ç©ºé—´éƒ½å¾—åˆ°åˆ©ç”¨ã€‚å¾ˆå¤šå“ˆå¸Œç®—æ³•éƒ½èƒ½å¤Ÿæ»¡è¶³è¿™ä¸€æ¡ä»¶ã€‚ å•è°ƒæ€§(Monotonicity)ï¼šå•è°ƒæ€§æ˜¯æŒ‡å¦‚æœå·²ç»æœ‰ä¸€äº›å†…å®¹é€šè¿‡å“ˆå¸Œåˆ†æ´¾åˆ°äº†ç›¸åº”çš„ç¼“å†²ä¸­ï¼Œåˆæœ‰æ–°çš„ç¼“å†²åŠ å…¥åˆ°ç³»ç»Ÿä¸­ã€‚å“ˆå¸Œçš„ç»“æœåº”èƒ½å¤Ÿä¿è¯åŸæœ‰å·²åˆ†é…çš„å†…å®¹å¯ä»¥è¢«æ˜ å°„åˆ°åŸæœ‰çš„æˆ–è€…æ–°çš„ç¼“å†²ä¸­å»ï¼Œè€Œä¸ä¼šè¢«æ˜ å°„åˆ°æ—§çš„ç¼“å†²é›†åˆä¸­çš„å…¶ä»–ç¼“å†²åŒºã€‚ åœ¨Jdk8çš„HashMapçš„æ‰©å®¹å°±ä¿è¯äº†å…ƒç´ çš„å•è°ƒæ€§ã€‚ åˆ†æ•£æ€§(Spread)ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œç»ˆç«¯æœ‰å¯èƒ½çœ‹ä¸åˆ°æ‰€æœ‰çš„ç¼“å†²ï¼Œè€Œæ˜¯åªèƒ½çœ‹åˆ°å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚å½“ç»ˆç«¯å¸Œæœ›é€šè¿‡å“ˆå¸Œè¿‡ç¨‹å°†å†…å®¹æ˜ å°„åˆ°ç¼“å†²ä¸Šæ—¶ï¼Œç”±äºä¸åŒç»ˆç«¯æ‰€è§çš„ç¼“å†²èŒƒå›´æœ‰å¯èƒ½ä¸åŒï¼Œä»è€Œå¯¼è‡´å“ˆå¸Œçš„ç»“æœä¸ä¸€è‡´ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ç›¸åŒçš„å†…å®¹è¢«ä¸åŒçš„ç»ˆç«¯æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ã€‚è¿™ç§æƒ…å†µæ˜¾ç„¶æ˜¯åº”è¯¥é¿å…çš„ï¼Œå› ä¸ºå®ƒå¯¼è‡´ç›¸åŒå†…å®¹è¢«å­˜å‚¨åˆ°ä¸åŒç¼“å†²ä¸­å»ï¼Œé™ä½äº†ç³»ç»Ÿå­˜å‚¨çš„æ•ˆç‡ã€‚åˆ†æ•£æ€§çš„å®šä¹‰å°±æ˜¯ä¸Šè¿°æƒ…å†µå‘ç”Ÿçš„ä¸¥é‡ç¨‹åº¦ã€‚å¥½çš„å“ˆå¸Œç®—æ³•åº”èƒ½å¤Ÿå°½é‡é¿å…ä¸ä¸€è‡´çš„æƒ…å†µå‘ç”Ÿï¼Œä¹Ÿå°±æ˜¯å°½é‡é™ä½åˆ†æ•£æ€§ã€‚ è´Ÿè½½(Load)ï¼šè´Ÿè½½é—®é¢˜å®é™…ä¸Šæ˜¯ä»å¦ä¸€ä¸ªè§’åº¦çœ‹å¾…åˆ†æ•£æ€§é—®é¢˜ã€‚æ—¢ç„¶ä¸åŒçš„ç»ˆç«¯å¯èƒ½å°†ç›¸åŒçš„å†…å®¹æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªç‰¹å®šçš„ç¼“å†²åŒºè€Œè¨€ï¼Œä¹Ÿå¯èƒ½è¢«ä¸åŒçš„ç”¨æˆ·æ˜ å°„ä¸ºä¸åŒ çš„å†…å®¹ã€‚ä¸åˆ†æ•£æ€§ä¸€æ ·ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ˜¯åº”å½“é¿å…çš„ï¼Œå› æ­¤å¥½çš„å“ˆå¸Œç®—æ³•åº”èƒ½å¤Ÿå°½é‡é™ä½ç¼“å†²çš„è´Ÿè·ã€‚ åœ¨åˆ†å¸ƒå¼é›†ç¾¤ä¸­ï¼Œå¯¹æœºå™¨çš„æ·»åŠ åˆ é™¤ï¼Œæˆ–è€…æœºå™¨æ•…éšœåè‡ªåŠ¨è„±ç¦»é›†ç¾¤è¿™äº›æ“ä½œæ˜¯åˆ†å¸ƒå¼é›†ç¾¤ç®¡ç†æœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚å¦‚æœé‡‡ç”¨å¸¸ç”¨çš„hash(object)%Nç®—æ³•ï¼Œé‚£ä¹ˆåœ¨æœ‰æœºå™¨æ·»åŠ æˆ–è€…åˆ é™¤åï¼Œå¾ˆå¤šåŸæœ‰çš„æ•°æ®å°±æ— æ³•æ‰¾åˆ°äº†ï¼Œè¿™æ ·ä¸¥é‡çš„è¿åäº†å•è°ƒæ€§åŸåˆ™ã€‚æ¥ä¸‹æ¥ä¸»è¦è®²è§£ä¸€ä¸‹ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼š 1. å“ˆå¸Œç¯æŒ‰ç…§å¸¸ç”¨çš„hashç®—æ³•æ¥å°†å¯¹åº”çš„keyå“ˆå¸Œåˆ°ä¸€ä¸ªå…·æœ‰2^32æ¬¡æ–¹ä¸ªæ¡¶çš„ç©ºé—´ä¸­ï¼Œå³0~(2^32)-1çš„æ•°å­—ç©ºé—´ä¸­ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†è¿™äº›æ•°å­—å¤´å°¾ç›¸è¿ï¼Œæƒ³è±¡æˆä¸€ä¸ªé—­åˆçš„ç¯å½¢ã€‚å¦‚ä¸‹å›¾ 2. å“ˆå¸Œæ˜ å°„2.1. å°†å¯¹è±¡æ˜ å°„ç°åœ¨æˆ‘ä»¬å°†object1ã€object2ã€object3ã€object4å››ä¸ªå¯¹è±¡é€šè¿‡ç‰¹å®šçš„Hashå‡½æ•°è®¡ç®—å‡ºå¯¹åº”çš„keyå€¼ï¼Œç„¶åæ•£åˆ—åˆ°Hashç¯ä¸Šã€‚å¦‚ä¸‹å›¾ Hash(object1) = key1ï¼› Hash(object2) = key2ï¼› Hash(object3) = key3ï¼› Hash(object4) = key4ï¼› 2.2. å°†æœºå™¨æ˜ å°„åœ¨é‡‡ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„åˆ†å¸ƒå¼é›†ç¾¤ä¸­å°†æ–°çš„æœºå™¨åŠ å…¥ï¼Œå…¶åŸç†æ˜¯é€šè¿‡ä½¿ç”¨ä¸å¯¹è±¡å­˜å‚¨ä¸€æ ·çš„Hashç®—æ³•å°†æœºå™¨ä¹Ÿæ˜ å°„åˆ°ç¯ä¸­ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹å¯¹æœºå™¨çš„hashè®¡ç®—æ˜¯é‡‡ç”¨æœºå™¨çš„IPæˆ–è€…æœºå™¨å”¯ä¸€çš„åˆ«åä½œä¸ºè¾“å…¥å€¼ï¼‰ï¼Œç„¶åä»¥é¡ºæ—¶é’ˆçš„æ–¹å‘è®¡ç®—ï¼Œå°†æ‰€æœ‰å¯¹è±¡å­˜å‚¨åˆ°ç¦»è‡ªå·±æœ€è¿‘çš„æœºå™¨ä¸­ã€‚å‡è®¾ç°åœ¨æœ‰NODE1ï¼ŒNODE2ï¼ŒNODE3ä¸‰å°æœºå™¨ï¼Œé€šè¿‡Hashç®—æ³•å¾—åˆ°å¯¹åº”çš„KEYå€¼ï¼Œæ˜ å°„åˆ°ç¯ä¸­ï¼Œå…¶ç¤ºæ„å›¾å¦‚ä¸‹ï¼š Hash(NODE1) = KEY1; Hash(NODE2) = KEY2; Hash(NODE3) = KEY3; é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹å‡ºå¯¹è±¡ä¸æœºå™¨å¤„äºåŒä¸€å“ˆå¸Œç©ºé—´ä¸­ï¼Œè¿™æ ·æŒ‰é¡ºæ—¶é’ˆè½¬åŠ¨object1å­˜å‚¨åˆ°äº†NODE1ä¸­ï¼Œobject3å­˜å‚¨åˆ°äº†NODE2ä¸­ï¼Œobject2ã€object4å­˜å‚¨åˆ°äº†NODE3ä¸­ã€‚åœ¨è¿™æ ·çš„éƒ¨ç½²ç¯å¢ƒä¸­ï¼Œhashç¯æ˜¯ä¸ä¼šå˜æ›´çš„ï¼Œå› æ­¤ï¼Œé€šè¿‡ç®—å‡ºå¯¹è±¡çš„hashå€¼å°±èƒ½å¿«é€Ÿçš„å®šä½åˆ°å¯¹åº”çš„æœºå™¨ä¸­ï¼Œè¿™æ ·å°±èƒ½æ‰¾åˆ°å¯¹è±¡çœŸæ­£çš„å­˜å‚¨ä½ç½®äº†ã€‚ 3. æœºå™¨çš„åˆ é™¤ä¸æ·»åŠ æ™®é€šhashæ±‚ä½™ç®—æ³•æœ€ä¸ºä¸å¦¥çš„åœ°æ–¹å°±æ˜¯åœ¨æœ‰æœºå™¨çš„æ·»åŠ æˆ–è€…åˆ é™¤ä¹‹åä¼šç…§æˆå¤§é‡çš„å¯¹è±¡å­˜å‚¨ä½ç½®å¤±æ•ˆï¼Œè¿™æ ·å°±å¤§å¤§çš„ä¸æ»¡è¶³å•è°ƒæ€§äº†ã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚ éƒ¨åˆ†ç¼“å­˜å¤±æ•ˆæ˜¯ä¸å¯é¿å…çš„ã€‚ 3.1. èŠ‚ç‚¹(æœºå™¨)çš„åˆ é™¤ä»¥ä¸Šé¢çš„åˆ†å¸ƒä¸ºä¾‹ï¼Œå¦‚æœNODE2å‡ºç°æ•…éšœè¢«åˆ é™¤äº†ï¼Œé‚£ä¹ˆæŒ‰ç…§é¡ºæ—¶é’ˆè¿ç§»çš„æ–¹æ³•ï¼Œobject3å°†ä¼šè¢«è¿ç§»åˆ°NODE3ä¸­ï¼Œè¿™æ ·ä»…ä»…æ˜¯object3çš„æ˜ å°„ä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œå…¶å®ƒçš„å¯¹è±¡æ²¡æœ‰ä»»ä½•çš„æ”¹åŠ¨ã€‚å¦‚ä¸‹å›¾ï¼š 3.2. èŠ‚ç‚¹ï¼ˆæœºå™¨ï¼‰çš„æ·»åŠ å¦‚æœå¾€é›†ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹NODE4ï¼Œé€šè¿‡å¯¹åº”çš„å“ˆå¸Œç®—æ³•å¾—åˆ°KEY4ï¼Œå¹¶æ˜ å°„åˆ°ç¯ä¸­ï¼Œå¦‚ä¸‹å›¾ï¼š 4. å¹³è¡¡æ€§æ ¹æ®ä¸Šé¢çš„å›¾è§£åˆ†æï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ»¡è¶³äº†å•è°ƒæ€§å’Œè´Ÿè½½å‡è¡¡çš„ç‰¹æ€§ä»¥åŠä¸€èˆ¬hashç®—æ³•çš„åˆ†æ•£æ€§ï¼Œä½†è¿™è¿˜å¹¶ä¸èƒ½å½“åšå…¶è¢«å¹¿æ³›åº”ç”¨çš„åŸç”±ï¼Œå› ä¸ºè¿˜ç¼ºå°‘äº†å¹³è¡¡æ€§ã€‚ä¸‹é¢å°†åˆ†æä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯å¦‚ä½•æ»¡è¶³å¹³è¡¡æ€§çš„ã€‚hashç®—æ³•æ˜¯ä¸ä¿è¯å¹³è¡¡çš„ï¼Œå¦‚ä¸Šé¢åªéƒ¨ç½²äº†NODE1å’ŒNODE3çš„æƒ…å†µï¼ˆNODE2è¢«åˆ é™¤çš„å›¾ï¼‰ï¼Œobject1å­˜å‚¨åˆ°äº†NODE1ä¸­ï¼Œè€Œobject2ã€object3ã€object4éƒ½å­˜å‚¨åˆ°äº†NODE3ä¸­ï¼Œè¿™æ ·å°±ç…§æˆäº†éå¸¸ä¸å¹³è¡¡çš„çŠ¶æ€ã€‚åœ¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­ï¼Œä¸ºäº†å°½å¯èƒ½çš„æ»¡è¶³å¹³è¡¡æ€§ï¼Œå…¶å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹ã€‚ â€œè™šæ‹ŸèŠ‚ç‚¹â€ï¼ˆ virtual node ï¼‰æ˜¯å®é™…èŠ‚ç‚¹ï¼ˆæœºå™¨ï¼‰åœ¨ hash ç©ºé—´çš„å¤åˆ¶å“ï¼ˆ replica ï¼‰ï¼Œä¸€å®é™…ä¸ªèŠ‚ç‚¹ï¼ˆæœºå™¨ï¼‰å¯¹åº”äº†è‹¥å¹²ä¸ªâ€œè™šæ‹ŸèŠ‚ç‚¹â€ï¼Œè¿™ä¸ªå¯¹åº”ä¸ªæ•°ä¹Ÿæˆä¸ºâ€œå¤åˆ¶ä¸ªæ•°â€ï¼Œâ€œè™šæ‹ŸèŠ‚ç‚¹â€åœ¨ hash ç©ºé—´ä¸­ä»¥hashå€¼æ’åˆ—ã€‚ ä»¥ä¸Šé¢åªéƒ¨ç½²äº†NODE1å’ŒNODE3çš„æƒ…å†µï¼ˆNODE2è¢«åˆ é™¤çš„å›¾ï¼‰ä¸ºä¾‹ï¼Œä¹‹å‰çš„å¯¹è±¡åœ¨æœºå™¨ä¸Šçš„åˆ†å¸ƒå¾ˆä¸å‡è¡¡ï¼Œç°åœ¨æˆ‘ä»¬ä»¥2ä¸ªå‰¯æœ¬ï¼ˆå¤åˆ¶ä¸ªæ•°ï¼‰ä¸ºä¾‹ï¼Œè¿™æ ·æ•´ä¸ªhashç¯ä¸­å°±å­˜åœ¨äº†4ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œæœ€åå¯¹è±¡æ˜ å°„çš„å…³ç³»å›¾å¦‚ä¸‹ï¼š æ ¹æ®ä¸Šå›¾å¯çŸ¥å¯¹è±¡çš„æ˜ å°„å…³ç³»ï¼šobject1-&gt;NODE1-1ï¼Œobject2-&gt;NODE1-2ï¼Œobject3-&gt;NODE3-2ï¼Œobject4-&gt;NODE3-1ã€‚é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹çš„å¼•å…¥ï¼Œå¯¹è±¡çš„åˆ†å¸ƒå°±æ¯”è¾ƒå‡è¡¡äº†ã€‚é‚£ä¹ˆåœ¨å®é™…æ“ä½œä¸­ï¼Œæ­£çœŸçš„å¯¹è±¡æŸ¥è¯¢æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿå¯¹è±¡ä»hashåˆ°è™šæ‹ŸèŠ‚ç‚¹åˆ°å®é™…èŠ‚ç‚¹çš„è½¬æ¢å¦‚ä¸‹å›¾ï¼š â€œè™šæ‹ŸèŠ‚ç‚¹â€çš„hashè®¡ç®—å¯ä»¥é‡‡ç”¨å¯¹åº”èŠ‚ç‚¹çš„IPåœ°å€åŠ æ•°å­—åç¼€çš„æ–¹å¼ã€‚ä¾‹å¦‚å‡è®¾NODE1çš„IPåœ°å€ä¸º192.168.1.100ã€‚å¼•å…¥â€œè™šæ‹ŸèŠ‚ç‚¹â€å‰ï¼Œè®¡ç®— cache A çš„ hash å€¼ï¼š Hash(â€œ192.168.1.100â€);å¼•å…¥â€œè™šæ‹ŸèŠ‚ç‚¹â€åï¼Œè®¡ç®—â€œè™šæ‹ŸèŠ‚â€ç‚¹NODE1-1å’ŒNODE1-2çš„hashå€¼ï¼š Hash(â€œ192.168.1.100#1â€); // NODE1-1 Hash(â€œ192.168.1.100#2â€); // NODE1-2 ä¸€å¥è¯å°±æ˜¯ï¼Œé€šè¿‡è™šæ‹ŸèŠ‚ç‚¹çš„æ–¹å¼ï¼Œè®©å…ƒç´ åœ¨æœºå™¨ä¸Šåˆ†å¸ƒå‡åŒ€","categories":[{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"https://htchz.cc/categories/åˆ†å¸ƒå¼/"}],"tags":[{"name":"ä¸€è‡´æ€§ç®—æ³•","slug":"ä¸€è‡´æ€§ç®—æ³•","permalink":"https://htchz.cc/tags/ä¸€è‡´æ€§ç®—æ³•/"}],"author":"åœŸå·"},{"title":"[ç¢§æ²¹é¸¡]ä½¿ç”¨HttpClient3çš„å‘","slug":"ç¢§æ²¹é¸¡-ä½¿ç”¨HttpClient3çš„å‘","date":"2018-03-22T09:57:00.000Z","updated":"2020-01-12T06:32:50.243Z","comments":true,"path":"589437945.html","link":"","permalink":"https://htchz.cc/589437945.html","excerpt":"ç‰¹ä¹ˆç™»å½•çŠ¶æ€è€æ˜¯ä¸¢å¤±ã€‚ã€‚ã€‚","text":"ç‰¹ä¹ˆç™»å½•çŠ¶æ€è€æ˜¯ä¸¢å¤±ã€‚ã€‚ã€‚ 1. åœºæ™¯ä½¿ç”¨é˜¿é‡Œå¼€æºé…ç½®ä¸­å¿ƒçš„diamond-sdkæ—¶éœ€è¦ç™»å½•é…ç½®ä¸­å¿ƒæ‰æœ‰æƒé™è¿›è¡Œæ“ä½œã€‚diamond-sdkæ˜¯ä½¿ç”¨HttpClient3æ¥è¿›è¡Œä¿¡æ¯ä¼ è¾“çš„ï¼Œäºæ˜¯åœ¨è¿›è¡Œé…ç½®çš„æ“ä½œä¹‹å‰å®¢æˆ·ç«¯ä¼šå…ˆæ¨¡æ‹Ÿç™»å½•è·å¾—sessionã€‚ç„¶è€Œåœ¨æ¥ä¸‹æ¥çš„æ“ä½œå´ä¸€ç›´æŠ¥â€æœªç™»å½•â€ä¹‹ç±»çš„æç¤ºã€‚ debugå¤§æ³•åå‘ç°Cookieå¯¹è±¡å¥½åƒidä¸€ç›´åœ¨å˜ï¼Œè¿”å›çš„jsessionidä¹Ÿæ²¡ä¿å­˜ã€‚ä¸€æ³¢æ¢ç´¢å‘ç°HttpClient3éœ€è¦æ‰‹åŠ¨è®¾ç½®cookieç­–ç•¥ã€‚ 2. è§£å†³æ–¹æ³•HttpClient3 é»˜è®¤çš„cookieç­–ç•¥æ˜¯æ¯æ¬¡æ–°å»ºä¸€ä¸ªCookieå¯¹è±¡ï¼Œå¤ç”¨Cookieçš„è¯ï¼Œè¦è¿›è¡Œå¦‚ä¸‹è®¾ç½®ã€‚ client.getParams().setCookiePolicy(CookiePolicy.BROWSER_COMPATIBILITY)(å®Œ)","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"BUG","slug":"BUG","permalink":"https://htchz.cc/tags/BUG/"}],"author":"åœŸå·"},{"title":"[Spring]Springä¹‹å¾ªç¯ä¾èµ–","slug":"Spring-Springä¹‹å¾ªç¯ä¾èµ–","date":"2018-03-19T17:57:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"3244702836.html","link":"","permalink":"https://htchz.cc/3244702836.html","excerpt":"é¢è¯•é¢è¿‡è¿™ä¸ªé—®é¢˜ï¼Œæ•´ç†ä¸€ä¸‹ã€‚æ‰€è°“å¾ªç¯ä¾èµ–å°±æ˜¯å¤šä¸ªBeanä¹‹é—´ä¾èµ–å…³ç³»å½¢æˆä¸€ä¸ªé—­ç¯ï¼Œä¾‹å¦‚A-&gt;B-&gt;C-&gt;â€¦-&gt;A è¿™ç§æƒ…å†µï¼Œå½“ç„¶ï¼Œæœ€ç®€å•çš„å¾ªç¯ä¾èµ–å°±æ˜¯2ä¸ªBeanä¹‹é—´äº’ç›¸ä¾èµ–ï¼šA-&gt;Bï¼ˆAä¾èµ–B), B-&gt;A(Bä¾èµ–A) ã€‚åœ¨Springä¸­ï¼Œå¦‚æœA-&gt;B,é‚£ä¹ˆåœ¨åˆ›å»ºAçš„è¿‡ç¨‹ä¸­ä¼šå»åˆ›å»ºB,åœ¨åˆ›å»ºBï¼ˆæˆ–Bçš„ä¾èµ–)çš„è¿‡ç¨‹ä¸­åˆå‘ç°B-&gt;Aï¼Œè¿™ä¸ªæ—¶å€™å°±å‡ºç°äº†å¾ªç¯ä¾èµ–çš„ç°è±¡ã€‚","text":"é¢è¯•é¢è¿‡è¿™ä¸ªé—®é¢˜ï¼Œæ•´ç†ä¸€ä¸‹ã€‚æ‰€è°“å¾ªç¯ä¾èµ–å°±æ˜¯å¤šä¸ªBeanä¹‹é—´ä¾èµ–å…³ç³»å½¢æˆä¸€ä¸ªé—­ç¯ï¼Œä¾‹å¦‚A-&gt;B-&gt;C-&gt;â€¦-&gt;A è¿™ç§æƒ…å†µï¼Œå½“ç„¶ï¼Œæœ€ç®€å•çš„å¾ªç¯ä¾èµ–å°±æ˜¯2ä¸ªBeanä¹‹é—´äº’ç›¸ä¾èµ–ï¼šA-&gt;Bï¼ˆAä¾èµ–B), B-&gt;A(Bä¾èµ–A) ã€‚åœ¨Springä¸­ï¼Œå¦‚æœA-&gt;B,é‚£ä¹ˆåœ¨åˆ›å»ºAçš„è¿‡ç¨‹ä¸­ä¼šå»åˆ›å»ºB,åœ¨åˆ›å»ºBï¼ˆæˆ–Bçš„ä¾èµ–)çš„è¿‡ç¨‹ä¸­åˆå‘ç°B-&gt;Aï¼Œè¿™ä¸ªæ—¶å€™å°±å‡ºç°äº†å¾ªç¯ä¾èµ–çš„ç°è±¡ã€‚ 1. ä¸æ˜¯å¾ªç¯è°ƒç”¨å¾ªç¯ä¾èµ–å°±æ˜¯å¾ªç¯å¼•ç”¨ï¼Œå°±æ˜¯ä¸¤ä¸ªæˆ–å¤šä¸ªBeanç›¸äº’ä¹‹é—´çš„æŒæœ‰å¯¹æ–¹ï¼Œæ¯”å¦‚CircleAå¼•ç”¨CircleBï¼ŒCircleBå¼•ç”¨CircleCï¼ŒCircleCå¼•ç”¨CircleAï¼Œåˆ™å®ƒä»¬æœ€ç»ˆåæ˜ ä¸ºä¸€ä¸ªç¯ã€‚æ­¤å¤„ä¸æ˜¯å¾ªç¯è°ƒç”¨ï¼Œå¾ªç¯è°ƒç”¨æ˜¯æ–¹æ³•ä¹‹é—´çš„ç¯è°ƒç”¨ï¼Œå¦‚ä¸‹å›¾ï¼š è€Œå¾ªç¯è°ƒç”¨æ˜¯æ— æ³•è§£å†³çš„ï¼Œé™¤éæœ‰ç»ˆç»“æ¡ä»¶ï¼Œå¦åˆ™å°±æ˜¯æ­»å¾ªç¯ï¼Œæœ€ç»ˆå¯¼è‡´å†…å­˜æº¢å‡ºé”™è¯¯ã€‚ Springå®¹å™¨å¾ªç¯ä¾èµ–åŒ…æ‹¬æ„é€ å™¨å¾ªç¯ä¾èµ–å’Œsetterå¾ªç¯ä¾èµ–ï¼Œé‚£Springå®¹å™¨å¦‚ä½•æ£€æµ‹å’Œè§£å†³å¾ªç¯ä¾èµ–å‘¢ï¼Ÿ 2. Springå¯ä»¥è§£å†³çš„å¾ªç¯ä¾èµ–springä¸­çš„å¾ªç¯ä¾èµ–åªæœ‰å½“ Beanæ˜¯å•ä¾‹ é€šè¿‡å±æ€§æ³¨å…¥çš„æƒ…å†µ è¿™ä¸¤ä¸ªæ¡ä»¶æ»¡è¶³çš„æƒ…å†µä¸‹æ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†æ˜¯å¦‚æœæ˜¯é€šè¿‡æ„é€ å™¨ä¾èµ–ï¼Œæˆ–è€…ä¸æ˜¯å•ä¾‹æ¨¡å¼çš„æƒ…å†µä¸‹å¾ªç¯ä¾èµ–å°±ä¼šæŠ›å‡ºå¼‚å¸¸BeanCurrentlyInCreationExceptionã€‚ä¸‹é¢ä»ä»£ç å±‚é¢ä¸Šè§£æä¸€ä¸‹ä¸ºä»€ä¹ˆã€‚ è‡³äºä¸ºä»€ä¹ˆè¦æœ‰prototypeç±»å‹çš„beanï¼Œæˆ‘æƒ³å…¸å‹çš„åº”ç”¨åœºæ™¯å°±æ˜¯strutsçš„Actionï¼ˆæœ‰ç‚¹åƒspringmvcçš„Controllerï¼‰å®ä¾‹ã€‚strutsçš„requestå‚æ•°æ˜¯ç»‘å®šåœ¨Actionå¯¹è±¡çš„æˆå‘˜å˜é‡ä¸Šçš„ï¼Œå¦‚æœActionçš„beanæ˜¯å•ä¾‹çš„å°±ä¼šé€ æˆçº¿ç¨‹ä¸å®‰å…¨ã€‚ 3. Prototypeå¾ªç¯ä¾èµ–æŠ›å¼‚å¸¸123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129protected &lt;T&gt; T doGetBean( final String name, final Class&lt;T&gt; requiredType, final Object[] args, boolean typeCheckOnly) throws BeansException &#123; final String beanName = transformedBeanName(name); Object bean; // Eagerly check singleton cache for manually registered singletons. Object sharedInstance = getSingleton(beanName); if (sharedInstance != null &amp;&amp; args == null) &#123; ...// æ—¥å¿—ä»£ç  bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); &#125; else &#123; // è¯·çœ‹è¿™é‡Œï¼ŒæŠ›å¼‚å¸¸ // Fail if we're already creating this bean instance: // We're assumably within a circular reference. if (isPrototypeCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName); &#125; // Check if bean definition exists in this factory. BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; // Not found -&gt; check parent. String nameToLookup = originalBeanName(name); if (args != null) &#123; // Delegation to parent with explicit args. return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else &#123; // No args -&gt; delegate to standard getBean method. return parentBeanFactory.getBean(nameToLookup, requiredType); &#125; &#125; if (!typeCheckOnly) &#123; markBeanAsCreated(beanName); &#125; try &#123; final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); checkMergedBeanDefinition(mbd, beanName, args); // Guarantee initialization of beans that the current bean depends on. String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; if (isDependent(beanName, dep)) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"Circular depends-on relationship between '\" + beanName + \"' and '\" + dep + \"'\"); &#125; registerDependentBean(dep, beanName); getBean(dep); &#125; &#125; // Create bean instance. if (mbd.isSingleton()) &#123; sharedInstance = getSingleton(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; try &#123; return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; &#125; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); &#125; else if (mbd.isPrototype()) &#123; // It's a prototype -&gt; create a new instance. Object prototypeInstance = null; try &#123; beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); &#125; else &#123; String scopeName = mbd.getScope(); final Scope scope = this.scopes.get(scopeName); if (scope == null) &#123; throw new IllegalStateException(\"No Scope registered for scope name '\" + scopeName + \"'\"); &#125; try &#123; Object scopedInstance = scope.get(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; beforePrototypeCreation(beanName); try &#123; return createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; &#125; &#125;); bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); &#125; catch (IllegalStateException ex) &#123; throw new BeanCreationException(beanName, \"Scope '\" + scopeName + \"' is not active for the current thread; consider \" + \"defining a scoped proxy for this bean if you intend to refer to it from a singleton\", ex); &#125; &#125; &#125; catch (BeansException ex) &#123; cleanupAfterBeanCreationFailure(beanName); throw ex; &#125; &#125; ...// typeæ ¡éªŒ return (T) bean;&#125; å¯ä»¥çœ‹å‡ºï¼Œè¯¥æµç¨‹ä¸­å°±è€ƒè™‘äº†Prototypeçš„å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œåªè¦åœ¨åˆ›å»ºPrototypeçš„Beanä¸­å‡ºç°å¾ªç¯ä¾èµ–é‚£ä¹ˆå°±æŠ›å‡ºå¼‚å¸¸ã€‚ä½†æ˜¯åœ¨singletonçš„æƒ…å†µä¸‹ï¼Œåˆ™é€šè¿‡å¦å¤–çš„æ–¹å¼æ¥è§£å†³ã€‚ 4. Singletonçš„å¾ªç¯ä¾èµ–ä¹‹æ„é€ æ³¨å…¥ä¸Šé¢çš„ä»£ç æœ‰è¿™ä¹ˆä¸€æ®µSingletonçš„å¤„ç† 12345678910111213141516171819// Create bean instance.if (mbd.isSingleton()) &#123; sharedInstance = getSingleton(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; try &#123; return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; &#125; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);&#125; è¿™ä¸ªgetSingletonæ¶‰åŠåˆ°äº†ObjectFactoryè¿™ä¸ªæ¥å£ç±»ï¼Œè¿™ä¸ªæ¥å£çš„åŠŸèƒ½å’ŒFactoryBeanç±»ä¼¼ï¼Œä½†æ˜¯ä¸»è¦æ˜¯ç”¨æ¥è§£å†³å¾ªç¯ä¾èµ–çš„ã€‚åœ¨åˆå§‹åŒ–è¿‡ç¨‹å†³å®šè¿”å›çš„Singletonå¯¹è±¡ã€‚å…³äºå•ä¾‹çš„å¯¹è±¡çš„åˆ›å»ºï¼Œåˆè¦ä»‹ç»ä¸€ä¸‹DefaultSingletonBeanRegistryè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»ä¸»è¦ç”¨æ¥å¸®åŠ©åˆ›å»ºå•ä¾‹æ¨¡å¼ï¼Œå…¶ä¸­ä¸»è¦çš„å±æ€§ï¼š 12345678910111213141516/** ç¼“å­˜åˆ›å»ºçš„å•ä¾‹å¯¹è±¡: beanåå­— --&gt; beanå¯¹è±¡ */private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;String, Object&gt;(256);/** ç¼“å­˜å•ä¾‹çš„factory,å°±æ˜¯ObjectFactoryè¿™ä¸ªä¸œè¥¿ï¼Œ: bean name --&gt; ObjectFactory */private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;String, ObjectFactory&lt;?&gt;&gt;(16);/** ä¹Ÿæ˜¯ç¼“å­˜åˆ›å»ºçš„å•ä¾‹å¯¹è±¡ï¼ŒåŠŸèƒ½å’ŒsingletonObjectsä¸ä¸€æ ·ï¼Œåœ¨beanæ„é€ æˆåŠŸä¹‹åï¼Œå±æ€§åˆå§‹åŒ–ä¹‹å‰ä¼šæŠŠå¯¹è±¡æ”¾å…¥åˆ°è¿™é‡Œï¼Œä¸»è¦æ˜¯ç”¨äºè§£å†³å±æ€§æ³¨å…¥çš„å¾ªç¯å¼•ç”¨: bean name --&gt; bean instance */private final Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;String, Object&gt;(16);/** è®°å½•åœ¨åˆ›å»ºå•ä¾‹å¯¹è±¡ä¸­å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œè¿˜è®°å¾—Prototypeä¸­åˆè®°å½•åˆ›å»ºè¿‡ç¨‹ä¸­ä¾èµ–çš„mapå—ï¼Ÿåœ¨Prototypeä¸­åªè¦å‡ºç°äº†å¾ªç¯ä¾èµ–å°±æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œåœ¨å•ä¾‹ä¸­ä¼šå°è¯•è§£å†³ */private final Set&lt;String&gt; singletonsCurrentlyInCreation = Collections.newSetFromMap(new ConcurrentHashMap&lt;String, Boolean&gt;(16)); ç°åœ¨çœ‹getSingleton(beanName, new ObjectFactory&lt;Object&gt;()çš„å®ç° 1234567891011121314151617181920212223242526272829303132333435363738394041public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123; Assert.notNull(beanName, \"'beanName' must not be null\"); synchronized (this.singletonObjects) &#123; Object singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) &#123; if (this.singletonsCurrentlyInDestruction) &#123; throw new BeanCreationNotAllowedException(beanName, \"Singleton bean creation not allowed while singletons of this factory are in destruction \" + \"(Do not request a bean from a BeanFactory in a destroy method implementation!)\"); &#125; //æ—¥å¿—ä»£ç  ... //æŠŠå½“å‰beanNameåŠ å…¥åˆ°singletonsCurrentlyInCreationä¸­ beforeSingletonCreation(beanName); boolean newSingleton = false; boolean recordSuppressedExceptions = (this.suppressedExceptions == null); if (recordSuppressedExceptions) &#123; this.suppressedExceptions = new LinkedHashSet&lt;Exception&gt;(); &#125; try &#123; singletonObject = singletonFactory.getObject(); newSingleton = true; &#125; catch(...)&#123; ... &#125; //ä»singletonsCurrentlyInCreationä¸­åˆ é™¤beanName finally &#123; if (recordSuppressedExceptions) &#123; this.suppressedExceptions = null; &#125; afterSingletonCreation(beanName); &#125; if (newSingleton) &#123; addSingleton(beanName, singletonObject); &#125; &#125; return (singletonObject != NULL_OBJECT ? singletonObject : null); &#125;&#125; è¿™æ®µé€»è¾‘æ˜¯ä¸æ˜¯å’ŒPrototypeä¸­è§£å†³å¾ªç¯ç±»ä¼¼,è¿™é‡Œå…¶å®å°±æ˜¯è°ƒç”¨äº†ObjectFactoryçš„getObject()è·å–å¯¹è±¡ï¼Œå›è¿‡å¤´å»çœ‹å‰é¢ä»£ç ï¼ŒObjectFactoryçš„getObject()æ–¹æ³•å®é™…è°ƒç”¨çš„æ˜¯createBean(beanName, mbd, args)ã€‚è¯´åˆ°createBean(beanName, mbd, args)åˆä¸å¾—ä¸è¯´AbstractAutowireCapableBeanFactoryè¿™ä¸ªç±»ï¼Œä¸»è¦åŠŸèƒ½å°±æ˜¯å®Œæˆä¾èµ–æ³¨å…¥çš„Beançš„åˆ›å»ºï¼Œè¿™ä¸ªç±»çš„createBeanæ–¹æ³•ä»£ç å¦‚ä¸‹,æ³¨æ„æ³¨è§£è¯´æ˜ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657@Overrideprotected Object createBean(String beanName, RootBeanDefinition mbd, Object[] args) throws BeanCreationException &#123; ... Object beanInstance = doCreateBean(beanName, mbdToUse, args); ...&#125;protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final Object[] args) throws BeanCreationException &#123; // å®ä¾‹åŒ–bean BeanWrapper instanceWrapper = null; if (mbd.isSingleton()) &#123; instanceWrapper = this.factoryBeanInstanceCache.remove(beanName); &#125; if (instanceWrapper == null) &#123; //å¦‚æœæ²¡å®ä¾‹åŒ–åˆ™åˆ›å»ºæ–°çš„BeanWrapper //å¦‚æœæ˜¯é€šè¿‡æ„é€ å™¨æ³¨å…¥ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªå…³é”®ç‚¹ /* å› ä¸ºåœ¨Aåˆå§‹åŒ–çš„æ—¶å€™å‘ç°æ„é€ å‡½æ•°ä¾èµ–Bï¼Œå°±ä¼šå»å®ä¾‹åŒ–Bï¼Œ ç„¶åBä¹Ÿä¼šè¿è¡Œåˆ°è¿™æ®µé€»è¾‘ï¼Œæ„é€ å‡½æ•°ä¸­å‘ç°ä¾èµ–Aï¼Œ è¿™ä¸ªæ—¶å€™å°±ä¼šæŠ›å‡ºå¾ªç¯ä¾èµ–çš„å¼‚å¸¸ */ instanceWrapper = createBeanInstance(beanName, mbd, args); &#125; //å¦‚æœå½“å‰æ˜¯å•ä¾‹ï¼Œå¹¶ä¸”allowCircularReferencesä¸ºtrue(é»˜è®¤å°±æ˜¯trueï¼Œé™¤éæˆ‘ä»¬ä¸å¸Œæœ›Springå¸®æˆ‘ä»¬è§£å†³) boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) &#123; /* ï¼ï¼ï¼è¿™é‡Œå¾ˆé‡è¦ï¼ŒæŠŠæ„é€ æˆåŠŸï¼Œä½†å±æ€§è¿˜æ²¡æ³¨å…¥çš„ çš„beanåŠ åˆ°singletonFactoryä¸­ï¼Œè¿™æ ·å†è§£å†³Açš„ä¾èµ– è¿‡ç¨‹ä¸­å¦‚æœä¾èµ–Aï¼Œå°±æŠŠè¿™ä¸ªåŠæˆå“è¿”å›å›å»ã€‚ */ addSingletonFactory(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; return getEarlyBeanReference(beanName, mbd, bean); &#125; &#125;); &#125; Object exposedObject = bean; try &#123; //è‡ªåŠ¨æ³¨å…¥å±æ€§ populateBean(beanName, mbd, instanceWrapper); if (exposedObject != null) &#123; exposedObject = initializeBean(beanName, exposedObject, mbd); &#125; &#125; ... return exposedObject;&#125; 5. æ€»ç»“ AbstractBeanFactory,è¿™ä¸ªç±»ä¸­åŒ…å«äº†Beanåˆ›å»ºçš„ä¸»è¦æµç¨‹ï¼Œåœ¨doGetBeanè¿™ä¸ªæ–¹æ³•ä¸­åŒ…å«äº†å¯¹Prototypeå¾ªç¯ä¾èµ–å¤„ç†ã€‚é€»è¾‘å¾ˆç®€å•ï¼Œå‡ºç°äº†å¾ªç¯ä¾èµ–åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ DefaultSingletonBeanRegister ç”¨äºç®¡ç†Singletonçš„å¯¹è±¡çš„åˆ›å»ºï¼Œä»¥åŠè§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜,å…¶ä¸­è§£å†³å¾ªç¯ä¾èµ–çš„å…³é”®å±æ€§å°±æ˜¯äº†earlySingletonObjectsï¼Œä»–ä¼šåœ¨æ„é€ Singletonå¯¹è±¡è¿‡ç¨‹ä¸­æš‚æ—¶ç¼“å­˜æ„é€ æˆåŠŸï¼Œä½†å±æ€§è¿˜æœªæ³¨å…¥çš„å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚ AbstractAutowireCapableBeanFactory,è‡ªåŠ¨æ³¨å…¥çš„ç›¸å…³é€»è¾‘ï¼ŒåŒ…è‡ªåŠ¨æ³¨å…¥çš„å¯¹è±¡çš„åˆ›å»ºã€åˆå§‹åŒ–å’Œæ³¨å…¥ã€‚ä½†å¦‚æœåœ¨è°ƒç”¨æ„é€ å‡½æ•°ä¸­å‘ç°äº†å¾ªç¯ä¾èµ–ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ ObjectFactory,è¿™ä¸ªæ¥å£åŠŸèƒ½å’ŒFactoryBeanç±»ä¼¼ï¼Œä½†æ˜¯ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–ï¼Œä»–å†³å®šäº†åœ¨è·å–çš„getSingleton()æ˜¯ä¸€ä¸ªå®Œæˆå“è¿˜æ˜¯ä¸€ä¸ªåŠæˆå“ã€‚ 6. æ„é€ å‡½æ•°å’Œå±æ€§æ³¨å…¥ä¾èµ–çš„å¾ªç¯çœ‹ä¸‹é¢çš„åœºæ™¯ 123456789101112131415@Componentpublic class BeanA &#123; private BeanB beanB; @Autowired public BeanA(BeanB beanB) &#123; this.beanB = beanB; &#125;&#125;@Componentpublic class BeanB &#123; @Autowired private BeanA beanA;&#125; è¿™ç§æƒ…å†µä¼šä¸ä¼šæŠ¥ä¾èµ–å¼‚å¸¸ï¼Ÿå†™ä¸ªdemoï¼ŒæŠ¥ä¸‹é¢çš„é”™è¯¯ä¿¡æ¯ã€‚ *************************** APPLICATION FAILED TO START *************************** Description: The dependencies of some of the beans in the application context form a cycle: â”Œâ”€â”€â”€â”€â”€â” | beanA defined in file [C:\\Users\\zack.huang\\IdeaProjects\\xunhuanbean\\target\\classes\\com\\htc\\testbean\\xunhuanbean\\BeanA.class] â†‘ â†“ | beanB (field private com.htc.testbean.xunhuanbean.BeanA com.htc.testbean.xunhuanbean.BeanB.beanC) â””â”€â”€â”€â”€â”€â”˜æŒ‰ç…§ç±»åçš„å­—å…¸æ’åºï¼ŒBeanAæ˜¯ä¼šæ¯”BeanBå…ˆè¢«æ‰«æåˆ°çš„ï¼Œé‚£ä¹ˆå…ˆæ„é€ BeanAï¼ŒBeanAæ˜æ˜¾æ„é€ éœ€è¦BeanBä¾èµ–ï¼Œåˆå§‹åŒ–BeanBï¼ŒBeanAæ²¡æ„é€ å®Œæˆæ— æ³•æ³¨å…¥ï¼Œäºæ˜¯GGã€‚ å¦‚æœBeanAæ”¹åä¸ºBeanCï¼Œå°±å¯ä»¥è§£å†³é—®é¢˜ï¼Œä¸è¿‡è¿™ç§è°å…ˆè°åæ˜¯ä¸å¯é çš„ï¼Œå‹¿å†™è¿™ç§ä»£ç ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://htchz.cc/categories/Spring/"}],"tags":[{"name":"Bean","slug":"Bean","permalink":"https://htchz.cc/tags/Bean/"},{"name":"IOC","slug":"IOC","permalink":"https://htchz.cc/tags/IOC/"}],"author":"åœŸå·"},{"title":"[ç¢§æ²¹é¸¡]æµ…è°ˆ0xFF","slug":"ç¢§æ²¹é¸¡-æµ…è°ˆ0xFF","date":"2018-03-16T07:47:00.000Z","updated":"2020-06-06T17:52:05.928Z","comments":true,"path":"2016889271.html","link":"","permalink":"https://htchz.cc/2016889271.html","excerpt":"è¿™æ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•°å¼•å‘çš„bug","text":"è¿™æ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•°å¼•å‘çš„bug 1. åœºæ™¯é¡¹ç›®ä¸­ä½¿ç”¨äº†Redisçš„BitMapæ•°æ®ç»“æ„ï¼Œå…³äºå®ƒçš„ç”¨æ³•å°±ä¸èµ˜è¿°äº†ã€‚ ç¬”è€…ç”¨BitMapæ¥ä½œä¸ºipåœ°å€çš„é»‘åå•æ¨¡å‹ï¼Œä½¿ç”¨ipçš„hashcodeä½œä¸ºoffsetï¼Œå†åˆé€‚ä¸è¿‡ã€‚ ä½†æ˜¯ipæ˜¯ä¸€ä¸ª32ä½çš„æ— ç¬¦å·æ•°ï¼Œè€Œjavaæ˜¯æ²¡æœ‰æ— ç¬¦å·æ•°çš„ï¼Œè¿™å°±å¯¼è‡´æœ‰äº›ipçš„hashcodeæ˜¯ä¸€ä¸ªè´Ÿæ•°ã€‚ javaçš„åšæ³•æ˜¯é€šè¿‡æ©ç çš„æ“ä½œæ¥è¿›è¡Œæœ‰ç¬¦å·æ•°åˆ°æ— ç¬¦å·æ•°çš„è½¬æ¢ã€‚ 2. è§£å†³æ–¹æ³•hashCode() &amp; 0x00000000FFFFFFFFL é€šè¿‡è¿™è¡Œä»£ç æŠŠintè½¬ä¸ºlongï¼Œè€Œä¸”æ•°å€¼æ˜¯æ— ç¬¦å·intçš„å€¼ javaä¹Ÿæœ‰BitMapä½å›¾æ¨¡å‹â€”â€”java.util.BitSet,è€Œä¸”javaçš„BitSetçš„apiåªèƒ½ä½¿ç”¨å¤§äº0çš„intä½œä¸ºoffsetï¼Œè€Œredisæ˜¯å¯ä»¥ç”¨longä½œä¸ºoffsetçš„ã€‚(redisçš„bitsetå¤§å°é™åˆ¶æ˜¯512MBï¼Œå³2^32bit) 3. äºŒè¿›åˆ¶é‚£äº›äº‹ åœ¨java.io.FilterOutputStream.DataOutputStreamï¼šä¸æœºå™¨æ— å…³åœ°å†™å…¥å„ç§ç±»å‹çš„æ•°æ®ä»¥åŠStringå¯¹è±¡çš„äºŒè¿›åˆ¶å½¢å¼ï¼Œä»é«˜ä½å¼€å§‹å†™ã€‚è¿™æ ·ä¸€æ¥ï¼Œä»»ä½•æœºå™¨ä¸Šä»»ä½•DataInputStreaméƒ½èƒ½å¤Ÿè¯»å–å®ƒä»¬ã€‚æ‰€æœ‰æ–¹æ³•éƒ½ä»¥â€œwriteâ€å¼€å¤´ï¼Œä¾‹å¦‚writeByte()ï¼ŒwriteFloat()ç­‰ã€‚java.io.FilterOutputStream.PrintStreamæœ€åˆçš„ç›®çš„æ˜¯ä¸ºäº†ä»¥å¯è§†åŒ–æ ¼å¼æ‰“å°æ‰€æœ‰çš„åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠStringå¯¹è±¡ã€‚è¿™å’ŒDataOutputStreamä¸åŒï¼Œå®ƒç›®çš„æ˜¯å°†æ•°æ®å…ƒç´ ç½®å…¥â€œæµâ€ä¸­ï¼Œä½¿DataInputStreamèƒ½å¤Ÿå¯ç§»æ¤åœ°é‡æ„å®ƒä»¬ã€‚ å¦‚ä½•æŠŠä¸€ä¸²å­—ç¬¦ä¸²å†™æˆäºŒè¿›åˆ¶ï¼Ÿ å­—ç¬¦ä¸²çš„æœ¬è´¨æ˜¯charçš„åºåˆ—ï¼Œä¹Ÿå°±æ˜¯char []ã€‚å› æ­¤ï¼Œéå†å†™å…¥æ¯ä¸€ä¸ªcharï¼Œå°±å®Œæˆäº†å†™ä¸€ä¸ªå­—ç¬¦ä¸²çš„åŠŸèƒ½ã€‚ charå†™æˆäºŒè¿›åˆ¶ï¼Ÿè‹±è¯­å­—æ¯æœ‰ASCIIç ï¼Œå¯ä»¥æŠŠæ¯ä¸ªå­—ç¬¦è½¬æ¢æˆå¯¹åº”çš„æ•°å­—ï¼Œé‚£ä¹ˆæ±‰å­—æ—¥è¯­å‘¢æ³°å›½è¯­å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜å‰äººæ—©å°±å·²ç»è§£å†³ã€‚ä¸–ç•Œä¸Šçš„ç»å¤§éƒ¨åˆ†å­—ç¬¦éƒ½æœ‰ä¸€å¼ ç±»ä¼¼äºASCIIç è¡¨çš„å­—ç¬¦å’Œç¼–ç é—´çš„æ˜ å°„ï¼Œé‚£å°±æ˜¯Unicodeç è¡¨ã€‚ Unicode å­—ç¬¦ç¼–ç æ ‡å‡†æ˜¯å›ºå®šé•¿åº¦çš„å­—ç¬¦ç¼–ç æ–¹æ¡ˆï¼Œå®ƒåŒ…å«äº†ä¸–ç•Œä¸Šå‡ ä¹æ‰€æœ‰ç°ç”¨è¯­è¨€çš„å­—ç¬¦ã€‚æœ‰å…³ Unicode çš„ä¿¡æ¯å¯åœ¨æœ€æ–°ç‰ˆæœ¬çš„ The Unicode Standard ä¸€ä¹¦ä¸­æ‰¾åˆ°ï¼Œå¹¶å¯ä» Unicode åä¼š Web ç«™ç‚¹ï¼ˆwww.unicode.orgï¼‰ä¸­æ‰¾åˆ°ã€‚ Unicode æ ¹æ®è¦ç¼–ç çš„æ•°æ®ç±»å‹ä½¿ç”¨ä¸¤ç§ç¼–ç æ ¼å¼ï¼š8 ä½å’Œ 16 ä½ã€‚ç¼ºçœç¼–ç æ ¼å¼æ˜¯ 16 ä½ï¼Œå³æ¯ä¸ªå­—ç¬¦æ˜¯ 16 ä½ï¼ˆä¸¤ä¸ªå­—èŠ‚ï¼‰å®½ï¼Œå¹¶ä¸”é€šå¸¸æ˜¾ç¤ºä¸º U+hhhhï¼Œå…¶ä¸­ hhhh æ˜¯å­—ç¬¦çš„åå…­è¿›åˆ¶ä»£ç ç‚¹ã€‚è™½ç„¶ç”Ÿæˆçš„ 65000 å¤šä¸ªä»£ç å…ƒç´ è¶³ä»¥ç”¨äº ç¼–ç ä¸–ç•Œä¸Šä¸»è¦è¯­è¨€çš„å¤§å¤šæ•°å­—ç¬¦ï¼Œä½† Unicode æ ‡å‡†è¿˜æä¾›äº†ä¸€ç§æ‰©å±•æœºåˆ¶ï¼Œå…è®¸ç¼–ç ä¸€ç™¾å¤šä¸‡ä¸ªå­—ç¬¦ã€‚æ‰©å±•æœºåˆ¶ä½¿ç”¨ä¸€å¯¹é«˜ä½å’Œä½ä½ä»£ç”¨å­—ç¬¦æ¥å¯¹æ‰©å±•å­—ç¬¦æˆ–è¡¥å……å­—ç¬¦è¿›è¡Œç¼–ç ã€‚ç¬¬ä¸€ä¸ªï¼ˆæˆ–é«˜ä½ï¼‰ä»£ç”¨å­—ç¬¦å…·æœ‰ U+D800 å’Œ U+DBFF ä¹‹é—´çš„ä»£ç å€¼ï¼Œè€Œç¬¬äºŒä¸ªï¼ˆæˆ–ä½ä½ï¼‰ä»£ç”¨å­—ç¬¦å…·æœ‰ U+DC00 å’Œ U+DFFF ä¹‹é—´çš„ä»£ç å€¼ã€‚ unicodeç å¯ä»¥ç”¨2ä¸ªå­—èŠ‚è¡¨ç¤ºä¸–ç•Œä¸Šçš„ç»å¤§éƒ¨åˆ†å­—ç¬¦ã€‚ ä¸€ä¸ªcharæ˜¯0-65535é—´çš„æ•°å­—ï¼Œä¸€ä¸ªStringå°±æ˜¯ä¸€ä¸²é•¿é•¿é•¿çš„æ•°å­—ã€‚ æ‰€ä»¥DataOutputStream.writeChars(str)çš„æºç æ˜¯è¿™æ ·çš„ï¼š 123456789101112131415161718192021/** * Writes a string to the underlying output stream as a sequence of * characters. Each character is written to the data output stream as * if by the &lt;code&gt;writeChar&lt;/code&gt; method. If no exception is * thrown, the counter &lt;code&gt;written&lt;/code&gt; is incremented by twice * the length of &lt;code&gt;s&lt;/code&gt;. * * @param s a &lt;code&gt;String&lt;/code&gt; value to be written. * @exception IOException if an I/O error occurs. * @see java.io.DataOutputStream#writeChar(int) * @see java.io.FilterOutputStream#out */public final void writeChars(String s) throws IOException &#123; int len = s.length(); for (int i = 0 ; i &lt; len ; i++) &#123; int v = s.charAt(i); out.write((v &gt;&gt;&gt; 8) &amp; 0xFF); // `out.wirte(int)` æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œä¸€æ¬¡ä¼ å…¥ä¸€ä¸ªintï¼Œè€Œ`out.wirte(int)`çš„å®ç°æ€»æ˜¯æŠŠä»–å¼ºè½¬æˆbyteã€‚ out.write((v &gt;&gt;&gt; 0) &amp; 0xFF); &#125; incCount(len * 2);&#125; é‚£ä¹ˆå›åˆ°æ ‡é¢˜ï¼Œ(v &gt;&gt;&gt; 8) &amp; 0xFFã€(v &gt;&gt;&gt; 0) &amp; 0xFFæ˜¯å¹²å˜›çš„ï¼Ÿ 0ï¼ˆé›¶ï¼‰xFFæ˜¯16è¿›åˆ¶çš„255ï¼Œä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶çš„ 1111 1111&amp; AND æŒ‰ä½ä¸æ“ä½œï¼ŒåŒæ—¶ä¸º1æ—¶æ‰æ˜¯1ï¼Œå¦åˆ™ä¸º0.â€”â€”â€”â€”ä½ç§»è¿ç®—è®¡ç®—æœºä¸­å­˜çš„éƒ½æ˜¯æ•°çš„è¡¥ç ï¼Œæ‰€ä»¥ä½ç§»è¿ç®—éƒ½æ˜¯å¯¹è¡¥ç è€Œè¨€çš„â€”â€”â€”â€”&lt;&lt; å·¦ç§» å³è¡¥0&gt;&gt; æœ‰ç¬¦å·å³ç§» å·¦è¡¥ç¬¦å·ä½ï¼Œå³ï¼šå¦‚æœç¬¦å·ä½æ˜¯1 å°±å·¦è¡¥1ï¼Œå¦‚æœç¬¦å·ä½æ˜¯0 å°±å·¦è¡¥0&gt;&gt;&gt; æ— ç¬¦å·å³ç§» ï¼Œé¡¾åæ€ä¹‰ï¼Œç»Ÿä¸€å·¦è¡¥0 ä½ç§»æ“ä½œæ˜¯ä¸ä¼šæ”¹å˜åŸæ¥çš„æ•°çš„ï¼Œå°±åƒStringçš„æ“ä½œéƒ½æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„String int v = s.charAt(i)å¾—åˆ°çš„væ˜¯ä¸€ä¸ªcharå¼ºè½¬çš„intï¼Œè¿™ä¸ªintçš„æœ‰æ•ˆä¿¡æ¯å…¶å®æ˜¯ä½16ä½ï¼ˆintæ˜¯32ä½ï¼Œcharæ˜¯16ä½ï¼‰çš„ä¸¤ä¸ªbyteçš„ä¿¡æ¯ã€‚ é‚£ä¹ˆæ€ä¹ˆè·å¾—è¿™ä¸¤ä¸ªbyteå¹¶ä¸€ä¸€å…¥å‚å‘¢ï¼Ÿ è¿™é‡Œå¯ä»¥æŠŠ&amp;0XFFçœ‹æˆä¸€æŠŠå‰ªåˆ€ï¼Œçœ‹ä¸‹é¢çš„æ“ä½œã€‚ 1000,0000,0000,0011 è¿™æ˜¯ä¸€ä¸ªshortï¼ˆä¸ºä»€ä¹ˆä¸ç”¨charï¼Ÿï¼‰çš„äºŒè¿›åˆ¶ 0000,0000,1000,0000 è¿™æ˜¯&quot;&gt;&gt;&gt;8&quot;çš„ç»“æœ ç„¶åå† &amp;0XFFï¼Œå¾—åˆ° 1000,0000 ï¼ˆå‡†ç¡®çš„è¯´æ˜¯ 0000 0000 1000 0000ï¼‰è¿™å°±æ˜¯ç¬¬ä¸€ä¸ªbyte(ä»é«˜ä½å¼€å§‹)ã€‚ æ¥ç€ 1000,0000,0000,0011 shortçš„äºŒè¿›åˆ¶åŸç  1000,0000,0000,0011 &gt;&gt;&gt;0è¿˜æ˜¯æºç æœ¬èº«ä¸å˜ç„¶åå† &amp;0XFFï¼Œå¾—åˆ° 0000,0011ï¼ˆå‡†ç¡®çš„è¯´æ˜¯ 0000 0000 0000 0011ï¼‰æ‰€ä»¥ &amp;0xFF å°±åƒè®¡ç®—æœºä¸­çš„ä¸€æŠŠå‰ªåˆ€ï¼Œç”¨æ¥æˆªå–ä¸€ä¸ªbyteã€‚åŒç†ï¼Œ&amp;0x0Få‘¢ï¼Ÿå¾—åˆ°4bitsæœ‰æ•ˆå€¼ã€‚ 4. &amp;0xFFå’Œä¸Šé¢çš„bugä»€ä¹ˆå…³ç³»ï¼Ÿæ—¢ç„¶å®é™…ä¸ŠRedisçš„javaå®¢æˆ·ç«¯Jedisçš„ä½å›¾apiæ˜¯è¿™æ ·çš„ public void setbit(byte[] key, long offset, boolean value)offsetæ˜¯ä¸€ä¸ªlongå€¼ï¼Œé‚£ä¹ˆä¼ å…¥ä¸€ä¸ªintç±»å‹çš„hashcodeå¿…ç„¶ä¼šå¼ºè½¬ã€‚å¦‚æœä¸€ä¸ªipæ˜¯128.xxx.xxx.xxxï¼Œé‚£ä¹ˆäºŒè¿›åˆ¶æ˜¯10000000 xxxxxxxx xxxxxxxx xxxxxxxxï¼Œhashcodeå°±æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œä¸€ä¸ªè´Ÿçš„intè½¬æˆlongä¹‹åï¼Œå¯¹äºè®¡ç®—æœºä¸ºäº†ä¿æŒè¡¥ç æ•°å€¼ä¸å˜ï¼Œé«˜ä½å¾—è‡ªåŠ¨è¡¥1ï¼Œæ‰€ä»¥å¾—åˆ° 11111111 11111111 11111111 11111111 10000000 xxxxxxxx xxxxxxxx xxxxxxxxå¯æˆ‘ä»¬æƒ³å¾—åˆ°çš„æœŸæœ›æ•°æ˜¯ 00000000 00000000 00000000 00000000 10000000 xxxxxxxx xxxxxxxx xxxxxxxxè¿™æ—¶å€™æˆ‘ä»¬å°±è¦ä¸€æŠŠå‰ªåˆ€&amp; 0x00000000FFFFFFFFLæ¥å‰ªä¸€ä¸‹ï¼Œå¾—åˆ°æˆ‘ä»¬çš„æœŸæœ›æ•°ã€‚ 5. é¢˜å¤–è¯æ—¢ç„¶æˆ‘ä»¬çš„DataOutputstremæ˜¯è¦writeä¸€ä¸ªbyteï¼Œä¸ºä»€ä¹ˆè¦ç”¨intå…¥å‚å¼•æ¥ä¸€æŠŠå‰ªåˆ€çš„éº»çƒ¦ï¼Œå…¶å®æ˜¯javaæ²¡æœ‰æ— ç¬¦å·æ•°çš„éº»çƒ¦ã€‚ è¿™å…¶å®å’Œread()å¯¹åº”ï¼Œread()æ˜¯è¿”å›0-255çš„æ•°æ®ï¼Œå’Œ -1 ä»£è¡¨æ–‡ä»¶æœ«å°¾ï¼Œæ‰€ä»¥æ²¡æœ‰æ— ç¬¦å·æ•°çš„javaåªèƒ½ç”¨readè¿”å›intã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"BUG","slug":"BUG","permalink":"https://htchz.cc/tags/BUG/"},{"name":"ä½è¿ç®—","slug":"ä½è¿ç®—","permalink":"https://htchz.cc/tags/ä½è¿ç®—/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]HashMapçš„æ‰©å®¹æœºåˆ¶åŠjdk8ä¼˜åŒ–â€”â€”resize()","slug":"JavaåŸºç¡€-HashMapçš„æ‰©å®¹æœºåˆ¶â€”â€”resize","date":"2018-03-16T03:19:00.000Z","updated":"2019-08-21T06:55:50.534Z","comments":true,"path":"92838208.html","link":"","permalink":"https://htchz.cc/92838208.html","excerpt":"æˆ‘ä»¬æ¥è®²è®²jdk8çš„HashMapæ‰©å®¹æœºåˆ¶ã€‚è™½ç„¶ã€ŠJavaé›†åˆ(å…«)HashMapã€‹è´´è¿‡ä»£ç äº†","text":"æˆ‘ä»¬æ¥è®²è®²jdk8çš„HashMapæ‰©å®¹æœºåˆ¶ã€‚è™½ç„¶ã€ŠJavaé›†åˆ(å…«)HashMapã€‹è´´è¿‡ä»£ç äº† 1. ä»€ä¹ˆæ—¶å€™æ‰©å®¹å½“å‘å®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­å½“å‰å®¹å™¨çš„å…ƒç´ ä¸ªæ•°ï¼Œå¦‚æœå¤§äºç­‰äºé˜ˆå€¼â€”â€”å³å½“å‰æ•°ç»„çš„é•¿åº¦ä¹˜ä»¥åŠ è½½å› å­çš„å€¼çš„æ—¶å€™ï¼Œå°±è¦è‡ªåŠ¨æ‰©å®¹å•¦ã€‚ 2. æ‰©å®¹(resize)æ•°ç»„æ˜¯ä¸èƒ½æ‰©å®¹çš„ï¼Œæ‰€ä»¥æ‰©å®¹æ–¹æ³•è‡ªç„¶æ˜¯ä½¿ç”¨ä¸€ä¸ªæ–°çš„æ›´å¤§å®¹é‡çš„æ•°ç»„ä»£æ›¿å·²æœ‰çš„å®¹é‡å°çš„æ•°ç»„ åˆ†æä¸‹resizeçš„æºç ï¼Œé‰´äºJDK1.8èå…¥äº†çº¢é»‘æ ‘ï¼Œè¾ƒå¤æ‚ï¼Œä¸ºäº†ä¾¿äºç†è§£æˆ‘ä»¬ä»ç„¶ä½¿ç”¨JDK1.7çš„ä»£ç ï¼Œå¥½ç†è§£ä¸€äº›ï¼Œæœ¬è´¨ä¸ŠåŒºåˆ«ä¸å¤§ï¼Œå…·ä½“åŒºåˆ«åæ–‡å†è¯´ã€‚ 12345678910111213void resize(int newCapacity) &#123; //ä¼ å…¥æ–°çš„å®¹é‡ Entry[] oldTable = table; //å¼•ç”¨æ‰©å®¹å‰çš„Entryæ•°ç»„ int oldCapacity = oldTable.length; if (oldCapacity == MAXIMUM_CAPACITY) &#123; //æ‰©å®¹å‰çš„æ•°ç»„å¤§å°å¦‚æœå·²ç»è¾¾åˆ°æœ€å¤§(2^30)äº† threshold = Integer.MAX_VALUE; //ä¿®æ”¹é˜ˆå€¼ä¸ºintçš„æœ€å¤§å€¼(2^31-1)ï¼Œè¿™æ ·ä»¥åå°±ä¸ä¼šæ‰©å®¹äº† return; &#125; Entry[] newTable = new Entry[newCapacity]; //åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„Entryæ•°ç»„ transfer(newTable); //ï¼ï¼å°†æ•°æ®è½¬ç§»åˆ°æ–°çš„Entryæ•°ç»„é‡Œ table = newTable; //HashMapçš„tableå±æ€§å¼•ç”¨æ–°çš„Entryæ•°ç»„ threshold = (int) (newCapacity * loadFactor);//ä¿®æ”¹é˜ˆå€¼ &#125; è¿™é‡Œå°±æ˜¯ä½¿ç”¨ä¸€ä¸ªå®¹é‡æ›´å¤§çš„æ•°ç»„æ¥ä»£æ›¿å·²æœ‰çš„å®¹é‡å°çš„æ•°ç»„ï¼Œtransfer()æ–¹æ³•å°†åŸæœ‰Entryæ•°ç»„çš„å…ƒç´ æ‹·è´åˆ°æ–°çš„Entryæ•°ç»„é‡Œã€‚ 1234567891011121314151617void transfer(Entry[] newTable) &#123; Entry[] src = table; //srcå¼•ç”¨äº†æ—§çš„Entryæ•°ç»„ int newCapacity = newTable.length; for (int j = 0; j &lt; src.length; j++) &#123; //éå†æ—§çš„Entryæ•°ç»„ Entry&lt;K, V&gt; e = src[j]; //å–å¾—æ—§Entryæ•°ç»„çš„æ¯ä¸ªå…ƒç´  if (e != null) &#123; src[j] = null;//é‡Šæ”¾æ—§Entryæ•°ç»„çš„å¯¹è±¡å¼•ç”¨ï¼ˆforå¾ªç¯åï¼Œæ—§çš„Entryæ•°ç»„ä¸å†å¼•ç”¨ä»»ä½•å¯¹è±¡ï¼‰ do &#123; Entry&lt;K, V&gt; next = e.next; // ä¿å­˜è¦å¤„ç†çš„entryçš„nextå¯¹è±¡ int i = indexFor(e.hash, newCapacity); //é‡æ–°è®¡ç®—entryåœ¨æ•°ç»„ä¸­çš„ä½ç½® e.next = newTable[i]; //è¿™ä¸ªæ“ä½œå°†æŠŠå¤„ç†çš„entryæ’åˆ°æ–°æ•°ç»„iä½ç½®çš„entryé“¾å¤´éƒ¨ï¼Œç„¶åç»“æœå°±æ˜¯æœ€ç»ˆé“¾è¡¨å€’ç½®å¯ä»¥çœ‹ä¸‹å›¾ newTable[i] = e; //å°†entryæ”¾åœ¨æ–°æ•°ç»„iä½ç½®ä¸Š e = next; //è®¿é—®ä¸‹ä¸€ä¸ªEntryé“¾ä¸Šçš„å…ƒç´  &#125; while (e != null); &#125; &#125; &#125; 123static int indexFor(int h, int length) &#123; return h &amp; (length - 1); // è¿™æ˜¯å–æ¨¡è¿ç®—ï¼Œçœ‹é‚£ç¯‡ã€Š[JDK8]HashMapçš„tableSizeFor()ã€‹ä¸­æœ‰æåˆ°&#125; å‡è®¾äº†æˆ‘ä»¬çš„hashç®—æ³•å°±æ˜¯ç®€å•çš„ç”¨key mod ä¸€ä¸‹è¡¨çš„å¤§å°ï¼ˆä¹Ÿå°±æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ã€‚ å…¶ä¸­çš„å“ˆå¸Œæ¡¶æ•°ç»„tableçš„size=2ï¼Œç°åœ¨æœ‰key = 3ã€7ã€5ï¼Œputé¡ºåºä¾æ¬¡ä¸º 5ã€7ã€3ã€‚åœ¨mod 2ä»¥åéƒ½å†²çªåœ¨table[1]è¿™é‡Œäº†ã€‚è¿™é‡Œå‡è®¾è´Ÿè½½å› å­ loadFactor=1ï¼Œå³å½“é”®å€¼å¯¹çš„å®é™…å¤§å°size å¤§äº tableçš„å®é™…å¤§å°æ—¶è¿›è¡Œæ‰©å®¹ã€‚æ¥ä¸‹æ¥çš„ä¸‰ä¸ªæ­¥éª¤æ˜¯å“ˆå¸Œæ¡¶æ•°ç»„ resizeæˆ4ï¼Œç„¶åæ‰€æœ‰çš„Nodeé‡æ–°rehashçš„è¿‡ç¨‹ã€‚ jdk1.7æ‰©å®¹ä¾‹å›¾ ç»è¿‡è§‚æµ‹å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯2æ¬¡å¹‚çš„æ‰©å±•(æŒ‡é•¿åº¦æ‰©ä¸ºåŸæ¥2å€ï¼Œpower of two)ï¼Œæ‰€ä»¥ï¼Œ ç»è¿‡rehashä¹‹åï¼Œå…ƒç´ çš„ä½ç½®è¦ä¹ˆæ˜¯åœ¨åŸä½ç½®ï¼Œè¦ä¹ˆæ˜¯åœ¨åŸä½ç½®å†ç§»åŠ¨2æ¬¡å¹‚çš„ä½ç½®ã€‚æ‰€ä»¥ï¼Œjdk7çš„å¯¹äºå¤„ç†åè¿˜åœ¨åŸä½ç½®çš„å…ƒç´ çš„æ“ä½œï¼Œå†—ä½™çš„æ“ä½œï¼Œäºæ˜¯jdk8æœ‰äº†ä»¥ä¸‹ä¼˜åŒ–ã€‚ 12345678910/** * Initializes or doubles table size. If null, allocates in * accord with initial capacity target held in field threshold. * Otherwise, because we are using power-of-two expansion, the * elements from each bin must either stay at same index, or move * with a power of two offset in the new table. * * @return the table */ final Node&lt;K,V&gt;[] resize() &#123; çœ‹ä¸‹å›¾å¯ä»¥æ˜ç™½è¿™å¥è¯çš„æ„æ€ï¼Œnä¸ºtableçš„é•¿åº¦ï¼Œå›¾ï¼ˆaï¼‰è¡¨ç¤ºæ‰©å®¹å‰çš„key1å’Œkey2ä¸¤ç§keyç¡®å®šç´¢å¼•ä½ç½®çš„ç¤ºä¾‹ï¼Œå›¾ï¼ˆbï¼‰è¡¨ç¤ºæ‰©å®¹åkey1å’Œkey2ä¸¤ç§keyç¡®å®šç´¢å¼•ä½ç½®çš„ç¤ºä¾‹ï¼Œå…¶ä¸­hash1æ˜¯key1å¯¹åº”çš„å“ˆå¸Œä¸é«˜ä½è¿ç®—ç»“æœã€‚ å…ƒç´ åœ¨é‡æ–°è®¡ç®—hashä¹‹åï¼Œå› ä¸ºnå˜ä¸º2å€ï¼Œé‚£ä¹ˆn-1çš„maskèŒƒå›´åœ¨é«˜ä½å¤š1bit(çº¢è‰²)ï¼Œå› æ­¤æ–°çš„indexå°±ä¼šå‘ç”Ÿè¿™æ ·çš„å˜åŒ–ï¼š å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ‰©å……HashMapçš„æ—¶å€™ï¼Œä¸éœ€è¦åƒJDK1.7çš„å®ç°é‚£æ ·é‡æ–°è®¡ç®—hashï¼Œåªéœ€è¦çœ‹çœ‹åŸæ¥çš„hashå€¼æ–°å¢çš„é‚£ä¸ªbitæ˜¯1è¿˜æ˜¯0å°±å¥½äº†ï¼Œæ˜¯0çš„è¯ç´¢å¼•æ²¡å˜ï¼Œæ˜¯1çš„è¯ç´¢å¼•å˜æˆâ€œåŸç´¢å¼•+oldCapâ€ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹å›¾ä¸º16æ‰©å……ä¸º32çš„resizeç¤ºæ„å›¾ï¼š è¿™ä¸ªè®¾è®¡ç¡®å®éå¸¸çš„å·§å¦™ï¼Œæ—¢çœå»äº†é‡æ–°è®¡ç®—hashå€¼çš„æ—¶é—´ï¼Œè€Œä¸”åŒæ—¶ï¼Œç”±äºæ–°å¢çš„1bitæ˜¯0è¿˜æ˜¯1å¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„ï¼Œå› æ­¤resizeçš„è¿‡ç¨‹ï¼Œå‡åŒ€çš„æŠŠä¹‹å‰çš„å†²çªçš„èŠ‚ç‚¹åˆ†æ•£åˆ°æ–°çš„bucketäº†ã€‚è¿™ä¸€å—å°±æ˜¯JDK1.8æ–°å¢çš„ä¼˜åŒ–ç‚¹ã€‚æœ‰ä¸€ç‚¹æ³¨æ„åŒºåˆ«ï¼ŒJDK1.7ä¸­rehashçš„æ—¶å€™ï¼Œæ—§é“¾è¡¨è¿ç§»æ–°é“¾è¡¨çš„æ—¶å€™ï¼Œå¦‚æœåœ¨æ–°è¡¨çš„æ•°ç»„ç´¢å¼•ä½ç½®ç›¸åŒï¼Œåˆ™é“¾è¡¨å…ƒç´ ä¼šå€’ç½®ï¼Œä½†æ˜¯ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒJDK1.8ä¸ä¼šå€’ç½®ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç ”ç©¶ä¸‹JDK1.8çš„resizeæºç ï¼Œå†™çš„å¾ˆèµï¼Œå¦‚ä¸‹: ä¸‹é¢æ˜¯ä»–çš„å®ç°: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182/** * Initializes or doubles table size. If null, allocates in * accord with initial capacity target held in field threshold. * Otherwise, because we are using power-of-two expansion, the * elements from each bin must either stay at same index, or move * with a power of two offset in the new table. * * @return the table */final Node&lt;K,V&gt;[] resize() &#123; Node&lt;K,V&gt;[] oldTab = table; int oldCap = (oldTab == null) ? 0 : oldTab.length; int oldThr = threshold; int newCap, newThr = 0; if (oldCap &gt; 0) &#123; if (oldCap &gt;= MAXIMUM_CAPACITY) &#123; threshold = Integer.MAX_VALUE; return oldTab; &#125; else if ((newCap = oldCap &lt;&lt; 1) &lt; MAXIMUM_CAPACITY &amp;&amp; oldCap &gt;= DEFAULT_INITIAL_CAPACITY) newThr = oldThr &lt;&lt; 1; // double threshold &#125; else if (oldThr &gt; 0) // initial capacity was placed in threshold newCap = oldThr; else &#123; // zero initial threshold signifies using defaults newCap = DEFAULT_INITIAL_CAPACITY; newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY); &#125; if (newThr == 0) &#123; float ft = (float)newCap * loadFactor; newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (float)MAXIMUM_CAPACITY ? (int)ft : Integer.MAX_VALUE); &#125; threshold = newThr; @SuppressWarnings(&#123;\"rawtypes\",\"unchecked\"&#125;) Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])new Node[newCap]; table = newTab; if (oldTab != null) &#123; for (int j = 0; j &lt; oldCap; ++j) &#123; Node&lt;K,V&gt; e; if ((e = oldTab[j]) != null) &#123; oldTab[j] = null; if (e.next == null) newTab[e.hash &amp; (newCap - 1)] = e; else if (e instanceof TreeNode) ((TreeNode&lt;K,V&gt;)e).split(this, newTab, j, oldCap); else &#123; // preserve order Node&lt;K,V&gt; loHead = null, loTail = null; Node&lt;K,V&gt; hiHead = null, hiTail = null; Node&lt;K,V&gt; next; do &#123; next = e.next; if ((e.hash &amp; oldCap) == 0) &#123; if (loTail == null) loHead = e; else loTail.next = e; loTail = e; &#125; else &#123; if (hiTail == null) hiHead = e; else hiTail.next = e; hiTail = e; &#125; &#125; while ((e = next) != null); if (loTail != null) &#123; loTail.next = null; newTab[j] = loHead; &#125; if (hiTail != null) &#123; hiTail.next = null; newTab[j + oldCap] = hiHead; &#125; &#125; &#125; &#125; &#125; return newTab;&#125;","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"jdk8","slug":"jdk8","permalink":"https://htchz.cc/tags/jdk8/"},{"name":"Javaé›†åˆ","slug":"Javaé›†åˆ","permalink":"https://htchz.cc/tags/Javaé›†åˆ/"}],"author":"åœŸå·"},{"title":"[é›†åˆæ‰©å®¹]HashMapçš„tableSizeFor()","slug":"JDK8-HashMapçš„tableSizeFor","date":"2018-03-15T08:51:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"2353864749.html","link":"","permalink":"https://htchz.cc/2353864749.html","excerpt":"jdk8çš„HashMapæºç é˜…è¯»çš„æ—¶å€™ï¼Œå‘ç°ä¸€ä¸ªtableSizeFor()æ–¹æ³•æ˜¯ä¸€ä¸²ä½è¿ç®—ï¼Œè¿™ä¸ªæ–¹æ³•ç¬¬ä¸€æ¬¡å‡ºç°æ˜¯åœ¨HashMapæŒ‡å®šå®¹é‡çš„æ„é€ å‡½æ•°é‡Œå‡ºç°","text":"jdk8çš„HashMapæºç é˜…è¯»çš„æ—¶å€™ï¼Œå‘ç°ä¸€ä¸ªtableSizeFor()æ–¹æ³•æ˜¯ä¸€ä¸²ä½è¿ç®—ï¼Œè¿™ä¸ªæ–¹æ³•ç¬¬ä¸€æ¬¡å‡ºç°æ˜¯åœ¨HashMapæŒ‡å®šå®¹é‡çš„æ„é€ å‡½æ•°é‡Œå‡ºç° 1. ä»£ç 1234567891011 // Returns a power of two size for the given target capacity. // è¿™æ˜¯æ–¹æ³•çš„æ³¨é‡Š // å¤§è‡´æ„æ€å°±æ˜¯æ‰¾åˆ°å¤§äºç­‰äºæŒ‡å®šå®¹é‡(capacity)å‚æ•°çš„2çš„å¹‚ static final int tableSizeFor(int cap) &#123; int n = cap - 1; n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2; n |= n &gt;&gt;&gt; 4; n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1; &#125; 2. ç›®çš„è¿™æ®µä»£ç çš„ç›®çš„æ³¨å¦‚æ³¨é‡Šæ‰€è¯´ï¼šæ‰¾åˆ°ä¸€ä¸ªæ•°ï¼Œæ»¡è¶³ä¸‹é¢çš„æ¡ä»¶ å®ƒæ˜¯2çš„å¹‚(æœ‰åŠ©äºæé«˜æ€§èƒ½)ï¼Œ å®ƒå¤§äºæˆ–è€…ç­‰äºcapacity æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶çš„æ•°ä¸­æœ€å°(ä¹Ÿå°±æ˜¯æœ€æ¥è¿‘capacity) 3. ä¸ªäººçæ°å¯¹ä¸€ä¸ªæ•°Aï¼Œæ€ä¹ˆæ‰¾ä¸€ä¸ªæ•°B æ»¡è¶³ä¸Šé¢æ¡ä»¶å‘¢ ä¸‹é¢çš„æ–¹æ³•ä¸æ˜¯ä»£ç å¯¹åº”çš„å®ç° æŠŠæ•°è½¬ä¸ºäºŒè¿›åˆ¶ï¼Œæ‰¾åˆ°Açš„æœ€é«˜ä½ï¼Œé‚£ä¹ˆæ•°Bå°±æ˜¯æ•°Aæœ€é«˜ä½å·¦ç§»ä¸€ä½å…¶ä½™ä¸º0çš„æ•°ã€‚ä¸¾ä¸ªä¾‹å­ã€‚ æ¯”å¦‚è¦æ‰¾ç»™å®šçš„æ•°7ï¼Œæ»¡è¶³æ¡ä»¶çš„æ•°æ˜æ˜¾æ˜¯8ã€‚ 8çš„2è¿›åˆ¶ï¼š 0000 1000 7çš„2è¿›åˆ¶ï¼š 0000 0111ä»7å¾—åˆ°8ï¼š æˆ‘ä»¬æŠŠ7çš„æœ€é«˜ä½ç¬¬ä¸‰ä½å·¦ç§»ä¸€ä½ï¼Œå¾—åˆ°0000 1110 å…¶ä½™æ¸…é›¶ï¼Œå¾—åˆ°0000 1000ï¼Œå°±æ˜¯ç›®æ ‡çš„8 ä½†æ˜¯è¿™æ ·æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªæ•°åˆšå¥½æ˜¯2çš„å¹‚ï¼Œæ¯”å¦‚2å¯¹åº”çš„0000 0010ï¼Œé‚£ä¹ˆç»è¿‡å·¦ç§»ã€æ¸…é›¶æ“ä½œï¼Œå¾—åˆ°0000 0100ï¼Œä¹Ÿå°±æ˜¯4ï¼Œæ˜æ˜¾æ¯”æ»¡è¶³æ¡ä»¶çš„æ•°å¤§äº†ä¸€å€ï¼ˆç»™å®š2æ»¡è¶³æ¡ä»¶çš„æ•°è¿˜æ˜¯2ï¼‰ è¿™æ ·è¿˜å¾—åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯ä¸æ˜¯2çš„å¹‚ï¼Œçƒ¦ä¸ï¼Ÿ 4. ä»£ç çš„å®ç°ä»£ç çš„é€»è¾‘æ˜¯ä»‹æ ·çš„ï¼š æˆ‘ä»¬å…ˆä¸çœ‹int n = cap - 1 ç›´æ¥è¯´ä»–çš„ä½ç§»æ“ä½œã€‚é€šè¿‡ä½ç§»æ“ä½œï¼Œä»æœ€é«˜ä½æ˜¯1çš„ä½ç½®å¼€å§‹ï¼Œå¾€ä½ä½ç½®å…¨éƒ¨ç½®ä¸º1(è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡æˆ–æ“ä½œ|å’Œæ— ç¬¦å·å³ç§»&gt;&gt;&gt;æ¥å®ç°çš„ï¼Œæ‹¿è‰ç¨¿çº¸æŒ‰ç…§ä»£ç å†™ä¸€ä¸‹å°±æ¸…æ¥šé€»è¾‘äº†)ï¼Œç„¶å+1ã€‚ ä»7å¾—åˆ°8ï¼š æˆ‘ä»¬æŠŠ7çš„æœ€é«˜ä½å¾€ä½ä½ç½®1ï¼Œå¾—åˆ°0000 0111 æ¥ç€+1ï¼Œå¾—åˆ°0000 1000 è¿™æ ·è¿˜æ˜¯æ²¡è§£å†³â€œä¸€ä¸ªæ•°åˆšå¥½æ˜¯2çš„å¹‚â€çš„é—®é¢˜ï¼Œäºæ˜¯æœ‰äº†é‚£ä¸€è¡Œint n = cap - 1ï¼Œè¿™ä¸ªå‡ä¸€æ“ä½œå¯ä»¥å®Œç¾é¿å…â€œåˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯ä¸æ˜¯2çš„å¹‚â€ã€‚ å¦‚æœä¸€ä¸ªæ•°ä¸æ˜¯2çš„å¹‚ï¼Œå‡ä¸€æ“ä½œåï¼Œæœ€ç»ˆä¼šè¢«ç½®1æ“ä½œè¡¥å¿å›æ¥ã€‚ å¦‚æœä¸€ä¸ªæ•°æ˜¯2çš„å¹‚ï¼Œå‡ä¸€æ“ä½œåï¼Œå¯ä»¥æŠŠè¿™ä¸ªæ•°ç¼©å°ä¸€å€ï¼Œæœ€åç½®1ã€+1æ“ä½œä¼šæŠŠæ•°è¿˜åŸã€‚ ï¼ˆå®Œï¼‰ ** å…¶å®è¿˜æ²¡å®Œï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆæ‰§ç€äºæŠŠå®¹é‡æ”¹æˆ2çš„å¹‚ï¼Ÿ** å…¶å®HashMapåœ¨æ ¹æ®hashcodeå–æ•°ç»„ä¸‹æ ‡çš„æ—¶å€™ï¼Œä»£ç æ˜¯è¿™æ ·çš„ 123static int indexFor(int h, int length) &#123; return h &amp; (length - 1); &#125; è¿™ä¸ªh &amp; (length - 1)è¿™æ˜¯ä¸€ä¸ªå–æ¨¡æ“ä½œ å–æ¨¡ç®—æ³•ä¸­çš„é™¤æ³•è¿ç®—æ•ˆç‡å¾ˆä½ï¼Œåœ¨HashMapä¸­é€šè¿‡h&amp;ï¼ˆn-1ï¼‰æ›¿ä»£å–æ¨¡ï¼Œå¾—åˆ°æ‰€åœ¨æ•°ç»„ä½ç½®ï¼Œæ•ˆç‡ä¼šé«˜å¾ˆå¤šã€‚ï¼ˆå‰ææ˜¯ä¿è¯æ•°ç»„çš„å®¹é‡æ˜¯2çš„æ•´æ•°å€ï¼‰ ï¼ˆå®Œï¼‰","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"Javaé›†åˆ","slug":"Javaé›†åˆ","permalink":"https://htchz.cc/tags/Javaé›†åˆ/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]Integerä¸int","slug":"JavaåŸºç¡€-Integerä¸int","date":"2018-03-13T02:27:00.000Z","updated":"2019-08-18T11:26:12.743Z","comments":true,"path":"1834665960.html","link":"","permalink":"https://htchz.cc/1834665960.html","excerpt":"è´´ä»£ç :","text":"è´´ä»£ç : 1234567891011121314151617181920public static void main(String[] args) &#123; int i = 128; Integer i2 = 128; Integer i3 = new Integer(128); //Integerä¼šè‡ªåŠ¨æ‹†ç®±ä¸ºintï¼Œæ‰€ä»¥ä¸ºtrue System.out.println(i == i2); System.out.println(i == i3); System.out.println(&quot;**************&quot;); Integer i5 = 127;//javaåœ¨ç¼–è¯‘çš„æ—¶å€™,è¢«ç¿»è¯‘æˆ-&gt; Integer i5 = Integer.valueOf(127); Integer i6 = 127; System.out.println(i5 == i6);//true /*Integer i5 = 128; Integer i6 = 128; System.out.println(i5 == i6);//false*/ Integer ii5 = new Integer(127); System.out.println(i5 == ii5); //false Integer i7 = new Integer(128); Integer i8 = new Integer(123); System.out.println(i7 == i8); //false&#125; 11 è¡Œä¸ºtrueï¼Œ16è¡Œä¸ºfalseï¼Œæ˜¯å› ä¸ºï¼š javaåœ¨ç¼–è¯‘Integer i5 = 127çš„æ—¶å€™,è¢«ç¿»è¯‘æˆ-&gt; Integer i5 = Integer.valueOf(127);æ‰€ä»¥å…³é”®å°±æ˜¯çœ‹valueOf()å‡½æ•°äº†ã€‚åªè¦çœ‹çœ‹valueOf()å‡½æ•°çš„æºç å°±ä¼šæ˜ç™½äº†ã€‚JDKæºç çš„valueOfå‡½æ•°å¼è¿™æ ·çš„ï¼š 123456public static Integer valueOf(int i) &#123; assert IntegerCache.high &gt;= 127; if (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high) return IntegerCache.cache[i + (-IntegerCache.low)]; return new Integer(i);&#125; 1. æ€»ç»“ æ— è®ºå¦‚ä½•ï¼ŒIntegerä¸new Integerä¸ä¼šç›¸ç­‰ã€‚ä¸ä¼šç»å†æ‹†ç®±è¿‡ç¨‹ï¼Œi3çš„å¼•ç”¨æŒ‡å‘å †ï¼Œè€Œi4æŒ‡å‘ä¸“é—¨å­˜æ”¾ä»–çš„å†…å­˜ï¼ˆå¸¸é‡æ± ï¼‰ï¼Œä»–ä»¬çš„å†…å­˜åœ°å€ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¸ºfalse ä¸¤ä¸ªéƒ½æ˜¯énewå‡ºæ¥çš„Integerï¼Œå¦‚æœæ•°åœ¨-128åˆ°127ä¹‹é—´ï¼Œåˆ™æ˜¯true,å¦åˆ™ä¸ºfalseï¼ˆIntegerçš„ç¼“å­˜ï¼‰javaåœ¨ç¼–è¯‘Integer i2 = 128çš„æ—¶å€™,è¢«ç¿»è¯‘æˆ-&gt; Integer i2 = Integer.valueOf(128);è€ŒvalueOf()å‡½æ•°ä¼šå¯¹-128åˆ°127ä¹‹é—´çš„æ•°è¿›è¡Œç¼“å­˜ ä¸¤ä¸ªéƒ½æ˜¯newå‡ºæ¥çš„,éƒ½ä¸ºfalse intå’Œinteger(æ— è®ºnewå¦)æ¯”ï¼Œéƒ½ä¸ºtrueï¼Œå› ä¸ºä¼šæŠŠIntegerè‡ªåŠ¨æ‹†ç®±ä¸ºintå†å»æ¯”","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"JVM","slug":"JVM","permalink":"https://htchz.cc/tags/JVM/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]LongAdder","slug":"JavaåŸºç¡€-LongAdder","date":"2018-03-13T02:07:00.000Z","updated":"2019-08-21T06:40:10.205Z","comments":true,"path":"973885938.html","link":"","permalink":"https://htchz.cc/973885938.html","excerpt":"","text":"1. å‰è¨€LongAdderæ˜¯jdk8æ–°å¢çš„ç”¨äºå¹¶å‘ç¯å¢ƒçš„è®¡æ•°å™¨ï¼Œç›®çš„æ˜¯ä¸ºäº†åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œä»£æ›¿AtomicLong/AtomicIntï¼Œæˆä¸ºä¸€ä¸ªç”¨äºé«˜å¹¶å‘æƒ…å†µä¸‹çš„é«˜æ•ˆçš„é€šç”¨è®¡æ•°å™¨ã€‚é«˜å¹¶å‘ä¸‹è®¡æ•°ï¼Œä¸€èˆ¬æœ€å…ˆæƒ³åˆ°çš„åº”è¯¥æ˜¯AtomicLong/AtomicIntï¼ŒAtmoicXXXä½¿ç”¨ç¡¬ä»¶çº§åˆ«çš„æŒ‡ä»¤ CAS æ¥æ›´æ–°è®¡æ•°å™¨çš„å€¼ï¼Œè¿™æ ·å¯ä»¥é¿å…åŠ é”ï¼Œæœºå™¨ç›´æ¥æ”¯æŒçš„æŒ‡ä»¤ï¼Œæ•ˆç‡ä¹Ÿå¾ˆé«˜ã€‚ä½†æ˜¯AtomicXXXä¸­çš„ CAS æ“ä½œåœ¨å‡ºç°çº¿ç¨‹ç«äº‰æ—¶ï¼Œå¤±è´¥çš„çº¿ç¨‹ä¼šç™½ç™½åœ°å¾ªç¯ä¸€æ¬¡ï¼Œåœ¨å¹¶å‘å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå› ä¸ºæ¯æ¬¡CASéƒ½åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸï¼Œç«äº‰å¤±è´¥çš„çº¿ç¨‹ä¼šéå¸¸å¤šã€‚å¤±è´¥æ¬¡æ•°è¶Šå¤šï¼Œå¾ªç¯æ¬¡æ•°å°±è¶Šå¤šï¼Œå¾ˆå¤šçº¿ç¨‹çš„CASæ“ä½œè¶Šæ¥è¶Šæ¥è¿‘ è‡ªæ—‹é”ï¼ˆspin lockï¼‰ã€‚è®¡æ•°æ“ä½œæœ¬æ¥æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ“ä½œï¼Œå®é™…éœ€è¦è€—è´¹çš„cpuæ—¶é—´åº”è¯¥æ˜¯è¶Šå°‘è¶Šå¥½ï¼ŒAtomicXXXåœ¨é«˜å¹¶å‘è®¡æ•°æ—¶ï¼Œå¤§é‡çš„cpuæ—¶é—´éƒ½æµªè´¹ä¼šåœ¨è‡ªæ—‹ä¸Šäº†ï¼Œè¿™å¾ˆæµªè´¹ï¼Œä¹Ÿé™ä½äº†å®é™…çš„è®¡æ•°æ•ˆç‡ã€‚ 12345678910// jdk1.8çš„AtomicLongçš„å®ç°ä»£ç ï¼Œè¿™æ®µä»£ç åœ¨sun.misc.Unsafeä¸­ // å½“çº¿ç¨‹ç«äº‰å¾ˆæ¿€çƒˆæ—¶ï¼Œwhileåˆ¤æ–­æ¡ä»¶ä¸­çš„CASä¼šè¿ç»­å¤šæ¬¡è¿”å›falseï¼Œè¿™æ ·å°±ä¼šé€ æˆæ— ç”¨çš„å¾ªç¯ï¼Œå¾ªç¯ä¸­è¯»å–volatileå˜é‡çš„å¼€é”€æœ¬æ¥å°±æ˜¯æ¯”è¾ƒé«˜çš„ // å› ä¸ºè¿™æ ·ï¼Œåœ¨é«˜å¹¶å‘æ—¶ï¼ŒAtomicXXXå¹¶ä¸æ˜¯é‚£ä¹ˆç†æƒ³çš„è®¡æ•°æ–¹å¼ public final long getAndAddLong(Object o, long offset, long delta) &#123; long v; do &#123; v = getLongVolatile(o, offset); &#125; while (!compareAndSwapLong(o, offset, v, v + delta)); return v; &#125; ç°åœ¨ï¼Œåœ¨å¤„ç†é«˜å¹¶å‘è®¡æ•°æ—¶ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨LongAdderï¼Œè€Œä¸æ˜¯ç»§ç»­ä½¿ç”¨AtomicLongã€‚å½“ç„¶ï¼Œçº¿ç¨‹ç«äº‰å¾ˆä½çš„æƒ…å†µä¸‹è¿›è¡Œè®¡æ•°ï¼Œä½¿ç”¨Atomicè¿˜æ˜¯æ›´ç®€å•æ›´ç›´æ¥ï¼Œå¹¶ä¸”æ•ˆç‡ç¨å¾®é«˜ä¸€äº›ã€‚å…¶ä»–æƒ…å†µï¼Œæ¯”å¦‚åºå·ç”Ÿæˆï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦å‡†ç¡®çš„æ•°å€¼ï¼Œå…¨å±€å”¯ä¸€çš„AtomicLongæ‰æ˜¯æ­£ç¡®çš„é€‰æ‹©ï¼Œæ­¤æ—¶ä¸åº”è¯¥ä½¿ç”¨LongAdderã€‚ ä¸‹é¢ç®€è¦åˆ†æä¸‹LongAdderçš„æºç ï¼Œæœ‰äº†ConcurrentHashMapï¼ˆLongAdderæ¯”è¾ƒåƒ1.6å’Œ1.7çš„ï¼Œå¯ä»¥çœ‹ä¸‹1.7çš„ï¼‰çš„åŸºç¡€ï¼Œè¿™ä¸ªç±»çš„æºç çœ‹èµ·æ¥ä¹Ÿä¸å¤æ‚ã€‚ 2. ç±»çš„å…³ç³» å…¬å…±çˆ¶ç±»Striped64æ˜¯å®ç°ä¸­çš„æ ¸å¿ƒï¼Œå®ƒå®ç°ä¸€äº›æ ¸å¿ƒæ“ä½œï¼Œå¤„ç†64ä½æ•°æ®ï¼Œå¾ˆå®¹æ˜“å°±èƒ½è½¬åŒ–ä¸ºå…¶ä»–åŸºæœ¬ç±»å‹ï¼Œæ˜¯ä¸ªé€šç”¨çš„ç±»ã€‚äºŒå…ƒç®—æœ¯è¿ç®—ç´¯ç§¯ï¼ŒæŒ‡çš„æ˜¯ä½ å¯ä»¥ç»™å®ƒæä¾›ä¸€ä¸ªäºŒå…ƒç®—æœ¯æ–¹å¼ï¼Œè¿™ä¸ªç±»æŒ‰ç…§ä½ æä¾›çš„æ–¹å¼è¿›è¡Œç®—æœ¯è®¡ç®—ï¼Œå¹¶ä¿å­˜è®¡ç®—ç»“æœã€‚äºŒå…ƒè¿ç®—ä¸­ç¬¬ä¸€ä¸ªæ“ä½œæ•°æ˜¯ç´¯ç§¯å™¨ä¸­æŸä¸ªè®¡æ•°å•å…ƒå½“å‰çš„å€¼ï¼Œå¦å¤–ä¸€ä¸ªå€¼æ˜¯å¤–éƒ¨æä¾›çš„ã€‚ä¸¾å‡ ä¸ªä¾‹å­ï¼šå‡è®¾æ¯æ¬¡æ“ä½œéƒ½éœ€è¦æŠŠåŸæ¥çš„æ•°å€¼åŠ ä¸ŠæŸä¸ªå€¼ï¼Œé‚£ä¹ˆäºŒå…ƒè¿ç®—ä¸º (x, y) -&gt; x+yï¼Œè¿™æ ·ç´¯ç§¯å™¨æ¯æ¬¡éƒ½ä¼šåŠ ä¸Šä½ æä¾›çš„æ•°å­—yï¼Œè¿™è·ŸLongAdderçš„åŠŸèƒ½åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼›å‡è®¾æ¯æ¬¡æ“ä½œéƒ½éœ€è¦æŠŠåŸæ¥çš„æ•°å€¼å˜ä¸ºå®ƒçš„æŸä¸ªå€æ•°ï¼Œé‚£ä¹ˆå¯ä»¥æŒ‡å®šäºŒå…ƒè¿ç®—ä¸º (x, y) -&gt; xyï¼Œç´¯ç§¯å™¨æ¯æ¬¡éƒ½ä¼šä¹˜ä»¥ä½ æä¾›çš„æ•°å­—yï¼Œy=2æ—¶å°±æ˜¯é€šå¸¸æ‰€è¯´çš„æ¯æ¬¡éƒ½ç¿»ä¸€å€ï¼›å‡è®¾æ¯æ¬¡æ“ä½œéƒ½éœ€è¦æŠŠåŸæ¥çš„æ•°å€¼å˜æˆå®ƒçš„5å€ï¼Œå†åŠ ä¸Š3ï¼Œå†é™¤ä»¥2ï¼Œå†å‡å»4ï¼Œå†ä¹˜ä»¥ä½ ç»™å®šçš„æ•°ï¼Œæœ€åè¿˜è¦åŠ ä¸Š6ï¼Œé‚£ä¹ˆäºŒå…ƒè¿ç®—ä¸º (x, y) -&gt; ((x5+3)/2 - 4)y +6ï¼Œç´¯ç§¯å™¨æ¯æ¬¡ç´¯ç§¯æ“ä½œéƒ½ä¼šæŒ‰ç…§ä½ è¯´çš„åšï¼›â€¦â€¦LongAccumulatoræ˜¯æ ‡å‡†çš„å®ç°ç±»ï¼ŒLongAdderæ˜¯ç‰¹åŒ–çš„å®ç°ç±»ï¼Œå®ƒçš„åŠŸèƒ½ç­‰ä»·äºLongAccumulator((x, y) -&gt; x+y, 0L)ã€‚å®ƒä»¬çš„åŒºåˆ«å¾ˆç®€å•ï¼Œå‰è€…å¯ä»¥è¿›è¡Œä»»ä½•äºŒå…ƒç®—æœ¯æ“ä½œï¼Œåè€…åªèƒ½è¿›è¡ŒåŠ å‡ä¸¤ç§ç®—æœ¯æ“ä½œã€‚Doubleç‰ˆæœ¬æ˜¯Longç‰ˆæœ¬çš„ç®€å•æ”¹è£…ï¼Œç›¸å¯¹Longç‰ˆæœ¬ï¼Œä¸»è¦çš„å˜åŒ–å°±æ˜¯ç”¨Double.longBitsToDouble å’ŒDouble.doubleToRawLongBitså¯¹åº•å±‚çš„8å­—èŠ‚æ•°æ®è¿›è¡Œlong &lt;â€”&gt; doubleè½¬æ¢ï¼Œå­˜å‚¨çš„æ—¶å€™ä½¿ç”¨longå‹ï¼Œè®¡ç®—çš„æ—¶å€™è½¬åŒ–ä¸ºdoubleå‹ã€‚è¿™æ˜¯å› ä¸ºCASæ˜¯sun.misc.Unsafeä¸­æä¾›çš„æ“ä½œï¼Œåªå¯¹intã€longã€å¯¹è±¡ç±»å‹ï¼ˆå¼•ç”¨æˆ–è€…æŒ‡é’ˆï¼‰æä¾›äº†è¿™ç§æ“ä½œï¼Œå…¶ä»–ç±»å‹éƒ½éœ€è¦è½¬åŒ–ä¸ºè¿™ä¸‰ç§ç±»å‹æ‰èƒ½è¿›è¡ŒCASæ“ä½œã€‚è¿™é‡Œçš„longå‹ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯8å­—èŠ‚çš„åŸå§‹ç±»å‹ï¼Œå› ä¸ºæŠŠå®ƒè§†ä¸ºlongç±»å‹æ˜¯æ— æ„ä¹‰çš„ã€‚javaä¸­æ²¡æœ‰Cè¯­è¨€ä¸­çš„ void æ— ç±»å‹ï¼ˆæˆ–è€…å«åŸå§‹ç±»å‹ï¼‰ï¼Œåªèƒ½ç”¨æœ€æ¥è¿‘çš„longç±»å‹æ¥ä»£æ›¿ã€‚ å››ä¸ªå®ç°ç±»çš„åŒºåˆ«å°±ä¸Šé¢è¿™ä¸¤å¥è¯ï¼Œè¿™é‡Œåªè®²LongAdderä¸€ä¸ªç±»ã€‚ 3. æ ¸å¿ƒå®ç°Striped64å››ä¸ªç±»çš„æ ¸å¿ƒå®ç°éƒ½åœ¨Striped64ä¸­ï¼Œè¿™ä¸ªç±»ä½¿ç”¨åˆ†æ®µçš„æ€æƒ³ï¼Œæ¥å°½é‡å¹³æ‘Šå¹¶å‘å‹åŠ›ã€‚ç±»ä¼¼1.7åŠä»¥å‰ç‰ˆæœ¬çš„ConcurrentHashMap.Segmentï¼ŒStriped64ä¸­ä½¿ç”¨äº†ä¸€ä¸ªå«Cellçš„ç±»ï¼Œæ˜¯ä¸€ä¸ªæ™®é€šçš„äºŒå…ƒç®—æœ¯ç´¯ç§¯å•å…ƒï¼Œçº¿ç¨‹ä¹Ÿæ˜¯é€šè¿‡hashå–æ¨¡æ“ä½œæ˜ å°„åˆ°ä¸€ä¸ªCellä¸Šè¿›è¡Œç´¯ç§¯ã€‚ä¸ºäº†åŠ å¿«å–æ¨¡è¿ç®—æ•ˆç‡ï¼Œä¹ŸæŠŠCellæ•°ç»„çš„å¤§å°è®¾ç½®ä¸º2^nï¼ŒåŒæ—¶å¤§é‡ä½¿ç”¨Unsafeæä¾›çš„åº•å±‚æ“ä½œã€‚åŸºæœ¬çš„å®ç°æ¡¶1.7çš„ConcurrentHashMapéå¸¸åƒï¼Œè€Œä¸”æ›´ç®€å•ã€‚ 3.1. ç´¯ç§¯å•å…ƒCellçœ‹åˆ°è¿™é‡Œæˆ‘æƒ³äº†ä¸€ä¸ªçœ‹ä¼¼ç®€å•çš„é—®é¢˜ï¼šæ—¢ç„¶Cellè¿™ä¹ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªlongå‹å˜é‡ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨long valueï¼Ÿé¦–å…ˆå£°æ˜ä¸‹ï¼ŒUnsafeæä¾›çš„æ“ä½œå¾ˆå¼ºå¤§ï¼Œä¹Ÿèƒ½å¯¹æ•°ç»„çš„å…ƒç´ è¿›è¡Œvolatileè¯»å†™ï¼ŒåŒæ—¶æ•°ç»„è®¡ç®—æŸä¸ªå…ƒç´ çš„offsetåç§»é‡æœ¬èº«å°±å¾ˆç®€å•ï¼Œå› æ­¤volatileã€casè¿™ç§ç«™ä¸ä½è„šã€‚è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºï¼šï¼ˆç”¨å¯¹è±¡å°è£…ï¼Œä¿è¯å¯¹è±¡çš„å¼•ç”¨æ”¹å˜æ—¶ï¼Œèƒ½ä¿è¯æ”¹å˜çš„valueä¸ä¼šä¸¢å¤±ï¼‰ 1234567891011121314151617181920212223// å¾ˆç®€å•çš„ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªç®€åŒ–çš„AtomicLong // é€šè¿‡casæ“ä½œæ¥æ›´æ–°valueçš„å€¼ // @sun.misc.Contendedæ˜¯ä¸€ä¸ªé«˜ç«¯çš„æ³¨è§£ï¼Œä»£è¡¨ä½¿ç”¨ç¼“å­˜è¡Œå¡«æ¥é¿å…ä¼ªå…±äº«ï¼Œå¯ä»¥è‡ªå·±ç½‘ä¸Šæœä¸‹ï¼Œè¿™ä¸ªæˆ‘å°±ä¸ç»†è¯´äº† @sun.misc.Contended static final class Cell &#123; volatile long value; Cell(long x) &#123; value = x; &#125; final boolean cas(long cmp, long val) &#123; return UNSAFE.compareAndSwapLong(this, valueOffset, cmp, val); &#125; // Unsafe mechanics Unsafeç›¸å…³çš„åˆå§‹åŒ– private static final sun.misc.Unsafe UNSAFE; private static final long valueOffset; static &#123; try &#123; UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; ak = Cell.class; valueOffset = UNSAFE.objectFieldOffset (ak.getDeclaredField(\"value\")); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125; &#125; 3.2. Striped64ä¸»ä½“ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159abstract class Striped64 extends Number &#123; @sun.misc.Contended static final class Cell &#123; ... &#125; /** Number of CPUS, to place bound on table size */ static final int NCPU = Runtime.getRuntime().availableProcessors(); // cellæ•°ç»„ï¼Œé•¿åº¦ä¸€æ ·è¦æ˜¯2^nï¼Œå¯ä»¥ç±»æ¯”ä¸ºjdk1.7çš„ConcurrentHashMapä¸­çš„segmentsæ•°ç»„ transient volatile Cell[] cells; // ç´¯ç§¯å™¨çš„åŸºæœ¬å€¼ï¼Œåœ¨ä¸¤ç§æƒ…å†µä¸‹ä¼šä½¿ç”¨ï¼š // 1ã€æ²¡æœ‰é‡åˆ°å¹¶å‘çš„æƒ…å†µï¼Œç›´æ¥ä½¿ç”¨baseï¼Œé€Ÿåº¦æ›´å¿«ï¼› // 2ã€å¤šçº¿ç¨‹å¹¶å‘åˆå§‹åŒ–tableæ•°ç»„æ—¶ï¼Œå¿…é¡»è¦ä¿è¯tableæ•°ç»„åªè¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œå› æ­¤åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç«äº‰æˆåŠŸï¼Œè¿™ç§æƒ…å†µä¸‹ç«äº‰å¤±è´¥çš„çº¿ç¨‹ä¼šå°è¯•åœ¨baseä¸Šè¿›è¡Œä¸€æ¬¡ç´¯ç§¯æ“ä½œ transient volatile long base; // è‡ªæ—‹æ ‡è¯†ï¼Œåœ¨å¯¹cellsè¿›è¡Œåˆå§‹åŒ–ï¼Œæˆ–è€…åç»­æ‰©å®¹æ—¶ï¼Œéœ€è¦é€šè¿‡CASæ“ä½œæŠŠæ­¤æ ‡è¯†è®¾ç½®ä¸º1ï¼ˆbusyï¼Œå¿™æ ‡è¯†ï¼Œç›¸å½“äºåŠ é”ï¼‰ï¼Œå–æ¶ˆbusyæ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨cellsBusy = 0ï¼Œç›¸å½“äºé‡Šæ”¾é” transient volatile int cellsBusy; Striped64() &#123; &#125; // ä½¿ç”¨CASæ›´æ–°baseçš„å€¼ final boolean casBase(long cmp, long val) &#123; return UNSAFE.compareAndSwapLong(this, BASE, cmp, val); &#125; // ä½¿ç”¨CASå°†cellsè‡ªæ—‹æ ‡è¯†æ›´æ–°ä¸º1 // æ›´æ–°ä¸º0æ—¶å¯ä»¥ä¸ç”¨CASï¼Œç›´æ¥ä½¿ç”¨cellsBusyå°±è¡Œ final boolean casCellsBusy() &#123; return UNSAFE.compareAndSwapInt(this, CELLSBUSY, 0, 1); &#125; // ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯ThreadLocalRandomä¸­çš„æ–¹æ³•ï¼Œä¸è¿‡å› ä¸ºåŒ…è®¿é—®å…³ç³»ï¼Œè¿™é‡Œåˆé‡æ–°å†™ä¸€é // probeç¿»è¯‘è¿‡æ¥æ˜¯æ¢æµ‹/æ¢æµ‹å™¨/æ¢é’ˆè¿™äº›ï¼Œä¸å¥½ç†è§£ï¼Œå®ƒæ˜¯ThreadLocalRandomé‡Œé¢çš„ä¸€ä¸ªå±æ€§ï¼Œ // ä¸è¿‡å¹¶ä¸å½±å“å¯¹Striped64çš„ç†è§£ï¼Œè¿™é‡Œå¯ä»¥æŠŠå®ƒç†è§£ä¸ºçº¿ç¨‹æœ¬èº«çš„hashå€¼ static final int getProbe() &#123; return UNSAFE.getInt(Thread.currentThread(), PROBE); &#125; // ç›¸å½“äºrehashï¼Œé‡æ–°ç®—ä¸€éçº¿ç¨‹çš„hashå€¼ static final int advanceProbe(int probe) &#123; probe ^= probe &lt;&lt; 13; // xorshift probe ^= probe &gt;&gt;&gt; 17; probe ^= probe &lt;&lt; 5; UNSAFE.putInt(Thread.currentThread(), PROBE, probe); return probe; &#125; /** * æ ¸å¿ƒæ–¹æ³•çš„å®ç°ï¼Œæ­¤æ–¹æ³•å»ºè®®åœ¨å¤–éƒ¨è¿›è¡Œä¸€æ¬¡CASæ“ä½œï¼ˆcell != nullæ—¶å°è¯•CASæ›´æ–°baseå€¼ï¼Œcells != nullæ—¶ï¼ŒCASæ›´æ–°hashå€¼å–æ¨¡åå¯¹åº”çš„cell.valueï¼‰ * @param x the value å‰é¢æˆ‘è¯´çš„äºŒå…ƒè¿ç®—ä¸­çš„ç¬¬äºŒä¸ªæ“ä½œæ•°ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨æä¾›çš„é‚£ä¸ªæ“ä½œæ•° * @param fn the update function, or null for add (this convention avoids the need for an extra field or function in LongAdder). * å¤–éƒ¨æä¾›çš„äºŒå…ƒç®—æœ¯æ“ä½œï¼Œå®ä¾‹æŒæœ‰å¹¶ä¸”åªèƒ½æœ‰ä¸€ä¸ªï¼Œç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜ï¼Œnullä»£è¡¨LongAdderè¿™ç§ç‰¹æ®Šä½†æ˜¯æœ€å¸¸ç”¨çš„æƒ…å†µï¼Œå¯ä»¥å‡å°‘ä¸€æ¬¡æ–¹æ³•è°ƒç”¨ * @param wasUncontended false if CAS failed before call å¦‚æœä¸ºfalseï¼Œè¡¨æ˜è°ƒç”¨è€…é¢„å…ˆè°ƒç”¨çš„ä¸€æ¬¡CASæ“ä½œéƒ½å¤±è´¥äº† */ final void longAccumulate(long x, LongBinaryOperator fn, boolean wasUncontended) &#123; int h; // è¿™ä¸ªifç›¸å½“äºç»™çº¿ç¨‹ç”Ÿæˆä¸€ä¸ªé0çš„hashå€¼ if ((h = getProbe()) == 0) &#123; ThreadLocalRandom.current(); // force initialization h = getProbe(); wasUncontended = true; &#125; boolean collide = false; // True if last slot nonempty å¦‚æœhashå–æ¨¡æ˜ å°„å¾—åˆ°çš„Cellå•å…ƒä¸æ˜¯nullï¼Œåˆ™ä¸ºtrueï¼Œæ­¤å€¼ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯æ‰©å®¹æ„å‘ï¼Œæ„Ÿè§‰è¿™ä¸ªæ›´å¥½ç†è§£ for (;;) &#123; Cell[] as; Cell a; int n; long v; if ((as = cells) != null &amp;&amp; (n = as.length) &gt; 0) &#123; // cellså·²ç»è¢«åˆå§‹åŒ–äº† if ((a = as[(n - 1) &amp; h]) == null) &#123; // hashå–æ¨¡æ˜ å°„å¾—åˆ°çš„Cellå•å…ƒè¿˜ä¸ºnullï¼ˆä¸ºnullè¡¨ç¤ºè¿˜æ²¡æœ‰è¢«ä½¿ç”¨ï¼‰ if (cellsBusy == 0) &#123; // Try to attach new Cell å¦‚æœæ²¡æœ‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œæ‰©å®¹ Cell r = new Cell(x); // Optimistically create å…ˆåˆ›å»ºæ–°çš„ç´¯ç§¯å•å…ƒ if (cellsBusy == 0 &amp;&amp; casCellsBusy()) &#123; // å°è¯•åŠ é” boolean created = false; try &#123; // Recheck under lock åœ¨æœ‰é”çš„æƒ…å†µä¸‹å†æ£€æµ‹ä¸€éä¹‹å‰çš„åˆ¤æ–­ Cell[] rs; int m, j; if ((rs = cells) != null &amp;&amp; (m = rs.length) &gt; 0 &amp;&amp; rs[j = (m - 1) &amp; h] == null) &#123; // è€ƒè™‘åˆ«çš„çº¿ç¨‹å¯èƒ½æ‰§è¡Œäº†æ‰©å®¹ï¼Œè¿™é‡Œé‡æ–°èµ‹å€¼é‡æ–°åˆ¤æ–­ rs[j] = r; // å¯¹æ²¡æœ‰ä½¿ç”¨çš„Cellå•å…ƒè¿›è¡Œç´¯ç§¯æ“ä½œï¼ˆç¬¬ä¸€æ¬¡èµ‹å€¼ç›¸å½“äºæ˜¯ç´¯ç§¯ä¸Šä¸€ä¸ªæ“ä½œæ•°ï¼Œæ±‚å’Œæ—¶å†å’Œbaseæ‰§è¡Œä¸€æ¬¡è¿ç®—å°±å¾—åˆ°å®é™…çš„ç»“æœï¼‰ created = true; &#125; &#125; finally &#123; cellsBusy = 0; æ¸…ç©ºè‡ªæ—‹æ ‡è¯†ï¼Œé‡Šæ”¾é” &#125; if (created) // å¦‚æœåŸæœ¬ä¸ºnullçš„Cellå•å…ƒæ˜¯ç”±è‡ªå·±è¿›è¡Œç¬¬ä¸€æ¬¡ç´¯ç§¯æ“ä½œï¼Œé‚£ä¹ˆä»»åŠ¡å·²ç»å®Œæˆäº†ï¼Œæ‰€ä»¥å¯ä»¥é€€å‡ºå¾ªç¯ break; continue; // Slot is now non-empty ä¸æ˜¯è‡ªå·±è¿›è¡Œç¬¬ä¸€æ¬¡ç´¯ç§¯æ“ä½œï¼Œé‡å¤´å†æ¥ &#125; &#125; collide = false; // æ‰§è¡Œè¿™ä¸€å¥æ˜¯å› ä¸ºcellsè¢«åŠ é”äº†ï¼Œä¸èƒ½å¾€ä¸‹ç»§ç»­æ‰§è¡Œç¬¬ä¸€æ¬¡çš„èµ‹å€¼æ“ä½œï¼ˆç¬¬ä¸€æ¬¡ç´¯ç§¯ï¼‰ï¼Œæ‰€ä»¥è¿˜ä¸èƒ½è€ƒè™‘æ‰©å®¹ &#125; else if (!wasUncontended) // CAS already known to fail å‰é¢ä¸€æ¬¡CASæ›´æ–°a.valueï¼ˆè¿›è¡Œä¸€æ¬¡ç´¯ç§¯ï¼‰çš„å°è¯•å·²ç»å¤±è´¥äº†ï¼Œè¯´æ˜å·²ç»å‘ç”Ÿäº†çº¿ç¨‹ç«äº‰ wasUncontended = true; // Continue after rehash æƒ…å†µå¤±è´¥æ ‡è¯†ï¼Œåé¢å»é‡æ–°ç®—ä¸€éçº¿ç¨‹çš„hashå€¼ else if (a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x)))) // å°è¯•CASæ›´æ–°a.valueï¼ˆè¿›è¡Œä¸€æ¬¡ç´¯ç§¯ï¼‰ ------ æ ‡è®°ä¸ºåˆ†æ”¯A break; // æˆåŠŸäº†å°±å®Œæˆäº†ç´¯ç§¯ä»»åŠ¡ï¼Œé€€å‡ºå¾ªç¯ else if (n &gt;= NCPU || cells != as) // cellæ•°ç»„å·²ç»æ˜¯æœ€å¤§çš„äº†ï¼Œæˆ–è€…ä¸­é€”å‘ç”Ÿäº†æ‰©å®¹æ“ä½œã€‚å› ä¸ºNCPUä¸ä¸€å®šæ˜¯2^nï¼Œæ‰€ä»¥è¿™é‡Œç”¨ &gt;= collide = false; // At max size or stale é•¿åº¦næ˜¯é€’å¢çš„ï¼Œæ‰§è¡Œåˆ°äº†è¿™ä¸ªåˆ†æ”¯ï¼Œè¯´æ˜n &gt;= NCPUä¼šæ°¸è¿œä¸ºtrueï¼Œä¸‹é¢ä¸¤ä¸ªelse ifå°±æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œäº†ï¼Œä¹Ÿå°±æ°¸è¿œä¸ä¼šå†è¿›è¡Œæ‰©å®¹ // CPUèƒ½å¤Ÿå¹¶è¡Œçš„CASæ“ä½œçš„æœ€å¤§æ•°é‡æ˜¯å®ƒçš„æ ¸å¿ƒæ•°ï¼ˆCASåœ¨x86ä¸­å¯¹åº”çš„æŒ‡ä»¤æ˜¯cmpxchgï¼Œå¤šæ ¸éœ€è¦é€šè¿‡é”ç¼“å­˜æ¥ä¿è¯æ•´ä½“åŸå­æ€§ï¼‰ï¼Œå½“n &gt;= NCPUæ—¶ï¼Œå†å‡ºç°å‡ ä¸ªçº¿ç¨‹æ˜ å°„åˆ°åŒä¸€ä¸ªCellå¯¼è‡´CASç«äº‰çš„æƒ…å†µï¼Œé‚£å°±çœŸä¸å…³æ‰©å®¹çš„äº‹äº†ï¼Œå®Œå…¨æ˜¯hashå€¼çš„é”…äº† else if (!collide) // æ˜ å°„åˆ°çš„Cellå•å…ƒä¸æ˜¯nullï¼Œå¹¶ä¸”å°è¯•å¯¹å®ƒè¿›è¡Œç´¯ç§¯æ—¶ï¼ŒCASç«äº‰å¤±è´¥äº†ï¼Œè¿™æ—¶å€™æŠŠæ‰©å®¹æ„å‘è®¾ç½®ä¸ºtrue // ä¸‹ä¸€æ¬¡å¾ªç¯å¦‚æœè¿˜æ˜¯è·Ÿè¿™ä¸€æ¬¡ä¸€æ ·ï¼Œè¯´æ˜ç«äº‰å¾ˆä¸¥é‡ï¼Œé‚£ä¹ˆå°±çœŸæ­£æ‰©å®¹ collide = true; // æŠŠæ‰©å®¹æ„å‘è®¾ç½®ä¸ºtrueï¼Œåªæœ‰è¿™é‡Œæ‰ä¼šç»™collideèµ‹å€¼ä¸ºtrueï¼Œä¹Ÿåªæœ‰æ‰§è¡Œäº†è¿™ä¸€å¥ï¼Œæ‰å¯èƒ½æ‰§è¡Œåé¢ä¸€ä¸ªelse ifè¿›è¡Œæ‰©å®¹ else if (cellsBusy == 0 &amp;&amp; casCellsBusy()) &#123; // æœ€åå†è€ƒè™‘æ‰©å®¹ï¼Œèƒ½åˆ°è¿™ä¸€æ­¥è¯´æ˜ç«äº‰å¾ˆæ¿€çƒˆï¼Œå°è¯•åŠ é”è¿›è¡Œæ‰©å®¹ ------ æ ‡è®°ä¸ºåˆ†æ”¯B try &#123; if (cells == as) &#123; // Expand table unless stale æ£€æŸ¥ä¸‹æ˜¯å¦è¢«åˆ«çš„çº¿ç¨‹æ‰©å®¹äº†ï¼ˆCASæ›´æ–°é”æ ‡è¯†ï¼Œå¤„ç†ä¸äº†ABAé—®é¢˜ï¼Œè¿™é‡Œå†æ£€æŸ¥ä¸€éï¼‰ Cell[] rs = new Cell[n &lt;&lt; 1]; // æ‰§è¡Œ2å€æ‰©å®¹ for (int i = 0; i &lt; n; ++i) rs[i] = as[i]; cells = rs; &#125; &#125; finally &#123; cellsBusy = 0; // é‡Šæ”¾é” &#125; collide = false; // æ‰©å®¹æ„å‘ä¸ºfalse continue; // Retry with expanded table æ‰©å®¹åé‡å¤´å†æ¥ &#125; h = advanceProbe(h); // é‡æ–°ç»™çº¿ç¨‹ç”Ÿæˆä¸€ä¸ªhashå€¼ï¼Œé™ä½hashå†²çªï¼Œå‡å°‘æ˜ å°„åˆ°åŒä¸€ä¸ªCellå¯¼è‡´CASç«äº‰çš„æƒ…å†µ &#125; else if (cellsBusy == 0 &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123; // cellsæ²¡æœ‰è¢«åŠ é”ï¼Œå¹¶ä¸”å®ƒæ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°±å°è¯•å¯¹å®ƒè¿›è¡ŒåŠ é”ï¼ŒåŠ é”æˆåŠŸè¿›å…¥è¿™ä¸ªelse if boolean init = false; try &#123; // Initialize table if (cells == as) &#123; // CASé¿å…ä¸äº†ABAé—®é¢˜ï¼Œè¿™é‡Œå†æ£€æµ‹ä¸€æ¬¡ï¼Œå¦‚æœè¿˜æ˜¯nullï¼Œæˆ–è€…ç©ºæ•°ç»„ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œåˆå§‹åŒ– Cell[] rs = new Cell[2]; // åˆå§‹åŒ–æ—¶åªåˆ›å»ºä¸¤ä¸ªå•å…ƒ rs[h &amp; 1] = new Cell(x); // å¯¹å…¶ä¸­ä¸€ä¸ªå•å…ƒè¿›è¡Œç´¯ç§¯æ“ä½œï¼Œå¦ä¸€ä¸ªä¸ç®¡ï¼Œç»§ç»­ä¸ºnull cells = rs; init = true; &#125; &#125; finally &#123; cellsBusy = 0; // æ¸…ç©ºè‡ªæ—‹æ ‡è¯†ï¼Œé‡Šæ”¾é” &#125; if (init) // å¦‚æœæŸä¸ªåŸæœ¬ä¸ºnullçš„Cellå•å…ƒæ˜¯ç”±è‡ªå·±è¿›è¡Œç¬¬ä¸€æ¬¡ç´¯ç§¯æ“ä½œï¼Œé‚£ä¹ˆä»»åŠ¡å·²ç»å®Œæˆäº†ï¼Œæ‰€ä»¥å¯ä»¥é€€å‡ºå¾ªç¯ break; &#125; else if (casBase(v = base, ((fn == null) ? v + x : fn.applyAsLong(v, x)))) // cellsæ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œå°è¯•ç›´æ¥åœ¨baseä¸Šè¿›è¡Œç´¯åŠ æ“ä½œ break; // Fall back on using base ç›´æ¥åœ¨baseä¸Šè¿›è¡Œç´¯ç§¯æ“ä½œæˆåŠŸäº†ï¼Œä»»åŠ¡å®Œæˆï¼Œå¯ä»¥é€€å‡ºå¾ªç¯äº† &#125; &#125; // doubleçš„ä¸è®²ï¼Œæ›´longçš„é€»è¾‘åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ final void doubleAccumulate(double x, DoubleBinaryOperator fn, boolean wasUncontended); // Unsafe mechanics Unsafeåˆå§‹åŒ– private static final sun.misc.Unsafe UNSAFE; private static final long BASE; private static final long CELLSBUSY; private static final long PROBE; static &#123; try &#123; UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; sk = Striped64.class; BASE = UNSAFE.objectFieldOffset (sk.getDeclaredField(\"base\")); CELLSBUSY = UNSAFE.objectFieldOffset (sk.getDeclaredField(\"cellsBusy\")); Class&lt;?&gt; tk = Thread.class; PROBE = UNSAFE.objectFieldOffset (tk.getDeclaredField(\"threadLocalRandomProbe\")); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125; &#125; 4. LongAdderçœ‹å®Œäº†Striped64çš„è®²è§£ï¼Œè¿™éƒ¨åˆ†å°±å¾ˆç®€å•äº†ï¼Œåªæ˜¯ä¸€äº›ç®€å•çš„å°è£…ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182public class LongAdder extends Striped64 implements Serializable &#123; // æ„é€ æ–¹æ³•ï¼Œä»€ä¹ˆä¹Ÿä¸åšï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å€¼ï¼Œbase = 0, cells = null public LongAdder() &#123; &#125; // addæ–¹æ³•ï¼Œæ ¹æ®çˆ¶ç±»çš„longAccumulateæ–¹æ³•çš„è¦æ±‚ï¼Œè¿™é‡Œè¦è¿›è¡Œä¸€æ¬¡CASæ“ä½œ // ï¼ˆè™½ç„¶è¿™é‡Œæœ‰ä¸¤ä¸ªCASï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªCASæˆåŠŸäº†å°±ä¸ä¼šæ‰§è¡Œç¬¬äºŒä¸ªï¼Œè¦æ‰§è¡Œç¬¬äºŒä¸ªï¼Œç¬¬ä¸€ä¸ªå°±è¢«â€œçŸ­è·¯â€äº†ä¸ä¼šè¢«æ‰§è¡Œï¼‰ // åœ¨çº¿ç¨‹ç«äº‰ä¸æ¿€çƒˆæ—¶ï¼Œè¿™æ ·åšæ›´å¿« public void add(long x) &#123; Cell[] as; long b, v; int m; Cell a; //é¦–å…ˆåˆ¤æ–­cellsæ˜¯å¦è¿˜æ²¡è¢«åˆå§‹åŒ–ï¼Œå¹¶ä¸”å°è¯•å¯¹valueå€¼è¿›è¡Œcasæ“ä½œ if ((as = cells) != null || !casBase(b = base, b + x)) &#123; boolean uncontended = true; //æ­¤å¤„æœ‰å¤šä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œä¾æ¬¡æ˜¯ //1.cell[]æ•°ç»„è¿˜æœªåˆå§‹åŒ– //2.cell[]æ•°ç»„è™½ç„¶åˆå§‹åŒ–äº†ä½†æ˜¯æ•°ç»„é•¿åº¦ä¸º0 //3.è¯¥çº¿ç¨‹æ‰€å¯¹åº”çš„cellä¸ºnullï¼Œå…¶ä¸­è¦æ³¨æ„çš„æ˜¯ï¼Œå½“nä¸º2çš„næ¬¡å¹‚æ—¶ï¼Œï¼ˆ(n - 1) &amp; hï¼‰ç­‰æ•ˆäºh%n //4.å°è¯•å¯¹è¯¥çº¿ç¨‹å¯¹åº”çš„cellå•å…ƒè¿›è¡Œcasæ›´æ–°ï¼ˆåŠ ä¸Šx) if (as == null || (m = as.length - 1) &lt; 0 || (a = as[getProbe() &amp; m]) == null || !(uncontended = a.cas(v = a.value, v + x))) // è¡¨ç¤ºç¬¬ä¸€æ¬¡casæˆåŠŸæƒ…å†µ longAccumulate(x, null, uncontended); &#125; &#125; public void increment() &#123; add(1L); &#125; public void decrement() &#123; add(-1L); &#125; // è¿”å›ç´¯åŠ çš„å’Œï¼Œä¹Ÿå°±æ˜¯â€œå½“å‰æ—¶åˆ»â€çš„è®¡æ•°å€¼ // æ­¤è¿”å›å€¼å¯èƒ½ä¸æ˜¯ç»å¯¹å‡†ç¡®çš„ï¼Œå› ä¸ºè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶è¿˜æœ‰å…¶ä»–çº¿ç¨‹å¯èƒ½æ­£åœ¨è¿›è¡Œè®¡æ•°ç´¯åŠ ï¼Œ // æ–¹æ³•çš„è¿”å›æ—¶åˆ»å’Œè°ƒç”¨æ—¶åˆ»ä¸æ˜¯åŒä¸€ä¸ªç‚¹ï¼Œåœ¨æœ‰å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼åªæ˜¯è¿‘ä¼¼å‡†ç¡®çš„è®¡æ•°å€¼ // é«˜å¹¶å‘æ—¶ï¼Œé™¤éå…¨å±€åŠ é”ï¼Œå¦åˆ™å¾—ä¸åˆ°ç¨‹åºè¿è¡Œä¸­æŸä¸ªæ—¶åˆ»ç»å¯¹å‡†ç¡®çš„å€¼ï¼Œä½†æ˜¯å…¨å±€åŠ é”åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹æ˜¯ä¸‹ä¸‹ç­– // åœ¨å¾ˆå¤šçš„å¹¶å‘åœºæ™¯ä¸­ï¼Œè®¡æ•°æ“ä½œå¹¶ä¸æ˜¯æ ¸å¿ƒï¼Œè¿™ç§æƒ…å†µä¸‹å…è®¸è®¡æ•°å™¨çš„å€¼å‡ºç°ä¸€ç‚¹åå·®ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨LongAdder // åœ¨å¿…é¡»ä¾èµ–å‡†ç¡®è®¡æ•°å€¼çš„åœºæ™¯ä¸­ï¼Œåº”è¯¥è‡ªå·±å¤„ç†è€Œä¸æ˜¯ä½¿ç”¨é€šç”¨çš„ç±» public long sum() &#123; Cell[] as = cells; Cell a; long sum = base; if (as != null) &#123; for (int i = 0; i &lt; as.length; ++i) &#123; if ((a = as[i]) != null) sum += a.value; &#125; &#125; return sum; &#125; // é‡ç½®è®¡æ•°å™¨ï¼Œåªåº”è¯¥åœ¨æ˜ç¡®æ²¡æœ‰å¹¶å‘çš„æƒ…å†µä¸‹è°ƒç”¨ï¼Œå¯ä»¥ç”¨æ¥é¿å…é‡æ–°newä¸€ä¸ªLongAdder public void reset() &#123; Cell[] as = cells; Cell a; base = 0L; if (as != null) &#123; for (int i = 0; i &lt; as.length; ++i) &#123; if ((a = as[i]) != null) a.value = 0L; &#125; &#125; &#125; // ç›¸å½“äºsum()åå†è°ƒç”¨reset() public long sumThenReset() &#123; Cell[] as = cells; Cell a; long sum = base; base = 0L; if (as != null) &#123; for (int i = 0; i &lt; as.length; ++i) &#123; if ((a = as[i]) != null) &#123; sum += a.value; a.value = 0L; &#125; &#125; &#125; return sum; &#125; // å…¶ä»–çš„ä¸è¯´äº† &#125; 5. åè®°è¿™ä¸ªç±»æ˜¯jdk1.8æ–°å¢çš„ç±»ï¼Œç›®çš„æ˜¯ä¸ºäº†æä¾›ä¸€ä¸ªé€šç”¨çš„ï¼Œæ›´é«˜æ•ˆçš„ç”¨äºå¹¶å‘åœºæ™¯çš„è®¡æ•°å™¨ã€‚å¯ä»¥ç½‘ä¸Šæœä¸‹ä¸€äº›å…³äºLongAdderçš„æ€§èƒ½æµ‹è¯•ï¼Œæœ‰å¾ˆå¤šç°æˆçš„ï¼Œæˆ‘è‡ªå·±å°±ä¸å†™äº†ã€‚jdk1.8çš„ConcurrentHashMapä¸­ï¼Œæ²¡æœ‰å†ä½¿ç”¨Segmentï¼Œä½¿ç”¨äº†ä¸€ä¸ªç®€å•çš„ä»¿é€ LongAdderå®ç°çš„è®¡æ•°å™¨ï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯è®¡æ•°æ•ˆç‡ä¸ä½äºä½¿ç”¨Segmentçš„æ•ˆç‡ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[JavaåŸºç¡€]BitSet","slug":"JavaåŸºç¡€-BitSet","date":"2018-03-13T02:02:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"4146306917.html","link":"","permalink":"https://htchz.cc/4146306917.html","excerpt":"","text":"1. BitSetç±»å¤§å°å¯åŠ¨æ€æ”¹å˜, å–å€¼ä¸ºtrueæˆ–falseçš„ä½é›†åˆã€‚ç”¨äºè¡¨ç¤ºä¸€ç»„å¸ƒå°”æ ‡å¿—ã€‚ æ­¤ç±»å®ç°äº†ä¸€ä¸ªæŒ‰éœ€å¢é•¿çš„ä½å‘é‡ã€‚ä½ set çš„æ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ª boolean å€¼ã€‚ç”¨éè´Ÿçš„æ•´æ•°å°† BitSet çš„ä½ç¼–å…¥ç´¢å¼•ã€‚å¯ä»¥å¯¹æ¯ä¸ªç¼–å…¥ç´¢å¼•çš„ä½è¿›è¡Œæµ‹è¯•ã€è®¾ç½®æˆ–è€…æ¸…é™¤ã€‚é€šè¿‡é€»è¾‘ä¸ã€é€»è¾‘æˆ–å’Œé€»è¾‘å¼‚æˆ–æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ª BitSet ä¿®æ”¹å¦ä¸€ä¸ª BitSet çš„å†…å®¹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œset ä¸­æ‰€æœ‰ä½çš„åˆå§‹å€¼éƒ½æ˜¯ falseã€‚æ¯ä¸ªä½ set éƒ½æœ‰ä¸€ä¸ªå½“å‰å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯¥ä½ set å½“å‰æ‰€ç”¨ç©ºé—´çš„ä½æ•°ã€‚æ³¨æ„ï¼Œè¿™ä¸ªå¤§å°ä¸ä½ set çš„å®ç°æœ‰å…³ï¼Œæ‰€ä»¥å®ƒå¯èƒ½éšå®ç°çš„ä¸åŒè€Œæ›´æ”¹ã€‚ä½ set çš„é•¿åº¦ä¸ä½ set çš„é€»è¾‘é•¿åº¦æœ‰å…³ï¼Œå¹¶ä¸”æ˜¯ä¸å®ç°æ— å…³è€Œå®šä¹‰çš„ã€‚é™¤éå¦è¡Œè¯´æ˜ï¼Œå¦åˆ™å°† null å‚æ•°ä¼ é€’ç»™ BitSet ä¸­çš„ä»»ä½•æ–¹æ³•éƒ½å°†å¯¼è‡´ NullPointerExceptionã€‚ åœ¨æ²¡æœ‰å¤–éƒ¨åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹æ“ä½œä¸€ä¸ª BitSet æ˜¯ä¸å®‰å…¨çš„ã€‚ 2. æ„é€ å‡½æ•°:BitSet() or BitSet(int nbits) 3. ä¸€äº›æ–¹æ³•12345678910111213141516public void set(int pos): ä½ç½®posçš„å­—ä½è®¾ç½®ä¸ºtrueã€‚ public void set(int bitIndex, boolean value) å°†æŒ‡å®šç´¢å¼•å¤„çš„ä½è®¾ç½®ä¸ºæŒ‡å®šçš„å€¼ã€‚ public void clear(int pos): ä½ç½®posçš„å­—ä½è®¾ç½®ä¸ºfalseã€‚public void clear() : å°†æ­¤ BitSet ä¸­çš„æ‰€æœ‰ä½è®¾ç½®ä¸º falseã€‚ public int cardinality() è¿”å›æ­¤ BitSet ä¸­è®¾ç½®ä¸º true çš„ä½æ•°ã€‚ public boolean get(int pos): è¿”å›ä½ç½®æ˜¯posçš„å­—ä½å€¼ã€‚ public void and(BitSet other): otheråŒè¯¥å­—ä½é›†è¿›è¡Œä¸æ“ä½œï¼Œç»“æœä½œä¸ºè¯¥å­—ä½é›†çš„æ–°å€¼ã€‚ public void or(BitSet other): otheråŒè¯¥å­—ä½é›†è¿›è¡Œæˆ–æ“ä½œï¼Œç»“æœä½œä¸ºè¯¥å­—ä½é›†çš„æ–°å€¼ã€‚ public void xor(BitSet other): otheråŒè¯¥å­—ä½é›†è¿›è¡Œå¼‚æˆ–æ“ä½œï¼Œç»“æœä½œä¸ºè¯¥å­—ä½é›†çš„æ–°å€¼ã€‚public void andNot(BitSet set) æ¸…é™¤æ­¤ BitSet ä¸­æ‰€æœ‰çš„ä½,set - ç”¨æ¥å±è”½æ­¤ BitSet çš„ BitSetpublic int size(): è¿”å›æ­¤ BitSet è¡¨ç¤ºä½å€¼æ—¶å®é™…ä½¿ç”¨ç©ºé—´çš„ä½æ•°ã€‚public int length() è¿”å›æ­¤ BitSet çš„â€œé€»è¾‘å¤§å°â€ï¼šBitSet ä¸­æœ€é«˜è®¾ç½®ä½çš„ç´¢å¼•åŠ  1ã€‚ public int hashCode(): è¿”å›è¯¥é›†åˆHash ç ï¼Œ è¿™ä¸ªç åŒé›†åˆä¸­çš„å­—ä½å€¼æœ‰å…³ã€‚ public boolean equals(Object other): å¦‚æœotherä¸­çš„å­—ä½åŒé›†åˆä¸­çš„å­—ä½ç›¸åŒï¼Œè¿”å›trueã€‚ public Object clone() å…‹éš†æ­¤ BitSetï¼Œç”Ÿæˆä¸€ä¸ªä¸ä¹‹ç›¸ç­‰çš„æ–° BitSetã€‚ public String toString() è¿”å›æ­¤ä½ set çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚ 4. è§£é‡ŠJava.util.BitSetå¯ä»¥æŒ‰ä½å­˜å‚¨ã€‚è®¡ç®—æœºä¸­ä¸€ä¸ªå­—èŠ‚ï¼ˆbyteï¼‰å 8ä½ï¼ˆbitï¼‰ï¼Œæˆ‘ä»¬javaä¸­æ•°æ®è‡³å°‘æŒ‰å­—èŠ‚å­˜å‚¨çš„ï¼Œæ¯”å¦‚ä¸€ä¸ªintå 4ä¸ªå­—èŠ‚ã€‚å¦‚æœé‡åˆ°å¤§çš„æ•°æ®é‡ï¼Œè¿™æ ·å¿…ç„¶ä¼šéœ€è¦å¾ˆå¤§å­˜å‚¨ç©ºé—´å’Œå†…å­˜ã€‚å¦‚ä½•å‡å°‘æ•°æ®å ç”¨å­˜å‚¨ç©ºé—´å’Œå†…å­˜å¯ä»¥ç”¨ç®—æ³•è§£å†³ã€‚java.util.BitSetå°±æä¾›äº†è¿™æ ·çš„ç®—æ³•ã€‚æ¯”å¦‚æœ‰ä¸€å †æ•°å­—ï¼Œéœ€è¦å­˜å‚¨ï¼Œsource=[3,5,6,9]ç”¨intå°±éœ€è¦4*4ä¸ªå­—èŠ‚ã€‚java.util.BitSetå¯ä»¥å­˜true/falseã€‚å¦‚æœç”¨java.util.BitSetï¼Œåˆ™ä¼šå°‘å¾ˆå¤šï¼Œå…¶åŸç†æ˜¯ï¼š å…ˆæ‰¾å‡ºæ•°æ®ä¸­æœ€å¤§å€¼maxvalue=9 å£°æ˜ä¸€ä¸ªBitSet bs,å®ƒçš„sizeæ˜¯maxvalue+1=10 éå†æ•°æ®sourceï¼Œbs[source[i]]è®¾ç½®æˆtrue. æœ€åçš„å€¼æ˜¯ï¼š(0ä¸ºfalse;1ä¸ºtrue) bs [0,0,0,1,0,1,1,0,0,1] è¿™æ ·ä¸€ä¸ªæœ¬æ¥è¦intå‹éœ€è¦å 4å­—èŠ‚å…±32ä½çš„æ•°å­—ç°åœ¨åªç”¨äº†1ä½ï¼æ¯”ä¾‹32:1 ,è¿™æ ·å°±çœä¸‹äº†å¾ˆå¤§ç©ºé—´ã€‚ é»˜è®¤çš„æ„é€ å‡½æ•°å£°æ˜ä¸€ä¸ª64ä½çš„BitSetï¼Œå€¼éƒ½æ˜¯falseã€‚å¦‚æœä½ è¦ç”¨çš„ä½è¶…è¿‡äº†é»˜è®¤size,å®ƒä¼šå†ç”³è¯·64ä½ï¼Œè€Œä¸æ˜¯æŠ¥é”™ã€‚ 123456789101112131415/** * @param args */ public static void main(String[] args) &#123; BitSet bm=new BitSet(); System.out.println(bm.isEmpty()+\"--\"+bm.size()); // true--64 bm.set(0); System.out.println(bm.isEmpty()+\"--\"+bm.size()); // false--64 bm.set(1); System.out.println(bm.isEmpty()+\"--\"+bm.size()); // false--64 System.out.println(bm.get(65)); // false System.out.println(bm.isEmpty()+\"--\"+bm.size()); // false--64 bm.set(65); System.out.println(bm.isEmpty()+\"--\"+bm.size()); // false--128 &#125; ç”³è¯·çš„ä½éƒ½æ˜¯ä»¥64ä¸ºå€æ•°çš„ï¼Œå°±æ˜¯è¯´ä½ ç”³è¯·ä¸è¶…è¿‡ä¸€ä¸ª64çš„å°±æŒ‰64ç®—ï¼Œè¶…è¿‡ä¸€ä¸ªä¸è¶…è¿‡2ä¸ªçš„å°±æŒ‰128ç®—ã€‚ 12345678910111213public static void main(String[] args) &#123; BitSet bm1=new BitSet(7); System.out.println(bm1.isEmpty()+&quot;--&quot;+bm1.size()); // true-64 BitSet bm2=new BitSet(63); System.out.println(bm2.isEmpty()+&quot;--&quot;+bm2.size()); // true-64 BitSet bm3=new BitSet(65); System.out.println(bm3.isEmpty()+&quot;--&quot;+bm3.size()); // true-128 BitSet bm4=new BitSet(111); System.out.println(bm4.isEmpty()+&quot;--&quot;+bm4.size()); // true-128&#125; æ¥çœ‹ä¸€ä¸ªå°ä»£ç : 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970package com; import java.util.BitSet; public class MainTestFive &#123; /** * @param args */ public static void main(String[] args) &#123; int[] shu=&#123;2,42,5,6,6,18,33,15,25,31,28,37&#125;; BitSet bm1=new BitSet(MainTestFive.getMaxValue(shu)); System.out.println(&quot;bm1.size()--&quot;+bm1.size()); MainTestFive.putValueIntoBitSet(shu, bm1); printBitSet(bm1); &#125; //åˆå§‹å…¨éƒ¨ä¸ºfalseï¼Œè¿™ä¸ªä½ å¯ä»¥ä¸ç”¨ï¼Œå› ä¸ºé»˜è®¤éƒ½æ˜¯false public static void initBitSet(BitSet bs)&#123; for(int i=0;i&lt;bs.size();i++)&#123; bs.set(i, false); &#125; &#125; //æ‰“å° public static void printBitSet(BitSet bs)&#123; StringBuffer buf=new StringBuffer(); buf.append(&quot;[\\n&quot;); for(int i=0;i&lt;bs.size();i++)&#123; if(i&lt;bs.size()-1)&#123; buf.append(MainTestFive.getBitTo10(bs.get(i))+&quot;,&quot;); &#125;else&#123; buf.append(MainTestFive.getBitTo10(bs.get(i))); &#125; if((i+1)%8==0&amp;&amp;i!=0)&#123; buf.append(&quot;\\n&quot;); &#125; &#125; buf.append(&quot;]&quot;); System.out.println(buf.toString()); &#125; //æ‰¾å‡ºæ•°æ®é›†åˆæœ€å¤§å€¼ public static int getMaxValue(int[] zu)&#123; int temp=0; temp=zu[0]; for(int i=0;i&lt;zu.length;i++)&#123; if(temp&lt;zu[i])&#123; temp=zu[i]; &#125; &#125; System.out.println(&quot;maxvalue:&quot;+temp); return temp; &#125; //æ”¾å€¼ public static void putValueIntoBitSet(int[] shu,BitSet bs)&#123; for(int i=0;i&lt;shu.length;i++)&#123; bs.set(shu[i], true); &#125; &#125; //true,falseæ¢æˆ1,0ä¸ºäº†å¥½çœ‹ public static String getBitTo10(boolean flag)&#123; String a=&quot;&quot;; if(flag==true)&#123; return &quot;1&quot;; &#125;else&#123; return &quot;0&quot;; &#125; &#125; &#125; è¾“å‡º: maxvalue:42 bm1.size()--64 0,0,1,0,0,1,1,0, 0,0,0,0,0,0,0,1, 0,0,1,0,0,0,0,0, 0,1,0,0,1,0,0,1, 0,1,0,0,0,1,0,0, 0,0,1,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0è¿™æ ·ä¾¿å®Œæˆäº†å­˜å€¼å’Œå–å€¼ã€‚æ³¨æ„å®ƒä¼šå¯¹é‡å¤çš„æ•°å­—è¿‡æ»¤ï¼Œå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæ•°å­—å‡ºç°è¿‡è¶…è¿‡2æ¬¡çš„å®ƒéƒ½è®°æˆ1.å‡ºç°çš„æ¬¡æ•°è¿™ä¸ªä¿¡æ¯å°±ä¸¢äº†ã€‚","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"ä½å›¾","slug":"ä½å›¾","permalink":"https://htchz.cc/tags/ä½å›¾/"}],"author":"åœŸå·"},{"title":"[å¤šçº¿ç¨‹]ä¸€ä¸ªçº¿ç¨‹é¥¥é¥¿æ­»é”çš„ä¾‹å­","slug":"å¤šçº¿ç¨‹-ä¸€ä¸ªçº¿ç¨‹é¥¥é¥¿æ­»é”çš„ä¾‹å­","date":"2018-03-10T12:44:00.000Z","updated":"2019-08-21T06:47:46.115Z","comments":true,"path":"45692816.html","link":"","permalink":"https://htchz.cc/45692816.html","excerpt":"ç®€å•åœ°è¯´ï¼Œå°±æ˜¯å¾ªç¯é˜»å¡ï¼Œäº’ç›¸æŠ¢å èµ„æºã€‚","text":"ç®€å•åœ°è¯´ï¼Œå°±æ˜¯å¾ªç¯é˜»å¡ï¼Œäº’ç›¸æŠ¢å èµ„æºã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556package com.htc.test;import java.util.concurrent.*;/** * Created by Zack.Huang on 2017/8/24. */public class ThreadDeadlock &#123; ExecutorService exec = Executors.newSingleThreadScheduledExecutor();// ExecutorService exec = Executors.newCachedThreadPool(); //å¦‚æœæ·»åŠ ç»™çº¿ç¨‹æ± ä¸­æ·»åŠ è¶³å¤Ÿå¤šçš„çº¿ç¨‹ï¼Œå°±å¯ä»¥è®©æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œï¼Œé¿å…é¥¥é¥¿æ­»é”ã€‚ /** * æ¨¡æ‹Ÿé¡µé¢åŠ è½½çš„ä¾‹å­ * * äº§ç”Ÿæ­»é”åˆ†æï¼š * RenderPageTaskä»»åŠ¡ä¸­æœ‰2ä¸ªå­ä»»åŠ¡åˆ†åˆ«æ˜¯â€œåŠ è½½é¡µçœ‰â€å’Œâ€œåŠ è½½é¡µè„šâ€ã€‚å½“æäº¤RenderPageTaskä»»åŠ¡æ—¶ï¼Œå®é™…ä¸Šæ˜¯å‘çº¿ç¨‹æ± ä¸­æ·»åŠ äº†3ä¸ªä»»åŠ¡ï¼Œ * ä½†æ˜¯ç”±äºçº¿ç¨‹æ± æ˜¯å•ä¸€çº¿ç¨‹æ± ï¼ŒåŒæ—¶åªä¼šæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œ2ä¸ªå­ä»»åŠ¡å°±ä¼šåœ¨é˜»å¡åœ¨çº¿ç¨‹æ± ä¸­ã€‚è€ŒRenderPageTaskä»»åŠ¡ç”±äºå¾—ä¸åˆ°è¿”å›ï¼Œä¹Ÿä¼š * ä¸€ç›´å µå¡ï¼Œä¸ä¼šé‡Šæ”¾çº¿ç¨‹èµ„æºè®©å­çº¿ç¨‹æ‰§è¡Œã€‚è¿™æ ·å°±å¯¼è‡´äº†çº¿ç¨‹é¥¥é¥¿æ­»é”ã€‚ * * åœ¨ä¸€ä¸ªCallableä»»åŠ¡ä¸­ï¼Œè¦è¿”å›2ä¸ªå­ä»»åŠ¡ * @author hadoop * */ class RenderPageTask implements Callable&lt;String&gt; &#123; @Override public String call() throws Exception &#123; Future&lt;String&gt; header,footer; header = exec.submit(() -&gt; &#123; System.out.println(\"åŠ è½½é¡µçœ‰\"); Thread.sleep(2*1000); return \"é¡µçœ‰\"; &#125;); footer = exec.submit(() -&gt; &#123; System.out.println(\"åŠ è½½é¡µè„š\"); Thread.sleep(3*1000); return \"é¡µè„š\"; &#125;); System.out.println(\"æ¸²æŸ“é¡µé¢ä¸»ä½“\"); return header.get() + footer.get();//return \"you bad bad\"; è¿™é‡Œæ”¹ä¸ºè¿™æ ·å°±å¯ä»¥ä¸é˜»å¡ &#125; &#125; public static void main(String[] args) throws InterruptedException, ExecutionException &#123; ThreadDeadlock td = new ThreadDeadlock(); Future&lt;String&gt; futre = td.exec.submit(td.new RenderPageTask()); String result = futre.get(); System.out.println(\"æ‰§è¡Œç»“æœä¸ºï¼š\" + result); &#125;&#125;","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"https://htchz.cc/categories/JavaåŸºç¡€/"}],"tags":[{"name":"multithread","slug":"multithread","permalink":"https://htchz.cc/tags/multithread/"}],"author":"åœŸå·"},{"title":"[è€å¸æœº]BTåè®®å­¦ä¹ ç¬”è®°","slug":"ç½‘ç»œ-BTåè®®å­¦ä¹ ç¬”è®°","date":"2018-03-10T08:01:00.000Z","updated":"2019-12-03T01:02:43.251Z","comments":true,"path":"2501905798.html","link":"","permalink":"https://htchz.cc/2501905798.html","excerpt":"","text":"1. ç¼–ç  B encodeåœ¨è¯´æ˜ç½‘ç»œæµç¨‹ä¹‹å‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸‹B encodeï¼Œå› ä¸ºåœ¨BitTorrentåè®®ä¸­çš„æ•°æ®å‡ ä¹éƒ½æ˜¯ç”¨B encodeè¿›è¡Œç¼–ç çš„ã€‚å®ƒæ˜¯ä¸€ç§ä½œç”¨ç±»ä¼¼äºXMLå’ŒJSONçš„æ•°æ®ç»„ç»‡æ ¼å¼ï¼Œå¯ä»¥è¡¨è¾¾å­—ç¬¦ä¸²ã€æ•´æ•°ä¸¤ç§åŸºæœ¬ç±»å‹ï¼Œåˆ—è¡¨ã€å­—å…¸ä¸¤ç§æ•°æ®ç»“æ„ï¼Œå®ƒçš„è¯­æ³•è§„åˆ™ååˆ†ç®€å•ã€‚ å­—èŠ‚ä¸²æŒ‰å¦‚ä¸‹æ–¹å¼ç¼–ç ï¼š &lt;ä»¥åè¿›åˆ¶ASCIIç¼–ç çš„ä¸²é•¿åº¦&gt;ï¼š&lt;ä¸²æ•°æ®&gt;ä¾‹ï¼šâ€œ4:spamâ€è¡¨ç¤ºå­—èŠ‚ä¸²â€œspamâ€ æ•´æ•°æŒ‰å¦‚ä¸‹æ–¹å¼ç¼–ç ï¼š i&lt;ä»¥åè¿›åˆ¶ASCIIç¼–ç çš„æ•´æ•°&gt;eä¾‹ï¼šâ€œi3eâ€è¡¨ç¤ºæ•´æ•°â€œ3â€ åˆ—è¡¨æŒ‰å¦‚ä¸‹æ–¹å¼ç¼–ç ï¼š l&lt;å†…å®¹&gt;eå¼€å§‹çš„â€œlâ€ä¸ç»“å°¾çš„â€œeâ€åˆ†åˆ«æ˜¯å¼€å§‹å’Œç»“æŸåˆ†éš”ç¬¦ã€‚listså¯ä»¥åŒ…å«ä»»ä½•Bç¼–ç çš„ç±»å‹ï¼ŒåŒ…æ‹¬æ•´æ•°ã€ä¸²ã€dictionarieså’Œå…¶ä»–çš„listsã€‚ä¾‹ï¼šl4:spam4:eggse è¡¨ç¤ºå«æœ‰ä¸¤ä¸ªä¸²çš„lists:[â€œspamâ€ã€â€œeggsâ€] å­—å…¸æŒ‰å¦‚ä¸‹æ–¹å¼ç¼–ç ï¼š d&lt;å†…å®¹&gt;eå¼€å§‹çš„â€œdâ€ä¸ç»“å°¾çš„â€œeâ€åˆ†åˆ«æ˜¯å¼€å§‹å’Œç»“æŸåˆ†éš”ç¬¦ã€‚æ³¨æ„é”®ï¼ˆkeyï¼‰å¿…é¡»è¢«Bç¼–ç ä¸ºä¸²ã€‚å€¼å¯ä»¥æ˜¯ä»»ä½•Bç¼–ç çš„ç±»å‹ï¼ŒåŒ…æ‹¬æ•´æ•°ã€ä¸²ã€listså’Œå…¶ä»–çš„dictionariesã€‚é”®ï¼ˆkeyï¼‰å¿…é¡»æ˜¯ä¸²ï¼Œå¹¶ä¸”ä»¥æ’åºçš„é¡ºåºå‡ºç°ï¼ˆä»¥åŸå§‹ä¸²æ’åˆ—ï¼Œè€Œä¸æ˜¯ä»¥å­—æ¯æ•°å­—é¡ºåºï¼‰ã€‚ä¾‹1ï¼šd3:cow3:moo4:spam4:eggse è¡¨ç¤ºdictionary { â€œcowâ€ =&gt; â€œmooâ€, â€œspamâ€ =&gt; â€œeggsâ€ } 2. å…ƒä¿¡æ¯æ–‡ä»¶ .torrentä½œä¸ºå‘å¸ƒè€…ï¼Œé¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªåŸŸåï¼Œä¸€å°ä½œä¸ºTrackerçš„æœåŠ¡å™¨ï¼Œä¸€å°å‘å¸ƒ.torrentæ–‡ä»¶çš„æœåŠ¡å™¨ï¼Œä¸€å°ä¿å­˜èµ„æºçš„æœåŠ¡å™¨ï¼Œå½“ç„¶è¿™äº›å¯ä»¥å…±ç”¨ä¸€å°æœåŠ¡å™¨ã€‚ä½¿ç”¨BitTorrentå·¥å…·é€‰æ‹©â€œæµ·è´¼ç‹712é›†.mkvâ€æ–‡ä»¶ï¼ŒæŒ‡å®šTrackeræœåŠ¡å™¨çš„URLï¼Œä¼šç”Ÿæˆä¸€ä¸ª.torrentæ–‡ä»¶ã€‚ .torrentæ–‡ä»¶ä½¿ç”¨B encodeè¡¨ç¤ºï¼Œæ•´ä¸ªæ˜¯ä¸€ä¸ªå­—å…¸æ•°æ®ç»“æ„ï¼Œå®ƒæœ‰å¤šä¸ªkeyå€¼ï¼ŒåŒ…æ‹¬ä¸€äº›æ˜¯å¯é€‰çš„ï¼Œè¿™é‡Œä»‹ç»æœ€å…³é”®çš„å‡ ä¸ªé”®å€¼å¯¹ã€‚ infoï¼šå­˜å‚¨èµ„æºæ–‡ä»¶çš„å…ƒä¿¡æ¯ piece length pieces name/path announceï¼šæè¿°trackeræœåŠ¡å™¨çš„URL infoé”®å¯¹åº”çš„å€¼åˆæ˜¯ä¸€ä¸ªå­—å…¸ç»“æ„ï¼ŒBTåè®®å°†ä¸€ä¸ªæ–‡ä»¶åˆ†æˆè‹¥å¹²ç‰‡ï¼Œä¾¿äºå®¢æˆ·ç«¯ä»å„ä¸ªä¸»æœºä¸‹è½½å„ä¸ªç‰‡ã€‚å…¶ä¸­çš„piece lengthé”®å€¼å¯¹è¡¨ç¤ºä¸€ä¸ªç‰‡çš„é•¿åº¦ï¼Œé€šç•…æƒ…å†µä¸‹æ˜¯2çš„næ¬¡æ–¹ï¼Œæ ¹æ®æ–‡ä»¶å¤§å°æœ‰æ‰€æƒè¡¡ï¼Œé€šé•¿è¶Šå¤§çš„æ–‡ä»¶piece lengthè¶Šå¤§ä»¥å‡å°‘pieceçš„æ•°é‡ï¼Œé™ä½æ•°é‡ä¸€æ–¹é¢é™ä½äº†.torrentä¿å­˜pieceä¿¡æ¯çš„å¤§å°ï¼Œä¸€æ–¹é¢ä¹Ÿå‡å°‘äº†ä¸‹è½½éœ€è¦å¯¹ç‰‡åšçš„ç¡®è®¤æ“ä½œï¼ŒåŠ å¿«ä¸‹è½½é€Ÿåº¦ã€‚ç›®å‰é€šå¸¸æ˜¯256kB,512kBæˆ–è€…1MBã€‚ piecesåˆ™æ˜¯æ¯ä¸ªpieceçš„æ­£ç¡®æ€§éªŒè¯ä¿¡æ¯ï¼Œæ¯ä¸€ç‰‡å‡å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„SHA1æ•£åˆ—å€¼ï¼Œè¯¥é”®å¯¹åº”çš„å€¼æ˜¯æ‰€æœ‰çš„20å­—èŠ‚SHA1æ•£åˆ—å€¼è¿æ¥è€Œæˆçš„å­—ç¬¦ä¸²ã€‚ name/pathæ¯”è¾ƒç¬¼ç»Ÿçš„è¯´ï¼Œå°±æ˜¯å…·ä½“æ–‡ä»¶çš„ä¿¡æ¯ã€‚å› ä¸ºBitTorrentåè®®å…è®¸å°†æ•°ä¸ªæ–‡ä»¶å’Œæ–‡ä»¶å¤¹ä½œä¸ºä¸€ä¸ªBitTorrentä¸‹è½½è¿›è¡Œå‘å¸ƒï¼Œå› æ­¤ä¸‹è½½æ–¹å¯ä»¥æ ¹æ®éœ€è¦å‹¾é€‰æŸä¸€äº›ä¸‹è½½æ–‡ä»¶ã€‚æ³¨æ„ï¼Œè¿™é‡Œå°†æ•°ä¸ªæ–‡ä»¶ä¹Ÿç æˆä¸€ä¸ªæ•°æ®æµï¼Œå› æ­¤ä¸€ä¸ªpieceå¦‚æœåœ¨æ–‡ä»¶è¾¹ç•Œä¸Šï¼Œå¯èƒ½åŒ…å«ä¸åŒæ–‡ä»¶çš„ä¿¡æ¯ã€‚ announceä¿å­˜çš„æ˜¯trackeræœåŠ¡å™¨çš„URLï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æ‹¿åˆ°.torrentæ–‡ä»¶é¦–å…ˆè¦è®¿é—®çš„æœåŠ¡å™¨ï¼Œåœ¨ä¸€äº›æ‰©å±•åè®®ä¸­ï¼Œannounceå¯ä»¥ä¿å­˜å¤šä¸ªtrackeræœåŠ¡å™¨ä½œä¸ºå¤‡é€‰ã€‚ ç”Ÿæˆå¥½.torrentæ–‡ä»¶ä¹‹åï¼Œå‘å¸ƒè€…éœ€è¦å…ˆä½œä¸ºä¸‹è½½è€…ä¸€æ ·æ ¹æ®.torrentæ–‡ä»¶è¿›è¡Œä¸‹è½½ï¼Œè¿™æ ·å°±ä¼šè¿æ¥åˆ°trackeræœåŠ¡å™¨ã€‚ç”±äºå‘å¸ƒè€…å·²ç»æœ‰äº†å®Œæ•´çš„èµ„æºæ–‡ä»¶ï¼ŒtrackeræœåŠ¡å™¨ä¼šå¾—çŸ¥è¿™æ˜¯ä¸€ä¸ªå®Œå…¨ä¸‹è½½å®Œæˆçš„ç”¨æˆ·ï¼Œä¼šæŠŠå‘å¸ƒè€…çš„ä¿¡æ¯ä¿å­˜åœ¨trackeræœåŠ¡å™¨ä¸­ï¼Œè¿™ä¹‹é—´çš„åè®®åœ¨åé¢è®²å®¢æˆ·ç«¯å’ŒtrackeræœåŠ¡å™¨çš„é€šä¿¡åè®®çš„æ—¶å€™å†è¯´ã€‚ å‘å¸ƒè€…è¿˜è¦åšçš„æœ€åä¸€ä»¶äº‹å°±æ˜¯å°†.torrentæ–‡ä»¶æ”¾åœ¨æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥é€šè¿‡HTTPæˆ–è€…FTPåè®®ä¾›ç”¨æˆ·ä¸‹è½½è¿™ä¸ª.torrentæ–‡ä»¶ã€‚ç›¸æ¯”äºç›´æ¥å°†æ•´ä¸ªèµ„æºæ–‡ä»¶æä¾›ç»™ç”¨æˆ·ä¸‹è½½ï¼Œåªä¼ è¾“ä¸€ä¸ª.torrentæ–‡ä»¶å¤§å¤§é™ä½äº†æœåŠ¡å™¨çš„è´Ÿè·ã€‚ è¿™æ ·ï¼Œå‘å¸ƒè€…çš„ä»»åŠ¡å°±å®Œæˆäº†ï¼Œåªéœ€è¦åœ¨èµ„æºä¼ æ’­å¼€å‰ä¿è¯èµ„æºæœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜äº†â€œæµ·è´¼ç‹712é›†.mkvâ€æ–‡ä»¶çš„æœåŠ¡å™¨åœ¨å¼€å¯çŠ¶æ€ï¼Œèƒ½å¤ŸæŒç»­ä¸Šä¼ ç›´åˆ°èµ„æºä¼ æ’­å¼€æ¥ã€‚ 3. å®¢æˆ·ç«¯å’ŒTrackeræœåŠ¡å™¨ç°åœ¨æˆ‘æ˜¯ä¸€ä¸ªåŠ¨æ¼«çˆ±å¥½è€…ï¼Œæˆ‘å‘ç°äº†æ¼«æ¸¸ä¸Šæœ‰æ–°çš„â€œæµ·è´¼ç‹712é›†.mkvâ€çš„BTèµ„æºï¼Œæˆ‘éœ€è¦æ€æ ·æ‰èƒ½ä¸‹è½½åˆ°è¿™ä¸ªè§†é¢‘å‘¢ï¼Ÿ é¦–å…ˆï¼Œå¯ä»¥é€šè¿‡HTTPæˆ–è€…FTPåè®®ç›´æ¥ä»æœåŠ¡å™¨ä¸Šå¾—åˆ°.torrentæ–‡ä»¶ã€‚ç„¶åä½¿ç”¨BitTorrentè½¯ä»¶å®¢æˆ·ç«¯æ‰“å¼€.torrentæ–‡ä»¶ï¼Œè½¯ä»¶ä¼šæ ¹æ®.torrentçš„name/pathå…ƒä¿¡æ¯å‘Šè¯‰æˆ‘è¿™ä¸ª.torrentæ–‡ä»¶å¯ä»¥ä¸‹è½½åˆ°ä¸€ä¸ª.mkvæ–‡ä»¶ï¼Œä¸€ä¸ªå­—å¹•æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µæˆ‘å¯ä»¥è¿›è¡Œä¸€äº›å‹¾é€‰ï¼Œé€‰æ‹©ä¸‹è½½æŸäº›è€Œä¸æ˜¯å…¨éƒ¨çš„èµ„æºã€‚ èµ„æºé€‰æ‹©ç¡®å®šåï¼ŒBitTorrentè½¯ä»¶å®¢æˆ·ç«¯å°±å¼€å§‹äº†ä¸‹è½½ã€‚å®¢æˆ·ç«¯çš„ç¬¬ä¸€æ­¥ä»»åŠ¡æ ¹æ®.torrentä¸Šçš„URLä½¿ç”¨HTTP GETè¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚åŒ…å«äº†å¾ˆå¤šå‚æ•°ï¼Œè¿™é‡Œåªä»‹ç»ä»å®¢æˆ·ç«¯å‘é€åˆ°Trackerçš„è¯·æ±‚æœ€å…³é”®çš„å‡ ä¸ªå‚æ•°ã€‚ info_hash peer_id ip port info_hashæ˜¯å…ƒä¿¡æ¯.torrentæ–‡ä»¶ä¸­infoé”®æ‰€å¯¹åº”çš„å€¼çš„SHA1æ•£åˆ—ï¼Œå¯ä»¥è¢«TrackeræœåŠ¡å™¨ç”¨æ¥ç´¢å¼•å”¯ä¸€çš„å¯¹åº”èµ„æºã€‚ peer_idæ˜¯20byteçš„ä¸²ï¼Œæ²¡æœ‰ä»»ä½•è¦æ±‚ï¼Œè¢«TrackeræœåŠ¡å™¨ç”¨äºè®°å½•å®¢æˆ·ç«¯çš„åå­—ã€‚ ipå¯ä»¥ä»HTTP GETè¯·æ±‚ä¸­ç›´æ¥è·å–ï¼Œæ”¾åœ¨å‚æ•°ä¸­å¯ä»¥è§£å†³ä½¿ç”¨ä»£ç†è¿›è¡ŒHTTP GETçš„æƒ…å†µï¼ŒTrackeræœåŠ¡å™¨å¯ä»¥è®°å½•å®¢æˆ·ç«¯çš„IPåœ°å€ã€‚ portå®¢æˆ·ç«¯ç›‘å¬çš„ç«¯å£å·ï¼Œç”¨äºæ¥æ”¶responseã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¸ºBitTorrentåè®®ä¿ç•™çš„ç«¯å£å·æ˜¯6881-6889ï¼ŒTrackeræœåŠ¡å™¨ä¼šè®°å½•ä¸‹ç«¯å£å·ç”¨äºé€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯ã€‚ åœ¨TrackeræœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„HTTP GETè¯·æ±‚åï¼Œä¼šè¿”å›B encodeå½¢å¼çš„text/plainæ–‡æœ¬ï¼ŒåŒæ ·æ˜¯ä¸€ä¸ªå­—å…¸æ•°æ®ç»“æ„ï¼Œå…¶ä¸­æœ€å…³é”®çš„ä¸€ä¸ªé”®å€¼å¯¹æ˜¯peersï¼Œå®ƒçš„å€¼æ˜¯ä¸ªå­—å…¸åˆ—è¡¨ç»“æ„ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯å¦‚ä¸‹çš„å­—å…¸ç»“æ„ã€‚ peers peer_id ip port è¿™äº›ä¿¡æ¯åœ¨æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥TrackeræœåŠ¡å™¨çš„æ—¶å€™éƒ½å‘é€è¿‡ï¼Œå¹¶ä¸”è¢«TrackeræœåŠ¡å™¨ä¿å­˜äº†ä¸‹æ¥ã€‚æ–°æ¥çš„å®¢æˆ·ç«¯è‡ªç„¶è¦è·å–åˆ°è¿™äº›ä¸‹è½½ä¸­æˆ–è€…å·²ä¸‹è½½å®Œçš„å®¢æˆ·ç«¯çš„ipï¼Œportç­‰ä¿¡æ¯ï¼Œæœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯å°±ä¸éœ€è¦åƒFTPæˆ–è€…HTTPåè®®ä¸€æ ·æŒç»­æ‰¾æœåŠ¡å™¨è·å–èµ„æºï¼Œå¯ä»¥ä»è¿™äº›å…¶ä»–å®¢æˆ·ç«¯ä¸Šè¯·æ±‚è·å–èµ„æºã€‚ 4. peer to peerpeer to peerï¼Œç®€ç§°P2Pï¼Œå°±æ˜¯ä»å…¶ä»–çš„ä¸‹è½½ç”¨æˆ·é‚£é‡Œè·å–æ•°æ®ï¼Œä¹Ÿå°±æ˜¯BitTorrentä¸‹è½½çš„æ ¸å¿ƒç‰¹ç‚¹ã€‚å®¢æˆ·ç«¯ä»TrackeræœåŠ¡å™¨è·å–åˆ°è‹¥å¹²å…¶ä»–ä¸‹è½½è€…(peer)çš„ipå’Œportä¿¡æ¯ï¼Œä¼šè¿›è¡Œè¯·æ±‚å¹¶ç»´æŒè·Ÿæ¯ä¸€ä¸ªpeerçš„è¿æ¥çŠ¶æ€ã€‚ä¸€ä¸ªå®¢æˆ·ç«¯å’Œæ¯ä¸€ä¸ªpeerçš„çŠ¶æ€ä¸»è¦æœ‰ä¸‹åˆ—çŠ¶æ€ä¿¡æ¯ï¼š chokedï¼šè¿œç¨‹å®¢æˆ·ç«¯æ‹’ç»å“åº”ä»»ä½•æœ¬å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ interestedï¼šè¿œç¨‹å®¢æˆ·ç«¯å¯¹æœ¬å®¢æˆ·ç«¯çš„æ•°æ®æ„Ÿå…´è¶£ï¼Œå½“æœ¬å®¢æˆ·ç«¯unchokedè¿œç¨‹å®¢æˆ·ç«¯åï¼Œè¿œç¨‹å®¢æˆ·ç«¯ä¼šè¯·æ±‚æ•°æ®ã€‚ æ‰€ä»¥åº”è¯¥æœ‰4ä¸ªå‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºæœ¬å®¢æˆ·ç«¯å¯¹è¿œç¨‹å®¢æˆ·ç«¯æ˜¯å¦chockï¼Œæ˜¯å¦interestedï¼Œè¿œç¨‹å®¢æˆ·ç«¯å¯¹æœ¬å®¢æˆ·ç«¯æ˜¯å¦chockï¼Œæ˜¯å¦interestedã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹ä¸€ä¸ªè¿œç¨‹peeræ„Ÿå…´è¶£å¹¶ä¸”é‚£ä¸ªè¿œç¨‹peeræ²¡æœ‰chokeè¿™ä¸ªå®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯å°±å¯ä»¥ä»è¿œç¨‹peerä¸‹è½½å—(block)ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯æ²¡æœ‰chokeä¸€ä¸ªpeerï¼Œå¹¶ä¸”é‚£ä¸ªpeerå¯¹è¿™ä¸ªå®¢æˆ·ç«¯è¿™ä¸ªæ„Ÿå…´è¶£æ—¶ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å°±ä¼šä¸Šä¼ å—(block)ã€‚ ç¬¬ä¸€æ¬¡é€šä¿¡ä¼šå…ˆå‘é€æ¡æ‰‹æŠ¥æ–‡ï¼Œå‘Šè¯‰è¿œç¨‹å®¢æˆ·ç«¯æœ¬å®¢æˆ·ç«¯çš„ä¸€äº›ä¿¡æ¯ï¼ŒåŒ…æ‹¬info_hashå’Œpeer_idã€‚æ¥ä¸‹æ¥çš„æ‰€æœ‰æŠ¥æ–‡æœ‰å¦‚ä¸‹å‡ ç§ç±»å‹ï¼š keep-aliveï¼šå‘Šè¯‰è¿œç¨‹å®¢æˆ·ç«¯è¿™ä¸ªé€šä¿¡è¿˜åœ¨ç»´æŒï¼Œå¦åˆ™è¶…è¿‡2åˆ†é’Ÿæ²¡æœ‰ä»»ä½•æŠ¥æ–‡è¿œç¨‹å®¢æˆ·ç«¯ä¼šå°†é€šä¿¡å…³é—­ choke unchoke interested not interested bitfieldï¼šå‘Šè¯‰å¯¹æ–¹æˆ‘å·²ç»æœ‰çš„piece haveï¼šå‘Šè¯‰å¯¹æ–¹æŸä¸ªpieceå·²ç»æˆåŠŸä¸‹è½½å¹¶ä¸”é€šè¿‡hashæ ¡éªŒ requestï¼šè¯·æ±‚æŸä¸ªå—(block) index: æ•´æ•°ï¼ŒæŒ‡å®šä»é›¶å¼€å§‹çš„pieceç´¢å¼• begin: æ•´æ•°ï¼ŒæŒ‡å®špieceä¸­ä»é›¶å¼€å§‹çš„å­—èŠ‚åç§» length: æ•´æ•°ï¼ŒæŒ‡å®šè¯·æ±‚çš„é•¿åº¦ pieceï¼šè¿”å›è¯·æ±‚çš„å—(block)çš„æ•°æ®ï¼Œæ˜¯çœŸæ­£çš„èµ„æºä¿¡æ¯ index: æ•´æ•°ï¼ŒæŒ‡å®šä»é›¶å¼€å§‹çš„pieceç´¢å¼• begin: æ•´æ•°ï¼ŒæŒ‡å®špieceä¸­ä»é›¶å¼€å§‹çš„å­—èŠ‚åç§» block: æ•°æ®å—ç»è¿‡è¿™äº›æŠ¥æ–‡åœ¨æœ¬åœ°å®¢æˆ·ç«¯å’Œè‹¥å¹²ä¸ªè¿œç¨‹å®¢æˆ·ç«¯ä¹‹é—´çš„æ¥å›ä¼ é€’ï¼Œå°±èƒ½å¤Ÿè·å–åˆ°èµ„æºæ–‡ä»¶ã€‚ ç»è¿‡å‰é¢çš„ç®€å•æè¿°ï¼Œå¯ä»¥çœ‹åˆ°è¿™ç§P2Pä¿¡æ¯ä¼ é€’çš„æœ‰è¯¸å¤šå¯ä»¥è¿›è¡ŒæŒ–æ˜å’Œä¼˜åŒ–çš„åœ°æ–¹ã€‚æ¯”å¦‚æ¯æ¬¡trackeræœåŠ¡å™¨è¿”å›å¤šå°‘ä¸ªpeerï¼Œå¤šäº†æ— ç”¨å¹¶ä¸”å¢åŠ ç½‘ç»œè´Ÿè·ï¼Œå°‘äº†åˆä¸å¤Ÿã€‚å®¢æˆ·ç«¯åŒæ—¶å’Œå¤šå°‘ä¸ªpeerä¿æŒé€šä¿¡æœ€å¥½ã€‚å®¢æˆ·ç«¯åº”è¯¥ä¼˜å…ˆè¯·æ±‚å“ªäº›pieceï¼Œå¦‚ä½•è¯·æ±‚è¿ç»­çš„pieceèƒ½å¤Ÿæé«˜ç¼“å­˜çš„ä½¿ç”¨ç‡ã€‚ä¸ºä»€ä¹ˆä¸‹è½½æ¥è¿‘å®Œæˆæœ€åçš„ä¸€äº›æ•°æ®æ€»æ˜¯éå¸¸æ…¢ã€‚è¿™äº›éƒ½æ˜¯å€¼å¾—ä¼˜åŒ–å’Œç ”ç©¶çš„åœ°æ–¹ã€‚","categories":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"https://htchz.cc/categories/ç½‘ç»œ/"}],"tags":[{"name":"BT","slug":"BT","permalink":"https://htchz.cc/tags/BT/"}],"author":"åœŸå·"},{"title":"[Nginx]Nginx location åŒ¹é…åŸåˆ™","slug":"Nginx-location-åŒ¹é…åŸåˆ™","date":"2018-03-10T07:16:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"3180078468.html","link":"","permalink":"https://htchz.cc/3180078468.html","excerpt":"","text":"Location block çš„åŸºæœ¬è¯­æ³•å½¢å¼æ˜¯ï¼šlocation [=|~|~*|^~|@] pattern { ... } [=|~|~*|^~|@]è¢«ç§°ä½œ location modifier ï¼Œè¿™ä¼šå®šä¹‰ Nginx å¦‚ä½•å»åŒ¹é…å…¶åçš„ pattern ï¼Œä»¥åŠè¯¥ pattern çš„æœ€åŸºæœ¬çš„å±æ€§ï¼ˆç®€å•å­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼ï¼‰ 1. location modifierè¯¦è§£ 1ã€= 123456server &#123; server_name htchz.com; location = /abcd &#123; [â€¦] &#125;&#125; åŒ¹é…æƒ…å†µï¼š http://website.com/abcd # æ­£å¥½å®Œå…¨åŒ¹é… http://website.com/ABCD # å¦‚æœè¿è¡Œ Nginx server çš„ç³»ç»Ÿæœ¬èº«å¯¹å¤§å°å†™ä¸æ•æ„Ÿï¼Œæ¯”å¦‚ Windows ï¼Œé‚£ä¹ˆä¹ŸåŒ¹é… http://website.com/abcd?param1m2 # å¿½ç•¥æŸ¥è¯¢ä¸²å‚æ•°ï¼ˆquery string argumentsï¼‰ï¼Œè¿™é‡Œå°±æ˜¯ /abcd åé¢çš„ ?param1m2 http://website.com/abcd/ # ä¸åŒ¹é…ï¼Œå› ä¸ºæœ«å°¾å­˜åœ¨åæ–œæ ï¼ˆtrailing slashï¼‰ï¼ŒNginx ä¸è®¤ä¸ºè¿™ç§æƒ…å†µæ˜¯å®Œå…¨åŒ¹é… http://website.com/abcde # ä¸åŒ¹é…ï¼Œå› ä¸ºä¸æ˜¯å®Œå…¨åŒ¹é… 2ã€(None) ä¸å†™ location modifier ï¼ŒNginx ä»ç„¶èƒ½å»åŒ¹é… pattern ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒåŒ¹é…é‚£äº›ä»¥æŒ‡å®šçš„ patern å¼€å¤´çš„ URIï¼Œæ³¨æ„è¿™é‡Œçš„ URI åªèƒ½æ˜¯æ™®é€šå­—ç¬¦ä¸²ï¼Œä¸èƒ½ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€‚ 123456server &#123; server_name website.com; location /abcd &#123; [â€¦] &#125;&#125; åŒ¹é…æƒ…å†µï¼š http://website.com/abcd # æ­£å¥½å®Œå…¨åŒ¹é… http://website.com/ABCD # å¦‚æœè¿è¡Œ Nginx server çš„ç³»ç»Ÿæœ¬èº«å¯¹å¤§å°å†™ä¸æ•æ„Ÿï¼Œæ¯”å¦‚ Windows ï¼Œé‚£ä¹ˆä¹ŸåŒ¹é… http://website.com/abcd?param1m2 # å¿½ç•¥æŸ¥è¯¢ä¸²å‚æ•°ï¼ˆquery string argumentsï¼‰ï¼Œè¿™é‡Œå°±æ˜¯ /abcd åé¢çš„ ?param1m2 http://website.com/abcd/ # æœ«å°¾å­˜åœ¨åæ–œæ ï¼ˆtrailing slashï¼‰ä¹Ÿå±äºåŒ¹é…èŒƒå›´å†… http://website.com/abcde # ä»ç„¶åŒ¹é…ï¼Œå› ä¸º URI æ˜¯ä»¥ pattern å¼€å¤´çš„ 3ã€~ 123456server &#123; server_name website.com; location ~ ^/abcd$ &#123; [â€¦] &#125;&#125; åŒ¹é…æƒ…å†µï¼š http://website.com/abcd # å®Œå…¨åŒ¹é… http://website.com/ABCD # ä¸åŒ¹é…ï¼Œ~ å¯¹å¤§å°å†™æ˜¯æ•æ„Ÿçš„ http://website.com/abcd?param1m2 # å¿½ç•¥æŸ¥è¯¢ä¸²å‚æ•°ï¼ˆquery string argumentsï¼‰ï¼Œè¿™é‡Œå°±æ˜¯ /abcd åé¢çš„ ?param1m2 http://website.com/abcd/ # ä¸åŒ¹é…ï¼Œå› ä¸ºæœ«å°¾å­˜åœ¨åæ–œæ ï¼ˆtrailing slashï¼‰ï¼Œå¹¶ä¸åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ ^/abcd$ http://website.com/abcde # ä¸åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ ^/abcd$ å¯¹äºä¸€äº›å¯¹å¤§å°å†™ä¸æ•æ„Ÿçš„ç³»ç»Ÿï¼Œæ¯”å¦‚ Windows ï¼Œ~ å’Œ ~* éƒ½æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œè¿™ä¸»è¦æ˜¯æ“ä½œç³»ç»Ÿçš„åŸå› ã€‚ 4ã€~* ä¸ ~ ç±»ä¼¼ï¼Œä½†è¿™ä¸ª location modifier ä¸åŒºåˆ†å¤§å°å†™ï¼Œpattern é¡»æ˜¯æ­£åˆ™è¡¨è¾¾å¼ 123456server &#123; server_name website.com; location ~* ^/abcd$ &#123; [â€¦] &#125;&#125; http://website.com/abcd # å®Œå…¨åŒ¹é… http://website.com/ABCD # åŒ¹é…ï¼Œè¿™å°±æ˜¯å®ƒä¸åŒºåˆ†å¤§å°å†™çš„ç‰¹æ€§ http://website.com/abcd?param1m2 # å¿½ç•¥æŸ¥è¯¢ä¸²å‚æ•°ï¼ˆquery string argumentsï¼‰ï¼Œè¿™é‡Œå°±æ˜¯ /abcd åé¢çš„ ?param1m2 http://website.com/abcd/ # ä¸åŒ¹é…ï¼Œå› ä¸ºæœ«å°¾å­˜åœ¨åæ–œæ ï¼ˆtrailing slashï¼‰ï¼Œå¹¶ä¸åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ ^/abcd$ http://website.com/abcde # ä¸åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ ^/abcd$ 5ã€^~ åŒ¹é…æƒ…å†µç±»ä¼¼ 2. (None) çš„æƒ…å†µï¼Œä»¥æŒ‡å®šåŒ¹é…æ¨¡å¼å¼€å¤´çš„ URI è¢«åŒ¹é…ï¼Œä¸åŒçš„æ˜¯ï¼Œä¸€æ—¦åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆ Nginx å°±åœæ­¢å»å¯»æ‰¾å…¶ä»–çš„ Location å—è¿›è¡ŒåŒ¹é…äº†ï¼ˆä¸ Location åŒ¹é…é¡ºåºæœ‰å…³ï¼‰ 6ã€@ ç”¨äºå®šä¹‰ä¸€ä¸ª Location å—ï¼Œä¸”è¯¥å—ä¸èƒ½è¢«å¤–éƒ¨ Client æ‰€è®¿é—®ï¼Œåªèƒ½è¢« Nginx å†…éƒ¨é…ç½®æŒ‡ä»¤æ‰€è®¿é—®ï¼Œæ¯”å¦‚ try_files or error_page 2. æœç´¢é¡ºåºä»¥åŠç”Ÿæ•ˆä¼˜å…ˆçº§å› ä¸ºå¯ä»¥å®šä¹‰å¤šä¸ª Location å—ï¼Œæ¯ä¸ª Location å—å¯ä»¥æœ‰å„è‡ªçš„ pattern ã€‚å› æ­¤å°±éœ€è¦æ˜ç™½ï¼ˆä¸ç®¡æ˜¯ Nginx è¿˜æ˜¯ä½ ï¼‰ï¼Œå½“ Nginx æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå®ƒæ˜¯å¦‚ä½•å»åŒ¹é… URI å¹¶æ‰¾åˆ°åˆé€‚çš„ Location çš„ã€‚ è¦æ³¨æ„çš„æ˜¯ï¼Œå†™åœ¨é…ç½®æ–‡ä»¶ä¸­æ¯ä¸ª Server å—ä¸­çš„ Location å—çš„æ¬¡åºæ˜¯ä¸é‡è¦çš„ï¼ŒNginx ä¼šæŒ‰ location modifier çš„ä¼˜å…ˆçº§æ¥ä¾æ¬¡ç”¨ URI å»åŒ¹é… pattern ï¼Œé¡ºåºå¦‚ä¸‹ï¼š 1. = 2. (None) å¦‚æœ pattern å®Œå…¨åŒ¹é… URIï¼ˆä¸æ˜¯åªåŒ¹é… URI çš„å¤´éƒ¨ï¼‰ 3. ^~ 4. ~ æˆ– ~* 5. (None) pattern åŒ¹é… URI çš„å¤´éƒ¨3. å®é™…ä½¿ç”¨å»ºè®®æ‰€ä»¥å®é™…ä½¿ç”¨ä¸­ï¼Œä¸ªäººè§‰å¾—è‡³å°‘æœ‰ä¸‰ä¸ªåŒ¹é…è§„åˆ™å®šä¹‰ï¼Œå¦‚ä¸‹ï¼šç›´æ¥åŒ¹é…ç½‘ç«™æ ¹ï¼Œé€šè¿‡åŸŸåè®¿é—®ç½‘ç«™é¦–é¡µæ¯”è¾ƒé¢‘ç¹ï¼Œä½¿ç”¨è¿™ä¸ªä¼šåŠ é€Ÿå¤„ç†ï¼Œå®˜ç½‘å¦‚æ˜¯è¯´ã€‚è¿™é‡Œæ˜¯ç›´æ¥è½¬å‘ç»™åç«¯åº”ç”¨æœåŠ¡å™¨äº†ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé™æ€é¦–é¡µ ç¬¬ä¸€ä¸ªå¿…é€‰è§„åˆ™ 123location = / &#123; proxy_pass http://tomcat:8080/index&#125; ç¬¬äºŒä¸ªå¿…é€‰è§„åˆ™æ˜¯å¤„ç†é™æ€æ–‡ä»¶è¯·æ±‚ï¼Œè¿™æ˜¯nginxä½œä¸ºhttpæœåŠ¡å™¨çš„å¼ºé¡¹,æœ‰ä¸¤ç§é…ç½®æ¨¡å¼ï¼Œç›®å½•åŒ¹é…æˆ–åç¼€åŒ¹é…,ä»»é€‰å…¶ä¸€æˆ–æ­é…ä½¿ç”¨ 123location ^~ /static/ &#123; root /webroot/static/;&#125; 123location ~* \\.(gif|jpg|jpeg|png|css|js|ico)$ &#123; root /webroot/res/;&#125; ç¬¬ä¸‰ä¸ªè§„åˆ™å°±æ˜¯é€šç”¨è§„åˆ™ï¼Œç”¨æ¥è½¬å‘åŠ¨æ€è¯·æ±‚åˆ°åç«¯åº”ç”¨æœåŠ¡å™¨ï¼Œéé™æ€æ–‡ä»¶è¯·æ±‚å°±é»˜è®¤æ˜¯åŠ¨æ€è¯·æ±‚ï¼Œè‡ªå·±æ ¹æ®å®é™…æŠŠæ¡ 123location / &#123; proxy_pass http://tomcat:8080/&#125;","categories":[{"name":"æœåŠ¡å™¨","slug":"æœåŠ¡å™¨","permalink":"https://htchz.cc/categories/æœåŠ¡å™¨/"}],"tags":[{"name":"Nginx","slug":"Nginx","permalink":"https://htchz.cc/tags/Nginx/"}],"author":"åœŸå·"},{"title":"[Spring]SpringåŠ è½½å‚æ•°é‚£äº›äº‹","slug":"SpringåŠ è½½å‚æ•°é‚£äº›äº‹","date":"2018-03-10T07:06:00.000Z","updated":"2018-10-22T03:34:46.000Z","comments":true,"path":"298553133.html","link":"","permalink":"https://htchz.cc/298553133.html","excerpt":"","text":"1. é€šè¿‡&lt;context:property-placeholder location=â€classpath:conn.propertiesâ€ &gt;1234567 &lt;context:property-placeholder location=\"classpath:conn.properties\"/&gt;&lt;bean id=\"dataSource\" class=\"$&#123;dataSource&#125;\"&gt; &lt;!-- è¿™äº›é…ç½®Springåœ¨å¯åŠ¨æ—¶ä¼šå»conn.propertiesä¸­æ‰¾ --&gt; &lt;property name=\"driverClass\" value=\"$&#123;driverClass&#125;\" /&gt; &lt;property name=\"jdbcUrl\" value=\"$&#123;jdbcUrl&#125;\" /&gt; &lt;property name=\"user\" value=\"$&#123;user&#125;\" /&gt; &lt;property name=\"password\" value=\"$&#123;password&#125;\" /&gt; &lt;/bean&gt; 2. é€šè¿‡@Valueæ³¨è§£@Valueæ³¨è§£æœ‰ä¸¤ç§Configurerå¯ä»¥ä½¿ç”¨ï¼Œä¸€ç§æ˜¯PropertiesFactoryBeanï¼Œå¦ä¸€ç§æ˜¯PropertyPlaceholderConfigurerï¼Œåè€…æ³¨é‡äºæ¨¡æ¿${} 123456789&lt;!-- ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ³¨å…¥ï¼Œä¸»è¦ç”¨åœ¨javaä»£ç ä¸­ä½¿ç”¨æ³¨è§£æ³¨å…¥propertiesæ–‡ä»¶ä¸­ç›¸åº”çš„valueå€¼ --&gt; &lt;bean id=\"prop\" class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\"&gt; &lt;!-- æˆ–è€…ä½¿ç”¨&lt;bean id=\"prop\" class=\"org.springframework.beans.factory.config.PropertiesFactoryBean\"&gt; --&gt; &lt;property name=\"locations\"&gt;&lt;!-- è¿™é‡Œæ˜¯PropertiesFactoryBeanç±»ï¼Œå®ƒä¹Ÿæœ‰ä¸ªlocationså±æ€§ï¼Œä¹Ÿæ˜¯æ¥æ”¶ä¸€ä¸ªæ•°ç»„ï¼Œè·Ÿä¸Šé¢ä¸€æ · &lt;array&gt; &lt;value&gt;classpath:public.properties&lt;/value&gt; &lt;/array&gt; &lt;/property&gt; &lt;/bean&gt; ç„¶ååœ¨beané‡Œä½¿ç”¨@Value(â€œ#{beanId[property_name]}â€)(PropertiesFactoryBean)æˆ–è€…@Value(â€œ${xxxxx}â€)(PropertyPlaceholderConfigurer)å³å¯ï¼Œå¦‚public.propertiesé‡Œæœ‰ username=htc é‚£ä¹ˆåœ¨beané‡Œä½¿ç”¨@Value(â€œ${username}â€) String username æ³¨å…¥åœ¨æ–¹æ³•å‚æ•° æ³¨æ„è¦æœ‰setæ–¹æ³•æ‰èƒ½è¢«æ³¨å…¥è¿›æ¥ï¼Œæ³¨è§£å†™åœ¨setæ–¹æ³•ä¸Šå³å¯ã€‚åœ¨setFilePathæ–¹æ³•ä¸­é€šè¿‡æ§åˆ¶å°æ‰“å°filePathæ˜¯ä¸ºäº†åœ¨å¯åŠ¨tomcatçš„æ—¶å€™ï¼Œè§‚å¯Ÿæ§åˆ¶å°æœ‰æ²¡æœ‰è¾“å‡ºæ¥ï¼Œå¦‚æœæœ‰ï¼Œè¯´æ˜Springåœ¨å¯åŠ¨æ—¶ï¼Œå·²ç»å°†filePathç»™åŠ è½½å¥½äº†ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ§åˆ¶å°çš„å¯åŠ¨ä¿¡æ¯ï¼š3. é‡è¦ï¼šç¬¬ä¸‰ç§@ConfigurationProperties 123456@Bean(value = \"dataSource\", destroyMethod = \"close\", initMethod = \"init\")@Primary@ConfigurationProperties(prefix = \"druid\")public DataSource getDataSource(@Value(\"$&#123;jdbcUrl&#125;\") String jdbcUrl,@Value(\"$&#123;user&#125;\") String user,@Value(\"$&#123;password&#125;\") String password)&#123; return DataSourceBuilder.create().username(user).password(password).type(DruidDataSource.class).url(jdbcUrl).build();&#125; è¿™é‡Œä½¿ç”¨äº†@ConfigurationPropertiesåœ¨ä½¿å¾—åœ¨å¤„ç†beançš„æ—¶å€™å¯ä»¥è‡ªåŠ¨æ ¹æ®fieldnameæ³¨å…¥å€¼ç„¶è€Œä½¿ç”¨ä¸Šé¢çš„é…ç½®æ˜¯ä¸ä¼šæ³¨å…¥çš„ï¼Œå› ä¸ºè¯»ä¸åˆ°ï¼ä¸Šé¢çš„é…ç½®æ˜¯ç”¨PropertyPlaceholderConfigurerè¿™ä¸ªç±»æ¥å­˜å‚¨é…ç½®æ–‡ä»¶ï¼Œè€Œ@ConfigurationPropertiesæ˜¯ä½¿ç”¨è¿™ä¸ªç±» org.springframework.context.support.PropertySourcesPlaceholderConfigureræ‰€ä»¥è¦é…ç½®çš„è¯å¾—è¿™ä¹ˆé…ç½® 1234567&lt;bean id=\"resourcePropertyConfigurer\" class=\"org.springframework.context.support.PropertySourcesPlaceholderConfigurer\"&gt; &lt;property name=\"locations\"&gt; &lt;list&gt; &lt;value&gt;classpath*:druid.properties&lt;/value&gt; &lt;/list&gt; &lt;/property&gt;&lt;/bean&gt; å®é™…ä¸ŠPropertySourcesPlaceholderConfigureræ˜¯springframeworkåæ¥å‡ºçš„ï¼Œç›¸å½“äºPropertyPlaceholderConfigurerçš„å‡çº§ç‰ˆ druid.propertiesé‡Œçš„å†…å®¹ç±»ä¼¼äº druid.initialSize=10 druid.minIdle=1 ...å¦‚ä¸Šï¼Œspringè¿˜å¯ä»¥è‡ªåŠ¨æ ¹æ®å‰ç¼€è£…é…ï¼Œæ ¹æ®å±æ€§åæ¨¡ç³ŠåŒ¹é…ã€‚ springä½¿ç”¨äº†æ¨¡ç³ŠåŒ¹é…ï¼Œå¯¹äºä¸€ä¸ªå±æ€§å¯ä»¥ç”Ÿæˆå‡ åä¸ªå˜ç§ï¼Œå¦‚æœ‰ä¸ªå±æ€§å«â€serverPortâ€ï¼Œå¯ä»¥æœ‰â€œserverPortâ€œã€â€œserver-portâ€œã€â€œserverportâ€œç­‰å¾ˆå¤šå˜ç§ï¼Œæ˜¯ä¸€ç§æ¾æ‡ˆçš„åŒ¹é…ï¼Œç„¶åå¯¹äºç”Ÿæˆçš„å‡ åç§å˜ç§éå†ï¼Œé€ä¸€å’ŒpropertiesåŒ¹é…ï¼ŒåŒ¹é…åˆ°ç¬¬ä¸€ä¸ªå°±è¿”å› ä»¥ä¸Šå°±æ˜¯SpringåŠ è½½propertiesé…ç½®æ–‡ä»¶çš„å‡ ç§æ–¹å¼ã€‚å®é™…ä¸Šï¼Œä¸Šé¢åŸºäºxmlæ–¹å¼ä¸­çš„PropertyPlaceholderConfigurerç±»å’Œè¿™é‡ŒåŸºäºæ³¨è§£æ–¹å¼çš„PropertiesFactoryBeanç±»éƒ½æ˜¯ç»§æ‰¿PropertiesLoaderSupportï¼Œéƒ½æ˜¯ç”¨æ¥åŠ è½½propertiesé…ç½®æ–‡ä»¶çš„ã€‚ åœ¨springé…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹äºbeançš„é…ç½®æœ‰è¿™æ ·ä¸€ä¸ªé…ç½®ï¼š&lt;property name=â€ignoreUnresolvablePlaceholdersâ€ value=â€trueâ€ /&gt;è¿™ä¸ªä¸»è¦æ˜¯ä¸ºäº†è§£å†³æŠ›å‡ºcannot be resolvedçš„å¼‚å¸¸ã€‚","categories":[{"name":"Spring","slug":"Spring","permalink":"https://htchz.cc/categories/Spring/"}],"tags":[{"name":"properties","slug":"properties","permalink":"https://htchz.cc/tags/properties/"}],"author":"åœŸå·"},{"title":"[qps]HystrixRollingNumber,å¯ä½œä¸ºä¸€ä¸ªqpsè®¡æ•°å™¨","slug":"HystrixRollingNumber-å¯ä½œä¸ºä¸€ä¸ªqpsè®¡æ•°å™¨","date":"2018-03-10T06:53:00.000Z","updated":"2019-06-24T07:32:04.000Z","comments":true,"path":"10902277.html","link":"","permalink":"https://htchz.cc/10902277.html","excerpt":"","text":"Hystrixæ˜¯Netflixå¼€æºçš„ä¸€æ¬¾å®¹é”™ç³»ç»Ÿï¼Œèƒ½å¸®åŠ©ä½¿ç”¨è€…ç å‡ºå…·å¤‡å¼ºå¤§çš„å®¹é”™èƒ½åŠ›å’Œé²æ£’æ€§çš„ç¨‹åºã€‚ 1. å‰è¨€è€ƒè™‘åˆ°ä¸€ç§éœ€æ±‚åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿè®¡ç³»ç»Ÿqpsã€æ¯ç§’å¹³å‡é”™è¯¯ç‡ç­‰ã€‚qpsè¡¨ç¤ºæ¯ç§’çš„è¯·æ±‚æ•°ç›®ï¼Œèƒ½æƒ³åˆ°çš„æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç»Ÿè®¡ä¸€å®šæ—¶é—´å†…çš„è¯·æ±‚æ€»æ•°ç„¶åé™¤ä»¥æ€»ç»Ÿè®¡æ—¶é—´ï¼Œæ‰€ä»¥è®¡æ•°æ˜¯å…¶ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚é€šå¸¸æˆ‘ä»¬çš„é¢ç³»ç»Ÿæ˜¯å·¥ä½œåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œæ‰€ä»¥è®¡æ•°æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨AtomicInteger/AtomicLongç³»åˆ—ï¼ŒAtomXXXä¸­æ²¡æœ‰ä½¿ç”¨é”ï¼Œä½¿ç”¨çš„æ˜¯å¾ªç¯+CASï¼Œåœ¨å¤šçº¿ç¨‹çš„æ¡ä»¶ä¸‹å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘é”å¸¦æ¥çš„æ€§èƒ½æŸå¤±ã€‚ä½†æ˜¯åœ¨ç«äº‰ç‰¹åˆ«æ¿€çƒˆçš„æƒ…å†µï¼Œä¼šå¤§é‡å‡ºç°casä¸æˆåŠŸçš„æƒ…å†µå¸¦æ¥æ€§èƒ½ä¸Šçš„å¼€é”€ã€‚ä¸ºäº†æ›´è¿›ä¸€æ­¥åˆ†æ•£çº¿ç¨‹å†™çš„å‹åŠ›ï¼ŒJDK8ä¸­å¼•å…¥äº†LongAdderï¼ŒLongAdderä¼šåˆ†æˆå¤šä¸ªæ¡¶ï¼Œå°†æ¯ä¸ªçº¿ç¨‹ç»‘å®šåˆ°å›ºå®šçš„æ¡¶ç©ºé—´ä¸­è¿›è¡Œè¯»å†™ï¼Œè®¡æ•°å¯ä»¥å¯¹æ‰€æœ‰çš„æ¡¶ä¸­çš„å€¼æ±‚æ€»æ•°ã€‚å‰é¢æåˆ°æ±‚qpsæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç»Ÿè®¡ä¸€å®šæ—¶é—´å†…çš„è¯·æ±‚æ€»æ•°ç„¶åé™¤ä»¥æ€»ç»Ÿè®¡æ—¶é—´ï¼Œè¿™æ ·çš„æ–¹æ³•è™½ç„¶ç®€å•ä½†æ˜¯å¯¹æœ‰ä¸€å®šçš„é—®é¢˜ï¼Œæ¯”å¦‚è¯´ç»Ÿè®¡å‡ºçš„qpsè·³è·ƒæ€§ä¼šæ¯”è¾ƒå¤§ï¼Œä¸å¤Ÿå¹³æ»‘ç­‰ã€‚åœ¨æœ¬æ–‡ä¸­å°†ä»‹ç»HystrixRollingNumberï¼Œè¿™æ˜¯Hystrixçš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„åœ¨ç»Ÿè®¡qpsç­‰ç±»ä¼¼çš„æ±‚å’Œç»Ÿè®¡çš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚ è¦æˆ‘è‡ªå·±å†™çš„è¯ã€‚ã€‚è¦ä¹ˆç²’åº¦å¤ªå¤§ï¼Œä¸å¤Ÿå¹³æ»‘ï¼Œè¦ä¹ˆç²’åº¦å°äº†ï¼Œä¸€å †é”ç«äº‰ã€‚ 2. åŸºæœ¬åŸç†å¦‚å‰æ‰€è¯´ï¼ŒHystrixRollingNumberä¸­åˆ©ç”¨äº†LongAdderï¼Œä¹Ÿå€Ÿé‰´äº†LongAdderåˆ†æ®µçš„æ€æƒ³ã€‚HystrixRollingNumberåŸºæœ¬æ€æƒ³å°±æ˜¯åˆ†æ®µç»Ÿè®¡ï¼Œæ¯”å¦‚è¯´è¦ç»Ÿè®¡qpsï¼Œå³1ç§’å†…çš„è¯·æ±‚æ€»æ•°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å°†1sçš„æ—¶é—´åˆ†æˆ10æ®µï¼Œæ¯æ®µ100msã€‚åœ¨ç¬¬ä¸€ä¸ª100mså†…ï¼Œå†™å…¥ç¬¬ä¸€ä¸ªæ®µä¸­è¿›è¡Œè®¡æ•°ï¼Œåœ¨ç¬¬äºŒä¸ª100mså†…ï¼Œå†™å…¥ç¬¬äºŒä¸ªæ®µä¸­è¿›è¡Œè®¡æ•°ï¼Œè¿™æ ·å¦‚æœè¦ç»Ÿè®¡å½“å‰æ—¶é—´çš„qpsï¼Œæˆ‘ä»¬æ€»æ˜¯å¯ä»¥é€šè¿‡ç»Ÿè®¡å½“å‰æ—¶é—´å‰1sï¼ˆå…±10æ®µï¼‰çš„è®¡æ•°æ€»å’Œå€¼ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹HystrixRollingNumberä¸­å…·ä½“æ˜¯æ€ä¹ˆåšçš„ã€‚ 3. BucketHystrixRollingNumberä¸­å¯¹Bucketçš„æè¿°æ˜¯â€œCounters for a given â€˜bucketâ€™ of timeâ€ï¼Œå³â€œç»™å®šæ—¶é—´æ¡¶å†…çš„è®¡æ•°å™¨â€ï¼Œä¹Ÿå³æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„â€œæ®µâ€ã€‚Bucketä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„å±æ€§å€¼ final long windowStart; final LongAdder[] adderForCounterType; final LongMaxUpdater[] updaterForCounterType;windowStartè®°å½•äº†è¯¥Bucketæ‰€å±çš„æ—¶é—´æ®µçš„å¼€å§‹æ—¶é—´ï¼ŒadderForCounterTypeæ˜¯ä¸€ä¸ªLongAdderæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨äº†ä¸€ç§äº‹ä»¶ç±»å‹çš„è®¡æ•°å€¼ã€‚updaterForCounterTypeåŒç†ã€‚adderForCounterTypeæ•°ç»„çš„é•¿åº¦ç­‰äºäº‹ä»¶ç±»å‹çš„ä¸ªæ•°ï¼Œå…·ä½“çš„äº‹ä»¶ç±»å‹å¯ä»¥å‚è€ƒHystrixRollingNumberEventæšä¸¾ç±»ã€‚ç›¸å…³çš„æ–¹æ³•ä»‹ç»å¦‚ä¸‹(ä»¥ä¸‹ä»£ç å»æ‰äº†LongMaxUpdaterç›¸å…³ï¼ŒLongMaxUpdaterç”¨æ¥ç»Ÿè®¡æœ€å¤§å€¼ï¼Œå’ŒLongAdderç±»ä¼¼å¯ç±»æ¯”)ï¼š long get(HystrixRollingNumberEvent type):è·å–äº‹ä»¶å¯¹åº”çš„LongAdderçš„æ€»å’Œ LongAdder getAdder(HystrixRollingNumberEvent type):è·å–äº‹ä»¶å¯¹åº”çš„LongAdderå¯¹è±¡ 4. ListStateHystrixRollingNumberä¸­å¯¹ListStateçš„æè¿°æ˜¯â€œImmutable object that is atomically set every time the state of the BucketCircularArray changesï¼ŒThis handles the compound operationsâ€ï¼Œå³â€œListStateæ˜¯ä¸ªä¸å¯å˜ç±»ï¼Œæ¯æ¬¡BucketCircularArrayçŠ¶æ€æ”¹å˜çš„æ—¶å€™ï¼Œä¼šæ–°å»ºä¸€ä¸ªå¹¶ä¸”ä¼šåŸå­åœ°è®¾ç½®åˆ°BucketCircularArrayä¸­ï¼Œå®ƒç”¨æ¥å¤„ç†å¤åˆæ“ä½œâ€ã€‚ListStateä¸­æ¯”è¾ƒé‡è¦çš„çš„å±æ€§å€¼ä»‹ç»å¦‚ä¸‹ï¼š private final AtomicReferenceArray data:å®˜æ–¹çš„è¯´æ˜æ˜¯â€œthis is an AtomicReferenceArray and not a normal Array because weâ€™re copying the reference between ListState objects and multiple threads could maintain references across these compound operations so I want the visibility/concurrency guaranteesâ€ï¼Œæ„æ€æ˜¯è¯´â€œListStateæŒæœ‰Bucketæ•°ç»„å¯¹è±¡ï¼Œä½†æ˜¯è¿™ä¸ªæ•°ç»„ä¸æ˜¯æ™®é€šçš„æ•°ç»„è€Œæ˜¯AtomicReferenceArrayï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¼šåœ¨ListStateå¯¹è±¡ä¹‹é—´æ‹·è´referenceï¼Œå¤šä¸ªçº¿ç¨‹ä¹‹é—´ä¼šé€šè¿‡å¤åˆæ“ä½œæŒæœ‰å¼•ç”¨ï¼Œæˆ‘ä»¬æƒ³è¦ä¿è¯å¯è§æ€§/å¹¶å‘æ€§â€ï¼ˆAtomicXXXæ˜¯åŸå­æ“ä½œï¼‰ private final int size;ï¼ˆæŒæœ‰çš„Bucketæ•°ç»„å¤§å°ï¼Œå¯ä»¥å¢åŠ ï¼Œä½†æ˜¯æœ€å¤§å€¼æ˜¯numBucketsï¼‰ private final int tail;ï¼ˆæ•°ç»„çš„å°¾éƒ¨åœ°å€ï¼‰ private final int head;ï¼ˆæ•°ç»„çš„å¤´éƒ¨åœ°å€ï¼‰ListStateä¸­æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³• public Bucket tail():è¿”å›æ•°ç»„å°¾éƒ¨çš„å…ƒç´  public ListState clear():æ¸…ç©ºæ•°ç»„å…ƒç´  public ListState addBucket(Bucket b):åœ¨å°¾éƒ¨å¢åŠ ä¸€ä¸ªBucketListStateæ˜¯ä¸ªä¸å¯å˜ç±»ï¼Œéµå¾ªè€…ä¸å¯å˜ç±»çš„åŸåˆ™ Fieldsä¸ºfinalï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­å…¨éƒ¨å‘å¸ƒä¸€æ¬¡copy on writeï¼Œå†™æ–¹æ³•ï¼ˆaddBucketï¼‰è¿”å›æ–°çš„ListStateListStateç®—æ˜¯ä¸ªåŠ©æ‰‹ç±»ï¼Œç»´æŒäº†ä¸€ä¸ªBucketæ•°ç»„ï¼Œå®šä¹‰äº†ä¸€äº›å›´ç»•ç€Bucketæ•°ç»„çš„æœ‰ç”¨æ“ä½œï¼Œå¹¶ä¸”è‡ªèº«æ˜¯ä¸ªä¸å¯å˜ç±»ï¼Œå¤©ç„¶çš„çº¿ç¨‹å®‰å…¨å±æ€§ã€‚ 5. BucketCircularArrayä»åå­—ä¸Šæ¥è¯´æ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªBucketï¼Œäº‹å®ä¸Šå¤§éƒ¨åˆ†æ“ä½œéƒ½æ˜¯è½åˆ°äº†ListStateæ•°æ®ç»“æ„ä¸ŠBucketCircularArrayä¸­æ¯”è¾ƒé‡è¦çš„å±æ€§å€¼ä»‹ç»å¦‚ä¸‹ï¼š private final AtomicReference state: ç»´æŒäº†ä¸€ä¸ªListStateçš„AtomicReference private final int numBuckets:ç¯çš„å¤§å° å…¶ä¸­ä¸»è¦çš„æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªæ–¹æ³•æ˜¯ï¼špublic void addLast(Bucket o) : 12345678910111213141516171819public void addLast(Bucket o) &#123; ListState currentState = state.get(); // create new version of state (what we want it to become) ListState newState = currentState.addBucket(o); //è¿™é‡Œè¿”å›æ–°çš„ListStateå®ä¾‹ /* * use compareAndSet to set in case multiple threads are attempting (which shouldn&apos;t be the case because since addLast will ONLY be called by a single thread at a time due to protection * provided in &lt;code&gt;getCurrentBucket&lt;/code&gt;) */ if (state.compareAndSet(currentState, newState)) &#123; // we succeeded return; &#125; else &#123; // we failed, someone else was adding or removing // instead of trying again and risking multiple addLast concurrently (which shouldn&apos;t be the case) // we&apos;ll just return and let the other thread &apos;win&apos; and if the timing is off the next call to getCurrentBucket will fix things return; &#125;&#125; è¿™ä¸ªæ–¹æ³•ä¸»è¦å°±æ˜¯ä¸ºäº†åœ¨ListStateçš„å°¾éƒ¨æ·»åŠ ä¸€ä¸ªBucketï¼Œå¹¶ä¸”å°†æ–°è¿”å›çš„ListStateå¯¹è±¡CASåˆ°stateä¸­ï¼Œä½†æ˜¯å…¶ä¸­æœ‰ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„å¤„ç†ï¼Œå°±æ˜¯åœ¨ä¸€æ¬¡CASä¸æˆåŠŸçš„æ—¶å€™ï¼Œç¨‹åºå®Œå…¨å¿½ç•¥è¿™æ¬¡å¤±è´¥ã€‚æ³¨é‡Šæ˜¯è¿™ä¹ˆè§£é‡Šçš„â€œwe failed, someone else was adding or removing instead of trying again and risking multiple addLast concurrently (which shouldnâ€™t be the case) weâ€™ll just return and let the other thread â€˜winâ€™ and if the timing is off the next call to getCurrentBucket will fix thingsâ€ã€‚å¤§æ¦‚æ„æ€å°±æ˜¯è¯´å¦‚æœCASå¤±è´¥æ˜¯å› ä¸ºå…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰§è¡Œaddingæˆ–è€…removingæ“ä½œã€‚æˆ‘ä»¬ä¸é‡è¯•ï¼Œè€Œåªæ˜¯è¿”å›è®©å…¶ä»–çº¿ç¨‹â€œwinâ€(è¿™åªæ˜¯ä¸€ä¸ªåˆ›å»ºæ¡¶çš„æ“ä½œ)ï¼Œå¦‚æœæ—¶é—´ç‰‡æµé€äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹æ¬¡è°ƒç”¨getCurrentBucketè¿›è¡Œè¡¥å¿ï¼ˆè¯¦ç»†çš„è¯·çœ‹ä¸‹é¢å¯¹äºgetCurrentBucketçš„åˆ†æï¼‰ 6. HystrixRollingNumberå®˜æ–¹docä¸­ç»™å…¶çš„å®šä¹‰æ˜¯â€œA number which can be used to track counters (increment) or set values over time.â€ï¼Œç”¨æ¥ç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…çš„è®¡æ•°ã€‚å…¶ä¸­æ¯”è¾ƒé‡è¦çš„çš„å±æ€§å€¼å¦‚ä¸‹ï¼š private final Time time: è·å–å½“å‰æ—¶é—´æ¯«ç§’å€¼ final int timeInMilliseconds: ç»Ÿè®¡çš„æ—¶é—´é•¿åº¦ï¼ˆæ¯«ç§’å•ä½ï¼‰ final int numberOfBuckets: Bucketçš„æ•°é‡ï¼ˆåˆ†æˆå¤šå°‘æ®µè¿›è¡Œç»Ÿè®¡ï¼‰ final int bucketSizeInMillseconds: æ¯ä¸ªBucketæ‰€å¯¹åº”çš„æ—¶é—´ç‰‡ï¼ˆæ¯«ç§’å•ä½ï¼‰ final BucketCircularArray buckets: ä½¿ç”¨BucketCircularArrayå¸®åŠ©ç»´æŒç¯å½¢æ•°ç»„æ¡¶ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374Bucket getCurrentBucket() &#123; // è·å–å½“å‰çš„æ¯«ç§’æ—¶é—´ long currentTime = time.getCurrentTimeInMillis(); //è·å–æœ€åä¸€ä¸ªBucketï¼ˆå³æœ€æ–°ä¸€ä¸ªBucketï¼‰ Bucket currentBucket = buckets.peekLast(); if (currentBucket != null &amp;&amp; currentTime &lt; currentBucket.windowStart + this.bucketSizeInMillseconds) &#123; //å¦‚æœå½“å‰æ—¶é—´æ˜¯åœ¨currentBucketå¯¹åº”çš„æ—¶é—´çª—å£å†…ï¼Œç›´æ¥è¿”å›currentBucket return currentBucket; &#125; /* if we didn&apos;t find the current bucket above, then we have to create one */ //å¦‚æœå½“å‰æ—¶é—´å¯¹åº”çš„Bucketä¸å­˜åœ¨ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª if (newBucketLock.tryLock()) &#123; //å°è¯•è·å–ä¸€æ¬¡é” try &#123; if (buckets.peekLast() == null) &#123; // the list is empty so create the first bucket //é¦–æ¬¡åˆ›å»º Bucket newBucket = new Bucket(currentTime); buckets.addLast(newBucket); return newBucket; &#125; else &#123; // We go into a loop so that it will create as many buckets as needed to catch up to the current time // as we want the buckets complete even if we don&apos;t have transactions during a period of time. // å°†åˆ›å»ºä¸€ä¸ªæˆ–è€…å¤šä¸ªBucketï¼Œç›´åˆ°Bucketä»£è¡¨çš„æ—¶é—´çª—å£èµ¶ä¸Šå½“å‰æ—¶é—´ for (int i = 0; i &lt; numberOfBuckets; i++) &#123; // we have at least 1 bucket so retrieve it Bucket lastBucket = buckets.peekLast(); if (currentTime &lt; lastBucket.windowStart + this.bucketSizeInMillseconds) &#123; // if we&apos;re within the bucket &apos;window of time&apos; return the current one // NOTE: We do not worry if we are BEFORE the window in a weird case of where thread scheduling causes that to occur, // we&apos;ll just use the latest as long as we&apos;re not AFTER the window return lastBucket; &#125; else if (currentTime - (lastBucket.windowStart + this.bucketSizeInMillseconds) &gt; timeInMilliseconds) &#123; // the time passed is greater than the entire rolling counter so we want to clear it all and start from scratch reset(); // recursively call getCurrentBucket which will create a new bucket and return it return getCurrentBucket(); &#125; else &#123; // we&apos;re past the window so we need to create a new bucket // create a new bucket and add it as the new &apos;last&apos; buckets.addLast(new Bucket(lastBucket.windowStart + this.bucketSizeInMillseconds)); // add the lastBucket values to the cumulativeSum cumulativeSum.addBucket(lastBucket); &#125; &#125; // we have finished the for-loop and created all of the buckets, so return the lastBucket now return buckets.peekLast(); &#125; &#125; finally &#123; //é‡Šæ”¾é” newBucketLock.unlock(); &#125; &#125; else &#123; //å¦‚æœè·å–ä¸åˆ°é”ï¼Œå°è¯•è·å–æœ€æ–°ä¸€ä¸ªBucket currentBucket = buckets.peekLast(); if (currentBucket != null) &#123; //å¦‚æœä¸ä¸ºnullï¼Œç›´æ¥è¿”å›æœ€æ–°Bucket // we didn&apos;t get the lock so just return the latest bucket while another thread creates the next one return currentBucket; &#125; else &#123; //å¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ›å»ºç¬¬ä¸€ä¸ªBucketï¼Œå°è¯•ç­‰å¾…ï¼Œé€’å½’è°ƒç”¨getCurrentBucket // the rare scenario where multiple threads raced to create the very first bucket // wait slightly and then use recursion while the other thread finishes creating a bucket try &#123; Thread.sleep(5); &#125; catch (Exception e) &#123; // ignore &#125; return getCurrentBucket(); &#125; &#125;&#125; å…¶å®HystrixRollingNumberä¸­å†™äº†å¾ˆå¤šæœ‰ç”¨çš„æ³¨é‡Šï¼Œè§£é‡Šäº†ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚ä¸Šè¿°getCurrentBucketä¸»è¦æ˜¯ä¸ºäº†è·å–å½“å‰æ—¶é—´çª—æ‰€å¯¹åº”çš„Bucketï¼Œä½†æ˜¯ä¸ºäº†å‡å°‘ç«äº‰ï¼Œå…¶ä¸­åªä½¿ç”¨äº†tryLock()ï¼Œå¦‚æœä¸æˆåŠŸåˆ™ç›´æ¥è¿”å›æœ€æ–°çš„ä¸€ä¸ªä¸ä¸ºç©ºçš„Bucketã€‚å¦‚æœè·å–äº†é”åˆ™å°è¯•å¢åŠ Bucketï¼ˆå¢åŠ Bucketä¼šä¸€ç›´å¢åŠ åˆ°Bucketå¯¹åº”çš„æ—¶é—´çª—å£è¦†ç›–å½“å‰æ—¶é—´ï¼‰ã€‚è¿™æ ·å¤„ç†ä¼šæœ‰ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯è·å–çš„Bucketå¯èƒ½æ²¡æœ‰è¦†ç›–å½“å‰æ—¶é—´ï¼ˆåŸå› æ˜¯ currentTimeåªè·å–ä¸€æ¬¡ï¼Œåœ¨forå¾ªç¯çš„è¿‡ç¨‹ä¸­ä¼šè¿‡æ—¶ï¼‰ï¼Œè¿™æ˜¯ä¸ºäº†å‡å°‘ç«äº‰ï¼Œæé«˜æ•ˆç‡ï¼Œè€Œä¸”æœªåˆ›å»ºçš„bucketæœ€ç»ˆè¿˜æ˜¯ä¼šè¢«åˆ›å»ºï¼ˆä¸‹ä¸€æ¬¡getCurrentBucket()ï¼‰ï¼Œè¿™åœ¨ç»Ÿè®¡çš„åœºæ™¯ä¸‹å¯ä»¥å®¹å¿ï¼Œå°†è®¡æ•°ç»Ÿè®¡åˆ°ä¹‹å‰çš„æ—¶é—´çª—å£å†…åœ¨è®¡ç®—qpsç­‰æ•°å€¼æ—¶é€šå¸¸ä¸ä¼šæœ‰å¤ªå¤§å½±å“ï¼ˆnumberOfBucketsé€šå¸¸ä¸æ­¢ä¸€ä¸ªï¼‰ã€‚ 7. æ€»ç»“HystrixRollingNumberè¿™ä¸ªæ•°æ®ç»“æ„ç”¨äºç»Ÿè®¡qpså¾ˆæœ‰ç”¨ï¼Œé€šå¸¸è¿™ç§ç»Ÿè®¡éœ€æ±‚ï¼ˆé™æµç›‘æ§ç»Ÿè®¡qpsçš„åœºæ™¯ä¸‹ï¼‰ä¸èƒ½å½±å“ä¸»è¦ä¸šåŠ¡ï¼Œå¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜ï¼ŒHystrixRollingNumberä¸­é‡‡å–äº†å¾ˆå¤šæŠ€å·§é¿å…ä½¿ç”¨é”ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹ç«äº‰ï¼Œæ‰€ä»¥HystrixRollingNumberæ•ˆç‡ä¼šéå¸¸é«˜ã€‚","categories":[{"name":"å¾®æœåŠ¡","slug":"å¾®æœåŠ¡","permalink":"https://htchz.cc/categories/å¾®æœåŠ¡/"}],"tags":[{"name":"æœåŠ¡é™æµ","slug":"æœåŠ¡é™æµ","permalink":"https://htchz.cc/tags/æœåŠ¡é™æµ/"},{"name":"Hystrix","slug":"Hystrix","permalink":"https://htchz.cc/tags/Hystrix/"}],"author":"åœŸå·"},{"title":"[ç¢§æ²¹é¸¡]Hexo-adminçš„404æ¢ç´¢","slug":"ç¢§æ²¹é¸¡-Hexo","date":"2018-03-10T02:58:00.000Z","updated":"2020-06-06T17:53:23.395Z","comments":true,"path":"3915904827.html","link":"","permalink":"https://htchz.cc/3915904827.html","excerpt":"","text":"ä½œä¸ºä¸€ä¸ªä¸æ‡‚jsçš„åç«¯å¼€å§‹äº†çæã€‚ã€‚ hexo-adminåœ¨å†™çš„æ—¶å€™ï¼Œä¸€èˆ¬æ˜¯æŠŠå›¾ç‰‡æ”¾åˆ°å›¾åºŠï¼Œå†è·å¾—å›¾ç‰‡é“¾æ¥åŠ å…¥mdï¼Œä½†æ˜¯ç¬”è€…ä¹ æƒ¯äº†ä¸ºçŸ¥ç¬”è®°ç›´æ¥æŠŠå›¾ç‰‡å¤åˆ¶ç²˜è´´è¿›mdé‡Œã€‚ä¸è¿‡hexo-adminç¡®å®åŠ å…¥äº†è¿™ä¸ªç›´æ¥ç²˜è´´å›¾ç‰‡çš„åŠŸèƒ½ï¼ŒæŠŠå›¾ç‰‡å¤åˆ¶è¿›mdé‡Œï¼Œæœ‰æ—¶ä¼šå‡ºç°ä¸€ä¸ª404çš„é—®é¢˜ï¼Œä¸€ç›´ç™¾åº¦è°·æ­Œæ— æœï¼ŒåŒäº‹è€å“¥ä¸€ç›´å«æˆ‘ç”¨gitbookï¼Œä½†æ˜¯ä¸æ‰¾å‡ºè¿™ä¸ª404çš„è°œåº•å®åœ¨éš¾å—ï¼Œäºæ˜¯æœ‰äº†ä¸‹é¢çš„è®°å½•ã€‚ 1. First Blood ç¬¬ä¸€å¼ å›¾å¦‚ä¸Šå›¾ï¼Œä¸Šä¼ æˆåŠŸåå‡ºç°äº†404ï¼Œç‚¹å‡»404å‘ç”Ÿçš„ä»£ç ï¼Œå¦‚ä¸‹ï¼šhexo-adminç›´æ¥ç”Ÿæˆhtmlè¿›è¡Œhtmlå†…å®¹çš„æ›¿æ¢ã€‚å¯ä»¥çœ‹åˆ°ç¬”è€…æŠŠå›¾ç‰‡ç²˜è´´ä¹‹åï¼Œhexo-adminåšäº†ä¸‰ä¸ªæ“ä½œï¼š ä¸Šä¼ å›¾ç‰‡ï¼Œè¿”å›![upload successful](/images/pasted-8.png)çš„å­—ç¬¦ä¸²ç»™å®¢æˆ·ç«¯ å®¢æˆ·ç«¯æ ¹æ®è¿”å›çš„å­—ç¬¦ä¸²é‡æ–°æ¸²æŸ“ æŠŠæ–°çš„æ–‡ç« å†…å®¹poståˆ°æœåŠ¡å™¨ ä¸ºä»€ä¹ˆä¸Šä¼ æˆåŠŸè¿˜404???è¿™æ—¶ç¬”è€…ç‚¹å¼€å›¾ç‰‡çš„é“¾æ¥ æ²¡é—®é¢˜å•Šï¼Œè¯¡å¼‚ã€‚ 2. ç¬¬äºŒå¼ å›¾ç²˜è´´ç¬¬äºŒå¼ å›¾ç‰‡çš„æ—¶å€™ å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è·å–å¤±è´¥çš„Nubia Z17è·å–æˆåŠŸäº†ï¼Œè¯æ˜å›¾ç‰‡æ˜¯ä¸Šä¼ æˆåŠŸï¼Œç„¶è€Œæ—å…å„¿åœ¨ä¸Šä¼ å®Œæˆåï¼Œå¹¶æ²¡æœ‰404 3. ç¬¬ä¸‰å¼ å›¾ç‰‡ç²˜è´´Gakkiï¼Œåˆæ˜¯404 4. å…¶ä»–ç°è±¡ ä¸Šé¢æ˜¯åœ¨å®¿èˆçš„æ“ä½œï¼Œåœ¨å…¬å¸æ“ä½œçš„æ—¶å€™å®Œå…¨æ²¡å‡ºç°è¿™ç§404ã€‚ä¸è¿‡æœ‰ä¸€ä¸ªç°è±¡æ˜¯ï¼Œå…¬å¸ç½‘ç»œpingè¿™å°vpsçš„æ—¶å€™æœ‰ç‚¹æ…¢ï¼Œå®¿èˆç½‘pingè¿™å°vpséå¸¸å¿«ã€‚ æ–°å»ºäº†å¦ä¸€å°vpsï¼ŒåŒæ ·çš„ç¯å¢ƒï¼Œä¹Ÿæ²¡æœ‰404ã€‚ä½†æ˜¯è¿™å°vpsåœ¨æ´›æ‰çŸ¶ï¼Œç½‘ç»œæ—¶å»¶æœ‰ç‚¹å¤§ã€‚ 5. å„ç§å°åŠ¨ä½œäºæ˜¯åœ¨404çš„jsæ‰“ä¸Šæ–­ç‚¹ï¼Œ è¿è¡Œåˆ°è¿™é‡Œä¹‹åï¼Œç»§ç»­æ‰§è¡Œæ‰€æœ‰jsï¼Œæ²¡å‘ç”Ÿ404ã€‚ äºæ˜¯ä¹çŒœæƒ³ï¼š æœåŠ¡å™¨ä¿å­˜å›¾ç‰‡çš„æ¥ä¸‹æ¥ï¼Œè¿”å›äº†responseï¼Œè‚¯å®šè¿˜è¿›è¡Œäº†æŸä¸ªæ“ä½œï¼Œä½†æ˜¯çŸ­æ—¶é—´å†…è¿™ä¸ªæ“ä½œæ²¡å®Œæˆï¼Œå¯¼è‡´çŸ­æ—¶é—´å†…è®¿é—®çš„æ—¶å€™è¿˜ä¸èƒ½é€šã€‚ è¿™å¯ä»¥è§£é‡Šä¸Šé¢ï¼š ç¬¬ä¸€æ¬¡æ“ä½œæ˜¯404ï¼Œç¬¬äºŒæ¬¡å´æ˜¯ä¸¤å¼ å›¾ç‰‡éƒ½æˆåŠŸè¯·æ±‚åˆ°ã€‚åŸå› æ˜¯ç¬¬äºŒæ¬¡è®¿é—®æ—¶ï¼Œç”±äºæˆ‘çš„Nubiaæ²¡æˆåŠŸåŠ è½½ï¼Œä»–ä¼šå»å†è®¿é—®ä¸€æ¬¡ï¼Œè¿™å°±å¯¼è‡´äº†æ—å…å„¿çš„è¯·æ±‚ä¼šç¨æ™šä¸€ç‚¹ï¼Œè€Œè¿™ç‚¹æ—¶é—´é—´éš”é‡Œï¼Œå¯¹æ—å…å„¿çš„æŸä¸ªæ“ä½œå·²ç»å®Œæˆï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡æ“ä½œä¸å­˜åœ¨404ï¼Œè€Œç¬¬ä¸‰æ¬¡æ“ä½œï¼ŒGakkiåˆæ²¡ç»™æŸä¸ªæ“ä½œç•™æ—¶é—´å®Œæˆï¼Œè¯·æ±‚ç»“æœæ˜æ˜¾404ã€‚ å…¬å¸è®¿é—®æˆ‘çš„vpsæ¯”è¾ƒæ…¢ï¼Œç½‘ç»œä¸Šçš„æ—¶å»¶è¶³å¤ŸæŸä¸ªæ“ä½œå®Œæˆ æ–­ç‚¹çš„æ—¶å»¶è¶³å¤ŸæŸä¸ªæ“ä½œå®Œæˆ é‚£ä¹ˆä¸Švpsçœ‹æ—¥å¿—ï¼Œä¸‰æ¬¡æ“ä½œä¾æ¬¡ä¸‰å¼ å›¾ã€‚ hexo server --debugå¯ä»¥è¾“å‡ºæ—¥å¿— åˆ©ç”¨å°å­¦æ‰¾è§„å¾‹é¢˜ç›®çš„å°¿æ€§ï¼Œæˆ‘å‘è§‰404å‘ç”Ÿåœ¨è¿™å¨Generatoræ“ä½œä¹‹å‰ è§„å¾‹ä¸æ˜¯3æ¬¡æ“ä½œæ€»ç»“çš„ï¼Œå…¶å®å¤ç°äº†å¾ˆå¤šæ¬¡äº† ç½‘ä¸Šçœ‹åˆ°hexo-serverä¼šjianè§†sourceæ–‡ä»¶å¤¹çš„å˜åŠ¨ï¼Œæˆ‘æ‰‹åŠ¨æŠŠä¸€å¼ å›¾ç‰‡åŠ å…¥source/imagesç›®å½•ä¸‹ï¼Œä»–ä¹Ÿè‡ªåŠ¨è·‘å‡ºGeneratoræ—¥å¿—ã€‚äºæ˜¯æˆ‘çŒœæƒ³è¿™ä¸ªGeneratorä¸è·‘å®Œï¼Œå°±ä¸èƒ½é€šè¿‡hexo-serverè®¿é—®åˆ°å›¾ç‰‡ã€‚ æ€ä¹ˆéªŒè¯ï¼Œç¢ç£¨å»æ”¹hexo-adminä»£ç ï¼Œä¸Šgithubï¼Œä¸æ‡‚node.jsï¼Œçœ‹åˆ°ä¸€ä¸ªapi.jsçš„å°±ç‚¹è¿›å»ï¼ŒæƒŠå–œæ‰¾åˆ°è¿™ä¸ªæ¥å£ æ¨èä¸ªçœ‹GitHubçš„ç¥å™¨Octotreeï¼Œæˆ‘åœ¨chromeå•†åº—è£…çš„ï¼Œå¯ä»¥ç›´æ¥çœ‹åˆ°GitHubçš„ç›®å½•ã€‚ è¿™ä¸ªæ–¹æ³•æ‹‰åˆ°æœ€åº• 12345678910111213141516... var dataURI = req.body.data.slice('data:image/png;base64,'.length) var buf = new Buffer(dataURI, 'base64') hexo.log.d(`saving image to $&#123;outpath&#125;`) fs.writeFile(outpath, buf, function (err) &#123; if (err) &#123; console.log(err) &#125; hexo.source.process().then(function () &#123; res.done(&#123; src: path.join(hexo.config.root + filename), msg: msg &#125;) &#125;); &#125;)... æŠŠæœåŠ¡å™¨å‘é€å“åº”res.doneè¯­å¥å»¶è¿Ÿ50msæ‰§è¡Œåï¼Œå†ä¹Ÿæ²¡æœ‰å‘ç”Ÿè¿‡è¿‡404 123456789101112131415161718... var dataURI = req.body.data.slice('data:image/png;base64,'.length) var buf = new Buffer(dataURI, 'base64') hexo.log.d(`saving image to $&#123;outpath&#125;`) fs.writeFile(outpath, buf, function (err) &#123; if (err) &#123; console.log(err) &#125; hexo.source.process().then(function () &#123; setTimeout(function()&#123; // ç™¾åº¦æ¥çš„å»¶è¿Ÿæ‰§è¡Œçš„æ–¹æ³•ã€‚ã€‚ res.done(&#123; src: path.join(hexo.config.root + filename), msg: msg &#125;) &#125;, 50); &#125;); &#125;)... ä¸ºä»€ä¹ˆæ˜¯50msï¼Ÿçœ‹æ—¥å¿—çš„æ—¶é—´ï¼Œ100mså·¦å³å¯ä»¥ä¿è¯Generatoræ“ä½œå®Œæˆï¼Œäºæ˜¯æˆ‘ç›´æ¥è®¾ç½®50msï¼Œåˆ°ç°åœ¨ä¹Ÿæ²¡å†404è¿‡ã€‚ 6. åè®°æˆ‘çœ‹hexo-adminä¹Ÿæ²¡äººæè¿™ä¸ªissueï¼Œä¼°è®¡ç›´æ¥ç²˜è´´å›¾ç‰‡çš„äººä¸å¤šï¼Œæ¯•ç«Ÿè¿™ç§æ–¹æ³•ä¸èƒ½æ¸…ç†mdä¸å†å¼•ç”¨çš„å›¾ç‰‡ã€‚æˆ‘èƒ½æƒ³åˆ°çš„è§£å†³æ–¹æ³•å°±æ˜¯å»¶è¿Ÿæ‰§è¡Œå†å“åº”è¯·æ±‚äº†ï¼Œæ¯•ç«Ÿè¿™ä¸ªçº¿ç¨‹ä¹Ÿä¸æ¸…æ¥šGeneratorä»€ä¹ˆæ—¶å€™æ‰æ‰§è¡Œå®Œã€‚ã€‚ã€‚","categories":[{"name":"å»ºç«™","slug":"å»ºç«™","permalink":"https://htchz.cc/categories/å»ºç«™/"}],"tags":[{"name":"BUG","slug":"BUG","permalink":"https://htchz.cc/tags/BUG/"}],"author":"åœŸå·"},{"title":"[å»ºç«™]Hexo+Nginx+VPSå®ç°HTTPSå»ºç«™","slug":"å»ºç«™-Hexo+Nginx+VPSå®ç°HTTPSå»ºç«™","date":"2018-03-08T10:02:00.000Z","updated":"2019-08-21T06:49:14.951Z","comments":true,"path":"711179553.html","link":"","permalink":"https://htchz.cc/711179553.html","excerpt":"","text":"æ‹¿äººå®¶hexoæ¥å»ºç«™ï¼Œå‚è€ƒhexoå»ºç«™å†™çš„ï¼ŒåŠ ä¸Šä¸€äº›è‡ªå·±çš„ä¸œè¥¿ ç³»ç»Ÿï¼šcentos6ï¼Œæ˜¯vultrçš„ä¸€ä¸ªvpsï¼Œ1000gæµé‡100må¸¦å®½å¯ä»¥è·‘æ»¡ï¼Œæœ€ä½æ¯ä¸ªæœˆ5ç¾åˆ€ï¼Œç‚¹å‡»å°±é€å± é¾™å®åˆ€å˜¿å˜¿vultr.comä½¿ç”¨å·¥å…·ï¼šnginxç”¨æ¥åšåå‘ä»£ç†å’Œhttpsé‡å®šå‘ã€certbotæ¥åšå…è´¹è¯ä¹¦ç”³è¯·ã€GitHub pages åŒæ­¥åšå®¢ã€hexoåšé™æ€èµ„æºã€hey hexoåšåšå®¢ç®¡ç† 1. GitHub Pageshexoå¯ä»¥å°†æ–‡ä»¶åŒæ­¥åˆ°GitHub pageä¸Šï¼Œå¯ä»¥åŒæ­¥åï¼Œè¾“å…¥[ä½ çš„å¸æˆ·å].github.io æ¥è®¿é—® æ²¡æœ‰GitHubè´¦å·å—ï¼Œç°åœ¨ä½ æœ‰äº† å‘½åæ ¼å¼æ˜¯:[ä½ çš„å¸æˆ·å].github.ioï¼Œä¸ç„¶ä¸è¡Œå“¦ 2. Hexoæœ€å¥½ç…§ç€å®˜ç½‘æ¥ï¼Œå› ä¸ºè¿™ä¸ªä¸œè¥¿æ›´æ–°æœ‰ç‚¹å¿«,é“¾æ¥å·²ç»è¯´æ˜ä¸€åˆ‡è£…node curl --silent --location https://rpm.nodesource.com/setup_9.x | sudo bash - yum -y install nodejsè£…git yum -y install gitå®‰è£…å®Œåï¼Œæ­£å¸¸æƒ…å†µä¸‹çš„hexoå‘½ä»¤ä¼šåŠ å…¥/usr/binä¸­ï¼Œ ä¸æ­£å¸¸æƒ…å†µä¸‹â€¦æˆ‘çš„çš„å‘½ä»¤åœ¨/etc/node/lib/node_modules/hexo/binä¸‹ä¸”æ²¡åŠ å…¥ç¯å¢ƒå˜é‡ï¼Œæ‰¾äº†åŠå¤©ï¼Œç¬¬äºŒæ¬¡å®‰è£…å°±æ­£å¸¸äº†ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡æ²¡æœ‰npmæ²¡åŠ -gå‚æ•°ã€‚ è¿™æ—¶å»ºä¸ªç«™ç‚¹ï¼Œæ‰§è¡Œhexo init your_blog_nameï¼Œè¿™é‡Œå‡è®¾ä½ è¦å»ºç«‹ä¸€ä¸ªå«å«fooçš„åšå®¢ï¼Œæ‰§è¡Œhexo init foo | cd foo | npm install, lså¯ä»¥çœ‹åˆ°fooç›®å½•ã€‚ è¿™é‡Œfooè·¯å¾„æ˜¯ç›¸å¯¹äºä½ æ‰§è¡Œå‘½ä»¤çš„è·¯å¾„ã€‚ è¿›å…¥fooç›®å½•ï¼Œvimæ‰“å¼€_config.ymlï¼Œå¹¶æ»šåŠ¨åˆ°æœ€ä¸‹é¢æ·»åŠ å¦‚ä¸‹é…ç½®ä¿¡æ¯ï¼ˆæ³¨æ„æœ€ä¸‹è¾¹æœ‰deployå’Œtypeå­—æ®µï¼Œè¦†ç›–è¿™ä¸¤ä¸ªå­—æ®µæˆ–è€…åˆ é™¤è¿™ä¸¤ä¸ªå­—æ®µç„¶åå¤åˆ¶ä¸‹é¢çš„å››ä¸ªå­—æ®µä¹Ÿè¡Œã€‚ï¼‰ï¼š deploy: type: git repo: git@github.com:hz8080/hz8080.github.io.git branch: master æˆ‘é…äº†sshéªŒè¯ï¼Œé¿å…å¯†ç ç™»é™† fooç›®å½•çš„ç»“æ„ â”œâ”€â”€ _config.yml â”œâ”€â”€ package.json â”œâ”€â”€ scaffolds â”œâ”€â”€ source | â”œâ”€â”€ _drafts | â””â”€â”€ _posts â””â”€â”€ themesthemesæ˜¯æˆ‘ä»¬å¾…ä¼šä¸»é¢˜æ”¾çš„åœ°æ–¹ æ¥ç€åœ¨fooç›®å½•æ‰§è¡Œhexo s -p 5000çœ‹åˆ°è¾“å‡ºï¼Œè¾“å…¥ip:5000å°±å¯ä»¥çœ‹åˆ°ä½ çš„åšå®¢äº†ã€‚ sæ˜¯serverçš„æ„æ€ï¼Œ-pæ˜¯ç«¯å£ï¼Œé»˜è®¤4000ã€‚ä¸è¦æŠŠså†™æˆ-sï¼Œ-så¯ä»¥åŠ ï¼Œä½†æ˜¯s æ˜¯å¯åŠ¨å¿…é¡»çš„ã€‚ 3. å‘å¸ƒ hexo cleanhexo ghexo d hexo cleanæ˜¯æ¸…æ¥šç¼“å­˜hexo gæ˜¯ç”Ÿæˆæœ¬åœ°å‘å¸ƒæ–‡ä»¶å¤¹hexo dæ˜¯å‘å¸ƒåˆ°deployåˆ° _config.ymlè®¾ç½®çš„ç›®æ ‡åœ°å€ å¯ä»¥æŠŠä¸‰æ¡å†™è¿›bashè„šæœ¬~ #!/bin/bash hexo clean hexo g hexo d hexo d é‡åˆ°not found é—®é¢˜, è¾“å…¥npm install hexo-deployer-git --saveï¼Œå†æ‰§è¡Œhexo d 4. ä¸»é¢˜hexoæœ‰å¾ˆå¤šä¸»é¢˜ï¼Œæ¯”å¦‚æˆ‘ç”¨çš„æ˜¯next 5. ç»™èœå•å¢åŠ æ ‡ç­¾ã€ç±»ç›®åœ¨ç«™ç‚¹å†…ï¼Œæ‰§è¡Œhexo new page tagsï¼Œè¿™æ—¶åœ¨sources/tagsæœ‰index.mdï¼Œvimç¼–è¾‘ä¹‹ï¼Œ --- title: tags date: 2016-11-11 21:40:58 type: &quot;tags&quot; ---åœ¨ç«™ç‚¹çš„_config.ymlæŠŠæ ‡ç­¾æ‰“å¼€ menu: home: / #categories: /categories #about: /about archives: /archives tags: /tags //ç¡®ä¿æ ‡ç­¾é¡µå·²æ‰“å¼€ #schedule: /schedule #commonweal: /404.html åˆ†ç±»åŒç†ï¼Œåœ¨ç«™ç‚¹å†…ï¼Œæ‰§è¡Œhexo new page categoriesï¼Œè¿™æ—¶åœ¨sources/categoriesæœ‰index.mdï¼Œvimç¼–è¾‘ä¹‹ï¼Œç„¶ååœ¨_config.ymlæŠŠ# å»æ‰ æœ€åï¼åœ¨ä¸»é¢˜æ–‡ä»¶é‡Œï¼ˆthemes/next/ï¼‰çš„_config.ymlçš„tagså’Œcategoriesè®°å¾—æŠŠæ³¨é‡Šå»æ‰ï¼Œèœå•æ æ‰ä¼šæ˜¾ç¤ºæ ‡ç­¾å’Œåˆ†ç±» 123456789menu: home: / || home #about: /about/ || user tags: /tags/ || tags categories: /categories/ || th archives: /archives/ || archive #schedule: /schedule/ || calendar #sitemap: /sitemap.xml || sitemap #commonweal: /404/ || heartbeat é‡æ–°éƒ¨ç½²ï¼Œå³å¯ç”Ÿæ•ˆã€‚ å…¶ä»–æ¢å›¾æ ‡ã€å¤´åƒä»€ä¹ˆçš„å¯ä»¥ææ hexo ä¿®æ”¹äº†ç«™ç‚¹åå­—ã€ä»‹ç»ä»€ä¹ˆçš„ï¼Œå¥½åƒé‡å¯æ‰ç”Ÿæ•ˆï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯bug 6. è®¾ç½®â€˜é˜…è¯»å…¨æ–‡â€™hexoé»˜è®¤æ˜¾ç¤ºå…¨éƒ¨ï¼Œè®¾ç½®é˜…è¯»å…¨æ–‡æœ‰ä¸¤ç§æ–¹æ³•ï¼Œ ç¬¬ä¸€ç§ï¼Œåœ¨ä¸»é¢˜çš„_config.ymlçš„auto_excerpt.enableæ”¹ä¸ºtrueï¼Œlengthæ˜¯é¢„è§ˆé•¿åº¦ ç¬¬äºŒç§ï¼Œåœ¨æ–‡ç« åŠ å…¥&lt;!--more--&gt;ï¼Œé¦–é¡µå°±ä¼šé¢„è§ˆåˆ°&lt;!--more--&gt;çš„ä½ç½® ç¬¬ä¸€ç§ä¼šæœ‰...ï¼Œä¸”é¢„è§ˆé•¿åº¦æ˜¯ä¸€æ ·çš„ 7. åŸŸåæˆ‘ä»godaddy ä¹°äº†ä¸€ä¸ª.meåç¼€çš„ï¼Œå¹´è´¹æŒºä¾¿å®œçš„ï¼Œä¸è¿‡ç»­è´¹å°±ä¸ä¾¿å®œäº†ï¼Œå¯ä»¥è¯•ç”¨ä¸€æ³¢ã€‚å…·ä½“ç»‘å®šæ–¹æ³•è‡ªæ‰¾ã€‚ ä¹°å®Œååœ¨dnsç®¡ç†æŠŠAç±»åæŒ‡å‘è‡ªå·±çš„æœåŠ¡å™¨ipï¼Œé…ç½®å®Œæ¯•æµè§ˆå™¨æ‰“å¼€ä½ çš„åŸŸå:hexoç«¯å£è¯•è¯• 8. åšå®¢æ–‡ç« ç®¡ç† hexo-heyï¼Œä¸æ¨èï¼Œå·²ç»åœæ­¢æ›´æ–°ï¼Œæœ‰è«åå…¶å¦™çš„bug hexo-admin ï¼Œç”¨æ³•ç®€å•ç²—æš´ï¼Œè¿˜èƒ½è‡ªåŠ¨ä¿å­˜ï¼Œç”¨çš„è¿™ä¸ª 9. nginxå®‰è£…å®‰è£…ä¸èµ˜è¿°ï¼Œç›´æ¥ä»é…ç½®åŠ¨æ‰‹åœ¨/etc/nginx/conf.d/default.confæ˜¯ä¸€ä¸ªé…ç½®æ¨¡æ¿ï¼Œåœ¨/etc/nginx/conf.d/ä¸‹çš„*.conféƒ½ä¼šè¢«nginxè¯»å–ã€‚æˆ‘åªæœ‰ä¸€ä¸ªåº”ç”¨ï¼Œç›´æ¥åœ¨default.confåŠ¨æ‰‹ 123456789101112131415161718192021222324252627282930313233upstream hexo_host&#123; server localhost:4000;&#125;## The default serveserver &#123; server_name htchz.me; # root /usr/share/nginx/html; # Load configuration files for the default server block. # include /etc/nginx/default.d/*.conf; location /admin &#123; proxy_set_header Host $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://hexo_host; &#125; // éåå°ç®¡ç†ç›´æ¥èµ°é™æ€æ–‡ä»¶ location / &#123; root /root/htc/public/; expires 30m; &#125; error_page 404 /404.html; location = /40x.html &#123; &#125; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; &#125; æ‰§è¡Œnginx -s reloadï¼Œ é‡å¯nginxï¼Œè¾“å…¥åŸŸåï¼ˆhttpé»˜è®¤80ç«¯å£ï¼‰ï¼ŒéªŒè¯nginxè½¬å‘ç«¯å£æ˜¯å¦ç”Ÿæ•ˆ å¦‚æœè¯·æ±‚èµ„æºæŠ¥403æƒé™ä¸è¶³ï¼Œå¯èƒ½æ˜¯/etc/nginx/nginx.confçš„useræƒé™ä¸è¶³ï¼Œæ”¹æˆrootå°±å¯ä»¥ 10. certbotç”³è¯·è¯ä¹¦ ä¸ºä»€ä¹ˆè¦åšå®¢å‡çº§httpsï¼Œå…¶å®åªæ˜¯ä¸ºäº†è£…é€¼ã€‚chromeæ‰“å¼€çš„æ—¶å€™åœ°å€æ ä¸€ä¸ªç»¿è‰²çš„å®‰å…¨|https çœ‹ç€æŒºèˆ’æœçš„ ç»ˆç«¯è¾“å…¥ wget https://dl.eff.org/certbot-auto chmod a+x certbot-auto ./certbot-auto --nginxæœŸé—´è¦è¾“å…¥ä½ çš„é‚®ç®±ï¼Œé€‰æ‹©ç”³è¯·è¯ä¹¦çš„åŸŸåï¼Œé€‰æ‹©æ˜¯å¦åŸç«¯å£é‡å®šå‘åˆ°httpsï¼ˆ443ï¼‰ï¼Œé€‰æ˜¯ ç„¶åcertbotä¼šè‡ªåŠ¨ç”³è¯·è¯ä¹¦ã€ä¿®æ”¹ä½ çš„nginxé…ç½®ã€‚ ä¸‹è¾¹æ˜¯80è½¬443çš„é…ç½®ã€‚ 123456789server &#123; if ($host = htchz.me) &#123; return 301 https://$host$request_uri; &#125; # managed by Certbot listen 80; server_name htchz.me; return 404; # managed by Certbot&#125; ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™ 12345server &#123; listen 80; server_name htchz.me; return 301 https://$server_name$request_uri;&#125; è®°å¾—å¼€é€šä½ çš„80ã€443ç«¯å£ã€‚ã€‚ã€‚ 11. è‡ªåŠ¨ç»­æœŸcertbotç”³è¯·çš„è¯ä¹¦åªæœ‰ä¸‰ä¸ªæœˆï¼Œè¿™é‡Œå†™ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå‘½ä»¤è¡Œï¼š crontab -eå†™å…¥ 0 0 * * 0 /root/www/certbot-auto renewè¿™æ¡å‘½ä»¤çš„æ„æ€æ˜¯æ¯å‘¨æ—¥çš„0ç‚¹0åˆ†æ‰§è¡Œ/root/www/certbot-auto renewè¿™æ¡å‘½ä»¤ã€‚æ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤æŸ¥çœ‹å®šæ—¶ä»»åŠ¡åˆ—è¡¨ä¸­æ˜¯å¦æœ‰åˆšæ‰æ·»åŠ çš„ä»»åŠ¡ [root@California_VPS etc]# crontab -l 0 0 * * 0 /root/www/certbot-auto renew12. åæ¥å‘ç°çš„é—®é¢˜åˆ°è¿™é‡Œæ•´ä¸ªåšå®¢å·®ä¸å¤šäº†ã€‚ ä½†è¿˜æ˜¯æœ‰é—®é¢˜ã€‚æ²¡åŠ å›¾ç‰‡çš„æ—¶å€™ï¼Œchromeè¿˜æ˜¯ä¸€æŠŠå°ç»¿é”ï¼ŒçŸ¥é“åŠ äº†å›¾ç‰‡ä¹‹åï¼Œå°ç»¿é”å°±æ²¡äº†ã€‚æ‰“å¼€chromeæ§åˆ¶å°ï¼Œçœ‹åˆ°ç±»ä¼¼ä¸‹é¢warningï¼Œ Mixed Content: The page at &apos;https://domain.com/w/a?id=074ac65d-70db-422d-a6d6-a534b0f410a4&apos; was loaded over HTTPS, but requested an insecure image &apos;http://img.domain.com/images/2016/5/3/2016/058c5085-21b0-4b1d-bb64-23a119905c84_cf0d97ab-bbdf-4e25-bc5b-868bdfb581df.jpg&apos;. This content should also be served over HTTPS.åŸæ¥æ˜¯httpsç«™ç‚¹ä¸‹ï¼Œå›¾ç‰‡ä¾æ—§æ˜¯httpè®¿é—®ã€‚ 12.1. è§£å†³æ–¹æ³•è¿™ä¸ªç®€å•ï¼Œåœ¨æœåŠ¡å™¨è¿”å›å“åº”æ—¶åŠ å“åº”å¤´ï¼Œnginxé…ç½®å¦‚ä¸‹ server { ... add_header Content-Security-Policy upgrade-insecure-requests; ... }è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯åœ¨htmlåŠ å…¥meta &lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;upgrade-insecure-requests&quot; /&gt;åœ¨hexoè¿™ä¸ªè¦å»æ”¹æ¨¡æ¿å¤ªéº»çƒ¦ ç„¶åé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œé¡ºåˆ©è§£å†³~ 13. ä¼˜åŒ– ä¼˜åŒ–urlè¿‡é•¿ æ ‡é¢˜è‡ªåŠ¨ç¼–å·","categories":[{"name":"å»ºç«™","slug":"å»ºç«™","permalink":"https://htchz.cc/categories/å»ºç«™/"}],"tags":[{"name":"Hexo","slug":"Hexo","permalink":"https://htchz.cc/tags/Hexo/"},{"name":"Https","slug":"Https","permalink":"https://htchz.cc/tags/Https/"}]}]}