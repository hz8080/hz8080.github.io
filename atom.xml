<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>åœŸå·çš„è‡ªç•™åœ°</title>
  
  <subtitle>via fennecs.huang@gmail.com</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://htchz.cc/"/>
  <updated>2020-05-29T09:51:50.329Z</updated>
  <id>https://htchz.cc/</id>
  
  <author>
    <name>åœŸå·</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>[Mysql]æ¼«æ¸¸bin log</title>
    <link href="https://htchz.cc/2414692924.html"/>
    <id>https://htchz.cc/2414692924.html</id>
    <published>2020-05-26T01:51:00.000Z</published>
    <updated>2020-05-29T09:51:50.329Z</updated>
    
    <content type="html"><![CDATA[<p>binlogæ˜¯serverå±‚çš„æ—¥å¿—ï¼Œå¯¹äºinnodbæ¥è¯´ï¼Œåªæœ‰binlogå†™å®Œåï¼Œæ‰èƒ½æäº¤redo logã€‚binlogè®°å½•é€»è¾‘è¯­å¥ï¼Œåªä¼šè®°å½•å†™ç±»ä¼¼äºsqlçš„æ—¥å¿—ã€‚binlogä¸»è¦çš„ä½œç”¨</p><ol><li>å´©æºƒæ¢å¤</li><li>ä¸»ä»å¤åˆ¶</li></ol><h1 id="ç»„ç»‡ç»“æ„">1. ç»„ç»‡ç»“æ„</h1><h2 id="æ–‡ä»¶">1.1. æ–‡ä»¶</h2><p>binlogçš„ç›¸å…³é…ç½®å¯ä»¥æ‰§è¡Œ<code>show variables like &#39;%bin%&#39;;</code>æŸ¥çœ‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like '%bin%';</span><br><span class="line">+<span class="comment">--------------------------------------------+---------------------------------+</span></span><br><span class="line">| Variable_name                              | Value                           |</span><br><span class="line">+<span class="comment">--------------------------------------------+---------------------------------+</span></span><br><span class="line">| bind_address                               | *                               |</span><br><span class="line">| binlog_cache_size                          | 32768                           |</span><br><span class="line">| binlog_checksum                            | CRC32                           |</span><br><span class="line">| binlog_direct_non_transactional_updates    | OFF                             |</span><br><span class="line">| binlog_error_action                        | ABORT_SERVER                    |</span><br><span class="line">| binlog_format                              | ROW                             |</span><br><span class="line">| binlog_group_commit_sync_delay             | 0                               |</span><br><span class="line">| binlog_group_commit_sync_no_delay_count    | 0                               |</span><br><span class="line">| binlog_gtid_simple_recovery                | ON                              |</span><br><span class="line">| binlog_max_flush_queue_time                | 0                               |</span><br><span class="line">| binlog_order_commits                       | ON                              |</span><br><span class="line">| binlog_row_image                           | FULL                            |</span><br><span class="line">| binlog_rows_query_log_events               | OFF                             |</span><br><span class="line">| binlog_stmt_cache_size                     | 32768                           |</span><br><span class="line">| binlog_transaction_dependency_history_size | 25000                           |</span><br><span class="line">| binlog_transaction_dependency_tracking     | COMMIT_ORDER                    |</span><br><span class="line">| innodb_api_enable_binlog                   | OFF                             |</span><br><span class="line">| innodb_locks_unsafe_for_binlog             | OFF                             |</span><br><span class="line">| log_bin                                    | ON                              |</span><br><span class="line">| log_bin_basename                           | /data/mysql3306/mysql-bin       |</span><br><span class="line">| log_bin_index                              | /data/mysql3306/mysql-bin.index |</span><br><span class="line">| log_bin_trust_function_creators            | ON                              |</span><br><span class="line">| log_bin_use_v1_row_events                  | OFF                             |</span><br><span class="line">| log_statements_unsafe_for_binlog           | ON                              |</span><br><span class="line">| max_binlog_cache_size                      | 18446744073709547520            |</span><br><span class="line">| max_binlog_size                            | 536870912                       |</span><br><span class="line">| max_binlog_stmt_cache_size                 | 18446744073709547520            |</span><br><span class="line">| sql_log_bin                                | ON                              |</span><br><span class="line">| sync_binlog                                | 1                               |</span><br><span class="line">+<span class="comment">--------------------------------------------+---------------------------------+</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>show master status;</code>å¯ä»¥çœ‹åˆ°å½“å‰å†™å…¥çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„åå­—å’Œä½ç½®ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+<span class="comment">------------------+-----------+--------------+------------------+-------------------+</span></span><br><span class="line">| File             | Position  | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+<span class="comment">------------------+-----------+--------------+------------------+-------------------+</span></span><br><span class="line">| mysql-bin.000930 | 178613715 |              | mysql,test       |                   |</span><br><span class="line">+<span class="comment">------------------+-----------+--------------+------------------+-------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.10</span> sec)</span><br></pre></td></tr></table></figure><p>binlogä¸»è¦æœ‰ä¸¤ç§æ–‡ä»¶ï¼š</p><ul><li>äºŒè¿›åˆ¶æ—¥å¿—ç´¢å¼•æ–‡ä»¶ï¼ˆæ–‡ä»¶ååç¼€ä¸º.indexï¼‰ç”¨äºè®°å½•æ‰€æœ‰æœ‰æ•ˆçš„çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li><li>äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼ˆæ–‡ä»¶ååç¼€ä¸º.****ï¼‰è®°å½•æ•°æ®åº“æ‰€æœ‰çš„DDLå’ŒDMLè¯­å¥äº‹ä»¶</li></ul><p>å¦‚ä¸Šè¾“å‡ºï¼ŒäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶å­˜æ”¾çš„<code>basename</code>æ˜¯â€/data/mysql3306/mysql-bin.****â€ï¼ŒäºŒè¿›åˆ¶æ—¥å¿—ç´¢å¼•æ–‡ä»¶è·¯å¾„æ˜¯â€/data/mysql3306/mysql-bin.indexâ€,</p><p>å…·ä½“å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@dev_test63 mysql3306]# ls -l mysql-bin*</span><br><span class="line">-rw-r----- 1 mysql mysql 538582976 5æœˆ  22 01:17 mysql-bin.000919</span><br><span class="line">-rw-r----- 1 mysql mysql 536879010 5æœˆ  22 12:03 mysql-bin.000920</span><br><span class="line">-rw-r----- 1 mysql mysql 536885288 5æœˆ  22 20:03 mysql-bin.000921</span><br><span class="line">-rw-r----- 1 mysql mysql 536871917 5æœˆ  23 05:05 mysql-bin.000922</span><br><span class="line">-rw-r----- 1 mysql mysql 536871391 5æœˆ  23 21:40 mysql-bin.000923</span><br><span class="line">-rw-r----- 1 mysql mysql 536895385 5æœˆ  24 07:03 mysql-bin.000924</span><br><span class="line">-rw-r----- 1 mysql mysql 536945072 5æœˆ  25 00:03 mysql-bin.000925</span><br><span class="line">-rw-r----- 1 mysql mysql 536904757 5æœˆ  25 09:03 mysql-bin.000926</span><br><span class="line">-rw-r----- 1 mysql mysql 536871742 5æœˆ  25 19:28 mysql-bin.000927</span><br><span class="line">-rw-r----- 1 mysql mysql 536870960 5æœˆ  26 04:34 mysql-bin.000928</span><br><span class="line">-rw-r----- 1 mysql mysql 536871255 5æœˆ  26 19:33 mysql-bin.000929</span><br><span class="line">-rw-r----- 1 mysql mysql 153202413 5æœˆ  27 00:22 mysql-bin.000930</span><br><span class="line">-rw-r----- 1 mysql mysql       228 5æœˆ  26 19:33 mysql-bin.index</span><br></pre></td></tr></table></figure><p><code>sync_binlog</code>æ˜¯ç”¨æ¥è¡¨ç¤ºåŒæ­¥åˆ·binlogï¼Œå¦‚æœæ•°æ®åº“ç¹å¿™å¯èƒ½ä¼šé€ æˆç£ç›˜ioå‹åŠ›å¤§</p><p><code>sql_log_bin</code>è¡¨ç¤ºå¼€å¯binlogï¼Œå¼€å…³éƒ½éœ€è¦é‡å¯mysql</p><p><strong>mysql-bin.index</strong>è¿™ä¸ªæ–‡ä»¶å¾ˆç®€å•ï¼Œåªæ˜¯è®°å½•äº†å½“å‰çš„binlogåˆ—è¡¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@dev_test63 mysql3306]# cat mysql-bin.index</span><br><span class="line">./mysql-bin.000919</span><br><span class="line">./mysql-bin.000920</span><br><span class="line">./mysql-bin.000921</span><br><span class="line">./mysql-bin.000922</span><br><span class="line">./mysql-bin.000923</span><br><span class="line">./mysql-bin.000924</span><br><span class="line">./mysql-bin.000925</span><br><span class="line">./mysql-bin.000926</span><br><span class="line">./mysql-bin.000927</span><br><span class="line">./mysql-bin.000928</span><br><span class="line">./mysql-bin.000929</span><br><span class="line">./mysql-bin.000930</span><br></pre></td></tr></table></figure><p>è€Œbinlogæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶é›†åˆï¼Œæ¯ä¸ªbinlogæ–‡ä»¶ä»¥ä¸€ä¸ª4å­—èŠ‚çš„é­”æ•°<code>0xfe62696e</code>å¼€å¤´ï¼ˆå3å­—èŠ‚å…¶å®å°±æ˜¯â€binâ€ï¼‰</p><p>æ¥ç€æ˜¯ä¸€ç»„Eventsï¼ŒEventç”±headerç»„æˆï¼Œheaderè®°å½•äº†åˆ›å»ºæ—¶é—´ã€æœåŠ¡å™¨æ ‡è¯†ç­‰ï¼Œdataæ˜¯æ•°æ®ã€‚ä¸€ä¸ªbinlogæ–‡ä»¶é‡Œï¼Œç¬¬ä¸€ä¸ªeventæè¿°binlogçš„æ ¼å¼ï¼Œæœ€åä¸€ä¸ªbinlogæè¿°ä¸‹ä¸€ä¸ªbinlogæ–‡ä»¶çš„ä¿¡æ¯ã€‚</p><h2 id="rotation">1.2. rotation</h2><p>å½“ä¸‹é¢ä¸‰ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œbinlogä¼šrotateæ–°æ–‡ä»¶ï¼š</p><ul><li>å®ä¾‹åœæ­¢æˆ–é‡å¯æ—¶</li><li>flush logs å‘½ä»¤ï¼›</li><li>å½“å‰binlog &gt; <code>max_binlog_size</code>(åƒä¸Šé¢çš„é…ç½®æ˜¯512M)</li></ul><blockquote><p>å¦‚æœæœ‰ä¸€ä¸ªå¤§äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œå¾ˆå¯èƒ½ä¼šå‘ç”Ÿä¸€ä¸ªbinlogæ–‡ä»¶ç¨å¤§äº<code>max_binlog_size</code></p></blockquote><h1 id="æ¨¡å¼">2. æ¨¡å¼</h1><p>binlogæœ‰ä¸‰ç§è®°å½•æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯<strong>statement</strong>ï¼Œ<strong>row</strong>ï¼Œ<strong>mixed</strong>ï¼Œé€šè¿‡<code>binlog_format</code>æ¥æŒ‡å®šï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æŒ‡å®šã€‚</p><!--TODO mysql binlogè®¾ç½®--><h2 id="statement">2.1. statement</h2><p><strong>statement</strong>è®°å½•çš„æ˜¯åŸè¯­å¥ï¼Œä½ æ‰§è¡Œä»€ä¹ˆè¯­å¥å°±ä¼šè®°å½•ä»€ä¹ˆè¯­å¥ã€‚è¿™åœ¨ä¸»ä»å¤åˆ¶çš„æ—¶å€™å°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼š</p><p>è¿™é‡Œæä¸€ä¸ªé—®é¢˜ï¼š<strong>ä¸ºä»€ä¹ˆå¤§å¤šæ•°æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯RCï¼Œè€Œinnodbæ˜¯RRå‘¢</strong>ï¼š</p><p>è¿™æ˜¯ä¸€ä¸ªå†å²é—ç•™é—®é¢˜ï¼Œç½‘ä¸Šä¹Ÿå¯ä»¥æ‰¾åˆ°å¾ˆå¤šè§£é‡Šï¼Œå¤§ä½“å°±æ˜¯ï¼šåœ¨mysql5.1.5ä¹‹å‰åªæœ‰<strong>statement</strong>æ¨¡å¼ï¼Œå¦‚æœäº‹åŠ¡ç”¨RCéš”ç¦»çº§åˆ«ï¼Œå°±ä¼šå¯èƒ½å‡ºç°ä¸»ä»ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><!--TODO éªŒè¯--><p>ç°åœ¨å·²ç»ä¸èƒ½åœ¨<strong>statement</strong>æ¨¡å¼ä¸‹æ‰§è¡ŒRCäº‹åŠ¡äº†ï¼Œä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š</p><blockquote><p>Cannot execute statement: impossible to write to binary log since BINLOG_FORMAT = STATEMENT and at least one table uses a storage engine limited to row-based logging. InnoDB is limited to row-logging when transaction isolation level is READ COMMITTED or READ UNCOMMITTED.</p></blockquote><p>å‡è®¾RCå…è®¸ï¼Œé‚£ä¹ˆå‡è®¾studentè¡¨æœ‰scoreå­—æ®µï¼Œ</p><table><thead><tr><th>äº‹åŠ¡A</th><th>äº‹åŠ¡B</th></tr></thead><tbody><tr><td>begin;</td><td>begin;</td></tr><tr><td>delete from student where score &lt; 6;</td><td>/</td></tr><tr><td>/</td><td>insert into student(score) values(1);</td></tr><tr><td>/</td><td>commit;</td></tr><tr><td>commit;</td><td>/</td></tr></tbody></table><p>åœ¨RRçº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Bçš„è¯­å¥ä¼šé˜»å¡ï¼Œå› ä¸ºäº‹åŠ¡Aä¼šç»™æ»¡è¶³æ¡ä»¶çš„åˆ—åŠ ä¸ŠXé”ï¼Œç»™é—´éš™åŠ ä¸Šgapé”ï¼Œæ‰€ä»¥äº‹åŠ¡Bæ˜¯ä¼šè¢«é˜»å¡çš„ã€‚<br>åœ¨RCçº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Bçš„è¯­å¥æ˜¯ä¸ä¼šé˜»å¡çš„ï¼Œå› æ­¤å…ˆäºäº‹åŠ¡Aæäº¤ï¼Œæäº¤å®Œæˆå†™å…¥binlogï¼Œæ¥ç€Aæäº¤å†™å…¥binlogï¼Œ</p><p>æ‰€ä»¥åœ¨binlogé‡Œæ˜¯è¿™æ ·çš„ï¼ˆåªæ˜¯ä¸¾ä¸ªğŸŒ°ï¼‰ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student(age) <span class="keyword">values</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> student <span class="keyword">where</span> age &lt; <span class="number">6</span>;</span><br></pre></td></tr></table></figure><p>è¿™æ ·binlogè¢«ä»åº“æ¶ˆè´¹ä¹‹åå°±ä¸»ä»å°±ä¸ä¸€è‡´ã€‚</p><h2 id="row">2.2. row</h2><p><strong>row</strong>æ˜¯è®°å½•åˆ°æ¯ä¸€è¡Œçš„é€»è¾‘è¯­å¥ï¼Œæ¯”å¦‚æ‰§è¡Œ<code>update student set name = &#39;åœŸå·&#39; where age &lt; 10</code>çš„sqlï¼Œå°±ä¼šç”Ÿæˆnæ¡è®°å½•ã€‚</p><p>è¿™æ ·å¯ä»¥é¿å…<strong>statement</strong>äº§ç”Ÿçš„é—®é¢˜ï¼Œ<strong>ç¼ºç‚¹</strong>å°±æ˜¯æ—¥å¿—é‡å¤ªå¤§ï¼Œå¯èƒ½ä¼šäº§ç”Ÿioå‹åŠ›ã€‚</p><h2 id="mixed">2.3. mixed</h2><p><strong>mixed</strong>æ¨¡å¼æ˜¯ç”±mysqlè‡ªè¡Œåˆ¤æ–­ä½¿ç”¨å“ªç§æ¨¡å¼ã€‚è½¬æ¢æ¡ä»¶<a href="https://dev.mysql.com/doc/refman/5.7/en/binary-log-mixed.html" target="_blank" rel="noopener">ä¼ é€é—¨</a></p><blockquote><p>æ–°ç‰ˆæœ¬çš„MySQLå¯¹row levelæ¨¡å¼ä¹Ÿè¢«åšäº†ä¼˜åŒ–ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¿®æ”¹éƒ½ä¼šä»¥row levelæ¥è®°å½•ï¼Œåƒé‡åˆ°è¡¨ç»“æ„å˜æ›´çš„æ—¶å€™å°±ä¼šä»¥statementæ¨¡å¼æ¥è®°å½•ï¼Œå¦‚æœsqlè¯­å¥ç¡®å®å°±æ˜¯updateæˆ–è€…deleteç­‰ä¿®æ”¹æ•°æ®çš„è¯­å¥ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šè®°å½•æ‰€æœ‰è¡Œçš„å˜æ›´ï¼›å› æ­¤ï¼Œç°åœ¨ä¸€èˆ¬ä½¿ç”¨row levelå³å¯ã€‚</p></blockquote><h1 id="binlogå†…å®¹">3. binlogå†…å®¹</h1><h2 id="mysqlbinlog">3.1. mysqlbinlog</h2><p>mysqlbinlogæ˜¯mysqlæä¾›çš„ä¸€ä¸ªæŸ¥çœ‹binlogçš„å·¥å…·ï¼Œé€šè¿‡è¯¥å·¥å…·å¯ä»¥å°†äºŒè¿›åˆ¶æ–‡ä»¶è§£æä¸ºæ–‡æœ¬ä¾›æˆ‘ä»¬è¿›è¡Œé˜…è¯»ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„binlogï¼Œå¯ä»¥æŒ‡å®šæ—¶é—´æˆ–åç§»é‡ä½œä¸ºstartã€stopæ¥ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ã€‚å¦‚æœæŒ‡å®šçš„åç§»é‡ä¸æ˜¯ä¸€ä¸ªeventçš„èµ·å§‹åç§»é‡ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚</p><p>å½“å‰msyqlæ˜¯rowæ¨¡å¼ï¼Œæ‰§è¡Œ<code>mysqlbinlog -v --start-datetime=&quot;2020-05-25 09:59:59&quot; --stop-datetime=&quot;2020-05-25 10:00:00&quot; mysql-bin.000927 --base64-output=decode-rows</code>ï¼Œ<code>--base64-output=decode-rows</code>ä¸ºäº†è§£ç <code>row</code>æ ¼å¼ï¼Œ<code>-v</code>è¯¦ç»†è¾“å‡ºè¯­å¥ã€‚æˆªå–ä¸€éƒ¨åˆ†å¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># at 26237733</span></span><br><span class="line"><span class="comment">#200525  9:59:59 server id 3306  end_log_pos 26237798 CRC32 0xbcd552f0 GTID [commit=no]</span></span><br><span class="line"><span class="keyword">SET</span> @@SESSION.GTID_NEXT= <span class="string">'ANONYMOUS'</span><span class="comment">/*!*/</span>;</span><br><span class="line"><span class="comment"># at 26237798</span></span><br><span class="line"><span class="comment">#200525  9:59:59 server id 3306  end_log_pos 26237883 CRC32 0x5558cbbe Querythread_id=43976966exec_time=0error_code=0</span></span><br><span class="line"><span class="keyword">SET</span> <span class="built_in">TIMESTAMP</span>=<span class="number">1590371999</span><span class="comment">/*!*/</span>;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">/*!*/</span>;</span><br><span class="line"><span class="comment"># at 26237883</span></span><br><span class="line"><span class="comment">#200525  9:59:59 server id 3306  end_log_pos 26237968 CRC32 0x8f9f400f Table_map: `superq_db`.`superq_trigger_registry` mapped to number 96550</span></span><br><span class="line"><span class="comment"># at 26237968</span></span><br><span class="line"><span class="comment">#200525  9:59:59 server id 3306  end_log_pos 26238162 CRC32 0x560afdaa Update_rows: table id 96550 flags: STMT_END_F</span></span><br><span class="line"><span class="comment">### UPDATE `superq_db`.`superq_trigger_registry`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=15093</span></span><br><span class="line"><span class="comment">###   @2='EXECUTOR'</span></span><br><span class="line"><span class="comment">###   @3='job-executor-saber'</span></span><br><span class="line"><span class="comment">###   @4='172.88.2.128:19012'</span></span><br><span class="line"><span class="comment">###   @5='172.88.2.128:10099'</span></span><br><span class="line"><span class="comment">###   @6=1590371989</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=15093</span></span><br><span class="line"><span class="comment">###   @2='EXECUTOR'</span></span><br><span class="line"><span class="comment">###   @3='job-executor-saber'</span></span><br><span class="line"><span class="comment">###   @4='172.88.2.128:19012'</span></span><br><span class="line"><span class="comment">###   @5='172.88.2.128:10099'</span></span><br><span class="line"><span class="comment">###   @6=1590371999</span></span><br><span class="line"><span class="comment"># at 26238162</span></span><br><span class="line"><span class="comment">#200525  9:59:59 server id 3306  end_log_pos 26238193 CRC32 0x1e662746 Xid = 3290666026</span></span><br><span class="line"><span class="keyword">COMMIT</span><span class="comment">/*!*/</span>;</span><br></pre></td></tr></table></figure><ul><li><code># at xxxx</code>ï¼šä¸€ä¸ªeventçš„å¼€å¤´ï¼Œ</li><li><code>#200525  9:59:59</code>ï¼šæ—¶é—´ï¼Œ20å¹´5æœˆ25æ—¥ï¼Œ9æ—¶59åˆ†59ç§’</li><li><code>server id 3306</code>ï¼šserverç¼–å·</li><li><code>end_log_pos 26237798</code>ï¼šä¸‹ä¸€ä¸ªäº‹ä»¶å¼€å§‹çš„ä½ç½®ï¼ˆå³å½“å‰äº‹ä»¶çš„ç»“æŸä½ç½®+1ï¼‰</li><li><code>CRC32 0xbcd552f0</code>ï¼šCRC32æ˜¯æ ¡éªŒå’Œçš„ç®—æ³•ï¼Œåœ¨ä¸Šé¢é…ç½®æ¸…å•é‡Œ<code>binlog_checksum</code>å¯ä»¥çœ‹åˆ°ï¼Œåé¢è·Ÿç€çš„æ˜¯32ä½æ ¡éªŒå’Œã€‚</li><li><code>Query</code>ï¼ševent typeï¼Œå…·ä½“å¯ä»¥ç¿»é˜…<a href="https://dev.mysql.com/doc/internals/en/event-classes-and-types.html" target="_blank" rel="noopener">Event Classes and Types</a></li><li><code>thread_id=43976966</code>ï¼šçº¿ç¨‹id</li><li><code>exec_time=0</code>ï¼šæ‰§è¡Œæ—¶é—´</li><li><code>error_code=0</code>ï¼šé”™è¯¯ç ï¼Œ0è¡¨ç¤ºæ— é”™è¯¯</li><li><code>Xid = 3290666026</code>ï¼šè¡¨ç¤ºredo logå’ŒbinlogåšXAçš„Xid</li></ul><h3 id="ç»“æ„ä½“">3.1.1. ç»“æ„ä½“</h3><p>å‰é¢è¯´åˆ°ï¼Œeventåˆ†ä¸ºheaderå’Œdataï¼Œäº‹å®ä¸Šï¼Œbinlog äº‹ä»¶çš„ç»“æ„ä¸»è¦æœ‰3ä¸ªç‰ˆæœ¬ï¼š</p><ul><li>v1: Used in MySQL 3.23</li><li>v3: Used in MySQL 4.0.2 though 4.1</li><li>v4: Used in MySQL 5.0 and up</li></ul><p>ç°åœ¨åŸºæœ¬ç”¨çš„æ˜¯v4ç‰ˆæœ¬ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+=====================================+</span><br><span class="line">| event  | timestamp         0 : 4    |</span><br><span class="line">| header +<span class="comment">----------------------------+</span></span><br><span class="line">|        | type_code         4 : 1    |</span><br><span class="line">|        +<span class="comment">----------------------------+</span></span><br><span class="line">|        | server_id         5 : 4    |</span><br><span class="line">|        +<span class="comment">----------------------------+</span></span><br><span class="line">|        | event_length      9 : 4    |</span><br><span class="line">|        +<span class="comment">----------------------------+</span></span><br><span class="line">|        | next_position    13 : 4    |</span><br><span class="line">|        +<span class="comment">----------------------------+</span></span><br><span class="line">|        | flags            17 : 2    |</span><br><span class="line">|        +<span class="comment">----------------------------+</span></span><br><span class="line">|        | extra_headers    19 : x-19 |</span><br><span class="line">+=====================================+</span><br><span class="line">| event  | fixed part        x : y    |</span><br><span class="line">| data   +<span class="comment">----------------------------+</span></span><br><span class="line">|        | variable part              |</span><br><span class="line">+=====================================+</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ç”¨<code>offset : length</code>æè¿°äº†å„ä¸ªå±æ€§çš„ä½ç½®ï¼Œå¦‚æœäº‹ä»¶å¤´çš„é•¿åº¦æ˜¯ x å­—èŠ‚ï¼Œé‚£ä¹ˆäº‹ä»¶ä½“çš„é•¿åº¦ä¸º (event_length - x) å­—èŠ‚ï¼›è®¾äº‹ä»¶ä½“ä¸­ fixed part çš„é•¿åº¦ä¸º y å­—èŠ‚ï¼Œé‚£ä¹ˆ variable part çš„é•¿åº¦ä¸º (event_length - (x + y)) å­—èŠ‚</p><h3 id="binlog-checksum">3.1.2. binlog-checksum</h3><p>æ ¡éªŒå’ŒåŠŸèƒ½æ˜¯ä¸ºäº†é˜²æ­¢ä¼ è¾“è¿‡ç¨‹ä¸­å‘ç”Ÿå·®é”™ï¼Œä¸»ä»ä¸ä¸€è‡´ã€‚</p><p>å…³äºbinlog-checksumæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯</p><ul><li><code>binlog_checksum</code>ï¼šé»˜è®¤å€¼æ˜¯CRC32ï¼Œå¯ä»¥è®¾ç½®ä¸º<code>NONE</code></li><li><code>master_verify_checksum</code>ï¼šä¸»åº“æ ¡éªŒeventæ ¡éªŒå’Œï¼Œé»˜è®¤ä¸º0ï¼Œåœ¨master threadè¿›è¡Œdumpçš„æ—¶å€™æ ¡éªŒï¼Œåœ¨<code>SHOW BINLOG EVENTS</code>æ ¡éªŒ</li><li><code>slave_sql_verify_checksum</code>ï¼šä»åº“æ ¡éªŒeventæ ¡éªŒå’Œï¼Œé»˜è®¤ä¸º1ï¼Œå½“IO threadæŠŠeventå†™å…¥åˆ°relay logï¼ˆä»åº“è¯»å–åˆ°çš„binlogç”Ÿæˆrelay logï¼‰çš„æ—¶å€™æ ¡éªŒã€‚</li></ul><p>mysqlbinlogå¯ä»¥åŠ ä¸Š<code>--verify-binlog-checksum</code>å‚æ•°ï¼Œæ‰“å°æœ‰é—®é¢˜çš„sqlã€‚</p><p>å¦‚æœæ ¡éªŒå¤±è´¥ä¼šæŠ¥é”™ï¼Œå¯ä»¥ç”¨<code>pt-table-checksum</code>å·¥å…·è¿›è¡Œä¿®æ­£ï¼Œå…³äºæ›´å¤šï¼Œå¦è¡Œäº†è§£ã€‚</p><h2 id="SHOW-BINLOG-EVENTS">3.2. SHOW BINLOG EVENTS</h2><p>è¿™ä¸ªæ˜¯mysqlå‘½ä»¤ï¼Œä¹Ÿæ˜¯ç”¨æ¥é˜…è¯»binlogã€‚ä½¿ç”¨æ–¹å¼æ˜¯<code>SHOW BINLOG EVENTS [IN &#39;log_name&#39;] [FROM pos] [LIMIT [offset,] row_count]</code>ï¼Œä¸­æ‹¬å·éƒ½æ˜¯å¯é€‰é¡¹ã€‚</p><h2 id="GTID">3.3. GTID</h2><p>å¯ä»¥åœ¨æ—¥å¿—é‡Œçœ‹åˆ°<code>GTID</code>çš„å­—çœ¼ï¼ŒGTIDå³Global Transaction IDï¼Œå…¨å±€äº‹åŠ¡idï¼Œç”±<code>server_uuid:transaction_id</code>ç»„æˆï¼Œæ˜¯åœ¨mysql5.6å¼•è¿›çš„ä¸€ä¸ªç‰¹æ€§ã€‚</p><p>ç»„å¤åˆ¶æ’ä»¶<strong>MGR</strong>mysqlå®˜æ–¹çš„ä¸€ä¸ªé«˜å¯ç”¨æ’ä»¶ï¼Œä½¿ç”¨äº†PAXOSåè®®ã€‚åœ¨è¿™ç§ä¸€è‡´æ€§åè®®ä¸­éœ€è¦æœ‰ä¸€ä¸ªå…¨å±€å¢é•¿çš„command indexï¼ŒGTIDå°±æ‰¿æ‹…äº†è¿™ä¸ªè§’è‰²ã€‚</p><p>æ‰§è¡Œ<code>show variables like &#39;%gtid%&#39;;</code>ï¼Œè¾“å‡º</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">----------------------------------+-----------+</span></span><br><span class="line">| Variable_name                    | Value     |</span><br><span class="line">+<span class="comment">----------------------------------+-----------+</span></span><br><span class="line">| binlog_gtid_simple_recovery      | ON        |</span><br><span class="line">| enforce_gtid_consistency         | OFF       |</span><br><span class="line">| gtid_executed_compression_period | 1000      |</span><br><span class="line">| gtid_mode                        | OFF       |</span><br><span class="line">| gtid_next                        | AUTOMATIC |</span><br><span class="line">| gtid_owned                       |           |</span><br><span class="line">| gtid_purged                      |           |</span><br><span class="line">| session_track_gtids              | OFF       |</span><br><span class="line">+<span class="comment">----------------------------------+-----------+</span></span><br><span class="line">8 rows in <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure><p><code>gtid_mode</code>å…¶å®æ˜¯<code>OFF</code>çŠ¶æ€ã€‚</p><p>å…³äºæ›´å¤šï¼Œå¦è¡Œäº†è§£ã€‚</p><h1 id="ä¸»ä»å¤åˆ¶">4. ä¸»ä»å¤åˆ¶</h1><p>ä¸»ä»å¤åˆ¶æœ‰åŸºäºbinlogå’ŒåŸºäºGTIDä¸¤ç§æ–¹å¼ã€‚åŸºäºbinlogçš„å¤åˆ¶æ¨¡å¼çš„åŸºæœ¬æµç¨‹æ˜¯ï¼š</p><ol><li>masteräº‹åŠ¡æäº¤ï¼Œå°†è®°å½•å˜æ›´å†™å…¥binlog</li><li>slaveçš„ioè¿›ç¨‹è¿æ¥masterï¼Œä»æŒ‡å®šä½ç½®æˆ–ä»0å¼€å§‹è¯·æ±‚æ—¥å¿—</li><li>masterè¿”å›æ—¥å¿—ç»™slaveï¼Œå¹¶å¸¦ä¸Šbinlogåç§°å’Œä¸‹ä¸€ä¸ªbinlogæ¶ˆè´¹ä½ç½®</li><li>slaveæ¥æ”¶åˆ°æ—¥å¿—ï¼Œå°†æ—¥å¿—è¿½åŠ åˆ°relay logæœ«ç«¯ï¼Œå¹¶è®°å½•binlogåç§°å’Œbinlogæ¶ˆè´¹ä½ç½®ï¼Œä¸‹æ¬¡è¯·æ±‚ä½¿å¸¦ä¸Šã€‚</li><li>slaveçš„sqlè¿›ç¨‹ä¸æ–­è¯»relay logï¼Œæ‰§è¡Œsqlã€‚</li><li>å¦‚æœslaveå¼€å¯äº†binlogï¼Œåˆä¼šå°†æ‰§è¡Œçš„sqlå˜æ›´è®°å…¥binlogï¼›å¦‚æœslaveåˆæ˜¯å…¶ä»–slaveçš„masterï¼Œå°±ä¼šæ‰§è¡Œä¸€æ ·çš„é€»è¾‘ã€‚</li></ol><p>åœ¨slaveä¸Šæ‰§è¡Œï¼Œ<code>show slave status\G</code>ï¼Œéƒ¨åˆ†è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 11.198.116.79</span><br><span class="line">                  Master_User: replicator</span><br><span class="line">                  Master_Port: 3018</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000831</span><br><span class="line">          Read_Master_Log_Pos: 1151797</span><br><span class="line">               Relay_Log_File: slave-relay.002490</span><br><span class="line">                Relay_Log_Pos: 313</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000831</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 1151797</span><br><span class="line">              Relay_Log_Space: 769</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>Read_Master_Log_Pos</code>å’Œ<code>Exec_Master_Log_Pos</code>ä¸€è‡´ï¼Œè¡¨ç¤ºä»åº“å·²ç»è¿½èµ¶ä¸Šä¸»åº“ã€‚</p><p>åœ¨ä¸»åº“æ‰§è¡Œ<code>show master status\G</code>ï¼Œå¯ä»¥çœ‹åˆ°ä¸»åº“å½“å‰æ­£åœ¨å†™å…¥çš„binlogå’Œä½ç½®ã€‚</p><h1 id="å‚è€ƒ">5. å‚è€ƒ</h1><ol><li><a href="https://dev.mysql.com/doc/internals/en/event-structure.html" target="_blank" rel="noopener">Event Structure</a></li><li><a href="https://dominicpoi.com/2019/06/16/MySQL-1/" target="_blank" rel="noopener">MySQLä¸ºä»€ä¹ˆé»˜è®¤éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»ï¼Ÿ</a></li><li><a href="https://zhuanlan.zhihu.com/p/33504555" target="_blank" rel="noopener">10åˆ†é’Ÿå­¦ä¼šMysqlä¹‹Binlog</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;binlogæ˜¯serverå±‚çš„æ—¥å¿—ï¼Œå¯¹äºinnodbæ¥è¯´ï¼Œåªæœ‰binlogå†™å®Œåï¼Œæ‰èƒ½æäº¤redo logã€‚binlogè®°å½•é€»è¾‘è¯­å¥ï¼Œåªä¼šè®°å½•å†™ç±»ä¼¼äºsqlçš„æ—¥å¿—ã€‚binlogä¸»è¦çš„ä½œç”¨&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å´©æºƒæ¢å¤&lt;/li&gt;
&lt;li&gt;ä¸»ä»å¤åˆ¶&lt;/li&gt;
&lt;/ol&gt;

      
    
    </summary>
    
      <category term="Mysql" scheme="https://htchz.cc/categories/Mysql/"/>
    
    
  </entry>
  
  <entry>
    <title>[Mysql]æ¼«æ¸¸redo log</title>
    <link href="https://htchz.cc/1559835943.html"/>
    <id>https://htchz.cc/1559835943.html</id>
    <published>2020-05-19T14:00:05.000Z</published>
    <updated>2020-05-30T11:43:33.883Z</updated>
    
    <content type="html"><![CDATA[<p>redo logè´Ÿè´£è®°å½•ç‰©ç†æ•°æ®é¡µï¼Œæ‰€ä»¥æ— è®ºæ‰§è¡Œå¤šå°‘æ¬¡éƒ½æ˜¯å¹‚ç­‰çš„ï¼›è€Œbinlogæ˜¯è®°å½•é€»è¾‘æ•°æ®ï¼Œæ‰§è¡Œå¤šæ¬¡å°±å¯èƒ½é‡å¤æ•°æ®ã€‚</p><p>æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ª<strong>ç¯å½¢æ•°ç»„</strong>ï¼Œinnodbå°†æœªå†™å…¥ç£ç›˜çš„é¡µå«åš<strong>è„é¡µ</strong>ï¼Œredo logçš„ä½œç”¨å°±æ˜¯è®°å½•è„é¡µçš„æ•°æ®ã€‚</p><p>åœ¨å®•æœºæ¢å¤æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡æ˜¯å¦æŒä¹…åŒ–æ˜¯æ ¹æ®redo logåˆ·ç›˜æƒ…å†µå†³å®šçš„ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡çš„redo logå·²ç»å…¨éƒ¨åˆ·å…¥ç£ç›˜ï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹åŠ¡æ˜¯æœ‰æ•ˆçš„ï¼Œåä¹‹éœ€è¦æ ¹æ®undo logå›æ»šã€‚</p><p>redo logåœ¨ç¡¬ç›˜ä¸­æ˜¯åˆ†æˆå¤šå—æ¥å­˜å‚¨çš„ï¼Œä»¥<code>ib_logfile[number]</code>å‘½åã€‚</p><p>æ‰§è¡Œ<code>SHOW GLOBAL VARIABLES LIKE &quot;innodb_log%&quot;;</code>ï¼Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----------------------------+-----------+</span></span><br><span class="line">| Variable_name               | Value     |</span><br><span class="line">+<span class="comment">-----------------------------+-----------+</span></span><br><span class="line">| innodb_log_buffer_size      | 67108864  |</span><br><span class="line">| innodb_log_checksums        | ON        |</span><br><span class="line">| innodb_log_compressed_pages | ON        |</span><br><span class="line">| innodb_log_file_size        | 536870912 |</span><br><span class="line">| innodb_log_files_in_group   | 4         |</span><br><span class="line">| innodb_log_group_home_dir   | ./        |</span><br><span class="line">| innodb_log_write_ahead_size | 8192      |</span><br><span class="line">+<span class="comment">-----------------------------+-----------+</span></span><br></pre></td></tr></table></figure><p><code>innodb_log_files_in_group</code>æŒ‡å®šäº†redo logæ–‡ä»¶è¢«åˆ†ä¸ºå‡ éƒ¨åˆ†ï¼Œæ¯ä¸€éƒ¨åˆ†çš„æ–‡ä»¶å¤§å°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå½“å†™å…¥ib_logfile3åï¼Œåˆç»§ç»­å†™å…¥ib_logfile0ï¼Œå¦‚æ­¤å¾ªç¯ã€‚</p><p>è¿™æ˜¯åœ¨ç£ç›˜é‡Œçš„æ–‡ä»¶ï¼Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@dev_test63 mysql3306]#  ll ib*</span><br><span class="line">-rw-r----- 1 mysql mysql 683671552 5æœˆ  20 01:25 ibdata1</span><br><span class="line">-rw-r----- 1 mysql mysql 536870912 5æœˆ  20 01:24 ib_logfile0</span><br><span class="line">-rw-r----- 1 mysql mysql 536870912 5æœˆ  19 11:10 ib_logfile1</span><br><span class="line">-rw-r----- 1 mysql mysql 536870912 5æœˆ  20 01:24 ib_logfile2</span><br><span class="line">-rw-r----- 1 mysql mysql 536870912 5æœˆ  20 01:25 ib_logfile3</span><br><span class="line">-rw-r----- 1 mysql mysql  79691776 5æœˆ  20 01:01 ibtmp1</span><br></pre></td></tr></table></figure><ul><li>ibtmp1æ˜¯ä¸´æ—¶è¡¨ç©ºé—´ï¼Œibdata1æ˜¯å…±äº«è¡¨ç©ºé—´ã€‚</li></ul><h1 id="ä¸ºä»€ä¹ˆè¦æœ‰redo-log">1. ä¸ºä»€ä¹ˆè¦æœ‰redo log:</h1><ul><li>redo logæ˜¯é¡ºåºå†™å…¥çš„ï¼Œè€Œæ•°æ®é¡µè½ç›˜æ˜¯éšæœºå­˜å‚¨ã€‚</li><li>å»¶è¿Ÿåˆ·è„é¡µå¯ä»¥èµ·åˆ°åˆå¹¶å¤šæ¬¡ä¿®æ”¹çš„ä½œç”¨ï¼Œmysqlçš„æœ€å°å­˜å‚¨å•ä½æ˜¯é¡µï¼Œä¸€ä¸ªé¡µæœ‰å¤šè¡Œï¼Œå¦‚æœæ¯æ¬¡ä¿®æ”¹ä¸€è¡Œå°±è¦æ›´æ–°æ•´ä¸ªé¡µï¼Œå¹¶ä¸æ˜¯é‚£ä¹ˆèƒ½æ¥æ”¶ã€‚</li></ul><p>æœ‰äº†redo logä¹‹åï¼Œå¯¹äºä¸€è¡Œæ•°æ®ï¼Œé¦–å…ˆæ›´æ–°<strong>buffer pool</strong>ï¼ˆåœ¨è¿™ä¹‹å‰è¿˜æœ‰undo logï¼‰ï¼Œç„¶åå†å†™å…¥log bufferã€‚</p><h1 id="ç»„ç»‡ç»“æ„">2. ç»„ç»‡ç»“æ„</h1><p>ç”±äºredoè®°å½•çš„æ˜¯ç‰©ç†å˜æ›´ï¼Œæ¯”å¦‚åœ¨â€œç¬¬100è¡¨ç©ºé—´ç¬¬100é¡µåç§»é‡1024å†™å…¥4ä¸ªå­—èŠ‚balabalaâ€ï¼Œè€Œä¸æ˜¯æè¿°ç¬¬å‡ è¡Œæ”¹æˆä»€ä¹ˆæ ·ï¼Œä¸€è¡Œè®°å½•å˜æ›´æ¶‰åŠçš„ç‰©ç†é¡µå¯èƒ½æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥å¯èƒ½äº§ç”Ÿä¸€æ¡redo logï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å¤šæ¡redo logï¼Œè¿™ä¸ªå’Œundo logä¸åŒã€‚ </p><h2 id="redo-log">2.1. redo log</h2><p>è¿™æ˜¯ä¸€æ¡redo logçš„é€šç”¨ç»“æ„<br><img src="../images/20200525182526.png" alt></p><ul><li>typeï¼šredo logçš„ç±»å‹ï¼Œå¯èƒ½æ˜¯åŸºç¡€ç±»å‹ï¼Œä¹Ÿå¯èƒ½æ˜¯å¤æ‚ç±»å‹</li><li>Space IDï¼šè¡¨ç©ºé—´id</li><li>page numberï¼šé¡µå·</li><li>dataï¼šredo logå†…å®¹</li></ul><p>å…·ä½“typeçš„ç±»å‹æœ‰å¾ˆå¤šï¼Œå‚è€ƒåº•éƒ¨é“¾æ¥ï¼Œå…¶ä¸­åŒ…æ‹¬undo logå¯¹åº”çš„redo log<code>MLOG_UNDO_INSERT</code>ã€‚ä¸€ä¸ªæ“ä½œäº§ç”Ÿçš„redo logå¯èƒ½æ˜¯ä¸€ä¸ªï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ç»„redo logã€‚</p><h2 id="log-block">2.2. log block</h2><p>ç»„ç»‡redo logçš„æ˜¯log blockï¼Œä¸€ä¸ªlog blockæ˜¯å­˜å‚¨redo logçš„åŸºæœ¬å•ä½ï¼Œå’Œé¡µæœ‰ç‚¹ç±»ä¼¼ã€‚<br><img src="../images/20200526000820.png" alt></p><ul><li>log block headerï¼šå­˜æ”¾blockä¿¡æ¯</li><li>log block bodyï¼šå­˜æ”¾å¤šæ¡redo log</li><li>log block trailerï¼šå­˜æ”¾blockçš„æ ¡éªŒå€¼ï¼Œç”¨äºæ­£ç¡®æ€§æ ¡éªŒ</li></ul><p>log bufferå’Œlog fileéƒ½æ˜¯ä»¥log blockä¸ºåŸºæœ¬æ“ä½œå•ä½ï¼Œredo logåœ¨log blocké‡Œé¡ºåºå†™å…¥ã€‚<br><img src="../images/20200526001104.png" alt></p><h2 id="mtr">2.3. mtr</h2><p>Mini-Transactionï¼Œå³mtrï¼Œ</p><p>å‰é¢è¯´åˆ°ä¸€ä¸ªæ“ä½œå¯èƒ½äº§ç”Ÿä¸€ç»„redo logï¼Œé‚£ä¹ˆè¿™ç»„redo logæ˜¯éœ€è¦ä¿è¯äº‹åŠ¡æ€§çš„ï¼Œinnodbä½¿ç”¨mtrè¿™ç§æ¯”transactionæ›´å°ç²’åº¦çš„äº‹åŠ¡ï¼Œæ¥ä¿è¯ä¸€ç»„redoçš„äº‹åŠ¡æ€§ã€‚</p><p>mtrå¼€å¯åï¼Œä¼šå®šä½åˆ°è¦ä¿®æ”¹çš„pageçš„ä½ç½®ï¼Œå¯¹ç´¢å¼•åŠ é”ï¼›ä¹‹åæ‰§è¡Œä¸€ç³»åˆ—å†™æ“ä½œï¼ŒæœŸé—´äº§ç”Ÿçš„redo logä¼šæš‚å­˜åœ¨mtrå¯¹è±¡ä¸­ï¼›mtræäº¤æ—¶ï¼Œéœ€è¦æŠŠæš‚å­˜çš„redo logç»„æ”¾å…¥log bufferä¸­ï¼Œç„¶åæŠŠä¿®æ”¹çš„è„é¡µæ”¾å…¥flush listï¼Œä¹‹åé‡Šæ”¾pageçš„é”ã€‚</p><h1 id="åˆ·ç›˜ç­–ç•¥">3. åˆ·ç›˜ç­–ç•¥</h1><p>è¿™é‡Œæœ‰å‡ ä¸ªæ¦‚å¿µ</p><ul><li>buffer poolï¼šæŒ‡åœ¨å†…å­˜ä¸­çš„æ•°æ®é¡µï¼Œinnodbéœ€è¦æŠŠç‰©æµæ•°æ®é¡µè¯»åˆ°å†…å­˜ä¸­è¿›è¡Œä¿®æ”¹ã€‚</li><li>log bufferï¼šæŒ‡redo logçš„bufferï¼Œå±äºè¿›ç¨‹ã€‚</li><li>redo log fileï¼šæŒ‡å†…å­˜ä¸­çš„redo logæ–‡ä»¶ï¼Œå±äºæ“ä½œç³»ç»Ÿï¼Œå¾…fsyncåˆ°ç£ç›˜ä¸­ã€‚</li></ul><p>redo logåˆ·ç›˜æ—¶æœºå¦‚ä¸‹ï¼š</p><ul><li>æœ‰äº‹åŠ¡æäº¤æ—¶ï¼Œæ ¹æ®<a href="#äº‹åŠ¡æäº¤æ—¶çš„åˆ·ç›˜ç­–ç•¥">äº‹åŠ¡æäº¤æ—¶çš„åˆ·ç›˜ç­–ç•¥</a>å†³å®šæ˜¯å¦åˆ·ç›˜</li><li><code>innodb_flush_log_at_timeout</code>é»˜è®¤å€¼ä¸º1ï¼Œä¹Ÿå°±æ˜¯1så†…å¦‚æœæ²¡å‘ç”Ÿåˆ·ç›˜ï¼Œéœ€è¦è¿›è¡Œåˆ·ç›˜</li><li>å½“log bufferä¸­å·²ç»ä½¿ç”¨çš„å†…å­˜è¶…è¿‡ä¸€åŠæ—¶</li><li>å½“åˆ°è¾¾checkpointæ—¶</li></ul><h2 id="äº‹åŠ¡æäº¤æ—¶çš„åˆ·ç›˜ç­–ç•¥">3.1. äº‹åŠ¡æäº¤æ—¶çš„åˆ·ç›˜ç­–ç•¥</h2><p><code>innodb_flush_log_at_trx_commit</code>æŒ‡å®šäº†redo logçš„äº‹åŠ¡æäº¤åˆ·ç›˜ç­–ç•¥ï¼Œåˆ†åˆ«ä¸‰ä¸ªå€¼<br>0ï¼šæ¯æ¬¡æäº¤äº‹åŠ¡ï¼Œä¸ä¼šå°†log bufferå†™å…¥redo log fileï¼Œè€Œæ˜¯ç”±master threadæ¯ç§’å°†log bufferå†™å…¥redo log fileï¼Œå¹¶è°ƒç”¨fsyncè½ç›˜<br>1ï¼šæ¯æ¬¡æäº¤äº‹åŠ¡ï¼Œå°†log bufferå†™å…¥redo log fileï¼Œ<strong>åŒæ—¶</strong>è°ƒç”¨fsyncè½ç›˜ï¼Œæ˜¯<strong>æœ€ä¸¥æ ¼</strong>ä¹Ÿæ˜¯æ€§èƒ½<strong>æœ€å·®</strong>çš„ç­–ç•¥<br>2: æ¯æ¬¡æäº¤äº‹åŠ¡ï¼Œå°†log bufferå†™å…¥redo log fileï¼Œ<strong>æ¯ç§’</strong>è°ƒç”¨fsyncè½ç›˜</p><p>0å’Œ2çœ‹èµ·æ¥æœ‰ç‚¹ç›¸ä¼¼ã€‚åŒºåˆ«åœ¨äºï¼Œå‰è€…æ²¡æœ‰å°†log bufferåŒæ­¥å†™å…¥redo log fileï¼Œè¦çŸ¥é“redo log fileæ˜¯æ–‡ä»¶ï¼Œæ‰€ä»¥0æ²¡åŒæ­¥å†™å…¥æ–‡ä»¶ï¼Œæ€§èƒ½ä¼šæ¯”2é«˜ï¼Œä½†mysqlå´©æºƒæ—¶ï¼Œä¼šä¸¢å¤±æ—¥å¿—ï¼›è€Œ2åŒæ­¥å†™å…¥æ–‡ä»¶ï¼Œå·²ç»å°†æ—¥å¿—æäº¤åˆ°æ“ä½œç³»ç»Ÿäº†ï¼Œåªæœ‰æ“ä½œç³»ç»Ÿå®•æœºäº†æ‰ä¼šä¸¢å¤±æ—¥å¿—ã€‚</p><p>æˆ‘ä»¬çº¿ä¸Šæ•°æ®åº“<code>innodb_flush_log_at_trx_commit</code>çš„å€¼æ˜¯1ï¼Œæœ‰ä¸€æ¬¡åŒäº‹æ¸…ç†æ•°æ®æ—¶åšäº†ä¸ªå…¨è¡¨æ›´æ–°ï¼Œredo logç–¯ç‹‚åˆ·ç›˜ï¼Œä»è€Œå¯¼è‡´æ•°æ®åº“ç¼“æ…¢ï¼Œäºæ˜¯è¿ç»´å…³é—­äº†åŒ1ï¼ˆ<code>innodb_flush_log_at_trx_commit</code>å’Œ<code>sync_binlog</code>ï¼‰ï¼Œæš‚åœäº†æ¸…ç†è„šæœ¬ï¼Œæ‰å¾—ä»¥æ¢å¤ã€‚</p><h1 id="LSN">4. LSN</h1><p>Log sequence numberæ˜¯ä¸€ä¸ª8å­—èŠ‚çš„ä¸æ–­å¢é•¿çš„æ•°å­—ï¼Œè¡¨ç¤ºæ—¥å¿—ç¼–å·ï¼Œèµ·åˆ°ä¸€ä¸ªç±»ä¼¼ç‰ˆæœ¬çš„ä½œç”¨ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½æœ‰è¿™ä¸ªLSNï¼Œæœ€ç»ˆéœ€è¦è¿™nä¸ªåœ°æ–¹çš„LSNè¾¾åˆ°ä¸€è‡´ã€‚</p><p>é€šè¿‡LSNå¯ä»¥è·å¾—ï¼š</p><ol><li>æ•°æ®é¡µçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚</li><li>å†™å…¥çš„æ—¥å¿—æ€»é‡ï¼Œé€šè¿‡LSNå¼€å§‹å·ç å’Œç»“æŸå·ç å¯ä»¥è®¡ç®—å‡ºå†™å…¥çš„æ—¥å¿—é‡ã€‚</li><li>å¯çŸ¥é“æ£€æŸ¥ç‚¹çš„ä½ç½®ã€‚</li></ol><p>æ‰§è¡Œ<code>SHOW ENGINE INNODB STATUS;</code>å¯ä»¥çœ‹åˆ°å’ŒLSNæœ‰å…³çš„ä¿¡æ¯ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---</span></span><br><span class="line">LOG</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">Log sequence number 1509428892</span><br><span class="line">Log flushed up to   1509428892</span><br><span class="line">Pages flushed up to 1509300590</span><br><span class="line">Last checkpoint at  1509300581</span><br><span class="line">0 pending log flushes, 0 pending chkp writes</span><br><span class="line">3554874 log i/o's done, 0.00 log i/o's/second</span><br></pre></td></tr></table></figure><p><strong>Log sequence number</strong>æ˜¯redo log bufferçš„LSN<br><strong>log flushed up to</strong>æ˜¯åˆ·åˆ°redo log fileåœ¨ç¡¬ç›˜ä¸­çš„LSNï¼›<br><strong>pages flushed up to</strong>æ˜¯å·²ç»åˆ·åˆ°ç£ç›˜æ•°æ®é¡µä¸Šçš„LSN<br><strong>last checkpoint at</strong>æ˜¯ä¸Šä¸€æ¬¡æ£€æŸ¥ç‚¹æ‰€åœ¨ä½ç½®çš„LSN</p><p>å¯ä»¥çœ‹åˆ°LSNä¸æ˜¯å®Œå…¨ä¸€è‡´ï¼Œæµ‹è¯•ç¯å¢ƒdbæ˜¯ç©ºé—²çš„ï¼Œ<strong>Log sequence number</strong>å’Œ<strong>log flushed up to</strong>æ˜¯ç›¸åŒçš„ï¼Œ<strong>pages flushed up to</strong>è½åï¼Œè¿™æ˜¯å› ä¸ºè„é¡µå¾ˆå°‘çš„è¯å¯ä»¥æš‚æ—¶ä¸åˆ·åˆ°ç£ç›˜ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œlog sequence number &gt; log flushed up to å’Œ pages flushed up to &gt; last checkpoint at</p><p>å¯èƒ½ä¼šå‡ºç°æ•°æ®é¡µåˆ·ç›˜å¿«äºredo logåˆ·ç›˜çš„æƒ…å†µï¼Œè¿™æ—¶checkpointæ˜¯æœ‰æœºåˆ¶ä¿æŠ¤æ•°æ®æ…¢äºæ—¥å¿—ï¼Œæ‰€ä»¥ä¼šæš‚åœæ•°æ®é¡µåˆ·ç›˜ï¼Œç­‰å¾…æ—¥å¿—åˆ·ç›˜è¿›åº¦è¶…è¿‡æ•°æ®åˆ·ç›˜ã€‚</p><p>ç”±äºè®°å½•ç‰©ç†æ•°æ®é¡µï¼Œå¦‚æœåœ¨ä¸€ä¸ªäº‹åŠ¡é‡ŒæŠŠaæ›´æ–°æˆbï¼ŒåˆæŠŠbæ›´æ–°ä¸ºaï¼Œä¼šä¸ä¼šä¿å­˜åˆ°redo logé‡Œçš„ï¼Ÿ</p><p>è¯•éªŒè¿‡åï¼Œæ‰§è¡Œ<code>SHOW ENGINE INNODB STATUS\G</code>ï¼Œå¯ä»¥çœ‹åˆ°<code>Log sequence number</code>æœ‰å¢åŠ ï¼›</p><h1 id="checkpoint">5. checkpoint</h1><p>ç”±äºredo logç›¸å½“äºç»™æ•°æ®é¡µåšäº†ä¸ªå¤‡ä»½ï¼Œæ‰€ä»¥äº‹åŠ¡æäº¤æ—¶å¹¶ä¸ä¸€å®šè¦æŠŠæ•°æ®é¡µè½ç›˜ã€‚ä½†æ˜¯ï¼š1ï¼šbuffer poolæ˜¯æœ‰é™çš„ï¼Œ2ï¼šredo log bufferæ˜¯æœ‰é™çš„ã€‚<br>æ‰€ä»¥éœ€è¦ä¸€ä¸ªæ—¶æœºï¼Œå°†buffer poolé‡Œçš„æ•°æ®è½ç›˜ï¼ŒåŒæ—¶æ¸…é™¤redo log bufferé‡Œå·²ç»è½ç›˜çš„æ•°æ®é¡µï¼Œè¿™ä¸ªæ—¶æœºå°±æ˜¯checkpointã€‚æ•°æ®åº“é‡å¯åçš„æ¢å¤ï¼Œåªéœ€è¦ä»checkpoint lsnç®—èµ·ï¼Œcheckpoint lsnä¹‹å‰çš„æ•°æ®éƒ½æ˜¯è®¤ä¸ºå·²ç»æŒä¹…åŒ–çš„ã€‚</p><p>checkpointçš„ç›®çš„å¾ˆç®€å•ï¼Œå³æŠŠæ•°æ®é¡µè½ç›˜ï¼Œä½†æ˜¯ä»€ä¹ˆæ—¶å€™ã€åˆ·å¤šå°‘é¡µåˆ°ç£ç›˜ã€ä»å“ªé‡Œå–è„é¡µéƒ½æœ‰äº›ä¸åŒã€‚</p><p><strong>checkpoint_lsn</strong>æ˜¯æŒ‡checkpointå‘ç”Ÿåˆ·ç›˜ä¹‹åï¼Œè®°å½•æ­¤æ¬¡checkpointçš„lsnåˆ°redo log fileçš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å¤´å¯ä»¥ç†è§£ä¸ºç®¡ç†æ•°æ®é¡µç¼“å†²çš„æ•°æ®ç»“æ„ï¼Œéœ€è¦ä¿è¯<br>FLUSHåˆ—è¡¨ï¼šLRUçš„<br>æœ‰ä¸¤ç§Checkpointï¼Œåˆ†åˆ«ä¸ºï¼šSharp Checkpointã€Fuzzy Checkpointã€‚</p><p><strong>Sharp Checkpoint</strong>æ˜¯å…¨éƒ¨åˆ·ç›˜ï¼Œå‘ç”Ÿåœ¨åˆ‡æ¢redo logæ–‡ä»¶æˆ–è€…æ•°æ®åº“å…³é—­çš„æ—¶å€™ï¼Œéœ€è¦æŠŠbuffer poolçš„æ•°æ®é¡µå…¨åˆ·ç›˜ã€‚</p><blockquote><p>MySQLåœæ­¢æ—¶æ˜¯å¦å°†è„æ•°æ®å’Œè„æ—¥å¿—åˆ·å…¥ç£ç›˜ï¼Œç”±å˜é‡<code>innodb_fast_shutdown={ 0|1|2 }</code>æ§åˆ¶ï¼Œé»˜è®¤å€¼ä¸º1ï¼Œå³åœæ­¢æ—¶å¿½ç•¥æ‰€æœ‰flushæ“ä½œï¼Œåœ¨ä¸‹æ¬¡å¯åŠ¨çš„æ—¶å€™å†flushï¼Œå®ç°fast shutdownã€‚</p></blockquote><p><strong>Fuzzy Checkpoint</strong>æ˜¯éƒ¨åˆ†åˆ·ç›˜ï¼Œåˆ†ä¸ºå››ç§ã€‚</p><h2 id="master-thread-checkpoint">5.1. master thread checkpoint</h2><p>ç”±masterçº¿ç¨‹æ§åˆ¶ï¼Œæ¯1ç§’ï¼Œæ¯10ç§’åˆ·å…¥ä¸€å®šæ¯”ä¾‹çš„è„é¡µåˆ°ç£ç›˜ï¼Œå¼‚æ­¥ã€‚</p><h2 id="flush-lru-list-checkpoint">5.2. flush_lru_list checkpoint</h2><p>ä»MySQL5.6å¼€å§‹å¯é€šè¿‡<code>innodb_page_cleaners</code>å˜é‡æŒ‡å®šä¸“é—¨è´Ÿè´£è„é¡µåˆ·ç›˜çš„<strong>page cleaner</strong>çº¿ç¨‹çš„ä¸ªæ•°ï¼Œè¯¥çº¿ç¨‹çš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯lru_listè¡¨æœ‰å¯ç”¨çš„ç©ºé—²é¡µã€‚</p><h2 id="async-sync-flush-checkpointï¼š">5.3. async/sync flush checkpointï¼š</h2><p>åŒæ­¥åˆ·ç›˜/å¼‚æ­¥åˆ·ç›˜ã€‚ä¾‹å¦‚è¿˜æœ‰éå¸¸å¤šçš„è„é¡µæ²¡åˆ·åˆ°ç£ç›˜(éå¸¸å¤šæ˜¯å¤šå°‘ï¼Œæœ‰æ¯”ä¾‹æ§åˆ¶)ï¼Œè¿™æ—¶å€™ä¼šé€‰æ‹©åŒæ­¥åˆ·åˆ°ç£ç›˜ï¼Œä½†è¿™å¾ˆå°‘å‡ºç°ï¼›å¦‚æœè„é¡µä¸æ˜¯å¾ˆå¤šï¼Œå¯ä»¥é€‰æ‹©å¼‚æ­¥åˆ·åˆ°ç£ç›˜ï¼Œå¦‚æœè„é¡µå¾ˆå°‘ï¼Œå¯ä»¥æš‚æ—¶ä¸åˆ·è„é¡µåˆ°ç£ç›˜ã€‚</p><p>è¿™é‡Œæœ‰å››ä¸ªé…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">innodb_log_files_in_group=4</span><br><span class="line">innodb_log_file_size=4G</span><br><span class="line">æ€»æ–‡ä»¶å¤§å°: 17179869184</span><br><span class="line"></span><br><span class="line">log_sys-&gt;max_modified_age_async = 12175607164 (71%)</span><br><span class="line">log_sys-&gt;max_modified_age_sync = 13045293390 (76%)</span><br><span class="line">log_sys-&gt;max_checkpoint_age_async = 13480136503 (78%)</span><br><span class="line">log_sys-&gt;max_checkpoint_age = 13914979615 (81%)</span><br></pre></td></tr></table></figure><p>è®¾ï¼Œcheckpoint_age = log_lsn - last_checkpoint_lsnï¼Œmax_modified_age = log_lsn - è„é¡µæœ€å°lsn</p><p>å½“max_modified_age &gt; max_modified_age_asyncsï¼Œéœ€è¦flush_listå–å‡ºè„é¡µï¼Œå¼‚æ­¥åˆ·ç›˜<br>å½“max_modified_age &gt; max_modified_age_syncï¼Œéœ€è¦flush_listå–å‡ºè„é¡µï¼ŒåŒæ­¥åˆ·ç›˜</p><p>å½“checkpoint_age &gt; max_checkpoint_age_asyncï¼Œå¯ä»¥æ— éœ€ç­‰å¾…checkpointå®Œæˆ<br>å½“checkpoint_age &gt; max_checkpoint_ageï¼Œéœ€è¦åŒæ­¥ç­‰å¾…checkpointå®Œæˆ</p><h2 id="dirty-page-too-much-checkpoint">5.4. dirty page too much checkpoint</h2><p>è„é¡µå¤ªå¤šæ—¶å¼ºåˆ¶è§¦å‘æ£€æŸ¥ç‚¹ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¿è¯ç¼“å­˜æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ã€‚è„é¡µæ¯”ä¾‹ç”±å˜é‡ innodb_max_dirty_pages_pct æ§åˆ¶ï¼ŒMySQL 5.6é»˜è®¤çš„å€¼ä¸º75ï¼Œå³å½“è„é¡µå ç¼“å†²æ± çš„75%åï¼Œå°±å¼ºåˆ¶åˆ·ä¸€éƒ¨åˆ†è„é¡µåˆ°ç£ç›˜ã€‚</p><p>å…³äºä¸Šé¢æåˆ°çš„åˆ—è¡¨ï¼š</p><p>lru_listï¼šæ˜¯ä¸€ä¸ªä½¿ç”¨äº†æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•çš„åˆ—è¡¨ï¼Œå¯ä»¥ç†è§£ä¸ºç®¡ç†æ•°æ®é¡µç¼“å†²çš„æ•°æ®ç»“æ„ã€‚<br>flush_listï¼šlruçš„çš„è„é¡µä¼šæ”¾è¿›è¿™ä¸ªåˆ—è¡¨ï¼Œä½†æ˜¯ä¸ä¼šä»lruç§»é™¤ï¼Œæ‰€ä»¥è„é¡µä¼šå­˜åœ¨ä¸¤ä¸ªåœ°æ–¹ã€‚flush_listé‡Œçš„è„é¡µä¼šæ ¹æ®lsnæœ€ä¸ºæ’åºä¾æ®ï¼Œä¿è¯lsnå°çš„å…ˆè½ç›˜ã€‚<br>free_listï¼šfree_listå¦‚æœæ²¡æœ‰ç©ºé—²é¡µå¯ä»¥åˆ†é…ï¼Œå°±ä¼šä»lru_listæ‰¹é‡æ·˜æ±°æ•°æ®é¡µä»¥ä¾›ä½¿ç”¨ã€‚</p><h1 id="redo-logå¤ªå¤§å’Œå¤ªå°">6. redo logå¤ªå¤§å’Œå¤ªå°</h1><p>å¯ä»¥çœ‹åˆ°ï¼Œ<strong>async/sync flush checkpoint</strong>è¿™ç§ç±»å‹çš„checkpointå…¶å®æ˜¯å’Œlog_fileçš„å¤§å°æœ‰å…³çš„ã€‚å¦‚æœlog_fileå°äº†ï¼Œä¼šä½¿checkpointå˜å¤šï¼Œå½±å“innodbæ€§èƒ½ï¼›å¦‚æœlog_fileå¤§äº†ï¼Œä¸¤æ¬¡checkpointè·¨åº¦å¤§ï¼Œåœ¨æ¢å¤çš„æ—¶å€™<strong>å¯èƒ½</strong>å°±ä¼šç­‰å¾…å¤ªä¹…ï¼ˆæŒ‚äº†è·‘è·¯å§ğŸ˜„ï¼‰ã€‚</p><p>å…·ä½“å¤šå¤§åº”è¯¥ç»“åˆå®é™…æµ‹è¯•ã€‚</p><h1 id="ä¸¤é˜¶æ®µæäº¤-å´©æºƒæ¢å¤">7. ä¸¤é˜¶æ®µæäº¤ å´©æºƒæ¢å¤</h1><p>å¦å¤–è®²ã€‚</p><h1 id="å‚è€ƒ">8. å‚è€ƒ</h1><ol><li><a href="https://juejin.im/entry/5ba0a254e51d450e735e4a1f" target="_blank" rel="noopener">è¯¦ç»†åˆ†æMySQLäº‹åŠ¡æ—¥å¿—(redo logå’Œundo log)</a></li><li><a href="https://www.cnblogs.com/gomysql/p/3721478.html" target="_blank" rel="noopener">InnoDB log file è®¾ç½®å¤šå¤§åˆé€‚ï¼Ÿ</a></li><li><a href="http://www.yunweipai.com/archives/15563.html" target="_blank" rel="noopener">ã€ŠMySQLè¿ç»´å†…å‚ã€‹èŠ‚é€‰ | InnoDBæ—¥å¿—ç®¡ç†æœºåˆ¶ï¼ˆäº”ï¼‰</a></li><li><a href="https://www.jianshu.com/p/fdae2e30b9fa" target="_blank" rel="noopener">Redo Logâ€”â€”ç¬¬ä¸€ç¯‡</a></li><li><a href="http://mysql.taobao.org/monthly/2015/05/01/" target="_blank" rel="noopener">MySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB redo logæ¼«æ¸¸</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;redo logè´Ÿè´£è®°å½•ç‰©ç†æ•°æ®é¡µï¼Œæ‰€ä»¥æ— è®ºæ‰§è¡Œå¤šå°‘æ¬¡éƒ½æ˜¯å¹‚ç­‰çš„ï¼›è€Œbinlogæ˜¯è®°å½•é€»è¾‘æ•°æ®ï¼Œæ‰§è¡Œå¤šæ¬¡å°±å¯èƒ½é‡å¤æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ª&lt;strong&gt;ç¯å½¢æ•°ç»„&lt;/strong&gt;ï¼Œinnodbå°†æœªå†™å…¥ç£ç›˜çš„é¡µå«åš&lt;strong&gt;è„é¡µ&lt;/strong&gt;ï¼Œredo
      
    
    </summary>
    
      <category term="Mysql" scheme="https://htchz.cc/categories/Mysql/"/>
    
    
  </entry>
  
  <entry>
    <title>[Mysql]æ¼«æ¸¸undo log</title>
    <link href="https://htchz.cc/1791523990.html"/>
    <id>https://htchz.cc/1791523990.html</id>
    <published>2020-05-10T01:51:00.000Z</published>
    <updated>2020-05-29T09:39:47.769Z</updated>
    
    <content type="html"><![CDATA[<p>Innodbå­¦ä¼šæ˜¯ä¸å¯èƒ½å­¦ä¼šçš„ï¼Œè¿™è¾ˆå­éƒ½å­¦ä¸ä¼šçš„ã€‚</p><a id="more"></a><p>innodbæ˜¯ä¸€ä¸ª<strong>æ—¥å¿—å…ˆè¡Œ</strong>ï¼ˆWrite-ahead loggingï¼‰çš„å­˜å‚¨å¼•æ“ï¼Œè¿™ä¹Ÿæ˜¯å¤§éƒ¨åˆ†å…³ç³»å‹æ•°æ®åº“çš„ç‰¹ç‚¹ã€‚è€Œåƒredisè¿™æ ·çš„nosqlå°±æ˜¯æ•°æ®ä¸ºå…ˆï¼Œå†è¿›è¡Œè½ç›˜ã€‚</p><p>undo logå’Œredo logå’Œbinlogï¼Œè¿™ä¸‰ä¸ªlogæ˜¯mysqlåŠinnodbçš„å…³é”®ã€‚è¿™ä¸‰ç§æ—¥å¿—éƒ½ä¼šåˆ·ç›˜ï¼Œå…¶ä¸­ï¼š</p><ul><li>undo log: äº‹åŠ¡åŸå­æ€§å’Œå¤šç‰ˆæœ¬æ§åˆ¶MVCCï¼ˆäº‹åŠ¡éš”ç¦»ï¼‰</li><li>redo log: äº‹åŠ¡æŒä¹…æ€§ï¼Œå®•æœºæ¢å¤</li><li>binlog: å®•æœºæ¢å¤ï¼Œä¸»ä»åŒæ­¥</li></ul><p>å¯ä»¥çœ‹å‡ºä¸‰ä¸ªæ—¥å¿—åœ¨å¯¹åº”åŠŸèƒ½ä¸Šéœ€è¦ç›¸äº’åä½œã€‚undo logå’Œredo logæ˜¯äº‹åŠ¡æ—¥å¿—ï¼›redo logè¦ç­‰binlogå†™å…¥æˆåŠŸæ‰èƒ½commitï¼›undo Logä¿è¯äº‹åŠ¡çš„åŸå­æ€§ï¼Œredo logä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚</p><p>ç½‘ä¸Šå¤§å¤šéƒ½æ˜¯è®²undo logèƒ½åšä»€ä¹ˆï¼Œä½†æ²¡å‡ ç¯‡è®²æ¸…æ¥šundo logç»„ç»‡ç»“æ„ã€‚innodbæœ€å°å­˜å‚¨ç²’åº¦æ˜¯é¡µ<code>page</code>ï¼Œè€Œé¡µå°±åˆ†ä¸º<code>FIL_PAGE_INDEX</code>ç´¢å¼•é¡µï¼ˆç´¢å¼•å³æ•°æ®ï¼‰å’Œ<code>FIL_PAGE_UNDO_LOG</code>undoé¡µã€‚</p><p>éƒ¨åˆ†æ¦‚å¿µæ˜¯å…³äºMVCCçš„ï¼Œéœ€è¦é…åˆ<a href="./3647734067.html#undo-log">[Mysql]Innodbçš„å¿«ç…§è¯»å®ç°</a>é£Ÿç”¨ï¼Œæœ¬æ–‡ä¸åšè®¨è®ºã€‚</p><p>undo logå°±æ˜¯ä¸ªå†å²ç‰ˆæœ¬ï¼Œè½ç›˜åä¸å’Œredo logå­˜åœ¨ä¸€èµ·ã€‚</p><h1 id="è¡¨ç©ºé—´">1. è¡¨ç©ºé—´</h1><p>InnoDBå­˜å‚¨å¼•æ“æä¾›äºŒç§æ•°æ®åº“è¡¨çš„å­˜å‚¨æ–¹å¼</p><ol><li>ç³»ç»Ÿè¡¨ç©ºé—´ï¼šæ‰€æœ‰æ•°æ®ä¸Šæ”¾åœ¨ä¸€èµ·ï¼Œç‰©ç†æ–‡ä»¶å¯ä»¥æ‹†æˆå¤šä¸ªæ–‡ä»¶ã€‚</li><li>ç‹¬å è¡¨ç©ºé—´ï¼šæ¯ä¸ªè¡¨æœ‰è‡ªå·±çš„ç‰©ç†æ–‡ä»¶ï¼Œæ€§èƒ½æ›´å¥½ã€‚</li></ol><p>å…³äºæ›´å¤šä¸åœ¨è®¨è®ºèŒƒå›´ã€‚</p><h1 id="ç»“æ„å±‚æ¬¡">2. ç»“æ„å±‚æ¬¡</h1><p>Rollback Segmentï¼ˆrsegï¼‰ç§°ä¸ºå›æ»šæ®µã€‚Mysql5.6ä¹‹å‰undoé»˜è®¤è®°å½•åˆ°ç³»ç»Ÿè¡¨ç©ºé—´ï¼ˆibdataï¼‰ï¼Œå¦‚æœå¼€å¯äº† innodb_file_per_table ï¼Œå°†æ”¾åœ¨æ¯ä¸ªè¡¨çš„.ibdæ–‡ä»¶ä¸­ã€‚5.6ä¹‹åè¿˜å¯ä»¥åˆ›å»ºç‹¬ç«‹çš„undoè¡¨ç©ºé—´ï¼Œ8ä¹‹åæ›´æ˜¯é»˜è®¤æ‰“å¼€ç‹¬ç«‹undoè¡¨ç©ºé—´ï¼Œæœ€ä½æ•°é‡ä¸º2ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯è‡³å°‘ä¸€ä¸ªundoè¡¨ç©ºé—´è¿›è¡Œtruncateï¼Œä¸€ä¸ªundoè¡¨ç©ºé—´ç»§ç»­ä½¿ç”¨ã€‚ç‹¬ç«‹undoè¡¨ç©ºé—´çš„æ–‡ä»¶æ ¼å¼æ˜¯undo001ï¼Œundo002â€¦â€¦</p><p>æ¯ä¸ªrollback Segmentä¸­é»˜è®¤æœ‰1024ä¸ªundo log segmentï¼Œmysql5.5å<strong>1ä¸ª</strong>undoè¡¨ç©ºé—´æ”¯æŒ<strong>128ä¸ª</strong>rollback Segmentã€‚0å·rollback Segmenté»˜è®¤åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ibdataä¸­ï¼Œ1-32rollback Segmentåœ¨ä¸´æ—¶è¡¨ç©ºé—´ï¼Œ33ï½128åœ¨ç‹¬ç«‹undoè¡¨ç©ºé—´ä¸­ï¼ˆæ²¡æœ‰æ‰“å¼€åˆ™åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ibdataä¸­ï¼Œè¿™æ ·ç³»ç»Ÿè¡¨ç©ºé—´ä¼šå¤ªå¤§ï¼‰ï¼Œæ‰€ä»¥<strong>1ä¸ª</strong>è¡¨ç©ºé—´<strong>æœ€å¤š</strong>æ”¯æŒ<strong>96*1024</strong>ä¸ªäº‹åŠ¡ï¼Œè¶…äº†å°±æŠ¥é”™å•¦ã€‚</p><p>ä¸€ä¸ªundo log segmentç§°ä¸ºundo logæˆ–undo slotæˆ–undoï¼›ä¸€ä¸ªundo logå¯¹è±¡å¯¹åº”å¤šä¸ªundo log recordï¼Œä¹Ÿå°±æ˜¯è®°å½•çš„å†å²ç‰ˆæœ¬ã€‚</p><p>ä¸€ä¸ªundo log segmentæœ‰ä¸€ä¸ªpageé“¾è¡¨ï¼Œundo log recordå°±æ˜¯æ”¾åœ¨pageä¸­çš„ï¼Œå½“ä¸€ä¸ªpageä¸è¶³ä»¥æ”¾ä¸‹æ–°çš„undo log recordæ—¶ï¼Œä¼šåˆ†é…æ–°çš„pageï¼Œæ”¾åˆ°é“¾è¡¨å°¾éƒ¨ã€‚</p><p>ä¸€ä¸ªundo log segmentå…¶å®æ˜¯ä¸€ä¸ªé¡µå«<code>undo log header page</code>ï¼Œæœ‰INSERT/UPDATEä¸¤ä¸ªç±»å‹ã€‚è¿™ä¸ªé¡µæœ‰ä¸€é¡¹å†…å®¹<code>TRX_UNDO_PAGE_LIST</code>æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå³undo pageé“¾è¡¨ã€‚</p><p><img src="../images/20200510231756.png" alt></p><p>ç®€å•æ¥è¯´ï¼Œç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>rollback segments(128)<ul><li>undo log segments(1024)<ul><li>undo page(Nï¼‰<ul><li>undo record</li><li>undo record</li><li>â€¦</li></ul></li></ul></li></ul></li></ul><blockquote><p>A collection of undo logs. Undo log segments exists within rollback segments. An undo log segment might contain undo logs from multiple transactions. An undo log segment can only be used by one transaction at a time but can be reused after it is released at transaction commit or rollbackâ€”â€”<a href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_undo_log_segment" target="_blank" rel="noopener">mysql#undo_log_segment</a> </p></blockquote><p>ä¸€ä¸ªrollback Segmentå¯ä»¥è¢«å¤šä¸ªäº‹åŠ¡ä½¿ç”¨ã€‚è€Œä¸€ä¸ªundo log segmentåªèƒ½è¢«ä¸€ä¸ªäº‹åŠ¡å æœ‰ã€‚ç”±äºundo log segmentåŒºåˆ†æ’å…¥å’Œæ›´æ–°ï¼ŒåˆåŒºåˆ†ä¸´æ—¶è¡¨å’Œæ™®é€šè¡¨ï¼Œæ‰€ä»¥ä¸€ä¸ªäº‹åŠ¡è‡³å¤šå æœ‰<strong>å››</strong>ä¸ªundo log segmentã€‚</p><h2 id="å¤´">2.1. å¤´</h2><p><img src="../images/20200510231756.png" alt><br>è¿™å¼ å›¾é‡Œï¼Œ</p><ul><li>Undo Log Segment Headerï¼šæ˜¯undo logçš„ç¬¬ä¸€é¡µï¼Œä¸å­˜æ”¾record</li><li>undo log headerï¼šå›¾é‡Œ<code>Undo Log Segment Header</code>çš„<code>TRX_UNDO_LAST_LOG</code>å±æ€§æŒ‡å‘äº†ä¸€ä¸ªundo pageï¼Œæ¯ä¸€ä¸ªundo pageéƒ½æœ‰undo log headeræè¿°è¿™ä¸ªundo pageçš„ä¿¡æ¯ã€‚</li><li>undo page headerï¼šå›¾é‡Œæ²¡æœ‰ï¼Œè¿™ä¸ªheaderç±»ä¼¼äºæ•°æ®é¡µçš„page headerã€‚</li></ul><h1 id="å†™undo-logè¿‡ç¨‹">3. å†™undo logè¿‡ç¨‹</h1><h2 id="åˆ†é…å›æ»šæ®µ">3.1. åˆ†é…å›æ»šæ®µ</h2><p>å½“è¯»å†™äº‹åŠ¡å¼€å¯æˆ–åªè¯»äº‹åŠ¡è½¬åŒ–ä¸ºè¯»å†™äº‹åŠ¡æ—¶ï¼Œä¼šä¸ºä¸€ä¸ªäº‹åŠ¡åˆ†é…äº‹åŠ¡idå’Œä¸€ä¸ªå›æ»šæ®µï¼ˆåªè¯»äº‹åŠ¡çš„idæ˜¯0ï¼‰ã€‚</p><p>åˆ†é…é€»è¾‘ï¼š</p><ol><li>è½®è¯¢ï¼ˆç¯å½¢ç¼“å†²ï¼ŒåŒredo logï¼‰é€‰å–ä¸€ä¸ªå¯ç”¨çš„å›æ»šæ®µï¼›</li><li>é€‰å–çš„å›æ»šæ®µå¼•ç”¨è®¡æ•°+1ï¼ˆå¤šå¯¹ä¸€ï¼‰ï¼Œé˜²æ­¢è¢«å›æ”¶ï¼ˆtruncateï¼‰ã€‚</li><li>ä¸´æ—¶è¡¨ä½¿ç”¨ä¸´æ—¶è¡¨å›æ»šæ®µï¼Œç‰¹ç‚¹æ˜¯ä¸ç”¨å†™redo logï¼Œæ™®é€šè¡¨ä½¿ç”¨çš„æ™®é€šå›æ»šæ®µéœ€è¦å†™redo logã€‚</li></ol><h2 id="ä½¿ç”¨å›æ»šæ®µ">3.2. ä½¿ç”¨å›æ»šæ®µ</h2><p>æ•°æ®å˜æ›´æ—¶ï¼Œinsertå’Œupdateåˆ†åˆ«å†™ç›¸ä¼¼ä½†ä¸åŒçš„undo logã€‚</p><ol><li>ä¸´æ—¶è¡¨ä¸ç”¨å†™redo log</li><li>æ“ä½œæ—¶æœªåˆ†é…undo log statementï¼Œåˆ™å¯¹å˜æ›´ç±»å‹åˆ†é…å¯¹åº”çš„undo log statement</li><li>åˆ†é…undo log statementæ—¶ï¼Œå¦‚æœç¼“å­˜åˆ—è¡¨æœ‰å¯ç”¨çš„undo log statementï¼Œå–å‡ºæ¥ä½¿ç”¨ã€‚</li></ol><p>redo logæœ‰è®¸å¤šç§ç±»å‹ï¼Œè¿™é‡Œæ˜¯ä¸€ç§typeä¸º<code>MLOG_UNDO_INSERT</code>çš„æ—¥å¿—ï¼Œä¿è¯undo logæ˜¯æœ‰æ•ˆçš„ã€‚</p><h2 id="å†™å…¥undo-log">3.3. å†™å…¥undo log</h2><p>insertçš„undo recordé•¿è¿™æ ·<br><img src="../images/20200510183601.png" alt></p><ul><li>type_cmplï¼šundo logç±»å‹ï¼Œpurgeæ—¶ç”¨</li><li>undo noï¼šäº‹åŠ¡ç¼–å·</li><li>table idï¼šè¡¨id</li></ul><p>updateçš„undo recordé•¿è¿™æ ·<br><img src="../images/20200510185016.png" alt></p><ul><li>DATA_ROLL_PTRï¼šè¯¥è¡Œå¯¹åº”çš„å‰ä¸€ä¸ªå†å²ç‰ˆæœ¬çš„æŒ‡é’ˆï¼Œä»è€Œæ„å»ºä¸€ä¸ªå†å²ç‰ˆæœ¬çš„é“¾è¡¨</li><li>type_cmplï¼šundo logç±»å‹ï¼Œè¾…åŠ©purgeçº¿ç¨‹æ¸…ç†</li><li>(posN,lenN,u_old_colN)[]ï¼šå­—æ®µæ—§å€¼ï¼Œåªéœ€è¦è®°å½•è¢«æ›´æ–°çš„å­—æ®µ</li><li>(pos,len,colN)[]ï¼šè¢«æ›´æ–°çš„äºŒçº§ç´¢å¼•ï¼Œå›æ»šçš„æ—¶å€™éœ€è¦</li><li>undo noï¼šäº‹åŠ¡ç¼–å·</li><li>table idï¼šè¡¨id</li></ul><p>äº‹åŠ¡noå’Œäº‹åŠ¡idè¿˜æ˜¯æœ‰äº›ä¸åŒçš„ï¼Œäº‹åŠ¡ç¼–å·æ˜¯ç”¨æ¥æ’åºçš„ï¼Œåœ¨äº‹åŠ¡æäº¤ä¹‹å‰é€šè¿‡å…¨å±€è®¡æ•°å™¨ç”Ÿæˆï¼Œç›®çš„æ˜¯ä¸ºäº†æ”¾å…¥histroy listæœ‰åºï¼Œæ–¹ä¾¿purgeæ¸…ç†ã€‚</p><p>ä¸åŒç±»å‹çš„undo recordä¸‹æœ‰äº›å±æ€§æ²¡æœ‰ï¼Œä¾‹å¦‚ç´¢å¼•æ²¡å˜åŒ–çš„æƒ…å†µä¸‹ï¼Œ<code>(pos,len,colN)[]</code>å°±æ²¡è®°å½•ã€‚</p><p>(å…¶å®æˆ‘ä¸çŸ¥é“è®°unique keyå¹²å˜›çš„)</p><h2 id="undo-logç±»å‹">3.4. undo logç±»å‹</h2><p>purgeçº¿ç¨‹åœ¨å¯¹å¾…undo logæ—¶ï¼Œä¼šæ ¹æ®undo logçš„ç±»å‹åšä¸åŒçš„åŠ¨ä½œï¼Œä¸‹é¢åˆ†ä¸ºä¸‰ç±»ï¼Œæ‹¬å·é‡Œæ˜¯åŠ¨ä½œ</p><ul><li>æ’å…¥ï¼š<ul><li>TRX_UNDO_INSERT_RECï¼šè¡¨ç¤ºæ–°å¢è®°å½•ï¼ˆä¸»é”®è®°å…¥æ—¥å¿—ï¼‰</li><li>TRX_UNDO_UPD_DEL_RECï¼šå½“è¡¨ä¸­æœ‰ä¸€æ¡è¢«æ ‡è®°ä¸ºåˆ é™¤çš„è®°å½•å’Œè¦æ’å…¥çš„æ•°æ®ä¸»é”®ç›¸åŒæ—¶ï¼Œå®é™…æ˜¯æ›´æ–°è¿™æ¡è¢«æ ‡è®°åˆ é™¤çš„è®°å½•ã€‚ï¼ˆä¸»é”®è®°å…¥æ—¥å¿—ï¼‰</li></ul></li><li>æ›´æ–°ï¼š<ul><li>TRX_UNDO_UPD_EXIST_RECï¼šï¼ˆå°†ä¸»é”®å’Œè¢«æ›´æ–°äº†çš„å­—æ®µå†…å®¹è®°å…¥æ—¥å¿—ï¼‰</li></ul></li><li>åˆ é™¤ï¼š<ul><li>TRX_UNDO_DEL_MARK_RECï¼šï¼ˆä¸»é”®è®°å…¥æ—¥å¿—ï¼‰æ ‡è®°åˆ é™¤</li></ul></li></ul><h2 id="æ’å…¥">3.5. æ’å…¥</h2><p>æ’å…¥æ—¶æ„å»ºçš„undo logï¼ŒåŒ…æ‹¬undoç±»å‹ï¼Œundo noï¼Œtable idï¼Œä¸»é”®å„åˆ—ä¿¡æ¯ã€‚</p><p>insert undo logåœ¨äº‹åŠ¡æäº¤åå°±ä¼šè¢«åˆ é™¤ã€‚</p><h2 id="æ›´æ–°">3.6. æ›´æ–°</h2><p>æ›´æ–°æ—¶æ„å»ºçš„undo logï¼ŒåŒ…æ‹¬undoç±»å‹ï¼Œundo noï¼Œtable idï¼Œä¸»é”®å„åˆ—ä¿¡æ¯ï¼Œdata_trx_idã€data_roll_pointerï¼Œè¢«æ›´æ–°çš„äºŒçº§ç´¢å¼•ï¼Œn_updatedï¼Œå­—æ®µæ—§å€¼ã€‚</p><p>MVCCé‚£ç¯‡è®²è¿‡ï¼Œæ¯è¡Œè®°å½•éƒ½æœ‰ä¸‰ä¸ªéšè—å­—æ®µï¼Œæ‰€ä»¥è®°å½•çš„<code>old_trx_id</code>ã€<code>old_roll_pointer</code>ä¼šè¢«è®°å…¥undo logï¼Œold trx_idè¡¨ç¤ºä¿®æ”¹çš„äº‹åŠ¡idï¼Œold_roll_pointeræŒ‡å‘å‰ä¸€ä¸ªundo recordã€‚</p><p>å¦‚æœè¦æ›´æ–°ä¸€è¡Œè®°å½•çš„ä¸»é”®ï¼Œéœ€è¦åˆ é™¤è®°å½•ï¼ˆdelete_markç½®1ï¼Œä¸èƒ½åŒæ­¥åˆ é™¤ï¼Œä¸ºäº†MVCCï¼‰ï¼Œå†æ’å…¥æ–°è®°å½•ï¼Œæ‰€ä»¥ä¼šæœ‰<code>TRX_UNDO_DEL_MARK_REC</code>å’Œ<code>TRX_UNDO_INSERT_REC</code>ä¸¤æ¡æ—¥å¿—ã€‚</p><p>å¯¹äºäºŒçº§ç´¢å¼•çš„æ›´æ–°éƒ½æ˜¯åˆ é™¤+æ’å…¥ã€‚</p><p>å¦‚æœæ›´æ–°ä¸€è¡Œå‰åçš„å­˜å‚¨ç©ºé—´ä¸ä¸€æ ·å¤§ï¼Œä¹Ÿéœ€è¦åˆ é™¤ï¼ˆåŒæ­¥åˆ é™¤ï¼‰å†æ’å…¥ã€‚</p><h2 id="åˆ é™¤">3.7. åˆ é™¤</h2><p>åˆ é™¤ä¸€æ¡è®°å½•ï¼Œå…¶å®åˆ†ä¸¤ä¸ªé˜¶æ®µï¼Œ</p><ol><li>prepareé˜¶æ®µï¼šå°†deleteæ ‡å¿—ä½ç½®1ï¼Œæ„é€ undo log</li><li>purgeé˜¶æ®µï¼šè¿™ä¸ªå‘ç”Ÿåœ¨äº‹åŠ¡æäº¤åï¼Œå°†è®°å½•ç§»åŠ¨åˆ°åƒåœ¾é“¾è¡¨ï¼Œç­‰å¾…å¤ç”¨ã€‚</li></ol><p>åƒåœ¾é“¾è¡¨æ˜¯æŒ‡æ•°æ®é¡µä¸Šçš„ä¸€ä¸ªå±æ€§<code>PAGE_FREE</code>ï¼ŒæŒ‡å‘ä¸€ä¸ªé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œå¯ä»¥å‚é˜…æ–‡ç« åº•éƒ¨çš„é“¾æ¥ã€‚</p><p>åˆ é™¤å±äºæ›´æ–°ï¼Œæ‰€ä»¥ä»–ä»¬çš„undo logæ˜¯åŒä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä¸è¿‡åˆ é™¤ç±»å‹çš„undo logå°‘äº†n_updatedå’Œå­—æ®µæ—§å€¼ï¼Œä»¥åŠè¢«æ›´æ–°çš„äºŒçº§ç´¢å¼•ã€‚</p><h2 id="äº‹åŠ¡prepare">3.8. äº‹åŠ¡prepare</h2><p>äº‹åŠ¡å¼€å§‹çš„é˜¶æ®µï¼Œéœ€è¦å°†undo log header pageçš„äº‹åŠ¡çŠ¶æ€<code>TRX_UNDO_STATE</code>è®¾ç½®ä¸º<code>TRX_UNDO_PREPARED</code><br><img src="../images/20200512183520.png" alt></p><h2 id="äº‹åŠ¡æäº¤">3.9. äº‹åŠ¡æäº¤</h2><p>å…ˆè¯´ä¸€ä¸‹history listï¼Œ<code>show engine innodb status</code>æ‰§è¡Œè¿™ä¸ªå‘½ä»¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°history list</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">*** WE ROLL BACK TRANSACTION (1)</span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">TRANSACTIONS</span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">Trx id counter 2915975770</span><br><span class="line"><span class="keyword">Purge</span> done <span class="keyword">for</span> trx<span class="string">'s n:o &lt; 2915975770 undo n:o &lt; 0 state: running but idle</span></span><br><span class="line"><span class="string">History list length 47</span></span><br><span class="line"><span class="string">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION 421366361910208, not started</span></span><br><span class="line"><span class="string">0 lock struct(s), heap size 1136, 0 row lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION 421366361903824, not started</span></span><br><span class="line"><span class="string">0 lock struct(s), heap size 1136, 0 row lock(s)</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå€¼è¡¨ç¤ºè¿˜æœ‰å¤šå°‘undo logæ²¡è¢«æ¸…ç†ï¼Œè¿™ä¸ªå€¼å¤ªå¤§çš„è¯ï¼Œè¯´æ˜æœ‰undo logç”±äºæœ‰å¤§äº‹åŠ¡å­˜åœ¨è€Œæ— æ³•è¢«æ¸…ç†ã€‚</p><p><code>Undo Log Segment Header</code>æœ‰ä¸ª<code>TRX_UNDO_STATE</code>ï¼Œäº‹åŠ¡æäº¤æ—¶ï¼Œ<code>TRX_UNDO_STATE</code>æœ‰ä¸‰ç§å€¼ï¼Œ</p><ul><li>å¦‚æœå½“å‰çš„undo logåªå ä¸€ä¸ªpageï¼Œä¸”å ç”¨å¤§å°ä½¿ç”¨ä¸è¶³å…¶3/4æ—¶(TRX_UNDO_PAGE_REUSE_LIMIT)ï¼Œåˆ™çŠ¶æ€è®¾ç½®ä¸º<code>TRX_UNDO_CACHED</code>ï¼Œè¯¥undoå¯¹è±¡ä¼šéšååŠ å…¥åˆ°undo cache listä¸Šï¼›</li><li>å¦‚æœäº‹åŠ¡ç±»å‹æ˜¯<code>TRX_UNDO_INSERT_REC</code>ï¼Œåˆ™çŠ¶æ€è®¾ç½®ä¸º<code>TRX_UNDO_TO_FREE</code></li><li>å¦‚æœä¸æ»¡è¶³ä¸Šé¢çš„ï¼Œå°±éœ€è¦purgeçº¿ç¨‹å»æ¸…ç†ï¼ŒçŠ¶æ€è®¾ç½®ä¸º<code>TRX_UNDO_TO_PURGE</code></li></ul><p>å¯¹äº<strong>update undo</strong>å¯¹è±¡éœ€è¦æ”¾å…¥<strong>history list</strong>ä¸Šï¼Œå…·ä½“æ˜¯å°†å½“å‰undoåŠ å…¥åˆ°å›æ»šæ®µheaderçš„TRX_RSEG_HISTORYé“¾è¡¨ä¸Šã€‚</p><p>å¦‚æœ<strong>update undo</strong>åªæœ‰æ™®é€šè¡¨ï¼Œåˆ™ç»™<strong>History list length</strong>+1ï¼Œå¦‚æœè¿˜æœ‰ä¸´æ—¶è¡¨ï¼Œåˆ™+2ï¼Œç„¶åå”¤é†’purgeçº¿ç¨‹ã€‚</p><p>å¦‚æœ<strong>update undo</strong>éœ€è¦ç¼“å­˜ï¼Œåˆ™æ”¾å…¥å›æ»šæ®µçš„update_undo_cachedé“¾è¡¨ä¸Šï¼›å¦åˆ™é‡Šæ”¾undoå¯¹è±¡å†…å­˜ã€‚</p><p>å¯¹äº<strong>insert undo</strong>åœ¨äº‹åŠ¡é‡Šæ”¾é”ã€ä»è¯»å†™äº‹åŠ¡é“¾è¡¨æ¸…é™¤ã€å…³é—­read viewåæ‰è¿›è¡Œï¼Œä¹Ÿå°±æ˜¯ç­‰æ‰€æœ‰åäº‹éƒ½åŠå®Œæ‰æ¸…ç†ã€‚</p><p>å¦‚æœ<strong>insert undo</strong>éœ€è¦ç¼“å­˜ï¼Œåˆ™æ”¾å…¥å›æ»šæ®µçš„insert_undo_cachedé“¾è¡¨ä¸Šï¼›å¦åˆ™é‡Šæ”¾undoå¯¹è±¡å†…å­˜ã€‚å’Œ<strong>update undo</strong>ä¸åŒçš„æ˜¯ï¼Œ<strong>insert undo</strong>ä¸éœ€è¦æ”¾å…¥hisotry listã€‚</p><p>äº‹åŠ¡æäº¤åï¼Œå›æ»šæ®µçš„å¼•ç”¨è®¡æ•°-1ã€‚</p><p>tip1ï¼šç”±äºcacheçš„åŸå› ï¼Œå³ä½¿dbç©ºé—²ä¸­ï¼Œhistory listçš„é•¿åº¦ä¸€èˆ¬éƒ½ä¸ä¼šæ˜¯0ã€‚<br>tip2ï¼šinsert undoçš„é‡ç”¨æ˜¯ç›´æ¥resetï¼Œè€Œupdate undoçš„é‡ç”¨æ˜¯ä¼šå’Œä¸Šä¸€ä¸ªäº‹åŠ¡çš„undo pageå…±å­˜çš„ï¼Œå…·ä½“æ˜¯undo pageä¸Šçš„undo log headeræœ‰<code>TRX_UNDO_NEXT_LOG</code> å’Œ<code>TRX_UNDO_PREV_LOG</code>æ¥è¡¨ç¤ºäº‹åŠ¡åœ¨é¡µé¢ä¸­çš„åç§»é‡çš„</p><h2 id="æ¸…ç†-purge">3.10. æ¸…ç† purge</h2><p>purgeå‘ç”Ÿåœ¨äº‹åŠ¡commitæ—¶ã€‚update undoä¼šè¢«æ”¾å…¥history listä¸­ï¼Œå½“æ²¡æœ‰æ´»è·ƒçš„äº‹åŠ¡ä½œç”¨äºundo logæ—¶ï¼Œä¼šè¢«purgeçº¿ç¨‹æ¸…ç†ã€‚å¦‚ä½•åˆ¤æ–­æœ‰æ²¡æœ‰æ´»è·ƒçš„äº‹åŠ¡ä½œç”¨äºundo log?innodbä¼šå¿«å…‹éš†ä¸€ä¸ªæ´»è·ƒçš„æœ€è€çš„read viewï¼Œæ‰€æœ‰åœ¨è¿™ä¸ªread viewä¹‹å‰çš„undo logéƒ½æ˜¯å¯ä»¥æ¸…ç†çš„ã€‚</p><p>purgeçº¿ç¨‹ä»history listæ‰¹é‡å–åˆ°undo logåï¼Œå¯¹äºin-placeæ›´æ–°ï¼Œéœ€è¦çœ‹éœ€ä¸éœ€è¦æ¸…ç†äºŒçº§ç´¢å¼•ï¼›å¯¹äºåˆ é™¤æ“ä½œï¼Œéœ€è¦å°†åˆ é™¤è®°å½•æ”¾å…¥æ•°æ®é¡µåƒåœ¾é“¾è¡¨<code>PAGE_FREE</code>ä¸­ã€‚</p><h2 id="å›æ»š">3.11. å›æ»š</h2><p>äº‹åŠ¡å›æ»šåªéœ€è¦æ‹¿åˆ°undo logçš„è¿›è¡Œé€†å‘æ“ä½œå°±å¯ä»¥äº†ã€‚</p><p>å¯¹äºæ ‡è®°åˆ é™¤çš„è®°å½•æ¸…ç†delete_markï¼›å¯¹äºæ›´æ–°ï¼Œå°†æ•°æ®å›æ»šåˆ°æœ€è€ç‰ˆæœ¬ï¼Œå›æ»šç´¢å¼•ï¼›å¯¹äºæ’å…¥æ“ä½œï¼Œç›´æ¥åˆ é™¤èšé›†ç´¢å¼•ï¼ˆåï¼‰å’ŒäºŒçº§ç´¢å¼•ï¼ˆå…ˆï¼‰ã€‚</p><h2 id="æŒä¹…åŒ–">3.12. æŒä¹…åŒ–</h2><p>todo</p><h2 id="å´©æºƒæ¢å¤">3.13. å´©æºƒæ¢å¤</h2><h1 id="åè®°">4. åè®°</h1><p>ç”±äºinsertå’Œupdateçš„ç§ç§åŒºåˆ«ï¼Œä»¥è‡³äºundo log segmentéœ€è¦åˆ†æˆä¸¤ç§ã€‚</p><h1 id="å‚è€ƒ">5. å‚è€ƒ</h1><ol><li><a href="http://mysql.taobao.org/monthly/2015/04/01/" target="_blank" rel="noopener">MySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB undo log æ¼«æ¸¸</a></li><li><a href="https://www.kancloud.cn/digest/innodb-zerok/195091" target="_blank" rel="noopener">innodbæºç åˆ†æä¹‹pageç»“æ„è§£æ</a></li><li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-undo-logs.html" target="_blank" rel="noopener">MySQL 5.7 Reference Manual 14.6.7 Undo Logs</a></li><li><a href="https://jimmy2angel.github.io/2019/05/07/InnoDB-undo-log/" target="_blank" rel="noopener">InnoDB undo log</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Innodbå­¦ä¼šæ˜¯ä¸å¯èƒ½å­¦ä¼šçš„ï¼Œè¿™è¾ˆå­éƒ½å­¦ä¸ä¼šçš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Mysql" scheme="https://htchz.cc/categories/Mysql/"/>
    
    
  </entry>
  
  <entry>
    <title>[ç½‘ç»œ]åˆ©ç”¨iptablesè½¬å‘æµé‡</title>
    <link href="https://htchz.cc/2735588161.html"/>
    <id>https://htchz.cc/2735588161.html</id>
    <published>2020-05-01T15:53:39.000Z</published>
    <updated>2020-05-31T08:41:55.802Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰ä¹°çš„GGCå®¶çš„HK vpsï¼Œä»å»å¹´å¼€å§‹ç”µä¿¡è®¿é—®ä¸€ç›´ä¸¢åŒ…ï¼Œä¸¢åŒ…ç‡ä¸€ä¸Šå»ï¼Œå¸¦å®½å†å¤§é€Ÿåº¦ä¹Ÿæ˜¯æä¸ä¸Šå»ï¼ˆ<a href="./3284953854.html">[ç½‘ç»œ]TCPæ‹¥å¡æ§åˆ¶é‚£äº›äº‹</a>ï¼‰ã€‚</p><p>äºæ˜¯æƒ³åˆ°ä¹°ä¸ªnatæœºä¸­è½¬ä¸€ä¸‹æµé‡ã€‚</p><p><img src="../images/20200502003159.png" alt><br>(2æ ¸384å†…å­˜ï¼Œé€‚åˆç”¨æ¥ä¸­è½¬æµé‡)</p><p><img src="../images/20200502000957.png" alt></p><p>natåˆ°æ‰‹åï¼Œæœºå™¨é•œåƒç”¨çš„æ˜¯centos7ï¼Œæˆ‘ä¸ç†Ÿæ‚‰firewalldè½¬å‘ï¼Œå…ˆæŠŠiptablesè£…ä¸Šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…³é—­ firewalld</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld --now</span><br><span class="line"><span class="comment"># è£…iptables</span></span><br><span class="line">yum install iptables-services</span><br><span class="line"><span class="comment"># å¼€æœºå¯åŠ¨</span></span><br><span class="line">systemctl <span class="built_in">enable</span> iptables.service --now</span><br></pre></td></tr></table></figure><p>æ¥ç€å¼€å¯ipv4è½¬å‘ï¼Œé»˜è®¤iptablesæ˜¯å…³é—­ipv4è½¬å‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸´æ—¶å¼€å¯ ipv4 è½¬å‘</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="comment"># æ°¸ä¹…å¼€å¯ ipv4 è½¬å‘</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'net.ipv4.ip_forward = 1'</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="comment"># ä½¿ç”Ÿæ•ˆ</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><p>æ¥ç€æ˜¯åŠ iptablesè§„åˆ™ï¼Œéœ€è¦åœ¨natè¡¨åŠ å…¥ä¸€æ¡DNATå’Œä¸€æ¡SNATï¼ŒDNATæ˜¯ä¿®æ”¹ç›®çš„åœ°å€ï¼Œè½¬å‘æµé‡åˆ°HK vpsï¼›SNATæ˜¯ä¿®æ”¹æºåœ°å€ï¼Œä¿è¯æµé‡å›åˆ°è¿™å°æœºä¸Šï¼ˆåªæœ‰è¿™å°æœºçŸ¥é“æ€ä¹ˆå›åˆ°æˆ‘å®¶ï¼‰ã€‚</p><p>å‡è®¾NATæœºç›‘å¬<code>10086</code>ç«¯å£ï¼ŒHK vpsçš„ipæ˜¯<code>104.104.104.104</code>ï¼ŒssæœåŠ¡ç«¯å£æ˜¯<code>10010</code>ï¼ŒNATæœºå†…ç½‘åœ°å€æ˜¯<code>192.168.1.10</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DNAT</span></span><br><span class="line">iptables -t nat -A PREROUTING -p  tcp -m tcp --dport 10086 -j DNAT --to-destination 104.104.104.104:10010</span><br><span class="line"><span class="comment"># SNATï¼Œ--to-source ip[:port] portå¯ä»¥ä¸æŒ‡å®šï¼Œä¼šæ˜¯éšæœºçš„</span></span><br><span class="line">iptables -t nat -A POSTROUTING -p tcp -m tcp -d 104.104.104.104 --dport 10010  -j SNAT --to-source 192.168.1.10</span><br><span class="line"><span class="comment"># åº”ç”¨iptables</span></span><br><span class="line">service iptables save</span><br><span class="line"><span class="comment"># é‡å¯</span></span><br><span class="line">systemctl restart iptables</span><br><span class="line"><span class="comment"># çœ‹ä¸‹natè¡¨</span></span><br><span class="line">iptables -nL -t nat</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œnatæœºè¦å¼€æ”¾<strong>10086</strong>ç«¯å£ã€‚</p><p>æœ€åä¸€æ­¥ï¼Œåœ¨natæ§åˆ¶é¢æ¿çš„<strong>NATè½¬å‘ç­–ç•¥</strong>åˆ›å»ºç­–ç•¥ï¼Œåˆ›å»ºä¸€ä¸ªæ˜ å°„åˆ°è¯¥æœºå™¨10086çš„ç­–ç•¥ï¼Œå°±èƒ½æ‹¿åˆ°å…¬ç½‘ipå’Œç«¯å£äº†ã€‚<br><img src="../images/20200502002852.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¹‹å‰ä¹°çš„GGCå®¶çš„HK vpsï¼Œä»å»å¹´å¼€å§‹ç”µä¿¡è®¿é—®ä¸€ç›´ä¸¢åŒ…ï¼Œä¸¢åŒ…ç‡ä¸€ä¸Šå»ï¼Œå¸¦å®½å†å¤§é€Ÿåº¦ä¹Ÿæ˜¯æä¸ä¸Šå»ï¼ˆ&lt;a href=&quot;./3284953854.html&quot;&gt;[ç½‘ç»œ]TCPæ‹¥å¡æ§åˆ¶é‚£äº›äº‹&lt;/a&gt;ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;äºæ˜¯æƒ³åˆ°ä¹°ä¸ªnatæœºä¸­è½¬ä¸€ä¸‹æµé‡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img s
      
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="https://htchz.cc/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="iptables" scheme="https://htchz.cc/tags/iptables/"/>
    
  </entry>
  
  <entry>
    <title>[JVM]JVMä¸­ä¸‰è‰²æ ‡è®°æ³•</title>
    <link href="https://htchz.cc/2394647798.html"/>
    <id>https://htchz.cc/2394647798.html</id>
    <published>2020-03-17T14:53:15.000Z</published>
    <updated>2020-04-02T08:07:09.175Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸‰è‰²æ ‡è®°ç®—æ³•æ˜¯æè¿°è¿½è¸ªå¼å›æ”¶å™¨çš„ä¸€ç§æœ‰ç”¨çš„æ–¹æ³•ï¼Œåˆ©ç”¨å®ƒå¯ä»¥æ¨æ¼”å›æ”¶å™¨çš„æ­£ç¡®æ€§ã€‚å¯¹è±¡åˆ†æˆä¸‰ç§ç±»å‹:</p><ul><li>é»‘è‰²:æ ¹å¯¹è±¡ï¼Œæˆ–è€…è¯¥å¯¹è±¡ä¸å®ƒçš„å­å¯¹è±¡éƒ½è¢«æ‰«æ</li><li>ç°è‰²:å¯¹è±¡æœ¬èº«è¢«æ‰«æ,ä½†è¿˜æ²¡æ‰«æå®Œè¯¥å¯¹è±¡ä¸­çš„å­å¯¹è±¡</li><li>ç™½è‰²:æœªè¢«æ‰«æå¯¹è±¡ï¼Œæ‰«æå®Œæˆæ‰€æœ‰å¯¹è±¡ä¹‹åï¼Œæœ€ç»ˆä¸ºç™½è‰²çš„ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œå³åƒåœ¾å¯¹è±¡</li></ul><p>æ ¹å¯¹è±¡è¢«ç½®ä¸ºé»‘è‰²ï¼Œå­å¯¹è±¡è¢«ç½®ä¸ºç°è‰²ã€‚<br><img src="/images/pasted-115.png" alt="upload successful"><br>ç»§ç»­ç”±ç°è‰²éå†,å°†å·²æ‰«æäº†å­å¯¹è±¡çš„å¯¹è±¡ç½®ä¸ºé»‘è‰²ã€‚</p><p><img src="/images/pasted-116.png" alt="upload successful"><br>éå†äº†æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡åï¼Œæ‰€æœ‰å¯è¾¾çš„å¯¹è±¡éƒ½å˜æˆäº†é»‘è‰²ã€‚ä¸å¯è¾¾çš„å¯¹è±¡å³ä¸ºç™½è‰²ï¼Œéœ€è¦è¢«æ¸…ç†ã€‚<br><img src="/images/pasted-117.png" alt="upload successful"><br>è¿™çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œä½†æ˜¯å¦‚æœåœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¹Ÿåœ¨è¿è¡Œï¼Œé‚£ä¹ˆå¯¹è±¡çš„æŒ‡é’ˆå°±æœ‰å¯èƒ½æ”¹å˜ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå¯¹è±¡ä¸¢å¤±é—®é¢˜</p><p>æˆ‘ä»¬çœ‹ä¸‹é¢ä¸€ç§æƒ…å†µï¼Œå½“åƒåœ¾æ”¶é›†å™¨æ‰«æåˆ°ä¸‹é¢æƒ…å†µæ—¶ï¼š<br><img src="/images/pasted-118.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A.c=C</span><br><span class="line">B.c=null</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå¯¹è±¡çš„çŠ¶æ€å›¾å˜æˆå¦‚ä¸‹æƒ…å½¢ï¼š<br><img src="/images/pasted-119.png" alt="upload successful"><br>è¿™æ—¶å€™åƒåœ¾æ”¶é›†å™¨å†æ ‡è®°æ‰«æçš„æ—¶å€™å°±ä¼šä¸‹å›¾æˆè¿™æ ·ï¼š<br><img src="/images/pasted-120.png" alt="upload successful"></p><p>æ˜¾ç„¶ï¼ŒCæ˜¯ç™½è‰²çš„ï¼Œä¹Ÿå°±æ˜¯æ¼æ ‡äº†ï¼Œä¼šè¢«å½“æˆåƒåœ¾å›æ”¶æ‰ï¼Œè¿™å¯¹ç¨‹åºæ¥è¯´æ˜¯ä¸å¯ä»¥æ¥å—çš„ã€‚</p><p>æ¼æ ‡çš„æƒ…å†µåªä¼šå‘ç”Ÿåœ¨ç™½è‰²å¯¹è±¡ä¸­ï¼Œä¸”æ»¡è¶³ä»¥ä¸‹ä»»æ„ä¸€ä¸ªæ¡ä»¶ï¼š</p><ol><li>å¹¶å‘æ ‡è®°æ—¶ï¼Œåº”ç”¨çº¿ç¨‹ç»™ä¸€ä¸ªé»‘è‰²å¯¹è±¡çš„å¼•ç”¨ç±»å‹å­—æ®µèµ‹å€¼äº†è¯¥ç™½è‰²å¯¹è±¡</li><li>å¹¶å‘æ ‡è®°æ—¶ï¼Œåº”ç”¨çº¿ç¨‹åˆ é™¤æ‰€æœ‰ç°è‰²å¯¹è±¡åˆ°è¯¥ç™½è‰²å¯¹è±¡çš„å¼•ç”¨</li></ol><p>äº‹å®ä¸Šï¼Œæ–¹æ³•1æ˜¯CMSçš„å®ç°å…³é”®ï¼Œæ–¹æ³•2æ˜¯G1çš„å®ç°å…³é”®ï¼Œæœ‰å…³å®ç°å°±ç§»æ­¥<a href="./4242301031.html">[JVM]CMS</a>å’Œ<a href="./2687941502.html">[JVM]G1</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸‰è‰²æ ‡è®°ç®—æ³•æ˜¯æè¿°è¿½è¸ªå¼å›æ”¶å™¨çš„ä¸€ç§æœ‰ç”¨çš„æ–¹æ³•ï¼Œåˆ©ç”¨å®ƒå¯ä»¥æ¨æ¼”å›æ”¶å™¨çš„æ­£ç¡®æ€§ã€‚å¯¹è±¡åˆ†æˆä¸‰ç§ç±»å‹:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é»‘è‰²:æ ¹å¯¹è±¡ï¼Œæˆ–è€…è¯¥å¯¹è±¡ä¸å®ƒçš„å­å¯¹è±¡éƒ½è¢«æ‰«æ&lt;/li&gt;
&lt;li&gt;ç°è‰²:å¯¹è±¡æœ¬èº«è¢«æ‰«æ,ä½†è¿˜æ²¡æ‰«æå®Œè¯¥å¯¹è±¡ä¸­çš„å­å¯¹è±¡&lt;/li&gt;
&lt;li&gt;ç™½è‰²:æœªè¢«æ‰«æå¯¹
      
    
    </summary>
    
      <category term="JavaåŸºç¡€" scheme="https://htchz.cc/categories/Java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="JVM" scheme="https://htchz.cc/tags/JVM/"/>
    
      <category term="GC" scheme="https://htchz.cc/tags/GC/"/>
    
  </entry>
  
  <entry>
    <title>[JVM]å†…å­˜æ¨¡å‹</title>
    <link href="https://htchz.cc/93872510.html"/>
    <id>https://htchz.cc/93872510.html</id>
    <published>2020-03-17T06:28:45.000Z</published>
    <updated>2020-03-17T09:18:39.189Z</updated>
    
    <content type="html"><![CDATA[<p>è¡¥ä¸ªå†…å­˜æ¨¡å‹ç¬”è®°ã€‚</p><a id="more"></a><p>JVM å†…å­˜å…±åˆ†ä¸ºè™šæ‹Ÿæœºæ ˆã€å †ã€æ–¹æ³•åŒºã€PCå¯„å­˜å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰ã€æœ¬åœ°æ–¹æ³•æ ˆäº”ä¸ªéƒ¨åˆ†ã€‚<br><img src="../images/20200317143112.png" alt></p><h1 id="è™šæ‹Ÿæœºæ ˆ">1. è™šæ‹Ÿæœºæ ˆ</h1><p>çº¿ç¨‹ç§æœ‰ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªè™šæ‹Ÿæœºæ ˆ</p><p>ä¸€ä¸ªæ ˆé‡Œæœ‰å¤šä¸ªå¸§ï¼Œæ ˆå¸§åŒ…å«å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ã€‚çº¿ç¨‹è°ƒç”¨æ–¹æ³•æ—¶ä¼šåˆ›å»ºæ ˆå¸§å…¥æ ˆï¼Œç»“æŸæ–¹æ³•æ—¶ä¼šå‡ºæ ˆã€‚</p><p>æ ˆæ·±åº¦è¶…è¿‡é™åˆ¶ä¼š<code>StackOverflowError</code>ï¼Œæ ˆå¸§ç”³è¯·æ—¶å†…å­˜ä¸è¶³ä¼šæŠ¥<code>OutOfMemoryError</code>ã€‚</p><h2 id="å±€éƒ¨å˜é‡è¡¨">1.1. å±€éƒ¨å˜é‡è¡¨</h2><p>ç”¨äºå­˜æ”¾å±€éƒ¨å˜é‡å’Œæ–¹æ³•å‚æ•°çš„å¼•ç”¨ï¼Œä½¿ç”¨<strong>ç´¢å¼•</strong>è¿›è¡Œè®¿é—®ã€‚</p><p>è¿™ä¸ªè¡¨çš„ç»„æˆå•ä½æ˜¯slotï¼Œ32ä½çš„jvmä¼šä½¿ç”¨32ä½çš„slotï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ<strong>long</strong>/<strong>double</strong>åœ¨32jvmä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><blockquote><p>è¢«è™šæ‹Ÿæœºæ ˆå¼•ç”¨çš„å¯¹è±¡ï¼Œå±äºGCROOTï¼Œä¸ä¼šå›æ”¶ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•å¾ˆé•¿ï¼Œä½†æ˜¯ä¸€ä¸ªå¤§å¯¹è±¡ä¸å†è¢«ä½¿ç”¨ï¼Œå¯ä»¥è®¾ç½®ä¸ºå°†å¤§å¯¹è±¡çš„å˜é‡èµ‹å€¼ä¸ºnullæ¥å¸®åŠ©gcã€‚ï¼ˆé•¿æ–¹æ³•ä½ å°±è¯¥ä¼˜åŒ–ä¸€ä¸‹äº†ï¼‰</p></blockquote><h2 id="æ“ä½œæ•°æ ˆ">1.2. æ“ä½œæ•°æ ˆ</h2><p>ä¹Ÿæ˜¯å­˜æ”¾åŸºæœ¬æ•°æ®ç±»å‹æˆ–å¼•ç”¨çš„ï¼Œåªèƒ½è¿›è¡Œ<strong>å‡ºæ ˆ/å‹æ ˆ</strong>ï¼Œä½¿ç”¨åœºæ™¯å¦‚å‘èµ·æ–¹æ³•è°ƒç”¨çš„æ—¶å€™æ”¾å‚æ•°ï¼Œç®—æœ¯è¿ç®—çš„ä¸­é—´å€¼</p><h2 id="åŠ¨æ€é“¾æ¥">1.3. åŠ¨æ€é“¾æ¥</h2><p>ä¸€ä¸ªå¼•ç”¨ï¼ŒæŒ‡å‘æ–¹æ³•åŒºçš„æ–¹æ³•ï¼Œç”±äºjavaå¤šæ€ç‰¹æ€§ï¼Œç¼–è¯‘åå¤§å¤šæ•°ä¸èƒ½ç¡®å®šå“ªä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œåªèƒ½åœ¨è¿è¡Œæ—¶æ‰èƒ½å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚</p><h2 id="æ–¹æ³•è¿”å›å€¼">1.4. æ–¹æ³•è¿”å›å€¼</h2><p>å¦‚æœæ–¹æ³•æ˜¯æ­£å¸¸é€€å‡ºï¼ˆæ²¡æœ‰å¼‚å¸¸ï¼‰ä¸”æœ‰è¿”å›å€¼ï¼Œè°ƒç”¨æ–¹éœ€è¦ä»è¿™é‡Œå–åˆ°è¿”å›å€¼ï¼Œå¹¶åœ¨æ ˆå¸§çš„æ“ä½œæ•°æ ˆè¿›è¡Œå‹æ ˆã€‚</p><h1 id="PCå¯„å­˜å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰">2. PCå¯„å­˜å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰</h1><p>çº¿ç¨‹ç§æœ‰ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªPCå¯„å­˜å™¨ï¼Œä¹Ÿå«ç¨‹åºè®¡æ•°å™¨ã€‚</p><p>PCå¯„å­˜å™¨å­˜æ”¾äº†çº¿ç¨‹å½“å‰æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ï¼Œç”¨äºä¸Šä¸‹æ–‡åˆ‡æ¢åæ¢å¤çº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚</p><p>å¦‚æœå½“å‰æ‰§è¡Œçš„æ˜¯<strong>native</strong>æ–¹æ³•ï¼Œé‚£ä¹ˆPCå¯„å­˜å™¨ä¸ºç©ºã€‚</p><h1 id="æœ¬åœ°æ–¹æ³•æ ˆ">3. æœ¬åœ°æ–¹æ³•æ ˆ</h1><p>çº¿ç¨‹ç§æœ‰ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ ˆã€‚</p><p>ç±»ä¼¼äº<strong>è™šæ‹Ÿæœºæ ˆ</strong>ï¼Œåªä¸è¿‡è¡¨ç¤ºçš„æ˜¯<strong>native</strong>æ–¹æ³•ã€‚</p><p>æ ˆæ·±åº¦è¶…è¿‡é™åˆ¶ä¼š<code>StackOverflowError</code>ï¼Œæ ˆå¸§ç”³è¯·æ—¶å†…å­˜ä¸è¶³ä¼šæŠ¥<code>OutOfMemoryError</code>ã€‚</p><h1 id="å †">4. å †</h1><p>çº¿ç¨‹å…±äº«ã€‚GCåŒºåŸŸã€‚</p><h1 id="æ–¹æ³•åŒº">5. æ–¹æ³•åŒº</h1><p>çº¿ç¨‹å…±äº«ã€‚é€»è¾‘ä¸Šå±äºå †å†…å­˜ã€‚ä¸»è¦ç”¨äºå­˜å‚¨ç±»çš„ä¿¡æ¯ã€å¸¸é‡æ± ã€é™æ€å˜é‡ã€åŠæ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚</p><h2 id="æ–¹æ³•åŒºï¼Œå…ƒç©ºé—´ä¸æ°¸ä¹…ä»£">5.1. æ–¹æ³•åŒºï¼Œå…ƒç©ºé—´ä¸æ°¸ä¹…ä»£</h2><p><strong>æ–¹æ³•åŒº</strong>æ˜¯jvmè§„èŒƒï¼ŒHotspotä»¥å‰ç”¨<strong>æ°¸ä¹…ä»£</strong>å®ç°ï¼Œæ”¾åœ¨äº†å †å†…å­˜é‡Œã€‚jdk8å®Œå…¨åºŸé™¤äº†<strong>æ°¸ä¹…ä»£</strong>ï¼Œå°†è¿™äº›æ•°æ®æ”¾åˆ°äº†<strong>æœ¬åœ°å†…å­˜</strong>ã€‚</p><p>ä¸»è¦åŸå› æ˜¯:</p><ol><li>å¸¸é‡å­˜åœ¨æ°¸ä¹…ä»£ä¸­ï¼Œå®¹æ˜“å‡ºç°æ€§èƒ½é—®é¢˜å’Œå†…å­˜æº¢å‡ºã€‚</li><li>ç±»åŠæ–¹æ³•çš„ä¿¡æ¯ç­‰æ¯”è¾ƒéš¾ç¡®å®šå…¶å¤§å°ï¼Œå› æ­¤å¯¹äºæ°¸ä¹…ä»£çš„å¤§å°æŒ‡å®šæ¯”è¾ƒå›°éš¾ï¼Œå¤ªå°å®¹æ˜“å‡ºç°æ°¸ä¹…ä»£æº¢å‡ºï¼Œå¤ªå¤§åˆ™å®¹æ˜“å¯¼è‡´è€å¹´ä»£æº¢å‡ºã€‚æ¯”å¦‚jspç”ŸæˆåŠ¨æ€ç±»ï¼Œè¿™æ˜¯æ¯”è¾ƒéš¾é¢„æµ‹çš„ã€‚</li><li>æ°¸ä¹…ä»£ä¼šä¸º GC å¸¦æ¥ä¸å¿…è¦çš„å¤æ‚åº¦ï¼Œå¹¶ä¸”å›æ”¶æ•ˆç‡åä½ï¼Œæ¯•ç«Ÿè¿™äº›ä¸œè¥¿æ˜¯ä¸€ç›´ä¸å˜çš„ã€‚</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¡¥ä¸ªå†…å­˜æ¨¡å‹ç¬”è®°ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="JavaåŸºç¡€" scheme="https://htchz.cc/categories/Java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="JVM" scheme="https://htchz.cc/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>[k8s]istioè‡ªåŠ¨æ³¨å…¥å¤±è´¥</title>
    <link href="https://htchz.cc/855478903.html"/>
    <id>https://htchz.cc/855478903.html</id>
    <published>2020-02-26T16:05:20.000Z</published>
    <updated>2020-02-26T17:25:53.347Z</updated>
    
    <content type="html"><![CDATA[<p>æŸ¥äº†æˆ‘ä¸€å¤©å–µçš„</p><a id="more"></a><h1 id="è¿‡ç¨‹">1. è¿‡ç¨‹</h1><p>istioä¸¤ç§æ³¨å…¥æ¨¡å¼ï¼Œä¸€ç§æ˜¯æ‰§è¡Œ<code>istioctl kube-inject</code>å°†ç›®æ ‡<code>deployment</code>çš„yamlå…ˆä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯æ‰‹åŠ¨æ³¨å…¥<code>sidecar</code>å’Œ<code>initContainer</code>ï¼Œå¦ä¸€ç§å°±æ˜¯åœ¨<code>pod</code>è¢«éƒ¨ç½²çš„æ—¶å€™ï¼Œåˆ©ç”¨k8sçš„<code>webhook</code>æœºåˆ¶ï¼Œè¿›è¡Œè‡ªåŠ¨æ³¨å…¥ã€‚</p><p>åœ¨è‡ªåŠ¨æ³¨å…¥å‰ï¼Œè¦åœ¨éƒ¨ç½²å®¹å™¨çš„<code>namespace</code>æ‰“ä¸Š<code>istio-injection: enabled</code>æ ‡ç­¾ï¼Œè¿™æ ·æ‰ä¼šè‡ªåŠ¨æ³¨å…¥ï¼ŒåŒæ—¶ï¼Œè¿˜å¯ä»¥æŒ‡å®š<code>template</code>çš„æ³¨è§£:<code>sidecar.istio.io/inject: true</code>æ¥åšæ›´å°ç²’åº¦çš„æ§åˆ¶ã€‚</p><p>åœ¨ä½¿ç”¨<code>bookinfo</code>çš„demoè¿‡ç¨‹ä¸­ï¼Œè‡ªåŠ¨æ³¨å…¥å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œç”šè‡³è¿<code>pod</code>éƒ½æ²¡æœ‰<code>create</code>ã€‚</p><p>æ‰§è¡Œ<code>kubectl describe deployment productpage</code>æŸ¥çœ‹å…¶ä¸­ä¸€ä¸ª<code>deployment</code>ï¼Œå‘ç°åªæœ‰ä¸€ä¸ªäº‹ä»¶ï¼Œ <code>Scaled up replica set productpage-v1-596598f447 to 1</code>ï¼Œç„¶åå°±æ²¡æœ‰ç„¶åäº†ã€‚</p><p>æ‰§è¡Œ<code>kubectl describe replicaset productpage-v1-596598f447</code>ï¼Œæ˜¾ç¤º<strong>failed calling webhook â€œsidecar-injector.istio.ioâ€: Post <a href="https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s" target="_blank" rel="noopener">https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s</a>: context deadline exceeded`</strong>ï¼Œ</p><p>æŸ¥çœ‹<code>apiserver</code>çš„æ—¥å¿—ï¼Œä¸€ç›´æç¤º</p><pre><code>&quot;sidecar-injector.istio.io&quot;: Post https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</code></pre><p>æŸ¥çœ‹<code>controller-manager</code>çš„æ—¥å¿—ï¼Œä¸€ç›´æç¤º</p><pre><code>Event(v1.ObjectReference{Kind:&quot;HorizontalPodAutoscaler&quot;, Namespace:&quot;istio-system&quot;, Name:&quot;istio-telemetry&quot;, UID:&quot;da322eac-127a-4c78-89e6-db614d697949&quot;, APIVersion:&quot;autoscaling/v2beta2&quot;, ResourceVersion:&quot;10847941&quot;, FieldPath:&quot;&quot;}): type: &apos;Warning&apos; reason: &apos;FailedComputeMetricsReplicas&apos; invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: unable to get metrics for resource cpu: no metrics returned from resource metrics API</code></pre><p>çœ‹èµ·æ¥æ˜¯åœ¨è¯´æ‰¾ä¸åˆ°<strong>metrics api</strong>ï¼Ÿ</p><p>ä¸Šå®˜ç½‘ï¼Œ<a href="https://istio.io/docs/ops/common-problems/injection/" target="_blank" rel="noopener">Istio / Sidecar Injection Problems</a>æ²¡æœ‰ä¸€ä¸ªæè¿°æ˜¯ç¬¦åˆçš„ã€‚github issueä¹Ÿæ²¡æœ‰æåˆ°è¦å®‰è£…<code>metrics-server</code>ã€‚</p><p>æœ€åæ‰¾åˆ°ä¸€ç¯‡<a href="https://www.yp14.cn/2019/12/12/Istio%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5sidecar%E5%87%BA%E9%94%99%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" target="_blank" rel="noopener">åšå®¢</a>ï¼Œé‡Œé¢æåˆ°</p><p><img src="../images/20200227005407.png" alt><br>äºæ˜¯ä¹–ä¹–å®‰è£…<code>metrics-server</code>ï¼Œç„¶åæ³¨å…¥<code>sidecar</code>çš„<code>pod</code>å°±æˆåŠŸåˆ›å»ºäº† = = å…¶å®ä¸€æ—©å°±çœ‹åˆ°å…³äº<strong>metrics api</strong>çš„æŠ¥é”™ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºé‚£æ˜¯æ”¶é›†ç›‘æ§æ•°æ®çš„ï¼Œäºæ˜¯æ²¡é¸Ÿä»–ï¼Œè¿˜æ˜¯å›¾æ ·äº†ã€‚</p><h1 id="demo">2. demo</h1><p><img src="../images/20200227012503.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æŸ¥äº†æˆ‘ä¸€å¤©å–µçš„&lt;/p&gt;
    
    </summary>
    
      <category term="å®¹å™¨" scheme="https://htchz.cc/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="k8s" scheme="https://htchz.cc/tags/k8s/"/>
    
      <category term="istio" scheme="https://htchz.cc/tags/istio/"/>
    
  </entry>
  
  <entry>
    <title>[Javaä»£ç†]Springçš„cglibä¸finalæ–¹æ³•çš„å‘</title>
    <link href="https://htchz.cc/4249712641.html"/>
    <id>https://htchz.cc/4249712641.html</id>
    <published>2020-01-12T05:51:39.000Z</published>
    <updated>2020-02-18T13:48:06.863Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>cglibæ˜¯é‡‡ç”¨ç”Ÿæˆç›®æ ‡ç±»subclassæ–¹å¼æ¥ä»£ç†ç›®æ ‡ç±»çš„ï¼Œæ‰€ä»¥å¦‚æœç›®æ ‡ç±»çš„æ–¹æ³•æ˜¯<code>final</code>çš„è¯ï¼Œå°±ä¼šç›´æ¥è°ƒç”¨ç›®æ ‡ç±»çš„æ–¹æ³•ã€‚Springçš„cglibä»£ç†å®ç°æœ‰ç‚¹å‘ï¼Œå°±æ˜¯ç”Ÿæˆçš„ä»£ç†å¯¹è±¡æ˜¯æ²¡æœ‰è°ƒç”¨æ„é€ å‡½æ•°çš„ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡çš„æˆå‘˜å˜é‡ä¸ä¼šåˆå§‹åŒ–ã€‚</p><h1 id="null">2. null</h1><p>Springçš„aopæ˜¯åŸºäºä»£ç†çš„ï¼Œè€Œé‡‡ç”¨cglibçš„å®ç°ä¸‹ï¼Œå¯¹äºä¸€ä¸ªbeanï¼Œå‡è®¾åªä»£ç†ä¸€æ¬¡çš„æƒ…å†µä¸‹ï¼ˆå¢å¼ºä¸€æ¬¡ï¼‰ï¼Œå†…å­˜å®é™…æ˜¯æœ‰ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä¸€ä¸ªç›®æ ‡å¯¹è±¡ã€‚å½“æˆ‘ä»¬è°ƒç”¨ä»£ç†å¯¹è±¡çš„éfianlæ–¹æ³•ï¼Œä»£ç†å¯¹è±¡è°ƒç”¨å®Œåˆ‡é¢é€»è¾‘ï¼Œä¸æ˜¯è°ƒç”¨è‡ªå·±çˆ¶ç±»æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•ï¼›å¦‚æœè°ƒç”¨ä»£ç†å¯¹è±¡çš„finalæ–¹æ³•ï¼Œä»£ç†å¯¹è±¡ä¼šç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚</p><p>çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRunner</span> <span class="keyword">implements</span> <span class="title">Runner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"I'm &#123;&#125;"</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">Â·</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        objects[<span class="number">0</span>] = <span class="string">"hijacked!"</span>;</span><br><span class="line">        <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">newProxy</span><span class="params">(Class klass)</span> </span>&#123;</span><br><span class="line">        enhancer.setSuperclass(klass);</span><br><span class="line">        enhancer.setCallback(<span class="keyword">new</span> CglibProxy());</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCglib</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CglibProxy cglibProxy = <span class="keyword">new</span> CglibProxy();</span><br><span class="line">    DefaultRunner runner = (DefaultRunner) cglibProxy.newProxy(DefaultRunner.class);</span><br><span class="line">    runner.run(<span class="string">"proxy"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬è°ƒç”¨ä»£ç†å¯¹è±¡çš„<code>runner.run(&quot;Tony&quot;)</code>ï¼Œæ—¥å¿—è¾“å‡ºçš„å°†ä¼šæ˜¯â€œIâ€™m Tonyâ€è€Œä¸æ˜¯â€œIâ€™m hijacked!â€ã€‚</p><p>è€ŒSpringä½¿ç”¨<code>org.springframework.aop.framework.CglibAopProxy</code>å¯¹ç›®æ ‡å¯¹è±¡è¿›è¡Œä»£ç†ï¼Œæˆ‘çš„ç¨‹åºåœ¨è°ƒç”¨ä¸€ä¸ªfianlæ–¹æ³•çš„æ—¶å€™ï¼ŒæŠ¥äº†ä¸€ä¸ªNPEå¼‚å¸¸ï¼Œdebugè¿›å»ä¸€çœ‹ï¼Œæˆå‘˜å˜é‡<code>logger</code>å±…ç„¶æ˜¯<code>null</code>ã€‚<br><img src="../images/20200112142005.png" alt><br>äº‹å®ä¸Šï¼ŒSpringçš„<code>CglibAopProxy</code>ç”Ÿæˆçš„ä»£ç†å¯¹è±¡çš„æˆå‘˜å˜é‡éƒ½æ˜¯nullï¼Œå› ä¸ºä»Springè®¾è®¡ä¸Šï¼Œä»£ç†ç±»åªè´Ÿè´£å¢å¼ºé€»è¾‘ï¼Œç„¶åå†è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰åˆå§‹åŒ–æˆå‘˜å˜é‡çš„å¿…è¦ã€‚<br><img src="../images/20200112142143.png" alt></p><p>å®é™…ä¸Šæˆ‘ä¹Ÿä¸éœ€è¦è¿™ä¸ªå¯¹è±¡è¢«ä»£ç†ã€‚ã€‚æ‰‹åŠ¨newä¸€ä¸ªå¯¹è±¡å°±æ­£å¸¸äº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;cglibæ˜¯é‡‡ç”¨ç”Ÿæˆç›®æ ‡ç±»subclassæ–¹å¼æ¥ä»£ç†ç›®æ ‡ç±»çš„ï¼Œæ‰€ä»¥å¦‚æœç›®æ ‡ç±»çš„æ–¹æ³•æ˜¯&lt;code&gt;final&lt;/code&gt;çš„è¯ï¼Œå°±ä¼šç›´æ¥è°ƒç”¨ç›®æ ‡ç±»çš„æ–¹æ³•ã€‚Springçš„cglibä»£ç†å®ç°æœ‰ç‚¹å‘ï¼Œå°±æ˜¯ç”Ÿæˆçš„ä»£ç†å¯¹è±¡æ˜¯æ²¡æœ‰è°ƒç”¨æ„é€ å‡½æ•°çš„
      
    
    </summary>
    
      <category term="Proxy" scheme="https://htchz.cc/categories/Proxy/"/>
    
    
      <category term="AOP" scheme="https://htchz.cc/tags/AOP/"/>
    
      <category term="BUG" scheme="https://htchz.cc/tags/BUG/"/>
    
  </entry>
  
  <entry>
    <title>[Mysql]Innodbçš„å¿«ç…§è¯»å®ç°</title>
    <link href="https://htchz.cc/3647734067.html"/>
    <id>https://htchz.cc/3647734067.html</id>
    <published>2019-12-11T14:08:30.000Z</published>
    <updated>2020-05-25T09:28:34.201Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>æœ‰ä¸€æ¬¡é¢è¯•ï¼Œé¢è¯•å®˜é—®æˆ‘ï¼šmysqläº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼Ÿ<br>æˆ‘ï¼šbalabalaâ€¦â€¦<br>é¢è¯•å®˜é—®ï¼šé‚£å¯é‡å¤è¯»æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ<br>æˆ‘ï¼šemmã€‚ã€‚ç¬¬ä¸€æ¬¡è¯»ä¼šæœ‰å¿«ç…§ã€‚ã€‚<br>é¢è¯•å®˜ï¼šå—¯ã€‚ã€‚<br>æˆ‘ï¼šã€‚ã€‚ã€‚</p><p>ç„¶åå‘¢ï¼Œç„¶åå°±ä¸çŸ¥é“å•¦ã€‚</p><p>äº‹å®ä¸Šï¼ŒInnodbçš„RCå’ŒRRéš”ç¦»çº§åˆ«ä¸‹ï¼Œè¯»æœ‰<strong>å¿«ç…§è¯»ï¼ˆsnapshot readï¼‰</strong>å’Œ<strong>å½“å‰è¯»ï¼ˆcurrent readï¼‰</strong>ä¹‹åˆ†ï¼Œ<strong>å½“å‰è¯»</strong>å°±æ˜¯<code>SELECT ... LOCK IN SHARE MODE</code>å’Œ<code>SELECT ... FOR UPDATE</code>ï¼Œå¿«ç…§è¯»å°±æ˜¯æ™®é€šçš„<code>SELECT</code>æ“ä½œã€‚</p><p><strong>å¿«ç…§è¯»</strong>çš„å®ç°ï¼Œåˆ©ç”¨äº†<strong>undo log</strong>å’Œ<strong>read view</strong>ã€‚</p><p><strong>å¿«ç…§è¯»ä¸æ˜¯åœ¨è¯»çš„æ—¶å€™ç”Ÿæˆå¿«ç…§ï¼Œè€Œæ˜¯åœ¨å†™çš„æ—¶å€™ä¿ç•™äº†å¿«ç…§ã€‚</strong></p><p><strong>å¿«ç…§è¯»</strong>å®ç°äº†<strong>Multi-Version Concurrent Controlï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰</strong>ï¼Œç®€ç§°<strong>MVCC</strong>ï¼ŒæŒ‡å¯¹äºåŒä¸€ä¸ªè®°å½•ï¼Œä¸åŒçš„äº‹åŠ¡ä¼šæœ‰ä¸åŒçš„ç‰ˆæœ¬ï¼Œä¸åŒç‰ˆæœ¬äº’ä¸å½±å“ï¼Œæœ€åäº‹åŠ¡æäº¤æ—¶æ ¹æ®ç‰ˆæœ¬å…ˆåç¡®å®šèƒ½å¦æäº¤ã€‚</p><p>ä½†æ˜¯ï¼Œ<strong>Innodb</strong>çš„è¯»å†™äº‹åŠ¡ä¼šåŠ æ’ä»–é”ï¼Œä¸åŒç‰ˆæœ¬å…¶å®æ˜¯<strong>ä¸²è¡Œ</strong>çš„ï¼Œæ‰€ä»¥é¦–å…ˆè¦æŒ‡å‡ºçš„æ˜¯ï¼Œ<strong>Innodbäº‹åŠ¡å¿«ç…§è¯»ä¸æ˜¯ä¸¥æ ¼çš„MVCCå®ç°</strong>ã€‚</p><h1 id="å®ç°">2. å®ç°</h1><h2 id="éšè—å­—æ®µ">2.1. éšè—å­—æ®µ</h2><p>Innodbæ¯ä¸€è¡Œéƒ½æœ‰ä¸‰ä¸ªéšè—å­—æ®µï¼Œåˆ†åˆ«æ˜¯<code>DB_ROW_ID</code>ã€<code>DB_TRX_ID</code>ã€<code>DB_ROLL_PTR</code>ã€‚</p><p><code>DB_ROW_ID</code>ï¼šå¦‚æœè¡¨æ²¡æœ‰è®¾ç½®ä¸»é”®ï¼Œç”¨æ¥ä½œä¸ºè®°å½•çš„ä¸»é”®ï¼Œå› ä¸º<strong>Innodb</strong>ä½¿ç”¨èšç°‡ç´¢å¼•çš„æ–¹å¼å­˜å‚¨ï¼Œè®°å½•å¿…é¡»æœ‰ä¸»é”®ã€‚<br><code>DB_TRX_ID</code>ï¼šè®°å½•ä¿®æ”¹è¿™è¡Œè®°å½•äº‹åŠ¡çš„idã€‚<br><code>DB_ROLL_PTR</code>ï¼šæŒ‡å‘è¿™è¡Œè®°å½•çš„å‰ä¸€ä¸ªç‰ˆæœ¬ã€‚</p><h2 id="undo-log">2.2. undo log</h2><p>å¤šç‰ˆæœ¬å…¶å®æ˜¯ç”¨<strong>undo log</strong>æ¥å®ç°çš„ï¼Œ<strong>undo log</strong>å¬èµ·æ¥æ˜¯åšå›æ»šä½¿ç”¨çš„ï¼Œæ²¡é”™ï¼Œä½†æ˜¯äº‹åŠ¡æäº¤å<strong>undo log</strong>å¯ä¸ä¼šç«‹åˆ»æ¸…é™¤ï¼Œå®ƒä½œä¸ºå†å²ç‰ˆæœ¬å­˜åœ¨ç€ã€‚åªæœ‰å½“å‰æ²¡æœ‰äº‹åŠ¡ä¾èµ–åœ¨è¿™è¡Œè®°å½•ä¸Šæ—¶ï¼Œmysqlçš„æ¸…ç†çº¿ç¨‹æ‰ä¼šæ¸…ç†æ‰æ— ç”¨çš„<strong>undo log</strong>ã€‚</p><p><code>insert</code>æ“ä½œçš„<strong>undo log</strong>åœ¨äº‹åŠ¡å›æ»šæˆ–æäº¤åå°±ä¼šåˆ é™¤ï¼Œå› ä¸ºåªæœ‰å›æ»šä¼šç”¨åˆ°ã€‚<br><code>update</code>ã€<code>delete</code>çš„<strong>undo log</strong>éœ€è¦ä¿ç•™ï¼ˆå¯è§<code>delete</code>åªæ˜¯é€»è¾‘åˆ é™¤ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸ª<code>update</code>æ“ä½œï¼Œé€»è¾‘åˆ é™¤åç”±åå°çº¿ç¨‹æ¸…ç†ï¼‰ã€‚</p><p>ä¸‹é¢å‡è®¾æœ‰ä¸€æ¡è®°å½•å¦‚ä¸‹ï¼Œ<strong>column_1</strong>ã€<strong>column_2</strong>åˆå§‹å€¼ä¸º1å’Œ2ã€‚<br><img src="../images/20191212171021.png" alt><br>å‡è®¾è¿™æ—¶æœ‰ä¸ªä¸‰ä¸ªäº‹åŠ¡ABCï¼ŒA,Cäº‹åŠ¡å¼€å§‹ï¼Œå¯¹è¿™æ¡è®°å½•çš„æŸ¥è¯¢ç»“æœå¦‚ä¸‹ï¼š</p><table><thead><tr><th align="center">column_1</th><th align="center">column_2</th></tr></thead><tbody><tr><td align="center">1</td><td align="center">2</td></tr></tbody></table><p>æ¥ç€Aäº‹åŠ¡æ‰§è¡Œæ›´æ–°<strong>column_1</strong>ä¸º11ï¼›<br>å…·ä½“è¿‡ç¨‹æ˜¯ï¼šç»™è®°å½•åŠ Xé”ï¼Œå¤åˆ¶è®°å½•ä¸º<strong>undo_log_1</strong>ï¼Œç„¶åå†å°†è®°å½•çš„<strong>column_1</strong>æ”¹ä¸º11ï¼Œ<code>DB_TRX_ID</code>ä¸ºAï¼Œ<code>DB_ROLL_PTR</code>æŒ‡å‘å‰ä¸€ä¸ªç‰ˆæœ¬ã€‚</p><blockquote><p>è™½ç„¶æ•°æ®è¡Œå’Œ<strong>undo log</strong>ç”»çš„ä¸€æ ·ï¼Œä½†å®é™…<strong>undo log</strong>æœ‰è‡ªå·±çš„æ•°æ®ç»“æ„ã€‚</p></blockquote><p><img src="../images/20191212171048.png" alt><br>Aäº‹åŠ¡æäº¤ï¼Œé‡Šæ”¾Xé”ã€‚</p><p>æ¥ç€Bå¼€å¯äº‹åŠ¡ï¼Œæ‰§è¡Œæ›´æ–°<strong>column_2</strong>ä¸º22ï¼›<br>å…·ä½“è¿‡ç¨‹æ˜¯ï¼šç»™è®°å½•åŠ Xé”ï¼Œå¤åˆ¶Aäº‹åŠ¡æ›´æ–°å®Œçš„è®°å½•ä¸º<strong>undo_log_2</strong>ï¼Œç„¶åå†å°†è®°å½•çš„<strong>column_2</strong>æ”¹ä¸º22ï¼Œ<code>DB_TRX_ID</code>ä¸ºBï¼Œ<code>DB_ROLL_PTR</code>æŒ‡å‘å‰ä¸€ä¸ªç‰ˆæœ¬ã€‚<br><img src="../images/20191212171106.png" alt><br>ç„¶åBäº‹åŠ¡æäº¤ã€‚</p><p>æ³¨æ„ï¼ï¼å¦‚æœAäº‹åŠ¡æ²¡æœ‰æäº¤ï¼ŒXé”æ˜¯ä¸ä¼šé‡Šæ”¾çš„ï¼Œé‚£ä¹ˆBäº‹åŠ¡å¯¹è¿™è¡Œè®°å½•æ‰§è¡Œupdateä¸ºäº†è·å–Xé”ä¼šé˜»å¡ä½çš„ï¼Œè€Œ<strong>MVCC</strong>æ ‡å‡†å„ä¸ªç‰ˆæœ¬åº”è¯¥æ˜¯ä¸ä¼šç›¸äº’å½±å“çš„ï¼Œæ‰€ä»¥è¯´<strong>Innodbäº‹åŠ¡å¿«ç…§è¯»ä¸æ˜¯ä¸¥æ ¼çš„MVCCå®ç°</strong>ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒCäº‹åŠ¡è¿™æ—¶æ‰§è¡Œç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ŒæŸ¥è¯¢ç»“æœä¼šæ˜¯ä»€ä¹ˆå‘¢ã€‚</p><h2 id="read-view">2.3. read view</h2><p>å…‰æœ‰å¤šç‰ˆæœ¬è¿˜ä¸å¤Ÿï¼Œéœ€è¦ä¸€ä¸ªæœºåˆ¶å¯¹<strong>undo log</strong>è¿›è¡Œå¯è§æ€§åˆ¤æ–­ï¼Œå†³å®šå½“å‰äº‹åŠ¡è¯»åˆ°çš„æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸ªæœºåˆ¶å°±æ˜¯é€šè¿‡<strong>read view</strong>å®Œæˆï¼Œ</p><p><strong>read view</strong>æ˜¯å¯¹å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„æ‰€æœ‰äº‹åŠ¡åˆ—è¡¨çš„å°è£…ï¼Œæ³¨æ„æ˜¯æ‰€æœ‰äº‹åŠ¡ï¼Œè€Œä¸æ˜¯ä½œç”¨äºç›®æ ‡è¡Œçš„äº‹åŠ¡ã€‚</p><p><strong>read view</strong>æœ€æ—©çš„äº‹åŠ¡idè®°ä¸º<code>up_limit_id</code>ï¼Œæœ€è¿Ÿçš„äº‹åŠ¡idè®°ä¸º<code>low_limit_id</code>ï¼ˆ<code>low_limit_id</code> = æœªå¼€å¯çš„äº‹åŠ¡id = å½“å‰æœ€å¤§äº‹åŠ¡id+1ï¼‰ï¼Œæ´»è·ƒäº‹åŠ¡idåˆ—è¡¨è®°ä¸º<code>descriptors</code>ã€‚</p><p>RCå’ŒRRçš„åŒºåˆ«å°±æ˜¯ï¼ŒRRåœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢ä¼šåˆ›å»ºæ–°çš„<strong>read view</strong>ï¼ŒRCæ˜¯æ¯æ¬¡æŸ¥è¯¢éƒ½åˆ›å»º<strong>read view</strong>ã€‚</p><blockquote><p>å¦‚æœè®°å½•ä¸Šçš„<code>trx_id</code>å°äº<code>read_view_t-&gt;up_limit_id</code>ï¼Œåˆ™è¯´æ˜è¿™æ¡è®°å½•çš„æœ€åä¿®æ”¹åœ¨readviewåˆ›å»ºä¹‹å‰ï¼Œå› æ­¤è¿™æ¡è®°å½•å¯ä»¥è¢«çœ‹è§ã€‚</p><p>å¦‚æœè®°å½•ä¸Šçš„<code>trx_id</code>å¤§äºç­‰äº<code>read_view_t-&gt;low_limit_id</code>ï¼Œåˆ™è¯´æ˜è¿™æ¡è®°å½•çš„æœ€åä¿®æ”¹åœ¨readviewåˆ›å»ºä¹‹åï¼Œå› æ­¤è¿™æ¡è®°å½•è‚¯å®šä¸å¯ä»¥è¢«çœ‹è§ã€‚</p><p>å¦‚æœè®°å½•ä¸Šçš„<code>trx_id</code>åœ¨<code>up_limit_id</code>å’Œ<code>low_limit_id</code>ä¹‹é—´ï¼Œä¸”<code>trx_id</code>åœ¨<code>read_view_t-&gt;descriptors</code>ä¹‹ä¸­ï¼Œåˆ™è¡¨ç¤ºè¿™æ¡è®°å½•çš„æœ€åä¿®æ”¹æ˜¯åœ¨readviewåˆ›å»ºä¹‹åï¼Œè¢«å¦å¤–ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡æ‰€ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™æ¡è®°å½•ä¹Ÿä¸å¯ä»¥è¢«çœ‹è§ã€‚å¦‚æœ<code>trx_id</code>ä¸åœ¨<code>read_view_t-&gt;descriptors</code>ä¹‹ä¸­ï¼Œåˆ™è¡¨ç¤ºè¿™æ¡è®°å½•çš„æœ€åä¿®æ”¹åœ¨readviewåˆ›å»ºä¹‹å‰ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°ã€‚</p><p>åŸºäºä¸Šè¿°åˆ¤æ–­ï¼Œå¦‚æœè®°å½•ä¸å¯è§ï¼Œåˆ™å°è¯•ä½¿ç”¨undoå»æ„å»ºè€çš„ç‰ˆæœ¬(row_vers_build_for_consistent_read)ï¼Œç›´åˆ°æ‰¾åˆ°å¯ä»¥è¢«çœ‹è§çš„è®°å½•æˆ–è€…è§£æå®Œæ‰€æœ‰çš„undoã€‚</p></blockquote><p>ä¸Šä¸€èŠ‚é‡Œï¼Œå‡è®¾äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯<strong>RR</strong>ï¼Œäº‹åŠ¡idå¤§å°é¡ºåºæ˜¯ï¼šX &lt; C &lt; A &lt; B &lt; D(Dæ˜¯æœªå¼€å¯çš„äº‹åŠ¡Id)ï¼Œäº‹åŠ¡éƒ½æ˜¯è¯»å†™äº‹åŠ¡ï¼ˆåªè¯»äº‹åŠ¡ä¸ä¼šåŠ å…¥<strong>read view</strong>ï¼‰</p><p>é‚£ä¹ˆCäº‹åŠ¡ç¬¬ä¸€æ¬¡æŸ¥è¯¢åˆ›å»ºä¸€ä¸ª<strong>read view</strong>ï¼Œ<code>up_limit_id</code>ä¸ºCï¼Œ<code>low_limit_id</code>ä¸ºBï¼Œ<code>descriptors</code>ä¸º{Cï¼ŒA}ï¼Œè¿™æ—¶è®°å½•çš„<code>DB_TRX_ID</code>æ˜¯Xï¼ŒA &gt; Xï¼Œè¯´æ˜è®°å½•å¯è§ã€‚</p><p>å½“Aäº‹åŠ¡æ›´æ–°å®Œæ¯•Bäº‹åŠ¡æ›´æ–°å®Œæ¯•åï¼ŒCäº‹åŠ¡æ‰§è¡Œç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œ<strong>read view</strong>è¿˜æ˜¯æœ€å¼€å§‹çš„é‚£ä¸ªï¼Œæ­¤æ—¶è®°å½•çš„<code>DB_TRX_ID</code>æ˜¯Bï¼Œ&gt;= <code>low_limit_id</code>ï¼Œ å› æ­¤è¿™æ¡è®°å½•è‚¯å®šä¸å¯ä»¥è¢«çœ‹è§ï¼Œéœ€è¦æ²¿ç€å†å²ç‰ˆæœ¬æ‰¾ã€‚</p><p>è®°å½•çš„å‰ä¸€ä¸ªç‰ˆæœ¬çš„<code>DB_TRX_ID</code>æ˜¯Aï¼Œåœ¨<code>up_limit_id</code>å’Œ<code>low_limit_id</code>ä¹‹é—´, ä¸”åœ¨<code>descriptors</code>ä¹‹é—´ï¼Œæ‰€ä»¥æ­¤ç‰ˆæœ¬è¿˜æ˜¯ä¸å¯ä»¥è¢«çœ‹è§ï¼Œç»§ç»­å¾€å†å²ç‰ˆæœ¬æ‰¾ã€‚</p><p>å‰ä¸€ä¸ªç‰ˆæœ¬çš„<code>DB_TRX_ID</code>æ˜¯Xï¼Œ&lt; <code>up_limit_id</code>, æ‰€ä»¥è¯¥ç‰ˆæœ¬å¯è§ï¼Œæ‰€ä»¥Cäº‹åŠ¡ç¬¬äºŒæ¬¡æŸ¥è¯¢ç»“æœä¾æ—§æ˜¯ï¼š</p><table><thead><tr><th align="center">column_1</th><th align="center">column_2</th></tr></thead><tbody><tr><td align="center">1</td><td align="center">2</td></tr></tbody></table><p>è¿™å°±åšåˆ°äº†å¯é‡å¤è¯»ã€‚</p><p><strong>å¦‚æœæ˜¯RCå‘¢ï¼Ÿ</strong></p><p>Cäº‹åŠ¡æ‰§è¡Œç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œåˆ›å»ºæ–°çš„<strong>read view</strong>ï¼Œ<code>up_limit_id</code>ä¸ºCï¼Œ<code>low_limit_id</code>ä¸ºDï¼Œ<code>descriptors</code>ä¸º{C}ï¼Œæ­¤æ—¶è®°å½•çš„<code>DB_TRX_ID</code>æ˜¯Bï¼Œåœ¨<code>up_limit_id</code>å’Œ<code>low_limit_id</code>ä¹‹é—´ï¼Œä½†æ˜¯ä¸åœ¨åœ¨<code>descriptors</code>ä¹‹ä¸­ï¼Œæ‰€ä»¥è®°å½•æ˜¯å¯è§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Cäº‹åŠ¡å¯ä»¥è¯»åˆ°Bäº‹åŠ¡æäº¤çš„ç»“æœï¼Œè¿™å°±æ˜¯RCå¿«ç…§è¯»çš„å®ç°ã€‚</p><h2 id="å¹»è¯»">2.4. å¹»è¯»</h2><p>RRçº§åˆ«ä¸‹ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œï¼Œå¦‚æœå…¨ç¨‹åªè¿›è¡Œ<strong>å¿«ç…§è¯»</strong>æ“ä½œï¼Œé‚£ä¹ˆæ˜¯ä¸ä¼šå‘ç”Ÿå¹»è¯»çš„ï¼Œä¹Ÿä¸ä¼šåŠ é”ï¼›å¦‚æœäº‹åŠ¡è¿›è¡Œå¿«ç…§è¯»åˆè¿›è¡Œäº†å†™æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿå¹»è¯»ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼šRRçš„å¹»è¯»åªå‘ç”Ÿåœ¨å†™æ“ä½œä¸­</p><p>å¯ä»¥ç”¨å½“å‰è¯»è§£å†³å¹»è¯»ã€‚</p><h2 id="èšç°‡ç´¢å¼•">2.5. èšç°‡ç´¢å¼•</h2><p>èšç°‡ç´¢å¼•åœ¨æ›´æ–°ä¸»é”®çš„æ—¶å€™ï¼Œä¼šåˆ æ‰æ—§è®°å½•ï¼Œæ’å…¥å¸¦æœ‰æ–°ä¸»é”®çš„è®°å½•ã€‚</p><h2 id="äºŒçº§ç´¢å¼•">2.6. äºŒçº§ç´¢å¼•</h2><p>äºŒçº§ç´¢å¼•æ˜¯æ²¡æœ‰éšè—å­—æ®µçš„ï¼Œæ‰€ä»¥<strong>æ²¡æœ‰undo log</strong>ï¼Œåªæœ‰ä¸€ä¸ªæ ‡å¿—ä½ã€‚</p><p>å¦‚æœä¸€ä¸ªupdateè¯­å¥æ›´æ–°åˆ°äº†äºŒçº§ç´¢å¼•ï¼Œæ—§äºŒçº§ç´¢å¼•<code>delete_mark</code>ç½®1ï¼Œæ’å…¥æ–°äºŒçº§ç´¢å¼•ã€‚æŸ¥è¯¢çš„æ—¶å€™ï¼Œè¦åˆ¤æ–­å¯è§æ€§æ€ä¹ˆåŠï¼Ÿæ ¹æ®äºŒçº§ç´¢å¼•æ‰¾åˆ°èšç°‡ç´¢å¼•ï¼ˆæ— è§†delete_markï¼‰ï¼Œå†ä»èšç°‡ç´¢å¼•å¼€å§‹å¯è§æ€§åˆ¤æ–­ï¼Œæ‰¾åˆ°å¯è§è®°å½•ï¼Œå¦‚æœå¯è§è®°å½•å’ŒäºŒçº§ç´¢å¼•ç»´æŠ¤çš„ç»“æœä¸€è‡´ï¼ˆç´¢å¼•å€¼å’Œä¸»é”®å€¼ä¸€æ ·ï¼‰ï¼Œå°±è¿”å›è®°å½•ï¼Œå¦åˆ™è¿”å›ç©ºã€‚</p><p>è¿™æ ·æ•ˆç‡æ¯”è¾ƒä½ï¼Œæ¯”å¦‚studentè¡¨é‡Œageæ˜¯äºŒçº§ç´¢å¼•ï¼ŒæŸ¥è¯¢æ¡ä»¶æ˜¯age=10ï¼Œæ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„age-&gt;student_idçš„äºŒçº§ç´¢å¼•ä¼šæœ‰å¤šä¸ªï¼Œäº‹åŠ¡äº‹åŠ¡éœ€è¦éå†æ‰€æœ‰age=10çš„ç´¢å¼•è¿›è¡Œå¯è§æ€§åˆ¤æ–­æ‰èƒ½æ‹¿åˆ°æ—§å€¼ã€‚</p><p>äºæ˜¯innodbç»™äºŒçº§ç´¢å¼•åŠ äº†ä¸ª<code>MAX_TRX_ID</code>è®°å½•æœ€åæ›´æ–°äºŒçº§ç´¢å¼•çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰äº‹åŠ¡read_viewçš„ up_limit_id &gt; MAX_TRX_IDï¼Œè¯´æ˜åœ¨åˆ›å»ºread_viewæ—¶æœ€åä¸€æ¬¡æ›´æ–°äºŒçº§ç´¢å¼•çš„äº‹åŠ¡å·²ç»ç»“æŸï¼Œå°±å¯ä»¥æ— è§†<code>delete_mark=1</code>çš„äºŒçº§ç´¢å¼•ã€‚å¦‚æœ<code>MAX_TRX_ID</code>å¤±æ•ˆï¼Œä¾æ—§è¦éå†æ‰€æœ‰age=10çš„äºŒçº§ç´¢å¼•ã€‚</p><h2 id="é¢˜å¤–è¯">2.7. é¢˜å¤–è¯</h2><p>åœ¨InnoDBé‡Œé¢æœ‰ä¸¤ç§äº‹åŠ¡æ¨¡å¼ï¼Œä¸€ç§æ˜¯è¯»å†™äº‹åŠ¡ï¼Œå°±æ˜¯ä¼šå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„äº‹åŠ¡ï¼Œå¦å¤–ä¸€ç§æ˜¯åªè¯»äº‹åŠ¡ï¼Œä»…ä»…å¯¹æ•°æ®è¿›è¡Œè¯»å–ã€‚å¼€å¯ä¸€ä¸ªè¯»å†™äº‹åŠ¡è¦åšçš„äº‹æ¯”å¼€å¯ä¸€ä¸ªåªè¯»äº‹åŠ¡å¤šè®¸å¤šï¼Œéœ€è¦åˆ†é…å›æ»šæ®µæ¥è®°å½•undo logï¼Œéœ€è¦æŠŠè¯»å†™äº‹åŠ¡åŠ å…¥åˆ°å…¨å±€è¯»å†™äº‹åŠ¡é“¾è¡¨ï¼ŒæŠŠäº‹åŠ¡idåŠ å…¥æ´»è·ƒè¯»å†™äº‹åŠ¡æ•°ç»„ä¸­ï¼Œæ‰€ä»¥ä½ çš„äº‹åŠ¡æ²¡æœ‰å†™æ“ä½œçš„è¯ï¼Œå£°æ˜ä¸ºåªè¯»äº‹åŠ¡æ˜¯ä¸ªä¸é”™çš„ä¼˜åŒ–ã€‚</p><p>5.6 å¦‚æœè¦å¼€å§‹åªè¯»äº‹åŠ¡ï¼Œéœ€è¦æ˜¾å¼æŒ‡æ˜äº‹åŠ¡æ¨¡å¼ä¸ºåªè¯»ï¼›</p><p>5.7å¦‚æœä¸æŒ‡æ˜äº‹åŠ¡æ¨¡å¼ï¼Œmysqlä¼šåˆå§‹åŒ–ä¸ºåªè¯»äº‹åŠ¡ï¼Œå¦‚æœå‘ç”Ÿå†™æ“ä½œï¼Œå†å°†äº‹åŠ¡æå‡ä¸ºè¯»å†™äº‹åŠ¡ï¼Œåˆ†é…å›æ»šæ®µï¼Œåˆ†é…äº‹åŠ¡idï¼ˆåªè¯»äº‹åŠ¡ä¹Ÿæœ‰idå•¦ï¼‰ï¼ŒåŠ å…¥è¯»å†™äº‹åŠ¡é“¾è¡¨ã€‚<br>5.7å¦‚æœä¸€æ¬¡<strong>read view</strong>ä½¿ç”¨å®Œåï¼Œæ²¡æœ‰æ–°çš„è¯»å†™äº‹åŠ¡åˆ›å»ºï¼Œé‚£ä¹ˆå¯ä»¥ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡å¤ç”¨ã€‚</p><p>è¿˜æœ‰<strong>æ€§èƒ½</strong>ï¼Œç”±äºè¯»æ˜¯ä¸åŠ é”çš„ï¼ŒRRä¼¼ä¹æ¯”RCå¼€é”€å°ï¼Œé‚£æ˜¯ä¸æ˜¯RRçš„æ€§èƒ½æ¯”RCå¥½ï¼Ÿäº‹å®æ˜¯ä¸ä¸€å®šçš„ï¼Œåœ¨å†™çš„æ—¶å€™ï¼ŒRRä¸ºäº†é˜²æ­¢å¹»è¯»ï¼ŒåŠ å…¥äº†gapå’Œnext-keyé”ï¼Œè¿™é€šå¸¸æ˜¯RRä¼šé€ æˆæ­»é”ï¼Œå¯¼è‡´RRæ¯”RCå·®çš„åŸå› ã€‚</p><h1 id="åè®°">3. åè®°</h1><p>åœ¨è¿™ä¹‹å‰ï¼Œä¸æ˜ç™½ä¸ºä»€ä¹ˆäº‹åŠ¡å¯ä»¥ä¸´æ—¶æŒ‡å®šéš”ç¦»çº§åˆ«ï¼Œä¸´æ—¶æŒ‡å®šä¸éœ€è¦å…¶ä»–äº‹åŠ¡é…åˆä¹ˆï¼Œç°åœ¨åº”è¯¥æ‡‚äº†ğŸ˜ï¼Œä¸è¿‡äº‹åŠ¡è¿˜æœ‰å¥½å¤šä¸æ‡‚ğŸ˜</p><h1 id="å‚è€ƒ">4. å‚è€ƒ</h1><ol><li><a href="http://mysql.taobao.org/monthly/2017/12/01/" target="_blank" rel="noopener">MySQL Â· å¼•æ“ç‰¹æ€§ Â· InnoDB äº‹åŠ¡ç³»ç»Ÿ</a></li><li><a href="https://www.cnblogs.com/stevenczp/p/8018986.html" target="_blank" rel="noopener">MySQL InnoDB MVCCæ·±åº¦åˆ†æ</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;æœ‰ä¸€æ¬¡é¢è¯•ï¼Œé¢è¯•å®˜é—®æˆ‘ï¼šmysqläº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼Ÿ&lt;br&gt;æˆ‘ï¼šbalabalaâ€¦â€¦&lt;br&gt;é¢è¯•å®˜é—®ï¼šé‚£å¯é‡å¤è¯»æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ&lt;br&gt;æˆ‘ï¼šemmã€‚ã€‚ç¬¬ä¸€æ¬¡è¯»ä¼šæœ‰å¿«ç…§ã€‚ã€‚&lt;br&gt;é¢è¯•å®˜ï¼šå—¯ã€‚ã€‚&lt;br&gt;æˆ‘ï¼šã€‚ã€‚ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶å
      
    
    </summary>
    
      <category term="Mysql" scheme="https://htchz.cc/categories/Mysql/"/>
    
    
      <category term="äº‹åŠ¡" scheme="https://htchz.cc/tags/%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>[ç¢ç¢å¿µ]ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹</title>
    <link href="https://htchz.cc/1473130276.html"/>
    <id>https://htchz.cc/1473130276.html</id>
    <published>2019-12-03T01:01:33.000Z</published>
    <updated>2019-12-11T03:07:48.770Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹ç¬¬äºŒç‰ˆåŸºäºredis3.0ï¼Œç°åœ¨6.0éƒ½å¿«å‡ºäº†ã€‚ç°åœ¨rediså’Œä¹¦é‡Œæœ‰äº›å†…å®¹å·²ç»ä¸ä¸€è‡´äº†ï¼Œä¸è¿‡ç”¨æ¥æ¢ç´¢redisæ˜¯æŒºå¥½çš„ã€‚</p><h1 id="ç¢ç¢å¿µ">2. ç¢ç¢å¿µ</h1><h2 id="ç¼–ç ">2.1. ç¼–ç </h2><p>ç°åœ¨çš„rediså·²ç»å¢åŠ äº†quicklistã€streamç¼–ç ã€‚</p><p>quicklistæ˜¯ziplistå’Œlinkedlistçš„æ•´åˆï¼Œä½œä¸ºlistçš„å”¯ä¸€ç¼–ç ï¼Œå…¶æ€æƒ³å°±æ˜¯å°†zipliståˆ†æ®µï¼Œziplistå†…å­˜ç¢ç‰‡å°‘ä½†æ¯æ¬¡æ“ä½œéƒ½è¦ç”³è¯·å†…å­˜ï¼Œå°†zipliståˆ†æ®µï¼Œå¹¶ç”¨æ“ä½œæ€§èƒ½æ¯”è¾ƒå¥½çš„åŒå‘é“¾è¡¨æŠŠæ®µä¸²èµ·æ¥ï¼Œè¿™ç®—æ˜¯æ—¶é—´ä¸ç©ºé—´çš„æŠ˜ä¸­ã€‚</p><p>streamç¼–ç ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ²¡æœ‰å»äº†è§£ã€‚</p><h2 id="å­—å…¸">2.2. å­—å…¸</h2><p>å­—å…¸expand/resizeæ˜¯redisçš„ä¸€ä¸ªå¤§è¯é¢˜ã€‚</p><p>å­—å…¸æ‰§è¡Œ<code>BGSAVE</code>æˆ–<code>BGREWRITEAOF</code>æ—¶è´Ÿè½½å› å­å¿…é¡»è¾¾åˆ°5æ‰èƒ½è¿›è¡Œæ‰©å®¹ï¼Œæ‰§è¡Œ<code>BGSAVE</code>æˆ–<code>BGREWRITEAOF</code>æ—¶ä¸èƒ½è¿›è¡Œç¼©å®¹ã€‚</p><p>ä¹‹æ‰€ä»¥ï¼Œæ˜¯å› ä¸º<code>BGSAVE</code>æˆ–<code>BGREWRITEAOF</code>ä½¿ç”¨äº†<code>copy-on-write</code>ï¼Œä¹Ÿå°±æ˜¯å†™æ—¶å¤åˆ¶ã€‚æ‰§è¡Œ<code>BGSAVE</code>æˆ–<code>BGREWRITEAOF</code>æ—¶redisä¼šforkå­è¿›ç¨‹ï¼Œè¿™æ—¶å€™å¦‚æœè¿›è¡Œä¸€ä¸ªå†…å­˜çš„æ‹·è´ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰ï¼Œé‚£ä¹ˆå†…å­˜çš„æµªè´¹æ˜¯å¾ˆå¤§çš„ã€‚ä½¿ç”¨å†™æ—¶å¤åˆ¶ï¼Œä¼šå°†çˆ¶è¿›ç¨‹çš„å†…å­˜è®¾ç½®ä¸ºåªè¯»ï¼Œå°†å†…å­˜å’Œå­è¿›ç¨‹å…±äº«ï¼Œç”±äºå†…å­˜æ˜¯åˆ†é¡µæœºåˆ¶ï¼Œå½“æŸä¸€é¡µå†…å­˜è¦å‘ç”Ÿå†™æ“ä½œæ—¶ï¼Œä¼šå‘ç”Ÿä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠè¿™ä¸€é¡µå†…å­˜å¤åˆ¶å‡ºæ¥è¿›è¡Œä¿®æ”¹ã€‚</p><p>å› æ­¤ï¼Œä¸ºäº†å‡å°‘å†™æ“ä½œå¯¼è‡´å†…å­˜é¡µå¤åˆ¶ï¼Œredisæ‰æœ‰äº†åœ¨ä¸Šé¢çš„ç­–ç•¥ã€‚</p><h2 id="ä¸‹ä¸ª2çš„å¹‚">2.3. ä¸‹ä¸ª2çš„å¹‚</h2><p>redisåœ¨expand/resizeéƒ½å°†æ–°æ•°ç»„çš„é•¿åº¦è®¾ç½®ä¸º2çš„å¹‚ï¼Œè¿™æ˜¯å› ä¸ºæŠŠæ•°ç»„é•¿åº¦è®¾ç½®ä¸º2çš„å¹‚ï¼Œå°±å¯ä»¥æŠŠå–æ¨¡è¿ç®—è½¬åŒ–ä¸ºä½è¿ç®—ï¼Œjavaé‡Œä¹Ÿæ˜¯è¿™ä¹ˆåšã€‚</p><p>redisä½œè€…ä½¿ç”¨äº†è¿™ä¹ˆä¸€ä¸ªç®—æ³•æ¥æ±‚ç»™å®šä¸€ä¸ªæ•°çš„ä¸‹ä¸ª2çš„å¹‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Our hash table capability is a power of two */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> _dictNextPower(<span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> i = DICT_HT_INITIAL_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= LONG_MAX) <span class="keyword">return</span> LONG_MAX + <span class="number">1L</span>U;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= size)</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        i *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆç®€å•çš„å¾ªç¯ï¼Œä¸è¿‡æœ‰äººç»™ä»–æå‡ºå¯ä»¥ç”¨ä½è¿ç®—ï¼š<a href="https://github.com/antirez/redis/pull/3833" target="_blank" rel="noopener">ä¼ é€é—¨</a>ï¼Œjavaé‡Œç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªç®—æ³•ï¼Œ<a href="./2353864749.html">HashMapçš„tableSizeFor()</a>ã€‚</p><p>ä½œè€…è¯´ä¸é”™ï¼Œä½†æ˜¯æ²¡å¿…è¦ï¼Œè¿™ç§ä½è¿ç®—çš„é­”æ³•å¯¹ç°å®æ¥è¯´éƒ½æ˜¯å‡çš„ï¼Œåªä¼šæŠŠä»£ç æå¤æ‚ã€‚</p><h2 id="EMBSTR">2.4. EMBSTR</h2><p>ä¹¦é‡Œçš„<code>REDIS_ENCODING_EMBSTR</code>æ”¯æŒæœ€å¤§é•¿åº¦39å­—èŠ‚ï¼Œè€Œç°åœ¨æœ€å¤§æ”¯æŒ44å­—èŠ‚ï¼ŒåŸå› æ˜¯3.2ç‰ˆæœ¬ä¹‹åsdshdrå˜äº†ã€‚<code>REDIS_ENCODING_EMBSTR</code>ä½¿ç”¨<code>sdshdr8</code>æ¥è¡¨ç¤ºï¼ŒåŸæ¥çš„sdshdréœ€è¦8å­—èŠ‚ï¼Œç°åœ¨ä½¿ç”¨<code>sdshdr8</code>åªéœ€è¦ä¸‰å­—èŠ‚ï¼Œé‚£ä¹ˆï¼š44 + 1ï¼ˆ<code>&#39;\0&#39;</code>ï¼‰+ 3 + 16(robj) = 64ï¼Œåˆšå¥½æ˜¯64å­—èŠ‚ï¼Œå¯ä»¥è¾¾åˆ°64å­—èŠ‚å†…å­˜å¯¹é½ã€‚</p><p>ä½œè€…ä¸€åº¦ç”¨ç€44çš„é™åˆ¶ï¼Œå†™ç€39çš„æ³¨é‡Šï¼Œè®©æˆ‘ä¸€åº¦è¿·æƒ‘ã€‚</p><h2 id="å¤šçº¿ç¨‹">2.5. å¤šçº¿ç¨‹</h2><p>redis6.0åŠ å…¥äº†å¤šçº¿ç¨‹ï¼Œä¸çŸ¥é“å’Œé˜¿é‡Œäº‘çš„å¤šçº¿ç¨‹redisæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œçœ‹èµ·æ¥éƒ½æ˜¯åœ¨ioçº¿ç¨‹å¹¶è¡Œï¼Œå·¥ä½œçº¿ç¨‹ä¸²è¡Œã€‚</p><h2 id="raft">2.6. raft</h2><p>redis é¢†å¤´sentinelé€‰ä¸¾å’Œä¸»èŠ‚ç‚¹é€‰ä¸¾éƒ½æ˜¯é‡‡ç”¨raftåè®®çš„é€‰ä¸¾æ–¹å¼ï¼šåŒä¸€ä¸ªtermé‡Œï¼Œä¸€äººä¸€ç¥¨ï¼›å½“å¾—åˆ°majorityçš„ç¥¨æ—¶é€‰ä¸¾æˆåŠŸï¼Œå½“ç¥¨è¢«ç“œåˆ†é€‰ä¸¾å¤±è´¥å¼€å§‹æ–°ä¸€è½®ã€‚</p><h2 id="LFU">2.7. LFU</h2><p>redis4.0æ–°å¢äº†lfuç­–ç•¥æ¥æ·˜æ±°key</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> lru:LRU_BITS; <span class="comment">/* LRU time (relative to global lru_clock) or</span></span><br><span class="line"><span class="comment">                            * LFU data (least significant 8 bits frequency</span></span><br><span class="line"><span class="comment">                            * and most significant 16 bits access time). */</span></span><br><span class="line">    <span class="keyword">int</span> refcount;</span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure><p>é€šè¿‡redis.confçš„è®¾ç½®ï¼Œ<code>unsigned lru:LRU_BITS</code>çš„æœ‰ä¸åŒçš„è¡¨ç¤ºã€‚å½“è¡¨ç¤ºlfuæ—¶ï¼Œè¿™ä¸ªå­—æ®µç”¨8ä½æ¥å½“ä½œè®¡æ•°å™¨ï¼Œç”¨16ä½å½“æ—¶é—´æˆ³ï¼Œ16ä½é•¿åº¦åªæœ‰ä¸¤ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å­˜çš„æ—¶é—´æ˜¯ä»¥ç§’ä½å•ä½ã€‚</p><p>åœ¨redisé‡Œlfuç­–ç•¥ä¸‹ï¼Œå¦‚æœä¸€ä¸ªkeyè¢«è®¿é—®ï¼Œé‚£ä¹ˆè®¡æ•°å™¨ä¼šå¢åŠ ï¼Œä¸è¿‡è¿™ç§å¢åŠ æ˜¯éœ€è¦ä¹˜ä¸Šä¸€ä¸ªæ¦‚ç‡çš„ï¼Œè®¡æ•°å™¨è¶Šå¤§ï¼Œè®¡æ•°å¢åŠ çš„å‡ ç‡è¶Šå°ï¼›è€ŒåŒæ—¶keyè¿˜è¦æ ¹æ®æ—¶é—´æˆ³åˆ¤æ–­è¦ä¸è¦è¡°å‡è®¡æ•°å™¨ï¼Œä»¥æ­¤è°ƒæ•´è®¡æ•°ã€‚</p><p>åœ¨è¿™ç§ç­–ç•¥ä¸‹ï¼Œredisä¼šä¸ºkeyåˆå§‹åŒ–ä¸€ä¸ª5çš„è®¡æ•°å™¨ï¼Œé˜²æ­¢keyåˆšè¢«åˆå§‹åŒ–å°±è¢«æ·˜æ±°ã€‚</p><h2 id="BITSET">2.8. BITSET</h2><p>ä½å›¾ç”¨æ¥ç»Ÿè®¡æ˜¯å¾ˆä¸é”™çš„ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œåœ¨redisé‡Œä½å›¾ä¹Ÿæ˜¯ä¸€ä¸ª<code>sdshdr</code>ï¼Œrediså°†ä¸€ä¸ªå­—ç¬¦ç”¨ä½œ8ä½ï¼Œå¹¶æŠŠä½å›¾ä»ä½ä½å¾€é«˜ä½å­˜å‚¨ï¼ˆsdshdrç”¨bufæ•°ç»„å­˜å‚¨å­—ç¬¦ä¸²ï¼Œå½“sdshdrè¡¨ç¤ºä½å›¾æ—¶ï¼Œbufæ•°ç»„ä»å·¦å¾€å³æ˜¯ä»ä½ä½åˆ°é«˜ä½ï¼‰ï¼Œè¿™æ ·å½“ä½å›¾éœ€è¦æ‰©å¤§çš„æ—¶å€™ï¼Œåªéœ€è¦åœ¨bufæ•°ç»„å°¾éƒ¨å¢åŠ å­—ç¬¦å°±å¯ä»¥äº†ã€‚</p><p>ä½å›¾çš„ç»Ÿè®¡çš„æ˜¯ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ç»Ÿè®¡ä¸€ä¸ªäºŒè¿›åˆ¶æ•°çš„1æœ‰å¤šå°‘ä¸ªã€‚</p><p>æš´åŠ›æ³•ä¸è€ƒè™‘ï¼Œè¦è¯´çš„æ˜¯ä¸¤ä¸ªæ–¹æ³•ï¼Œ<strong>æŸ¥è¡¨æ³•</strong>è¿˜æœ‰<strong>variable-precision SWARç®—æ³•</strong></p><h3 id="æŸ¥è¡¨æ³•">2.8.1. æŸ¥è¡¨æ³•</h3><p>æŸ¥è¡¨æ³•å°±æ˜¯é¢„å…ˆç»™å‡ºå„ä¸ªæ•°çš„äºŒè¿›åˆ¶çš„1çš„æ•°é‡ï¼Œå¯¹äºæ¯”è¾ƒå°çš„æ•°å­—ï¼Œè¿™æ˜¯ä¸€ä¸ªé€Ÿåº¦æœ€å¿«çš„æ–¹æ³•ã€‚</p><h3 id="variable-precision-SWARç®—æ³•">2.8.2. variable-precision SWARç®—æ³•</h3><p>è¿™ä¸ªæ–¹æ³•é‡‡ç”¨ä½è¿ç®—ï¼Œè€Œä¸”è¿˜ä¸å é¢å¤–å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">swar</span><span class="params">(<span class="keyword">uint32_t</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//è®¡ç®—æ¯ä¸¤ä½äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•°</span></span><br><span class="line">    i = ( i &amp; <span class="number">0x55555555</span>) + ((i &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">    <span class="comment">//è®¡ç®—æ¯å››ä½äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•°</span></span><br><span class="line">    i = (i &amp; <span class="number">0x33333333</span>) + ((i &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">    <span class="comment">//è®¡ç®—æ¯å…«ä½äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•°</span></span><br><span class="line">    i = (i &amp; <span class="number">0x0F0F0F0F</span>) + ((i &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F0F0F0F</span>);</span><br><span class="line">    <span class="comment">//å°†æ¯å…«ä½äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•°å’Œç›¸åŠ ï¼Œå¹¶ç§»è‡³æœ€ä½ä½å…«ä½</span></span><br><span class="line">    i = (i * <span class="number">0x01010101</span>) &gt;&gt; <span class="number">24</span>);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸€ä¸ª32ä½çš„æ•°ï¼Œé€šè¿‡ä½è¿ç®—å½’å¹¶1çš„æ•°é‡åˆ°4ä¸ªå­—èŠ‚ä¸­ï¼Œæœ€åç”¨ä¸€ä¸ªä¹˜æ³•æ±‡æ€»4ä¸ªå­—èŠ‚çš„1çš„æ•°é‡åˆ°é«˜8ä½ï¼Œè¿™ä¸ªä¹˜æ³•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">                                00000001 00000010 00000011 00000100</span><br><span class="line"></span><br><span class="line">  x                             00000001 00000001 00000001 00000001</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">                                00000001 00000010 00000011 00000100</span><br><span class="line"></span><br><span class="line">                       00000001 00000010 00000011 00000100</span><br><span class="line"></span><br><span class="line">              00000001 00000010 00000011 00000100</span><br><span class="line"></span><br><span class="line">     00000001 00000010 00000011 00000100</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">                               |00001010|Â·Â·Â·Â·Â·Â·Â·no sense bitÂ·Â·Â·Â·Â·Â·Â·</span><br></pre></td></tr></table></figure><p>æœ€åå³ç§»24ä½å¾—åˆ°è¿™8ä½çš„å€¼ã€‚</p><h3 id="redis-bitcount">2.8.3. redis bitcount</h3><p>redisé‡‡ç”¨æŸ¥æ³•å’Œvariable-precision SWARç®—æ³•ç»“åˆçš„æ–¹æ³•æ¥å®ç°bitcountã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> redisPopcount(<span class="keyword">void</span> *s, <span class="keyword">long</span> count) &#123;</span><br><span class="line">    <span class="keyword">size_t</span> bits = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p = s;</span><br><span class="line">    <span class="keyword">uint32_t</span> *p4;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> bitsinbyte[<span class="number">256</span>] = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Count initial bytes not aligned to 32 bit. */</span></span><br><span class="line">    <span class="keyword">while</span>((<span class="keyword">unsigned</span> <span class="keyword">long</span>)p &amp; <span class="number">3</span> &amp;&amp; count) &#123;</span><br><span class="line">        bits += bitsinbyte[*p++];</span><br><span class="line">        count--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Count bits 28 bytes at a time */</span></span><br><span class="line">    p4 = (<span class="keyword">uint32_t</span>*)p;</span><br><span class="line">    <span class="keyword">while</span>(count&gt;=<span class="number">28</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> aux1, aux2, aux3, aux4, aux5, aux6, aux7;</span><br><span class="line"></span><br><span class="line">        aux1 = *p4++;</span><br><span class="line">        aux2 = *p4++;</span><br><span class="line">        aux3 = *p4++;</span><br><span class="line">        aux4 = *p4++;</span><br><span class="line">        aux5 = *p4++;</span><br><span class="line">        aux6 = *p4++;</span><br><span class="line">        aux7 = *p4++;</span><br><span class="line">        count -= <span class="number">28</span>;</span><br><span class="line"></span><br><span class="line">        aux1 = aux1 - ((aux1 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux1 = (aux1 &amp; <span class="number">0x33333333</span>) + ((aux1 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux2 = aux2 - ((aux2 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux2 = (aux2 &amp; <span class="number">0x33333333</span>) + ((aux2 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux3 = aux3 - ((aux3 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux3 = (aux3 &amp; <span class="number">0x33333333</span>) + ((aux3 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux4 = aux4 - ((aux4 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux4 = (aux4 &amp; <span class="number">0x33333333</span>) + ((aux4 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux5 = aux5 - ((aux5 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux5 = (aux5 &amp; <span class="number">0x33333333</span>) + ((aux5 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux6 = aux6 - ((aux6 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux6 = (aux6 &amp; <span class="number">0x33333333</span>) + ((aux6 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux7 = aux7 - ((aux7 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux7 = (aux7 &amp; <span class="number">0x33333333</span>) + ((aux7 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        bits += ((((aux1 + (aux1 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux2 + (aux2 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux3 + (aux3 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux4 + (aux4 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux5 + (aux5 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux6 + (aux6 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux7 + (aux7 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>))* <span class="number">0x01010101</span>) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Count the remaining bytes. */</span></span><br><span class="line">    p = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)p4;</span><br><span class="line">    <span class="keyword">while</span>(count--) bits += bitsinbyte[*p++];</span><br><span class="line">    <span class="keyword">return</span> bits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå¯¹äºä½å›¾éœ€è¦4å­—èŠ‚å¯¹é½ï¼Œå› ä¸ºredisé‡Œçš„SWARç®—æ³•ä¸€æ¬¡æ“ä½œ4ä¸ªå­—èŠ‚ï¼Œä¿è¯å­—èŠ‚å¯¹é½å¯ä»¥æé«˜å†…å­˜è¯»å–é€Ÿåº¦ï¼Œç„¶åæºç é‡Œæœ‰è¿™ä¹ˆä¸€æ®µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Count initial bytes not aligned to 32 bit. */</span></span><br><span class="line"><span class="keyword">while</span>((<span class="keyword">unsigned</span> <span class="keyword">long</span>)p &amp; <span class="number">3</span> &amp;&amp; count) &#123;</span><br><span class="line">    bits += bitsinbyte[*p++];</span><br><span class="line">    count--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µæˆ‘çœ‹äº†åŠå¤©çœ‹ä¸æ‡‚ï¼Œæœ€ååœ¨stackoverflow<a href="https://stackoverflow.com/questions/19190502/how-do-i-check-a-memory-address-is-32-bit-aligned-in-c" target="_blank" rel="noopener">How Do I check a Memory address is 32 bit aligned in C</a>æ‰¾åˆ°ç­”æ¡ˆï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯åœ°å€ç»“å°¾æ˜¯100çš„å€æ•°ï¼Œä¹Ÿå°±æ˜¯<code>&amp; 11b = 0</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€å°±æ˜¯å¯ä»¥4å­—èŠ‚å¯¹é½çš„ã€‚æ‰€ä»¥å¦‚æœ<code>(unsigned long)p &amp; 3</code>ä¸ºtrueï¼Œè¯´æ˜åœ°å€ä¸å¯¹é½ï¼Œå°±è¦æŒ‡é’ˆå‰è¿›ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶é€šè¿‡æŸ¥è¡¨æ³•è®¡ç®—è¿™ä¸ªå­—èŠ‚çš„1çš„æ•°é‡ã€‚</p><p>æ¥ç€åŒæ—¶è®¡ç®—è¿ç»­çš„28ä¸ªå­—èŠ‚ï¼Œæ¯4å­—èŠ‚ä½¿ç”¨ä¸€æ¬¡SWARç®—æ³•ï¼Œå†æŠŠ7æ¬¡ç»“æœæ±‡æ€»ã€‚</p><p>æœ€åä½™ä¸‹ä¸è¶³28å­—èŠ‚çš„å†ç”¨æŸ¥è¡¨æ³•è®¡ç®—ã€‚æ•´ä¸ªbitcountçš„è¿‡ç¨‹å°±æ˜¯è¿™æ ·ã€‚</p><blockquote><p>ç»Ÿè®¡ä¸€ä¸ªä½æ•°ç»„ä¸­é0ä½çš„æ•°é‡ï¼Œæ•°å­¦ä¸Šç§°ä½œï¼šâ€Hanmming Weightâ€œ(æ±‰æ˜é‡é‡)ã€‚</p></blockquote><h2 id="AOF">2.9. AOF</h2><p>å³ä½¿å¼€å¯<strong>appendfsync always</strong>é…ç½®ï¼Œredisè¿˜æ˜¯å¯èƒ½ä¸¢æ•°æ®ã€‚</p><p>AOFä¸»è¦é <code>aof_buf</code>å’ŒAOFæ–‡ä»¶ã€‚</p><p>éƒ½è¯´redisæ˜¯åŸºäºäº‹ä»¶å¾ªç¯çš„ã€‚åœ¨ä¸€æ¬¡äº‹ä»¶å¾ªç¯é‡Œï¼Œæ¯ä¸ªå†™äº‹ä»¶rediséƒ½ä¼šè¿½åŠ åˆ°<code>aof_buf</code>ä¸­ï¼›æ¯æ¬¡äº‹ä»¶å¾ªç¯åï¼Œrediséƒ½ä¼šæŠŠ<code>aof_buf</code>çš„å†…å®¹å†™è¿›AOFæ–‡ä»¶é‡Œã€‚ä½†æ˜¯AOFæ–‡ä»¶æ˜¯ä¸ä¼šå®æ—¶åˆ·å…¥ç¡¬ç›˜çš„ï¼Œè€Œ<strong>appendfsync</strong>é…ç½®å…·ä½“å°±æ˜¯åˆ·ç›˜æ—¶æœºã€‚å¼€å¯<strong>appendfsync always</strong>é…ç½®åï¼Œæ¯ä¸ªäº‹ä»¶å¾ªç¯éƒ½ä¼šè¿›è¡Œåˆ·ç›˜ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹rediså®•æœºï¼Œä¹Ÿä¼šè‡³å¤šä¸¢å¤±ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„å‘½ä»¤ã€‚</p><p>é¢˜å¤–è¯ï¼Œinnodbæ—¥å¿—ç³»ç»Ÿä¹Ÿæœ‰<strong>log buffer</strong>å’Œ<strong>log file</strong>ï¼Œç±»ä¼¼äº<code>aof_buf</code>å’ŒAOFæ–‡ä»¶ï¼Œè€Œ<strong>innodb_flush_log_at_trx_commit</strong>è¿™ä¸ªé…ç½®æ§åˆ¶çš„ä¹Ÿæ˜¯<strong>log file</strong>åˆ·ç›˜ç­–ç•¥ï¼Œä¸è¿‡innodbå¯ä»¥åšåˆ°ä¸ä¸¢æ•°æ®ï¼Œè€Œredisä¸è¡Œã€‚</p><h1 id="å‚è€ƒ">3. å‚è€ƒ</h1><ol><li><a href="https://segmentfault.com/a/1190000015481454" target="_blank" rel="noopener">ã€Rediså­¦ä¹ ç¬”è®°ã€‘bitcountåˆ†æ</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹ç¬¬äºŒç‰ˆåŸºäºredis3.0ï¼Œç°åœ¨6.0éƒ½å¿«å‡ºäº†ã€‚ç°åœ¨rediså’Œä¹¦é‡Œæœ‰äº›å†…å®¹å·²ç»ä¸ä¸€è‡´äº†ï¼Œä¸è¿‡ç”¨æ¥æ¢ç´¢redisæ˜¯æŒºå¥½çš„ã€‚&lt;/p&gt;
&lt;h1 id=&quot;ç¢ç¢å¿µ&quot;&gt;2. ç¢ç¢å¿µ&lt;/h1&gt;&lt;h2 id=&quot;ç¼–ç &quot;&gt;2
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>[åˆ†å¸ƒå¼]æ‰‹æ’•raft</title>
    <link href="https://htchz.cc/1823228532.html"/>
    <id>https://htchz.cc/1823228532.html</id>
    <published>2019-10-03T08:27:57.000Z</published>
    <updated>2020-02-23T04:26:12.496Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>Raftä½œä¸ºä¸€ä¸ªç®€å•çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œå®ç°ä¸€ä¸‹è¿˜æ˜¯æŒºå¥½ç©çš„ã€‚ä»£ç åŸºäº<strong>6.824</strong> <a href="http://nil.csail.mit.edu/6.824/2018/labs/lab-raft.html" target="_blank" rel="noopener">lab-raft</a>ï¼Œ<strong>6.824</strong>æ˜¯éº»çœç†å·¥çš„åˆ†å¸ƒå¼è¯¾ç¨‹çš„ä¸€ä¸ªç¼–å·ï¼Œé‡Œé¢æœ‰4ä¸ªlabï¼Œç¬¬äºŒä¸ªå°±æ˜¯raftåè®®çš„å®ç°ï¼Œç¬¬ä¸‰ä¸ªæ˜¯åŸºäºraftåè®®çš„kvå­˜å‚¨è®¾è®¡ï¼Œæœ‰å¾…å®ç°ï¼ˆohæˆ‘å±…ç„¶åœ¨åšéº»çœç†å·¥çš„è¯¾ç¨‹è®¾è®¡ï¼‰ã€‚è¯¥labè¦æ±‚ä½¿ç”¨goå®ç°ç®—æ³•ï¼Œå¹¶æä¾›äº†ä¸€ä¸ª<a href="http://oserror.com/distributed/golang-rpc-with-failure-simulation/" target="_blank" rel="noopener">å…·æœ‰æ•…éšœæ¨¡æ‹ŸåŠŸèƒ½çš„RPC</a>ï¼Œå³é€šè¿‡æ¨¡æ‹Ÿç½‘ç»œï¼Œåœ¨å•å°æœºå™¨æˆ‘ä»¬å°±å¯ä»¥è¿è¡Œraftç®—æ³•ã€‚</p><blockquote><p>åšå®éªŒå‰ï¼Œä½ åº”è¯¥ç†Ÿè¯»raftè®ºæ–‡ï¼Œè¿™é‡Œæ˜¯<a href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md" target="_blank" rel="noopener">ä¸­æ–‡ç‰ˆ</a></p></blockquote><h1 id="å®ç°">2. å®ç°</h1><p>å‚ç…§raftè®ºæ–‡å’Œlabæç¤ºï¼Œæ•´ä½“åˆ©ç”¨channelä½œä¸ºäº‹ä»¶é©±åŠ¨ã€mutexä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå†™å‡ºä¸€ä¸ªraftç®—æ³•éª¨æ¶è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ã€‚ä¸è¿‡åœ¨è·‘testçš„æ—¶å€™ï¼Œå°å°çš„ç»†èŠ‚ä¸å¯¹å°±ä¼šå¯¼è‡´<code>test failed</code>ã€‚<br><img src="../images/20191004005135.png" alt><br><strong>raft-lab</strong>æä¾›äº†17ä¸ªtestï¼Œæ£€éªŒäº†å„ç§æƒ…å†µä¸‹çš„ä¸€è‡´æ€§ï¼Œæ¨¡æ‹Ÿäº†å„ç§å¥‡è‘©ç½‘ç»œå˜åŒ–ï¼ˆç½‘ç»œå˜æˆè¿™æ ·è¿˜æ˜¯è·‘è·¯å§ï¼‰ï¼Œè¦æ±‚4åˆ†é’Ÿå†…passã€‚</p><h2 id="æ•°æ®ç»“æ„">2.1. æ•°æ®ç»“æ„</h2><p>å‚ç…§è®ºæ–‡ï¼Œå®šä¹‰å‡ ä¸ªæ•°æ®ç»“æ„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">Follower = <span class="literal">iota</span></span><br><span class="line">Candidate</span><br><span class="line">Leader</span><br><span class="line"></span><br><span class="line">HeartbeatInterval = <span class="number">100</span> * time.Millisecond</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ApplyMsg <span class="keyword">struct</span> &#123;</span><br><span class="line">CommandValid <span class="keyword">bool</span></span><br><span class="line">Command      <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">CommandIndex <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">Term    <span class="keyword">int</span></span><br><span class="line">Command <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AppendEntriesArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">Term         <span class="keyword">int</span></span><br><span class="line">LeaderId     <span class="keyword">int</span></span><br><span class="line">PrevLogIndex <span class="keyword">int</span></span><br><span class="line">PrevLogTerm  <span class="keyword">int</span></span><br><span class="line">Entries      []LogEntry</span><br><span class="line">LeaderCommit <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AppendEntriesReply <span class="keyword">struct</span> &#123;</span><br><span class="line">Term      <span class="keyword">int</span></span><br><span class="line">Success   <span class="keyword">bool</span></span><br><span class="line">NextIndex <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Raft <span class="keyword">struct</span> &#123;</span><br><span class="line">currentTerm     <span class="keyword">int</span></span><br><span class="line">mu              sync.Mutex          <span class="comment">// Lock to protect shared access to this peer's state</span></span><br><span class="line">peers           []*labrpc.ClientEnd <span class="comment">// RPC end points of all peers</span></span><br><span class="line">persister       *Persister          <span class="comment">// Object to hold this peer's persisted state</span></span><br><span class="line">me              <span class="keyword">int</span>                 <span class="comment">// this peer's index into peers[]</span></span><br><span class="line">state           <span class="keyword">int</span>                 <span class="comment">// 0:Follower 1:Candidate 2:Leader</span></span><br><span class="line">votedFor        <span class="keyword">int</span>                 <span class="comment">// è¿™ä¸ªå®éªŒç”¨indexæ¥ä»£æ›¿èŠ‚ç‚¹</span></span><br><span class="line">voteCount       <span class="keyword">int</span></span><br><span class="line">commitIndex     <span class="keyword">int</span></span><br><span class="line">lastApplied     <span class="keyword">int</span></span><br><span class="line">currentLeaderId <span class="keyword">int</span></span><br><span class="line">log             []LogEntry</span><br><span class="line">nextIndex       []<span class="keyword">int</span></span><br><span class="line">matchIndex      []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">applyCh     <span class="keyword">chan</span> ApplyMsg</span><br><span class="line">heartbeatCh <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">leaderCh    <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">commitCh    <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RequestVoteArgs <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// Your data here (2A, 2B).</span></span><br><span class="line">Term         <span class="keyword">int</span></span><br><span class="line">CandidateId  <span class="keyword">int</span> <span class="comment">// è¿™ä¸ªå®éªŒç”¨indexæ¥ä»£æ›¿èŠ‚ç‚¹</span></span><br><span class="line">LastLogIndex <span class="keyword">int</span></span><br><span class="line">LastLogTerm  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RequestVoteReply <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// Your data here (2A).</span></span><br><span class="line">VoteGranted <span class="keyword">bool</span> <span class="comment">// æ˜¯å¦æ”¯æŒ</span></span><br><span class="line">Term        <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°å£°bbï¼Œ<code>AppendEntriesReply</code>è®ºæ–‡æ˜¯æ²¡æœ‰è¿”å›<code>nextIndex</code>çš„ï¼Œè€Œæ˜¯ç”±leaderè‡ªå·±å»<strong>å‡ä¸€é‡è¯•</strong>ï¼Œè¿™å…¶å®æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œåœ¨è®¾ç½®äº†ç½‘ç»œæ•…éšœ<strong>unreliable</strong>çš„testä¸­ï¼Œå•çº¯çš„<strong>å‡ä¸€é‡è¯•</strong>ä¼šå¯¼è‡´rafté›†ç¾¤åœ¨ä¸€å®šæ—¶é—´å†…ä¸èƒ½è¾¾åˆ°ä¸€è‡´ã€‚è®©followerè¿‡æ»¤æ‰åŒä¸€ä¸ªtermçš„indexï¼Œå¹¶è¿”å›åº”è¯¥å°è¯•çš„<code>nextIndex</code>ï¼Œè™½ç„¶ä¼šå¯¼è‡´ä¸€æ¬¡å¤åˆ¶çš„æ—¥å¿—å˜å¤šï¼Œä¸è¿‡æé«˜äº†é›†ç¾¤è¾¾åˆ°ä¸€è‡´çš„é€Ÿåº¦ã€‚</p><h2 id="ä¸€äº›å°è£…">2.2. ä¸€äº›å°è£…</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–é”/é‡Šæ”¾é”çš„å°è£…ï¼Œå¯ä»¥åœ¨åˆ©ç”¨`runtime.Caller`æ‰“å°è·å–é”çš„è°ƒç”¨ç‚¹ï¼Œè™½ç„¶æ€§èƒ½æŸå¤±æ¯”è¾ƒå¤§ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</span><br><span class="line">rf.mu.Lock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­—å¦‚å…¶å</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">getLastLogTerm</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> rf.log[<span class="built_in">len</span>(rf.log)<span class="number">-1</span>].Term</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">getLastLogIndex</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(rf.log) - <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="raftå®ä¾‹åˆå§‹åŒ–">2.3. raftå®ä¾‹åˆå§‹åŒ–</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Make</span><span class="params">(peers []*labrpc.ClientEnd, me <span class="keyword">int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">persister *Persister, applyCh <span class="keyword">chan</span> ApplyMsg)</span> *<span class="title">Raft</span></span> &#123;</span><br><span class="line">rf := &amp;Raft&#123;&#125;</span><br><span class="line">rf.peers = peers</span><br><span class="line">rf.persister = persister</span><br><span class="line">rf.me = me</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your initialization code here (2A, 2B, 2C).</span></span><br><span class="line">rf.state = Follower</span><br><span class="line">rf.currentTerm = <span class="number">0</span></span><br><span class="line">rf.votedFor = <span class="number">-1</span></span><br><span class="line">rf.currentLeaderId = <span class="number">-1</span></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ç©ºç™½æ—¥å¿—</span></span><br><span class="line">rf.log = <span class="built_in">append</span>(rf.log, LogEntry&#123;Term: <span class="number">0</span>&#125;)</span><br><span class="line">rf.applyCh = applyCh</span><br><span class="line"></span><br><span class="line">rf.heartbeatCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">100</span>)</span><br><span class="line">rf.leaderCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">100</span>)</span><br><span class="line">rf.commitCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize from state persisted before a crash</span></span><br><span class="line">rf.readPersist(persister.ReadRaftState())</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–éšæœºæ•°èµ„æºåº“</span></span><br><span class="line">rand.Seed(time.Now().UnixNano())</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> rf.state &#123;</span><br><span class="line"><span class="keyword">case</span> Follower:</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-rf.heartbeatCh:</span><br><span class="line"><span class="comment">// è¿™æ˜¯labè¦æ±‚å¿ƒè·³</span></span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(time.Duration(rand.Int63()%<span class="number">333</span>+<span class="number">550</span>) * time.Millisecond):</span><br><span class="line">rf.state = Candidate</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> Leader:</span><br><span class="line">rf.broadcastAppendEntries()</span><br><span class="line">time.Sleep(HeartbeatInterval)</span><br><span class="line"><span class="keyword">case</span> Candidate:</span><br><span class="line"><span class="keyword">go</span> rf.broadcastVote()</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(time.Duration(rand.Int63()%<span class="number">300</span>+<span class="number">500</span>) * time.Millisecond): <span class="comment">//éšæœºæŠ•ç¥¨è¶…æ—¶æ˜¯å¿…é¡»çš„ï¼Œä¸ºäº†é˜²æ­¢ç¥¨è¢«ç“œåˆ†å®Œã€‚</span></span><br><span class="line"><span class="keyword">case</span> &lt;-rf.heartbeatCh:</span><br><span class="line">rf.state = Follower</span><br><span class="line"><span class="keyword">case</span> &lt;-rf.leaderCh: </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">&lt;-rf.commitCh</span><br><span class="line">rf.applyMsg(applyCh)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> rf</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªraftå®ä¾‹ï¼Œè¯»å–æŒä¹…åŒ–æ•°æ®ï¼Œèµ·äº†ä¸¤ä¸ªgoroutineã€‚</p><ul><li><p>goroutine1æ˜¯raftä¸‰ç§çŠ¶æ€çš„è½¬åŒ–ï¼Œè¿™é‡Œçš„è¶…æ—¶æ—¶é—´ä¸å®œè®¾çš„å¤ªçŸ­ï¼ˆå¤ªçŸ­æŒ‡è®ºæ–‡é‡Œçš„æ—¶é—´ï¼‰ï¼Œåœ¨labæ–‡æ¡£é‡Œæœ‰æŒ‡å‡ºä¸ºäº†é…åˆtestï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´åº”è¯¥<strong>larger than the paperâ€™s 150 to 300 milliseconds</strong></p></li><li><p>goroutine2åº”ç”¨å·²æäº¤æ—¥å¿—ã€‚</p></li></ul><p>åœ¨åˆå§‹åŒ–channelçš„æ—¶å€™åº”è¯¥è®¾ç½®ç¼“å†²å¤§äº1ã€‚å¤šä½™çš„äº‹ä»¶å¹¶ä¸ä¼šå¯¼è‡´ç³»ç»Ÿä¸ä¸€è‡´ï¼Œä½†æ˜¯è‹¥ç”±äºchannelç¼“å†²ä¸å¤Ÿè€Œå¯¼è‡´é˜»å¡ï¼Œå°±ä¼šä½¿raftèŠ‚ç‚¹æ­»é”ã€‚</p><h2 id="votedForæ¸…ç©ºæ—¶æœº">2.4. votedForæ¸…ç©ºæ—¶æœº</h2><p>ä¸€æ¬¡rpcï¼Œæ— è®ºæ˜¯å‘èµ·ç«¯è¿˜æ˜¯æ¥æ”¶ç«¯ï¼Œåªè¦æ”¶åˆ°æ›´å¤§çš„termï¼Œå°±è¦è°ƒæ•´è‡ªå·±çš„çŠ¶æ€ï¼Œå‘ç”Ÿä¸‹é¢å˜åŒ–ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rf.votedFor = <span class="number">-1</span></span><br><span class="line">rf.state = Follower</span><br><span class="line">rf.currentTerm = remoteTerm</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>state</code>ä¼šå˜æˆ<code>Follower</code>ã€‚</p><p>å‡è®¾ä¸€ç§æƒ…æ™¯ï¼ŒABCä¸‰ä¸ªèŠ‚ç‚¹ä¸‹ï¼ŒAä¸ºleaderï¼Œæ­¤æ—¶Cå‘ç”Ÿåˆ†åŒºï¼Œé‚£ä¹ˆCä¸€å®šä¼šä¸æ–­å¾ªç¯è¿›è¡Œè¶…æ—¶é€‰ä¸¾ï¼ŒCçš„termä¼šä¸€ç›´å¢å¤§ï¼Œå½“Cç½‘ç»œæ¢å¤é‡æ–°åŠ å…¥é›†ç¾¤åä¼šç»§ç»­å‘æŠ•ç¥¨è¯·æ±‚rpcã€‚ç”±äºCçš„æŠ•ç¥¨è¯·æ±‚rpcä¸­çš„<code>term</code>è¾ƒå¤§ï¼Œé›†ç¾¤å°±ä¼šè°ƒæ•´<code>currentTerm</code>ä»¥åŠ<code>state</code>ï¼Œå·²æœ‰leaderä¼šåºŸæ‰ã€‚è€Œé—®é¢˜æ˜¯ï¼ŒCçš„è¯·æ±‚æŠ•ç¥¨æ˜¯æ— æ„ä¹‰çš„ï¼Œå´ä½¿é›†ç¾¤è¿›è¡Œäº†ä¸€æ¬¡é€‰ä¸¾ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜æœ‰ä¸ª<strong>preVote</strong>æ–¹æ¡ˆï¼Œå°±æ˜¯åœ¨æŠ•ç¥¨å‰è°ƒç ”ä¸€ä¸‹è‡ªå·±æ˜¯å¦æœ‰æŠ•ç¥¨å¿…è¦ï¼Œå¦‚æœæ²¡å¿…è¦ï¼Œå°±ä¸å‘èµ·æŠ•ç¥¨ã€‚è¿™ç¯‡æ–‡ç« æš‚æ— æ¶‰åŠ<strong>preVote</strong>ã€‚</p><h2 id="æŠ•ç¥¨å‘èµ·ä¸æ¥æ”¶">2.5. æŠ•ç¥¨å‘èµ·ä¸æ¥æ”¶</h2><h3 id="broadcastVote-å‘èµ·æŠ•ç¥¨">2.5.1. broadcastVote() å‘èµ·æŠ•ç¥¨</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">broadcastVote</span><span class="params">()</span></span> &#123;</span><br><span class="line">rf.Lock()</span><br><span class="line">rf.currentTerm++</span><br><span class="line">rf.voteCount = <span class="number">1</span></span><br><span class="line">rf.votedFor = rf.me</span><br><span class="line">vote := &amp;RequestVoteArgs&#123;</span><br><span class="line">Term:         rf.currentTerm,</span><br><span class="line">CandidateId:  rf.me,</span><br><span class="line">LastLogIndex: rf.getLastLogIndex(),</span><br><span class="line">LastLogTerm:  rf.getLastLogTerm(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rf.persist()</span><br><span class="line">rf.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(rf.peers); i++ &#123;</span><br><span class="line"><span class="keyword">if</span> rf.state != Candidate &#123; <span class="comment">// å‘é€</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> vote.CandidateId == i &#123; <span class="comment">// è‡ªå·±çš„ç¥¨å·²ç»ç»™è‡ªå·±äº†</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(server <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> reply RequestVoteReply</span><br><span class="line">ok := rf.sendRequestVote(server, vote, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rf.Lock()</span><br><span class="line"><span class="keyword">defer</span> rf.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸€èˆ¬æ¥è¯´ï¼Œreply.Term &gt; rf.currentTerm çš„æƒ…å†µä¸‹ reply.VoteGranted ä¸ä¼šä¸ºtrue</span></span><br><span class="line"><span class="keyword">if</span> reply.Term &gt; rf.currentTerm &#123;</span><br><span class="line">rf.votedFor = <span class="number">-1</span></span><br><span class="line">rf.state = Follower</span><br><span class="line">rf.currentTerm = reply.Term</span><br><span class="line">rf.persist()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> reply.VoteGranted &#123;</span><br><span class="line">rf.voteCount++</span><br><span class="line"><span class="keyword">if</span> rf.state == Candidate &amp;&amp; rf.voteCount &gt; <span class="built_in">len</span>(rf.peers)/<span class="number">2</span> &#123;</span><br><span class="line">rf.becomeLeader()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">sendRequestVote</span><span class="params">(server <span class="keyword">int</span>, args *RequestVoteArgs, reply *RequestVoteReply)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">ok := rf.peers[server].Call(<span class="string">"Raft.RequestVote"</span>, args, reply)</span><br><span class="line"><span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ¥æ”¶åˆ°æŠ•ç¥¨replyåï¼ŒæŸ¥çœ‹ç¥¨æ ¹æ˜¯å¦è¿‡åŠï¼Œå¦‚æœè¿‡åŠè½¬åŒ–ä¸ºleaderã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ²¡æœ‰åŠ é”ï¼Œå¤–éƒ¨è°ƒç”¨å·²ç»åŠ é”äº†</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">becomeLeader</span><span class="params">()</span></span> &#123;</span><br><span class="line">rf.state = Leader</span><br><span class="line">rf.nextIndex = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(rf.peers))</span><br><span class="line">rf.matchIndex = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(rf.peers))</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸º0</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(rf.peers); i++ &#123;</span><br><span class="line">rf.nextIndex[i] = rf.getLastLogIndex() + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">rf.leaderCh &lt;- <span class="literal">true</span> <span class="comment">// ç»“æŸé€‰ä¸¾é˜»å¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RequestVote-æ¥æ”¶æŠ•ç¥¨">2.5.2. RequestVote æ¥æ”¶æŠ•ç¥¨</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">RequestVote</span><span class="params">(args *RequestVoteArgs, reply *RequestVoteReply)</span></span> &#123;</span><br><span class="line">rf.Lock()</span><br><span class="line"><span class="keyword">defer</span> rf.Unlock()</span><br><span class="line"><span class="keyword">defer</span> rf.persist()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your code here (2A, 2B).</span></span><br><span class="line">reply.VoteGranted = <span class="literal">false</span></span><br><span class="line">reply.Term = rf.currentTerm</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿‡æœŸçš„æŠ•ç¥¨è¯·æ±‚</span></span><br><span class="line"><span class="keyword">if</span> rf.currentTerm &gt; args.Term &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¦‚æœå‘èµ·æ–¹çš„termæ¯”æ¥æ”¶æ–¹å¤§</span></span><br><span class="line"><span class="comment">// adjust current term</span></span><br><span class="line"><span class="keyword">if</span> rf.currentTerm &lt; args.Term &#123;</span><br><span class="line">rf.currentTerm = args.Term</span><br><span class="line">rf.state = Follower</span><br><span class="line">rf.votedFor = <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upToDate := <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> args.LastLogTerm &gt; rf.getLastLogTerm() &#123;</span><br><span class="line">upToDate = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> args.LastLogTerm == rf.getLastLogTerm() &amp;&amp; args.LastLogIndex &gt;= rf.getLastLogIndex() &#123;</span><br><span class="line">upToDate = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (rf.votedFor == <span class="number">-1</span> || rf.votedFor == args.CandidateId) &amp;&amp; <span class="comment">// ä¿è¯æœ‰ç¥¨</span></span><br><span class="line">upToDate &#123;</span><br><span class="line">reply.VoteGranted = <span class="literal">true</span></span><br><span class="line">rf.state = Follower</span><br><span class="line">rf.votedFor = args.CandidateId</span><br><span class="line">rf.heartbeatCh &lt;- <span class="literal">true</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ï¼Œè¿›è¡ŒæŠ•ç¥¨åè¦å‘é€å¿ƒè·³<code>rf.heartbeatCh &lt;- true</code>ï¼Œä¸ç„¶èŠ‚ç‚¹ä¼šç”±<code>Follower</code>è¶…æ—¶ï¼Œä»è€Œä½¿é›†ç¾¤é€‰ä¸¾å¾ªç¯ä¸‹å»ã€‚<br>2ï¼Œåˆ¤æ–­æ—¥å¿—æ˜¯å¦è¾ƒæ–°è¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶ï¼šä¸€ï¼Œtermè¾ƒå¤§ï¼ŒäºŒï¼Œtermä¸€æ ·ï¼Œä½†æ—¥å¿—indexæ¯”è¾ƒå¤§</p><h2 id="æ—¥å¿—å¤åˆ¶ä¸æ¥æ”¶">2.6. æ—¥å¿—å¤åˆ¶ä¸æ¥æ”¶</h2><h3 id="broadcastAppendEntries-å¹¿æ’­æ—¥å¿—-å¿ƒè·³">2.6.1. broadcastAppendEntries å¹¿æ’­æ—¥å¿—/å¿ƒè·³</h3><p>æ—¥å¿—å¤åˆ¶labæ–‡æ¡£è¦æ±‚ä¸€ç§’ä¸èƒ½è¶…è¿‡10æ¬¡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">broadcastAppendEntries</span><span class="params">()</span></span> &#123;</span><br><span class="line">rf.Lock()</span><br><span class="line"><span class="keyword">defer</span> rf.Unlock()</span><br><span class="line"></span><br><span class="line">N := rf.commitIndex</span><br><span class="line"><span class="keyword">for</span> i := rf.commitIndex + <span class="number">1</span>; i &lt;= rf.getLastLogIndex(); i++ &#123;</span><br><span class="line"><span class="comment">// 1 æ˜¯leaderæœ¬èº«</span></span><br><span class="line">num := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> j := <span class="keyword">range</span> rf.peers &#123;</span><br><span class="line"><span class="comment">// åªèƒ½æäº¤æœ¬termçš„ï¼Œä¸€æ—¦æäº¤äº†æœ¬termçš„ï¼Œæ—§termä¹Ÿç®—æäº¤äº†</span></span><br><span class="line"><span class="keyword">if</span> rf.me != j &amp;&amp; rf.matchIndex[j] &gt;= i &amp;&amp; rf.log[i].Term == rf.currentTerm &#123;</span><br><span class="line">num++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> num &gt; <span class="built_in">len</span>(rf.peers)/<span class="number">2</span> &#123;</span><br><span class="line">N = i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> N != rf.commitIndex &#123;</span><br><span class="line">rf.commitIndex = N</span><br><span class="line">rf.commitCh &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(rf.peers); i++ &#123;</span><br><span class="line"><span class="keyword">if</span> rf.state != Leader &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> i == rf.me &#123; <span class="comment">// ä¸ç”¨ç»™è‡ªå·±å¿ƒè·³</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> args AppendEntriesArgs</span><br><span class="line">args.Term = rf.currentTerm</span><br><span class="line">args.LeaderCommit = rf.commitIndex</span><br><span class="line">args.LeaderId = rf.me</span><br><span class="line">args.PrevLogIndex = rf.nextIndex[i] - <span class="number">1</span></span><br><span class="line">args.PrevLogTerm = rf.log[args.PrevLogIndex].Term</span><br><span class="line">args.Entries = <span class="built_in">make</span>([]LogEntry, <span class="built_in">len</span>(rf.log[args.PrevLogIndex+<span class="number">1</span>:]))</span><br><span class="line"><span class="comment">// å¤åˆ¶</span></span><br><span class="line"><span class="built_in">copy</span>(args.Entries, rf.log[args.PrevLogIndex+<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, args AppendEntriesArgs)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> reply AppendEntriesReply</span><br><span class="line">ok := rf.sendAppendEntries(i, &amp;args, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">rf.handleAppendEntriesReply(&amp;args, &amp;reply, i)</span><br><span class="line">&#125;(i, args)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">sendAppendEntries</span><span class="params">(server <span class="keyword">int</span>, args *AppendEntriesArgs, reply *AppendEntriesReply)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">ok := rf.peers[server].Call(<span class="string">"Raft.AppendEntries"</span>, args, reply)</span><br><span class="line"><span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡å‘é€æ—¥å¿—å‰ï¼Œleaderä»<code>matchIndex[]</code>é‡Œç»Ÿè®¡å‡ºåº”è¯¥commitçš„indexï¼Œå¦‚æœindexå‰è¿›ï¼Œå‘é€commitäº‹ä»¶ã€‚ç»Ÿè®¡æ—¶è¦åˆ¤æ–­<code>rf.log[i].Term == rf.currentTerm</code>ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½æäº¤è‡ªå·±termçš„logï¼Œä¸€æ—¦æäº¤äº†è‡ªå·±termçš„logï¼Œä¹‹å‰termæœªè¢«æäº¤çš„logä¹Ÿç®—æäº¤äº†ã€‚è¿™ä¸ªåœ¨è®ºæ–‡æœ‰æåˆ°ã€‚</p><p>ä¸‹é¢æ˜¯å¤åˆ¶æ—¥å¿—çš„å“åº”ä»£ç ï¼Œä¹Ÿå¾ˆç›´ç™½ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reply ä¸º falseï¼Œ å¦‚æœä¸æ˜¯ä»»æœŸé—®é¢˜ï¼Œå°±æ˜¯æ—¥å¿—ä¸åŒ¹é…</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">handleAppendEntriesReply</span><span class="params">(args *AppendEntriesArgs, reply *AppendEntriesReply, i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">rf.Lock()</span><br><span class="line">    <span class="keyword">defer</span> rf.Unlock()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> rf.state != Leader &#123; <span class="comment">// è·å–é”åæ ¡éªŒè‡ªå·±çš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> args.Term != rf.currentTerm &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> reply.Term &gt; rf.currentTerm &#123;</span><br><span class="line">rf.votedFor = <span class="number">-1</span></span><br><span class="line">rf.currentTerm = reply.Term</span><br><span class="line">rf.state = Follower</span><br><span class="line">rf.persist()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> reply.Success &#123;</span><br><span class="line">        <span class="comment">// len(args.Entries)  == 0 å°±æ˜¯å¿ƒè·³äº†ï¼Œä¸ç”¨å¤„ç†</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(args.Entries) &gt; <span class="number">0</span> &#123;</span><br><span class="line">rf.matchIndex[i] = args.PrevLogIndex + <span class="built_in">len</span>(args.Entries)</span><br><span class="line">rf.nextIndex[i] = rf.matchIndex[i] + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">rf.nextIndex[i] = reply.NextIndex <span class="comment">// ç›´æ¥é‡‡ç”¨followerçš„å»ºè®®</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AppendEntries-æ¥æ”¶æ—¥å¿—">2.6.2. AppendEntries æ¥æ”¶æ—¥å¿—</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">AppendEntries</span><span class="params">(args *AppendEntriesArgs, reply *AppendEntriesReply)</span></span> &#123;</span><br><span class="line">rf.Lock()</span><br><span class="line"><span class="keyword">defer</span> rf.Unlock()</span><br><span class="line"><span class="keyword">defer</span> rf.persist()</span><br><span class="line"></span><br><span class="line">reply.Success = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘Šè¯‰è€termçš„èŠ‚ç‚¹è¯¥æ›´æ–°å•¦</span></span><br><span class="line"><span class="keyword">if</span> rf.currentTerm &gt; args.Term &#123;</span><br><span class="line">reply.Term = rf.currentTerm</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¿ƒè·³</span></span><br><span class="line">rf.heartbeatCh &lt;- <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// adjust current term</span></span><br><span class="line"><span class="keyword">if</span> args.Term &gt; rf.currentTerm &#123;</span><br><span class="line">rf.currentTerm = args.Term</span><br><span class="line">rf.state = Follower</span><br><span class="line">rf.votedFor = <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reply.Term = rf.currentTerm</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™å¨æ˜¯åœ¨æ—¥å¿—ä¸åŒ¹é…çš„æƒ…å†µä¸‹ï¼Œå¯¹leaderçš„NextIndexå»ºè®®</span></span><br><span class="line"><span class="keyword">if</span> rf.getLastLogIndex() &lt; args.PrevLogIndex &#123;</span><br><span class="line">reply.NextIndex = rf.getLastLogIndex() + <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> rf.log[args.PrevLogIndex].Term != args.PrevLogTerm &#123;</span><br><span class="line">term := rf.log[args.PrevLogIndex].Term</span><br><span class="line"><span class="keyword">if</span> args.PrevLogTerm != term &#123;</span><br><span class="line"><span class="keyword">for</span> i := args.PrevLogIndex - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line"><span class="keyword">if</span> rf.log[i].Term != term &#123;</span><br><span class="line">reply.NextIndex = i + <span class="number">1</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reply.Success = <span class="literal">true</span></span><br><span class="line">reply.NextIndex = rf.getLastLogIndex() + <span class="number">1</span></span><br><span class="line"><span class="comment">// åˆ é™¤å·²å­˜åœ¨æ—¥å¿—</span></span><br><span class="line">rf.log = rf.log[:args.PrevLogIndex+<span class="number">1</span>]</span><br><span class="line"><span class="comment">// é™„åŠ æ–°æ—¥å¿—</span></span><br><span class="line">rf.log = <span class="built_in">append</span>(rf.log, args.Entries...)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.LeaderCommit &gt; rf.commitIndex &#123;</span><br><span class="line">rf.commitIndex = Min(args.LeaderCommit, rf.getLastLogIndex())</span><br><span class="line">rf.commitCh &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç†ä¸»è¦æ˜¯<code>NextIndex</code>å»ºè®®å€¼çš„è®¡ç®—ã€‚</p><h2 id="å°†æäº¤çš„æ—¥å¿—åº”ç”¨è‡³çŠ¶æ€æœº">2.7. å°†æäº¤çš„æ—¥å¿—åº”ç”¨è‡³çŠ¶æ€æœº</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">applyMsg</span><span class="params">(applyCh <span class="keyword">chan</span> ApplyMsg)</span></span> &#123;</span><br><span class="line">rf.Lock()</span><br><span class="line"><span class="keyword">defer</span> rf.Unlock()</span><br><span class="line"><span class="keyword">for</span> i := rf.lastApplied + <span class="number">1</span>; i &lt;= rf.commitIndex; i++ &#123;</span><br><span class="line">msg := ApplyMsg&#123;</span><br><span class="line"><span class="literal">true</span>,</span><br><span class="line">rf.log[i].Command,</span><br><span class="line">i,</span><br><span class="line">&#125;</span><br><span class="line">applyCh &lt;- msg</span><br><span class="line">rf.lastApplied = i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨è¿‡ç¨‹å…¶å®æ˜¯ç”±testå»ç®¡ç†çš„ï¼Œæˆ‘ä»¬åªè¦è´Ÿè´£æŠŠéœ€è¦åº”ç”¨çš„æ—¥å¿—æ”¾å…¥<code>chan ApplyMsg</code>ã€‚</p><h2 id="æŒä¹…åŒ–">2.8. æŒä¹…åŒ–</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">persist</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// Your code here (2C).</span></span><br><span class="line"><span class="comment">// Example:</span></span><br><span class="line">w := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">e := gob.NewEncoder(w)</span><br><span class="line">e.Encode(rf.currentTerm)</span><br><span class="line">e.Encode(rf.votedFor)</span><br><span class="line">e.Encode(rf.log)</span><br><span class="line">data := w.Bytes()</span><br><span class="line">rf.persister.SaveRaftState(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span> <span class="title">readPersist</span><span class="params">(data []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> data == <span class="literal">nil</span> || <span class="built_in">len</span>(data) &lt; <span class="number">1</span> &#123; <span class="comment">// bootstrap without any state?</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">r := bytes.NewBuffer(data)</span><br><span class="line">d := gob.NewDecoder(r)</span><br><span class="line">d.Decode(&amp;rf.currentTerm)</span><br><span class="line">d.Decode(&amp;rf.votedFor)</span><br><span class="line">d.Decode(&amp;rf.log)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªæŒä¹…åŒ–å‡½æ•°ï¼ŒæŒä¹…åŒ–äº†<code>currentTerm</code>å½“å‰term,<code>votedFor</code>å¾—ç¥¨è€…,<code>log</code>æ—¥å¿—æ•°ç»„ï¼Œå½“è¿™ä¸‰ä¸ªå±æ€§å˜åŒ–æ—¶ï¼Œéƒ½æ‰§è¡Œä¸€æ¬¡<code>rf.persist()</code>å°±æ²¡é”™å•¦ã€‚</p><h1 id="åè®°">3. åè®°</h1><p>è¡¨é¢æ˜¯åœ¨è´´ä»£ç ï¼Œå®é™…å°±æ˜¯åœ¨è´´ä»£ç ã€‚</p><p>ç”±äºå®éªŒæ˜¯å¹¶å‘è¿‡ç¨‹ï¼Œä¸€æ—¦<code>test failed</code>æ˜¯ä¸å®¹æ˜“æŒ‰çº¿æ€§çš„è¿‡ç¨‹æ¥åˆ†æçš„ã€‚æˆ‘çš„æ–¹æ³•æ˜¯å¤šæ‰“æ—¥å¿—ï¼Œä»¥åŠåˆ©ç”¨<code>net/http/pprof</code>åŒ…å¯¹ç¨‹åºçš„goroutineã€mutexçŠ¶æ€è¿›è¡Œåˆ†æã€‚</p><p>å®ç°å®Œä»¥åæˆ‘æ„Ÿè§‰åˆå˜å¼ºäº†ï¼ˆå¹¶æ²¡æœ‰ï¼‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;Raftä½œä¸ºä¸€ä¸ªç®€å•çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œå®ç°ä¸€ä¸‹è¿˜æ˜¯æŒºå¥½ç©çš„ã€‚ä»£ç åŸºäº&lt;strong&gt;6.824&lt;/strong&gt; &lt;a href=&quot;http://nil.csail.mit.edu/6.824/2018/labs/lab-raft.h
      
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="https://htchz.cc/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="raft" scheme="https://htchz.cc/tags/raft/"/>
    
  </entry>
  
  <entry>
    <title>[k8s]k8séƒ¨ç½²è¸©å‘</title>
    <link href="https://htchz.cc/2102019255.html"/>
    <id>https://htchz.cc/2102019255.html</id>
    <published>2019-08-25T06:06:02.000Z</published>
    <updated>2020-02-26T16:06:20.434Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>è‡ªå·±æ­ä¸ªk8sé›†ç¾¤ï¼Œè¸©äº†ä¸€äº›å‘</p><h1 id="é•œåƒ">2. é•œåƒ</h1><p><code>kubeadm init</code>å‘½ä»¤ä¼šå»<code>k8s.gcr.io</code>æ‹‰é•œåƒï¼Œè¿™ä¸ªåœ°å€æ˜¯å¾—æŒ‚ä»£ç†æ‰èƒ½ä¸Šçš„ï¼ˆå¯ä»¥æŒ‡å®šåœ°å€å¿½ç•¥ä»£ç†ï¼‰ï¼Œå¯ä»¥ç”¨<code>kubeadm config images pull</code>å°è¯•ä¸€ä¸‹ï¼Œåæœ‰å…«ä¹æ˜¯ä¸è¡Œã€‚ä¸æƒ³æŒ‚ä»£ç†çš„è¯ï¼Œç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•ã€‚</p><p>å…ˆæ‰§è¡Œ<code>kubeadm config images list</code>åˆ—å‡ºé•œåƒï¼Œè¾“å‡ºä¿¡æ¯ä¸­æœ‰ä¸¤è¡Œ<code>WARN</code>æ˜¯è·å–ç‰ˆæœ¬timeoutå¯ä»¥ä¸ç†ä¼šã€‚</p><p>æ¥ç€æŠŠåˆ—å‡ºæ¥çš„ä¿¡æ¯æ”¾åˆ°ä¸‹é¢çš„bashè„šæœ¬ä¸­ï¼Œè¿è¡Œè„šæœ¬å°±æŠŠé•œåƒä¸‹è½½å¥½å•¦(å…¶å®å°±æ˜¯ä»é˜¿é‡Œäº‘ä¸‹é•œåƒæ”¹tag)ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">images=(  <span class="comment"># ä¸‹é¢çš„é•œåƒåº”è¯¥å»é™¤"k8s.gcr.io"çš„å‰ç¼€ï¼Œç‰ˆæœ¬æ¢æˆä¸Šé¢è·å–åˆ°çš„ç‰ˆæœ¬</span></span><br><span class="line">kube-apiserver:v1.15.3</span><br><span class="line">kube-controller-manager:v1.15.3</span><br><span class="line">kube-scheduler:v1.15.3</span><br><span class="line">kube-proxy:v1.15.3</span><br><span class="line">pause:3.1</span><br><span class="line">etcd:3.3.10</span><br><span class="line">coredns:1.3.1</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line">    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h1 id="tokenå’Œca-cert-hash">3. tokenå’Œca-cert-hash</h1><p>åœ¨masterè¿›è¡Œ<code>kubeadm init</code>åä¼šè¾“å‡º<code>token</code>å’Œ<code>ca-cert-hash</code>ï¼Œè¿™ä¸ªè¦è®°ä½ï¼Œå¦‚æœå¿˜è®°äº†è™½ç„¶å¯ä»¥æ‰§è¡Œ<code>kubeadm token list</code>è·å–<code>token</code>ï¼Œä½†æ˜¯<code>ca-cert-hash</code>æ˜¯ä¸ä¼šè¾“å‡ºçš„ï¼Œå¿˜è®°<code>ca-cert-hash</code>åªèƒ½é‡æ–°æ‰§è¡Œ<code>kubeadm token create</code>ä»è¾“å‡ºä¸­æ‹¿åˆ°ã€‚</p><h1 id="ipè½¬å‘">4. ipè½¬å‘</h1><p>åœ¨nodeä¸»æœºæ‰§è¡Œ<code>kubeadm join</code>çš„æ—¶å€™ï¼ŒæŠ¥</p><pre><code>[ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1`</code></pre><p>æ„æ€æ˜¯æ²¡æœ‰å¼€å¯ipv4è½¬å‘ï¼Œè®¾ç½®ä¸€ä¸‹å°±å¥½äº†ï¼š<code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</code></p><h1 id="æ—¶é—´åŒæ­¥">5. æ—¶é—´åŒæ­¥</h1><p>åœ¨nodeä¸»æœºæ‰§è¡Œ<code>kubeadm join</code>çš„æ—¶å€™ï¼Œä¸€ç›´å¡ä½ï¼ŒåŠ ä¸Š<code>--v=2</code>å¯ä»¥è¾“å‡ºè¯¦ç»†ä¿¡æ¯ï¼Œè¾“å‡ºäº†ä¸€ä¸ªä¿¡æ¯</p><pre><code>I0824 21:58:46.950161   16866 token.go:146] [discovery] Failed to request cluster info, will try again: [Get https://192.168.0.113:6443/api/v1/namespaces/kube-public/configmaps/cluster-info: x509: certificate has expired or is not yet valid]`</code></pre><p>ä½†æ˜¯æˆ‘çš„è¯ä¹¦æ²¡è¿‡æœŸå‘€ï¼Œåœ¨ä¸€ä¸ªissueé‡Œä¸€ä½è€å“¥è¯´æ˜¯ä¸æ˜¯å‡ å°æœºå™¨æ—¶é—´æ²¡åŒæ­¥ï¼Œæˆ‘åœ¨nodeä¸»æœºä¸Šæ‰§è¡Œ<code>date</code>ï¼Œæœç„¶æ—¶é—´å’Œmasterå·®äº†å¥½ä¹…ï¼Œç”¨äºæ˜¯ntpå‘½ä»¤åŒæ­¥äº†ä¸€ä¸‹æ—¶é—´ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ntpdate</span><br><span class="line">ntpdate cn.pool.ntp.org</span><br></pre></td></tr></table></figure><h1 id="hostname">6. hostname</h1><p>åœ¨nodeä¸»æœºæ‰§è¡Œ<code>kubeadm join</code>çš„æ—¶å€™ï¼Œè¦ç”¨<code>--node-name</code>æŒ‡å®šèŠ‚ç‚¹åå­—ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œä¼šç”¨hostnameï¼Œå¦‚æœä½ å’Œæˆ‘ä¸€æ ·ä¸»æœºæ˜¯ç”¨vmwareå…‹éš†å‡ºæ¥çš„ï¼Œå‡ å°æœºå™¨çš„hostnameéƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°±ä¼šæ‰§è¡Œ<code>kubeadm join</code>æˆåŠŸï¼Œ<code>kubectl get nodes</code>åªæœ‰ä¸€å°master(ä¸‰å°æœºhostnameéƒ½æ˜¯master)ï¼Œ<code>kubectl get pods --namespace kube-system</code>çš„podä¹Ÿéƒ½åªæœ‰ä¸€ä»½ã€‚</p><h1 id="ç½‘æ¡¥åœ°å€é‡å¤">7. ç½‘æ¡¥åœ°å€é‡å¤</h1><p><code>failed to set bridge addr: &quot;cni0&quot; already has an IP address different from 10.244.1.1/24</code>ï¼Œæ‰§è¡Œ<code>ip link delete cin0</code>åˆ é™¤<strong>cni0</strong>ç½‘æ¡¥ã€‚</p><h1 id="dashboard-404é”™è¯¯">8. dashboard 404é”™è¯¯</h1><p>è¾“å…¥tokenåæ˜¾ç¤ºçš„æ˜¯404ï¼Œæ‰§è¡Œ<code>kubectl logs</code>å‘ç°æ‰¾ä¸åˆ°æŸäº›<code>Resource</code>ï¼ŒæŸ¥çœ‹iusseï¼Œdashboard v1.Xå’Œæ–°ç‰ˆçš„k8sä¸å…¼å®¹ï¼Œå‡åˆ°v2.xå°±å¥½äº†ã€‚ä¸è¿‡v2.xè¿˜æ²¡æœ‰æ­£å¼ç‰ˆã€‚</p><p># </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;è‡ªå·±æ­ä¸ªk8sé›†ç¾¤ï¼Œè¸©äº†ä¸€äº›å‘&lt;/p&gt;
&lt;h1 id=&quot;é•œåƒ&quot;&gt;2. é•œåƒ&lt;/h1&gt;&lt;p&gt;&lt;code&gt;kubeadm init&lt;/code&gt;å‘½ä»¤ä¼šå»&lt;code&gt;k8s.gcr.io&lt;/code&gt;æ‹‰é•œåƒï¼Œè¿™ä¸ªåœ°å€æ˜¯å¾—æŒ‚ä»£ç†æ‰èƒ½ä¸Šçš„ï¼ˆ
      
    
    </summary>
    
      <category term="å®¹å™¨" scheme="https://htchz.cc/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="k8s" scheme="https://htchz.cc/tags/k8s/"/>
    
      <category term="deploy" scheme="https://htchz.cc/tags/deploy/"/>
    
  </entry>
  
  <entry>
    <title>[ç½‘ç»œ]åœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªurlåˆ°é¡µé¢å±•ç°å‘ç”Ÿäº†ä»€ä¹ˆ</title>
    <link href="https://htchz.cc/334107480.html"/>
    <id>https://htchz.cc/334107480.html</id>
    <published>2019-08-20T17:01:46.000Z</published>
    <updated>2019-12-03T01:04:31.762Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>è¢«é—®èµ·çš„æ—¶å€™æ€»æ˜¯ä¸¤ä¸‰å¥è¯å°±ç»“æŸäº†ã€‚è¿™ä¸€æ¬¡æƒ³å¥½å¥½æ€»ç»“ï¼Œæè¿°æˆ‘æ‰€çŸ¥é“çš„æµç¨‹ã€‚</p><h1 id="è¿‡ç¨‹">2. è¿‡ç¨‹</h1><h2 id="DNS">2.1. DNS</h2><p>å‘DNSå‘èµ·è¯·æ±‚ï¼Œé€šå¸¸æ˜¯udpåè®®ï¼Œè·å¾—åŸŸåå¯¹åº”çš„ipåœ°å€ã€‚</p><p>æŸ¥æ‰¾é¡ºåºæ˜¯ï¼šæµè§ˆå™¨ç¼“å­˜ -&gt; æ“ä½œç³»ç»Ÿç¼“å­˜ -&gt; è·¯ç”±å™¨ç¼“å­˜ -&gt; ISPçš„DNSç¼“å­˜ -&gt; æ ¹æœåŠ¡å™¨</p><h2 id="ARP">2.2. ARP</h2><p>å¦‚æœä¸æ˜¯åŒä¸€ç½‘ç»œçš„åœ°å€ï¼ŒæŒ‰ç…§è·¯ç”±è¡¨æ‰¾ä¸‹ä¸€è·³çš„ipï¼Œé€šè¿‡å¹¿æ’­ARPè¯·æ±‚è·å¾—ä¸‹ä¸€è·³macåœ°å€ï¼Œå°†æŠ¥æ–‡å‘å¾€æ­¤åœ°å€ã€‚</p><p>ç›®æ ‡ç½‘ç»œçš„ç½‘å…³æ¥æ”¶åˆ°æ­¤æŠ¥æ–‡åï¼ŒåŒæ ·å‘èµ·ARPå¹¿æ’­è¯·æ±‚ï¼Œå¯»æ‰¾ç›®æ ‡ipå¯¹åº”çš„macåœ°å€ï¼Œå°†æŠ¥æ–‡å‘å¾€æ­¤åœ°å€ã€‚</p><h2 id="TCPä¸‰æ¬¡æ¡æ‰‹">2.3. TCPä¸‰æ¬¡æ¡æ‰‹</h2><p>å‘é€ç«¯éšæœºé€‰æ‹©ä¸€ä¸ªç«¯å£å’Œæ¥æ”¶ç«¯ç«¯å£ä¹‹é—´å‘èµ·ä¸‰æ¬¡æ¡æ‰‹ï¼Œä¹‹åå»ºç«‹èµ·TCPè¿æ¥ã€‚</p><blockquote><p>Linuxæ‰§è¡Œ<code>sysctl -a|grep ip_local_port_range</code>å¯ä»¥çœ‹åˆ°éšæœºç«¯å£é€‰æ‹©èŒƒå›´</p></blockquote><h2 id="MSSåå•†ä¸TCPåˆ†æ®µ">2.4. MSSåå•†ä¸TCPåˆ†æ®µ</h2><p>MSSï¼ŒMaximum Segment Sizeï¼ŒTCPæŠ¥æ–‡æ•°æ®ä¸èƒ½å¤§äºè¿™ä¸ªå€¼ï¼ŒMSS = MTU - IPé¦–éƒ¨é•¿åº¦ï¼Œ20 - TCPé¦–éƒ¨é•¿åº¦ï¼Œ20</p><p>ä¸ºäº†å¾—å‡ºè·¯å¾„æœ€å°MSSï¼ŒTCPä¸€ç«¯è®¾ç½®IPæŠ¥æ–‡DFæ ‡å¿—ï¼ˆDonâ€™t Fragment flagï¼‰å‘Šè¯‰IPå±‚ä¸è¦åˆ†ç‰‡ï¼Œè¿™æ ·IPå¿…é¡»åˆ†ç‰‡çš„æ—¶å€™ï¼Œå°±ä¼šä¼ å›ä¸€ä¸ªICMPå·®é”™æŠ¥æ–‡ã€‚</p><p>é«˜çº§çš„ICMPå·®é”™æŠ¥æ–‡ä¼šè¿”å›å‘ç”Ÿå·®é”™çš„MTUå¤§å°ï¼Œå¦‚æœICMPå·®é”™æŠ¥æ–‡æ²¡æœ‰å¸¦å›MTUå¤§å°ï¼Œéœ€è¦å‘é€ç«¯ä¸æ–­å‡å°‘MSSå¹¶é‡å‘æŠ¥æ–‡ï¼Œå¾—å‡ºåˆé€‚çš„MSSã€‚æ³¨æ„ï¼Œä¸€æ®µæ—¶é—´åTCPä¼šé‡æ–°åå•†è·¯å¾„æœ€å°MSSï¼Œè°ƒæ•´è·¯å¾„æœ€å°MSSã€‚</p><p>å°†ä¸€ä¸ªæ•°æ®åˆ†ç»„æ ¹æ®MSSæ‹†æˆå¤šä¸ªTCPæŠ¥æ–‡ï¼Œè¿™å°±æ˜¯<strong>TCPåˆ†æ®µ</strong>ã€‚</p><h2 id="HTTP">2.5. HTTP</h2><p>å»ºç«‹èµ·è¿æ¥ä¹‹åï¼Œå‘é€HTTPæŠ¥æ–‡ã€‚HTTPç”±<strong>è¯·æ±‚è¡Œ</strong>ã€<strong>è¯·æ±‚å¤´</strong>ã€<strong>è¯·æ±‚ä¸»ä½“</strong>ç»„æˆã€‚</p><ul><li>è¯·æ±‚è¡Œåªæœ‰ä¸€è¡Œï¼Œç”±<strong>æ–¹æ³•</strong>ï¼Œ<strong>path</strong>ï¼Œ<strong>åè®®ç‰ˆæœ¬</strong>ï¼Œä»¥ä¸€ä¸ª<code>\r\n</code>ç»“æŸã€‚</li><li>è¯·æ±‚å¤´ç”±å¤šå¯¹<code>key-value</code>ç»„ç»‡è€Œæˆï¼Œä»¥ä¸€ä¸ª<code>\r\n</code>æ¢è¡Œï¼Œä»¥ä¸¤ä¸ª<code>\r\n</code>ç»“æŸã€‚</li><li>è¯·æ±‚ä¸»ä½“ï¼ŒåŒ…å«è¯·æ±‚çš„æ•°æ®/å“åº”æ•°æ®ã€‚</li></ul><p>http1.1ç‰ˆæœ¬åŠ å…¥äº†<code>Connection:Keep-Alive</code>,ä½¿å¾—ä¸€ä¸ªTCPè¿æ¥å¯ä»¥å¤ç”¨å¤šæ¬¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè¯·æ±‚å»ºç«‹èµ·ä¸€æ¬¡è¿æ¥ã€‚<br>http2ç‰ˆæœ¬åŠ å…¥TCPå¤šè·¯å¤ç”¨ã€‚è™½ç„¶http1.1ç‰ˆæœ¬å¯ä»¥å¤ç”¨TCPè¿æ¥ï¼Œä½†æ˜¯ä¸€æ¬¡åªèƒ½å‘ä¸€ä¸ªHTTPè¯·æ±‚æŠ¥æ–‡ï¼Œæƒ³è¦å¹¶è¡Œå‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œè¿½èƒ½å¤šå»ºç«‹TCPè¿æ¥ï¼Œè€Œæµè§ˆå™¨ä¸€èˆ¬ä¼šé™åˆ¶å¹¶å‘6ï½8ä¸ªè¿æ¥ï¼Œå…¶ä½™è¯·æ±‚åªèƒ½æ’é˜Ÿã€‚åŠ å…¥TCPå¤šè·¯å¤ç”¨ä¹‹åï¼Œå‡å°‘äº†è¿æ¥ï¼›æ­¤å¤–http2é‡‡ç”¨äº†äºŒè¿›åˆ¶ä¼ è¾“ï¼Œå¤´éƒ¨å‹ç¼©å¤§å¹…æé«˜äº†æ€§èƒ½ã€‚è™½ç„¶äºŒè¿›åˆ¶ä¼ è¾“åœ¨è°ƒè¯•è¿‡ç¨‹ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯è°ƒè¯•å·¥å…·éƒ½ä¼šå¸®æˆ‘ä»¬è½¬æˆæ˜æ–‡æ ¼å¼å±•ç¤ºã€‚</p><blockquote><p>æ›´å¤šä¿¡æ¯http2å¯å‚è§<a href="https://juejin.im/post/5c4e6d11e51d4534dc477f05" target="_blank" rel="noopener">å†è°ˆHTTP2æ€§èƒ½æå‡ä¹‹èƒŒååŸç†â€”HTTP2å†å²è§£å‰–</a>ã€‚æœ¬ç«™ä¹Ÿæœ‰å¯ç”¨http2ã€‚</p></blockquote><h2 id="HTTPS">2.6. HTTPS</h2><p>å¦‚æœå¯ç”¨ç”¨HTTPSï¼Œå®¢æˆ·ç«¯ä¼šæ ¡éªŒæœåŠ¡ç«¯çš„è¯ä¹¦ï¼Œæ ¹æ®è¯ä¹¦å’ŒæœåŠ¡å™¨åå•†ä¸€ä¸ªå¯¹ç§°åŠ å¯†ç®—æ³•å’Œä¸€ä¸ªå¯†é’¥ï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯RSAéå †æˆåŠ å¯†ï¼Œä¹‹åå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¼šä½¿ç”¨è¿™ä¸ªç®—æ³•å’Œå¯†é’¥è¿›è¡Œæ•°æ®åŠ å¯†ä¼ è¾“ã€‚HTTPSçš„åŸç†å‡ºé—¨å·¦è½¬<a href="https://zhuanlan.zhihu.com/p/26684050" target="_blank" rel="noopener">TLSå®Œå…¨æŒ‡å—ï¼ˆä¸€ï¼‰ï¼šTLSå’Œå®‰å…¨é€šä¿¡</a>ï¼Œè¿™æ–‡ç« è®²äº†HTTPSçš„éƒ¨åˆ†å†…å®¹ï¼Œä¸»è¦å†…å®¹æ˜¯è¯ä¹¦æ–¹é¢çš„å†…å®¹ï¼›è¿˜æœ‰ä¸€éƒ¨åˆ†å†…å®¹çœ‹<a href="http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html" target="_blank" rel="noopener">å›¾è§£SSL/TLSåè®®</a>ï¼Œä¸»è¦è¡¥å……äº†ç”¨DHç®—æ³•ä»£æ›¿RSAè¿›è¡Œå¯†é’¥äº¤æ¢ï¼Œé¿å…äº†å¯†é’¥åœ¨ç½‘ç»œä¸­ä¼ è¾“ã€‚</p><h2 id="TCPæ‹¥å¡æ§åˆ¶">2.7. TCPæ‹¥å¡æ§åˆ¶</h2><p>TCPéœ€è¦æ‹¥å¡æ§åˆ¶é€»è¾‘ä½¿ç”¨ç½‘ç»œä¸å¥½çš„æƒ…å†µï¼Œè¯¦è§<a href="./3284953854.html">TCPæ‹¥å¡æ§åˆ¶é‚£äº›äº‹</a>ã€‚</p><h2 id="åº”ç”¨">2.8. åº”ç”¨</h2><p>å…³äºåº”ç”¨å±‚é¢çš„å°±ä¸è¯´äº†ã€‚</p><h2 id="TCPå››æ¬¡æŒ¥æ‰‹">2.9. TCPå››æ¬¡æŒ¥æ‰‹</h2><p>å‘é€ç«¯å’Œæ¥æ”¶ç«¯ä¹‹é—´è¿›è¡Œå››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥ï¼Œæ¥ç€ä¸»åŠ¨æ–­å¼€çš„ç«¯å£è¿›å…¥<code>FIN_WAIT_1</code>ï¼Œæ”¶åˆ°<strong>ACKæŠ¥æ–‡</strong>åè¿›å…¥<code>FIN_WAIT_2</code>,æ”¶åˆ°æ¥æ”¶ç«¯çš„<strong>FINæŠ¥æ–‡</strong>åæœ€ç»ˆä¼šè¿›å…¥<code>TIME_WAIT</code>çŠ¶æ€ï¼Œ é»˜è®¤ä¿æŒ<code>2MSL</code>çš„ä¸å¯ç”¨æ—¶é—´ï¼Œé˜²æ­¢<strong>ç›¸åŒäº”å…ƒç»„</strong>çš„è¿æ¥å»ºç«‹åï¼Œæ”¶åˆ°ä¸Šä¸€ä»£è¿æ¥çš„é‡å¤æŠ¥æ–‡ï¼Œè€Œäº§ç”Ÿæ··ä¹±ã€‚è¢«åŠ¨æ–­å¼€çš„ç«¯å£å…ˆè¿›å…¥<code>CLOSE_WAIT</code>ï¼Œç”±æœåŠ¡å™¨æ‰§è¡Œæ–­å¼€åå‘é€<strong>FINæŠ¥æ–‡</strong>è¿›å…¥<code>LAST_ACK</code>çŠ¶æ€ï¼Œæ”¶åˆ°å®¢æˆ·ç«¯<strong>ACKæŠ¥æ–‡</strong>è¿›å…¥<code>CLOSED</code>çŠ¶æ€ã€‚</p><h1 id="åè®°">3. åè®°</h1><p>è¿™ä¸ªé—®é¢˜èƒ½åæ˜ å‡ºå¯¹è®¡ç®—æœºçš„ç½‘ç»œçš„äº†è§£ï¼Œå…¶å®ç®—æ˜¯ä¸€ä¸ªèƒ½æ‰¯å¾ˆä¹…çš„é—®é¢˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;è¢«é—®èµ·çš„æ—¶å€™æ€»æ˜¯ä¸¤ä¸‰å¥è¯å°±ç»“æŸäº†ã€‚è¿™ä¸€æ¬¡æƒ³å¥½å¥½æ€»ç»“ï¼Œæè¿°æˆ‘æ‰€çŸ¥é“çš„æµç¨‹ã€‚&lt;/p&gt;
&lt;h1 id=&quot;è¿‡ç¨‹&quot;&gt;2. è¿‡ç¨‹&lt;/h1&gt;&lt;h2 id=&quot;DNS&quot;&gt;2.1. DNS&lt;/h2&gt;&lt;p&gt;å‘DNSå‘èµ·è¯·æ±‚ï¼Œé€šå¸¸æ˜¯udpåè®®ï¼Œè·å¾—åŸŸåå¯¹
      
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="https://htchz.cc/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="TCP" scheme="https://htchz.cc/tags/TCP/"/>
    
      <category term="HTTP" scheme="https://htchz.cc/tags/HTTP/"/>
    
  </entry>
  
  <entry>
    <title>[åˆ†å¸ƒå¼]Raftå’ŒZABçš„å¼‚åŒ</title>
    <link href="https://htchz.cc/3841980432.html"/>
    <id>https://htchz.cc/3841980432.html</id>
    <published>2019-08-18T11:28:38.000Z</published>
    <updated>2019-10-03T08:30:45.983Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>ä¸ºäº†å­¦ä¹ <code>etcd</code>,å…ˆå­¦ä¹ äº†è§£ä¸€ä¸‹Raftåè®®ï¼Œæƒ³æ€»ç»“ä¸€ä¸‹Raftå’Œzookeeperçš„ZABåè®®åè®®çš„å¼‚åŒã€‚</p><p>ZABæ˜¯å¯¹PAXOSç®—æ³•çš„æ”¹è¿›ï¼ˆæ²¡çœ‹è¿‡PASXOSï¼Œå¥½åƒæ²¡æœ‰leaderæ¦‚å¿µï¼Œæˆ‘ç›´æ¥çœ‹çš„ZABï¼‰ï¼Œå¢åŠ äº†leaderã€followerã€learnerçš„è§’è‰²ã€‚</p><p>Raftè‡ªç§°æ˜¯æ¯”PAXOSæ›´å®¹æ˜“ç†è§£çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œå’ŒZABä¸€æ ·æœ‰leaderã€followerï¼Œè€Œä¸”ä¸€ä¸ªå¼ºleaderçš„ç®—æ³•ã€‚</p><h1 id="æ—¶é—´">2. æ—¶é—´</h1><p>Raftï¼šä½¿ç”¨ä»»æœŸ<code>term</code>è¡¨ç¤ºä¸€ä¸ªé€‰ä¸¾è½®æ¬¡ã€‚  </p><p>ZABï¼šä½¿ç”¨<code>electionEpoch</code>è¡¨ç¤ºä¸€ä¸ªé€‰ä¸¾è½®æ¬¡ã€‚</p><h1 id="é€‰ä¸¾">3. é€‰ä¸¾</h1><h2 id="æŠ•ç¥¨">3.1. æŠ•ç¥¨</h2><p>Raftï¼šå¿½ç•¥ä¸Šä¸€è½®æŠ•ç¥¨ã€‚é€‰ä¸¾è¿‡ç¨‹åªèƒ½è¿›è¡Œä¸€æ¬¡æŠ•ç¥¨ï¼Œå¦‚æœæŠ•è¿‡ç¥¨äº†ï¼Œæ”¶åˆ°æŠ•ç¥¨è¯·æ±‚å°±ä¼šæ— è§†ã€‚è¿™æ ·è¶Šæ—©å‘èµ·æŠ•ç¥¨çš„äººè¶Šæœ‰å¯èƒ½å½“leaderï¼›åŒæ—¶ï¼Œä¹Ÿå¯èƒ½å‡ºç°æ¯ä¸ªèŠ‚ç‚¹éƒ½æ²¡æœ‰æ”¶åˆ°majorityçš„æŠ•ç¥¨ï¼Œå‡ºç°æŠ•ç¥¨è¢«ç“œåˆ†çš„æƒ…å†µã€‚Rafté‡‡ç”¨è®¾ç½®éšæœºçš„<strong>é€‰ä¸¾è¶…æ—¶æ—¶é—´</strong>æ¥è§£å†³æŠ•ç¥¨è¢«ç“œåˆ†ã€‚  </p><p>ZABï¼šå¿½ç•¥ä¸Šä¸€è½®æŠ•ç¥¨ã€‚æ¯æ¬¡æ”¶åˆ°æŠ•ç¥¨è¯·æ±‚éƒ½ä¼šè¿›è¡Œåˆ¤å®šï¼Œç„¶åè‹¥è‡ªå·±çš„æŠ•ç¥¨æœ‰å˜ï¼Œä¼šé‡æ–°é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹ã€‚è¿™æ ·ä¸ä¼šå‡ºç°æŠ•ç¥¨è¢«ç“œåˆ†ï¼Œä½†æ˜¯æ—¶é—´ä¼šæ¯”Raftå¤šå¾ˆå¤šï¼Œå¯¼è‡´<strong>æœåŠ¡å¯ç”¨æ€§é™ä½</strong>ã€‚</p><h2 id="æŠ•ç¥¨pk">3.2. æŠ•ç¥¨pk</h2><p>Raftï¼štermå¤§çš„èƒœå‡ºï¼Œç›¸åŒæ—¶<code>index</code>å¤§çš„èƒœå‡º</p><p>ZABï¼š<code>electionEpoch</code>å¤§çš„èƒœå‡ºï¼Œç›¸åŒæ—¶<code>zxid</code>å¤§çš„èƒœå‡º</p><h2 id="æŠ•ç¥¨ç»“æœ">3.3. æŠ•ç¥¨ç»“æœ</h2><p>Raftï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½åªæœ‰è‡ªå·±çš„æŠ•ç¥¨ç»“æœï¼Œå¦‚æœå‘ç°è‡ªå·±æŠ•ç¥¨è¿‡åŠï¼Œè¦é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶å‘é€å¿ƒè·³ï¼Œ<strong>å¿ƒè·³é—´éš”</strong> &lt; <strong>é€‰ä¸¾è¶…æ—¶æ—¶é—´</strong>.  </p><p>ZABï¼šæ¯ä¸ªèŠ‚ç‚¹ä¿å­˜æ‰€æœ‰èŠ‚ç‚¹çš„ç¥¨æ ¹ä¿¡æ¯ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ”¶åˆ°æŠ•ç¥¨è¯·æ±‚åéƒ½ä¼šæ£€æŸ¥æ˜¯å¦æœ‰è¿‡åŠçš„ç¥¨æ ¹ï¼Œå¦‚æœæœ‰ï¼Œä¼šå’Œleaderå»ºç«‹èµ·ä¸€ä¸ªè¿æ¥ï¼Œleaderä¼šå‘é€å¿ƒè·³ã€‚</p><h2 id="é€‰ä¸¾ç»“æŸ">3.4. é€‰ä¸¾ç»“æŸ</h2><p>Raftï¼šé€‰ä¸¾å®Œå¯ä»¥ç«‹åˆ»æä¾›æœåŠ¡ï¼Œå¯¹äºèŠ‚ç‚¹ä¸ä¸€è‡´çš„é—®é¢˜ï¼ŒRafté æ¥ä¸‹æ¥é™„åŠ æ¡ç›®RPCæ¥é€æ¸ä¿®å¤ã€‚æŒ‰è®ºæ–‡è¯´çš„5å°èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œé‡æ–°é€‰ä¸¾å®Œæˆçš„æ—¶é—´å¹³å‡æ˜¯35msï¼Œæœ€é•¿æ˜¯150msï¼ˆé€‰ä¸¾è¶…æ—¶æ—¶é—´é…ç½®ä¸º12-24msï¼‰ã€‚  </p><p>ZABï¼šé€‰ä¸¾å®Œå¾—å®Œæˆ<strong>æ—¥å¿—åŒæ­¥</strong>æ‰èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œè€Œä¸”ZABçš„é€‰ä¸¾å¯èƒ½é•¿è¾¾ç§’çº§çš„æ—¶é—´ï¼Œå¯¼è‡´<strong>æœåŠ¡å¯ç”¨æ€§é™ä½</strong>ã€‚</p><h1 id="åˆ†åŒºå®¹é”™æ€§">4. åˆ†åŒºå®¹é”™æ€§</h1><p>å½“ å¯ç”¨èŠ‚ç‚¹ &gt; N/2ï¼ŒRaftå’ŒZABçš„é›†ç¾¤éƒ½æ˜¯å¯ç”¨çš„ã€‚</p><h1 id="å®¢æˆ·ç«¯è¯·æ±‚">5. å®¢æˆ·ç«¯è¯·æ±‚</h1><h2 id="è¯»ï¼ˆé’ˆå¯¹è¯»è¯·æ±‚è½åˆ°followerçš„æƒ…å†µï¼‰">5.1. è¯»ï¼ˆé’ˆå¯¹è¯»è¯·æ±‚è½åˆ°followerçš„æƒ…å†µï¼‰</h2><p>Raftï¼šRaftçš„è¯»å…¶å®æœ‰å‡ ä¸ªæ–¹æ¡ˆ</p><ol><li><strong>å¼ºä¸€è‡´è¯»</strong>ï¼šè½¬å‘ç»™leaderï¼›leaderæ’å…¥ä¸€ä¸ªç©ºæ—¥å¿—è·å¾—readIndexï¼›å¿ƒè·³å¹¿æ’­(ç¡®è®¤è‡ªå·±æ˜¯leaderï¼Œæ‰èƒ½æ‹¥æœ‰æœ€æ–°æ—¥å¿—)ï¼›ç­‰å¾…çŠ¶æ€æœºapplyIndexç»è¿‡readIndexï¼ˆåŒæ­¥æœ€æ–°æ—¥å¿—æ¡ç›®ï¼‰ï¼›è¿”å›ç»™followerï¼›è¿”å›ç»™å®¢æˆ·ç«¯ï¼›</li><li><strong>åœ¨followerè¯»</strong>ï¼šä»leaderè·å¾—readIndexï¼›ç­‰å¾…applyIndexç»è¿‡readIndexï¼›æŸ¥è¯¢è‡ªèº«çŠ¶æ€æœºï¼›ï¼ˆä»leaderè·å¾—readIndexæ—¶ï¼Œleaderä¹Ÿè¦è¿›è¡Œå¿ƒè·³å¹¿æ’­ï¼‰</li><li><strong>æŠ˜ä¸­æ–¹æ¡ˆ</strong>ï¼šleaderåœ¨æ¥å—åˆ°majorityå¿ƒè·³å“åº”åä¸€æ®µæ—¶é—´å†…ä¸å¹¿æ’­ï¼Œè¿™æ˜¯è®ºæ–‡ä½œè€…ä¸æ¨èçš„ï¼Œå› ä¸ºâ€œå“åº”åä¸€æ®µæ—¶é—´å†…â€è¿™ä¸ªæ—¶é—´å¯èƒ½æ˜¯ä¸å‡†ç¡®çš„ã€‚</li></ol><p>ZABï¼šfollowerç›´æ¥è¿”å›ï¼Œå¦‚æœä¸€ä¸ªfollowerå’ŒleaderæœªåŒæ­¥å®Œæˆï¼Œfollowerè¿”å›çš„æ˜¯è„æ•°æ®ï¼Œå¦‚æœè¦ä¿è¯æ•°æ®æœ€æ–°ï¼Œéœ€è¦å®¢æˆ·ç«¯è°ƒç”¨<code>sync()</code>æ–¹æ³•åŒæ­¥æ•°æ®ï¼Œæ­£å¸¸æƒ…å†µä¸‹ZABåªä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><h2 id="å†™">5.2. å†™</h2><h3 id="ä¸»è¦æµç¨‹">5.2.1. ä¸»è¦æµç¨‹</h3><p>Raft:</p><ol><li>è½¬å‘ç»™leader;</li><li>leaderå°†è¯·æ±‚å°è£…ä¸ºentriesï¼Œå†™å…¥æ—¥å¿—ï¼Œå¾—åˆ°åœ¨æ—¥å¿—ä¸­çš„indexï¼Œè¿åŒentrieså‘é€ç»™followersï¼Œæ³¨æ„è¿™å¯ä»¥æ˜¯<strong>æ‰¹é‡</strong>çš„</li><li>followeræ‰§è¡Œ<strong>æ¥æ”¶é€»è¾‘</strong>ï¼Œå¦‚æœæˆåŠŸå†™å…¥æ–‡ä»¶ï¼Œè¿”å›true</li><li>leaderæ”¶åˆ°è¿‡åŠæˆåŠŸå›å¤å°±æ›´æ–°<code>committIndex</code>ï¼ŒæŠŠentriesåº”ç”¨åˆ°çŠ¶æ€æœºä¸­ï¼Œå›å¤å®¢æˆ·ç«¯</li><li>leaderä¸‹æ¬¡å¿ƒè·³ä¼šå¸¦ä¸Š<code>committIndex</code>çš„å€¼ç”¨<code>leaderCommit</code>è¡¨ç¤ºï¼Œfollowerså‘ç°<code>leaderCommit</code>å¤§äºè‡ªå·±ç»´æŠ¤çš„<code>committIndex</code>ï¼Œå°±ä»¤ <code>commitIndex</code> ç­‰äº <code>leaderCommit</code> å’Œ æ–°æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼ä¸­è¾ƒå°çš„ä¸€ä¸ª  </li></ol><p>ZABï¼šå…¸å‹çš„ä¸¤é˜¶æ®µæäº¤</p><ol><li>è½¬å‘ç»™leader</li><li>leaderå°è£…ä¸º<strong>ä¸€ä¸ª</strong><code>proposal</code>ï¼Œå†™å…¥æ—¥å¿—ï¼Œå‘é€ç»™followers</li><li>followeræ‰§è¡Œ<strong>æ¥æ”¶é€»è¾‘</strong>ï¼Œå¦‚æœæˆåŠŸå†™å…¥æ–‡ä»¶ï¼Œè¿”å›true</li><li>leaderæ”¶åˆ°è¿‡åŠæˆåŠŸå›å¤å°±æäº¤<code>proposal</code>ï¼ŒåŒæ—¶å¹¿æ’­ä¸€ä¸ª<code>commit</code>æ¶ˆæ¯ï¼Œé€šçŸ¥followersæäº¤æè®®</li></ol><h3 id="æ¥æ”¶é€»è¾‘">5.2.2. æ¥æ”¶é€»è¾‘</h3><p>Raftï¼šå¦‚æœ<code>prevLogIndex</code>å’Œ<code>prevLogTerm</code>ä¸åŒ¹é…ï¼Œè¿”å›falseï¼Œç”±leaderè°ƒæ•´ï¼Œä»è€Œè¾¾åˆ°åœ¨å†™è¯·æ±‚å†åŒæ­¥æ•°æ®çš„ç›®çš„  </p><p>ZABï¼šæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæ¥æ”¶åˆ°<code>proposal</code>å†™å…¥æ–‡ä»¶ï¼Œæ¥æ”¶åˆ°<code>commit</code>æäº¤æ—¥å¿—</p><h1 id="æ—§leaderæ•°æ®">6. æ—§leaderæ•°æ®</h1><p>è¿™ä¸ªæ˜¯æŒ‡æ—§leaderå´©æºƒåï¼Œæ–°leaderå¯¹æ—§æ•°æ®çš„å¤„ç†</p><p>Raftï¼šä¿å®ˆï¼Œè¿‡åŠæˆ–æœªè¿‡åŠæ—¥å¿—éƒ½æ˜¯æœªæäº¤ã€‚åªèƒ½æäº¤å½“å‰termçš„æ—¥å¿—ï¼Œå¦‚æœæäº¤äº†å½“å‰æ—¥å¿—ï¼Œé‚£ä¹ˆæ—§termçš„æ—¥å¿—ä¹Ÿä¼šè¢«ä¸€æ³¢æäº¤ï¼ˆæ—§termçš„æ—¥å¿—åªèƒ½è¢«é—´æ¥æäº¤ï¼‰ã€‚å…è®¸å‡ºç°æœªæäº¤çš„æ•°æ®è¢«è¦†ç›–ã€‚</p><p>ZABï¼šæ¿€è¿›ï¼Œè¿‡åŠæˆ–æœªè¿‡åŠæ—¥å¿—éƒ½è¢«æäº¤ï¼Œç”±zookeeperé€‰ä¸¾å®Œæˆåçš„æ•°æ®åŒæ­¥å®Œæˆã€‚</p><h1 id="leaderå‡æ­»">7. leaderå‡æ­»</h1><p>Raftï¼šleaderå’Œfolloweræ˜¯æ²¡æœ‰è¿æ¥çš„ã€‚æ—§leaderå‡æ­»åï¼Œæ–°leaderè¯ç”Ÿï¼Œæ—§leaderå¤æ´»åå‘é€å¸¦æœ‰<strong>æ—§term</strong>çš„RPCsï¼Œfolloweræ”¶åˆ°ä¹‹åè¿”å›<strong>æ–°term</strong>ç»™æ—§leaderï¼Œæ—§leaderæ›´æ–°<code>term</code>ï¼ŒåŠ å…¥followerå¤§å†›ã€‚ </p><p>ZABï¼šleaderå’Œfollowerå­˜åœ¨è¿æ¥ã€‚æ—§leaderå‡æ­»åï¼Œè¿æ¥æ–­å¼€ï¼Œæ—§leaderè¿›å…¥LOOKINGçŠ¶æ€ï¼Œä»é›†ç¾¤ä¸­å­¦ä¹ æŠ•ç¥¨ç»“æœ/é‡æ–°é€‰ä¸¾ï¼Œæœ€ç»ˆæ‰¾åˆ°leaderå»ºç«‹èµ·è¿æ¥ã€‚</p><h1 id="è¯·æ±‚å¼‚å¸¸">8. è¯·æ±‚å¼‚å¸¸</h1><p>Raftï¼šé‡è¯•ï¼ŒRaftè¦ä¿è¯RPCsæ˜¯å¹‚ç­‰çš„ã€‚</p><p>ZABï¼šfollowerå’Œleaderæ–­å¼€è¿æ¥ï¼Œé‡æ–°åŠ å…¥é›†ç¾¤</p><h1 id="æŒ‚äº†çš„æœºå™¨åŠ å…¥ä¸€ä¸ªé€‰ä¸¾å®Œæˆçš„é›†ç¾¤ï¼ˆä¸æ˜¯æ–°åŠ æœºå™¨ï¼‰">9. æŒ‚äº†çš„æœºå™¨åŠ å…¥ä¸€ä¸ªé€‰ä¸¾å®Œæˆçš„é›†ç¾¤ï¼ˆä¸æ˜¯æ–°åŠ æœºå™¨ï¼‰</h1><p>Raftï¼šleaderä¼šå¯¹followerè¿›è¡ŒRPCsé‡è¯•ï¼Œæ‰€ä»¥æ¢å¤çš„followerä¼šæ”¶åˆ°leaderçš„å¿ƒè·³è¯·æ±‚ã€‚</p><p>ZABï¼šæ¢å¤çš„followerä¼šå­¦ä¹ é›†ç¾¤ä¸­çš„æŠ•ç¥¨ç»“æœï¼Œå¯ä»¥è¯†åˆ«åˆ°leader</p><h1 id="æ—¥å¿—å¤åˆ¶çš„é¡ºåº">10. æ—¥å¿—å¤åˆ¶çš„é¡ºåº</h1><p>Raftï¼šç”±leaderç»´æŠ¤logé¡ºåºã€‚å¦‚æœfolloweré‡å¯ï¼Œä¸ä¼šé˜»å¡leaderå†™å…¥è¯·æ±‚ï¼Œä¼šæŒ‰ç…§leaderé¡ºåºè¿½èµ¶æ—¥å¿—ï¼›å¦‚æœleaderæŒ‚äº†ï¼Œæ–°leaderä¹Ÿå¯ä»¥å°†æ—§termã€æ–°termæ—¥å¿—æŒ‰é¡ºåºæäº¤ã€‚</p><p>ZABï¼šç”±leaderç»´æŠ¤logé¡ºåºã€‚å¦‚æœfolloweré‡å¯ï¼Œä¼šè·å–leaderè¯»é”ï¼Œleader<strong>é˜»å¡</strong>å†™å…¥è¯·æ±‚ï¼Œæ¥ç€è¿½èµ¶å·®å¼‚ï¼Œè·å–leaderå·²æäº¤<code>proposal</code>å’Œæœªæäº¤<code>proposal</code>ï¼Œç„¶åå†é‡Šæ”¾leaderè¯»é”ï¼›å¦‚æœleaderé‡å¯ï¼Œæ–°leaderé€‰ä¸¾åä¼šè¿›è¡Œæ•°æ®åŒæ­¥</p><h1 id="é›†ç¾¤æˆå‘˜å˜æ›´">11. é›†ç¾¤æˆå‘˜å˜æ›´</h1><p>é›†ç¾¤é…ç½®ä¸èƒ½ä¸€ä¸‹å­å…¨åˆ‡æ¢ï¼Œå¦åˆ™åŒä¸€ä¸ªæ—¶æœŸå¯èƒ½ä¼šå‡ºç°ä¸¤ä¸ªleaderã€‚<br>Raftï¼šä½¿ç”¨ä¸¤é˜¶æ®µå˜æ›´ã€‚æ—§é…ç½®ä¸º<code>C-old</code>ï¼Œæ–°é…ç½®ä¸º<code>C-new</code>ï¼Œ<code>C-old-new</code>è¡¨ç¤ºä¸­é—´é…ç½®ã€‚é…ç½®å˜æ›´å‘½ä»¤ç”±å®¢æˆ·ç«¯å‘èµ·ï¼Œleaderä»¥logä¼ æ’­<code>C-old-new</code>ï¼Œç­‰<code>C-old-new</code>æäº¤ä¹‹åï¼Œå†å¹¿æ’­<code>C-new</code>é…ç½®ï¼Œè¿™æ—¶ä¸åœ¨<code>C-new</code>é‡Œçš„æœºå™¨å°±è¦è‡ªè§‰é€€å‡ºã€‚Raftè®ºæ–‡å‚ä¸è€…åæ¥è¿˜æå‡ºä¸€ä¸ªä¸€é˜¶æ®µå˜æ›´ï¼Œæå‡ºé™åˆ¶<strong>ä¸€æ¬¡å˜æ›´åªèƒ½æ·»åŠ æˆ–åˆ é™¤ä¸€ä¸ªæˆå‘˜</strong>æ¥ç®€åŒ–é—®é¢˜ï¼Œå¦‚æœè¦å˜æ›´å¤šä¸ªæˆå‘˜ï¼Œéœ€è¦æ‰§è¡Œå¤šæ¬¡æˆå‘˜å˜æ›´ã€‚</p><p>ZABï¼š3.5ç‰ˆæœ¬ä»¥å‰æ˜¯åœæœºçš„ï¼Œä½†åœæœºå˜æ›´ä¹Ÿæœ‰é—®é¢˜ï¼Œ3.5å¼€å§‹ä½¿ç”¨äº†åŠ¨æ€å˜æ›´æˆå‘˜ï¼Œå‡ºé—¨å·¦è½¬<a href="https://zhuanlan.zhihu.com/p/57128195" target="_blank" rel="noopener">Zabåè®®ä¸­çš„åŠ¨æ€æˆå‘˜å˜æ›´</a>ï¼Œæ¯”Raftéš¾ç†è§£ğŸ˜ï¼Œåæ­£æˆ‘æ˜¯çœ‹ä¸ä¸‹å»ğŸ˜ã€‚</p><h1 id="æ€»ç»“">12. æ€»ç»“</h1><p>Raftæ˜¯åœ¨æƒ³è§£å†³PAXOSè¿‡äºå¤æ‚çš„ç¼ºç‚¹çš„èƒŒæ™¯ä¸‹æå‡ºæ¥çš„ä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•ï¼Œä¹‹å‰ä¹Ÿçœ‹è¿‡ZABåè®®ï¼Œæ„Ÿè§‰Raftå¯ç”¨æ€§æ¯”ZABé«˜å¾ˆå¤šã€‚</p><p>ä¸è¿‡æœ‰ä¸ªé—®é¢˜è®©æˆ‘è¿·æƒ‘æ˜¯ï¼Œåœ¨ä¸¤é˜¶æ®µæˆå‘˜å˜æ›´æ–¹æ¡ˆé‡Œï¼Œå¦‚æœæäº¤äº†<code>C-old-new</code>åï¼Œè¿˜æœ‰æ—§çš„Server1ï¼ŒServer2æ²¡æœ‰å¤åˆ¶åˆ°ï¼ŒServer1ï¼ŒServer2çš„é…ç½®è¿˜æ˜¯<code>C-old</code><br><img src="../images/20190822194828.png" alt><br>è¿™æ—¶å€™Server1ï¼ŒServer2å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºï¼Œé‚£ä¹ˆè¿™ä¸¤å°æœåŠ¡å™¨è¿˜æ˜¯å¯ä»¥äº§ç”ŸåŸºäº<code>C-old</code>çš„leaderï¼Œè€ŒServer3ï¼ŒServer4ï¼ŒServer5å½¢æˆå¦ä¸€ä¸ª<strong>majority</strong>ï¼Œä¹Ÿå¯ä»¥äº§ç”Ÿä¸€ä¸ªleaderï¼Œä¸ä¸€æ ·è¿˜ä¼šå‡ºç°åŒleaderé—®é¢˜ä¹ˆï¼Ÿè‹¥ä½¿ç”¨ä¸€é˜¶æ®µæˆå‘˜å˜æ›´ï¼Œå°±å¯ä»¥é˜»æ­¢å¤šä¸ªmajorityäº§ç”Ÿï¼Œæœç»è¿™ç§æƒ…å†µå§ã€‚</p><p>å¾ˆæœ‰å…´è¶£å®ç°ä¸€ä¸ªRaftç®—æ³•ã€‚</p><h1 id="å‚è€ƒ">13. å‚è€ƒ</h1><ol><li><a href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md" target="_blank" rel="noopener">å¯»æ‰¾ä¸€ç§æ˜“äºç†è§£çš„ä¸€è‡´æ€§ç®—æ³•ï¼ˆæ‰©å±•ç‰ˆï¼‰</a>Raftè®ºæ–‡æ±‰åŒ–</li><li><a href="https://raft.github.io/raft.pdf" target="_blank" rel="noopener">In Search of an Understandable Consensus Algorithm(Extended Version)</a>Raftè®ºæ–‡åŸç‰ˆ</li><li><a href="https://mp.weixin.qq.com/s/8HkeYupmqeMjVlXGJDdlLg" target="_blank" rel="noopener">Raftå¯¹æ¯”ZABåè®®</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;ä¸ºäº†å­¦ä¹ &lt;code&gt;etcd&lt;/code&gt;,å…ˆå­¦ä¹ äº†è§£ä¸€ä¸‹Raftåè®®ï¼Œæƒ³æ€»ç»“ä¸€ä¸‹Raftå’Œzookeeperçš„ZABåè®®åè®®çš„å¼‚åŒã€‚&lt;/p&gt;
&lt;p&gt;ZABæ˜¯å¯¹PAXOSç®—æ³•çš„æ”¹è¿›ï¼ˆæ²¡çœ‹è¿‡PASXOSï¼Œå¥½åƒæ²¡æœ‰leaderæ¦‚å¿µï¼Œæˆ‘
      
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="https://htchz.cc/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="ä¸€è‡´æ€§ç®—æ³•" scheme="https://htchz.cc/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95/"/>
    
      <category term="raft" scheme="https://htchz.cc/tags/raft/"/>
    
      <category term="ZAB" scheme="https://htchz.cc/tags/ZAB/"/>
    
  </entry>
  
  <entry>
    <title>[ç½‘ç»œ]TCPæ‹¥å¡æ§åˆ¶é‚£äº›äº‹</title>
    <link href="https://htchz.cc/3284953854.html"/>
    <id>https://htchz.cc/3284953854.html</id>
    <published>2019-08-15T02:05:00.000Z</published>
    <updated>2019-08-22T06:21:52.435Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>çœ‹å®Œäº†ã€ŠTCP/IPè¯¦è§£ å·ä¸€ã€‹ï¼Œå¯¹TCP/IPåè®®ç°‡çš„è®¤çŸ¥å¤šäº†ä¸€äº›ã€‚æ€»ç»“ä¸€ä¸‹TCPçª—å£æœ‰å…³çš„æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤çš„æ¦‚å¿µã€‚</p><h1 id="TCPæ»‘åŠ¨çª—å£">2. TCPæ»‘åŠ¨çª—å£</h1><p>çª—å£æœ‰ä¸¤ç§ï¼Œé€šå‘Šçª—å£(Receiver Window,rwnd)å’Œæ‹¥å¡çª—å£(Congestion Window,cwnd)ã€‚  </p><ul><li>é€šå‘Šçª—å£ï¼šé€šå‘Šçª—å£è¡¨æ˜äº†æ¥æ”¶ç«¯å½“å‰çš„æ¥å—èƒ½åŠ›ã€‚TCPåœ¨å‘é€ç«¯å’Œæ¥æ”¶ç«¯éƒ½æ˜¯æœ‰ç¼“å†²åŒºçš„ï¼Œé€šå‘Šçª—å£å£°æ˜äº†å½“å‰æ¥æ”¶ç«¯çš„ç¼“å†²åŒºè¿˜èƒ½æ¥æ”¶çš„å­—èŠ‚å¤§å°ã€‚è¿™ä¸ªæ•°å€¼ä¼šåœ¨TCPæŠ¥æ–‡é‡Œæºå¸¦ã€‚</li><li>æ‹¥å¡çª—å£ï¼šæ‹¥å¡çª—å£ä¸è¢«TCPæŠ¥æ–‡ä¼ è¾“ï¼Œæ˜¯å‘é€ç«¯åŸºäºæ‹¥å¡é¿å…ç®—æ³•ç®—å‡ºæ¥çš„ä¸€ä¸ªçª—å£ã€‚è¿™ä¸ªçª—å£é™åˆ¶äº†å‘é€æ–¹çš„å‘é€é€Ÿç‡é¿å…ç½‘ç»œæ‹¥å¡ã€‚</li></ul><p>ä¸¤ä¸ªçª—å£å…±åŒç»„æˆäº†ä¸€ä¸ªæ»‘åŠ¨çª—å£ã€‚ç®€å•æ¥è¯´ï¼Œé€šå‘Šçª—å£æ˜¯å¼ºåˆ¶é™åˆ¶ï¼Œæ‹¥å¡çª—å£æ˜¯è‡ªå‘é™åˆ¶ã€‚</p><p>æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼Œçª—å£çš„å•ä½ç”¨å­—èŠ‚è¡¨ç¤ºï¼Œä½†æ˜¯æ‹¥å¡çª—å£çš„è°ƒæ•´æ€»æ˜¯ä»¥ä¸€ä¸ªMSSçš„å€æ•°æ¥è°ƒæ•´ã€‚</p><p>è¿™é‡Œç”¨ä¹¦ä¸Šçš„å›¾æè¿°æ»‘åŠ¨çª—å£ï¼Œ<br><img src="/images/pasted-178.png" alt="upload successful"><br>å½“ä¸€ä¸ªTCPå‘é€æ–¹å‘é€æ•°æ®çš„æ—¶å€™å°±ä¼šæŸ¥çœ‹å¯ç”¨çª—å£èƒ½å¦å‘é€ï¼ˆå¦‚æœå¯ç”¨äº†Nagleç®—æ³•ï¼Œå¯ç”¨çª—å£å¿…é¡»å¤§äºç­‰äºä¸€ä¸ªMSSï¼Œå‘é€æ–¹æ‰å‘é€æ•°æ®ï¼‰</p><p><img src="/images/pasted-177.png" alt="upload successful"><br>ä¸Šé¢æ˜¯æŠ“åŒ…å¾—åˆ°çš„ä¸€ä¸ªæŠ¥æ–‡ï¼ŒWin=2027æ˜¯ä¸€ä¸ªé€šå‘Šçª—å£ï¼Œè¡¨ç¤ºæœåŠ¡å™¨çš„ç¼“å†²åŒºè¿˜èƒ½æ¥å—2027å­—èŠ‚çš„æ•°æ®ã€‚</p><h1 id="æ‹¥å¡æ§åˆ¶">3. æ‹¥å¡æ§åˆ¶</h1><p><img src="/images/pasted-183.png" alt="upload successful"><br>ä¸Šå›¾æ˜¯ä¸€ä¸ªtcpåˆšå¼€å§‹ä¼ è¾“æ•°æ®æ—¶çš„é€Ÿç‡å˜åŒ–èµ°å‘ã€‚</p><p>æ‹¥å¡é¿å…ã€æ…¢å¯åŠ¨ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤è¿™å››ä¸ªè¯å…¶å®å¹¶ä¸èƒ½å•ç‹¬åˆ†å¼€è®²ã€‚å½“ä¸€ä¸ªè¿æ¥çš„ç½‘ç»œæƒ…å†µä¸å¥½çš„æ—¶å€™ï¼Œå°±ä¼š<strong>ä¸¢åŒ…</strong>æˆ–<strong>è¶…æ—¶</strong>ï¼Œè¿™æ—¶å°±è¦é™ä½å‘é€æ–¹çš„å‘é€é€Ÿç‡é˜²æ­¢æ¶åŒ–ï¼Œè¿™ç§å°±æ˜¯æ‹¥å¡æ§åˆ¶ã€‚</p><p>è¿™ç§æœºåˆ¶æ¶‰åŠåˆ°cwndå’Œssthreshä¸¤ä¸ªæŒ‡æ ‡ï¼Œssthreshæ˜¯ä¸€ä¸ªåŒºåˆ†æ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…çš„é˜ˆå€¼ï¼Œå½“æ‹¥å¡å‘ç”Ÿæ—¶ï¼Œåˆ†ä¸¤ç§æƒ…å†µ<br>è¶…æ—¶ï¼šssthresh = cwnd / 2ï¼ˆæœ€å°ä¸º2MSSï¼‰ï¼Œcwnd = 1MSSï¼Œè¿›å…¥æ…¢å¯åŠ¨<br>ä¸¢åŒ…ï¼šssthresh = cwnd / 2ï¼ˆæœ€å°ä¸º2MSSï¼‰ï¼Œcwnd = ssthresh + 3MSSï¼Œè¿›å…¥å¿«é€Ÿé‡ä¼ </p><h1 id="æ…¢å¯åŠ¨">4. æ…¢å¯åŠ¨</h1><p>æ…¢å¯åŠ¨å…¶å®æ˜¯å‘é€é€Ÿç‡é‡æ–°è®¡ç®—ï¼Œcwnd åˆå§‹å€¼ä¸ºä¸€ä¸ªæ•°æ®æŠ¥å¤§å°ï¼Œssthreshåˆå§‹å€¼ä¸º65535ï¼Œæ˜¯ä¸€ä¸ªç„¶ååœ¨åˆ°è¾¾é˜ˆå€¼ä¹‹å‰ï¼Œæ¯æ¥æ”¶åˆ°ä¸€ä¸ªæ–°çš„ACKï¼Œcwndå°±ä¼šå¢åŠ ä¸€ä¸ªæŠ¥æ–‡æ®µçš„å¤§å°ï¼Œè¿™æ ·å­æ…¢å¯åŠ¨å…¶å®æ˜¯ä»¥æŒ‡æ•°å¢åŠ ç½‘ç»œä¼ </p><h1 id="æ‹¥å¡æ§åˆ¶-1">5. æ‹¥å¡æ§åˆ¶</h1><p><img src="/images/pasted-185.png" alt="upload successful"><br>ä¸Šå›¾æ˜¯ä¸€ä¸ªtcpåˆšå¼€å§‹ä¼ è¾“æ•°æ®æ—¶çš„é€Ÿç‡å˜åŒ–èµ°å‘ã€‚</p><p>æ‹¥å¡é¿å…ã€æ…¢å¯åŠ¨ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤è¿™å››ä¸ªè¯å…¶å®å¹¶ä¸èƒ½å•ç‹¬åˆ†å¼€è®²ã€‚å½“ä¸€ä¸ªè¿æ¥çš„ç½‘ç»œæƒ…å†µä¸å¥½çš„æ—¶å€™ï¼Œå°±ä¼š<strong>ä¸¢åŒ…</strong>æˆ–<strong>è¶…æ—¶</strong>ï¼Œè¿™æ—¶å°±è¦é™ä½å‘é€æ–¹çš„å‘é€é€Ÿç‡é˜²æ­¢æ¶åŒ–ï¼Œè¿™ç§å°±æ˜¯æ‹¥å¡æ§åˆ¶ã€‚</p><p>è¿™ç§æœºåˆ¶æ¶‰åŠåˆ°cwndå’Œssthreshä¸¤ä¸ªæŒ‡æ ‡ï¼Œssthreshæ˜¯ä¸€ä¸ªåŒºåˆ†æ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…çš„é˜ˆå€¼ï¼Œå½“æ‹¥å¡å‘ç”Ÿæ—¶ï¼Œåˆ†ä¸¤ç§æƒ…å†µ<br>è¶…æ—¶ï¼šssthresh = cwnd / 2ï¼ˆæœ€å°ä¸º2MSSï¼‰ï¼Œcwnd = 1MSSï¼Œè¿›å…¥æ…¢å¯åŠ¨<br>ä¸¢åŒ…ï¼šè¿›å…¥å¿«é€Ÿé‡ä¼ </p><h2 id="æ…¢å¯åŠ¨-1">5.1. æ…¢å¯åŠ¨</h2><p>æ…¢å¯åŠ¨å…¶å®æ˜¯å‘é€é€Ÿç‡é‡æ–°è®¡ç®—ï¼Œcwnd åˆå§‹å€¼ä¸ºä¸€ä¸ªæ•°æ®æŠ¥å¤§å°ï¼Œssthreshåˆå§‹å€¼ä¸º65535ï¼Œæ˜¯ä¸€ä¸ªç„¶ååœ¨åˆ°è¾¾é˜ˆå€¼ä¹‹å‰ï¼Œæ¯æ¥æ”¶åˆ°ä¸€ä¸ªæ–°çš„ACKï¼Œcwndå°±ä¼šå¢åŠ ä¸€ä¸ªæŠ¥æ–‡æ®µçš„å¤§å°ï¼Œè¿™æ ·å­æ…¢å¯åŠ¨å…¶å®æ˜¯ä»¥æŒ‡æ•°å¢åŠ ç½‘é€Ÿåˆ°ä¸€ä¸ªæ¯”è¾ƒå¹³è¡¡çš„æ°´å¹³ã€‚</p><h2 id="æ‹¥å¡é¿å…">5.2. æ‹¥å¡é¿å…</h2><p>å½“cwndå¤§äºç­‰äºssthreshæ—¶è¿›å…¥æ‹¥å¡é¿å…çŠ¶æ€ï¼Œåœ¨ä¸€ä¸ªRTTå†…æ— è®ºæ”¶åˆ°å¤šå°‘ACKéƒ½åªå°†cwndå¢åŠ ä¸€ä¸ªæŠ¥æ–‡å¤§å°ï¼Œä»æ—¶é—´ä¸Šæ¥çœ‹ç½‘é€Ÿçº¿æ€§å¢åŠ ã€‚</p><h2 id="å¿«é€Ÿé‡ä¼ å’Œå¿«é€Ÿæ¢å¤">5.3. å¿«é€Ÿé‡ä¼ å’Œå¿«é€Ÿæ¢å¤</h2><p>å¿«é€Ÿé‡ä¼ æŒ‡ï¼Œå½“æ”¶åˆ°é‡å¤çš„3ä¸ªACKæŠ¥æ–‡æ—¶ï¼ˆduplicate ackï¼‰ï¼Œè®¾ç½®<code>ssthresh = cwnd / 2ï¼ˆæœ€å°ä¸º2MSSï¼‰ï¼Œcwnd = ssthresh + 3MSS</code>ï¼Œç„¶åè¿›å…¥å¿«é€Ÿæ¢å¤é˜¶æ®µã€‚</p><p>æš‚åœå‘é€æ–°çš„æŠ¥æ–‡ï¼Œé‡ä¼ ä¸¢å¤±æŠ¥æ–‡ã€‚</p><p>æ¥ä¸‹æ¥æ¯æ”¶åˆ°é‡å¤çš„ACKæ—¶ï¼Œå°†cwndå¢åŠ ä¸€ä¸ªæŠ¥æ–‡å¤§å°ã€‚å¦‚æœcwndå¤§äºæœªç¡®è®¤æŠ¥æ–‡å¤§å°ï¼ˆæŠ¥æ–‡ä¸¢å¤±åæˆ‘ä»¬è¿˜åœ¨å‘æ–°çš„æŠ¥æ–‡ï¼Œæœªç¡®è®¤æŠ¥æ–‡æŒ‡ä¸¢å¤±æŠ¥æ–‡åˆ°æœ€åä¸€ä¸ªæŠ¥æ–‡ä¹‹é—´æŠ¥æ–‡æ€»å¤§å°ï¼‰ï¼Œå¯ä»¥å‘é€æ–°æŠ¥æ–‡ã€‚</p><p>æ¥ä¸‹æ¥å¦‚æœæ”¶åˆ°æ–°çš„ACKæŠ¥æ–‡ï¼Œå°†cwndè®¾ç½®ä¸ºssthreshï¼Œä¹Ÿå°±æ˜¯ç½‘é€Ÿé™ä¸ºä¸€åŠï¼Œå¹¶è¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œç½‘é€Ÿä¸€ç›´å¤„äºä¸€ä¸ªåŠ¨æ€è°ƒæ•´çš„è¿‡ç¨‹ï¼Œä¸€ä¸ªè¿æ¥ä¸Šcwndéšæ—¶é—´çš„å˜åŒ–å¦‚å›¾æ‰€ç¤º</p><p><img src="/images/pasted-182.png" alt="upload successful"></p><p>è¿˜æœ‰ä¸€ç‚¹ï¼Œä¸Šé¢å…³äºcwndçš„æ¯”è¾ƒå…¶å®è¿˜è¦è€ƒè™‘rwndçš„å€¼ï¼Œå¦‚æœrwnd&gt;cwndï¼Œåº”å–rwndå»æ¯”è¾ƒï¼Œæ¯•ç«Ÿä¸¤è€…å†³å®šäº†å¯ç”¨çª—å£å¤§å°ã€‚</p><h1 id="åè®°">6. åè®°</h1><p>TCPæ‹¥å¡æ§åˆ¶å…¶å®è¿˜æœ‰å¾ˆå¤šæ”¹è¿›æœªå»äº†è§£ã€‚æ¯”å¦‚å½“æ”¶åˆ°é‡å¤çš„3ä¸ªACKæŠ¥æ–‡æ—¶ï¼Œå…¶å®ä¸ä¸€å®šåªä¸¢äº†ä¸€ä¸ªæŠ¥æ–‡ï¼Œæ‰€ä»¥ç½‘é€Ÿå¯èƒ½æŒ‡æ•°ä¸‹é™ï¼Œä¸èƒ½è¾¾åˆ°å¿«é€Ÿæ¢å¤çš„ç›®çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;çœ‹å®Œäº†ã€ŠTCP/IPè¯¦è§£ å·ä¸€ã€‹ï¼Œå¯¹TCP/IPåè®®ç°‡çš„è®¤çŸ¥å¤šäº†ä¸€äº›ã€‚æ€»ç»“ä¸€ä¸‹TCPçª—å£æœ‰å…³çš„æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ã€å¿«é€Ÿé‡ä¼ ã€å¿«é€Ÿæ¢å¤çš„æ¦‚å¿µã€‚&lt;/p&gt;
&lt;h1 id=&quot;TCPæ»‘åŠ¨çª—å£&quot;&gt;2. TCPæ»‘åŠ¨çª—å£&lt;/h1&gt;&lt;p&gt;çª—å£æœ‰ä¸¤ç§ï¼Œ
      
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="https://htchz.cc/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="TCP" scheme="https://htchz.cc/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>[ç¢ç¢å¿µ]ç»™æœºå™¨åŠ ä¸ªç›‘æ§</title>
    <link href="https://htchz.cc/3663317463.html"/>
    <id>https://htchz.cc/3663317463.html</id>
    <published>2019-07-20T05:49:00.000Z</published>
    <updated>2019-07-20T12:50:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ˜æ˜åªæœ‰ä¸€å°ç ´æœºå™¨ï¼Œå´è¦è£…æˆç”¨ä¸èµ·çš„æ ·å­</p><p><img src="/images/pasted-176.png" alt="upload successful"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ˜æ˜åªæœ‰ä¸€å°ç ´æœºå™¨ï¼Œå´è¦è£…æˆç”¨ä¸èµ·çš„æ ·å­&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/pasted-176.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;

      
    
    </summary>
    
      <category term="ç¢ç¢å¿µ" scheme="https://htchz.cc/categories/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>[FCM]ç”¨FCMåšä¸€ä¸ªè·¨è®¾å¤‡æ¶ˆæ¯åŒæ­¥å·¥å…·</title>
    <link href="https://htchz.cc/2379284348.html"/>
    <id>https://htchz.cc/2379284348.html</id>
    <published>2019-05-18T03:00:00.000Z</published>
    <updated>2019-05-20T07:45:55.000Z</updated>
    
    <content type="html"><![CDATA[<p>FcmçœŸæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œå¸Œæœ›ä½ ä¹Ÿæœ‰ã€‚</p><a id="more"></a><h1 id="éœ€æ±‚èƒŒæ™¯">1. éœ€æ±‚èƒŒæ™¯</h1><p>ä½œä¸ºä¸€ä¸ªç©·äººï¼Œæ‰‹æŒä¸äº†iPhone(æ»‘ç¨½)ï¼Œå½“åŒæ—¶ä½¿ç”¨ç€macOSã€windowsã€å®‰å“ä¸‰ä¸ªå¹³å°æ—¶ï¼Œæˆ‘é¢ä¸´ç€å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>ä¼ æ–‡ä»¶ã€‚å¯¹äºä¼ æ–‡ä»¶ï¼Œæœ‰è®¸å¤šæ–¹æ¡ˆï¼Œæˆ‘åå‘äºç”¨Feemæˆ–è€…å…±äº«æ–‡ä»¶å¤¹ï¼Œéƒ½æ˜¯å±€åŸŸç½‘ä¼ è¾“ï¼Œåˆå¿«åˆä¸ç”¨ç»è¿‡ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ã€‚</li><li>å¤åˆ¶æ–‡æœ¬ã€‚iPhoneå’Œmacä¹‹é—´æœ‰é€šç”¨å‰ªåˆ‡æ¿ï¼Œwin10å’ŒiPhoneã€å®‰å“ä¹‹é—´æœ‰å¾®è½¯å°å¨œã€‚</li><li>é€šçŸ¥åŒæ­¥ã€‚ä¸»è¦æ˜¯æ‰‹æœºé€šçŸ¥ï¼Œä¸Šç­å·¥ä½œæ—¶ï¼Œå¬åˆ°æ‰‹æœºæ¨é€çš„å£°éŸ³æƒ³çŸ¥é“æ—¶ä»€ä¹ˆä¸œè¥¿åˆæ‡’å¾—å»çœ‹æ‰‹æœºã€‚</li><li>çŸ­ä¿¡éªŒè¯ç ã€‚ç”µè„‘ä¸Šç”¨çŸ­ä¿¡éªŒè¯ç åœºæ™¯å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œä¸è¿‡æˆ‘ä»¬å…¬å¸çš„çº¿ä¸ŠæœåŠ¡å™¨ç™»å½•æ—¶éœ€è¦çŸ­ä¿¡éªŒè¯ç çš„äºŒæ¬¡éªŒè¯ï¼Œè¿™æ—¶å€™å»è§£é”æ‰‹æœºã€çœ‹éªŒè¯ç ã€ä¸€ä¸ªä¸€ä¸ªè¾“å…¥ç»ˆç«¯ã€‚ã€‚ã€‚å¦ˆè›‹å¾ˆçƒ¦ã€‚</li></ol><p>äºæ˜¯æ‰¾äº†ä¸€å †ï¼ŒAirDroidã€Pushbulletç­‰ç­‰ï¼Œåœ¨åˆ°å¤„è®²éšç§çš„ä»Šå¤©ï¼Œæˆ‘è§‰å¾—æŠŠè‡ªå·±çš„å‰ªåˆ‡æ¿ã€çŸ­ä¿¡ã€é€šçŸ¥å°±è¿™ä¹ˆå‘é€ç»™äººå®¶æ€»æ˜¯æœ‰ç‚¹ä¸å®‰ï¼ˆä¸è¿‡ç”¨fcmä¹Ÿæ˜¯æŠŠæ•°æ®ç»™å·ç§°â€˜ä¸ä½œæ¶â€™å£å·çš„è°·æ­Œï¼‰ã€‚å¶ç„¶çœ‹åˆ°äº†å‰ªçº¸äº‘ï¼Œæ˜¯ä¸ªæ”¶è´¹è½¯ä»¶ï¼Œä¸è¿‡çœ‹äº†ç®€ä»‹è¯´æ˜¯ç”¨FCMåšçš„ï¼Œæ‰¾äº†ä¸‹FCMçš„æ¥å…¥æŒ‡åŒ—ï¼Œè‡ªå·±åšä¸€ä¸ªåŒæ­¥å·¥å…·ã€‚</p><h1 id="æ•´ä½“æµç¨‹">2. æ•´ä½“æµç¨‹</h1><p><img src="/images/pasted-174.png" alt="upload successful"></p><p>æ•°æ®çš„æµå‘å¦‚å›¾ï¼Œç»ˆç«¯æŠŠè¦åŒæ­¥çš„æ•°æ®å‘åˆ°è‡ªå·±çš„åº”ç”¨æœåŠ¡å™¨ï¼Œåº”ç”¨æœåŠ¡å™¨è½½æŠŠæ•°æ®å‘åˆ°FCMï¼Œäº¤ç”±FCMæ¨é€åˆ°è®¾å¤‡ç»„ã€‚</p><p>å¯¹äºæ¯ä¸€å°è®¾å¤‡ï¼Œå½“åº”ç”¨ä¸FCMå»ºç«‹èµ·è¿æ¥åå¯ä»¥å¾—åˆ°ä¸€ä¸ªfcm tokenï¼Œè¿™ä¸ªtokenå°±æ˜¯è¿™å°è®¾å¤‡è¿™ä¸ªåº”ç”¨çš„idäº†ã€‚</p><p>è‡³äºè®¾å¤‡ç»„idï¼Œæˆ‘æ˜¯ç”¨Firebase-Authçš„userIdä½œä¸ºè®¾å¤‡ç»„idçš„ã€‚</p><p>ç¨‹åºä¸»è¦æµç¨‹æ˜¯ï¼š</p><ol><li>å®¢æˆ·ç«¯å¯åŠ¨æ—¶è·å–fcm tokenï¼ŒæŒä¹…åŒ–å­˜å‚¨ï¼ˆè¿™ä¸ªfcm tokené™¤éæŠŠåº”ç”¨åˆ äº†å’Œæˆ‘ä¸çŸ¥é“çš„æƒ…å†µï¼Œå¦åˆ™ä¸‡å¹´ä¸æ›´æ–°ä¸€æ¬¡ï¼Œå½“ç„¶fcm sdkæä¾›äº†æ›´æ–°çš„å›è°ƒï¼Œæˆ‘ä»¬è¦å®ç°è¿™ä¸ªæ–¹æ³•ã€‚ï¼‰</li><li>å®¢æˆ·ç«¯ç™»å½•ï¼Œæ‹‰èµ·è°·æ­Œçš„OAuth2.0æˆæƒï¼ˆChromeæ’ä»¶ç”¨çš„clientIdæ¨¡å¼ï¼‰ï¼Œç™»å½•æˆåŠŸåè·å–åˆ°firebase-authçš„userIdï¼ŒæŒä¹…åŒ–å­˜å‚¨</li><li>ç™»å½•æˆåŠŸåæŠŠuserIdå’Œfcm tokenå‘é€åˆ°åº”ç”¨æœåŠ¡å™¨ä¿å­˜ï¼Œç»´æŠ¤åŒå‘å…³ç³»ï¼Œå®Œæˆæ³¨å†Œã€‚</li><li>å®¢æˆ·ç«¯æ¯æ¬¡å‘é€åŒæ­¥æ•°æ®æ—¶ï¼Œå¸¦ä¸Šæ—¶é—´æˆ³ã€åŒæ­¥ç±»å‹ã€fcm tokenç­‰å†…å®¹ã€‚</li><li>å®¢æˆ·ç«¯æ¥å—åˆ°fcmæ¨é€æ—¶ï¼Œè§æœºè¡Œäº‹ã€‚</li></ol><p>åŒæ­¥æ•°æ®çš„æ•°æ®ç»“æ„</p><table><thead><tr><th>å­—æ®µ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>type</td><td>çŸ­ä¿¡ã€é€šçŸ¥ã€å‰ªåˆ‡æ¿</td></tr><tr><td>time</td><td>æ¯«ç§’æ—¶é—´æˆ³ï¼Œä¹Ÿä½œä¸ºåˆ†ç‰‡idï¼ˆå…¶å®æ˜¯å·æ‡’ï¼‰</td></tr><tr><td>text</td><td>æ–‡æœ¬å†…å®¹</td></tr><tr><td>head</td><td>é¢å¤–å†…å®¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å­˜é€šçŸ¥çš„é€šçŸ¥æ ‡é¢˜</td></tr><tr><td>fcm_token</td><td>è®¾å¤‡id</td></tr><tr><td>mark</td><td>åˆ†ç‰‡çš„æ ‡è¯†ï¼Œ8ä½æ•´æ•°ï¼Œé«˜ä½èµ·ç¬¬ä¸€ä½è¡¨ç¤ºæ˜¯å¦åˆ†ç‰‡ï¼Œç¬¬äºŒä½è¡¨ç¤ºæ˜¯å¦è¿˜æœ‰åˆ†ç‰‡ï¼Œä½™ä¸‹6ä½è¡¨ç¤ºåˆ†ç‰‡é¡ºåº</td></tr></tbody></table><h1 id="æœåŠ¡ç«¯">3. æœåŠ¡ç«¯</h1><p>æœåŠ¡ç«¯ç”¨goå†™çš„ï¼Œæ¡†æ¶ä½¿ç”¨ginï¼Œæ•°æ®åº“ç”¨redisã€‚</p><p>ä¸»è¦ç»´æŠ¤ä¸¤ä¸ªå…³ç³»ã€‚</p><ol><li>è®¾å¤‡idåˆ°è®¾å¤‡ç»„idçš„å…³ç³»</li><li>è®¾å¤‡ç»„idåˆ°æ‰€æœ‰è®¾å¤‡idçš„å…³ç³»</li></ol><p>ç¬¬ä¸€ä¸ªç›´æ¥ç”¨redisçš„kvæ¨¡å‹ï¼Œç¬¬äºŒä¸ªç”¨redisçš„å“ˆå¸Œæ¨¡å‹ã€‚</p><p>å½“æœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„åŒæ­¥è¯·æ±‚æ—¶ï¼Œæ¨é€åˆ°fcmæœ‰ä¸¤ç§æ–¹å¼ã€‚</p><ol><li>ä½¿ç”¨fcmçš„è®¾å¤‡ç»„ç®¡ç†ï¼Œfcmè®¾å¤‡ç»„ç®¡ç†éœ€è¦æ–°å»ºè®¾å¤‡ç»„ï¼ŒæŠŠfcm tokenæ·»åŠ åˆ°è®¾å¤‡ç»„ï¼Œå‘é€åŒæ­¥æ•°æ®æ—¶ï¼Œå¸¦ä¸Šfcmè®¾å¤‡ç»„idï¼Œfcmå°±ä¼šæŠŠåŒæ­¥æ•°æ®æ¨é€åˆ°æ‰€æœ‰ç»„ã€‚å¯¹äºå·²ç»å¤±æ•ˆçš„fcm tokenï¼Œfcmè®¾å¤‡ç»„ç®¡ç†ä¼šè‡ªå·±æ¸…ç†ã€‚</li><li>è‡ªå·±ç»´æŠ¤è®¾å¤‡ç»„ï¼Œéå†è®¾å¤‡ç»„çš„è®¾å¤‡ï¼Œä¸€ä¸ªä¸ªå¸¦ä¸Šfcm tokenæ¨åˆ°fcmã€‚å¦‚æœæ¥æ”¶åˆ°fcm tokenæ— æ•ˆçš„å“åº”ï¼Œå°±ä»redisæŠŠfcm tokençš„kvå…³ç³»ã€å“ˆå¸Œå…³ç³»åˆ é™¤ã€‚</li></ol><p>ä½¿ç”¨fcmçš„è®¾å¤‡ç»„ç®¡ç†çš„å¥½å¤„æ˜¯åªéœ€è¦ç»´æŠ¤è®¾å¤‡idåˆ°è®¾å¤‡ç»„idçš„å…³ç³»ï¼Œå¯¹äºä¸€äº›æ— æ•ˆçš„fcm tokenç”±fcmè‡ªå·±å»ç®¡ç†ï¼Œä¸è¶³çš„æ˜¯ç›®å‰fcmè®¾å¤‡ç»„ç®¡ç†æ²¡æœ‰æä¾›APIè·å–è®¾å¤‡ç»„çš„è®¾å¤‡ç»„åˆ—è¡¨ï¼Œè€Œä¸”ä¸€å‘å°±æ˜¯å‘å…¨éƒ¨ï¼Œå®¢æˆ·ç«¯å‘æ¶ˆæ¯å‡ºå»ï¼Œå¾…ä¼šåˆæ”¶åˆ°è‡ªå·±çš„æ¶ˆæ¯ã€‚æ­¤å¤–ï¼Œfcmè®¾å¤‡ç»„ç®¡ç†åœ¨goæ²¡æœ‰sdkã€‚ã€‚ã€‚</p><p>æ‰€ä»¥æˆ‘å†³å®šè‡ªå·±ç®¡ç†è®¾å¤‡ç»„ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªâ˜ï¸å‰ªåˆ‡æ¿çš„é—®é¢˜ï¼Œå½“å‘é€åˆ°fcmçš„payloadå¤§äº4kbçš„æ—¶å€™ï¼Œä¼šè¿”å›</p><pre><code>400; reason: request contains an invalid argument; code: invalid-argument; details: Request contains an invalid argument.</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦æ§åˆ¶å¥½æ•°æ®å¤§å°ã€‚ä½œä¸ºctrl cvå·¥ç¨‹å¸ˆï¼Œå¦‚æœè¦ä»macå¾€windowså¤åˆ¶1000è¡Œä»£ç æ€ä¹ˆåŠï¼Ÿç­”æ¡ˆæ˜¯åˆ†ç‰‡ã€‚</p><p>æ­£å¦‚ipåˆ†ç‰‡å’Œtcpåˆ†æ®µä¸ºäº†è§£å†³æŠ¥æ–‡çš„å¤§å°é™åˆ¶ï¼Œæˆ‘ä»¬è¦åœ¨åº”ç”¨å±‚è¿›è¡Œåˆ†ç‰‡é‡ç»„ã€‚ä¸è¿‡è¿™ä¸ªç”±äºæ˜¯åº”ç”¨å±‚çš„åˆ†ç‰‡è¦ç®€å•çš„å¤šã€‚</p><ol><li>åº”ç”¨æœåŠ¡å™¨æ¥æ”¶åˆ°åŒæ­¥æ•°æ®åï¼Œå¦‚æœtextæ–‡æœ¬å¤§äº4kbï¼Œåˆ™è¿›è¡Œåˆ†ç‰‡ï¼Œmarké«˜ä½ç¬¬ä¸€ä½ç½®0ï¼Œå¦åˆ™ç½®1ç›´æ¥æ¨åˆ°FCMã€‚</li><li>ç¬¬äºŒæ­¥ï¼Œç”±äºjsonæ˜¯ä¸ªæ–‡æœ¬åè®®ï¼Œæˆ‘ä»¬åˆ†ç‰‡çš„æ—¶å€™æœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œç¬¬ä¸€ç§è½¬æ¢ä¸ºå­—èŠ‚åˆ†ç‰‡ï¼Œç¬¬äºŒç§è½¬æ¢ä¸ºruneåˆ†ç‰‡ï¼ˆruneæ˜¯goçš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥è¡¨ç¤ºä¸€ä¸ªutf8å­—ç¬¦ï¼‰ï¼Œä¸€ä¸ªruneçš„å¤§å°æ˜¯4ä¸ªå­—èŠ‚ï¼Œä¸ºäº†é˜²æ­¢è¾¾åˆ°é™åˆ¶ï¼Œruneåˆ†ç‰‡å¤§å°åº”ä¸º1000ä¸ªruneï¼Œä¸è¿‡è¿™æ ·å°±å¯èƒ½ä¼šå¯¼è‡´ä¸€æ¬¡payloadåˆ©ç”¨ç‡ä¸é«˜ï¼Œæ¯•ç«Ÿ1000ä¸ªæ±‰å­—æ˜¯1000ä¸ªruneï¼Œè‡³å°‘å 3000å­—èŠ‚ï¼Œ1000ä¸ªå­—æ¯ä¹Ÿæ˜¯1000ä¸ªruneï¼Œå 1000ä¸ªå­—èŠ‚ï¼›å¥½å¤„æ˜¯åœ¨å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦‚æœä½¿ç”¨å­—èŠ‚åˆ†ç‰‡ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°åˆ†ç‰‡åéœ€è¦è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ï¼Œç»„åˆå­—èŠ‚æ•°ç»„ï¼Œå†å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç‚’é¸¡éº»çƒ¦ã€‚</li><li>æ¥ä¸‹æ¥åœ¨åˆ†ç‰‡marké«˜ä½èµ·ä½6ä½è®¾ç½®å¥½åˆ†ç‰‡é¡ºåºï¼Œåªè¦ç®€å•çš„0ï¼Œ1ï¼Œ2..è¿™æ ·å°±å¥½äº†ï¼ˆä¸åŒäºipåˆ†ç‰‡ï¼Œipåˆ†ç‰‡ä½¿ç”¨çš„æ˜¯æ•°æ®åç§»é‡ä½œä¸ºä½ç½®ç´¢å¼•ï¼‰ã€‚å¦‚æœæ˜¯æœ€åä¸€ç‰‡åˆ†ç‰‡ï¼Œmarké«˜ä½èµ·ç¬¬äºŒä½è¦ç½®1è¡¨ç¤ºæ²¡æœ‰æ›´å¤šåˆ†ç‰‡ã€‚</li></ol><p>æ¥ä¸‹æ¥åˆ©ç”¨sdkæ¨é€åˆ°fcmå°±å¥½äº†ã€‚åº”ç”¨æœåŠ¡å™¨çš„æ¥å…¥fcmæœ‰å¤šç§æ–¹å¼ï¼Œæ–‡æ¡£çœŸæ˜¯å‚»ç“œå¼æ•™ç¨‹ã€‚</p><h1 id="å®¢æˆ·ç«¯">4. å®¢æˆ·ç«¯</h1><p>å®¢æˆ·ç«¯å†™Chromeæ‹“å±•å’Œandroidã€‚<br>ä¸»è¦æµç¨‹æ˜¯</p><ol><li>æ ¹æ®æ¥æ”¶åˆ°çš„æ•°æ®ç±»å‹å¤„ç†ï¼Œ<br>ï¼ˆ1ï¼‰é€šçŸ¥ç›´æ¥æ˜¾ç¤ºï¼Œ<br>ï¼ˆ2ï¼‰çŸ­ä¿¡æ˜¾ç¤ºå¹¶ä¸”æ£€éªŒæœ‰æ²¡æœ‰éªŒè¯ç ï¼Œæœ‰åˆ™å°†éªŒè¯ç æå–æ”¾å…¥å‰ªåˆ‡æ¿ï¼Œ<br>ï¼ˆ3ï¼‰å‰ªåˆ‡æ¿è¿›è¡Œåˆ†ç‰‡åˆ¤æ–­</li><li>å¦‚æœä¸æ˜¯åˆ†ç‰‡ï¼Œç›´æ¥æ”¾å…¥å‰ªåˆ‡æ¿ï¼Œå¦åˆ™è¿›è¡Œé‡ç»„ã€‚</li></ol><p>é‡ç»„éœ€è¦ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨ï¼Œkeyä¸ºæ—¶é—´æˆ³ï¼Œä¹Ÿæ˜¯åˆ†ç‰‡idï¼ˆè¿™é‡Œç”¨æ—¶é—´æˆ³æ˜¯å·æ‡’ï¼Œæ¯•ç«Ÿä¸€ä¸ªäºº1æ¯«ç§’å†…ä¹Ÿä¸èƒ½å¤åˆ¶ä¸¤æ¬¡å­ï¼‰ï¼›valueæ˜¯ç»´æŠ¤åˆ†ç‰‡çš„æ•°æ®ç»“æ„FragHoldï¼Œå¦‚ä¸‹</p><table><thead><tr><th>å­—æ®µ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>count</td><td>æ•´å‹</td></tr><tr><td>length</td><td>æ•´å‹</td></tr><tr><td>text</td><td>æ•°ç»„</td></tr></tbody></table><p>å½“ç¬¬ä¸€ä¸ªåˆ†ç‰‡åˆ°æ¥æ—¶ï¼Œå°†åˆ†ç‰‡timeä½œä¸ºkeyï¼Œåˆå§‹åŒ–ä¸€ä¸ªFragHoldã€‚æ¯æ¬¡åˆ°è¾¾ä¸€ä¸ªåˆ†ç‰‡ï¼ŒFragHold.countåŠ 1ï¼Œå½“æœ€åä¸€ä¸ªåˆ†ç‰‡åˆ°æ¥ï¼ŒFragHold.lengthå¯ä»¥ç¡®å®šã€‚å¦‚æœFragHoldçš„count == lengthï¼Œé‚£ä¹ˆåˆ†ç‰‡é‡ç»„å®Œæˆï¼Œç›´æ¥å¯¹æ•°ç»„ä¸€ä¸ªjoinæ“ä½œå¾—åˆ°ä¸€ç¯‡å®Œæ•´çš„åƒå­—æ–‡ï¼Œåˆå¯ä»¥æ„‰å¿«åœ°ctrl cväº†ã€‚</p><p>æ­¤å¤–èµ·ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä¸æ–­å°†å…¨å±€å“ˆå¸Œè¡¨é‡Œè¿‡æœŸçš„FragHoldå‰”é™¤ï¼Œæ¯•ç«Ÿè¿™ä¸ªæ˜¯æ²¡æœ‰è¶…æ—¶é‡ä¼ çš„ï¼Œä¸€æ—¦ä¸¢äº†å°±å†å¤åˆ¶ä¸€æ¬¡å‘—ã€‚</p><h1 id="ç»“è¯­">5. ç»“è¯­</h1><p>è¿™é‡Œè¦è¯´ä¸€ä¸‹åœ¨è®¾å¤‡ç»„ç®¡ç†é‡åˆ°çš„é—®é¢˜ï¼Œä¸€å¼€å§‹æˆ‘ä¹Ÿæ˜¯ç”¨fcmçš„è®¾å¤‡ç»„ç®¡ç†ï¼Œå¯¼è‡´å‘é€æ–¹ä¼šæ¥æ”¶åˆ°è‡ªå·±å‘é€çš„æ¶ˆæ¯ã€‚è¿™ä¸ªæœ¬æ¥æ— æ‰€è°“ï¼Œæ ¹æ®æ¶ˆæ¯çš„fcm_tokenåˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœç­‰äºè‡ªå·±çš„fcm_tokenï¼Œå°±ä¸å¤„ç†ã€‚ä½†æ˜¯jså®¢æˆ·ç«¯æ˜¯ç”¨service workeræ¥å¤„ç†ï¼Œå½“service workeré‡æ–°å”¤é†’æ—¶ï¼Œå› ä¸ºæŸ¥è¯¢indexedDBå’Œè°ƒç”¨fcmæ¥å£éƒ½è¦åœ¨ç¬¬äºŒè½®äº‹ä»¶å¾ªç¯æ‰èƒ½æ‹¿åˆ°è‡ªå·±çš„fcm_token, è€Œservice workerè¢«å”¤é†’åçš„ç¬¬ä¸€ä¸ªäº‹ä»¶å¾ªç¯å°±è¦å¤„ç†æ¶ˆæ¯äº†ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡è¢«å”¤é†’æ—¶æ˜¯ä¸çŸ¥é“è‡ªå·±fcm_tokençš„ã€‚</p><p>è¿˜æœ‰ä¸€ç‚¹ï¼Œfcm jsè¦æ±‚ä½ å¿…é¡»å¯¹æ”¶åˆ°çš„pushå¼¹çª—ï¼Œå¦åˆ™ä»–ä¼šå¸®ä½ å¼¹çª—ï¼Œæœ‰çŸ¥é“æ€ä¹ˆè§£å†³çš„å‘Šè¯‰æˆ‘ä¸€ä¸‹ã€‚ã€‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;FcmçœŸæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œå¸Œæœ›ä½ ä¹Ÿæœ‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Firebase" scheme="https://htchz.cc/categories/Firebase/"/>
    
    
      <category term="æ•°æ®åˆ†ç‰‡" scheme="https://htchz.cc/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87/"/>
    
  </entry>
  
  <entry>
    <title>[Dubbo]Dubbo SPI æœºåˆ¶</title>
    <link href="https://htchz.cc/2436052280.html"/>
    <id>https://htchz.cc/2436052280.html</id>
    <published>2019-03-25T03:44:00.000Z</published>
    <updated>2019-03-25T09:16:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>ä¹‹å‰ä¸€ç¯‡<a href="./754409717.html">[JavaåŸºç¡€]Javaçš„SPIæœºåˆ¶</a>è®²åˆ°Java spiçš„ç¼ºé™·æ˜¯åœ¨æŸ¥æ‰¾æ‰€éœ€å®ç°çš„æ—¶å€™ï¼Œä¼šå®ä¾‹åŒ–æ— å…³çš„å®ç°ï¼Œé‚£ä¹ˆè¿™ç¯‡çœ‹çœ‹Dubboæ˜¯æ€ä¹ˆè§„é¿è¿™ä¸ªé—®é¢˜çš„ã€‚</p><h1 id="Dubbo-spiçš„ç‰¹ç‚¹">2. Dubbo spiçš„ç‰¹ç‚¹</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SPI &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * default extension name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºé…ç½®æ–‡ä»¶æ˜¯ä»¥key-valueé…ç½®çš„ï¼Œè¿™é‡Œå¯ä»¥ä¸ºSPIæ¥å£æŒ‡å®šä¸€ä¸ªé»˜è®¤å®ç°çš„key</p><p><strong>Dubbo spiæœ‰ä»¥ä¸‹ç‰¹ç‚¹</strong></p><ol><li>ä¸éœ€è¦éå†æ‰€æœ‰å®ä¾‹åŒ–æ‰€æœ‰å®ç°ç±»</li><li>å¢åŠ äº†å¯¹æ‰©å±•ç‚¹IoCå’ŒAOPçš„æ”¯æŒï¼Œä¸€ä¸ªæ‰©å±•ç‚¹å¯ä»¥ç›´æ¥setteræ³¨å…¥å…¶å®ƒæ‰©å±•ç‚¹ã€‚</li></ol><h1 id="Demo">3. Demo</h1><p>æ¥å£,éœ€è¦åŠ ä¸Š<code>org.apache.dubbo.common.extension.SPI</code>æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRunner</span> <span class="keyword">implements</span> <span class="title">Runner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"I'm a DefaultRunner"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcitedRunner</span> <span class="keyword">implements</span> <span class="title">Runner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"I'm a ExcitedRunner!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨èµ„æºç›®å½•<code>META-INF/dubbo</code>ä¸‹åˆ›å»ºæ–‡ä»¶<code>com.htc.learning.api.Runner</code></p><p><img src="/images/pasted-172.png" alt="upload successful"></p><p>å†…å®¹æ˜¯ä¸€è¡Œä¸€è¡Œçš„é”®å€¼å¯¹ï¼Œvalueæ˜¯å®ç°ç±»ï¼Œæˆ‘ä»¬åªè¦é€šè¿‡keyå°±èƒ½ç›´æ¥æ‹¿åˆ°æ‰€éœ€ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span>=com.htc.learning.api.impl.DefaultRunner</span><br><span class="line">excited=com.htc.learning.api.impl.ExcitedRunner</span><br></pre></td></tr></table></figure><p>æµ‹è¯•æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dubboSpiTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ExtensionLoader&lt;Runner&gt; extensionLoader = ExtensionLoader.getExtensionLoader(Runner.class);</span><br><span class="line">    Runner defaultRunner = extensionLoader.getExtension(<span class="string">"default"</span>);</span><br><span class="line">    defaultRunner.run(<span class="string">"htc"</span>);</span><br><span class="line">    Runner excitedRunner = extensionLoader.getExtension(<span class="string">"excited"</span>);</span><br><span class="line">    excitedRunner.run(<span class="string">"htc"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><pre><code>2019-03-23 12:20:50.681  INFO   --- [           main] com.htc.learning.api.impl.DefaultRunner  : I&apos;m a DefaultRunner2019-03-23 12:20:50.681  INFO   --- [           main] com.htc.learning.api.impl.ExcitedRunner  : I&apos;m a ExcitedRunner!</code></pre><h1 id="åŸç†">4. åŸç†</h1><h2 id="getExtensionLoader">4.1. getExtensionLoader</h2><p>Dubbo spiä¸java spiçš„<code>ServiceLoader</code>å¯¹åº”çš„ï¼Œæ˜¯<code>ExtensionLoader</code>ã€‚ä¸åŒäº<code>ServiceLoader</code>çš„<code>load</code>æ–¹æ³•æ¯æ¬¡è¿”å›éƒ½è¦å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œ<code>ExtensionLoader</code>æ¯æ¬¡<code>getExtensionLoader</code>ä¼šè¿›è¡Œç¼“å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ExtensionLoader&lt;T&gt; <span class="title">getExtensionLoader</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension type == null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!type.isInterface()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension type("</span> + type + <span class="string">") is not interface!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!withExtensionAnnotation(type)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension type("</span> + type +</span><br><span class="line">                <span class="string">") is not extension, because WITHOUT @"</span> + SPI.class.getSimpleName() + <span class="string">" Annotation!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span><br><span class="line">    <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        EXTENSION_LOADERS.putIfAbsent(type, <span class="keyword">new</span> ExtensionLoader&lt;T&gt;(type));</span><br><span class="line">        loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> loader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ExtensionLoader</code>æ„é€ å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ExtensionLoader</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.type = type;</span><br><span class="line">    objectFactory = (type == ExtensionFactory.class ? <span class="keyword">null</span> : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>objectFactory</code>æ˜¯ä¸€ä¸ªæ¥å£,ä¸IOCç›¸å…³ï¼Œè¯¥æ¥å£æ ¹æ®typeå’Œnameæ‰¾åˆ°ä¸€ä¸ªbeanï¼Œè¿™ä¸ªbeanå¯ä»¥æ˜¯Springçš„beanï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªdubbo spiå®ç°ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExtensionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get extension.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type object type.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name object name.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¹Ÿæ˜¯ä¸€ä¸ªSPIæ¥å£ï¼Œæ¥ä¸‹æ¥è°ƒç”¨çš„<code>getExtensionLoader</code>é€»è¾‘å°±æ˜¯é€šè¿‡ä»–å®ç°çš„ã€‚</p><h2 id="getExtension">4.2. getExtension</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension name == null"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"true"</span>.equals(name)) &#123;</span><br><span class="line">        <span class="comment">// è·å–é»˜è®¤çš„æ‹“å±•å®ç°ç±»</span></span><br><span class="line">        <span class="keyword">return</span> getDefaultExtension();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Holderï¼Œé¡¾åæ€ä¹‰ï¼Œç”¨äºæŒæœ‰ç›®æ ‡å¯¹è±¡</span></span><br><span class="line">    Holder&lt;Object&gt; holder = cachedInstances.get(name);</span><br><span class="line">    <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cachedInstances.putIfAbsent(name, <span class="keyword">new</span> Holder&lt;Object&gt;());</span><br><span class="line">        holder = cachedInstances.get(name);</span><br><span class="line">    &#125;</span><br><span class="line">    Object instance = holder.get();</span><br><span class="line">    <span class="comment">// åŒé‡æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (holder) &#123;</span><br><span class="line">            instance = holder.get();</span><br><span class="line">            <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// åˆ›å»ºæ‹“å±•å®ä¾‹</span></span><br><span class="line">                instance = createExtension(name);</span><br><span class="line">                <span class="comment">// è®¾ç½®å®ä¾‹åˆ° holder ä¸­</span></span><br><span class="line">                holder.set(instance);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½æ‰€æœ‰çš„æ‹“å±•ç±»ï¼Œå¯å¾—åˆ°â€œé…ç½®é¡¹åç§°â€åˆ°â€œé…ç½®ç±»â€çš„æ˜ å°„å…³ç³»è¡¨</span></span><br><span class="line">    Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> findException(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        T instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡åå°„åˆ›å»ºå®ä¾‹</span></span><br><span class="line">            EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());</span><br><span class="line">            instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‘å®ä¾‹ä¸­æ³¨å…¥ä¾èµ–</span></span><br><span class="line">        injectExtension(instance);</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</span><br><span class="line">        <span class="keyword">if</span> (wrapperClasses != <span class="keyword">null</span> &amp;&amp; !wrapperClasses.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// å¾ªç¯åˆ›å»º Wrapper å®ä¾‹</span></span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</span><br><span class="line">                <span class="comment">// å°†å½“å‰ instance ä½œä¸ºå‚æ•°ä¼ ç»™ Wrapper çš„æ„é€ æ–¹æ³•ï¼Œå¹¶é€šè¿‡åå°„åˆ›å»º Wrapper å®ä¾‹ã€‚</span></span><br><span class="line">                <span class="comment">// ç„¶åå‘ Wrapper å®ä¾‹ä¸­æ³¨å…¥ä¾èµ–ï¼Œæœ€åå°† Wrapper å®ä¾‹å†æ¬¡èµ‹å€¼ç»™ instance å˜é‡</span></span><br><span class="line">                instance = injectExtension(</span><br><span class="line">                    (T) wrapperClass.getConstructor(type).newInstance(instance));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŒ‰é€»è¾‘å¯ä»¥æ‹†åˆ†æˆå››æ­¥</p><ol><li><code>getExtensionClasses()</code>è·å–æ¥å£çš„æ‰€æœ‰å®ç°ç±»ã€‚è¿™ä¸ªæ–¹æ³•ä¼šåœ¨å¾ˆå¤šåœ°æ–¹è¢«è°ƒç”¨ï¼Œä¿è¯æ‰€æœ‰ç±»è¢«è·å–åˆ°ã€‚ç”±äºå¤šæ¬¡è°ƒç”¨ç¼“å­˜ä¹Ÿæ˜¯å¿…é¡»çš„ã€‚</li><li>å®ä¾‹åŒ–ç›®æ ‡ç±»çš„å¯¹è±¡ã€‚</li><li>IOCæ³¨å…¥ã€‚æ³¨å…¥å…¶ä»–SPIå®ç°ã€‚</li><li>AOPå®ç°ã€‚å¦‚æœéœ€è¦ï¼ŒæŠŠå¯¹è±¡å®ä¾‹åŒ…è£¹åœ¨Wrapperä¸­ã€‚</li></ol><h3 id="getExtensionClasses">4.2.1. getExtensionClasses</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line">    <span class="comment">// ä»ç¼“å­˜ä¸­è·å–å·²åŠ è½½çš„æ‹“å±•ç±»</span></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span><br><span class="line">    <span class="comment">// åŒé‡æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (cachedClasses) &#123;</span><br><span class="line">            classes = cachedClasses.get();</span><br><span class="line">            <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// åŠ è½½æ‹“å±•ç±»</span></span><br><span class="line">                classes = loadExtensionClasses();</span><br><span class="line">                cachedClasses.set(classes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¸å‹çš„åŒé‡æ ¡éªŒï¼Œè¿™é‡Œçš„ç¼“å­˜keyæ˜¯å®ç°ç±»çš„keyï¼Œå€¼å°±æ˜¯å®ç°ç±»äº†ã€‚å¦‚æœç¼“å­˜ä¸º<code>null</code>ï¼Œè°ƒç”¨<code>loadExtensionClasses</code>åˆå§‹åŒ–ç¼“å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// synchronized in getExtensionClasses</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123;</span><br><span class="line">    <span class="keyword">final</span> SPI defaultAnnotation = type.getAnnotation(SPI.class);</span><br><span class="line">    <span class="keyword">if</span> (defaultAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè®¾ç½®äº†é»˜è®¤å®ç°ï¼Œå°±ç¼“å­˜ä»¥ä¸‹è¿™ä¸ªé»˜è®¤å®ç°çš„key</span></span><br><span class="line">        String value = defaultAnnotation.value();</span><br><span class="line">        <span class="keyword">if</span> ((value = value.trim()).length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String[] names = NAME_SEPARATOR.split(value);</span><br><span class="line">            <span class="keyword">if</span> (names.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"more than 1 default extension name on extension "</span> + type.getName()</span><br><span class="line">                        + <span class="string">": "</span> + Arrays.toString(names));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (names.length == <span class="number">1</span>) &#123;</span><br><span class="line">                cachedDefaultName = names[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = <span class="keyword">new</span> HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line">    loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY, type.getName());</span><br><span class="line">    loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY, type.getName().replace(<span class="string">"org.apache"</span>, <span class="string">"com.alibaba"</span>));</span><br><span class="line">    loadDirectory(extensionClasses, DUBBO_DIRECTORY, type.getName());</span><br><span class="line">    loadDirectory(extensionClasses, DUBBO_DIRECTORY, type.getName().replace(<span class="string">"org.apache"</span>, <span class="string">"com.alibaba"</span>));</span><br><span class="line">    loadDirectory(extensionClasses, SERVICES_DIRECTORY, type.getName());</span><br><span class="line">    loadDirectory(extensionClasses, SERVICES_DIRECTORY, type.getName().replace(<span class="string">"org.apache"</span>, <span class="string">"com.alibaba"</span>));</span><br><span class="line">    <span class="keyword">return</span> extensionClasses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>java spiçš„é…ç½®åªèƒ½æ”¾åœ¨ä¸€ä¸ªç›®å½•<code>META-INF/services/</code>,dubbo spiçš„é…ç½®å¯ä»¥æ”¾åœ¨ä¸‰ä¸ªç›®å½•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICES_DIRECTORY = <span class="string">"META-INF/services/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_DIRECTORY = <span class="string">"META-INF/dubbo/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + <span class="string">"internal/"</span>;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä¾èµ–æˆ‘ç”¨çš„æ˜¯apache-dubboï¼Œç›¸å¯¹äºalibaba-dubboä¸‰ä¸ªç›®å½•ï¼Œä¼°è®¡ä¸ºäº†å…¼å®¹ï¼Œapache-dubboç‰ˆæœ¬çš„<code>loadDirectory</code>æ–¹æ³•è¿›è¡Œäº†ä¸€ä¸ªåŒ…åçš„æ›¿æ¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadDirectory</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// fileName = æ–‡ä»¶å¤¹è·¯å¾„ + type å…¨é™å®šå </span></span><br><span class="line">    String fileName = dir + type.getName();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Enumeration&lt;java.net.URL&gt; urls;</span><br><span class="line">        ClassLoader classLoader = findClassLoader();</span><br><span class="line">        <span class="comment">// æ ¹æ®æ–‡ä»¶ååŠ è½½æ‰€æœ‰çš„åŒåæ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            urls = classLoader.getResources(fileName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            urls = ClassLoader.getSystemResources(fileName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (urls != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">                java.net.URL resourceURL = urls.nextElement();</span><br><span class="line">                <span class="comment">// åŠ è½½èµ„æº</span></span><br><span class="line">                loadResource(extensionClasses, classLoader, resourceURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        logger.error(<span class="string">"..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥â€œçœŸÂ·è¯»å–é…ç½®æ–‡ä»¶â€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadResource</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, </span></span></span><br><span class="line"><span class="function"><span class="params">ClassLoader classLoader, java.net.URL resourceURL)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(</span><br><span class="line">            <span class="keyword">new</span> InputStreamReader(resourceURL.openStream(), <span class="string">"utf-8"</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="comment">// æŒ‰è¡Œè¯»å–é…ç½®å†…å®¹</span></span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å®šä½ # å­—ç¬¦</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> ci = line.indexOf(<span class="string">'#'</span>);</span><br><span class="line">                <span class="keyword">if</span> (ci &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// æˆªå– # ä¹‹å‰çš„å­—ç¬¦ä¸²ï¼Œ# ä¹‹åçš„å†…å®¹ä¸ºæ³¨é‡Šï¼Œéœ€è¦å¿½ç•¥</span></span><br><span class="line">                    line = line.substring(<span class="number">0</span>, ci);</span><br><span class="line">                &#125;</span><br><span class="line">                line = line.trim();</span><br><span class="line">                <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        String name = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">int</span> i = line.indexOf(<span class="string">'='</span>);</span><br><span class="line">                        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// ä»¥ç­‰äºå· = ä¸ºç•Œï¼Œæˆªå–é”®ä¸å€¼</span></span><br><span class="line">                            name = line.substring(<span class="number">0</span>, i).trim();</span><br><span class="line">                            line = line.substring(i + <span class="number">1</span>).trim();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// åŠ è½½ç±»ï¼Œå¹¶é€šè¿‡ loadClass æ–¹æ³•å¯¹ç±»è¿›è¡Œç¼“å­˜</span></span><br><span class="line">                            loadClass(extensionClasses, resourceURL, </span><br><span class="line">                                      Class.forName(line, <span class="keyword">true</span>, classLoader), name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                        IllegalStateException e = <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to load extension class..."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            reader.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        logger.error(<span class="string">"Exception when load extension class..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»å®Œé…ç½®æ–‡ä»¶ï¼Œä¸‹é¢ä¸å•æ˜¯å¯¹ç±»è¿›è¡ŒåŠ è½½ï¼Œè€Œä¸”è¿˜å¯¹<code>Adaptive</code>ã€<code>Wrapper</code>ç±»è¿›è¡Œç¼“å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadClass</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, java.net.URL resourceURL, Class&lt;?&gt; clazz, String name)</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!type.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Error when load extension class(interface: "</span> +</span><br><span class="line">                type + <span class="string">", class line: "</span> + clazz.getName() + <span class="string">"), class "</span></span><br><span class="line">                + clazz.getName() + <span class="string">"is not subtype of interface."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åªèƒ½æœ‰ä¸€ä¸ªè‡ªé€‚åº”å®ç°ç±»</span></span><br><span class="line">    <span class="keyword">if</span> (clazz.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cachedAdaptiveClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            cachedAdaptiveClass = clazz;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!cachedAdaptiveClass.equals(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isWrapperClass(clazz)) &#123;</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses;</span><br><span class="line">        <span class="keyword">if</span> (wrappers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            cachedWrapperClasses = <span class="keyword">new</span> ConcurrentHashSet&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">            wrappers = cachedWrapperClasses;</span><br><span class="line">        &#125;</span><br><span class="line">        wrappers.add(clazz);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        clazz.getConstructor();</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            name = findAnnotationName(clazz);</span><br><span class="line">            <span class="keyword">if</span> (name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] names = NAME_SEPARATOR.split(name);</span><br><span class="line">        <span class="keyword">if</span> (names != <span class="keyword">null</span> &amp;&amp; names.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Activate activate = clazz.getAnnotation(Activate.class);</span><br><span class="line">            <span class="keyword">if</span> (activate != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cachedActivates.put(names[<span class="number">0</span>], activate);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// support com.alibaba.dubbo.common.extension.Activate</span></span><br><span class="line">                com.alibaba.dubbo.common.extension.Activate oldActivate = clazz.getAnnotation(com.alibaba.dubbo.common.extension.Activate.class);</span><br><span class="line">                <span class="keyword">if</span> (oldActivate != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    cachedActivates.put(names[<span class="number">0</span>], oldActivate);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String n : names) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!cachedNames.containsKey(clazz)) &#123;</span><br><span class="line">                    cachedNames.put(clazz, n);</span><br><span class="line">                &#125;</span><br><span class="line">                Class&lt;?&gt; c = extensionClasses.get(n);</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    extensionClasses.put(n, clazz);</span><br><span class="line">                <span class="comment">// å®ç°ç±»é‡å¤æŠ¥é”™</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c != clazz) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦æ³¨æ„çš„å‡ ç‚¹ï¼š</p><ol><li><code>@Adaptive</code>æ³¨è§£æ˜¯æ ‡æ˜ä¸€ä¸ªSPIå®ç°ç±»æ˜¯å±äºè‡ªé€‚åº”ç±»ï¼Œä¸€ä¸ªSPIæ¥å£åªèƒ½æœ‰ä¸€ä¸ªè‡ªé€‚åº”å®ç°ï¼Œè¿™ä»ä»£ç é€»è¾‘å¯ä»¥çœ‹å‡ºæ¥ï¼Œå¦‚æœ<code>!cachedAdaptiveClass.equals(clazz)</code>åˆ™æŠ¥é”™ã€‚å…·ä½“è¿™ä¸ªè‡ªé€‚åº”ç±»å¯ä»¥åšä»€ä¹ˆï¼Œä¸‹é¢ä¼šè¯´ã€‚</li><li><code>Wrapper</code>ç±»æ˜¯AOPç±»</li><li>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª<code>@Active</code>æ³¨è§£ï¼Œæ ‡æ˜å®ç°ç±»çš„æ¿€æ´»æ¡ä»¶ï¼Œæ˜¯ä¸€ç§æ¡ä»¶æœºåˆ¶ã€‚</li></ol><h3 id="IOC">4.2.2. IOC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">injectExtension</span><span class="params">(T instance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (objectFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Method method : instance.getClass().getMethods()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (method.getName().startsWith(<span class="string">"set"</span>)</span><br><span class="line">                        &amp;&amp; method.getParameterTypes().length == <span class="number">1</span></span><br><span class="line">                        &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * Check &#123;<span class="doctag">@link</span> DisableInject&#125; to see if we need auto injection for this property</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> (method.getAnnotation(DisableInject.class) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">if</span> (ReflectUtils.isPrimitives(pt)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        String property = method.getName().length() &gt; <span class="number">3</span> ? method.getName().substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + method.getName().substring(<span class="number">4</span>) : <span class="string">""</span>;</span><br><span class="line">                        Object object = objectFactory.getExtension(pt, property);</span><br><span class="line">                        <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            method.invoke(instance, object);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        logger.error(<span class="string">"fail to inject via method "</span> + method.getName()</span><br><span class="line">                                + <span class="string">" of interface "</span> + type.getName() + <span class="string">": "</span> + e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dubboçš„IOCç›®å‰åªå¯¹setteræ–¹æ³•æ”¯æŒï¼Œå¦‚æœsetçš„æ–¹æ³•å‚æ•°åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆå°±æ‹¿å‚æ•°ç±»å‹<code>pt</code>å’ŒsetPropertyçš„<code>property</code>å»<code>objectFactory</code>æ‰¾ã€‚<code>objectFactory</code>æ˜¯<code>ExtensionFactory</code>æ¥å£ï¼Œæœ‰ä¸¤ä¸ªå®ç°ï¼Œ</p><p>ä¸Šé¢æåˆ°<code>ExtensionLoader</code>æ„é€ å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ExtensionLoader</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.type = type;</span><br><span class="line">    objectFactory = (type == ExtensionFactory.class ? <span class="keyword">null</span> : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>getAdaptiveExtension()</code>æ˜¯ä»€ä¹ˆï¼Ÿ</p><h3 id="Adaptive">4.2.3. @Adaptive</h3><p><code>getAdaptiveExtension()</code>çš„å®ç°å¦‚ä¸‹ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getAdaptiveExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object instance = cachedAdaptiveInstance.get();</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (createAdaptiveInstanceError == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (cachedAdaptiveInstance) &#123;</span><br><span class="line">                instance = cachedAdaptiveInstance.get();</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        instance = createAdaptiveExtension();</span><br><span class="line">                        cachedAdaptiveInstance.set(instance);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                        createAdaptiveInstanceError = t;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dubboçš„Adaptiveæœºåˆ¶å¦‚ä¸‹</p><ol><li>å¦‚æœä¸€ä¸ªSPIæ¥å£å®ç°ç±»å­˜åœ¨è‡ªé€‚åº”å®ç°ï¼Œé‚£ä¹ˆç›´æ¥æ‹¿è¿™ä¸ªç±»ï¼›</li><li>å¦åˆ™åŠ¨æ€åˆ›å»ºè‡ªé€‚åº”ç±»(æ‰‹åŠ¨æ‹¼æ¥ä»£ç å­—ç¬¦ï¼Œå¹¶è½¬ä¸ºå­—èŠ‚ç ï¼ŒåŠ è½½åˆ°jvmä¸­)ï¼Œç”±äºdubboæ˜¯ä»¥urlä¸ºåè®®çš„ï¼Œæ‰€ä»¥åˆ›å»ºçš„è‡ªé€‚åº”ä»£ç æ˜¯æ ¹æ®urlä¸­çš„å†…å®¹å†³å®šä½¿ç”¨é‚£ç§å®ç°ã€‚</li></ol><p>ä¸‹é¢æ˜¯alibaba dubbo çš„ä¸­æ–‡æ³¨é‡Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Adaptive &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»&#123;<span class="doctag">@link</span> URL&#125;çš„Keyåï¼Œå¯¹åº”çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåã€‚</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * å¦‚æœ&#123;<span class="doctag">@link</span> URL&#125;è¿™äº›Keyéƒ½æ²¡æœ‰Valueï¼Œä½¿ç”¨ ç”¨ ç¼ºçœçš„æ‰©å±•ï¼ˆåœ¨æ¥å£çš„&#123;<span class="doctag">@link</span> SPI&#125;ä¸­è®¾å®šçš„å€¼ï¼‰ã€‚&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * æ¯”å¦‚ï¼Œ&lt;code&gt;String[] &#123;"key1", "key2"&#125;&lt;/code&gt;ï¼Œè¡¨ç¤º</span></span><br><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;å…ˆåœ¨URLä¸Šæ‰¾key1çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåï¼›</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;key1æ²¡æœ‰Valueï¼Œåˆ™ä½¿ç”¨key2çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåã€‚</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;key2æ²¡æœ‰Valueï¼Œä½¿ç”¨ç¼ºçœçš„æ‰©å±•ã€‚</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;å¦‚æœæ²¡æœ‰è®¾å®šç¼ºçœæ‰©å±•ï¼Œåˆ™æ–¹æ³•è°ƒç”¨ä¼šæŠ›å‡º&#123;<span class="doctag">@link</span> IllegalStateException&#125;ã€‚</span></span><br><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * å¦‚æœä¸è®¾ç½®åˆ™ç¼ºçœä½¿ç”¨Extensionæ¥å£ç±»åçš„ç‚¹åˆ†éš”å°å†™å­—ä¸²ã€‚&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * å³å¯¹äºExtensionæ¥å£&#123;<span class="doctag">@code</span> com.alibaba.dubbo.xxx.YyyInvokerWrapper&#125;çš„ç¼ºçœå€¼ä¸º&lt;code&gt;String[] &#123;"yyy.invoker.wrapper"&#125;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SPI#value()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ@Adaptiveä¸Šçš„keyä»urlè·å–ä¸åˆ°ï¼Œå°±ä»¥@SPIä¸Šçš„é»˜è®¤æ‰©å±•å€¼ä½œä¸ºkeyå»urlæ‰¾ï¼Œå¦‚æœ@SPIéƒ½æ²¡é»˜è®¤å€¼ï¼Œå°±å°†æ¥å£ç±»åç”¨<code>.</code>åˆ†éš”ï¼Œä½œä¸ºæ¥å£ç¼ºçœå€¼ï¼ˆè¿™ä¹ˆå¥‡æ€ªçš„keyå— =ã€‚=ï¼‰</p><p>ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"dubbo"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Protocol</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive</span></span><br><span class="line">    &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive</span></span><br><span class="line">    &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Protocol protocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension();</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè¿”å›ä¸€ä¸ª<code>Protocol$Adaptive</code>ç±»ï¼Œå› ä¸º<code>Protocol</code>æ²¡æœ‰ä¸€ä¸ªè‡ªé€‚åº”å®ç°ç±»ï¼Œæ‰€ä»¥dubboåŠ¨æ€ç”Ÿæˆäº†ä¸€ä¸ªè‡ªé€‚åº”ç±»ï¼Œé€šè¿‡debugå¾—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.dubbo.rpc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.ExtensionLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Protocol</span>$<span class="title">Adaptive</span> <span class="keyword">implements</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">dubbo</span>.<span class="title">rpc</span>.<span class="title">Protocol</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"method public abstract void org.apache.dubbo.rpc.Protocol.destroy() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"method public abstract int org.apache.dubbo.rpc.Protocol.getDefaultPort() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> org.apache.dubbo.rpc.<span class="function">Exporter <span class="title">export</span><span class="params">(org.apache.dubbo.rpc.Invoker arg0)</span> <span class="keyword">throws</span> org.apache.dubbo.rpc.RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"org.apache.dubbo.rpc.Invoker argument == null"</span>);</span><br><span class="line">        <span class="keyword">if</span> (arg0.getUrl() == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"org.apache.dubbo.rpc.Invoker argument getUrl() == null"</span>);</span><br><span class="line">        org.apache.dubbo.common.URL url = arg0.getUrl();</span><br><span class="line">        <span class="comment">// è¿™é‡Œé»˜è®¤ä½¿ç”¨dubbo</span></span><br><span class="line">        String extName = (url.getProtocol() == <span class="keyword">null</span> ? <span class="string">"dubbo"</span> : url.getProtocol());</span><br><span class="line">        <span class="keyword">if</span> (extName == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(org.apache.dubbo.rpc.Protocol) name from url("</span> + url.toString() + <span class="string">") use keys([protocol])"</span>);</span><br><span class="line">        org.apache.dubbo.rpc.Protocol extension = (org.apache.dubbo.rpc.Protocol) ExtensionLoader.getExtensionLoader(org.apache.dubbo.rpc.Protocol.class).getExtension(extName);</span><br><span class="line">        <span class="keyword">return</span> extension.export(arg0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> org.apache.dubbo.rpc.<span class="function">Invoker <span class="title">refer</span><span class="params">(java.lang.Class arg0, org.apache.dubbo.common.URL arg1)</span> <span class="keyword">throws</span> org.apache.dubbo.rpc.RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arg1 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br><span class="line">        org.apache.dubbo.common.URL url = arg1;</span><br><span class="line">        <span class="comment">// è¿™é‡Œé»˜è®¤ä½¿ç”¨dubbo</span></span><br><span class="line">        String extName = (url.getProtocol() == <span class="keyword">null</span> ? <span class="string">"dubbo"</span> : url.getProtocol());</span><br><span class="line">        <span class="keyword">if</span> (extName == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(org.apache.dubbo.rpc.Protocol) name from url("</span> + url.toString() + <span class="string">") use keys([protocol])"</span>);</span><br><span class="line">        org.apache.dubbo.rpc.Protocol extension = (org.apache.dubbo.rpc.Protocol) ExtensionLoader.getExtensionLoader(org.apache.dubbo.rpc.Protocol.class).getExtension(extName);</span><br><span class="line">        <span class="keyword">return</span> extension.refer(arg0, arg1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>Protocol$Adaptive</code>ä»£ç é‡Œï¼Œå¦‚æœæ¥å£æ–¹æ³•æ²¡æœ‰è®¾ç½®<code>@Adaptive</code>æ³¨è§£ï¼Œä»¥æŠ›å¼‚å¸¸å¤„ç†ã€‚</p><p>åœ¨ç”Ÿæˆçš„æ–¹æ³•ä¸­ï¼Œä»¥<code>protocol</code>ä¸ºkeyå»urlé‡ŒæŸ¥æ‰¾è¿™ä¸ªkeyçš„å€¼ï¼Œå¦‚æœurlé‡Œæ²¡æœ‰è®¾ç½®ï¼Œå°±ä»¥<code>Protocol</code>æ¥å£ä¸Šçš„@SPIæ³¨è§£é»˜è®¤å€¼â€”â€”â€œdubboâ€ä½œä¸ºè‡ªé€‚åº”ç±»è¦æ‰¾çš„æ‰©å±•çš„nameã€‚</p><blockquote><p>åˆ›å»ºcodeä»£ç å¤ªé•¿ï¼Œä¸è´´ã€‚</p></blockquote><p>æ‹¿<code>ExtensionFactory</code>æ¥è¯´ï¼Œä»–æœ‰ä¸‰ä¸ªå®ç°ï¼ˆæœ‰ä¸€ä¸ªåºŸå¼ƒçš„ï¼‰</p><p><img src="/images/pasted-173.png" alt="upload successful"></p><p>ä¸€ä¸ªè‡ªé€‚åº”å®ç°ç±»ï¼Œä»¥<code>@Adaptive</code>æ ‡æ³¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Adaptive</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdaptiveExtensionFactory</span> <span class="keyword">implements</span> <span class="title">ExtensionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ExtensionFactory&gt; factories;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AdaptiveExtensionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ExtensionLoader&lt;ExtensionFactory&gt; loader = ExtensionLoader.getExtensionLoader(ExtensionFactory.class);</span><br><span class="line">        List&lt;ExtensionFactory&gt; list = <span class="keyword">new</span> ArrayList&lt;ExtensionFactory&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String name : loader.getSupportedExtensions()) &#123;</span><br><span class="line">            list.add(loader.getExtension(name));</span><br><span class="line">        &#125;</span><br><span class="line">        factories = Collections.unmodifiableList(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (ExtensionFactory factory : factories) &#123;</span><br><span class="line">            T extension = factory.getExtension(type, name);</span><br><span class="line">            <span class="keyword">if</span> (extension != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> extension;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªç”¨äºè·å–dubbo Spiå®ç°ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpiExtensionFactory</span> <span class="keyword">implements</span> <span class="title">ExtensionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type.isInterface() &amp;&amp; type.isAnnotationPresent(SPI.class)) &#123;</span><br><span class="line">            ExtensionLoader&lt;T&gt; loader = ExtensionLoader.getExtensionLoader(type);</span><br><span class="line">            <span class="keyword">if</span> (!loader.getSupportedExtensions().isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> loader.getAdaptiveExtension();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæ˜¯ç”¨äºè·å–Springçš„beanï¼Œä»£ç å¤ªé•¿ä¸è´´</p><h3 id="Active">4.2.4. @Active</h3><p>@Activeæ³¨è§£ç”¨äºå®ç°ç±»ä¸Šï¼Œè¡¨ç¤ºä¸€äº›æ¿€æ´»æ¡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Activate &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Activate the current extension when one of the groups matches. The group passed into</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ExtensionLoader#getActivateExtension(URL, String, String)&#125; will be used for matching.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> group names to match</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ExtensionLoader#getActivateExtension(URL, String, String)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] group() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Activate the current extension when the specified keys appear in the URL's parameters.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * For example, given &lt;code&gt;<span class="doctag">@Activate</span>("cache, validation")&lt;/code&gt;, the current extension will be return only when</span></span><br><span class="line"><span class="comment">     * there's either &lt;code&gt;cache&lt;/code&gt; or &lt;code&gt;validation&lt;/code&gt; key appeared in the URL's parameters.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> URL parameter keys</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ExtensionLoader#getActivateExtension(URL, String)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ExtensionLoader#getActivateExtension(URL, String, String)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Relative ordering info, optional</span></span><br><span class="line"><span class="comment">     * Deprecated since 2.7.0</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> extension list which should be put before the current one</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    String[] before() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Relative ordering info, optional</span></span><br><span class="line"><span class="comment">     * Deprecated since 2.7.0</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> extension list which should be put after the current one</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    String[] after() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Absolute ordering info, optional</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> absolute ordering info</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">order</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·ç”±äºdubboæ˜¯é¢å‘urlçš„åè®®ï¼Œæ‰€ä»¥è¿™äº›æ¿€æ´»æ¡ä»¶éœ€è¦é€šè¿‡urlåŒ¹é…ã€‚</p><p>åœ¨åŠ è½½ç±»çš„æ—¶å€™ï¼Œæœ‰è¿™ä¹ˆå‡ è¡Œä»£ç ï¼Œä»¥æ‰©å±•åå­—ä¸ºkeyï¼Œä»¥æ‰©å±•ä¸Šçš„æ³¨è§£ä¸ºå€¼è¿›è¡Œmapç¼“å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.dubbo.common.extension.ExtensionLoader#loadClass</span></span><br><span class="line">Activate activate = clazz.getAnnotation(Activate.class);</span><br><span class="line"><span class="keyword">if</span> (activate != <span class="keyword">null</span>) &#123;</span><br><span class="line">    cachedActivates.put(names[<span class="number">0</span>], activate);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// support com.alibaba.dubbo.common.extension.Activate</span></span><br><span class="line">    com.alibaba.dubbo.common.extension.Activate oldActivate = clazz.getAnnotation(com.alibaba.dubbo.common.extension.Activate.class);</span><br><span class="line">    <span class="keyword">if</span> (oldActivate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        cachedActivates.put(names[<span class="number">0</span>], oldActivate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–æ¿€æ´»çš„çš„æ‰©å±•å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getActivateExtension(url, key, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is equivalent to &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *     getActivateExtension(url, values, null);</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url    url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> values extension point names</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> extension list which are activated</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getActivateExtension(com.alibaba.dubbo.common.URL, String[], String)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String[] values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getActivateExtension(url, values, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is equivalent to &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *     getActivateExtension(url, url.getParameter(key).split(","), null);</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url   url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key   url parameter key which used to get extension point names</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> group group</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> extension list which are activated.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getActivateExtension(com.alibaba.dubbo.common.URL, String[], String)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String key, String group)</span> </span>&#123;</span><br><span class="line">    String value = url.getParameter(key);</span><br><span class="line">    <span class="keyword">return</span> getActivateExtension(url, value == <span class="keyword">null</span> || value.length() == <span class="number">0</span> ? <span class="keyword">null</span> : Constants.COMMA_SPLIT_PATTERN.split(value), group);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get activate extensions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url    url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> values extension point names</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> group  group</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> extension list which are activated</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> com.alibaba.dubbo.common.extension.Activate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String[] values, String group)</span> </span>&#123;</span><br><span class="line">    List&lt;T&gt; exts = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">    List&lt;String&gt; names = values == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;String&gt;(<span class="number">0</span>) : Arrays.asList(values);</span><br><span class="line">    <span class="keyword">if</span> (!names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) &#123;</span><br><span class="line">        getExtensionClasses();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Activate&gt; entry : cachedActivates.entrySet()) &#123;</span><br><span class="line">            String name = entry.getKey();</span><br><span class="line">            Activate activate = entry.getValue();</span><br><span class="line">            <span class="keyword">if</span> (isMatchGroup(group, activate.group())) &#123;</span><br><span class="line">                T ext = getExtension(name);</span><br><span class="line">                <span class="keyword">if</span> (!names.contains(name)</span><br><span class="line">                        &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name)</span><br><span class="line">                        &amp;&amp; isActive(activate, url)) &#123;</span><br><span class="line">                    exts.add(ext);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// order å€¼è¶Šå°è¶Šé å‰</span></span><br><span class="line">        Collections.sort(exts, ActivateComparator.COMPARATOR);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;T&gt; usrs = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; names.size(); i++) &#123;</span><br><span class="line">        String name = names.get(i);</span><br><span class="line">        <span class="keyword">if</span> (!name.startsWith(Constants.REMOVE_VALUE_PREFIX)</span><br><span class="line">                &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Constants.DEFAULT_KEY.equals(name)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (usrs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    exts.addAll(<span class="number">0</span>, usrs);</span><br><span class="line">                    usrs.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                T ext = getExtension(name);</span><br><span class="line">                usrs.add(ext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (usrs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        exts.addAll(usrs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> exts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">(String[] keys, URL url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (keys.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸¤æ¬¡forå¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : url.getParameters().entrySet()) &#123;</span><br><span class="line">            String k = entry.getKey();</span><br><span class="line">            String v = entry.getValue();</span><br><span class="line">            <span class="comment">// å¦‚æœkeyå­˜åœ¨ä¸”å¯¹åº”çš„valueä¸ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">if</span> ((k.equals(key) || k.endsWith(<span class="string">"."</span> + key))</span><br><span class="line">                    &amp;&amp; ConfigUtils.isNotEmpty(v)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒ¹é…æ¡ä»¶çš„é€»è¾‘æ˜¯ï¼Œå…ˆåŒ¹é…ç»„ï¼Œå†åŒ¹é…é”®ï¼Œé”®åªè¦éƒ½å­˜åœ¨å€¼ï¼Œé‚£ä¹ˆå³åŒ¹é…æˆåŠŸã€‚å½“æ³¨è§£ä¸Šorderå€¼è¶Šå°ï¼Œè¿™ä¸ªå®ç°ç±»çš„æ’åºè¶Šé å‰ã€‚</p><p>å…³äºæ’åºï¼Œè¿™é‡Œçš„ä¸€ä¸ªå…·ä½“ä¾‹å­æ˜¯DubboæœåŠ¡çš„è¿‡æ»¤å™¨å¾€å¾€åŠ ä¸Šäº†@Activeæ³¨è§£ï¼Œè¿™æ—¶å€™å¦‚æœè¦è®¾ç½®è¿‡æ»¤å™¨çš„å¤„ç†é¡ºåºï¼Œå°±å¯ä»¥é€šè¿‡è¯¥æ³¨è§£ä¸Šçš„orderå±æ€§è®¾ç½®ã€‚</p><h1 id="ç»“æŸè¯­">5. ç»“æŸè¯­</h1><p>è¿˜å·®Wrapperæœºåˆ¶æ²¡çœ‹ã€‚ã€‚å…³äºä¸‹é¢é‚£æ®µè¯æˆ‘ä¹Ÿæ²¡çœ‹åˆ°å…·ä½“çš„ä¾‹å­ã€‚</p><blockquote><p>å¦‚æœæ‰©å±•ç‚¹åŠ è½½å¤±è´¥ï¼Œè¿æ‰©å±•ç‚¹çš„åç§°éƒ½æ‹¿ä¸åˆ°äº†ã€‚æ¯”å¦‚ï¼šJDKæ ‡å‡†çš„ScriptEngineï¼Œé€šè¿‡getName();è·å–è„šæœ¬ç±»å‹çš„åç§°ï¼Œä½†å¦‚æœRubyScriptEngineå› ä¸ºæ‰€ä¾èµ–çš„jruby.jarä¸å­˜åœ¨ï¼Œå¯¼è‡´RubyScriptEngineç±»åŠ è½½å¤±è´¥ï¼Œè¿™ä¸ªå¤±è´¥åŸå› è¢«åƒæ‰äº†ï¼Œå’Œrubyå¯¹åº”ä¸èµ·æ¥ï¼Œå½“ç”¨æˆ·æ‰§è¡Œrubyè„šæœ¬æ—¶ï¼Œä¼šæŠ¥ä¸æ”¯æŒrubyï¼Œè€Œä¸æ˜¯çœŸæ­£å¤±è´¥çš„åŸå› ã€‚</p></blockquote><h1 id="å‚è€ƒ">6. å‚è€ƒ</h1><ol><li><a href="https://dubbo.apache.org/zh-cn/docs/source_code_guide/dubbo-spi.html" target="_blank" rel="noopener">Apache Dubbo SPI</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;ä¹‹å‰ä¸€ç¯‡&lt;a href=&quot;./754409717.html&quot;&gt;[JavaåŸºç¡€]Javaçš„SPIæœºåˆ¶&lt;/a&gt;è®²åˆ°Java spiçš„ç¼ºé™·æ˜¯åœ¨æŸ¥æ‰¾æ‰€éœ€å®ç°çš„æ—¶å€™ï¼Œä¼šå®ä¾‹åŒ–æ— å…³çš„å®ç°ï¼Œé‚£ä¹ˆè¿™ç¯‡çœ‹çœ‹Dubboæ˜¯æ€ä¹ˆè§„é¿è¿™ä¸ªé—®é¢˜çš„ã€‚&lt;/p&gt;

      
    
    </summary>
    
      <category term="Dubbo" scheme="https://htchz.cc/categories/Dubbo/"/>
    
    
      <category term="OOP" scheme="https://htchz.cc/tags/OOP/"/>
    
  </entry>
  
  <entry>
    <title>[Javaä»£ç†]Cglibä»£ç†</title>
    <link href="https://htchz.cc/3922793788.html"/>
    <id>https://htchz.cc/3922793788.html</id>
    <published>2019-03-10T06:03:00.000Z</published>
    <updated>2019-08-15T16:08:49.216Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Cglib">1. Cglib</h1><blockquote><p>CGLIBæ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜æ€§èƒ½çš„ä»£ç ç”ŸæˆåŒ…ã€‚CGLIBåŒ…çš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå°è€Œå¿«çš„å­—èŠ‚ç å¤„ç†æ¡†æ¶ASMï¼Œæ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»ã€‚é™¤äº†CGLIBåŒ…ï¼Œè„šæœ¬è¯­è¨€ä¾‹å¦‚Groovyå’ŒBeanShellï¼Œä¹Ÿæ˜¯ä½¿ç”¨ASMæ¥ç”Ÿæˆjavaçš„å­—èŠ‚ç ã€‚å½“ç„¶ä¸é¼“åŠ±ç›´æ¥ä½¿ç”¨ASMï¼Œå› ä¸ºå®ƒè¦æ±‚ä½ å¿…é¡»å¯¹JVMå†…éƒ¨ç»“æ„åŒ…æ‹¬classæ–‡ä»¶çš„æ ¼å¼å’ŒæŒ‡ä»¤é›†éƒ½å¾ˆç†Ÿæ‚‰ã€‚</p></blockquote><h1 id="Demo">2. Demo</h1><p>ç›´æ¥ä¸ŠDemoï½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ç›®æ ‡ç±»</span><br><span class="line"> */</span><br><span class="line">public class RunnerDefault implements Runner &#123;</span><br><span class="line">    private Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(String name) &#123;</span><br><span class="line">        log.info(&quot;run: &quot; + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‡å®šCallbackçš„é¡ºåº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class CglibCallbackFilter implements CallbackFilter &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public int accept(Method method) &#123;</span><br><span class="line">        if (&quot;toString&quot;.equals(method.getName())) &#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç†é€»è¾‘åŠç”Ÿæˆä»£ç†çš„å°è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// æ‹¦æˆªæ‰€æœ‰æ–¹æ³•</span><br><span class="line">public class CglibProxy implements MethodInterceptor &#123;</span><br><span class="line">    private Enhancer enhancer = new Enhancer();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123;</span><br><span class="line">        objects[0] = &quot;cglib &quot; + objects[0];</span><br><span class="line">        return methodProxy.invokeSuper(o, objects);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object newProxy(Class klass) &#123;</span><br><span class="line">        enhancer.setSuperclass(klass);</span><br><span class="line">        enhancer.setCallbackFilter(new CglibCallbackFilter());</span><br><span class="line">        enhancer.setCallbacks(new Callback[]&#123;new CglibProxy(), new CglibStringProxy()&#125;);</span><br><span class="line">        return enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ºäº†æ‹¦æˆªtoStringæ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibStringProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"toString hijacked"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCglib</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç”Ÿæˆclassæ–‡ä»¶</span></span><br><span class="line">    System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, <span class="string">"./"</span>);</span><br><span class="line">    CglibProxy cglibProxy = <span class="keyword">new</span> CglibProxy();</span><br><span class="line">    RunnerDefault runner = (RunnerDefault) cglibProxy.newProxy(RunnerDefault.class);</span><br><span class="line">    runner.run(<span class="string">"proxy"</span>);</span><br><span class="line">    runner.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º:</p><pre><code>2019-03-07 16:48:44.248  INFO   --- [           main] RunnerDefault$$EnhancerByCGLIB$$5b557d48 : run: cglib proxy2019-03-07 16:48:44.254  INFO   --- [           main] com.htc.learning.proxy.CglibStringProxy  : toString hijacked</code></pre><blockquote><p>ä¹Ÿå¯ä»¥ä¸é…ç½®CallbackFilterï¼Œåªèƒ½é…ä¸€ä¸ªCallbackï¼ŒEnhancerä¼šæŠŠå•ä¸ªçš„Callbackè½¬ä¸ºæ•°ç»„,å¹¶ä¸”æŠŠCallbackFilterè®¾ç½®ä¸ºALL_ZEROï¼Œå›ºå®šè¿”å›0</p></blockquote><p>ä¸‹é¢æ˜¯ä¸Šé¢testæ‰§è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ–‡ä»¶</p><p><img src="/images/pasted-169.png" alt="upload successful"></p><h1 id="NamingPolicy">3. NamingPolicy</h1><p>ä¸Šé¢çš„<strong>RunnerDefault$$EnhancerByCGLIB$$16487fc</strong>æ˜¯cglibå‘½åè€Œæ¥çš„ï¼Œé»˜è®¤å®ç°ç±»æ˜¯<code>net.sf.cglib.core.DefaultNamingPolicy</code>å‘½åè§„åˆ™å¦‚ä¸‹ï¼š</p><pre><code>ç›®æ ‡ClassName + &quot;$$&quot; + ä½¿ç”¨cglibå¤„ç†çš„ClassName + &quot;ByCGLIB&quot; + &quot;$$&quot; + keyçš„hashcode</code></pre><h1 id="Keyå’Œç¼“å­˜">4. Keyå’Œç¼“å­˜</h1><h2 id="KeyFactory">4.1. KeyFactory</h2><p>å…ˆçœ‹<code>KeyFactory</code>ï¼Œè¿™ä¸ªç±»å¯ä»¥ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ï¼Œè¿™ä¸ªä»£ç†ç±»å¯¹äºç»™å®šçš„å‚æ•°ï¼Œæ¯æ¬¡è°ƒç”¨è¿”å›çš„å¯¹è±¡çš„<code>equals</code>ã€<code>hashcode</code>æ–¹æ³•éƒ½æ˜¯è¿”å›ç›¸åŒçš„å€¼ã€‚ç”±äºcglibçš„é…ç½®é¡¹æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ä¸ªç±»ç”¨äºç”Ÿæˆç¼“å­˜keyçš„ã€‚</p><blockquote><p>ç›®æ ‡ç±»éœ€è¦æä¾›ä¸€ä¸ª<code>public Object newInstance(...)</code>çš„å£°æ˜ï¼Œå‚æ•°æ•°é‡ç±»å‹éšæ„ã€‚</p></blockquote><p>ä¸‹é¢æ˜¯cglib</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeySample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyFactory</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">char</span>[] b, String d)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æºç æ²¡æœ‰è¿™ä¸€è¡Œï¼ŒåŠ ä¸Šè¿™ä¸€è¡Œï¼Œcglibçš„debugæ¨¡å¼æ‰“å¼€ï¼Œå°±å¯ä»¥è¾“å‡ºç”Ÿæˆä»£ç†ç±»çš„classæ–‡ä»¶äº†ã€‚</span></span><br><span class="line">        System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, <span class="string">"./"</span>);</span><br><span class="line">        </span><br><span class="line">        MyFactory f = (MyFactory)KeyFactory.create(MyFactory.class);</span><br><span class="line">        Object key1 = f.newInstance(<span class="number">20</span>, <span class="keyword">new</span> <span class="keyword">char</span>[]&#123; <span class="string">'a'</span>, <span class="string">'b'</span> &#125;, <span class="string">"hello"</span>);</span><br><span class="line">        Object key2 = f.newInstance(<span class="number">20</span>, <span class="keyword">new</span> <span class="keyword">char</span>[]&#123; <span class="string">'a'</span>, <span class="string">'b'</span> &#125;, <span class="string">"hello"</span>);</span><br><span class="line">        Object key3 = f.newInstance(<span class="number">20</span>, <span class="keyword">new</span> <span class="keyword">char</span>[]&#123; <span class="string">'a'</span>, <span class="string">'_'</span> &#125;, <span class="string">"hello"</span>);</span><br><span class="line">        System.out.println(key1.equals(key2));<span class="comment">// true</span></span><br><span class="line">        System.out.println(key2.equals(key3));<span class="comment">// false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-168.png" alt="upload successful"><br>ä¸‰æ¬¡ç”Ÿæˆçš„æ˜¯ä¸åŒå¯¹è±¡ã€‚<br>key1å’Œkey2æ˜¯ç›¸ç­‰çš„ï¼Œkey2å’Œkey3æ˜¯ä¸ç­‰çš„ã€‚è¿½è¸ªä»£ç å¯ä»¥çœ‹åˆ°<code>KeyFactory</code>é‡å†™äº†ä»£ç†ç±»çš„<code>equals</code>ã€<code>hashcode</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// net.sf.cglib.core.KeyFactory.Generator#generateClass</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// hash code</span></span><br><span class="line">e = ce.begin_method(Constants.ACC_PUBLIC, HASH_CODE, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">int</span> hc = (constant != <span class="number">0</span>) ? constant : PRIMES[(<span class="keyword">int</span>)(Math.abs(seed) % PRIMES.length)];</span><br><span class="line"><span class="keyword">int</span> hm = (multiplier != <span class="number">0</span>) ? multiplier : PRIMES[(<span class="keyword">int</span>)(Math.abs(seed * <span class="number">13</span>) % PRIMES.length)];</span><br><span class="line">e.push(hc);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</span><br><span class="line">    e.load_this();</span><br><span class="line">    e.getfield(getFieldName(i));</span><br><span class="line">    EmitUtils.hash_code(e, parameterTypes[i], hm, customizers);</span><br><span class="line">&#125;</span><br><span class="line">e.return_value();</span><br><span class="line">e.end_method();</span><br><span class="line"></span><br><span class="line"><span class="comment">// equals</span></span><br><span class="line">e = ce.begin_method(Constants.ACC_PUBLIC, EQUALS, <span class="keyword">null</span>);</span><br><span class="line">Label fail = e.make_label();</span><br><span class="line">e.load_arg(<span class="number">0</span>);</span><br><span class="line">e.instance_of_this();</span><br><span class="line">e.if_jump(e.EQ, fail);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</span><br><span class="line">    e.load_this();</span><br><span class="line">    e.getfield(getFieldName(i));</span><br><span class="line">    e.load_arg(<span class="number">0</span>);</span><br><span class="line">    e.checkcast_this();</span><br><span class="line">    e.getfield(getFieldName(i));</span><br><span class="line">    EmitUtils.not_equals(e, parameterTypes[i], fail, customizers);</span><br><span class="line">&#125;</span><br><span class="line">e.push(<span class="number">1</span>);</span><br><span class="line">e.return_value();</span><br><span class="line">e.mark(fail);</span><br><span class="line">e.push(<span class="number">0</span>);</span><br><span class="line">e.return_value();</span><br><span class="line">e.end_method();</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="ä»£ç†ç¼“å­˜">4.2. ä»£ç†ç¼“å­˜</h2><p>æ‰€æœ‰cglibä»£ç†ç±»çš„ç¼“å­˜éƒ½å­˜åœ¨äº<code>net.sf.cglib.core.AbstractClassGenerator</code>çš„<code>static</code>å˜é‡é‡Œï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Map&lt;ClassLoader, ClassLoaderData&gt; CACHE = <span class="keyword">new</span> WeakHashMap&lt;ClassLoader, ClassLoaderData&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEFAULT_USE_CACHE =        Boolean.parseBoolean(System.getProperty(<span class="string">"cglib.useCache"</span>, <span class="string">"true"</span>));</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç¼“å­˜æ˜¯ä¸€ä¸ª<code>WeakHashMap</code>ï¼Œkeyå’Œjdkä»£ç†ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä»¥<code>ClassLoaderä¸º</code>ä¸ºkeyï¼Œè‡³äº<code>ClassLoaderData</code>æ˜¯ä¸€ä¸ªå…³äº<code>interfaces</code>çš„å°è£…ï¼Œåˆ°æœ€åº•å±‚å…¶å®æ˜¯ä¸€ä¸ª<code>ConcurrentHashMap</code>ã€‚çœ‹<code>net.sf.cglib.core.AbstractClassGenerator#create</code>çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">create</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ClassLoader loader = getClassLoader();</span><br><span class="line">        Map&lt;ClassLoader, ClassLoaderData&gt; cache = CACHE;</span><br><span class="line">        ClassLoaderData data = cache.get(loader);</span><br><span class="line">        <span class="comment">// ç»´æŠ¤å¤šçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (AbstractClassGenerator.class) &#123;</span><br><span class="line">                cache = CACHE;</span><br><span class="line">                data = cache.get(loader);</span><br><span class="line">                <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Map&lt;ClassLoader, ClassLoaderData&gt; newCache = <span class="keyword">new</span> WeakHashMap&lt;ClassLoader, ClassLoaderData&gt;(cache);</span><br><span class="line">                    data = <span class="keyword">new</span> ClassLoaderData(loader);</span><br><span class="line">                    newCache.put(loader, data);</span><br><span class="line">                    CACHE = newCache;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="comment">// è¿™é‡Œå‘ç”Ÿäº†äºŒçº§ç¼“å­˜çš„putæ“ä½œ</span></span><br><span class="line">        Object obj = data.get(<span class="keyword">this</span>, getUseCache());</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">            <span class="keyword">return</span> firstInstance((Class) obj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nextInstance(obj);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹<code>net.sf.cglib.core.AbstractClassGenerator.ClassLoaderData#get</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(AbstractClassGenerator gen, <span class="keyword">boolean</span> useCache)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸ä½¿ç”¨ç¼“å­˜ç›´æ¥ç”Ÿæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (!useCache) &#123;</span><br><span class="line">      <span class="keyword">return</span> gen.generate(ClassLoaderData.<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// åº•å±‚æ˜¯å»ConcurrentHashMapæ‹¿</span></span><br><span class="line">      Object cachedValue = generatedClasses.get(gen);</span><br><span class="line">      <span class="keyword">return</span> gen.unwrapCachedValue(cachedValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰é¢è¯´åˆ°äºŒçº§ç¼“å­˜å…¶å®æ˜¯<code>ConcurrentHashMap</code>,é‚£ä¹ˆkeyï¼Œvalueåˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿkeyæ˜¯<code>AbstractClassGenerator</code>å­ç±»å†³å®šçš„ï¼Œæ¯”å¦‚<code>KeyFactory</code>ä½¿ç”¨çš„æ˜¯ç›®æ ‡ç±»åï¼›è‡³äºvalueåˆæœ‰jdkä»£ç†çš„å‘³é“â€”â€”valueå€¼ä¸æ˜¯å›ºå®šçš„ï¼Œå¯èƒ½æ˜¯ç”Ÿæˆçš„ä»£ç†ç±»ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ª<code>FutureTask</code>ï¼Œå¤šä¸ªçº¿ç¨‹ä¸‹å¤šä¸ª<code>FutureTask</code>è°ƒç”¨<code>get()</code>åªä¼šæœ‰ä¸€ä¸ªåœ¨æ‰§è¡Œï¼Œé¿å…äº†é‡å¤ç”Ÿæˆå­—èŠ‚ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> V <span class="title">createEntry</span><span class="params">(<span class="keyword">final</span> K key, KK cacheKey, Object v)</span> </span>&#123;</span><br><span class="line">    FutureTask&lt;V&gt; task;</span><br><span class="line">    <span class="keyword">boolean</span> creator = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Another thread is already loading an instance</span></span><br><span class="line">        task = (FutureTask&lt;V&gt;) v;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        task = <span class="keyword">new</span> FutureTask&lt;V&gt;(<span class="keyword">new</span> Callable&lt;V&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> V <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> loader.apply(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Object prevTask = map.putIfAbsent(cacheKey, task);</span><br><span class="line">        <span class="keyword">if</span> (prevTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// creator does the load</span></span><br><span class="line">            creator = <span class="keyword">true</span>;</span><br><span class="line">            task.run();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevTask <span class="keyword">instanceof</span> FutureTask) &#123;</span><br><span class="line">            task = (FutureTask&lt;V&gt;) prevTask;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (V) prevTask;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    V result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = task.get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Interrupted while loading cache item"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">        Throwable cause = e.getCause();</span><br><span class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ((RuntimeException) cause);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unable to load cache item"</span>, cause);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (creator) &#123;</span><br><span class="line">        map.put(cacheKey, result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Enhancer">5. Enhancer</h1><p><code>Enhancer</code>æ˜¯CGLibä¸­çš„ä¸€ä¸ªå­—èŠ‚ç å¢å¼ºå™¨ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½ç”¨è¿™ä¸ªæ¥è¿›è¡Œç”Ÿæˆcglibä»£ç†ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class[] interfaces;</span><br><span class="line"><span class="keyword">private</span> CallbackFilter filter;</span><br><span class="line"><span class="keyword">private</span> Callback[] callbacks;</span><br><span class="line"><span class="comment">// å›è°ƒé€»è¾‘çš„ç±»å‹ï¼ŒåŒ…æ‹¬ MethodInterceptor|NoOp|LazyLoader|Dispatcher|InvocationHandler|FixedValue</span></span><br><span class="line"><span class="keyword">private</span> Type[] callbackTypes;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> validateCallbackTypes;</span><br><span class="line"><span class="comment">// create()æ˜¯å¦åªç”Ÿæˆä»£ç†ç±»,è€Œä¸æ˜¯è¿”å›ä¸€ä¸ªå¯¹è±¡,å¦‚æœåªç”Ÿæˆä»£ç†ç±»ï¼Œcallbackä¸èƒ½è®¾ç½®ï¼Œä¼šæŠ¥é”™</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> classOnly;</span><br><span class="line"><span class="keyword">private</span> Class superclass;</span><br><span class="line"><span class="keyword">private</span> Class[] argumentTypes;</span><br><span class="line"><span class="keyword">private</span> Object[] arguments;</span><br><span class="line"><span class="comment">// æ˜¯å¦ä½¿ç”¨å·¥å‚ç±»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> useFactory = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">private</span> Long serialVersionUID;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> interceptDuringConstruction = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯åˆ›å»ºé€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createHelper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œè¿›è¡Œä¸€äº›é…ç½®æ ¡éªŒï¼Œæ¯”å¦‚è®¾ç½®äº†å¤šä¸ªCallbackä½†æ˜¯æ²¡æœ‰è®¾ç½®filter</span></span><br><span class="line">    preValidate();</span><br><span class="line">    <span class="comment">// è¿™é‡ŒKEY_FACTORYæ˜¯KeyFactoryå®ä¾‹</span></span><br><span class="line">    Object key = KEY_FACTORY.newInstance((superclass != <span class="keyword">null</span>) ? superclass.getName() : <span class="keyword">null</span>,</span><br><span class="line">            ReflectUtils.getNames(interfaces),</span><br><span class="line">            filter == ALL_ZERO ? <span class="keyword">null</span> : <span class="keyword">new</span> WeakCacheKey&lt;CallbackFilter&gt;(filter),</span><br><span class="line">            callbackTypes,</span><br><span class="line">            useFactory,</span><br><span class="line">            interceptDuringConstruction,</span><br><span class="line">            serialVersionUID);</span><br><span class="line">    <span class="keyword">this</span>.currentKey = key;</span><br><span class="line">    Object result = <span class="keyword">super</span>.create(key);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Object result = super.create(key);</code>åˆæ˜¯è·³åˆ°ä¸Šé¢æåˆ°è¿‡çš„<code>net.sf.cglib.core.AbstractClassGenerator#create</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">create</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ClassLoader loader = getClassLoader();</span><br><span class="line">        Map&lt;ClassLoader, ClassLoaderData&gt; cache = CACHE;</span><br><span class="line">        ClassLoaderData data = cache.get(loader);</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (AbstractClassGenerator.class) &#123;</span><br><span class="line">                cache = CACHE;</span><br><span class="line">                data = cache.get(loader);</span><br><span class="line">                <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Map&lt;ClassLoader, ClassLoaderData&gt; newCache = <span class="keyword">new</span> WeakHashMap&lt;ClassLoader, ClassLoaderData&gt;(cache);</span><br><span class="line">                    data = <span class="keyword">new</span> ClassLoaderData(loader);</span><br><span class="line">                    newCache.put(loader, data);</span><br><span class="line">                    CACHE = newCache;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        Object obj = data.get(<span class="keyword">this</span>, getUseCache());</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">            <span class="keyword">return</span> firstInstance((Class) obj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nextInstance(obj);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä¸€å°èŠ‚æåˆ°ï¼Œè¿™é‡Œé¢æ˜¯æœ‰ç¼“å­˜çš„ã€‚</p><h2 id="ä»£ç†ä¸»æµç¨‹">5.1. ä»£ç†ä¸»æµç¨‹</h2><p><code>net.sf.cglib.proxy.Enhancer#generateClass</code>æ–¹æ³•è´Ÿè´£ç”Ÿæˆä»£ç†ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>CallbackFilter</code>ä¸ºä¸åŒçš„<code>Method</code>æä¾›ä¸åŒçš„<code>Callback</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateClass</span><span class="params">(ClassVisitor v)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class sc = (superclass == <span class="keyword">null</span>) ? Object.class : superclass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TypeUtils.isFinal(sc.getModifiers()))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot subclass final class "</span> + sc.getName());</span><br><span class="line">    List constructors = <span class="keyword">new</span> ArrayList(Arrays.asList(sc.getDeclaredConstructors()));</span><br><span class="line">    filterConstructors(sc, constructors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Order is very important: must add superclass, then</span></span><br><span class="line">    <span class="comment">// its superclass chain, then each interface and</span></span><br><span class="line">    <span class="comment">// its superinterfaces.</span></span><br><span class="line">    List actualMethods = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    List interfaceMethods = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    <span class="keyword">final</span> Set forcePublic = <span class="keyword">new</span> HashSet();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœ‹ä¸‹é¢ä»£ç </span></span><br><span class="line">    getMethods(sc, interfaces, actualMethods, interfaceMethods, forcePublic);</span><br><span class="line">    <span class="comment">// è¿™é‡ŒæŠŠactualMethodsä¸­ï¼Œéabstract,énative,ésynchronizedæ–¹æ³•çš„ä¿®é¥°ç¬¦å…¨éƒ¨å˜æˆfinalï¼Œå°†è½¬åŒ–åçš„æ–¹æ³•ä¿¡æ¯MethodInfoåˆ—è¡¨ è®°å½•åœ¨methodsä¸­</span></span><br><span class="line">    List methods = CollectionUtils.transform(actualMethods, <span class="keyword">new</span> Transformer() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">            Method method = (Method)value;</span><br><span class="line">            <span class="keyword">int</span> modifiers = Constants.ACC_FINAL</span><br><span class="line">                | (method.getModifiers()</span><br><span class="line">                   &amp; ~Constants.ACC_ABSTRACT</span><br><span class="line">                   &amp; ~Constants.ACC_NATIVE</span><br><span class="line">                   &amp; ~Constants.ACC_SYNCHRONIZED);</span><br><span class="line">            <span class="keyword">if</span> (forcePublic.contains(MethodWrapper.create(method))) &#123;</span><br><span class="line">                modifiers = (modifiers &amp; ~Constants.ACC_PROTECTED) | Constants.ACC_PUBLIC;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ReflectUtils.getMethodInfo(method, modifiers);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    ClassEmitter e = <span class="keyword">new</span> ClassEmitter(v);</span><br><span class="line">    <span class="comment">// è¿™ä¸ªcurrentDataä¸çŸ¥é“æ˜¯å¹²å˜›çš„</span></span><br><span class="line">    <span class="keyword">if</span> (currentData == <span class="keyword">null</span>) &#123;</span><br><span class="line">    e.begin_class(Constants.V1_2,</span><br><span class="line">                  Constants.ACC_PUBLIC,</span><br><span class="line">                  getClassName(),</span><br><span class="line">                  Type.getType(sc),</span><br><span class="line">                  (useFactory ?</span><br><span class="line">                   TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) :</span><br><span class="line">                   TypeUtils.getTypes(interfaces)),</span><br><span class="line">                  Constants.SOURCE_FILE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        e.begin_class(Constants.V1_2,</span><br><span class="line">                Constants.ACC_PUBLIC,</span><br><span class="line">                getClassName(),</span><br><span class="line">                <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">new</span> Type[]&#123;FACTORY&#125;,</span><br><span class="line">                Constants.SOURCE_FILE);</span><br><span class="line">    &#125;</span><br><span class="line">    List constructorInfo = CollectionUtils.transform(constructors, MethodInfoTransformer.getInstance());</span><br><span class="line"></span><br><span class="line">    e.declare_field(Constants.ACC_PRIVATE, BOUND_FIELD, Type.BOOLEAN_TYPE, <span class="keyword">null</span>);</span><br><span class="line">    e.declare_field(Constants.ACC_PUBLIC | Constants.ACC_STATIC, FACTORY_DATA_FIELD, OBJECT_TYPE, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (!interceptDuringConstruction) &#123;</span><br><span class="line">        e.declare_field(Constants.ACC_PRIVATE, CONSTRUCTED_FIELD, Type.BOOLEAN_TYPE, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    e.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, <span class="keyword">null</span>);</span><br><span class="line">    e.declare_field(Constants.PRIVATE_FINAL_STATIC, STATIC_CALLBACKS_FIELD, CALLBACK_ARRAY, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (serialVersionUID != <span class="keyword">null</span>) &#123;</span><br><span class="line">        e.declare_field(Constants.PRIVATE_FINAL_STATIC, Constants.SUID_FIELD_NAME, Type.LONG_TYPE, serialVersionUID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®callbackTypeså¢åŠ å±æ€§ï¼Œåå­—ä¸ºCGLIB$CALLBACK_xx(xxæ˜¯åºå·)</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackTypes.length; i++) &#123;</span><br><span class="line">        e.declare_field(Constants.ACC_PRIVATE, getCallbackField(i), callbackTypes[i], <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// This is declared private to avoid "public field" pollution</span></span><br><span class="line">    e.declare_field(Constants.ACC_PRIVATE | Constants.ACC_STATIC, CALLBACK_FILTER_FIELD, OBJECT_TYPE, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentData == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¸ºç›®æ ‡æ–¹æ³•é…ç½®Callback</span></span><br><span class="line">        emitMethods(e, methods, actualMethods);</span><br><span class="line">        emitConstructors(e, constructorInfo);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        emitDefaultConstructor(e);</span><br><span class="line">    &#125;</span><br><span class="line">    emitSetThreadCallbacks(e);</span><br><span class="line">    emitSetStaticCallbacks(e);</span><br><span class="line">    emitBindCallbacks(e);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (useFactory || currentData != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span>[] keys = getCallbackKeys();</span><br><span class="line">        emitNewInstanceCallbacks(e);</span><br><span class="line">        emitNewInstanceCallback(e);</span><br><span class="line">        emitNewInstanceMultiarg(e, constructorInfo);</span><br><span class="line">        emitGetCallback(e, keys);</span><br><span class="line">        emitSetCallback(e, keys);</span><br><span class="line">        emitGetCallbacks(e);</span><br><span class="line">        emitSetCallbacks(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    e.end_class();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è·å–è¦ä»£ç†çš„æ–¹æ³•">5.2. è·å–è¦ä»£ç†çš„æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getMethods</span><span class="params">(Class superclass, Class[] interfaces, List methods, List interfaceMethods, Set forcePublic)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ä¸‹é¢è¿™ä¸€å¨æ˜¯æŠŠç›®æ ‡ç±»çš„æ–¹æ³•ï¼Œæ¥å£æ–¹æ³•çš„ä¿¡æ¯ï¼ˆç±»å‹æ˜¯ MethodInfoï¼‰éƒ½åŠ å…¥åˆ°methodsåˆ—è¡¨é‡Œ</span></span><br><span class="line">    ReflectUtils.addAllMethods(superclass, methods);</span><br><span class="line">    List target = (interfaceMethods != <span class="keyword">null</span>) ? interfaceMethods : methods;</span><br><span class="line">    <span class="keyword">if</span> (interfaces != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (interfaces[i] != Factory.class) &#123;</span><br><span class="line">                ReflectUtils.addAllMethods(interfaces[i], target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (interfaceMethods != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (forcePublic != <span class="keyword">null</span>) &#123;</span><br><span class="line">            forcePublic.addAll(MethodWrapper.createSet(interfaceMethods));</span><br><span class="line">        &#125;</span><br><span class="line">        methods.addAll(interfaceMethods);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿‡æ»¤staticæ–¹æ³•</span></span><br><span class="line">    CollectionUtils.filter(methods, <span class="keyword">new</span> RejectModifierPredicate(Constants.ACC_STATIC));</span><br><span class="line">    <span class="comment">// æ ¹æ®å¸ƒå°”å€¼å†³å®šæ˜¯å¦è¿‡æ»¤protectedçš„æ–¹æ³•ï¼Œè¿‡æ»¤privateæ–¹æ³•</span></span><br><span class="line">    CollectionUtils.filter(methods, <span class="keyword">new</span> VisibilityPredicate(superclass, <span class="keyword">true</span>));</span><br><span class="line">    <span class="comment">// è¿‡æ»¤é‡å¤</span></span><br><span class="line">    CollectionUtils.filter(methods, <span class="keyword">new</span> DuplicatesPredicate(methods));</span><br><span class="line">    <span class="comment">// è¿‡æ»¤finalæ–¹æ³•</span></span><br><span class="line">    CollectionUtils.filter(methods, <span class="keyword">new</span> RejectModifierPredicate(Constants.ACC_FINAL));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹demoçš„<code>RunnerDefault</code>ï¼Œè·å–åˆ°çš„æœ€ç»ˆæ–¹æ³•ä¸º</p><p><img src="/images/pasted-170.png" alt="upload successful"></p><h2 id="ä¸ºç›®æ ‡æ–¹æ³•é…ç½®Callback">5.3. ä¸ºç›®æ ‡æ–¹æ³•é…ç½®Callback</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// methodsçš„ç±»å‹æ˜¯MethodInfoï¼Œä¸»è¦æ˜¯æ”¹äº†åŸæ–¹æ³•çš„modifiers</span></span><br><span class="line"><span class="comment">// actualMethodsçš„ç±»å‹Method</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">emitMethods</span><span class="params">(<span class="keyword">final</span> ClassEmitter ce, List methods, List actualMethods)</span> </span>&#123;</span><br><span class="line">    CallbackGenerator[] generators = CallbackInfo.getGenerators(callbackTypes);</span><br><span class="line"></span><br><span class="line">    Map groups = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">final</span> Map indexes = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">final</span> Map originalModifiers = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">final</span> Map positions = CollectionUtils.getIndexMap(methods);</span><br><span class="line">    <span class="keyword">final</span> Map declToBridge = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">    Iterator it1 = methods.iterator();</span><br><span class="line">    Iterator it2 = (actualMethods != <span class="keyword">null</span>) ? actualMethods.iterator() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (it1.hasNext()) &#123;</span><br><span class="line">        MethodInfo method = (MethodInfo)it1.next();</span><br><span class="line">        Method actualMethod = (it2 != <span class="keyword">null</span>) ? (Method)it2.next() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// è·å– index</span></span><br><span class="line">        <span class="keyword">int</span> index = filter.accept(actualMethod);</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= callbackTypes.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Callback filter returned an index that is too large: "</span> + index);</span><br><span class="line">        &#125;</span><br><span class="line">        originalModifiers.put(method, <span class="keyword">new</span> Integer((actualMethod != <span class="keyword">null</span>) ? actualMethod.getModifiers() : method.getModifiers()));</span><br><span class="line">        <span class="comment">// æŠŠindexæ”¾å…¥map</span></span><br><span class="line">        indexes.put(method, <span class="keyword">new</span> Integer(index));</span><br><span class="line">        List group = (List)groups.get(generators[index]);</span><br><span class="line">        <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">            groups.put(generators[index], group = <span class="keyword">new</span> ArrayList(methods.size()));</span><br><span class="line">        &#125;</span><br><span class="line">        group.add(method);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Optimization: build up a map of Class -&gt; bridge methods in class</span></span><br><span class="line">        <span class="comment">// so that we can look up all the bridge methods in one pass for a class.</span></span><br><span class="line">        <span class="keyword">if</span> (TypeUtils.isBridge(actualMethod.getModifiers())) &#123;</span><br><span class="line">        Set bridges = (Set)declToBridge.get(actualMethod.getDeclaringClass());</span><br><span class="line">        <span class="keyword">if</span> (bridges == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bridges = <span class="keyword">new</span> HashSet();</span><br><span class="line">            declToBridge.put(actualMethod.getDeclaringClass(), bridges);</span><br><span class="line">        &#125;</span><br><span class="line">        bridges.add(method.getSignature());            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> Map bridgeToTarget = <span class="keyword">new</span> BridgeMethodResolver(declToBridge, getClassLoader()).resolveAll();</span><br><span class="line"></span><br><span class="line">    Set seenGen = <span class="keyword">new</span> HashSet();</span><br><span class="line">    CodeEmitter se = ce.getStaticHook();</span><br><span class="line">    se.new_instance(THREAD_LOCAL);</span><br><span class="line">    se.dup();</span><br><span class="line">    se.invoke_constructor(THREAD_LOCAL, CSTRUCT_NULL);</span><br><span class="line">    se.putfield(THREAD_CALLBACKS_FIELD);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Object[] state = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">    CallbackGenerator.Context context = <span class="keyword">new</span> CallbackGenerator.Context() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Enhancer.<span class="keyword">this</span>.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOriginalModifiers</span><span class="params">(MethodInfo method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ((Integer)originalModifiers.get(method)).intValue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">(MethodInfo method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ((Integer)indexes.get(method)).intValue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ ¹æ®indexè·å–å¯¹åº”çš„Callbackï¼ˆä»DeclaredFieldè·å–ï¼‰</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">emitCallback</span><span class="params">(CodeEmitter e, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">            emitCurrentCallback(e, index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Signature <span class="title">getImplSignature</span><span class="params">(MethodInfo method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> rename(method.getSignature(), ((Integer)positions.get(method)).intValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">emitLoadArgsAndInvoke</span><span class="params">(CodeEmitter e, MethodInfo method)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// If this is a bridge and we know the target was called from invokespecial,</span></span><br><span class="line">            <span class="comment">// then we need to invoke_virtual w/ the bridge target instead of doing</span></span><br><span class="line">            <span class="comment">// a super, because super may itself be using super, which would bypass</span></span><br><span class="line">            <span class="comment">// any proxies on the target.</span></span><br><span class="line">            Signature bridgeTarget = (Signature)bridgeToTarget.get(method.getSignature());</span><br><span class="line">            <span class="keyword">if</span> (bridgeTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// checkcast each argument against the target's argument types</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bridgeTarget.getArgumentTypes().length; i++) &#123;</span><br><span class="line">                    e.load_arg(i);</span><br><span class="line">                    Type target = bridgeTarget.getArgumentTypes()[i];</span><br><span class="line">                    <span class="keyword">if</span> (!target.equals(method.getSignature().getArgumentTypes()[i])) &#123;</span><br><span class="line">                        e.checkcast(target);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                e.invoke_virtual_this(bridgeTarget);</span><br><span class="line">                </span><br><span class="line">                Type retType = method.getSignature().getReturnType();                    </span><br><span class="line">                <span class="comment">// Not necessary to cast if the target &amp; bridge have</span></span><br><span class="line">                <span class="comment">// the same return type. </span></span><br><span class="line">                <span class="comment">// (This conveniently includes void and primitive types,</span></span><br><span class="line">                <span class="comment">// which would fail if casted.  It's not possible to </span></span><br><span class="line">                <span class="comment">// covariant from boxed to unbox (or vice versa), so no having</span></span><br><span class="line">                <span class="comment">// to box/unbox for bridges).</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> It also isn't necessary to checkcast if the return is</span></span><br><span class="line">                <span class="comment">// assignable from the target.  (This would happen if a subclass</span></span><br><span class="line">                <span class="comment">// used covariant returns to narrow the return type within a bridge</span></span><br><span class="line">                <span class="comment">// method.)</span></span><br><span class="line">                <span class="keyword">if</span> (!retType.equals(bridgeTarget.getReturnType())) &#123;</span><br><span class="line">                    e.checkcast(retType);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                e.load_args();</span><br><span class="line">                e.super_invoke(method.getSignature());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> CodeEmitter <span class="title">beginMethod</span><span class="params">(ClassEmitter ce, MethodInfo method)</span> </span>&#123;</span><br><span class="line">            CodeEmitter e = EmitUtils.begin_method(ce, method);</span><br><span class="line">            <span class="keyword">if</span> (!interceptDuringConstruction &amp;&amp;</span><br><span class="line">                !TypeUtils.isAbstract(method.getModifiers())) &#123;</span><br><span class="line">                Label constructed = e.make_label();</span><br><span class="line">                e.load_this();</span><br><span class="line">                e.getfield(CONSTRUCTED_FIELD);</span><br><span class="line">                e.if_jump(e.NE, constructed);</span><br><span class="line">                e.load_this();</span><br><span class="line">                e.load_args();</span><br><span class="line">                e.super_invoke();</span><br><span class="line">                e.return_value();</span><br><span class="line">                e.mark(constructed);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackTypes.length; i++) &#123;</span><br><span class="line">        CallbackGenerator gen = generators[i];</span><br><span class="line">        <span class="keyword">if</span> (!seenGen.contains(gen)) &#123;</span><br><span class="line">            seenGen.add(gen);</span><br><span class="line">            <span class="keyword">final</span> List fmethods = (List)groups.get(gen);</span><br><span class="line">            <span class="keyword">if</span> (fmethods != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    gen.generate(ce, context, fmethods);</span><br><span class="line">                    gen.generateStatic(se, context, fmethods);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> CodeGenerationException(x);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    se.return_value();</span><br><span class="line">    se.end_method();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»£ç æ²¡æœ‰çœ‹çš„å¾ˆç»†ï¼Œäº†è§£äº†å¤§æ¦‚ã€‚</p><blockquote><p>ä¸€ä¸ªæ–¹æ³•åªä¼šæœ‰ä¸€ä¸ª<code>Callback</code>ã€‚</p></blockquote><p>è¿™ä¸€èŠ‚ï¼Œæœ€åçœ‹ä¸€ä¸‹ä»£ç†å‡ºæ¥çš„ç±»çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">    MethodInterceptor var10000 = <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">    <span class="keyword">if</span> (var10000 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">        var10000 = <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (var10000 != <span class="keyword">null</span>) &#123;</span><br><span class="line">        var10000.intercept(<span class="keyword">this</span>, CGLIB$run$<span class="number">0</span>$Method, <span class="keyword">new</span> Object[]&#123;var1&#125;, CGLIB$run$<span class="number">0</span>$Proxy);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.run(var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CGLIB$run$0$Method </span></span><br><span class="line">Method CGLIB$run$<span class="number">0</span>$Method = ReflectUtils.findMethods(<span class="keyword">new</span> String[]&#123;<span class="string">"run"</span>, <span class="string">"(Ljava/lang/String;)V"</span>&#125;, (var1 = Class.forName(<span class="string">"com.htc.learning.api.impl.RunnerDefault"</span>)).getDeclaredMethods())[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// CGLIB$run$0$Proxy</span></span><br><span class="line">MethodProxy CGLIB$run$<span class="number">0</span>$Proxy = MethodProxy.create(var1, var0, <span class="string">"(Ljava/lang/String;)V"</span>, <span class="string">"run"</span>, <span class="string">"CGLIB$run$0"</span>);</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œä»£ç†ç±»å°†è°ƒç”¨è½¬å‘ç»™ä¸€ä¸ª<code>Callback</code>ï¼Œåœ¨<code>Callback</code>é‡Œï¼Œå¦‚æœè¦æ‰§è¡Œç›®æ ‡ç±»çš„ç›®æ ‡æ–¹æ³•ï¼Œå³è°ƒç”¨<code>net.sf.cglib.proxy.MethodProxy#invokeSuper</code></p><p>ç­‰ç­‰ï¼Œ<code>MethodProxy</code>æ˜¯ä»€ä¹ˆ</p><p>æ­¤å¤–ä»ç”Ÿæˆçš„ç±»é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹é™¤äº†Enhancerå’ŒKeyFactoryçš„å¢å¼ºç±»ä¹‹å¤–ï¼Œè¿˜ç”Ÿæˆäº†ä¸‰ä¸ªç±»</p><p><img src="/images/pasted-171.png" alt="upload successful"><br>ç¬¬äºŒä¸ªæ˜¯æˆ‘ä»¬çš„ä»£ç†ç±»ï¼Œé‚£ä¹ˆå…¶ä½™ä¸¤ä¸ªæ˜¯å¹²å˜›çš„ï¼Œ<code>FastClass</code>åˆæ˜¯ä»€ä¹ˆ?</p><h1 id="MethodProxyä¸Fastclass">6. MethodProxyä¸Fastclass</h1><h2 id="ä¸ºä»€ä¹ˆè¦æœ‰MethodProxyã€Fastclass">6.1. ä¸ºä»€ä¹ˆè¦æœ‰MethodProxyã€Fastclass</h2><p>æˆ‘ä»¬é…ç½®ä»£ç†çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ä¼ å…¥ä¸€ä¸ªç›®æ ‡ç±»å®ä¾‹ï¼Œè€Œæ˜¯ä¼ å…¥ç›®æ ‡ç±»çš„classï¼Œè¿™æ—¶æˆ‘ä»¬è¦å»è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœæ¯æ¬¡éƒ½é åå°„ï¼Œé‚£å°±æ²¡æœ‰ç›´æ¥è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ¥çš„å¿«ã€‚</p><blockquote><p>æ²¡é”™æ¯æ¬¡éƒ½é åå°„è¯´çš„å°±æ˜¯ä½ jdkä»£ç†ã€‚</p></blockquote><h2 id="MethodProxy">6.2. MethodProxy</h2><p><code>MethodProxy</code>è¡¨æ˜äº†ä¸€ä¸ªæ–¹æ³•åˆ°å¦ä¸€ä¸ªæ–¹æ³•çš„æ˜ å°„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£ç†ç±»runæ–¹æ³•çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">    MethodInterceptor var10000 = <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">    <span class="keyword">if</span> (var10000 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">        var10000 = <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (var10000 != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// CGLIB$run$0$Proxy å³æ˜¯ MethodProxy</span></span><br><span class="line">        var10000.intercept(<span class="keyword">this</span>, CGLIB$run$<span class="number">0</span>$Method, <span class="keyword">new</span> Object[]&#123;var1&#125;, CGLIB$run$<span class="number">0</span>$Proxy);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.run(var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­,</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class var0 = Class.forName(<span class="string">"com.htc.learning.api.impl.RunnerDefault$$EnhancerByCGLIB$$5b557d48"</span>);  </span><br><span class="line">Class var1 = Class.forName(<span class="string">"com.htc.learning.api.impl.RunnerDefault"</span>)</span><br><span class="line">CGLIB$run$<span class="number">0</span>$Proxy = MethodProxy.create(var1, var0, <span class="string">"(Ljava/lang/String;)V"</span>, <span class="string">"run"</span>, <span class="string">"CGLIB$run$0"</span>);</span><br></pre></td></tr></table></figure><p>å†å…¶ä¸­ï¼Œ<code>&quot;CGLIB$run$0&quot;</code>æ˜¯Enhancerä»£ç†ç±»é‡Œçš„ä¸€ä¸ªå·²ç»ç”Ÿæˆçš„æ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> CGLIB$run$<span class="number">0</span>(String var1) &#123;</span><br><span class="line">    <span class="keyword">super</span>.run(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MethodProxy</code>çš„<code>create</code>æ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MethodProxy <span class="title">create</span><span class="params">(Class c1, Class c2, String desc, String name1, String name2)</span> </span>&#123;</span><br><span class="line">    MethodProxy proxy = <span class="keyword">new</span> MethodProxy();</span><br><span class="line">    proxy.sig1 = <span class="keyword">new</span> Signature(name1, desc);</span><br><span class="line">    proxy.sig2 = <span class="keyword">new</span> Signature(name2, desc);</span><br><span class="line">    proxy.createInfo = <span class="keyword">new</span> MethodProxy.CreateInfo(c1, c2);</span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ®µå°±æ˜¯è¯´<code>c1</code>çš„æ–¹æ³•<code>name1</code>,å¯¹åº”çš„ä»£ç†æ–¹æ³•æ˜¯å®ç°ç±»<code>c2</code>çš„æ–¹æ³•<code>name2</code>ã€‚å†å…·ä½“ä¸€ç‚¹ï¼Œ<code>RunnerDefault</code>çš„<code>run</code>æ–¹æ³•ï¼Œå¯¹åº”çš„å°±æ˜¯<code>com.htc.learning.api.impl.RunnerDefault$$EnhancerByCGLIB$$5b557d48</code>çš„<code>CGLIB$run$0</code>æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªç­¾åæ²¡æœ‰ä¾èµ–ï¼ŒMethodProxyåˆ©ç”¨è¿™ä¸¤ä¸ªç­¾åï¼Œæä¾›ä¸¤ç§ä¸åŒçš„ç›®æ ‡æ–¹æ³•è°ƒç”¨ï¼Œ</p><h2 id="FastClass">6.3. FastClass</h2><p>ä¸Šé¢åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå…³è”å…³ç³»ï¼Œæ¥ä¸‹æ¥çœ‹<code>net.sf.cglib.proxy.MethodProxy#invokeSuper</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invokeSuper</span><span class="params">(Object obj, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.init();</span><br><span class="line">        MethodProxy.FastClassInfo fci = <span class="keyword">this</span>.fastClassInfo;</span><br><span class="line">        <span class="comment">// f2æ˜¯Enhancerä»£ç†ç±»ï¼Œi2æ˜¯é…ç½®å¥½çš„å¯ä»¥è°ƒç”¨åˆ°ç›®æ ‡æ–¹æ³•çš„ç´¢å¼•ï¼Œinvokeæ ¹æ®ç´¢å¼•ï¼Œä½¿ç”¨switchå—ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼Œè€Œä¸æ˜¯åˆ©ç”¨åå°„</span></span><br><span class="line">        <span class="keyword">return</span> fci.f2.invoke(fci.i2, obj, args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException var4) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var4.getTargetException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å•ä¾‹æ¨¡å¼ï¼Œé˜²æ­¢é‡å¤åˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fastClassInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.initLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.fastClassInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                MethodProxy.CreateInfo ci = <span class="keyword">this</span>.createInfo;</span><br><span class="line">                MethodProxy.FastClassInfo fci = <span class="keyword">new</span> MethodProxy.FastClassInfo();</span><br><span class="line">                fci.f1 = helper(ci, ci.c1);</span><br><span class="line">                fci.f2 = helper(ci, ci.c2);</span><br><span class="line">                fci.i1 = fci.f1.getIndex(<span class="keyword">this</span>.sig1);</span><br><span class="line">                fci.i2 = fci.f2.getIndex(<span class="keyword">this</span>.sig2);</span><br><span class="line">                <span class="keyword">this</span>.fastClassInfo = fci;</span><br><span class="line">                <span class="keyword">this</span>.createInfo = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> FastClass <span class="title">helper</span><span class="params">(MethodProxy.CreateInfo ci, Class type)</span> </span>&#123;</span><br><span class="line">    Generator g = <span class="keyword">new</span> Generator();</span><br><span class="line">    g.setType(type);</span><br><span class="line">    g.setClassLoader(ci.c2.getClassLoader());</span><br><span class="line">    g.setNamingPolicy(ci.namingPolicy);</span><br><span class="line">    g.setStrategy(ci.strategy);</span><br><span class="line">    g.setAttemptLoad(ci.attemptLoad);</span><br><span class="line">    <span class="comment">// è¿›å»ä»£ç åå¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†ç¼“å­˜ï¼Œæ‰€ä»¥ä¸ä¼šé‡å¤ç”ŸæˆFastClass</span></span><br><span class="line">    <span class="keyword">return</span> g.create();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FastClassInfo</span> </span>&#123;</span><br><span class="line">    FastClass f1;</span><br><span class="line">    FastClass f2;</span><br><span class="line">    <span class="keyword">int</span> i1;</span><br><span class="line">    <span class="keyword">int</span> i2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">FastClassInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‚æ•°å‘½ä»¤å®åœ¨æœ‰ç‚¹éš¾æ‡‚ï¼Œæ¢³ç†ä¸€ä¸‹ï¼Œé’ˆå¯¹<code>run</code>æ–¹æ³•ï¼Œ</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>c1</td><td><code>RunnerDefault</code></td></tr><tr><td>f1</td><td><code>RunnerDefault$$FastClassByCGLIB$$a60a67a3</code></td></tr><tr><td>i1</td><td>ç›®æ ‡ç±»<code>run</code>çš„ç´¢å¼•</td></tr><tr><td>c2</td><td><code>RunnerDefault$$EnhancerByCGLIB$$5b557d48</code> (<code>Enhancer</code>ä»£ç†ç±»)</td></tr><tr><td>f2</td><td><code>RunnerDefault$$EnhancerByCGLIB$$5b557d48$$FastClassByCGLIB$$9f176e41</code>ï¼ˆ<code>Enhancer</code>ä»£ç†ç±»çš„ä¸€ä¸ªå¿«é€ŸæŸ¥æ‰¾ç±»ï¼‰</td></tr><tr><td>i2</td><td><code>Enhancer</code>ä»£ç†ç±»è°ƒç”¨<code>run</code>çš„ç´¢å¼•</td></tr></tbody></table><p>ä¸‹é¢æ˜¯<code>RunnerDefault$$FastClassByCGLIB$$a60a67a3</code>çš„éƒ¨åˆ†ä»£ç (å¦‚æœæ˜¯<code>RunnerDefault$$EnhancerByCGLIB$$5b557d48$$FastClassByCGLIB$$9f176e41</code>switchå—ä¼šæ›´å¤§ï¼Œå› ä¸º<code>RunnerDefault$$EnhancerByCGLIB$$5b557d48</code>çš„æ–¹æ³•æ›´å¤š)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">(Signature var1)</span> </span>&#123;</span><br><span class="line">    String var10000 = var1.toString();</span><br><span class="line">    <span class="keyword">switch</span>(var10000.hashCode()) &#123;</span><br><span class="line">    <span class="keyword">case</span> -<span class="number">1717138348</span>:</span><br><span class="line">        <span class="keyword">if</span> (var10000.equals(<span class="string">"run(Ljava/lang/String;)V"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1826985398</span>:</span><br><span class="line">        <span class="keyword">if</span> (var10000.equals(<span class="string">"equals(Ljava/lang/Object;)Z"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1913648695</span>:</span><br><span class="line">        <span class="keyword">if</span> (var10000.equals(<span class="string">"toString()Ljava/lang/String;"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1984935277</span>:</span><br><span class="line">        <span class="keyword">if</span> (var10000.equals(<span class="string">"hashCode()I"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨æ„è¿™çš„var2æ˜¯Enhancerä»£ç†ç±»</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(<span class="keyword">int</span> var1, Object var2, Object[] var3)</span> <span class="keyword">throws</span> InvocationTargetException </span>&#123;</span><br><span class="line">    RunnerDefault var10000 = (RunnerDefault)var2;</span><br><span class="line">    <span class="keyword">int</span> var10001 = var1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span>(var10001) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            var10000.run((String)var3[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Boolean(var10000.equals(var3[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> var10000.toString();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Integer(var10000.hashCode());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvocationTargetException(var4);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot find matching method/constructor"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="StackOverflowError">6.4. StackOverflowError</h2><p>å¦‚æœæˆ‘ä»¬å†™Callbackçš„æ—¶å€™ï¼ŒæŠŠ<code>invokeSuper</code>å†™æˆ<code>invoke</code>ä¼šæ€ä¹ˆæ ·ï¼Œç­”æ¡ˆæ˜¯ï¼š<strong>æ ˆæº¢å‡º</strong>ã€‚<br><code>MethodProxy</code>çš„<code>invoke</code>æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object obj, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.init();</span><br><span class="line">        MethodProxy.FastClassInfo fci = <span class="keyword">this</span>.fastClassInfo;</span><br><span class="line">        <span class="keyword">return</span> fci.f1.invoke(fci.i1, obj, args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>obj</code>æ˜¯Enhancerä»£ç†ç±»ï¼Œè€Œ<code>f1</code>æ˜¯<code>RunnerDefault$$FastClassByCGLIB$$a60a67a3</code>ï¼Œæ‰€ä»¥åˆä¼šç´¢å¼•åˆ°<code>Enhancerä»£ç†ç±»</code>çš„ä»£ç†<code>run</code>æ–¹æ³•ï¼Œæ¥ç€åˆæ‰§è¡Œä¸Šé¢çš„<code>invoke</code>,balabalaâ€¦é™·å…¥æ­»å¾ªç¯ã€‚</p><h2 id="invokeä¸invokeSuper">6.5. invokeä¸invokeSuper</h2><p>é‚£æ˜¯ä¸æ˜¯<code>invoke</code>ä¸èƒ½è¢«è°ƒç”¨äº†ï¼Ÿä¸æ˜¯ï¼Œä¸Šé¢è¯´åˆ°<strong>MethodProxyåˆ©ç”¨è¿™ä¸¤ä¸ªç­¾åï¼Œæä¾›ä¸¤ç§ä¸åŒçš„ç›®æ ‡æ–¹æ³•è°ƒç”¨ï¼Œ</strong>æ‰€ä»¥ï¼Œ<code>invoke</code>æ˜¯å¦ä¸€ç§è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„å§¿åŠ¿ã€‚</p><p>å†™<code>Callback</code>çš„æ—¶å€™ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        objects[<span class="number">0</span>] = <span class="string">"cglib "</span> + objects[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¼ å…¥çš„<code>Object o</code>æ˜¯<code>Enhancer</code>ä»£ç†ç±»ï¼Œè€Œæˆ‘ä»¬ä¸èƒ½æ‰§è¡Œ<code>methodProxy.invoke(o, objects)</code>é™·å…¥æ­»å¾ªç¯ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨<code>Callback</code>éœ€è¦ä¿å­˜ä¸€ä¸ªç›®æ ‡ç±»å®ä¾‹çš„å¼•ç”¨<code>target</code>ï¼Œç„¶å<code>methodProxy.invoke(target, objects)</code>ã€‚</p><h2 id="æ€»ç»“">6.6. æ€»ç»“</h2><p><code>MethodProxy</code>ä¸<code>Fastclass</code>æä¾›äº†ä¸€ä¸ª  <strong>Signature -&gt; index -&gt; invoke</strong>çš„æœºåˆ¶ã€‚</p><h1 id="ç¼ºé™·">7. ç¼ºé™·</h1><p>å¦‚æœç†è§£äº†<code>FastClass</code>ï¼Œé‚£ä¹ˆå¾ˆå®¹çŒœæµ‹<code>cglib</code>çš„æ€§èƒ½ç“¶é¢ˆåœ¨äºï¼Œå½“ç›®æ ‡ç±»çš„æ–¹æ³•å¾ˆå¤šçš„æ—¶å€™ï¼Œ<code>switch</code>å—å°±æ˜¯ä¸€ä¸ªå¾ˆæ…¢çš„æŸ¥æ‰¾ï¼Œè¿™ä¸ªæŸ¥æ‰¾æ˜¯æœ‰ä¼˜åŒ–ç©ºé—´çš„ã€‚æ­¤å¤–ï¼Œ<code>cglib</code>ä»£ç†çš„åˆ›å»ºæ—¶é—´ä¼šæ¯”<code>jdk</code>ä»£ç†çš„åˆ›å»ºæ›´è€—æ—¶é—´ï¼Œä¸è¿‡æˆ‘è§‰å¾—è¿™éƒ½ä¸æ˜¯äº‹ã€‚</p><h1 id="å‚è€ƒ">8. å‚è€ƒ</h1><ol><li><a href="https://www.jianshu.com/p/20203286ccd9" target="_blank" rel="noopener">cglib demoä»¥åŠEnhanceræºç è§£æ</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Cglib&quot;&gt;1. Cglib&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;CGLIBæ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜æ€§èƒ½çš„ä»£ç ç”ŸæˆåŒ…ã€‚CGLIBåŒ…çš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå°è€Œå¿«çš„å­—èŠ‚ç å¤„ç†æ¡†æ¶ASMï¼Œæ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»ã€‚é™¤äº†CGLIBåŒ…ï¼Œè„šæœ¬è¯­è¨€ä¾‹å¦‚Groovyå’ŒBeanShell
      
    
    </summary>
    
      <category term="Proxy" scheme="https://htchz.cc/categories/Proxy/"/>
    
    
      <category term="AOP" scheme="https://htchz.cc/tags/AOP/"/>
    
  </entry>
  
  <entry>
    <title>[Javaä»£ç†]Jdkä»£ç†</title>
    <link href="https://htchz.cc/68869360.html"/>
    <id>https://htchz.cc/68869360.html</id>
    <published>2019-03-04T16:16:00.000Z</published>
    <updated>2019-08-15T16:08:49.215Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">1. å‰è¨€</h1><p>ç›¸æ¯”é™æ€ä»£ç†éœ€è¦æ‰‹åŠ¨å†™ä»£ç†ç±»ï¼ŒåŠ¨æ€ä»£ç†å¯ä»¥é€šè¿‡æŠ½è±¡ä»£ç å®Œæˆå¯¹ä¸€å®šè§„åˆ™çš„ç±»çš„ä»£ç†ï¼Œç”Ÿæˆçš„ä»£ç†ç±»ç›´æ¥ä»¥å­—èŠ‚ç çš„å½¢å¼å­˜åœ¨äºå†…å­˜ä¸­ã€‚Springé‡ŒAopçš„å®ç°ä½¿ç”¨äº†ä¸¤ç§åŠ¨æ€ä»£ç†æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯jdkä»£ç†ï¼Œä¸€ç§æ˜¯<code>cglib</code>ä»£ç†ã€‚</p><p>jdkä»£ç†æ˜¯ä»ç›®æ ‡ç±»çš„æ¥å£ç”Ÿæˆå®ç°ç±»ï¼Œcglibæ˜¯ç»§æ‰¿ç›®æ ‡ç±»ç”Ÿæˆå­ç±»ã€‚</p><h1 id="Demo">2. Demo</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¥å£å®ç°ç±»</span></span><br><span class="line"><span class="comment"> * created by Huang.Zhen on 2019-02-22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnerDefault</span> <span class="keyword">implements</span> <span class="title">Runner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"run: "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»£ç†ç±»</span></span><br><span class="line"><span class="comment"> * created by Huang Zhen on 2019-02-22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkProxyHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜ç›®æ ‡ç±»çš„å¼•ç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdkProxyHandler</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯¹newProxyInstanceæ–¹æ³•çš„å°è£…</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ä»£ç†ç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç”Ÿæˆä»£ç†ç±»</span></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        args[<span class="number">0</span>] = <span class="string">"jdk "</span> + args[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ä¸‹é¢çš„ä»£ç è·å–ä»£ç†ç±»å¹¶è¿è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJdk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Runner runner = (Runner) <span class="keyword">new</span> JdkProxyHandler(<span class="keyword">new</span> RunnerDefault()).getProxy();</span><br><span class="line">    runner.run(<span class="string">"proxy"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º </p><pre><code>2019-03-01 16:02:17.623  INFO   --- [           main] com.htc.learning.api.impl.RunnerDefault  : run: jdk proxy</code></pre><h1 id="åŸç†">3. åŸç†</h1><h2 id="æ€ä¹ˆç”Ÿæˆä»£ç†ç±»classæ–‡ä»¶">3.1. æ€ä¹ˆç”Ÿæˆä»£ç†ç±»classæ–‡ä»¶</h2><p>ç›´æ£<code>Proxy.newProxyInstance</code>æ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Look up or generate the designated proxy class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</span><br></pre></td></tr></table></figure><p>è¿›å…¥<code>getProxyClass0</code>ï¼Œä»<code>proxyClassCache</code>å­—é¢ä¸Šç†è§£ï¼Œjdkä»£ç†æ˜¯æœ‰ç¼“å­˜çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If the proxy class defined by the given loader implementing</span></span><br><span class="line"><span class="comment">// the given interfaces exists, this will simply return the cached copy;</span></span><br><span class="line"><span class="comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span></span><br><span class="line"><span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</span><br></pre></td></tr></table></figure><p>è¿›å…¥getæ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°å‡ºç°äº†jdk8çº§åˆ«çš„ä»£ç ï¼Œè¯´æ˜jdk8é‡Œjdkä»£ç†åˆè¢«ä¼˜åŒ–äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create subKey and retrieve the possible Supplier&lt;V&gt; stored by that</span></span><br><span class="line"><span class="comment">// subKey from valuesMap</span></span><br><span class="line"><span class="comment">// subKeyFactory å…¶å®æ˜¯ java.lang.reflect.Proxy.ProxyClassFactory</span></span><br><span class="line">Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));</span><br><span class="line">Supplier&lt;V&gt; supplier = valuesMap.get(subKey);</span><br><span class="line">...</span><br><span class="line">V value = supplier.get();</span><br><span class="line"><span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>è¿›å…¥<code>java.lang.reflect.Proxy.ProxyClassFactory#apply</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Generate the specified proxy class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(</span><br><span class="line">    proxyName, interfaces, accessFlags);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateProxyClass(<span class="keyword">final</span> String var0, Class&lt;?&gt;[] var1, <span class="keyword">int</span> var2) &#123;</span><br><span class="line">    ProxyGenerator var3 = <span class="keyword">new</span> ProxyGenerator(var0, var1, var2);</span><br><span class="line">    <span class="comment">// ç”Ÿæˆå­—èŠ‚ç çš„æ–¹æ³•ï¼Œä¸æƒ³çœ‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] var4 = var3.generateClassFile();</span><br><span class="line">    <span class="comment">// è¿™é‡Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è®¾ç½®è¦ä¸è¦å­˜å‚¨ç”Ÿæˆçš„classæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (saveGeneratedFiles) &#123;</span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> var1 = var0.lastIndexOf(<span class="number">46</span>);</span><br><span class="line">                    Path var2;</span><br><span class="line">                    <span class="keyword">if</span> (var1 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        Path var3 = Paths.get(var0.substring(<span class="number">0</span>, var1).replace(<span class="string">'.'</span>, File.separatorChar));</span><br><span class="line">                        Files.createDirectories(var3);</span><br><span class="line">                        var2 = var3.resolve(var0.substring(var1 + <span class="number">1</span>, var0.length()) + <span class="string">".class"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        var2 = Paths.get(var0 + <span class="string">".class"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Files.write(var2, var4, <span class="keyword">new</span> OpenOption[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var4x) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"I/O exception saving generated file: "</span> + var4x);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä»¥å¾€éƒ½æ˜¯è¯´jdkä»£ç†æ¯”cglibæ€§èƒ½å·®ï¼Œå…¶å®ä¼˜åŒ–åˆ°ç°åœ¨éƒ½æ²¡å·®å¤šå°‘äº†ï¼Œæ›´å¤šçš„æ—¶å€™æ˜¯ä»ä¸¤è€…çš„ç‰¹æ€§æŒ‰éœ€æ±‚é‡‡å–ä¸åŒçš„ã€‚</p></blockquote><h2 id="ç¼“å­˜">3.2. ç¼“å­˜</h2><p>jdkä»£ç†è·å–Classçš„æ—¶å€™ä½¿ç”¨äº†ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,</span><br><span class="line">                                       Class&lt;?&gt;... interfaces) &#123;</span><br><span class="line">    <span class="keyword">if</span> (interfaces.length &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the proxy class defined by the given loader implementing</span></span><br><span class="line">    <span class="comment">// the given interfaces exists, this will simply return the cached copy;</span></span><br><span class="line">    <span class="comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span></span><br><span class="line">    <span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>proxyClassCache</code>çš„å£°æ˜æ˜¯è¿™æ ·çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * a cache of proxy classes</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</span><br><span class="line">        proxyClassCache = <span class="keyword">new</span> WeakCache&lt;&gt;(<span class="keyword">new</span> KeyFactory(), <span class="keyword">new</span> ProxyClassFactory());</span><br></pre></td></tr></table></figure><p>ä¸»è¦çš„æˆå‘˜å˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼•ç”¨é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;K&gt; refQueue</span><br><span class="line">    = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</span><br><span class="line"><span class="comment">// ç¼“å­˜æœ¬å­˜</span></span><br><span class="line"><span class="comment">// the key type is Object for supporting null key</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Object, ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt;&gt; map</span><br><span class="line">    = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">// åå‘ç´¢å¼•ï¼Œç”¨æ¥å¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å­˜åœ¨ç¼“å­˜é‡Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Supplier&lt;V&gt;, Boolean&gt; reverseMap</span><br><span class="line">    = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">// ä¸¤ä¸ªäºŒå…ƒè¿ç®—æ–¹æ³•</span></span><br><span class="line"><span class="comment">// subKeyFactory = new KeyFactory()</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BiFunction&lt;K, P, ?&gt; subKeyFactory;</span><br><span class="line"><span class="comment">// valueFactory = new ProxyClassFactory()</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BiFunction&lt;K, P, V&gt; valueFactory;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡Œçš„ç¼“å­˜<code>map</code>çš„valueåˆæ˜¯ä¸€ä¸ª<code>ConcurrentMap</code>,è¯´æ˜è¿™ä¸ªç¼“å­˜æ˜¯ä¸€ä¸ªäºŒçº§ç¼“å­˜ã€‚</p><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ä¸€çº§ç¼“å­˜key</td><td>ä¸€ä¸ªCacheKeyç±»å‹çš„å¯¹è±¡ï¼Œä»¥ClassLoaderä½œä¸ºhash</td></tr><tr><td>ä¸€çº§ç¼“å­˜value</td><td>ä¸€çº§ç¼“å­˜</td></tr></tbody></table><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>äºŒçº§ç¼“å­˜key</td><td>ä»¥interfacesä¸ºkey</td></tr><tr><td>äºŒçº§ç¼“å­˜value</td><td>Supplieræ¥å£ï¼Œå¯èƒ½æ˜¯CacheValue æˆ–è€… ä»£ç†å·¥å‚å¯¹è±¡</td></tr></tbody></table><p>çœ‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨Proxyç±»çš„ä»£ç ä¸­ï¼Œkeyæ˜¯ClassLoaderï¼Œparameteræ˜¯interfaceæ•°ç»„</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K key, P parameter)</span> </span>&#123;</span><br><span class="line">    Objects.requireNonNull(parameter);</span><br><span class="line"></span><br><span class="line">    expungeStaleEntries();</span><br><span class="line"></span><br><span class="line">    Object cacheKey = CacheKey.valueOf(key, refQueue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lazily install the 2nd level valuesMap for the particular cacheKey</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–äºŒçº§ç¼“å­˜ï¼Œç”¨äº†åŒé‡æ ¡éªŒï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹æ‹¿åˆ°çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹</span></span><br><span class="line">    ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap = map.get(cacheKey);</span><br><span class="line">    <span class="keyword">if</span> (valuesMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; oldValuesMap</span><br><span class="line">            = map.putIfAbsent(cacheKey,</span><br><span class="line">                              valuesMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;());</span><br><span class="line">        <span class="keyword">if</span> (oldValuesMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">            valuesMap = oldValuesMap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create subKey and retrieve the possible Supplier&lt;V&gt; stored by that</span></span><br><span class="line">    <span class="comment">// subKey from valuesMap</span></span><br><span class="line">    Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));</span><br><span class="line">    Supplier&lt;V&gt; supplier = valuesMap.get(subKey);</span><br><span class="line">    Factory factory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (supplier != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// supplier might be a Factory or a CacheValue&lt;V&gt; instance</span></span><br><span class="line">            V value = supplier.get();</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// else no supplier in cache</span></span><br><span class="line">        <span class="comment">// or a supplier that returned null (could be a cleared CacheValue</span></span><br><span class="line">        <span class="comment">// or a Factory that wasn't successful in installing the CacheValue)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// lazily construct a Factory</span></span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            factory = <span class="keyword">new</span> Factory(key, parameter, subKey, valuesMap);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (supplier == <span class="keyword">null</span>) &#123;</span><br><span class="line">            supplier = valuesMap.putIfAbsent(subKey, factory);</span><br><span class="line">            <span class="keyword">if</span> (supplier == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// successfully installed Factory</span></span><br><span class="line">                supplier = factory;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// else retry with winning supplier</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (valuesMap.replace(subKey, supplier, factory)) &#123;</span><br><span class="line">                <span class="comment">// successfully replaced</span></span><br><span class="line">                <span class="comment">// cleared CacheEntry / unsuccessful Factory</span></span><br><span class="line">                <span class="comment">// with our Factory</span></span><br><span class="line">                supplier = factory;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// retry with current supplier</span></span><br><span class="line">                supplier = valuesMap.get(subKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™é‡Œçš„ä»£ç ä¸»è¦æ˜¯ç»´æŠ¤<code>Map.put</code>æ“ä½œå¤šçº¿ç¨‹ä¸‹çš„ä¸€äº›åŒæ­¥ï¼Œé˜²æ­¢é‡å¤å®ä¾‹åŒ–ã€‚è™½ç„¶<code>map</code>æ˜¯<code>ConcurrentHashMap</code>,ä½†é‡å¤putè¿˜æ˜¯å¾—é¿å…çš„ã€‚</li><li>äºŒçº§ç¼“å­˜<code>Map</code>çš„<code>value</code>ä¸º<code>Supplier</code>ç±»å‹ï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ˜¯ <code>Factory</code>å¯¹è±¡ï¼Œç¬¬äºŒæ¬¡è®¿é—®å°±å¯èƒ½æ˜¯<code>CacheValue</code>ï¼Œå› ä¸º<code>Factory</code>å­˜æœ‰äºŒçº§ç¼“å­˜mapçš„å¼•ç”¨ï¼Œä¼šæŠŠ<code>value</code>ä»<code>this</code>ï¼ˆ<code>Factory</code>æœ¬èº«ï¼‰æ›¿æ¢ä¸º<code>CacheValue</code></li></ul><blockquote><p>å…¶å®ä¸å¤ªæ˜ç™½è¿™ç§æœºåˆ¶,å¯èƒ½ä¸ºäº†æé«˜å¹¶å‘æ€§èƒ½ï¼Ÿå…ˆè¿”å›å€¼ï¼Œå†ä¸ºå€¼æ„é€ ç¼“å­˜ã€‚</p></blockquote><h2 id="ç¼“å­˜è¿‡æœŸæœºåˆ¶">3.3. ç¼“å­˜è¿‡æœŸæœºåˆ¶</h2><p><code>CacheKey</code>æ˜¯ä¸€ä¸ª<code>WeakReference</code>ï¼Œå½“gcæ—¶å°±ä¼šè¢«æ¸…ç†æ‰å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™æ—¶éœ€è¦æŠŠ<code>CacheKey</code>ä»<code>Map</code>é‡Œ<code>remove</code>ï¼Œä¸‹é¢è¿™ä¸ªæ–¹æ³•åœ¨<code>WeakCache</code>æ‰§è¡Œè¯»æ“ä½œçš„æ—¶å€™ä¼šæ‰§è¡Œä¸€éã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expungeStaleEntries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CacheKey&lt;K&gt; cacheKey;</span><br><span class="line">    <span class="keyword">while</span> ((cacheKey = (CacheKey&lt;K&gt;)refQueue.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        cacheKey.expungeFrom(map, reverseMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>CacheValue</code>ä¹Ÿæ˜¯è™šå¼•ç”¨ã€‚</p></blockquote><h2 id="InvocationHandleræ³¨å…¥">3.4. InvocationHandleræ³¨å…¥</h2><p>ä»£ç†ç±»å·²ç»ç”Ÿæˆäº†ï¼Œæˆ‘ä»¬å†™çš„<code>InvocationHandler</code>è¿˜æ²¡æœ‰æ³¨å…¥ï¼Œæ‰€ä»¥ç”Ÿæˆä»£ç†ç±»çš„æ—¶å€™æ˜¯ä¸åŒ…å«ä»£ç†é€»è¾‘çš„ã€‚</p><p>æˆ‘ä»¬å›åˆ°<code>Proxy.newProxyInstance</code>æ–¹æ³•ï¼Œè¿™æ—¶å·²ç»è·å–åˆ°<code>class</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</span><br><span class="line"><span class="keyword">final</span> InvocationHandler ih = h;</span><br><span class="line"><span class="keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;</span><br><span class="line">    AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            cons.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</span><br></pre></td></tr></table></figure><p><code>InvocationHandler</code>æ˜¯é€šè¿‡æ„é€ å‚æ•°æ³¨å…¥çš„ã€‚</p><h2 id="ä»£ç†classæ–‡ä»¶çš„å†…å®¹">3.5. ä»£ç†classæ–‡ä»¶çš„å†…å®¹</h2><p>æˆ‘ä»¬ç”ŸæˆåŸºæœ¬çš„classæ–‡ä»¶åªéœ€è¦ç»™ä¸€ä¸ªè‡ªå®šä¹‰ç±»åå’Œä¸€ä¸ªç›®æ ‡ç±»å°±å¯ä»¥äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveJdkProxyClass</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       String path = <span class="string">"./$Proxy0.class"</span>;</span><br><span class="line">       <span class="keyword">byte</span>[] classFile = ProxyGenerator.generateProxyClass(<span class="string">"$Proxy0"</span>, RunnerDefault.class.getInterfaces());</span><br><span class="line">       FileOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           out = <span class="keyword">new</span> FileOutputStream(path);</span><br><span class="line">           out.write(classFile);</span><br><span class="line">           out.flush();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">               out.close();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.htc.learning.api.Runner;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Runner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, Class.forName(<span class="string">"java.lang.Object"</span>));</span><br><span class="line">            m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>);</span><br><span class="line">            m3 = Class.forName(<span class="string">"com.htc.learning.api.Runner"</span>).getMethod(<span class="string">"run"</span>, Class.forName(<span class="string">"java.lang.String"</span>));</span><br><span class="line">            m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>é‚£ä¹ˆcglibæ–¹æ¡ˆçš„ä»£ç†ç±»classæ–‡ä»¶åˆè¦æ€ä¹ˆè·å–å‘¢ï¼Œä¸‹ç¯‡å†è¯´ã€‚</p></blockquote><p>å¯ä»¥çœ‹åˆ°å­—èŠ‚ç é‡Œæ¯ä¸ªç›®æ ‡æ–¹æ³•éƒ½æœ‰ä¸€ä¸ªåŒåçš„ä»£ç†æ–¹æ³•åŒ…ç€ï¼Œä»£ç†é€»è¾‘å·²ç»å†™åœ¨<code>InvocationHandler</code>ï¼Œä»£ç†æ–¹æ³•ç›´æ¥è°ƒç”¨<code>InvocationHandler</code>å°±å¯ä»¥äº†ã€‚</p><h1 id="ä»ä»£ç†ç±»è·å–åŸå§‹å¯¹è±¡çš„Class">4. ä»ä»£ç†ç±»è·å–åŸå§‹å¯¹è±¡çš„Class</h1><p>åœ¨Springé‡Œï¼Œbeanè¢«ä»£ç†æ˜¯å¾ˆå¸¸è§çš„ï¼Œå‡å¦‚æˆ‘ä»¬è¦è·å–ç›®æ ‡beanä¸Šçš„æ³¨è§£ï¼Œè¿™æ—¶å€™æˆ‘ä»¬æ‹¿åˆ°çš„å¦‚æœæ˜¯ä»£ç†ç±»ï¼Œæ˜¯è·å–ä¸åˆ°çš„ç›®æ ‡beanä¸Šçš„æ³¨è§£çš„ã€‚æ‰€ä»¥è¿™æ—¶æˆ‘ä»¬å¾—ä»ä»£ç†ç±»è·å–åŸå§‹å¯¹è±¡ï¼Œå†è·å¾—å¯¹åº”çš„Classã€‚</p><h2 id="æˆ‘çš„åšæ³•">4.1. æˆ‘çš„åšæ³•</h2><p>åœ¨<code>InvocationHandler</code>å®ç°ç±»é‡Œï¼ŒæŠŠç›®æ ‡ç±»å¯¹è±¡æ”¾å…¥äº†ä¸€ä¸ª<code>target</code>æˆå‘˜å˜é‡ï¼Œç„¶åå½“æˆ‘ä»¬æ‹¿åˆ°ä»£ç†ç±»åï¼Œé€šè¿‡è°ƒç”¨<code>java.lang.reflect.Proxy#getInvocationHandler</code>æ–¹æ³•ï¼Œå†é€šè¿‡åå°„å³å¯è·å–åˆ°åŸå§‹å¯¹è±¡<code>target</code>ã€‚</p><h2 id="Springçš„åšæ³•">4.2. Springçš„åšæ³•</h2><p>Springæœ‰ä¸€ä¸ªAopProxyUtilsçš„å·¥å…·ï¼Œå…¶ä¸­æœ‰ä¸ªæ–¹æ³•å¯ä»¥è·å–åˆ°jdkä»£ç†æˆ–cglibä»£ç†çš„åŸå§‹å¯¹è±¡ã€‚å…³äºè¿™ä¸ªå·¥å…·æ›´å¤šä½¿ç”¨å‚è€ƒ<a href="https://www.jianshu.com/p/273d8e2bb992" target="_blank" rel="noopener">AopProxyUtilsè¯¦è§£</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// candidateå³ä¼ å…¥çš„ä»£ç†ç±»å®ä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; ultimateTargetClass(Object candidate) &#123;</span><br><span class="line">Assert.notNull(candidate, <span class="string">"Candidate object must not be null"</span>);</span><br><span class="line">Object current = candidate;</span><br><span class="line">Class&lt;?&gt; result = <span class="keyword">null</span>;</span><br><span class="line">       <span class="comment">// Springçš„ä»£ç†ç±»éƒ½å®ç°äº† TargetClassAwareï¼Œè°ƒç”¨getTargetClass()å¯è·å–åˆ°ç›®æ ‡å¯¹è±¡ï¼Œæ³¨æ„ï¼Œè¿™é‡Œä¸ä¸€å®šæ˜¯åŸå§‹å¯¹è±¡ï¼Œå› ä¸ºå¯èƒ½åˆ‡é¢åˆ‡äº†å¾ˆå¤šæ¬¡ï¼Œç”Ÿæˆäº†å¾ˆå¤šå±‚çš„ä»£ç†ç±»ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªwhileå¾ªç¯</span></span><br><span class="line"><span class="keyword">while</span> (current <span class="keyword">instanceof</span> TargetClassAware) &#123;</span><br><span class="line">result = ((TargetClassAware) current).getTargetClass();</span><br><span class="line">current = getSingletonTarget(current);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// å¦‚æœæ˜¯cglibä»£ç†ï¼Œåˆ™è·å–å¯¹è±¡çˆ¶ç±»ï¼Œå¦åˆ™æ˜¯jdkä»£ç†ï¼Œç›´æ¥è·å–å¯¹è±¡ç±»å‹</span></span><br><span class="line">result = (AopUtils.isCglibProxy(candidate) ? candidate.getClass().getSuperclass() : candidate.getClass());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getSingletonTarget</span><span class="params">(Object candidate)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (candidate <span class="keyword">instanceof</span> Advised) &#123;</span><br><span class="line">TargetSource targetSource = ((Advised) candidate).getTargetSource();</span><br><span class="line"><span class="keyword">if</span> (targetSource <span class="keyword">instanceof</span> SingletonTargetSource) &#123;</span><br><span class="line"><span class="keyword">return</span> ((SingletonTargetSource) targetSource).getTarget();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä»£ç é€»è¾‘çœ‹èµ·æ¥ä¸éš¾ï¼Œä½†æ˜¯æ¶‰åŠäº†Spring Aopçš„æ¥å£æ¦‚å¿µï¼Œæ‰€ä»¥å…·ä½“è°ƒç”¨æˆ‘ä¹Ÿä¸å¤ªæ‡‚æ˜¯å¹²å˜›çš„ã€‚</p><blockquote><p>Springåœ¨ä»£ç†é€»è¾‘ä¸­æ‹¦æˆªäº†<code>getTargetClass()</code>ç­‰åˆ‡é¢æ–¹æ³•ï¼Œå°†è¿™äº›æ–¹æ³•è½¬å‘ç»™<code>Advised</code>å»æ‰§è¡Œã€‚</p></blockquote><h1 id="ç¼ºé™·">5. ç¼ºé™·</h1><p>ä»classæ–‡ä»¶çœ‹ï¼Œç”±äºä»£ç†ç±»ç»§æ‰¿äº†<code>Proxy</code>ç±»ï¼ˆå…¶å®è¿™ä¸ªç±»çœ‹èµ·æ¥ä¹Ÿåªæœ‰ä¸€ä¸ª<code>java.lang.reflect.Proxy#getInvocationHandler</code>æ¯”è¾ƒé€šç”¨çš„æ–¹æ³•ï¼Œå…¶å®æˆ‘è§‰å¾—è¿™ä¸ª<code>InvocationHandler</code>å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°ï¼Œä¸æ‡‚ä¸ºä»€ä¹ˆéè¦ç»§æ‰¿è¿™ä¸ªç±»ï¼Œå–µï¼Ÿï¼‰ï¼Œå¯¼è‡´jdkä»£ç†ä¸èƒ½é€šè¿‡ç»§æ‰¿ç›®æ ‡ç±»æ¥è¾¾åˆ°ä»£ç†çš„ç›®çš„ã€‚</p><h1 id="å…³äºSpring">6. å…³äºSpring</h1><p>Springæœ‰ä¸ªå±æ€§æ˜¯<code>proxy-target-class</code>ï¼Œé»˜è®¤å€¼æ˜¯<code>false</code>ï¼Œè¡¨ç¤ºé»˜è®¤ä½¿ç”¨jdkä»£ç†ï¼Œè¿™æ—¶ä½¿ç”¨å¸¸å¸¸ä¼šå‘ç”Ÿç±»å‹è½¬æ¢çš„é”™è¯¯ï¼Œå› ä¸ºæœ€ç»ˆbeançš„classå·²ç»ä¸æ˜¯æœ€åˆçš„beançš„ç±»å‹ã€‚<br>åœ¨Springbooté‡Œï¼Œ<code>proxy-target-class</code>ä½¿ç”¨<code>spring.aop.proxy-target-class</code>å±æ€§æ¥é…ç½®ï¼Œé»˜è®¤ä¸º<code>true</code>ï¼Œå³éƒ½ä½¿ç”¨<code>cglib</code>æ¥ä»£ç†ã€‚å¦‚æœé…ç½®ä¸º<code>false</code>ï¼ŒSpringbootä¼šå¯¹å®ç°æ¥å£çš„beanä½¿ç”¨jdkä»£ç†ï¼Œå¯¹äºæ²¡æœ‰å®ç°æ¥å£çš„ç±»ä¾æ—§ä½¿ç”¨<code>cglib</code>ä»£ç†ã€‚</p><h1 id="å‚è€ƒ">7. å‚è€ƒ</h1><ol><li><a href="https://www.jianshu.com/p/273d8e2bb992" target="_blank" rel="noopener">AopProxyUtilsè¯¦è§£</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;1. å‰è¨€&lt;/h1&gt;&lt;p&gt;ç›¸æ¯”é™æ€ä»£ç†éœ€è¦æ‰‹åŠ¨å†™ä»£ç†ç±»ï¼ŒåŠ¨æ€ä»£ç†å¯ä»¥é€šè¿‡æŠ½è±¡ä»£ç å®Œæˆå¯¹ä¸€å®šè§„åˆ™çš„ç±»çš„ä»£ç†ï¼Œç”Ÿæˆçš„ä»£ç†ç±»ç›´æ¥ä»¥å­—èŠ‚ç çš„å½¢å¼å­˜åœ¨äºå†…å­˜ä¸­ã€‚Springé‡ŒAopçš„å®ç°ä½¿ç”¨äº†ä¸¤ç§åŠ¨æ€ä»£ç†æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯jdkä»£ç†ï¼Œä¸€ç§æ˜¯&lt;code&gt;cglib&lt;/cod
      
    
    </summary>
    
      <category term="Proxy" scheme="https://htchz.cc/categories/Proxy/"/>
    
    
      <category term="AOP" scheme="https://htchz.cc/tags/AOP/"/>
    
  </entry>
  
</feed>
