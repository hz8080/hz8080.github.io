<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- å¼ºåˆ¶é¡µé¢åœ¨å½“å‰çª—å£ä»¥ç‹¬ç«‹é¡µé¢æ˜¾ç¤º,é˜²æ­¢åˆ«äººåœ¨æ¡†æ¶é‡Œè°ƒç”¨é¡µé¢ -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>[JavaåŸºç¡€]AQSä¸Condition | åœŸå·çš„è‡ªç•™åœ°</title>
  <meta name="description" content="è¿™æ˜¯ä¾èµ–äºReentrantLockçš„ä¸€ä¸ªç±»">
<meta name="keywords" content="multithread">
<meta property="og:type" content="article">
<meta property="og:title" content="[JavaåŸºç¡€]AQSä¸Condition">
<meta property="og:url" content="https://htchz.cc/2912753191.html">
<meta property="og:site_name" content="åœŸå·çš„è‡ªç•™åœ°">
<meta property="og:description" content="è¿™æ˜¯ä¾èµ–äºReentrantLockçš„ä¸€ä¸ªç±»">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://htchz.cc/images/pasted-136.png">
<meta property="og:updated_time" content="2018-10-22T03:34:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[JavaåŸºç¡€]AQSä¸Condition">
<meta name="twitter:description" content="è¿™æ˜¯ä¾èµ–äºReentrantLockçš„ä¸€ä¸ªç±»">
<meta name="twitter:image" content="https://htchz.cc/images/pasted-136.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://htchz.cc/2912753191.html">
  
    <link rel="alternate" href="/atom.xml" title="åœŸå·çš„è‡ªç•™åœ°" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/unnamed.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
</head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/fennecs" target="_blank">
          <img class="img-circle img-rotate" src="/images/unnamed.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">åœŸå·</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">åç«¯ç å†œ</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Guangzhou, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="æœç´¢" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">é¦–é¡µ</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">å½’æ¡£</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">åˆ†ç±»</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">æ ‡ç­¾</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">å…³äº</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/fennecs" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">å…¬å‘Š</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>ç¢§æ²¹é¸¡!ç¢§æ²¹é¸¡ï¼</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">åˆ†ç±»</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DB/">DB</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Firebase/">Firebase</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GolangåŸºç¡€/">GolangåŸºç¡€</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaåŸºç¡€/">JavaåŸºç¡€</a><span class="category-list-count">48</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Proxy/">Proxy</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/åˆ†å¸ƒå¼/">åˆ†å¸ƒå¼</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å®¹å™¨/">å®¹å™¨</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å»ºç«™/">å»ºç«™</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å¾®æœåŠ¡/">å¾®æœåŠ¡</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/æœåŠ¡å™¨/">æœåŠ¡å™¨</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç¢ç¢å¿µ/">ç¢ç¢å¿µ</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç½‘ç»œ/">ç½‘ç»œ</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">æ ‡ç­¾</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/">AOP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BT/">BT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BUG/">BUG</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bean/">Bean</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GC/">GC</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Https/">Https</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hystrix/">Hystrix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IOC/">IOC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javaé›†åˆ/">Javaé›†åˆ</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Json/">Json</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/">NIO</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OOP/">OOP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/">TCP</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZAB/">ZAB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bbr/">bbr</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deploy/">deploy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/goroutine/">goroutine</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/istio/">istio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdk8/">jdk8</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/">k8s</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/multithread/">multithread</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/properties/">properties</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raft/">raft</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ä¸€è‡´æ€§ç®—æ³•/">ä¸€è‡´æ€§ç®—æ³•</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ä½å›¾/">ä½å›¾</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ä½è¿ç®—/">ä½è¿ç®—</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/å‘/">å‘</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æ•°æ®åˆ†ç‰‡/">æ•°æ®åˆ†ç‰‡</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æœåŠ¡é™æµ/">æœåŠ¡é™æµ</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æ­£åˆ™/">æ­£åˆ™</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/è¿ç»´/">è¿ç»´</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">æ ‡ç­¾äº‘</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/AOP/" style="font-size: 13.29px;">AOP</a> <a href="/tags/BT/" style="font-size: 13px;">BT</a> <a href="/tags/BUG/" style="font-size: 13.43px;">BUG</a> <a href="/tags/Bean/" style="font-size: 13px;">Bean</a> <a href="/tags/GC/" style="font-size: 13.57px;">GC</a> <a href="/tags/HTTP/" style="font-size: 13px;">HTTP</a> <a href="/tags/Hexo/" style="font-size: 13px;">Hexo</a> <a href="/tags/Https/" style="font-size: 13px;">Https</a> <a href="/tags/Hystrix/" style="font-size: 13px;">Hystrix</a> <a href="/tags/IOC/" style="font-size: 13px;">IOC</a> <a href="/tags/JVM/" style="font-size: 13.71px;">JVM</a> <a href="/tags/Javaé›†åˆ/" style="font-size: 14px;">Javaé›†åˆ</a> <a href="/tags/Json/" style="font-size: 13px;">Json</a> <a href="/tags/Mysql/" style="font-size: 13.14px;">Mysql</a> <a href="/tags/NIO/" style="font-size: 13.14px;">NIO</a> <a href="/tags/Nginx/" style="font-size: 13px;">Nginx</a> <a href="/tags/OOP/" style="font-size: 13.29px;">OOP</a> <a href="/tags/TCP/" style="font-size: 13.14px;">TCP</a> <a href="/tags/ZAB/" style="font-size: 13px;">ZAB</a> <a href="/tags/bbr/" style="font-size: 13px;">bbr</a> <a href="/tags/deploy/" style="font-size: 13px;">deploy</a> <a href="/tags/goroutine/" style="font-size: 13.14px;">goroutine</a> <a href="/tags/istio/" style="font-size: 13px;">istio</a> <a href="/tags/jdk8/" style="font-size: 13.14px;">jdk8</a> <a href="/tags/k8s/" style="font-size: 13.14px;">k8s</a> <a href="/tags/multithread/" style="font-size: 13.86px;">multithread</a> <a href="/tags/properties/" style="font-size: 13px;">properties</a> <a href="/tags/raft/" style="font-size: 13.14px;">raft</a> <a href="/tags/ä¸€è‡´æ€§ç®—æ³•/" style="font-size: 13.14px;">ä¸€è‡´æ€§ç®—æ³•</a> <a href="/tags/ä½å›¾/" style="font-size: 13px;">ä½å›¾</a> <a href="/tags/ä½è¿ç®—/" style="font-size: 13px;">ä½è¿ç®—</a> <a href="/tags/å‘/" style="font-size: 13px;">å‘</a> <a href="/tags/æ•°æ®åˆ†ç‰‡/" style="font-size: 13px;">æ•°æ®åˆ†ç‰‡</a> <a href="/tags/æœåŠ¡é™æµ/" style="font-size: 13.14px;">æœåŠ¡é™æµ</a> <a href="/tags/æ­£åˆ™/" style="font-size: 13px;">æ­£åˆ™</a> <a href="/tags/è¿ç»´/" style="font-size: 13px;">è¿ç»´</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">å½’æ¡£</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">äºŒæœˆ 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">ä¸€æœˆ 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">åäºŒæœˆ 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">åæœˆ 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">å…«æœˆ 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">ä¸ƒæœˆ 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">äº”æœˆ 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">ä¸‰æœˆ 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">ä¸€æœˆ 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">åäºŒæœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">åä¸€æœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">åæœˆ 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">ä¹æœˆ 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">å…«æœˆ 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">ä¸ƒæœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">å…­æœˆ 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">äº”æœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">å››æœˆ 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">ä¸‰æœˆ 2018</a><span class="archive-list-count">38</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse in" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">æ–‡ç« ç›®å½•</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#çº¿ç¨‹æŒ‚èµ·"><span class="toc-text">1. çº¿ç¨‹æŒ‚èµ·</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#çº¿ç¨‹å”¤é†’"><span class="toc-text">2. çº¿ç¨‹å”¤é†’</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#å”¤é†’åçš„æ“ä½œ"><span class="toc-text">3. å”¤é†’åçš„æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#å…³äºinterruptMode"><span class="toc-text">3.1. å…³äºinterruptMode</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#å…¶ä»–await"><span class="toc-text">4. å…¶ä»–await</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#è¶…æ—¶await"><span class="toc-text">4.1. è¶…æ—¶await</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¸æŠ›ä¸­æ–­å¼‚å¸¸çš„await"><span class="toc-text">5. ä¸æŠ›ä¸­æ–­å¼‚å¸¸çš„await</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ReentrantLockçš„ä¸­æ–­é”"><span class="toc-text">6. ReentrantLockçš„ä¸­æ–­é”</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-JavaåŸºç¡€-Condition" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      [JavaåŸºç¡€]AQSä¸Condition
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2912753191.html" class="article-date">
	  <time datetime="2018-08-27T03:43:00.000Z" itemprop="datePublished">2018-08-27</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/JavaåŸºç¡€/">JavaåŸºç¡€</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/multithread/">multithread</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2912753191.html#comments" class="article-comment-link">è¯„è®º</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">å­—æ•°ç»Ÿè®¡: 4.1k(å­—)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">é˜…è¯»æ—¶é•¿: 18(åˆ†)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <blockquote>
<p>è¿™æ˜¯ä¾èµ–äºReentrantLockçš„ä¸€ä¸ªç±»</p>
</blockquote>
<a id="more"></a>
<p>ConditionåŸºäºReentrantLockï¼Œè¿™é‡Œæœ‰ Doug Lea ä¸¾çš„ğŸŒ°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedBuffer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="comment">// condition ä¾èµ–äº lock æ¥äº§ç”Ÿ</span></span><br><span class="line">    <span class="keyword">final</span> Condition notFull = lock.newCondition();</span><br><span class="line">    <span class="keyword">final</span> Condition notEmpty = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">new</span> Object[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">int</span> putptr, takeptr, count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿäº§</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object x)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == items.length)</span><br><span class="line">                notFull.await();  <span class="comment">// é˜Ÿåˆ—å·²æ»¡ï¼Œç­‰å¾…ï¼Œç›´åˆ° not full æ‰èƒ½ç»§ç»­ç”Ÿäº§</span></span><br><span class="line">            items[putptr] = x;</span><br><span class="line">            <span class="keyword">if</span> (++putptr == items.length) putptr = <span class="number">0</span>;</span><br><span class="line">            ++count;</span><br><span class="line">            notEmpty.signal(); <span class="comment">// ç”Ÿäº§æˆåŠŸï¼Œé˜Ÿåˆ—å·²ç» not empty äº†ï¼Œå‘ä¸ªé€šçŸ¥å‡ºå»</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¶ˆè´¹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>)</span><br><span class="line">                notEmpty.await(); <span class="comment">// é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ— not emptyï¼Œæ‰èƒ½ç»§ç»­æ¶ˆè´¹</span></span><br><span class="line">            Object x = items[takeptr];</span><br><span class="line">            <span class="keyword">if</span> (++takeptr == items.length) takeptr = <span class="number">0</span>;</span><br><span class="line">            --count;</span><br><span class="line">            notFull.signal(); <span class="comment">// è¢«æˆ‘æ¶ˆè´¹æ‰ä¸€ä¸ªï¼Œé˜Ÿåˆ— not full äº†ï¼Œå‘ä¸ªé€šçŸ¥å‡ºå»</span></span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå…¶å®å°±æ˜¯<code>ArrayBlockingQueue</code>çš„åŸç†ã€‚</p>
<p>è·å–ä¸€ä¸ªConditionå®ä¾‹è¦é€šè¿‡ReentrantLockå®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ConditionObject <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> ConditionObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionObject</span> <span class="keyword">implements</span> <span class="title">Condition</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1173984872572414699L</span>;</span><br><span class="line">    <span class="comment">/** First node of condition queue. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line">    <span class="comment">/** Last node of condition queue. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šåˆ©ç”¨<code>Node</code>çš„<code>nextWaiter</code>å±æ€§ï¼Œconditionç»´æŠ¤äº†ä¸€ä¸ªå•å‘é“¾è¡¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Link to next node waiting on condition, or the special</span></span><br><span class="line"><span class="comment"> * value SHARED.  Because condition queues are accessed only</span></span><br><span class="line"><span class="comment"> * when holding in exclusive mode, we just need a simple</span></span><br><span class="line"><span class="comment"> * linked queue to hold nodes while they are waiting on</span></span><br><span class="line"><span class="comment"> * conditions. They are then transferred to the queue to</span></span><br><span class="line"><span class="comment"> * re-acquire. And because conditions can only be exclusive,</span></span><br><span class="line"><span class="comment"> * we save a field by using special value to indicate shared</span></span><br><span class="line"><span class="comment"> * mode.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Node nextWaiter;</span><br></pre></td></tr></table></figure>

<p>å·æ¥ä¸€å¼ å›¾ï¼Œæˆ‘ä»¬æŠŠä¸Šä¸€èŠ‚çš„é˜Ÿåˆ—ç§°ä¸ºé˜»å¡é˜Ÿåˆ—ï¼ŒæŠŠconditionçš„é˜Ÿåˆ—å«åšæ¡ä»¶é˜Ÿåˆ—ã€‚<br><img src="/images/pasted-136.png" alt="upload successful"></p>
<ol>
<li>å½“conditionè°ƒç”¨<code>await()</code>çš„æ—¶å€™å°±æŠŠå½“å‰çº¿ç¨‹å°è£…ä¸ºä¸€ä¸ªNodeæ”¾åˆ°<code>lastWaiter</code>ï¼Œå¹¶ä¸”æŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚</li>
<li>å½“conditionè°ƒç”¨<code>signal()</code>çš„æ—¶å€™å°±æŠŠ<code>firstWaiter</code>æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ã€‚</li>
</ol>
<h1 id="çº¿ç¨‹æŒ‚èµ·">1. çº¿ç¨‹æŒ‚èµ·</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¯è¢«ä¸­æ–­çš„ï¼Œä¸å¯è¢«ä¸­æ–­çš„æ˜¯å¦ä¸€ä¸ªæ–¹æ³• awaitUninterruptibly()</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°è°ƒç”¨ signal æ–¹æ³•ï¼ˆæŒ‡ signal() å’Œ signalAll()ï¼Œä¸‹åŒï¼‰ï¼Œæˆ–è¢«ä¸­æ–­</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ° condition çš„æ¡ä»¶é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”ï¼Œè¿”å›å€¼æ˜¯é‡Šæ”¾é”ä¹‹å‰çš„ state å€¼</span></span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// è¿™é‡Œé€€å‡ºå¾ªç¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¹‹åå†ä»”ç»†åˆ†æ</span></span><br><span class="line">    <span class="comment">// 1. isOnSyncQueue(node) è¿”å› trueï¼Œå³å½“å‰ node å·²ç»è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†</span></span><br><span class="line">    <span class="comment">// 2. checkInterruptWhileWaiting(node) != 0 ä¼šåˆ° breakï¼Œç„¶åé€€å‡ºå¾ªç¯ï¼Œä»£è¡¨çš„æ˜¯çº¿ç¨‹ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¢«å”¤é†’åï¼Œå°†è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…è·å–é”</span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹<code>addConditionWaiter()</code>ï¼ŒæŠŠå½“å‰çº¿ç¨‹åŠ å…¥æ¡ä»¶é˜Ÿåˆ—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds a new waiter to wait queue.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> its new wait node</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = lastWaiter;</span><br><span class="line">    <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸ºä»€ä¹ˆæ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿå› ä¸ºConditionéœ€è¦å’ŒReentrantLock.lock()ä¸€èµ·ä½¿ç”¨ï¼Œä¸ä¸€èµ·ä½¿ç”¨ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿå°±ä¸å®‰å…¨äº†</p>
</blockquote>
<p>å–æ¶ˆèŠ‚ç‚¹çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œéå†é“¾è¡¨å°†å·²ç»å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹æ¸…é™¤å‡ºå»</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unlinkCancelledWaiters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = firstWaiter;</span><br><span class="line">    Node trail = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Node next = t.nextWaiter;</span><br><span class="line">        <span class="comment">// å¦‚æœèŠ‚ç‚¹çš„çŠ¶æ€ä¸æ˜¯ Node.CONDITION çš„è¯ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯è¢«å–æ¶ˆçš„</span></span><br><span class="line">        <span class="keyword">if</span> (t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            t.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (trail == <span class="keyword">null</span>)</span><br><span class="line">                firstWaiter = next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                trail.nextWaiter = next;</span><br><span class="line">            <span class="keyword">if</span> (next == <span class="keyword">null</span>)</span><br><span class="line">                lastWaiter = trail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            trail = t;</span><br><span class="line">        t = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŠ å…¥æ¡ä»¶é˜Ÿåˆ—ä¹‹åï¼Œå°±å®Œå…¨é‡Šæ”¾ç‹¬å é”ï¼Œè®©å‡ºé”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆï¼Œæˆ‘ä»¬è¦å…ˆè§‚å¯Ÿåˆ°è¿”å›å€¼ savedState ä»£è¡¨ release ä¹‹å‰çš„ state å€¼</span></span><br><span class="line"><span class="comment">// å¯¹äºæœ€ç®€å•çš„æ“ä½œï¼šå…ˆ lock.lock()ï¼Œç„¶å condition1.await()ã€‚</span></span><br><span class="line"><span class="comment">//         é‚£ä¹ˆ state ç»è¿‡è¿™ä¸ªæ–¹æ³•ç”± 1 å˜ä¸º 0ï¼Œé”é‡Šæ”¾ï¼Œæ­¤æ–¹æ³•è¿”å› 1</span></span><br><span class="line"><span class="comment">//         ç›¸åº”çš„ï¼Œå¦‚æœ lock é‡å…¥äº† n æ¬¡ï¼ŒsavedState == n</span></span><br><span class="line"><span class="comment">// å¦‚æœè¿™ä¸ªæ–¹æ³•å¤±è´¥ï¼Œä¼šå°†èŠ‚ç‚¹è®¾ç½®ä¸º"å–æ¶ˆ"çŠ¶æ€ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ IllegalMonitorStateException</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> savedState = getState();</span><br><span class="line">        <span class="comment">// è¿™é‡Œä½¿ç”¨äº†å½“å‰çš„ state ä½œä¸º release çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å®Œå…¨é‡Šæ”¾æ‰é”ï¼Œå°† state ç½®ä¸º 0</span></span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            failed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡Šæ”¾æ‰é”ä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨é˜»å¡é˜Ÿåˆ—é‡Œé¢ï¼Œå¦‚æœä¸åœ¨ï¼ŒæŒ‚èµ·ï¼Œè‡ªæ—‹ç›´åˆ°è¿›å…¥é˜»å¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æŒ‚èµ·</span></span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>isOnSyncQueue(Node node)</code>ç”¨äºåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²ç»è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isOnSyncQueue</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// ç§»åŠ¨è¿‡å»çš„æ—¶å€™ï¼Œnode çš„ waitStatus ä¼šç½®ä¸º 0ï¼Œè¿™ä¸ªä¹‹ååœ¨è¯´ signal æ–¹æ³•çš„æ—¶å€™ä¼šè¯´åˆ°</span></span><br><span class="line">     <span class="comment">// node.prev == nullï¼Œé‚£ä¹ˆè‚¯å®šæ²¡æœ‰è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œnode.prev != null, ä¸ä¸€å®šè¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå› ä¸ºä¸Šç¯‡çš„AQSè®²åˆ°Nodeå…¥é˜Ÿé¦–å…ˆè®¾ç½®çš„æ˜¯ node.prev æŒ‡å‘ tailï¼Œ</span></span><br><span class="line">     <span class="comment">// ç„¶åæ˜¯ CAS æ“ä½œå°†è‡ªå·±è®¾ç½®ä¸ºæ–°çš„ tailï¼Œå¯æ˜¯è¿™æ¬¡çš„ CAS æ˜¯å¯èƒ½å¤±è´¥çš„ã€‚</span></span><br><span class="line">     <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="keyword">null</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">     <span class="keyword">if</span> (node.next != <span class="keyword">null</span>) <span class="comment">// If has successor, it must be on queue</span></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">     <span class="comment">// </span></span><br><span class="line">     <span class="keyword">return</span> findNodeFromTail(node);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»åŒæ­¥é˜Ÿåˆ—(é˜»å¡é˜Ÿåˆ—)çš„é˜Ÿå°¾å¾€å‰éå†ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œè¿”å› true</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">findNodeFromTail</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    Node t = tail;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t == node)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        t = t.prev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="çº¿ç¨‹å”¤é†’">2. çº¿ç¨‹å”¤é†’</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å”¤é†’ç­‰å¾…äº†æœ€ä¹…çš„çº¿ç¨‹</span></span><br><span class="line"><span class="comment">// å…¶å®å°±æ˜¯ï¼Œå°†è¿™ä¸ªçº¿ç¨‹å¯¹åº”çš„ node ä»æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ signal æ–¹æ³•çš„çº¿ç¨‹å¿…é¡»æŒæœ‰å½“å‰çš„ç‹¬å é”</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    Node first = firstWaiter;</span><br><span class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»æ¡ä»¶é˜Ÿåˆ—é˜Ÿå¤´å¾€åéå†ï¼Œæ‰¾å‡ºç¬¬ä¸€ä¸ªéœ€è¦è½¬ç§»çš„ node</span></span><br><span class="line"><span class="comment">// å› ä¸ºå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œæœ‰äº›çº¿ç¨‹ä¼šå–æ¶ˆæ’é˜Ÿï¼Œä½†æ˜¯è¿˜åœ¨é˜Ÿåˆ—ä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">          <span class="comment">// å°† firstWaiter æŒ‡å‘ first èŠ‚ç‚¹åé¢çš„ç¬¬ä¸€ä¸ª</span></span><br><span class="line">        <span class="comment">// å¦‚æœå°†é˜Ÿå¤´ç§»é™¤åï¼Œåé¢æ²¡æœ‰èŠ‚ç‚¹åœ¨ç­‰å¾…äº†ï¼Œé‚£ä¹ˆéœ€è¦å°† lastWaiter ç½®ä¸º null</span></span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">            lastWaiter = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// å› ä¸º first é©¬ä¸Šè¦è¢«ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†ï¼Œå’Œæ¡ä»¶é˜Ÿåˆ—çš„é“¾æ¥å…³ç³»åœ¨è¿™é‡Œæ–­æ‰</span></span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">             (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">      <span class="comment">// è¿™é‡Œ while å¾ªç¯ï¼Œå¦‚æœ first è½¬ç§»ä¸æˆåŠŸï¼Œé‚£ä¹ˆé€‰æ‹© first åé¢çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè½¬ç§»ï¼Œä¾æ­¤ç±»æ¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è½¬ç§»èŠ‚ç‚¹çš„ä»£ç ï¼Œå¹¶ä¸”å”¤é†’é˜»å¡çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†èŠ‚ç‚¹ä»æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">// true ä»£è¡¨æˆåŠŸè½¬ç§»</span></span><br><span class="line"><span class="comment">// false ä»£è¡¨åœ¨ signal ä¹‹å‰ï¼ŒèŠ‚ç‚¹å·²ç»å–æ¶ˆäº†</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CAS å¦‚æœå¤±è´¥ï¼Œè¯´æ˜æ­¤ node çš„ waitStatus å·²ä¸æ˜¯ Node.CONDITIONï¼Œè¯´æ˜èŠ‚ç‚¹å·²ç»å–æ¶ˆï¼Œ</span></span><br><span class="line">    <span class="comment">// æ—¢ç„¶å·²ç»å–æ¶ˆï¼Œä¹Ÿå°±ä¸éœ€è¦è½¬ç§»äº†ï¼Œæ–¹æ³•è¿”å›ï¼Œè½¬ç§»åé¢ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// å¦åˆ™ï¼Œå°† waitStatus ç½®ä¸º 0</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// enq(node): è‡ªæ—‹è¿›å…¥é˜»å¡é˜Ÿåˆ—çš„é˜Ÿå°¾</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œçš„è¿”å›å€¼ p æ˜¯ node åœ¨é˜»å¡é˜Ÿåˆ—çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    Node p = enq(node);</span><br><span class="line">    <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">    <span class="comment">// ws &gt; 0 è¯´æ˜ node åœ¨é˜»å¡é˜Ÿåˆ—ä¸­çš„å‰é©±èŠ‚ç‚¹å–æ¶ˆäº†ç­‰å¾…é”ï¼Œç›´æ¥å”¤é†’ node å¯¹åº”çš„çº¿ç¨‹ã€‚å”¤é†’ä¹‹åä¼šæ€ä¹ˆæ ·ï¼Œåé¢å†è§£é‡Š</span></span><br><span class="line">    <span class="comment">// å¦‚æœ ws &lt;= 0, é‚£ä¹ˆ compareAndSetWaitStatus å°†ä¼šè¢«è°ƒç”¨ï¼Œä¸Šç¯‡ä»‹ç»çš„æ—¶å€™è¯´è¿‡ï¼ŒèŠ‚ç‚¹å…¥é˜Ÿåï¼Œéœ€è¦æŠŠå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ä¸º Node.SIGNAL(-1)</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹å–æ¶ˆæˆ–è€… CAS å¤±è´¥ï¼Œä¼šè¿›åˆ°è¿™é‡Œå”¤é†’çº¿ç¨‹ï¼Œä¹‹åçš„æ“ä½œçœ‹ä¸‹ä¸€èŠ‚</span></span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL) è¿™å¥ä¸­ï¼Œå¦‚æœws &lt;= 0ï¼Œé‚£ä¹ˆä¸€èˆ¬ compareAndSetWaitStatus(p, ws, Node.SIGNAL) ä¼šè¿”å› trueï¼Œæ‰€ä»¥ä¸€èˆ¬ä¹Ÿä¸ä¼šè¿›å» if è¯­å¥å—ä¸­å”¤é†’ node å¯¹åº”çš„çº¿ç¨‹ã€‚ç„¶åè¿™ä¸ªæ–¹æ³•è¿”å› trueï¼Œä¹Ÿå°±æ„å‘³ç€ signal æ–¹æ³•ç»“æŸäº†ï¼ŒèŠ‚ç‚¹è¿›å…¥äº†é˜»å¡é˜Ÿåˆ—ã€‚</p>
<p>å‡è®¾å‘ç”Ÿäº†é˜»å¡é˜Ÿåˆ—ä¸­çš„å‰é©±èŠ‚ç‚¹å–æ¶ˆç­‰å¾…ï¼Œæˆ–è€… CAS å¤±è´¥ï¼Œåªè¦å”¤é†’çº¿ç¨‹ï¼Œè®©å…¶è¿›åˆ°ä¸‹ä¸€æ­¥å³å¯</p>
<blockquote>
<p>æ²¡æœ‰å”¤é†’çš„è¯ï¼Œå› ä¸ºå·²ç»åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…å‰é©±èŠ‚ç‚¹å»å”¤é†’ã€‚</p>
</blockquote>
<h1 id="å”¤é†’åçš„æ“ä½œ">3. å”¤é†’åçš„æ“ä½œ</h1><p>ä¸Šä¸€æ­¥ signal ä¹‹åï¼Œæˆ‘ä»¬çš„çº¿ç¨‹ç”±æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°äº†é˜»å¡é˜Ÿåˆ—ï¼Œä¹‹åå°±å‡†å¤‡è·å–é”äº†ã€‚åªè¦é‡æ–°è·å–åˆ°é”äº†ä»¥åï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p>
<p>ç­‰çº¿ç¨‹ä»æŒ‚èµ·ä¸­æ¢å¤è¿‡æ¥ï¼Œç»§ç»­å¾€ä¸‹çœ‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æŒ‚èµ·</span></span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å…³äºinterruptMode">3.1. å…³äºinterruptMode</h2><ul>
<li>REINTERRUPTï¼š ä»£è¡¨ await è¿”å›çš„æ—¶å€™ï¼Œéœ€è¦é‡æ–°è®¾ç½®ä¸­æ–­çŠ¶æ€</li>
<li>THROW_IEï¼š ä»£è¡¨ await è¿”å›çš„æ—¶å€™ï¼Œéœ€è¦æŠ›å‡ºInterruptedException å¼‚å¸¸</li>
<li>0 ï¼šè¯´æ˜åœ¨ await æœŸé—´ï¼Œæ²¡æœ‰å‘ç”Ÿä¸­æ–­</li>
</ul>
<p>æœ‰ä¸‰ç§æƒ…å†µå¯ä»¥è®©<code>LockSupport.park(this);</code>è¿”å›ï¼š</p>
<ol>
<li>å¸¸è§„è·¯å¾„ã€‚signal -&gt; è½¬ç§»èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ— -&gt; ç­‰å¾…å‰é©±èŠ‚ç‚¹å”¤é†’</li>
<li>çº¿ç¨‹ä¸­æ–­ã€‚åœ¨ park çš„æ—¶å€™ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªçº¿ç¨‹è¿›è¡Œäº†ä¸­æ–­</li>
<li>signal()çš„æ—¶å€™ï¼Œè½¬ç§»ä»¥åçš„å‰é©±èŠ‚ç‚¹å–æ¶ˆäº†ï¼Œæˆ–è€…å¯¹å‰é©±èŠ‚ç‚¹çš„CASæ“ä½œå¤±è´¥äº†</li>
<li>å‡å”¤é†’ã€‚è¿™ä¸ªä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œå’Œ Object.wait() ç±»ä¼¼ï¼Œéƒ½æœ‰è¿™ä¸ªé—®é¢˜</li>
</ol>
<p>çº¿ç¨‹å”¤é†’åç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨ checkInterruptWhileWaiting(node) è¿™ä¸ªæ–¹æ³•ï¼Œæ­¤æ–¹æ³•ç”¨äºåˆ¤æ–­æ˜¯å¦åœ¨çº¿ç¨‹æŒ‚èµ·æœŸé—´å‘ç”Ÿäº†ä¸­æ–­ï¼Œå¦‚æœå‘ç”Ÿäº†ä¸­æ–­ï¼Œæ˜¯ signal è°ƒç”¨ä¹‹å‰ä¸­æ–­çš„ï¼Œè¿˜æ˜¯ signal ä¹‹åå‘ç”Ÿçš„ä¸­æ–­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. å¦‚æœåœ¨ signal ä¹‹å‰å·²ç»ä¸­æ–­ï¼Œè¿”å› THROW_IE</span></span><br><span class="line"><span class="comment">// 2. å¦‚æœæ˜¯ signal ä¹‹åä¸­æ–­ï¼Œè¿”å› REINTERRUPT</span></span><br><span class="line"><span class="comment">// 3. æ²¡æœ‰å‘ç”Ÿä¸­æ–­ï¼Œè¿”å› 0</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">checkInterruptWhileWaiting</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted() ?</span><br><span class="line">        (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) :</span><br><span class="line">        <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ¤æ–­signalä¹‹å‰è¿˜æ˜¯ä¹‹åä¸­æ–­çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åªæœ‰çº¿ç¨‹å¤„äºä¸­æ–­çŠ¶æ€ï¼Œæ‰ä¼šè°ƒç”¨æ­¤æ–¹æ³•</span></span><br><span class="line"><span class="comment">// å¦‚æœéœ€è¦çš„è¯ï¼Œå°†è¿™ä¸ªå·²ç»å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">// è¿”å› trueï¼šå¦‚æœæ­¤çº¿ç¨‹åœ¨ signal ä¹‹å‰è¢«å–æ¶ˆï¼Œ</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferAfterCancelledWait</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç”¨ CAS å°†èŠ‚ç‚¹çŠ¶æ€è®¾ç½®ä¸º 0 </span></span><br><span class="line">    <span class="comment">// å¦‚æœè¿™æ­¥ CAS æˆåŠŸï¼Œè¯´æ˜æ˜¯ signal æ–¹æ³•ä¹‹å‰å‘ç”Ÿçš„ä¸­æ–­ï¼Œå› ä¸ºå¦‚æœ signal å…ˆå‘ç”Ÿçš„è¯ï¼Œsignal ä¸­ä¼šå°† waitStatus è®¾ç½®ä¸º 0</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// å°†èŠ‚ç‚¹æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå³ä½¿ä¸­æ–­äº†ï¼Œä¾ç„¶ä¼šè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ°è¿™é‡Œæ˜¯å› ä¸º CAS å¤±è´¥ï¼Œè‚¯å®šæ˜¯å› ä¸º signal æ–¹æ³•å·²ç»å°† waitStatus è®¾ç½®ä¸ºäº† 0</span></span><br><span class="line">    <span class="comment">// signal æ–¹æ³•ä¼šå°†èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯å¯èƒ½è¿˜æ²¡å®Œæˆï¼Œè¿™è¾¹è‡ªæ—‹ç­‰å¾…å…¶å®Œæˆ</span></span><br><span class="line">    <span class="comment">// å½“ç„¶ï¼Œè¿™ç§äº‹æƒ…è¿˜æ˜¯æ¯”è¾ƒå°‘çš„å§ï¼šsignal è°ƒç”¨ä¹‹åï¼Œæ²¡å®Œæˆè½¬ç§»ä¹‹å‰ï¼Œå‘ç”Ÿäº†ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node))</span><br><span class="line">        Thread.yield();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å°±æ˜¯è®¨è®ºçº¿ç¨‹ä¸­æ–­åæ€ä¹ˆè®©ç¨‹åºæ¢å¤æ­£å¸¸ã€‚</p>
<ol>
<li>signalä¹‹å‰ä¸­æ–­ï¼Œæ‰§è¡Œ<code>enq(node)</code>ï¼Œç¡®ä¿è¿›å…¥é˜»å¡é˜Ÿåˆ—ã€‚</li>
<li>signalä¹‹åä¸­æ–­ï¼Œæ²¡è½¬ç§»å®Œæˆï¼ˆåˆ¤æ–­<code>waitStatus==0</code>),è®©å‡ºcpuï¼Œè‡ªæ—‹ç›´è‡³enq(node)æ‰§è¡Œå®Œæˆã€‚</li>
</ol>
<p>æ¥ç€è·å–ç‹¬å é”ï¼Œçœ‹æ¥ä¸‹æ¥çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">    interruptMode = REINTERRUPT;</span><br></pre></td></tr></table></figure>

<p>ç”±äº while å‡ºæ¥åï¼Œæˆ‘ä»¬ç¡®å®šèŠ‚ç‚¹å·²ç»è¿›å…¥äº†é˜»å¡é˜Ÿåˆ—ï¼Œå‡†å¤‡è·å–é”ã€‚</p>
<p>è¿™é‡Œçš„ acquireQueued(node, savedState) çš„ç¬¬ä¸€ä¸ªå‚æ•° node ä¹‹å‰å·²ç»ç»è¿‡ enq(node) è¿›å…¥äº†é˜Ÿåˆ—ï¼Œå‚æ•° savedState æ˜¯ä¹‹å‰é‡Šæ”¾é”å‰çš„ stateï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„æ—¶å€™ï¼Œä»£è¡¨å½“å‰çº¿ç¨‹è·å–äº†é”ï¼Œè€Œä¸” state == savedStateäº†, åŸæ¥é‡å…¥äº†å‡ æ¬¡ï¼Œç°åœ¨è¿˜æ˜¯ç®—å‡ æ¬¡ã€‚</p>
<p>æ³¨æ„ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œä¸ç®¡æœ‰æ²¡æœ‰å‘ç”Ÿä¸­æ–­ï¼Œéƒ½ä¼šè¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œè€Œ acquireQueued(node, savedState) çš„è¿”å›å€¼å°±æ˜¯ä»£è¡¨çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ã€‚å¦‚æœè¿”å› trueï¼Œè¯´æ˜è¢«ä¸­æ–­äº†ï¼Œè€Œä¸” interruptMode != THROW_IEï¼Œè¯´æ˜åœ¨ signal ä¹‹å‰å°±å‘ç”Ÿä¸­æ–­äº†ï¼Œè¿™é‡Œå°† interruptMode è®¾ç½®ä¸º REINTERRUPTï¼Œç”¨äºå¾…ä¼šé‡æ–°ä¸­æ–­ã€‚</p>
<p>ç»§ç»­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">    unlinkCancelledWaiters();</span><br><span class="line"><span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">    reportInterruptAfterWait(interruptMode);</span><br></pre></td></tr></table></figure>

<p><code>node.nextWaiter != null</code>ä¾æ—§æ˜¯å¯¹ä¸­æ–­çš„å–„åï¼Œå‰é¢signal çš„æ—¶å€™ä¼šå°†èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œæœ‰ä¸€æ­¥æ˜¯ node.nextWaiter = nullï¼Œå°†æ–­å¼€èŠ‚ç‚¹å’Œæ¡ä»¶é˜Ÿåˆ—çš„è”ç³»ã€‚</p>
<p>å¯æ˜¯ï¼Œåœ¨åˆ¤æ–­å‘ç”Ÿä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œæ˜¯ signal ä¹‹å‰è¿˜æ˜¯ä¹‹åå‘ç”Ÿçš„ï¼Ÿ è¿™éƒ¨åˆ†çš„æ—¶å€™ï¼Œæˆ‘ä¹Ÿä»‹ç»äº†ï¼Œå¦‚æœ signal ä¹‹å‰å°±ä¸­æ–­äº†ï¼Œä¹Ÿéœ€è¦å°†èŠ‚ç‚¹è¿›è¡Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œè¿™éƒ¨åˆ†è½¬ç§»çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰è®¾ç½® node.nextWaiter = null çš„ã€‚</p>
<p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œå¦‚æœæœ‰èŠ‚ç‚¹å–æ¶ˆï¼Œä¹Ÿä¼šè°ƒç”¨ unlinkCancelledWaiters è¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯è¿™é‡Œäº†ã€‚</p>
<p>æ¥ä¸‹æ¥æ˜¯è¿›å…¥<code>reportInterruptAfterWait</code>ä»£ç å—ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Throws InterruptedException, reinterrupts current thread, or</span></span><br><span class="line"><span class="comment">  * does nothing, depending on mode.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reportInterruptAfterWait</span><span class="params">(<span class="keyword">int</span> interruptMode)</span></span></span><br><span class="line"><span class="function">     <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">     <span class="comment">// THROW_IE è·‘å‡ºå¼‚å¸¸</span></span><br><span class="line">     <span class="keyword">if</span> (interruptMode == THROW_IE)</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">     <span class="comment">// é‡æ–°ä¸­æ–­ï¼Œè‡ªæˆ‘äº†æ–­</span></span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (interruptMode == REINTERRUPT)</span><br><span class="line">         selfInterrupt();</span><br><span class="line">     <span class="comment">// 0ä¸å¤„ç†</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h1 id="å…¶ä»–await">4. å…¶ä»–await</h1><h2 id="è¶…æ—¶await">4.1. è¶…æ—¶await</h2><p>è¶…æ—¶çš„awaitéƒ½å·®ä¸å¤šï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">awaitNanos</span><span class="params">(<span class="keyword">long</span> nanosTimeout)</span> </span></span><br><span class="line"><span class="function">                  <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">awaitUntil</span><span class="params">(Date deadline)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> InterruptedException</span></span><br></pre></td></tr></table></figure>

<p>çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">awaitNanos</span><span class="params">(<span class="keyword">long</span> nanosTimeout)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> deadline = System.nanoTime() + nanosTimeout;</span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">    	<span class="comment">// è¶…æ—¶å•¦</span></span><br><span class="line">        <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">            transferAfterCancelledWait(node);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// spinForTimeoutThreshold = 1000ï¼ˆ1msï¼‰ï¼Œå½“è¶…æ—¶æ—¶é—´å¤§äº1msæ‰æŒ‚èµ·ï¼Œå¦åˆ™ç»§ç»­è‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">if</span> (nanosTimeout &gt;= spinForTimeoutThreshold)</span><br><span class="line">        	<span class="comment">// æŒ‡å®šæ—¶é—´çš„æŒ‚èµ·</span></span><br><span class="line">            LockSupport.parkNanos(<span class="keyword">this</span>, nanosTimeout);</span><br><span class="line">        <span class="comment">// é†’æ¥æ£€æŸ¥æ˜¯å¦signalå‘ç”Ÿä¸­æ–­</span></span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        nanosTimeout = deadline - System.nanoTime();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>)</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">    <span class="keyword">return</span> deadline - System.nanoTime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¶…æ—¶çš„æ€è·¯è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä¸å¸¦è¶…æ—¶å‚æ•°çš„ await æ˜¯ parkï¼Œç„¶åç­‰å¾…åˆ«äººå”¤é†’ã€‚è€Œç°åœ¨å°±æ˜¯è°ƒç”¨ parkNanos æ–¹æ³•æ¥ä¼‘çœ æŒ‡å®šçš„æ—¶é—´ï¼Œé†’æ¥ååˆ¤æ–­æ˜¯å¦ signal è°ƒç”¨äº†ï¼Œè°ƒç”¨äº†å°±æ˜¯æ²¡æœ‰è¶…æ—¶ï¼Œå¦åˆ™å°±æ˜¯è¶…æ—¶äº†ã€‚è¶…æ—¶çš„è¯ï¼Œè‡ªå·±æ¥è¿›è¡Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼ˆ<code>checkInterruptWhileWaiting</code>æ–¹æ³•ï¼‰ï¼Œç„¶å<code>acquireQueued</code>æŠ¢é”ã€‚</p>
<h1 id="ä¸æŠ›ä¸­æ–­å¼‚å¸¸çš„await">5. ä¸æŠ›ä¸­æ–­å¼‚å¸¸çš„await</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">awaitUninterruptibly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">            interrupted = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) || interrupted)</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é†’æ¥åæ£€æŸ¥ä¸­æ–­ï¼ŒæŠŠä¸­æ–­åäº†,ä½¿ç”¨æ—¶ç¡®ä¿åˆ«äººä¸ä¼šæ¥ä¸­æ–­ä»–ã€‚</p>
<h1 id="ReentrantLockçš„ä¸­æ–­é”">6. ReentrantLockçš„ä¸­æ–­é”</h1><p>è¿™ç¯‡è®²äº†å¾ˆå¤šä¸­æ–­çš„å¤„ç†ï¼Œé‚£ä¹ˆå›å¤´çœ‹ReentrantLockçš„<code>lock()</code>æ–¹æ³•ï¼Œå®ƒé‡Œé¢å®é™…ä¸Šé»˜è®¤æ˜¯åäº†ä¸­æ–­çš„ï¼Œæƒ³é€šè¿‡ä¸­æ–­çº¿ç¨‹æ¥å–æ¶ˆä¸€ä¸ªé”çš„è·å–æ˜¯ä¸å¯ä»¥çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>interrupted = true;</code>ä¹‹ååˆå¼€å§‹è‡ªæ—‹äº†ï¼Œæ‰“äº†ä¸ªæ ‡å¿—ä¹‹åè¿˜æ˜¯åƒæ²¡äº‹äººä¸€æ ·è·å–ğŸ”’ã€‚</p>
<p>è¿™æ—¶å€™è¯·çœ‹<code>lockInterruptibly()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">        doAcquireInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœçº¿ç¨‹ä¸­æ–­ï¼Œå¼€å§‹ç–¯ç‹‚æŠ›å¼‚å¸¸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Acquires in exclusive interruptible mode.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arg the acquire argument</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                <span class="comment">// ç–¯ç‹‚æŠ›å¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡ŒæŠ›å¼‚å¸¸çš„è¯ï¼Œfailedæ˜¯trueçš„ï¼Œç»ˆäºæœ‰æœºä¼šè¿›å…¥<code>cancelAcquire(node)</code>äº†ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Ignore if node doesn't exist</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Skip cancelled predecessors</span></span><br><span class="line">    Node pred = node.prev;</span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// predNext is the apparent node to unsplice. CASes below will</span></span><br><span class="line">    <span class="comment">// fail if not, in which case, we lost race vs another cancel</span></span><br><span class="line">    <span class="comment">// or signal, so no further action is necessary.</span></span><br><span class="line">    Node predNext = pred.next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Can use unconditional write instead of CAS here.</span></span><br><span class="line">    <span class="comment">// After this atomic step, other Nodes can skip past us.</span></span><br><span class="line">    <span class="comment">// Before, we are free of interference from other threads.</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we are the tail, remove ourselves.</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If successor needs signal, try to set pred's next-link</span></span><br><span class="line">        <span class="comment">// so it will get one. Otherwise wake it up to propagate.</span></span><br><span class="line">        <span class="keyword">int</span> ws;</span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Node next = node.next;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        node.next = node; <span class="comment">// help GC</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šæŠŠ<code>node.waitStatus = Node.CANCELLED;</code>ï¼Œå¦‚æœæ˜¯å¤´èŠ‚ç‚¹ï¼Œåˆ™å”¤é†’æŒ‚èµ·çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦åˆ™caså°†å‰é©±èŠ‚ç‚¹çš„nextæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„nextï¼ŒæŠŠè‡ªå·±ä»é˜»å¡é˜Ÿåˆ—æ¸…é™¤ã€‚</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://htchz.cc/2912753191.html" title="[JavaåŸºç¡€]AQSä¸Condition" target="_blank" rel="external">https://htchz.cc/2912753191.html</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong> æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CNåè®®</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/fennecs" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/unnamed.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/fennecs" target="_blank"><span class="text-dark">åœŸå·</span><small class="ml-1x">åç«¯ç å†œ</small></a></h3>
        <div>è¯·è¯´å‡ºHello Worldçš„16ç§å†™æ³•ã€‚</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/4255302597.html" title="[JavaåŸºç¡€]AQSä¸å…±äº«é”"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;ä¸Šä¸€ç¯‡</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2430429572.html" title="[JavaåŸºç¡€]AQSä¸ReentrantLock"><span>ä¸‹ä¸€ç¯‡&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn" data-toggle="collapse" href="#collapseToc" aria-expanded="true" title="æ–‡ç« ç›®å½•" role="button">
        <span>[&nbsp;</span><span>æ–‡ç« ç›®å½•</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/fennecs" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'æ–‡ç« ',
            PAGES: 'é¡µé¢',
            CATEGORIES: 'åˆ†ç±»',
            TAGS: 'æ ‡ç­¾',
            UNTITLED: '(æœªå‘½å)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
    <script defer>
    var disqus_config = function () {
        
            this.page.url = 'https://htchz.cc/2912753191.html';
        
        this.page.identifier = 'JavaåŸºç¡€-Condition';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'htchz' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //åˆ©ç”¨ FancyBox å®ç°ç‚¹å‡»å›¾ç‰‡æ”¾å¤§
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>





</body>
</html>